<Window x:Class="AdRev.Desktop.DiscussionWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:AdRev.Desktop"
        Title="Assistant Discussion" Height="750" Width="1000"
        WindowStartupLocation="CenterScreen"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent">

    <Border Background="{StaticResource BackgroundBrush}" CornerRadius="20" BorderBrush="#DDD" BorderThickness="1">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <!-- Custom Title Bar -->
                <RowDefinition Height="*"/>    <!-- Content -->
                <RowDefinition Height="Auto"/> <!-- Footer -->
            </Grid.RowDefinitions>

            <!-- Custom Title Bar / Header -->
            <Border Grid.Row="0" Background="{StaticResource PrimaryBrush}" CornerRadius="19,19,0,0" Padding="20,15">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="ðŸ’¬" FontSize="24" VerticalAlignment="Center" Margin="0,0,15,0"/>
                        <StackPanel VerticalAlignment="Center">
                            <TextBlock Text="Assistant Discussion &amp; Commentaires" FontSize="20" FontWeight="Bold" Foreground="White"/>
                            <TextBlock Text="Ã‰laborez vos arguments scientifiques avec l'assistance AdRev" FontSize="12" Foreground="#AACCFF"/>
                        </StackPanel>
                    </StackPanel>

                    <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Top">
                        <Button Content="âœ•" Click="Close_Click" Width="30" Height="30" Background="Transparent" Foreground="White" BorderThickness="0" FontSize="16" FontWeight="Bold" Cursor="Hand"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Main Content Area -->
            <Grid Grid.Row="1" Margin="25">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="1.8*"/> <!-- Main Editor -->
                    <ColumnDefinition Width="30"/>    <!-- Spacer -->
                    <ColumnDefinition Width="1.2*"/> <!-- Support / AI Panes -->
                </Grid.ColumnDefinitions>

                <!-- Left Column: Writing Area -->
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <!-- Top Illustration -->
                        <Border CornerRadius="12" Margin="0,0,0,25" Height="150" ClipToBounds="True">
                             <Image Source="{Binding ImageSource}" Stretch="UniformToFill" Opacity="0.9">
                                 <!-- We will set the ImageSource in code-behind if needed, or use a static resource if we move the file -->
                                 <!-- Since it's dynamic, I'll update the code-behind to set this -->
                             </Image>
                             <!-- Fallback design if image fails -->
                             <Border.Background>
                                 <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                     <GradientStop Color="#1A237E" Offset="0"/>
                                     <GradientStop Color="#4A148C" Offset="1"/>
                                 </LinearGradientBrush>
                             </Border.Background>
                        </Border>

                        <!-- Main Writing Tabs -->
                        <TabControl Background="Transparent" BorderThickness="0" Margin="0,0,0,20">
                            <!-- Tab 1: Global Draft -->
                            <TabItem Header="Ã‰bauche Globale">
                                <Border Style="{StaticResource CardStyle}" Margin="0,10,0,0">
                                    <StackPanel>
                                        <Grid Margin="0,0,0,12">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="ðŸ“„ Plan de Discussion GÃ©nÃ©ral" Style="{StaticResource LabelStyle}" VerticalAlignment="Center"/>
                                                <TextBlock Text="(Vue d'ensemble et synthÃ¨se)" FontSize="10" Foreground="#888" VerticalAlignment="Center" Margin="10,0,0,0"/>
                                            </StackPanel>
                                            <Button HorizontalAlignment="Right" Content="+ Citer" Click="AddCitation_Click" Tag="DiscussionPlanTextBox" Style="{StaticResource SecondaryButtonStyle}" Padding="10,2" FontSize="11" Height="25"/>
                                        </Grid>
                                        <TextBox x:Name="DiscussionPlanTextBox" Height="300" TextWrapping="Wrap" AcceptsReturn="True" 
                                                 Tag="DÃ©crivez ici l'interprÃ©tation de vos rÃ©sultats, la comparaison avec d'autres Ã©tudes..."
                                                 FontSize="14" FontFamily="Times New Roman"/>
                                    </StackPanel>
                                </Border>
                            </TabItem>

                            <!-- Tab 2: Writing by Objectives -->
                            <TabItem Header="Par Objectif SpÃ©cifique">
                                <Border Style="{StaticResource CardStyle}" Margin="0,10,0,0">
                                    <StackPanel>
                                        <Grid Margin="0,0,0,15">
                                            <TextBlock Text="ðŸŽ¯ InterprÃ©tation par Objectif" Style="{StaticResource LabelStyle}" VerticalAlignment="Center"/>
                                            <Button HorizontalAlignment="Right" Content="Fusionner tout" Click="MergeObjectives_Click" Style="{StaticResource SecondaryButtonStyle}" Padding="10,2" FontSize="11" Height="25"/>
                                        </Grid>
                                        
                                        <ItemsControl x:Name="ObjectivesItemsControl" ItemsSource="{Binding ObjectiveItems}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border BorderBrush="#F0F0F0" BorderThickness="0,0,0,1" Padding="0,0,0,15" Margin="0,0,0,15">
                                                        <StackPanel>
                                                            <TextBlock Text="{Binding ObjectiveTitle}" FontWeight="Bold" Foreground="{StaticResource PrimaryDarkBrush}" Margin="0,0,0,8" TextWrapping="Wrap"/>
                                                            <TextBox Text="{Binding Content, UpdateSourceTrigger=PropertyChanged}" 
                                                                     Height="100" TextWrapping="Wrap" AcceptsReturn="True" 
                                                                     FontSize="13" FontFamily="Times New Roman"
                                                                     Tag="Commentez ce rÃ©sultat par rapport Ã  l'objectif..."/>
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </Border>
                            </TabItem>
                        </TabControl>

                        <!-- Limitations Card -->
                        <Border Style="{StaticResource CardStyle}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel>
                                    <Grid Margin="0,0,0,12">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="âš ï¸ Limites de l'Ã©tude (Biais, ValiditÃ©)" Style="{StaticResource LabelStyle}" VerticalAlignment="Center"/>
                                        </StackPanel>
                                        <Button HorizontalAlignment="Right" Content="+ Citer" Click="AddCitation_Click" Tag="LimitationsTextBox" Style="{StaticResource SecondaryButtonStyle}" Padding="10,2" FontSize="11" Height="25"/>
                                    </Grid>
                                    <TextBox x:Name="LimitationsTextBox" Height="120" TextWrapping="Wrap" AcceptsReturn="True"
                                             Tag="Biais de sÃ©lection, de rappel, perdus de vue... Analyse de la validitÃ© interne et externe."
                                             FontSize="14" FontFamily="Times New Roman"/>
                                </StackPanel>
                                <Image Grid.Column="1" Source="{Binding LimitationsImageSource}" Width="100" Height="100" Margin="15,0,0,0" VerticalAlignment="Center" Opacity="0.8"/>
                            </Grid>
                        </Border>
                    </StackPanel>
                </ScrollViewer>

                <!-- Right Column: AI Assistant & Norms -->
                <ScrollViewer Grid.Column="2" VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <!-- Magic Button -->
                        <Button Click="GeneratePlan_Click" Margin="0,0,0,20" Height="50" Cursor="Hand">
                            <Button.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                    <GradientStop Color="#FF9800" Offset="0"/>
                                    <GradientStop Color="#F57C00" Offset="1"/>
                                </LinearGradientBrush>
                            </Button.Background>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="âœ¨" FontSize="20" Margin="0,0,10,0"/>
                                <TextBlock Text="GÃ©nÃ©rer une structure intelligente" FontWeight="Bold" Foreground="White" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>

                        <!-- Norms Card -->
                        <Border Background="White" CornerRadius="12" Margin="0,0,0,20" Padding="15">
                            <Border.Effect>
                                <DropShadowEffect BlurRadius="10" Color="#E3F2FD" Opacity="0.5" ShadowDepth="2"/>
                            </Border.Effect>
                            <StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <TextBlock Text="ðŸ“˜" FontSize="18" Margin="0,0,8,0"/>
                                    <TextBlock Text="Normes de Publication" FontWeight="Bold" Foreground="#1976D2" VerticalAlignment="Center"/>
                                </StackPanel>
                                <TextBlock x:Name="NormsText" Text="Chargement..." TextWrapping="Wrap" FontSize="12" Foreground="#455A64" LineHeight="18"/>
                                <Border Height="1" Background="#E0E0E0" Margin="0,15"/>
                                <TextBlock Text="Ces critÃ¨res sont extraits des checklists COREQ/STROBE recommandÃ©es pour votre Ã©tude." FontSize="10" Foreground="#999" FontStyle="Italic" TextWrapping="Wrap"/>
                            </StackPanel>
                        </Border>

                        <!-- Expert Card -->
                        <Border Background="#FFF8E1" CornerRadius="12" Padding="15" BorderBrush="#FFE082" BorderThickness="1">
                             <StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <TextBlock Text="ðŸ’¡" FontSize="18" Margin="0,0,8,0"/>
                                    <TextBlock Text="Conseils d'Expert" FontWeight="Bold" Foreground="#F57C00" VerticalAlignment="Center"/>
                                </StackPanel>
                                <TextBlock x:Name="ExpertText" Text="Chargement..." TextWrapping="Wrap" FontSize="12" Foreground="#5D4037" LineHeight="18"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </Grid>

            <!-- Footer Actions -->
            <Border Grid.Row="2" Background="White" Padding="25,15" CornerRadius="0,0,19,19" BorderBrush="#EEE" BorderThickness="0,1,0,0">
                <Grid>
                    <TextBlock Text="Les modifications sont enregistrÃ©es localement dans votre protocole." VerticalAlignment="Center" Foreground="#AAA" FontSize="11" FontStyle="Italic"/>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Annuler" IsCancel="True" Style="{StaticResource SecondaryButtonStyle}" Width="120" Height="40" Margin="0,0,15,0"/>
                        <Button Content="Valider &amp; Enregistrer" Click="Save_Click" Style="{StaticResource ModernButtonStyle}" Width="200" Height="40" FontWeight="Bold"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
    </Border>
</Window>
