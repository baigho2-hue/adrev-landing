<UserControl x:Class="AdRev.Desktop.Views.Project.ProtocolView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:AdRev.Desktop"
             mc:Ignorable="d" 
             Loaded="UserControl_Loaded"
             d:DesignHeight="700" d:DesignWidth="1100">
    <UserControl.Resources>
        <local:EnumDescriptionConverter x:Key="EnumDescriptionConverter"/>
        
        <Style TargetType="{x:Type TextBox}">
            <Setter Property="FontFamily" Value="Times New Roman"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Padding" Value="5"/>
        </Style>

        <Style TargetType="{x:Type RichTextBox}">
             <Setter Property="FontFamily" Value="Times New Roman"/>
             <Setter Property="FontSize" Value="12"/>
             <Setter Property="Block.LineHeight" Value="18"/>
        </Style>

        <Style x:Key="LabelStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="{StaticResource CalmSubHeaderBrush}"/>
            <Setter Property="Margin" Value="0,0,0,5"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="FontFamily" Value="Segoe UI"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- 0: Menu -->
            <RowDefinition Height="*"/>    <!-- 1: Content -->
            <RowDefinition Height="Auto"/> <!-- 2: Footer -->
        </Grid.RowDefinitions>

        <!-- Menu Bar (Onglets) -->
        <Border Grid.Row="0" Background="{StaticResource CalmAltBackgroundBrush}" BorderBrush="{StaticResource CalmBorderBrush}" BorderThickness="0,0,0,1" Padding="5">
             <Menu Background="Transparent">
                <MenuItem Header="{DynamicResource MenuFile}" FontSize="14" Margin="5,0,10,0">
                    <MenuItem x:Name="MenuFileNew" Header="{DynamicResource MenuNew}" Click="MenuFileNew_Click"/>
                    <MenuItem x:Name="MenuFileSave" Header="{DynamicResource MenuSave}" Click="CreateProtocol_Click"/>
                    <MenuItem x:Name="MenuFileExport" Header="{DynamicResource MenuExportWord}" Click="ExportWord_Click"/>
                </MenuItem>
                
                <MenuItem Header="{DynamicResource MenuEdit}" FontSize="14" Margin="5,0,10,0">
                    <MenuItem Header="{DynamicResource MenuCopy}" Command="ApplicationCommands.Copy"/>
                    <MenuItem Header="{DynamicResource MenuPaste}" Command="ApplicationCommands.Paste"/>
                </MenuItem>
                
                <MenuItem x:Name="MenuDiscussion" Header="{DynamicResource MenuDiscussionAssistant}" 
                          FontSize="14" 
                          FontWeight="Bold" 
                          Foreground="{StaticResource PrimaryBrush}" 
                          Margin="20,0,10,0"
                          Click="MenuDiscussion_Click"
                          ToolTip="{DynamicResource TooltipDiscussion}"/>
            </Menu>
        </Border>

        <!-- Contenu Principal : Multi-Vues -->
        <Grid Grid.Row="1" Background="{StaticResource CalmBackgroundBrush}">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Navigation LatÃ©rale -->
            <Border Grid.Column="0" Background="{StaticResource CalmAltBackgroundBrush}" BorderBrush="{StaticResource CalmBorderBrush}" BorderThickness="0,0,1,0" Padding="0,15,0,0">
                <ListBox x:Name="SideMenuListBox" BorderThickness="0" Background="Transparent" 
                         ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                         SelectionChanged="SideMenu_SelectionChanged">
                    <ListBox.Resources>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Padding" Value="20,12"/>
                            <Setter Property="FontSize" Value="14"/>
                            <Setter Property="Cursor" Value="Hand"/>
                            <Setter Property="Margin" Value="0,2"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border x:Name="bd" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="0" Padding="{TemplateBinding Padding}">
                                            <ContentPresenter HorizontalAlignment="Left" VerticalAlignment="Center"/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter TargetName="bd" Property="Background" Value="#F1F5F9"/>
                                                <Setter TargetName="bd" Property="BorderBrush" Value="{StaticResource CalmSubHeaderBrush}"/>
                                                <Setter TargetName="bd" Property="BorderThickness" Value="4,0,0,0"/>
                                                <Setter Property="Foreground" Value="{StaticResource CalmSubHeaderBrush}"/>
                                                <Setter Property="FontWeight" Value="ExtraBold"/>
                                            </Trigger>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="bd" Property="Background" Value="#F5F5F5"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.Resources>
                    
                    <ListBoxItem Content="{DynamicResource Step1GeneralInfo}" Tag="1"/>
                    <ListBoxItem Content="{DynamicResource Step2IntroContext}" Tag="2"/>
                    <ListBoxItem Content="{DynamicResource Step3Objectives}" Tag="3"/>
                    <ListBoxItem Content="{DynamicResource Step4ConceptualModel}" Tag="4"/>
                    <ListBoxItem Content="{DynamicResource Step5DesignSetting}" Tag="5"/>
                    <ListBoxItem Content="{DynamicResource Step6PopulationCriteria}" Tag="6"/>
                    <ListBoxItem Content="{DynamicResource Step7Sampling}" Tag="7"/>
                    <ListBoxItem Content="{DynamicResource Step8DataCollection}" Tag="8"/>
                    <ListBoxItem Content="{DynamicResource Step9Budget}" Tag="9"/>
                    <ListBoxItem Content="{DynamicResource Step10Ethics}" Tag="10"/>
                    <ListBoxItem Content="{DynamicResource Step11AnalysisPlan}" Tag="11"/>
                    <ListBoxItem Content="{DynamicResource Step12ExpectedResults}" Tag="12"/>
                    <ListBoxItem Content="{DynamicResource Step13Conclusion}" Tag="13"/>
                    <ListBoxItem Content="{DynamicResource Step14References}" Tag="14"/>
                </ListBox>
            </Border>

            <!-- Zone Contenu -->
            <Grid Grid.Column="1" Margin="30,20,30,20">
                <!-- Ã‰TAPE 1 : INFORMATIONS GÃ‰NÃ‰RALES -->
                <ScrollViewer x:Name="View_Step1" VerticalScrollBarVisibility="Auto" Visibility="Visible">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="{DynamicResource HeaderStep1}" Tag="#F1F5F9" Foreground="{StaticResource CalmSubHeaderBrush}" IsExpanded="True">
                            <StackPanel>
                                <StackPanel Margin="0,0,0,15">
                                     <StackPanel Margin="0,0,0,15">
                                         <TextBlock Text="{DynamicResource LabelProtocolTitle}" Style="{StaticResource LabelStyle}" FontWeight="SemiBold"/>
                                         <TextBox x:Name="TitleTextBox" Height="40" FontSize="14" VerticalContentAlignment="Center" Padding="5" Tag="Sujet de recherche, Titre complet du protocole..."/>
                                     </StackPanel>
                                     <StackPanel Margin="0,0,0,10">
                                         <TextBlock Text="{DynamicResource LabelResearchDomain}" Style="{StaticResource LabelStyle}" FontWeight="SemiBold"/>
                                         <ComboBox x:Name="DomainComboBox" Height="35" VerticalContentAlignment="Center" Padding="10,0" SelectionChanged="DomainComboBox_SelectionChanged" SelectedIndex="0">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                         </ComboBox>
                                     </StackPanel>
                                     <StackPanel Margin="0,0,0,10">
                                         <TextBlock Text="{DynamicResource LabelRefStyle}" Style="{StaticResource LabelStyle}" FontWeight="SemiBold"/>
                                         <ComboBox x:Name="RefStyleComboStep1" Height="35" VerticalContentAlignment="Center" Padding="10,0" SelectionChanged="RefStyleCombo_SelectionChanged" SelectedIndex="0">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding}"/>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                         </ComboBox>
                                     </StackPanel>
                                </StackPanel>
                                <Rectangle Height="1" Fill="#EEEEEE" Margin="0,10,0,20"/>
                                <TextBlock Text="{DynamicResource LabelPrincipalAuthor}" Style="{StaticResource HeaderTextStyle}" FontSize="16" Margin="0,0,0,10"/>
                                <Grid Margin="0,0,0,15">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="80"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="5"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="{DynamicResource LabelTitle}" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                        <ComboBox x:Name="AuthorTitleBox" SelectedIndex="0" Height="30" VerticalContentAlignment="Center">
                                            <ComboBoxItem Content="Dr"/>
                                            <ComboBoxItem Content="Pr"/>
                                            <ComboBoxItem Content="M."/>
                                            <ComboBoxItem Content="Mme"/>
                                            <ComboBoxItem Content="Mlle"/>
                                        </ComboBox>
                                    </StackPanel>
                                    <StackPanel Grid.Column="2">
                                        <TextBlock Text="{DynamicResource LabelFirstName}" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                         <TextBox x:Name="AuthorFirstNameBox" Height="30" Tag="PrÃ©nom"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="4">
                                        <TextBlock Text="{DynamicResource LabelLastName}" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                         <TextBox x:Name="AuthorLastNameBox" Height="30" Tag="Nom"/>
                                    </StackPanel>
                                    <StackPanel Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="3">
                                        <TextBlock Text="{DynamicResource LabelInstitution}" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                         <TextBox x:Name="AuthorInstitutionBox" Height="30" ToolTip="UniversitÃ©, HÃ´pital, Centre de recherche..." Tag="Affiliation Institutionnelle"/>
                                    </StackPanel>
                                    <StackPanel Grid.Row="2" Grid.Column="4">
                                        <TextBlock Text="{DynamicResource LabelEmail}" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                         <TextBox x:Name="AuthorEmailBox" Height="30" ToolTip="email@exemple.com" Tag="contact@exemple.com"/>
                                    </StackPanel>
                                </Grid>
                                <TextBlock Text="{DynamicResource LabelCoAuthors}" Style="{StaticResource HeaderTextStyle}" FontSize="16" Margin="0,10,0,5"/>
                                <Border Background="#F9F9F9" BorderBrush="#EEEEEE" BorderThickness="1" CornerRadius="5" Padding="15">
                                    <StackPanel>
                                        <TextBlock Text="{DynamicResource LabelAddCoAuthor}" Style="{StaticResource LabelStyle}" FontSize="12" FontWeight="Bold" Margin="0,0,0,10"/>
                                        <Grid Margin="0,0,0,5">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/> 
                                                <ColumnDefinition Width="*"/> 
                                                <ColumnDefinition Width="1.5*"/> 
                                                <ColumnDefinition Width="1.5*"/> 
                                                <ColumnDefinition Width="Auto"/> 
                                            </Grid.ColumnDefinitions>
                                             <TextBox x:Name="CoAuthFirst" Margin="0,0,5,0" Height="30" ToolTip="PrÃ©nom" Tag="PrÃ©nom"/>
                                             <TextBox x:Name="CoAuthLast" Grid.Column="1" Margin="0,0,5,0" Height="30" ToolTip="Nom" Tag="Nom"/>
                                             <TextBox x:Name="CoAuthInst" Grid.Column="2" Margin="0,0,5,0" Height="30" ToolTip="Institution" Tag="Institution"/>
                                             <TextBox x:Name="CoAuthEmail" Grid.Column="3" Margin="0,0,5,0" Height="30" ToolTip="Email" Tag="Email"/>
                                            <Button Grid.Column="4" Content="âž•" Click="AddCoAuthor_Click" Width="40" Height="30" Background="#DDDDDD" ToolTip="Ajouter"/>
                                        </Grid>
                                        <ListBox x:Name="CoAuthorsListBox" Height="100" BorderThickness="1" BorderBrush="#EEEEEE" Background="White">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding}" FontSize="12" Padding="5"/>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                        <Button Content="{DynamicResource BtnRemoveSelection}" Click="RemoveCoAuthor_Click" HorizontalAlignment="Right" Margin="0,5,0,0" FontSize="11" Background="Transparent" BorderThickness="0" Foreground="#CC3333" Cursor="Hand"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 2 : INTRODUCTION -->
                <ScrollViewer x:Name="View_Introduction" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="{DynamicResource HeaderStep2}" Tag="#E1F5FE" Foreground="#0277BD" IsExpanded="True">
                             <StackPanel>
                                <TextBlock Text="{DynamicResource LabelIntroStructure}" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                <Grid Margin="0,0,0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="{DynamicResource LabelContext}" Style="{StaticResource LabelStyle}" VerticalAlignment="Center"/>
                                    <Button Grid.Column="1" Content="{DynamicResource BtnCiteSource}" Click="AddCitation_Click" Tag="Context" Height="25" FontSize="11" Padding="10,0" Background="#E0E0E0" Foreground="Black" Margin="0"/>
                                </Grid>
                                 <TextBox x:Name="ContextTextBox" Height="300" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15" VerticalScrollBarVisibility="Auto" Tag="DÃ©crivez l'Ã©tat actuel des connaissances, les dÃ©finitions et le contexte global de votre Ã©tude..."/>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="{DynamicResource LabelJustification}" Style="{StaticResource LabelStyle}"/>
                                    <Button Grid.Column="1" Content="{DynamicResource BtnCite}" Click="AddCitation_Click" Tag="ProblemTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                 <TextBox x:Name="ProblemTextBox" Height="80" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="Quelle est la lacune ou le problÃ¨me spÃ©cifique que cette Ã©tude vise Ã  rÃ©soudre ?"/>
                                <TextBlock Text="{DynamicResource LabelResearchQuestion}" Style="{StaticResource LabelStyle}"/>
                                 <TextBox x:Name="ResearchQuestionTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="Ex: Quel est l'impact de X sur Y dans la population Z ?"/>
                                <TextBlock Text="{DynamicResource LabelHypotheses}" Style="{StaticResource LabelStyle}"/>
                                 <TextBox x:Name="HypothesesTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="Ex: Il existe une corrÃ©lation positive entre..."/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 3 : OBJECTIFS -->
                <ScrollViewer x:Name="View_Objectives" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="{DynamicResource HeaderStep3}" Tag="#E8F5E9" Foreground="#2E7D32" IsExpanded="True">
                            <StackPanel>
                                <TextBlock Text="{DynamicResource LabelStudyObjectives}" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                <TextBlock Text="{DynamicResource LabelGeneralObjective}" Style="{StaticResource LabelStyle}" FontWeight="Bold"/>
                                <TextBlock Text="{DynamicResource LabelBloomTaxonomy}" FontSize="10" Foreground="#666" Margin="0,0,0,2"/>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,2">
                                    <TextBlock x:Name="OGCountAlert" Text="âš ï¸ Attention : Limitez-vous Ã  3 Objectifs GÃ©nÃ©raux." Foreground="Red" FontWeight="Bold" FontSize="11" Visibility="Collapsed" Margin="0,0,10,0"/>
                                    <TextBlock x:Name="OGBloomAlert" Text="âš ï¸ Utilisez un verbe d'action Bloom." Foreground="#FF8C00" FontWeight="Bold" FontSize="11" Visibility="Collapsed"/>
                                </StackPanel>
                                 <TextBox x:Name="GeneralObjectiveTextBox" Height="120" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" 
                                          TextChanged="GeneralObjectiveTextBox_TextChanged" Text=""
                                          PreviewKeyDown="ObjectiveTextBox_PreviewKeyDown" Tag="OG1: DÃ©terminer l'efficacitÃ© de..."/>
                                <TextBlock Text="{DynamicResource LabelSpecificObjectives}" Style="{StaticResource LabelStyle}" FontWeight="Bold"/>
                                <TextBlock x:Name="OSSuggestions" Text="ðŸ’¡ Verbes suggÃ©rÃ©s : ..." FontSize="11" Foreground="#1565C0" FontStyle="Italic" Margin="0,0,0,2" Visibility="Collapsed"/>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock x:Name="OSCountAlert" Text="âš ï¸ Attention : Max 4 OS par OG recommandÃ©s." Foreground="Red" FontWeight="Bold" FontSize="11" Visibility="Collapsed" Margin="0,0,10,0"/>
                                        <TextBlock x:Name="OSBloomAlert" Text="âš ï¸ Utilisez des verbes d'action Bloom." Foreground="#FF8C00" FontWeight="Bold" FontSize="11" Visibility="Collapsed"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                                        <Button Content="{DynamicResource BtnLinkToOG}" Click="LinkOSToOG_Click" FontSize="10" Padding="5,2" Background="#E3F2FD" BorderBrush="#2196F3" Foreground="#1565C0" Margin="0,0,5,0"/>
                                        <Button Content="{DynamicResource BtnAjustNumber}" Click="RenumberOS_Click" FontSize="10" Padding="5,2" Background="#FFF3E0" BorderBrush="#FF9800" Foreground="#E65100" ToolTip="RenumÃ©rote automatiquement les OS (ex: corrige les doublons ou sauts)"/>
                                    </StackPanel>
                                </Grid>
                                 <TextBox x:Name="SpecificObjectivesTextBox" Height="250" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10"
                                          TextChanged="SpecificObjectivesTextBox_TextChanged" Text=""
                                          PreviewKeyDown="ObjectiveTextBox_PreviewKeyDown" Tag="OS1: Comparer les taux de..."/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 4 : CADRE CONCEPTUEL -->
                <ScrollViewer x:Name="View_ConceptualModel" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                     <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="{DynamicResource HeaderStep4}" Tag="#E8EAF6" Foreground="#283593" IsExpanded="True">
                             <StackPanel>
                                <TextBlock Text="{DynamicResource LabelConcepts}" Style="{StaticResource LabelStyle}"/>
                                 <TextBox x:Name="ConceptsTextBox" Height="100" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15" Tag="DÃ©finissez les variables indÃ©pendantes, dÃ©pendantes et les concepts thÃ©oriques majeurs..."/>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="{DynamicResource LabelConceptualModel}" Style="{StaticResource LabelStyle}"/>
                                    <Button Grid.Column="1" Content="âž• Citer" Click="AddCitation_Click" Tag="ConceptualModelTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                 <TextBlock Text="{DynamicResource LabelConceptualModelDesc}" FontSize="10" Foreground="#666" Margin="0,0,0,5"/>
                                <TextBox x:Name="ConceptualModelTextBox" Height="100" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="Expliquez comment les variables interagissent entre elles (SchÃ©ma ou texte)..."/>
                            </StackPanel>
                        </Expander>
                     </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 5 : METHODOLOGIE - Design & Cadre -->
                <ScrollViewer x:Name="View_Methodology_Design" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="{DynamicResource HeaderStep5}" Tag="#E8F5E9" Foreground="#2E7D32" IsExpanded="True">
                            <StackPanel>
                                <TextBlock Text="{DynamicResource LabelStudyType}" Style="{StaticResource LabelStyle}" FontWeight="SemiBold"/>
                                <ComboBox x:Name="StudyTypeComboBox" Height="40" Padding="10" VerticalContentAlignment="Center" FontSize="14" Margin="0,0,0,10" SelectionChanged="StudyTypeComboBox_SelectionChanged">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                                <StackPanel x:Name="QualitativeTypePanel" Visibility="Collapsed" Margin="0,0,0,15">
                                    <TextBlock Text="{DynamicResource LabelQualitativeApproach}" Style="{StaticResource LabelStyle}" FontWeight="SemiBold" Foreground="{StaticResource SecondaryBrush}"/>
                                    <ComboBox x:Name="QualitativeApproachComboBox" Height="40" Padding="10" VerticalContentAlignment="Center" FontSize="14" SelectionChanged="QualitativeApproachComboBox_SelectionChanged" Margin="0,0,0,10">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}" Foreground="Black"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                    
                                    <TextBlock Text="{DynamicResource LabelQualitativeSampling}" Style="{StaticResource LabelStyle}" FontWeight="SemiBold" Foreground="{StaticResource SecondaryBrush}"/>
                                    <ComboBox x:Name="QualitativeSamplingComboBox" Height="40" Padding="10" VerticalContentAlignment="Center" FontSize="14" SelectionChanged="RefreshAudit_LostFocus">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}" Foreground="Black"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </StackPanel>

                                <StackPanel x:Name="EpidemiologyTypePanel" Visibility="Collapsed" Margin="0,0,0,15">
                                    <TextBlock x:Name="DesignPrecisionLabel" Text="{DynamicResource LabelDesignPrecision}" Style="{StaticResource LabelStyle}" FontWeight="SemiBold" Foreground="{StaticResource SecondaryBrush}"/>
                                    <ComboBox x:Name="EpidemiologyTypeComboBox" Height="40" Padding="10" VerticalContentAlignment="Center" FontSize="14" SelectionChanged="EpidemiologyTypeComboBox_SelectionChanged">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </StackPanel>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                       <ColumnDefinition Width="*"/>
                                       <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="{DynamicResource LabelStudySetting}" Style="{StaticResource LabelStyle}"/>
                                    <Button Grid.Column="1" Content="âž• Citer" Click="AddCitation_Click" Tag="StudySettingTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                <TextBox x:Name="StudySettingTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" LostFocus="RefreshAudit_LostFocus" Tag="OÃ¹ et quand se dÃ©roule l'Ã©tude ? (Ville, HÃ´pital, Services concernÃ©s...)"/>
                                <Border x:Name="PanelQualityGuidelines" Visibility="Collapsed" Background="#E8F5E9" BorderBrush="#4CAF50" BorderThickness="1" CornerRadius="5" Padding="15" Margin="0,15,0,0">
                                    <StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                            <TextBlock Text="{DynamicResource HeaderQualityGuidelines}" FontWeight="Bold" FontSize="14" Foreground="#2E7D32" VerticalAlignment="Center"/>
                                            <TextBlock x:Name="QualityStandardName" Text="(COREQ/STROBE)" Foreground="#2E7D32" Margin="10,0,0,0" VerticalAlignment="Center" FontStyle="Italic"/>
                                        </StackPanel>
                                        <TextBlock Text="{DynamicResource LabelQualityGuidelinesDesc}" FontSize="11" Foreground="#555" Margin="0,0,0,10"/>
                                        <ScrollViewer MaxHeight="300" VerticalScrollBarVisibility="Auto">
                                            <StackPanel x:Name="QualityGuidelinesList"/>
                                        </ScrollViewer>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 6 : METHODOLOGIE - Population & CritÃ¨res -->
                <ScrollViewer x:Name="View_Methodology_Population" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="{DynamicResource HeaderStep6}" Tag="#F1F8E9" Foreground="#33691E" IsExpanded="True">
                            <StackPanel>
                                <TextBlock Text="{DynamicResource LabelPopulation}" Style="{StaticResource LabelStyle}"/>
                                 <TextBox x:Name="PopulationTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="DÃ©finissez la population source et la population cible (ex: Patients diabÃ©tiques de type 2)..."/>
                                <Border Background="#F5F5F5" BorderBrush="#DDDDDD" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,0,0,15">
                                    <StackPanel>
                                        <CheckBox x:Name="IsMulticentricCheckBox" Content="{DynamicResource LabelMulticentric}" FontWeight="SemiBold" Margin="0,0,0,10" Checked="IsMulticentricCheckBox_Checked" Unchecked="IsMulticentricCheckBox_Unchecked"/>
                                        <StackPanel x:Name="MulticentricDetailsPanel" Visibility="Collapsed">
                                            <TextBlock Text="{DynamicResource LabelStudyCenters}" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                             <TextBox x:Name="StudyCentersTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" ToolTip="Listez les centres participants Ã  l'Ã©tude" Tag="Ex: CHU A, Centre MÃ©dical B, etc."/>
                                        </StackPanel>
                                    </StackPanel>
                                </Border>
                                <Grid Margin="0,0,0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0">
                                        <Grid Margin="0,0,0,2">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="{DynamicResource LabelInclusionCriteria}" Style="{StaticResource LabelStyle}"/>
                                            <Button Grid.Column="1" Content="âž• Citer" Click="AddCitation_Click" Tag="InclusionTextBox" Height="22" FontSize="10" Padding="5,0" Background="#E0E0E0" Foreground="Black"/>
                                        </Grid>
                                         <TextBox x:Name="InclusionTextBox" Height="80" TextWrapping="Wrap" AcceptsReturn="True" Tag="Ex: Ã‚ge > 18 ans, Consentement signÃ©..."/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="2">
                                        <TextBlock Text="{DynamicResource LabelExclusionCriteria}" Style="{StaticResource LabelStyle}"/>
                                         <TextBox x:Name="ExclusionTextBox" Height="80" TextWrapping="Wrap" AcceptsReturn="True" Tag="Ex: ComorbiditÃ©s graves, Grossesse..."/>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 7 : METHODOLOGIE - Echantillonnage -->
                <ScrollViewer x:Name="View_Methodology_Sampling" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="{DynamicResource HeaderStep7}" Tag="#FFF8E1" Foreground="#FF6F00" IsExpanded="True">
                            <StackPanel>
                                <Border Background="#FFF9E6" BorderBrush="#FFD700" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,0,0,15">
                                    <StackPanel>
                                        <TextBlock Text="{DynamicResource HeaderSamplingConfig}" FontWeight="Bold" FontSize="13" Margin="0,0,0,10"/>
                                        <TextBlock Text="{DynamicResource LabelSamplingType}" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                        <ComboBox x:Name="SamplingTypeComboBox" Height="32" Padding="8" VerticalContentAlignment="Center" FontSize="12" Margin="0,0,0,10" SelectionChanged="SamplingTypeComboBox_SelectionChanged">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}" Foreground="Black"/>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>

                                        <StackPanel x:Name="StratificationPanel" Visibility="Collapsed" Margin="0,0,0,10">
                                            <CheckBox x:Name="IsStratifiedCheckBox" Content="{DynamicResource LabelStratifiedSampling}" FontSize="11" Margin="0,0,0,5" Checked="IsStratifiedCheckBox_Checked" Unchecked="IsStratifiedCheckBox_Unchecked"/>
                                            <StackPanel x:Name="StratificationDetailsPanel" Visibility="Collapsed">
                                                <TextBlock Text="{DynamicResource LabelStratificationCriteria}" FontSize="10" Foreground="#666" Margin="15,0,0,2"/>
                                                <TextBox x:Name="StratificationCriteriaTextBox" Height="40" TextWrapping="Wrap" AcceptsReturn="True" Margin="15,0,0,0" FontSize="11" ToolTip="Ex: Ã‚ge, Sexe, RÃ©gion gÃ©ographique..."/>
                                            </StackPanel>
                                        </StackPanel>
                                        <StackPanel x:Name="ClusterPanel" Visibility="Collapsed" Margin="0,0,0,10">
                                            <CheckBox x:Name="IsClusterCheckBox" Content="{DynamicResource LabelClusterSampling}" FontSize="11" Margin="0,0,0,5" Checked="IsClusterCheckBox_Checked" Unchecked="IsClusterCheckBox_Unchecked"/>
                                            <StackPanel x:Name="ClusterDetailsPanel" Visibility="Collapsed">
                                                <Grid Margin="15,0,0,0">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="10"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <StackPanel>
                                                        <TextBlock Text="{DynamicResource LabelClusterSize}" FontSize="10" Foreground="#666"/>
                                                        <TextBox x:Name="ClusterSizeTextBox" Height="28" FontSize="11" Foreground="Black" ToolTip="Nombre moyen de sujets par grappe"/>
                                                    </StackPanel>
                                                    <StackPanel Grid.Column="2">
                                                        <TextBlock Text="{DynamicResource LabelDesignEffect}" FontSize="10" Foreground="#666"/>
                                                        <TextBox x:Name="DesignEffectTextBox" Text="1.5" Height="28" FontSize="11" Foreground="Black" ToolTip="GÃ©nÃ©ralement entre 1.5 et 2.0"/>
                                                    </StackPanel>
                                                </Grid>
                                            </StackPanel>
                                        </StackPanel>
                                        <Border Background="White" BorderBrush="#FFD700" BorderThickness="1" CornerRadius="4" Margin="0,10,0,0" Padding="10">
                                            <StackPanel>
                                                <TextBlock Text="{DynamicResource HeaderAttrition}" FontWeight="Bold" FontSize="12" Margin="0,0,0,5"/>
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="15"/>
                                                        <ColumnDefinition Width="80"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Text="{DynamicResource LabelEstimatedRate}" VerticalAlignment="Center"/>
                                                    <TextBox Grid.Column="2" x:Name="ExpectedLossRateTextBox" Text="10" Height="35" FontSize="14" FontWeight="Bold" Foreground="Black" Background="White" BorderBrush="Gray" BorderThickness="1" VerticalContentAlignment="Center" HorizontalContentAlignment="Center" Padding="0"/>
                                                    <TextBlock Grid.Column="3" Text="%" VerticalAlignment="Center" Margin="5,0,0,0" FontSize="14"/>
                                                </Grid>
                                                <TextBlock Text="{DynamicResource LabelAttritionDesc}" FontSize="10" Foreground="#777" Margin="0,3,0,0" FontStyle="Italic"/>
                                            </StackPanel>
                                        </Border>
                                    </StackPanel>
                                </Border>
                                <Border Background="#F0F4C3" CornerRadius="5" Padding="15" Margin="0,0,0,10" BorderBrush="#CDDC39" BorderThickness="1">
                                    <StackPanel>
                                        <TextBlock Text="{DynamicResource HeaderSampleCalculator}" FontWeight="Bold" FontSize="14" Foreground="#827717" Margin="0,0,0,10"/>
                                        <Grid Margin="0,0,0,10">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="{DynamicResource LabelCalculationMethod}" VerticalAlignment="Center" Margin="0,0,10,0" FontWeight="SemiBold"/>
                                            <ComboBox Grid.Column="1" x:Name="CalculatorSelector" Height="35" VerticalContentAlignment="Center" SelectionChanged="CalculatorSelector_SelectionChanged">
                                                <ComboBoxItem Content="Aucun (Saisie libre)" Tag="None" IsSelected="True"/>
                                                <ComboBoxItem Content="Estimation d'une PrÃ©valence (Cochran/Schwartz)" Tag="Cochran"/>
                                                <ComboBoxItem Content="Comparaison de 2 Proportions (Analytique)" Tag="Comparison"/>
                                            </ComboBox>
                                        </Grid>
                                    </StackPanel>
                                </Border>
                                <Border x:Name="PanelCochran" Visibility="Collapsed" Background="#F0F8FF" BorderBrush="#ADD8E6" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,0,0,10">
                                    <StackPanel>
                                        <TextBlock Text="{DynamicResource TitleCochran}" FontSize="11" Foreground="#555" Margin="0,0,0,5"/>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <StackPanel Margin="0,0,5,0">
                                                <TextBlock Text="{DynamicResource LabelPrevP}" FontSize="10"/>
                                                <TextBox x:Name="Calc_Cochran_P" Text="50" Foreground="Black" ToolTip="Ex: 50 pour 50%"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="1" Margin="0,0,5,0">
                                                <TextBlock Text="{DynamicResource LabelPrecisionD}" FontSize="10"/>
                                                <TextBox x:Name="Calc_Cochran_D" Text="5" Foreground="Black" ToolTip="Marge d'erreur, ex: 5%"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="2" Margin="0,0,5,0">
                                                <TextBlock Text="{DynamicResource LabelPopulationN}" FontSize="10" FontWeight="Bold"/>
                                                <TextBox x:Name="Calc_Cochran_N" Text="" Foreground="Black" ToolTip="Laisser vide si inconnue/infinie"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="3" Margin="0,0,5,0">
                                                <TextBlock Text="{DynamicResource LabelConfidenceZ}" FontSize="10"/>
                                                <ComboBox x:Name="Calc_Cochran_Z" SelectedIndex="1">
                                                    <ComboBoxItem Content="90%" Tag="1.65"/>
                                                    <ComboBoxItem Content="95%" Tag="1.96"/>
                                                    <ComboBoxItem Content="99%" Tag="2.58"/>
                                                </ComboBox>
                                            </StackPanel>
                                            <Button Grid.Column="4" Content="{DynamicResource BtnCalculate}" Click="CalculateCochran_Click" Padding="10,0" VerticalAlignment="Bottom" Height="22"/>
                                        </Grid>
                                        <TextBlock x:Name="ResultCochran" Text="N = ?" FontWeight="Bold" Foreground="#007ACC" Margin="0,5,0,0" HorizontalAlignment="Right"/>
                                    </StackPanel>
                                </Border>
                                <Border x:Name="PanelComparison" Visibility="Collapsed" Background="#FFF5E5" BorderBrush="#FFDAB9" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,0,0,10">
                                    <StackPanel>
                                        <TextBlock Text="{DynamicResource TitleComparison}" FontSize="11" Foreground="#555" Margin="0,0,0,5"/>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <StackPanel Margin="0,0,5,0">
                                                <TextBlock Text="{DynamicResource LabelP1}" FontSize="10"/>
                                                <TextBox x:Name="Calc_Comp_P1" Text="30" Foreground="Black"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="1" Margin="0,0,5,0">
                                                <TextBlock Text="{DynamicResource LabelP2}" FontSize="10"/>
                                                <TextBox x:Name="Calc_Comp_P2" Text="15" Foreground="Black"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="2" Margin="0,0,5,0">
                                                <TextBlock Text="{DynamicResource LabelAlpha}" FontSize="10"/>
                                                <ComboBox x:Name="Calc_Comp_Alpha" SelectedIndex="1">
                                                    <ComboBoxItem Content="5% (1.96)" Tag="1.96"/>
                                                    <ComboBoxItem Content="1% (2.58)" Tag="2.58"/>
                                                </ComboBox>
                                            </StackPanel>
                                            <StackPanel Grid.Column="3" Margin="0,0,5,0">
                                                <TextBlock Text="{DynamicResource LabelPower}" FontSize="10"/>
                                                <ComboBox x:Name="Calc_Comp_Power" SelectedIndex="1">
                                                    <ComboBoxItem Content="80% (0.84)" Tag="0.84"/>
                                                    <ComboBoxItem Content="90% (1.28)" Tag="1.28"/>
                                                </ComboBox>
                                            </StackPanel>
                                            <StackPanel Grid.Column="4" VerticalAlignment="Bottom">
                                                <CheckBox x:Name="Chk_Matched" Content="AppariÃ© ?" ToolTip="Cocher si Cas et TÃ©moins sont appariÃ©s (Matching)" FontSize="10" Margin="0,0,0,5"/>
                                                <Button Content="Calculer" Click="CalculateComparison_Click" Padding="10,0" Height="22"/>
                                            </StackPanel>
                                        </Grid>
                                        <TextBlock x:Name="ResultComparison" Text="N par groupe = ?" FontWeight="Bold" Foreground="#D2691E" Margin="0,5,0,0" HorizontalAlignment="Right"/>
                                    </StackPanel>
                                </Border>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Texte final sur l'Ã©chantillonnage :" Style="{StaticResource LabelStyle}"/>
                                    <Button Grid.Column="1" Content="âž• Citer" Click="AddCitation_Click" Tag="SamplingTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                 <TextBox x:Name="SamplingTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="DÃ©taillez la procÃ©dure de sÃ©lection des participants (ex: tirage au sort, recrutement consÃ©cutif...)"/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 8 : METHODOLOGIE - Collecte de donnÃ©es -->
                <ScrollViewer x:Name="View_Methodology_Data" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="{DynamicResource HeaderStep8}" Tag="#E0F2F1" Foreground="#00695C" IsExpanded="True">
                            <StackPanel>
                                <Border Background="#f8fdfd" IsEnabled="True" CornerRadius="8" Padding="5" Margin="0,2,0,8" BorderBrush="#e0eeec" BorderThickness="1" HorizontalAlignment="Center">
                                    <StackPanel HorizontalAlignment="Center">
                                        <Button Height="45" Width="350" BorderThickness="0" Cursor="Hand" Click="OpenVariableDesigner_Click" IsEnabled="True">
                                            <Button.Resources>
                                                <Style TargetType="Border">
                                                    <Setter Property="CornerRadius" Value="6"/>
                                                </Style>
                                            </Button.Resources>
                                            <Button.Background>
                                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                    <GradientStop Color="#60A9A4" Offset="0.0"/>
                                                    <GradientStop Color="#509A95" Offset="1.0"/>
                                                </LinearGradientBrush>
                                            </Button.Background>
                                            <Button.Style>
                                                <Style TargetType="Button">
                                                    <Style.Triggers>
                                                        <Trigger Property="IsMouseOver" Value="True">
                                                            <Setter Property="Background">
                                                                <Setter.Value>
                                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                                        <GradientStop Color="#70B9B4" Offset="0.0"/>
                                                                        <GradientStop Color="#60A9A4" Offset="1.0"/>
                                                                    </LinearGradientBrush>
                                                                </Setter.Value>
                                                            </Setter>
                                                            <Setter Property="Opacity" Value="0.95"/>
                                                        </Trigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Button.Style>
                                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                                <TextBlock Text="&#xE70F;" FontFamily="Segoe MDL2 Assets" FontSize="18" Foreground="White" VerticalAlignment="Center" Margin="0,0,10,0"/>
                                                <StackPanel VerticalAlignment="Center">
                                                    <TextBlock Text="{DynamicResource BtnOpenDesigner}" FontSize="15" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center"/>
                                                    <TextBlock Text="GÃ©nÃ©rer le dictionnaire &amp; le masque de saisie" FontSize="10" FontWeight="SemiBold" Foreground="White" Opacity="0.95" HorizontalAlignment="Center" Margin="0,1,0,0"/>
                                                </StackPanel>
                                            </StackPanel>
                                        </Button>
                                    </StackPanel>
                                </Border>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="ProcÃ©dures de Collecte" Style="{StaticResource LabelStyle}"/>
                                    <Button Grid.Column="1" Content="âž• Citer" Click="AddCitation_Click" Tag="DataCollectionTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                 <TextBox x:Name="DataCollectionTextBox" Height="250" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10" Tag="DÃ©crivez les outils (Questionnaires, Mesures cliniques) et les procÃ©dures de collecte..."/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 9 : BUDGET -->
                <ScrollViewer x:Name="View_Budget" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="{DynamicResource HeaderStep9}" Tag="#FFF3E0" Foreground="#EF6C00" IsExpanded="True">
                            <StackPanel>
                                <TextBlock Text="{DynamicResource LabelBudgetEstimation}" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                <Border x:Name="BudgetSuggestionsPanel" Background="#E3F2FD" BorderBrush="#2196F3" BorderThickness="1" CornerRadius="5" Padding="15" Margin="0,0,0,15">
                                    <StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                            <TextBlock Text="{DynamicResource LabelBudgetSuggestions}" FontWeight="Bold" Foreground="#1565C0"/>
                                            <TextBlock x:Name="BudgetSuggestionType" Text="(Type)" Margin="5,0,0,0" FontStyle="Italic" Foreground="#1565C0"/>    
                                        </StackPanel>
                                        <TextBlock x:Name="BudgetSuggestionsText" Text="â€¢ Personnel..." TextWrapping="Wrap" FontSize="13"/>
                                    </StackPanel>
                                </Border>
                                <TextBlock Text="{DynamicResource LabelBudgetDetail}" Style="{StaticResource LabelStyle}"/>
                                <TextBox x:Name="BudgetTextBox" Height="200" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15" VerticalContentAlignment="Top" Padding="10"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="{DynamicResource LabelBudgetTotal}" VerticalAlignment="Center" FontWeight="Bold"/>
                                    <TextBox Grid.Column="1" x:Name="BudgetTotalBox" Margin="10,0,0,0" Height="30" Width="150" HorizontalAlignment="Left"/>
                                </Grid>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 10 : CONSIDERATIONS ETHIQUES -->
                <ScrollViewer x:Name="View_Ethics" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                     <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="{DynamicResource HeaderStep10}" Tag="#FFEBEE" Foreground="#C62828" IsExpanded="True">
                            <StackPanel>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="{DynamicResource LabelEthicsTitle}" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                    <Button Grid.Column="1" Content="âž• Citer" Click="AddCitation_Click" Tag="EthicsTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                <TextBlock Text="{DynamicResource LabelEthicsDesc}" FontSize="11" Foreground="#666" Margin="0,0,0,5"/>
                                <TextBox x:Name="EthicsTextBox" Height="150" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15"/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 11 : PLAN D'ANALYSE -->
                <ScrollViewer x:Name="View_DataAnalysis" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="{DynamicResource HeaderStep11}" Tag="#EDE7F6" Foreground="#4527A0" IsExpanded="True">
                            <StackPanel>
                                <TextBlock Text="{DynamicResource LabelAnalysisPlanDesc}" FontSize="11" Foreground="#666" Margin="0,0,0,15" FontStyle="Italic"/>
                                <Grid Margin="0,0,0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="{DynamicResource LabelAnalysisPlanTitle}" Style="{StaticResource LabelStyle}" VerticalAlignment="Center"/>
                                    <Button Grid.Column="1" Content="{DynamicResource BtnAutoPlan}" Click="GenerateProtocolPlan_Click" Height="25" FontSize="11" Padding="12,0" Margin="0,0,8,0" Background="#FFF3E0" Foreground="#E65100" BorderBrush="#FFCC80" BorderThickness="1"/>
                                    <Button Grid.Column="2" Content="âž• Citer" Click="AddCitation_Click" Tag="DataAnalysisTextBox" Height="25" FontSize="11" Padding="10,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                <TextBox x:Name="DataAnalysisTextBox" Height="350" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10" Tag="Le plan gÃ©nÃ©rÃ© apparaÃ®tra ici. Vous pouvez ensuite le modifier librement."/>
                                <Border Background="#E3F2FD" Padding="10" CornerRadius="5">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="â„¹ï¸" Margin="0,0,10,0"/>
                                        <TextBlock Text="{DynamicResource LabelAnalysisInfo}" FontSize="11" Foreground="#1565C0" TextWrapping="Wrap"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 12 : RESULTATS ATTENDUS -->
                <ScrollViewer x:Name="View_Results" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="{DynamicResource HeaderStep12}" Tag="#E0F7FA" Foreground="#006064" IsExpanded="True">
                            <StackPanel>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="{DynamicResource LabelExpectedResultsTitle}" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                    <Button Grid.Column="1" Content="âž• Citer" Click="AddCitation_Click" Tag="ExpectedResultsTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                <TextBlock Text="{DynamicResource LabelExpectedResultsDesc}" FontSize="11" Foreground="#666" Margin="0,0,0,5"/>
                                <TextBox x:Name="ExpectedResultsTextBox" Height="200" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15"/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 13 : CONCLUSION -->
                <ScrollViewer x:Name="View_Conclusion" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="{DynamicResource HeaderStep13}" Tag="#ECEFF1" Foreground="#37474F" IsExpanded="True">
                            <StackPanel>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="{DynamicResource LabelConclusionTitle}" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                    <Button Grid.Column="1" Content="âž• Citer" Click="AddCitation_Click" Tag="ConclusionTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                <TextBlock Text="{DynamicResource LabelConclusionDesc}" FontSize="11" Foreground="#666" Margin="0,0,0,5"/>
                                <TextBox x:Name="ConclusionTextBox" Height="200" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15"/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 14 : REFERENCES -->
                <ScrollViewer x:Name="View_References" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="{DynamicResource HeaderStep14}" Tag="#FAFAFA" Foreground="#424242" IsExpanded="True">
                            <StackPanel>
                                <Grid Margin="0,0,0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="{DynamicResource LabelReferencesTitle}" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                    <ComboBox Grid.Column="1" x:Name="RefStyleComboStep14" Height="30" Width="150" VerticalContentAlignment="Center" SelectionChanged="RefStyleCombo_SelectionChanged" SelectedIndex="0"/>
                                </Grid>
                                <TextBlock Text="{DynamicResource LabelReferencesAutoDesc}" FontSize="11" Foreground="#666" Margin="0,0,0,5"/>
                                <TextBox x:Name="ReferencesTextBox" Height="500" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" VerticalScrollBarVisibility="Auto" IsReadOnly="False"/>
                                <Button Content="{DynamicResource BtnRegenerateRefs}" Click="RegenerateReferences_Click" HorizontalAlignment="Right" Width="150" Height="30" FontSize="12"/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Grid>

        <!-- Barre d'action fixe en bas -->
        <Border Grid.Row="2" Background="White" BorderBrush="#EEEEEE" BorderThickness="0,1,0,0" Padding="15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Navigation Gauche -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Content="{DynamicResource BtnPrevious}" Click="PrevSection_Click" Height="40" Width="120" Margin="0,0,10,0" Background="#F0F0F0" Foreground="Black" BorderThickness="0"/>
                    <Button Content="{DynamicResource BtnNext}" Click="NextSection_Click" Height="40" Width="120" Background="#F0F0F0" Foreground="Black" BorderThickness="0"/>
                </StackPanel>

                <!-- Zone de messages de validation -->
                <ListBox Grid.Column="1" x:Name="ValidationMessagesListBox" 
                         BorderThickness="0" Background="Transparent" 
                         Foreground="{StaticResource ErrorBrush}" 
                         FontSize="13" FontWeight="Bold"
                         MaxHeight="100" Margin="20,0,20,0" 
                         VerticalAlignment="Center" HorizontalAlignment="Right"/>

                <!-- Bouton Action -->
                <Button Grid.Column="2" Content="{DynamicResource BtnValidateSave}" Click="CreateProtocol_Click" Height="45" Width="200" FontSize="15" FontWeight="Bold"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>
