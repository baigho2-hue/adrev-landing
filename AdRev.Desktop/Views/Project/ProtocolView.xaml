<UserControl x:Class="AdRev.Desktop.Views.Project.ProtocolView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:AdRev.Desktop"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1100">
    <UserControl.Resources>
        <local:EnumDescriptionConverter x:Key="EnumDescriptionConverter"/>
        
        <Style TargetType="{x:Type TextBox}">
            <Setter Property="FontFamily" Value="Times New Roman"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Padding" Value="5"/>
        </Style>

        <Style TargetType="{x:Type RichTextBox}">
             <Setter Property="FontFamily" Value="Times New Roman"/>
             <Setter Property="FontSize" Value="12"/>
             <Setter Property="Block.LineHeight" Value="18"/>
        </Style>

        <Style x:Key="LabelStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="#333"/>
            <Setter Property="Margin" Value="0,0,0,5"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="FontFamily" Value="Segoe UI"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- 0: Menu -->
            <RowDefinition Height="*"/>    <!-- 1: Content -->
            <RowDefinition Height="Auto"/> <!-- 2: Footer -->
        </Grid.RowDefinitions>

        <!-- Menu Bar (Onglets) -->
        <Border Grid.Row="0" Background="#F8F9FA" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1" Padding="5">
             <Menu Background="Transparent">
                <MenuItem Header="Fichier" FontSize="14" Margin="5,0,10,0">
                    <MenuItem x:Name="MenuFileNew" Header="Nouveau" Click="MenuFileNew_Click"/>
                    <MenuItem x:Name="MenuFileSave" Header="Enregistrer" Click="CreateProtocol_Click"/>
                    <MenuItem x:Name="MenuFileExport" Header="Exporter en Word (.docx)" Click="ExportWord_Click"/>
                </MenuItem>
                
                <MenuItem Header="Ã‰dition" FontSize="14" Margin="5,0,10,0">
                    <MenuItem Header="Copier" Command="ApplicationCommands.Copy"/>
                    <MenuItem Header="Coller" Command="ApplicationCommands.Paste"/>
                </MenuItem>

                <MenuItem x:Name="MenuDiscussion" Header="Assistant Discussion ðŸ’¬" 
                          FontSize="14" 
                          FontWeight="Bold" 
                          Foreground="{StaticResource PrimaryBrush}" 
                          Margin="20,0,10,0"
                          Click="MenuDiscussion_Click"
                          ToolTip="Ouvrir la fenÃªtre d'aide Ã  la discussion"/>
            </Menu>
        </Border>

        <!-- Contenu Principal : Multi-Vues -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Navigation LatÃ©rale -->
            <Border Grid.Column="0" Background="White" BorderBrush="#EEEEEE" BorderThickness="0,0,1,0" Padding="0,15,0,0">
                <ListBox x:Name="SideMenuListBox" BorderThickness="0" Background="Transparent" ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                    <ListBox.Resources>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Padding" Value="20,12"/>
                            <Setter Property="FontSize" Value="14"/>
                            <Setter Property="Cursor" Value="Hand"/>
                            <Setter Property="Margin" Value="0,2"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border x:Name="bd" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="0" Padding="{TemplateBinding Padding}">
                                            <ContentPresenter HorizontalAlignment="Left" VerticalAlignment="Center"/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter TargetName="bd" Property="Background" Value="#E3F2FD"/>
                                                <Setter TargetName="bd" Property="BorderBrush" Value="#2196F3"/>
                                                <Setter TargetName="bd" Property="BorderThickness" Value="4,0,0,0"/>
                                                <Setter Property="Foreground" Value="#1976D2"/>
                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                            </Trigger>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="bd" Property="Background" Value="#F5F5F5"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.Resources>
                    
                    <ListBoxItem Content="1. Informations GÃ©nÃ©rales" Tag="1"/>
                    <ListBoxItem Content="2. Introduction &amp; Contexte" Tag="2"/>
                    <ListBoxItem Content="3. Objectifs de l'Ã‰tude" Tag="3"/>
                    <ListBoxItem Content="4. Cadre Conceptuel" Tag="4"/>
                    <ListBoxItem Content="5. Design &amp; Cadre" Tag="5"/>
                    <ListBoxItem Content="6. Population &amp; CritÃ¨res" Tag="6"/>
                    <ListBoxItem Content="7. Echantillonnage" Tag="7"/>
                    <ListBoxItem Content="8. Collecte de donnÃ©es" Tag="8"/>
                    <ListBoxItem Content="9. Budget &amp; Ressources" Tag="9"/>
                    <ListBoxItem Content="10. ConsidÃ©rations Ã‰thiques" Tag="10"/>
                    <ListBoxItem Content="11. Plan d'Analyse (SAP/TAP)" Tag="11"/>
                    <ListBoxItem Content="12. RÃ©sultats Attendus" Tag="12"/>
                    <ListBoxItem Content="13. Conclusion" Tag="13"/>
                    <ListBoxItem Content="14. RÃ©fÃ©rences" Tag="14"/>
                </ListBox>
            </Border>

            <!-- Zone Contenu -->
            <Grid Grid.Column="1" Margin="30,20,30,20">
                <!-- Ã‰TAPE 1 : INFORMATIONS GÃ‰NÃ‰RALES -->
                <ScrollViewer x:Name="View_Step1" VerticalScrollBarVisibility="Auto" Visibility="Visible">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="Ã‰tape 1/14 : Informations GÃ©nÃ©rales" Tag="#E3F2FD" Foreground="#1565C0">
                            <StackPanel>
                                <StackPanel Margin="0,0,0,15">
                                     <StackPanel Margin="0,0,0,15">
                                         <TextBlock Text="Titre du protocole" Style="{StaticResource LabelStyle}" FontWeight="SemiBold"/>
                                         <TextBox x:Name="TitleTextBox" Height="40" FontSize="14" VerticalContentAlignment="Center" Padding="5" Tag="Sujet de recherche, Titre complet du protocole..."/>
                                     </StackPanel>
                                     <StackPanel Margin="0,0,0,10">
                                         <TextBlock Text="Domaine de Recherche" Style="{StaticResource LabelStyle}" FontWeight="SemiBold"/>
                                         <ComboBox x:Name="DomainComboBox" Height="35" VerticalContentAlignment="Center" Padding="10,0" SelectionChanged="DomainComboBox_SelectionChanged" SelectedIndex="0">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                         </ComboBox>
                                     </StackPanel>
                                     <StackPanel Margin="0,0,0,10">
                                         <TextBlock Text="Style de RÃ©fÃ©rence Bibliographique" Style="{StaticResource LabelStyle}" FontWeight="SemiBold"/>
                                         <ComboBox x:Name="RefStyleComboStep1" Height="35" VerticalContentAlignment="Center" Padding="10,0" SelectionChanged="RefStyleCombo_SelectionChanged" SelectedIndex="0">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding}"/>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                         </ComboBox>
                                     </StackPanel>
                                </StackPanel>
                                <Rectangle Height="1" Fill="#EEEEEE" Margin="0,10,0,20"/>
                                <TextBlock Text="Auteur Principal" Style="{StaticResource HeaderTextStyle}" FontSize="16" Margin="0,0,0,10"/>
                                <Grid Margin="0,0,0,15">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="80"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="5"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="Titre" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                        <ComboBox x:Name="AuthorTitleBox" SelectedIndex="0" Height="30" VerticalContentAlignment="Center">
                                            <ComboBoxItem Content="Dr"/>
                                            <ComboBoxItem Content="Pr"/>
                                            <ComboBoxItem Content="M."/>
                                            <ComboBoxItem Content="Mme"/>
                                            <ComboBoxItem Content="Mlle"/>
                                        </ComboBox>
                                    </StackPanel>
                                    <StackPanel Grid.Column="2">
                                        <TextBlock Text="PrÃ©nom" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                         <TextBox x:Name="AuthorFirstNameBox" Height="30" Tag="PrÃ©nom"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="4">
                                        <TextBlock Text="Nom" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                         <TextBox x:Name="AuthorLastNameBox" Height="30" Tag="Nom"/>
                                    </StackPanel>
                                    <StackPanel Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="3">
                                        <TextBlock Text="Institution" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                         <TextBox x:Name="AuthorInstitutionBox" Height="30" ToolTip="UniversitÃ©, HÃ´pital, Centre de recherche..." Tag="Affiliation Institutionnelle"/>
                                    </StackPanel>
                                    <StackPanel Grid.Row="2" Grid.Column="4">
                                        <TextBlock Text="Email" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                         <TextBox x:Name="AuthorEmailBox" Height="30" ToolTip="email@exemple.com" Tag="contact@exemple.com"/>
                                    </StackPanel>
                                </Grid>
                                <TextBlock Text="Co-Auteurs" Style="{StaticResource HeaderTextStyle}" FontSize="16" Margin="0,10,0,5"/>
                                <Border Background="#F9F9F9" BorderBrush="#EEEEEE" BorderThickness="1" CornerRadius="5" Padding="15">
                                    <StackPanel>
                                        <TextBlock Text="Ajouter un co-auteur :" Style="{StaticResource LabelStyle}" FontSize="12" FontWeight="Bold" Margin="0,0,0,10"/>
                                        <Grid Margin="0,0,0,5">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/> 
                                                <ColumnDefinition Width="*"/> 
                                                <ColumnDefinition Width="1.5*"/> 
                                                <ColumnDefinition Width="1.5*"/> 
                                                <ColumnDefinition Width="Auto"/> 
                                            </Grid.ColumnDefinitions>
                                             <TextBox x:Name="CoAuthFirst" Margin="0,0,5,0" Height="30" ToolTip="PrÃ©nom" Tag="PrÃ©nom"/>
                                             <TextBox x:Name="CoAuthLast" Grid.Column="1" Margin="0,0,5,0" Height="30" ToolTip="Nom" Tag="Nom"/>
                                             <TextBox x:Name="CoAuthInst" Grid.Column="2" Margin="0,0,5,0" Height="30" ToolTip="Institution" Tag="Institution"/>
                                             <TextBox x:Name="CoAuthEmail" Grid.Column="3" Margin="0,0,5,0" Height="30" ToolTip="Email" Tag="Email"/>
                                            <Button Grid.Column="4" Content="âž•" Click="AddCoAuthor_Click" Width="40" Height="30" Background="#DDDDDD" ToolTip="Ajouter"/>
                                        </Grid>
                                        <ListBox x:Name="CoAuthorsListBox" Height="100" BorderThickness="1" BorderBrush="#EEEEEE" Background="White">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding}" FontSize="12" Padding="5"/>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                        <Button Content="ðŸ—‘ï¸ Retirer la sÃ©lection" Click="RemoveCoAuthor_Click" HorizontalAlignment="Right" Margin="0,5,0,0" FontSize="11" Background="Transparent" BorderThickness="0" Foreground="#CC3333" Cursor="Hand"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 2 : INTRODUCTION -->
                <ScrollViewer x:Name="View_Introduction" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="Ã‰tape 2/14 : Introduction &amp; Contexte" Tag="#E1F5FE" Foreground="#0277BD">
                             <StackPanel>
                                <TextBlock Text="Structure de l'Introduction (Max 2000 mots)" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                <Grid Margin="0,0,0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="1. Contexte (DÃ©finitions principales...)" Style="{StaticResource LabelStyle}" VerticalAlignment="Center"/>
                                    <Button Grid.Column="1" Content="âž• Citer une source" Click="AddCitation_Click" Tag="Context" Height="25" FontSize="11" Padding="10,0" Background="#E0E0E0" Foreground="Black" Margin="0"/>
                                </Grid>
                                 <TextBox x:Name="ContextTextBox" Height="300" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15" VerticalScrollBarVisibility="Auto" Tag="DÃ©crivez l'Ã©tat actuel des connaissances, les dÃ©finitions et le contexte global de votre Ã©tude..."/>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="2. Justification du ProblÃ¨me (DonnÃ©es, Lacunes...)" Style="{StaticResource LabelStyle}"/>
                                    <Button Grid.Column="1" Content="âž• Citer" Click="AddCitation_Click" Tag="ProblemTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                 <TextBox x:Name="ProblemTextBox" Height="80" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="Quelle est la lacune ou le problÃ¨me spÃ©cifique que cette Ã©tude vise Ã  rÃ©soudre ?"/>
                                <TextBlock Text="3. Question de Recherche (Max 3)" Style="{StaticResource LabelStyle}"/>
                                 <TextBox x:Name="ResearchQuestionTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="Ex: Quel est l'impact de X sur Y dans la population Z ?"/>
                                <TextBlock Text="4. HypothÃ¨ses (Max 2)" Style="{StaticResource LabelStyle}"/>
                                 <TextBox x:Name="HypothesesTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="Ex: Il existe une corrÃ©lation positive entre..."/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 3 : OBJECTIFS -->
                <ScrollViewer x:Name="View_Objectives" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="Ã‰tape 3/14 : Objectifs de l'Ã‰tude" Tag="#E8F5E9" Foreground="#2E7D32">
                            <StackPanel>
                                <TextBlock Text="Objectifs de l'Ã©tude" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                <TextBlock Text="Objectif GÃ©nÃ©ral (Max 2)" Style="{StaticResource LabelStyle}" FontWeight="Bold"/>
                                <TextBlock Text="Utilisez des verbes d'action prÃ©cis (Taxonomie de Bloom)." FontSize="10" Foreground="#666" Margin="0,0,0,2"/>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,2">
                                    <TextBlock x:Name="OGCountAlert" Text="âš ï¸ Attention : Limitez-vous Ã  3 Objectifs GÃ©nÃ©raux." Foreground="Red" FontWeight="Bold" FontSize="11" Visibility="Collapsed" Margin="0,0,10,0"/>
                                    <TextBlock x:Name="OGBloomAlert" Text="âš ï¸ Utilisez un verbe d'action Bloom." Foreground="#FF8C00" FontWeight="Bold" FontSize="11" Visibility="Collapsed"/>
                                </StackPanel>
                                 <TextBox x:Name="GeneralObjectiveTextBox" Height="120" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" 
                                          TextChanged="GeneralObjectiveTextBox_TextChanged" Text=""
                                          PreviewKeyDown="ObjectiveTextBox_PreviewKeyDown" Tag="OG1: DÃ©terminer l'efficacitÃ© de..."/>
                                <TextBlock Text="Objectifs SpÃ©cifiques (Max 4 par OG)" Style="{StaticResource LabelStyle}" FontWeight="Bold"/>
                                <TextBlock x:Name="OSSuggestions" Text="ðŸ’¡ Verbes suggÃ©rÃ©s : ..." FontSize="11" Foreground="#1565C0" FontStyle="Italic" Margin="0,0,0,2" Visibility="Collapsed"/>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock x:Name="OSCountAlert" Text="âš ï¸ Attention : Max 4 OS par OG recommandÃ©s." Foreground="Red" FontWeight="Bold" FontSize="11" Visibility="Collapsed" Margin="0,0,10,0"/>
                                        <TextBlock x:Name="OSBloomAlert" Text="âš ï¸ Utilisez des verbes d'action Bloom." Foreground="#FF8C00" FontWeight="Bold" FontSize="11" Visibility="Collapsed"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                                        <Button Content="Lier aux OG ðŸ”—" Click="LinkOSToOG_Click" FontSize="10" Padding="5,2" Background="#E3F2FD" BorderBrush="#2196F3" Foreground="#1565C0" Margin="0,0,5,0"/>
                                        <Button Content="ðŸ”¢ Ajuster NÂ°" Click="RenumberOS_Click" FontSize="10" Padding="5,2" Background="#FFF3E0" BorderBrush="#FF9800" Foreground="#E65100" ToolTip="RenumÃ©rote automatiquement les OS (ex: corrige les doublons ou sauts)"/>
                                    </StackPanel>
                                </Grid>
                                 <TextBox x:Name="SpecificObjectivesTextBox" Height="250" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10"
                                          TextChanged="SpecificObjectivesTextBox_TextChanged" Text=""
                                          PreviewKeyDown="ObjectiveTextBox_PreviewKeyDown" Tag="OS1: Comparer les taux de..."/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 4 : CADRE CONCEPTUEL -->
                <ScrollViewer x:Name="View_ConceptualModel" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                     <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="Ã‰tape 4/14 : Cadre Conceptuel" Tag="#E8EAF6" Foreground="#283593">
                             <StackPanel>
                                <TextBlock Text="DÃ©finition des Concepts ClÃ©s" Style="{StaticResource LabelStyle}"/>
                                 <TextBox x:Name="ConceptsTextBox" Height="100" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15" Tag="DÃ©finissez les variables indÃ©pendantes, dÃ©pendantes et les concepts thÃ©oriques majeurs..."/>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="ModÃ¨le Conceptuel (Optionnel)" Style="{StaticResource LabelStyle}"/>
                                    <Button Grid.Column="1" Content="âž• Citer" Click="AddCitation_Click" Tag="ConceptualModelTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                 <TextBlock Text="DÃ©crivez les relations entre les variables." FontSize="10" Foreground="#666" Margin="0,0,0,5"/>
                                <TextBox x:Name="ConceptualModelTextBox" Height="100" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="Expliquez comment les variables interagissent entre elles (SchÃ©ma ou texte)..."/>
                            </StackPanel>
                        </Expander>
                     </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 5 : METHODOLOGIE - Design & Cadre -->
                <ScrollViewer x:Name="View_Methodology_Design" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="Ã‰tape 5/14 : MÃ©thodologie - Design &amp; Cadre" Tag="#E8F5E9" Foreground="#2E7D32">
                            <StackPanel>
                                <TextBlock Text="Type d'Ã©tude (Approche)" Style="{StaticResource LabelStyle}" FontWeight="SemiBold"/>
                                <ComboBox x:Name="StudyTypeComboBox" Height="40" Padding="10" VerticalContentAlignment="Center" FontSize="14" Margin="0,0,0,10" SelectionChanged="StudyTypeComboBox_SelectionChanged">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                                <StackPanel x:Name="QualitativeTypePanel" Visibility="Collapsed" Margin="0,0,0,15">
                                    <TextBlock Text="Approche Qualitative" Style="{StaticResource LabelStyle}" FontWeight="SemiBold" Foreground="{StaticResource SecondaryBrush}"/>
                                    <ComboBox x:Name="QualitativeApproachComboBox" Height="40" Padding="10" VerticalContentAlignment="Center" FontSize="14" SelectionChanged="RefreshAudit_LostFocus">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </StackPanel>
                                <StackPanel x:Name="EpidemiologyTypePanel" Visibility="Collapsed" Margin="0,0,0,15">
                                    <TextBlock x:Name="DesignPrecisionLabel" Text="PrÃ©cision du Devis (MÃ©thodologie)" Style="{StaticResource LabelStyle}" FontWeight="SemiBold" Foreground="{StaticResource SecondaryBrush}"/>
                                    <ComboBox x:Name="EpidemiologyTypeComboBox" Height="40" Padding="10" VerticalContentAlignment="Center" FontSize="14" SelectionChanged="EpidemiologyTypeComboBox_SelectionChanged">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </StackPanel>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                       <ColumnDefinition Width="*"/>
                                       <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Cadre de l'Ã©tude (Lieu, PÃ©riode)" Style="{StaticResource LabelStyle}"/>
                                    <Button Grid.Column="1" Content="âž• Citer" Click="AddCitation_Click" Tag="StudySettingTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                <TextBox x:Name="StudySettingTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" LostFocus="RefreshAudit_LostFocus" Tag="OÃ¹ et quand se dÃ©roule l'Ã©tude ? (Ville, HÃ´pital, Services concernÃ©s...)"/>
                                <Border x:Name="PanelQualityGuidelines" Visibility="Collapsed" Background="#E8F5E9" BorderBrush="#4CAF50" BorderThickness="1" CornerRadius="5" Padding="15" Margin="0,15,0,0">
                                    <StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                            <TextBlock Text="âœ… CritÃ¨res de QualitÃ© MÃ©thodologique" FontWeight="Bold" FontSize="14" Foreground="#2E7D32" VerticalAlignment="Center"/>
                                            <TextBlock x:Name="QualityStandardName" Text="(COREQ/STROBE)" Foreground="#2E7D32" Margin="10,0,0,0" VerticalAlignment="Center" FontStyle="Italic"/>
                                        </StackPanel>
                                        <TextBlock Text="Cochez les Ã©lÃ©ments au fur et Ã  mesure que vous les intÃ©grez :" FontSize="11" Foreground="#555" Margin="0,0,0,10"/>
                                        <ScrollViewer MaxHeight="300" VerticalScrollBarVisibility="Auto">
                                            <StackPanel x:Name="QualityGuidelinesList"/>
                                        </ScrollViewer>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 6 : METHODOLOGIE - Population & CritÃ¨res -->
                <ScrollViewer x:Name="View_Methodology_Population" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="Ã‰tape 6/14 : MÃ©thodologie - Population &amp; CritÃ¨res" Tag="#F1F8E9" Foreground="#33691E">
                            <StackPanel>
                                <TextBlock Text="Population d'Ã©tude" Style="{StaticResource LabelStyle}"/>
                                 <TextBox x:Name="PopulationTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="DÃ©finissez la population source et la population cible (ex: Patients diabÃ©tiques de type 2)..."/>
                                <Border Background="#F5F5F5" BorderBrush="#DDDDDD" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,0,0,15">
                                    <StackPanel>
                                        <CheckBox x:Name="IsMulticentricCheckBox" Content="Ã‰tude Multicentrique" FontWeight="SemiBold" Margin="0,0,0,10" Checked="IsMulticentricCheckBox_Checked" Unchecked="IsMulticentricCheckBox_Unchecked"/>
                                        <StackPanel x:Name="MulticentricDetailsPanel" Visibility="Collapsed">
                                            <TextBlock Text="Centres participants (un par ligne) :" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                             <TextBox x:Name="StudyCentersTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" ToolTip="Listez les centres participants Ã  l'Ã©tude" Tag="Ex: CHU A, Centre MÃ©dical B, etc."/>
                                        </StackPanel>
                                    </StackPanel>
                                </Border>
                                <Grid Margin="0,0,0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0">
                                        <Grid Margin="0,0,0,2">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="CritÃ¨res d'Inclusion" Style="{StaticResource LabelStyle}"/>
                                            <Button Grid.Column="1" Content="âž• Citer" Click="AddCitation_Click" Tag="InclusionTextBox" Height="22" FontSize="10" Padding="5,0" Background="#E0E0E0" Foreground="Black"/>
                                        </Grid>
                                         <TextBox x:Name="InclusionTextBox" Height="80" TextWrapping="Wrap" AcceptsReturn="True" Tag="Ex: Ã‚ge > 18 ans, Consentement signÃ©..."/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="2">
                                        <TextBlock Text="CritÃ¨res de Non-Inclusion" Style="{StaticResource LabelStyle}"/>
                                         <TextBox x:Name="ExclusionTextBox" Height="80" TextWrapping="Wrap" AcceptsReturn="True" Tag="Ex: ComorbiditÃ©s graves, Grossesse..."/>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 7 : METHODOLOGIE - Echantillonnage -->
                <ScrollViewer x:Name="View_Methodology_Sampling" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="Ã‰tape 7/14 : MÃ©thodologie - Echantillonnage" Tag="#FFF8E1" Foreground="#FF6F00">
                            <StackPanel>
                                <Border Background="#FFF9E6" BorderBrush="#FFD700" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,0,0,15">
                                    <StackPanel>
                                        <TextBlock Text="âš™ï¸ Configuration de l'Ã‰chantillonnage" FontWeight="Bold" FontSize="13" Margin="0,0,0,10"/>
                                        <TextBlock Text="Type d'Ã©chantillonnage :" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                        <ComboBox x:Name="SamplingTypeComboBox" Height="32" Padding="8" VerticalContentAlignment="Center" FontSize="12" Margin="0,0,0,10" SelectionChanged="SamplingTypeComboBox_SelectionChanged">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>
                                        <StackPanel x:Name="StratificationPanel" Visibility="Collapsed" Margin="0,0,0,10">
                                            <CheckBox x:Name="IsStratifiedCheckBox" Content="Ã‰chantillonnage stratifiÃ©" FontSize="11" Margin="0,0,0,5" Checked="IsStratifiedCheckBox_Checked" Unchecked="IsStratifiedCheckBox_Unchecked"/>
                                            <StackPanel x:Name="StratificationDetailsPanel" Visibility="Collapsed">
                                                <TextBlock Text="CritÃ¨res de stratification :" FontSize="10" Foreground="#666" Margin="15,0,0,2"/>
                                                <TextBox x:Name="StratificationCriteriaTextBox" Height="40" TextWrapping="Wrap" AcceptsReturn="True" Margin="15,0,0,0" FontSize="11" ToolTip="Ex: Ã‚ge, Sexe, RÃ©gion gÃ©ographique..."/>
                                            </StackPanel>
                                        </StackPanel>
                                        <StackPanel x:Name="ClusterPanel" Visibility="Collapsed" Margin="0,0,0,10">
                                            <CheckBox x:Name="IsClusterCheckBox" Content="Ã‰chantillonnage en grappe" FontSize="11" Margin="0,0,0,5" Checked="IsClusterCheckBox_Checked" Unchecked="IsClusterCheckBox_Unchecked"/>
                                            <StackPanel x:Name="ClusterDetailsPanel" Visibility="Collapsed">
                                                <Grid Margin="15,0,0,0">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="10"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <StackPanel>
                                                        <TextBlock Text="Taille moyenne des grappes :" FontSize="10" Foreground="#666"/>
                                                        <TextBox x:Name="ClusterSizeTextBox" Height="28" FontSize="11" Foreground="Black" ToolTip="Nombre moyen de sujets par grappe"/>
                                                    </StackPanel>
                                                    <StackPanel Grid.Column="2">
                                                        <TextBlock Text="Effet de plan (Design Effect) :" FontSize="10" Foreground="#666"/>
                                                        <TextBox x:Name="DesignEffectTextBox" Text="1.5" Height="28" FontSize="11" Foreground="Black" ToolTip="GÃ©nÃ©ralement entre 1.5 et 2.0"/>
                                                    </StackPanel>
                                                </Grid>
                                            </StackPanel>
                                        </StackPanel>
                                        <Border Background="White" BorderBrush="#FFD700" BorderThickness="1" CornerRadius="4" Margin="0,10,0,0" Padding="10">
                                            <StackPanel>
                                                <TextBlock Text="Gestion des perdus de vue (Attrition)" FontWeight="Bold" FontSize="12" Margin="0,0,0,5"/>
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="15"/>
                                                        <ColumnDefinition Width="80"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Text="Taux estimÃ© :" VerticalAlignment="Center"/>
                                                    <TextBox Grid.Column="2" x:Name="ExpectedLossRateTextBox" Text="10" Height="35" FontSize="14" FontWeight="Bold" Foreground="Black" Background="White" BorderBrush="Gray" BorderThickness="1" VerticalContentAlignment="Center" HorizontalContentAlignment="Center" Padding="0"/>
                                                    <TextBlock Grid.Column="3" Text="%" VerticalAlignment="Center" Margin="5,0,0,0" FontSize="14"/>
                                                </Grid>
                                                <TextBlock Text="Ce taux sera ajoutÃ© Ã  la taille calculÃ©e pour garantir la puissance statistique." FontSize="10" Foreground="#777" Margin="0,3,0,0" FontStyle="Italic"/>
                                            </StackPanel>
                                        </Border>
                                    </StackPanel>
                                </Border>
                                <Border Background="#F0F4C3" CornerRadius="5" Padding="15" Margin="0,0,0,10" BorderBrush="#CDDC39" BorderThickness="1">
                                    <StackPanel>
                                        <TextBlock Text="âž— Assistant de Calcul de Taille d'Ã‰chantillon" FontWeight="Bold" FontSize="14" Foreground="#827717" Margin="0,0,0,10"/>
                                        <Grid Margin="0,0,0,10">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="MÃ©thode :" VerticalAlignment="Center" Margin="0,0,10,0" FontWeight="SemiBold"/>
                                            <ComboBox Grid.Column="1" x:Name="CalculatorSelector" Height="35" VerticalContentAlignment="Center" SelectionChanged="CalculatorSelector_SelectionChanged">
                                                <ComboBoxItem Content="Aucun (Saisie libre)" Tag="None" IsSelected="True"/>
                                                <ComboBoxItem Content="Estimation d'une PrÃ©valence (Cochran/Schwartz)" Tag="Cochran"/>
                                                <ComboBoxItem Content="Comparaison de 2 Proportions (Analytique)" Tag="Comparison"/>
                                            </ComboBox>
                                        </Grid>
                                    </StackPanel>
                                </Border>
                                <Border x:Name="PanelCochran" Visibility="Collapsed" Background="#F0F8FF" BorderBrush="#ADD8E6" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,0,0,10">
                                    <StackPanel>
                                        <TextBlock Text="Formule de Cochran / Schwartz (Population Finie ou Infinie)" FontSize="11" Foreground="#555" Margin="0,0,0,5"/>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <StackPanel Margin="0,0,5,0">
                                                <TextBlock Text="PrÃ©valence p (%)" FontSize="10"/>
                                                <TextBox x:Name="Calc_Cochran_P" Text="50" Foreground="Black" ToolTip="Ex: 50 pour 50%"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="1" Margin="0,0,5,0">
                                                <TextBlock Text="PrÃ©cision d (%)" FontSize="10"/>
                                                <TextBox x:Name="Calc_Cochran_D" Text="5" Foreground="Black" ToolTip="Marge d'erreur, ex: 5%"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="2" Margin="0,0,5,0">
                                                <TextBlock Text="Population N" FontSize="10" FontWeight="Bold"/>
                                                <TextBox x:Name="Calc_Cochran_N" Text="" Foreground="Black" ToolTip="Laisser vide si inconnue/infinie"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="3" Margin="0,0,5,0">
                                                <TextBlock Text="Confiance (Z)" FontSize="10"/>
                                                <ComboBox x:Name="Calc_Cochran_Z" SelectedIndex="1">
                                                    <ComboBoxItem Content="90%" Tag="1.65"/>
                                                    <ComboBoxItem Content="95%" Tag="1.96"/>
                                                    <ComboBoxItem Content="99%" Tag="2.58"/>
                                                </ComboBox>
                                            </StackPanel>
                                            <Button Grid.Column="4" Content="Calculer" Click="CalculateCochran_Click" Padding="10,0" VerticalAlignment="Bottom" Height="22"/>
                                        </Grid>
                                        <TextBlock x:Name="ResultCochran" Text="N = ?" FontWeight="Bold" Foreground="#007ACC" Margin="0,5,0,0" HorizontalAlignment="Right"/>
                                    </StackPanel>
                                </Border>
                                <Border x:Name="PanelComparison" Visibility="Collapsed" Background="#FFF5E5" BorderBrush="#FFDAB9" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,0,0,10">
                                    <StackPanel>
                                        <TextBlock Text="Comparaison de Deux Proportions (Cas-TÃ©moins / Cohorte)" FontSize="11" Foreground="#555" Margin="0,0,0,5"/>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <StackPanel Margin="0,0,5,0">
                                                <TextBlock Text="P1 (ExposÃ©s/Cas) %" FontSize="10"/>
                                                <TextBox x:Name="Calc_Comp_P1" Text="30" Foreground="Black"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="1" Margin="0,0,5,0">
                                                <TextBlock Text="P2 (TÃ©moins/Non) %" FontSize="10"/>
                                                <TextBox x:Name="Calc_Comp_P2" Text="15" Foreground="Black"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="2" Margin="0,0,5,0">
                                                <TextBlock Text="Confiance (Alpha)" FontSize="10"/>
                                                <ComboBox x:Name="Calc_Comp_Alpha" SelectedIndex="1">
                                                    <ComboBoxItem Content="5% (1.96)" Tag="1.96"/>
                                                    <ComboBoxItem Content="1% (2.58)" Tag="2.58"/>
                                                </ComboBox>
                                            </StackPanel>
                                            <StackPanel Grid.Column="3" Margin="0,0,5,0">
                                                <TextBlock Text="Puissance (1-Beta)" FontSize="10"/>
                                                <ComboBox x:Name="Calc_Comp_Power" SelectedIndex="1">
                                                    <ComboBoxItem Content="80% (0.84)" Tag="0.84"/>
                                                    <ComboBoxItem Content="90% (1.28)" Tag="1.28"/>
                                                </ComboBox>
                                            </StackPanel>
                                            <StackPanel Grid.Column="4" VerticalAlignment="Bottom">
                                                <CheckBox x:Name="Chk_Matched" Content="AppariÃ© ?" ToolTip="Cocher si Cas et TÃ©moins sont appariÃ©s (Matching)" FontSize="10" Margin="0,0,0,5"/>
                                                <Button Content="Calculer" Click="CalculateComparison_Click" Padding="10,0" Height="22"/>
                                            </StackPanel>
                                        </Grid>
                                        <TextBlock x:Name="ResultComparison" Text="N par groupe = ?" FontWeight="Bold" Foreground="#D2691E" Margin="0,5,0,0" HorizontalAlignment="Right"/>
                                    </StackPanel>
                                </Border>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Texte final sur l'Ã©chantillonnage :" Style="{StaticResource LabelStyle}"/>
                                    <Button Grid.Column="1" Content="âž• Citer" Click="AddCitation_Click" Tag="SamplingTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                 <TextBox x:Name="SamplingTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="DÃ©taillez la procÃ©dure de sÃ©lection des participants (ex: tirage au sort, recrutement consÃ©cutif...)"/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 8 : METHODOLOGIE - Collecte de donnÃ©es -->
                <ScrollViewer x:Name="View_Methodology_Data" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="Ã‰tape 8/13 : MÃ©thodologie - Collecte de donnÃ©es" Tag="#E0F2F1" Foreground="#00695C">
                            <StackPanel>
                                <Border Background="#E8F5E9" CornerRadius="5" Padding="10" Margin="0,0,0,15" BorderBrush="#4CAF50" BorderThickness="1">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel>
                                            <TextBlock Text="ðŸ“ Dictionnaire des Variables / Masque de Saisie" FontWeight="Bold" Foreground="#2E7D32"/>
                                            <TextBlock Text="DÃ©finissez les variables de l'Ã©tude (comme dans Epi Info 'Make View')" FontSize="11" Foreground="#555"/>
                                        </StackPanel>
                                        <Button Grid.Column="1" Content="Ouvrir le Concepteur" Padding="15,5" Background="#4CAF50" Foreground="White" BorderThickness="0" Click="OpenVariableDesigner_Click" Cursor="Hand">
                                            <Button.Resources>
                                                <Style TargetType="Border">
                                                    <Setter Property="CornerRadius" Value="4"/>
                                                </Style>
                                            </Button.Resources>
                                        </Button>
                                    </Grid>
                                </Border>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="ProcÃ©dures de Collecte" Style="{StaticResource LabelStyle}"/>
                                    <Button Grid.Column="1" Content="âž• Citer" Click="AddCitation_Click" Tag="DataCollectionTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                 <TextBox x:Name="DataCollectionTextBox" Height="250" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10" Tag="DÃ©crivez les outils (Questionnaires, Mesures cliniques) et les procÃ©dures de collecte..."/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 9 : BUDGET -->
                <ScrollViewer x:Name="View_Budget" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="Ã‰tape 9/14 : Budget &amp; Ressources" Tag="#FFF3E0" Foreground="#EF6C00">
                            <StackPanel>
                                <TextBlock Text="Estimation des Ressources &amp; Budget" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                <Border x:Name="BudgetSuggestionsPanel" Background="#E3F2FD" BorderBrush="#2196F3" BorderThickness="1" CornerRadius="5" Padding="15" Margin="0,0,0,15">
                                    <StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                            <TextBlock Text="ðŸ’¡ Suggestions basÃ©es sur votre mÃ©thode :" FontWeight="Bold" Foreground="#1565C0"/>
                                            <TextBlock x:Name="BudgetSuggestionType" Text="(Type)" Margin="5,0,0,0" FontStyle="Italic" Foreground="#1565C0"/>    
                                        </StackPanel>
                                        <TextBlock x:Name="BudgetSuggestionsText" Text="â€¢ Personnel..." TextWrapping="Wrap" FontSize="13"/>
                                    </StackPanel>
                                </Border>
                                <TextBlock Text="DÃ©tail du Budget" Style="{StaticResource LabelStyle}"/>
                                <TextBox x:Name="BudgetTextBox" Height="200" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15" VerticalContentAlignment="Top" Padding="10"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Total EstimÃ© (Devise locale) :" VerticalAlignment="Center" FontWeight="Bold"/>
                                    <TextBox Grid.Column="1" x:Name="BudgetTotalBox" Margin="10,0,0,0" Height="30" Width="150" HorizontalAlignment="Left"/>
                                </Grid>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 10 : CONSIDERATIONS ETHIQUES -->
                <ScrollViewer x:Name="View_Ethics" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                     <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="Ã‰tape 10/14 : ConsidÃ©rations Ã‰thiques" Tag="#FFEBEE" Foreground="#C62828">
                            <StackPanel>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="ConsidÃ©rations Ã‰thiques" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                    <Button Grid.Column="1" Content="âž• Citer" Click="AddCitation_Click" Tag="EthicsTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                <TextBlock Text="DÃ©crivez les mesures prises pour protÃ©ger les participants (consentement, confidentialitÃ©, approbation Ã©thique...)." FontSize="11" Foreground="#666" Margin="0,0,0,5"/>
                                <TextBox x:Name="EthicsTextBox" Height="150" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15"/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 11 : PLAN D'ANALYSE -->
                <ScrollViewer x:Name="View_DataAnalysis" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="Ã‰tape 11/14 : Plan d'Analyse des DonnÃ©es" Tag="#EDE7F6" Foreground="#4527A0">
                            <StackPanel>
                                <TextBlock Text="Cette section est CRUCIALE : elle dÃ©finit comment vous allez rÃ©pondre Ã  vos objectifs." FontSize="11" Foreground="#666" Margin="0,0,0,15" FontStyle="Italic"/>
                                <Grid Margin="0,0,0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Description du Plan d'Analyse" Style="{StaticResource LabelStyle}" VerticalAlignment="Center"/>
                                    <Button Grid.Column="1" Content="âœ¨ GÃ©nÃ©rer Plan Automatique" Click="GenerateProtocolPlan_Click" Height="25" FontSize="11" Padding="12,0" Margin="0,0,8,0" Background="#FFF3E0" Foreground="#E65100" BorderBrush="#FFCC80" BorderThickness="1"/>
                                    <Button Grid.Column="2" Content="âž• Citer" Click="AddCitation_Click" Tag="DataAnalysisTextBox" Height="25" FontSize="11" Padding="10,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                <TextBox x:Name="DataAnalysisTextBox" Height="350" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10" Tag="Le plan gÃ©nÃ©rÃ© apparaÃ®tra ici. Vous pouvez ensuite le modifier librement."/>
                                <Border Background="#E3F2FD" Padding="10" CornerRadius="5">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="â„¹ï¸" Margin="0,0,10,0"/>
                                        <TextBlock Text="Le plan rÃ©digÃ© ici sera automatiquement disponible dans l'onglet 'Analyse' de la fenÃªtre principale." FontSize="11" Foreground="#1565C0" TextWrapping="Wrap"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 12 : RESULTATS ATTENDUS -->
                <ScrollViewer x:Name="View_Results" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="Ã‰tape 12/14 : RÃ©sultats Attendus" Tag="#E0F7FA" Foreground="#006064">
                            <StackPanel>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="RÃ©sultats Attendus" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                    <Button Grid.Column="1" Content="âž• Citer" Click="AddCitation_Click" Tag="ExpectedResultsTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                <TextBlock Text="Quels sont les rÃ©sultats escomptÃ©s et leur impact ?" FontSize="11" Foreground="#666" Margin="0,0,0,5"/>
                                <TextBox x:Name="ExpectedResultsTextBox" Height="200" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15"/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 13 : CONCLUSION -->
                <ScrollViewer x:Name="View_Conclusion" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="Ã‰tape 13/13 : Conclusion" Tag="#ECEFF1" Foreground="#37474F">
                            <StackPanel>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Conclusion" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                    <Button Grid.Column="1" Content="âž• Citer" Click="AddCitation_Click" Tag="ConclusionTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                <TextBlock Text="SynthÃ¨se, retombÃ©es et recommandations." FontSize="11" Foreground="#666" Margin="0,0,0,5"/>
                                <TextBox x:Name="ConclusionTextBox" Height="200" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15"/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- Ã‰TAPE 14 : REFERENCES -->
                <ScrollViewer x:Name="View_References" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="Ã‰tape 14/14 : RÃ©fÃ©rences Bibliographiques" Tag="#FAFAFA" Foreground="#424242">
                            <StackPanel>
                                <Grid Margin="0,0,0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="RÃ©fÃ©rences Bibliographiques" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                    <ComboBox Grid.Column="1" x:Name="RefStyleComboStep14" Height="30" Width="150" VerticalContentAlignment="Center" SelectionChanged="RefStyleCombo_SelectionChanged" SelectedIndex="0"/>
                                </Grid>
                                <TextBlock Text="Liste gÃ©nÃ©rÃ©e automatiquement :" FontSize="11" Foreground="#666" Margin="0,0,0,5"/>
                                <TextBox x:Name="ReferencesTextBox" Height="500" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" VerticalScrollBarVisibility="Auto" IsReadOnly="False"/>
                                <Button Content="ðŸ”„ RÃ©gÃ©nÃ©rer la liste" Click="RegenerateReferences_Click" HorizontalAlignment="Right" Width="150" Height="30" FontSize="12"/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Grid>

        <!-- Barre d'action fixe en bas -->
        <Border Grid.Row="2" Background="White" BorderBrush="#EEEEEE" BorderThickness="0,1,0,0" Padding="15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Navigation Gauche -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Content="â¬…ï¸ PrÃ©cÃ©dent" Click="PrevSection_Click" Height="40" Width="120" Margin="0,0,10,0" Background="#F0F0F0" Foreground="Black" BorderThickness="0"/>
                    <Button Content="Suivant âž¡ï¸" Click="NextSection_Click" Height="40" Width="120" Background="#F0F0F0" Foreground="Black" BorderThickness="0"/>
                </StackPanel>

                <!-- Zone de messages de validation -->
                <ListBox Grid.Column="1" x:Name="ValidationMessagesListBox" BorderThickness="0" Background="Transparent" Foreground="{StaticResource ErrorBrush}" FontSize="12" MaxHeight="60" Margin="20,0,20,0" VerticalAlignment="Center"/>

                <!-- Bouton Action -->
                <Button Grid.Column="2" Content="Valider et Enregistrer" Click="CreateProtocol_Click" Height="45" Width="200" FontSize="15" FontWeight="Bold"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>
