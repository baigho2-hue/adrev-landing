ADREV 2.0 CODEBASE DIGEST

G√©n√©r√© le : 01/23/2026 20:27:26

====================================


FILE: \AdRev.CLI\Program.cs
------------------------------------
using System;
using AdRev.Core.Services;
using AdRev.Domain.Models;

namespace AdRev.CLI
{
    class Program
    {
        static void Main(string[] args)
        {
            if (args.Length == 0)
            {
                PrintHelp();
                return;
            }

            try
            {
                string cmd = args[0].ToLower();
                switch (cmd)
                {
                    case "generate":
                        Generate(args);
                        break;
                    case "inspect":
                        Inspect(args);
                        break;
                    case "get-hwid":
                        GetHwid();
                        break;
                    default:
                        PrintHelp();
                        break;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error: {ex.Message}");
                Environment.Exit(1);
            }
        }

        static void Generate(string[] args)
        {
            // Parse arguments
            string hwid = GetArg(args, "--hwid");
            string typeStr = GetArg(args, "--type") ?? "Lifetime";
            string email = GetArg(args, "--email") ?? "";
            string label = GetArg(args, "--label") ?? "";
            string daysStr = GetArg(args, "--days");

            if (string.IsNullOrEmpty(hwid))
            {
                Console.WriteLine("Error: --hwid is required.");
                Environment.Exit(1);
            }

            if (!Enum.TryParse(typeStr, true, out LicenseType type))
            {
                Console.WriteLine($"Error: Invalid license type '{typeStr}'. Valid values: Lifetime, Annual, Enterprise, Student, Trial.");
                Environment.Exit(1);
            }

            DateTime expiry = DateTime.MaxValue;
            if (type == LicenseType.Annual) expiry = DateTime.UtcNow.AddYears(1);
            else if (type == LicenseType.Trial) expiry = DateTime.UtcNow.AddDays(7);
            
            // Override days if provided
            if (int.TryParse(daysStr, out int days))
            {
                expiry = DateTime.UtcNow.AddDays(days);
            }

            Console.WriteLine("--- License Details ---");
            Console.WriteLine($"Target HWID : {hwid}");
            Console.WriteLine($"License Type: {type}");
            Console.WriteLine($"Label/Tag   : {(string.IsNullOrEmpty(label) ? "N/A" : label)}");
            Console.WriteLine($"Expiry Date : {(expiry == DateTime.MaxValue ? "Lifetime" : expiry.ToShortDateString())}");
            Console.WriteLine("-----------------------");

            // Logic
            var service = new LicensingService();
            string key = service.GenerateLicense(hwid, type, 1, expiry, email, label);

            Console.WriteLine("LICENSE_KEY_START");
            Console.WriteLine(key);
            Console.WriteLine("LICENSE_KEY_END");
        }

        static void Inspect(string[] args)
        {
            string key = GetArg(args, "--key");
            if (string.IsNullOrEmpty(key))
            {
                Console.WriteLine("Error: --key is required.");
                Environment.Exit(1);
            }

            var service = new LicensingService();
            var meta = service.InspectLicense(key);

            if (meta == null)
            {
                Console.WriteLine("INVALID LICENSE: Could not decrypt or signature mismatch.");
                Environment.Exit(1);
            }

            Console.WriteLine("--- Decoded License ---");
            Console.WriteLine($"HWID        : {meta.Hwid}");
            Console.WriteLine($"Type        : {meta.Type}");
            Console.WriteLine($"Expiry      : {meta.ExpiryDate}");
            Console.WriteLine($"Max Seats   : {meta.MaxSeats}");
            Console.WriteLine($"Email       : {meta.RegisteredEmail}");
            Console.WriteLine($"Label       : {meta.FeaturesLabel}");
            Console.WriteLine($"Signature   : {meta.Signature}");
            Console.WriteLine("-----------------------");
        }

        static void GetHwid()
        {
            var service = new LicensingService();
            Console.WriteLine(service.GetHardwareId());
        }

        static string? GetArg(string[] args, string name)
        {
            for (int i = 0; i < args.Length - 1; i++)
            {
                if (string.Equals(args[i], name, StringComparison.OrdinalIgnoreCase))
                    return args[i + 1];
            }
            return null;
        }

        static void PrintHelp()
        {
            Console.WriteLine("AdRev License Generator CLI");
            Console.WriteLine("Commands:");
            Console.WriteLine("  generate   : Create a new license key");
            Console.WriteLine("  inspect    : Decode and verify a license key");
            Console.WriteLine("  get-hwid   : Show the HWID of the current machine");
            Console.WriteLine("");
            Console.WriteLine("Usage (Generate):");
            Console.WriteLine("  AdRev.CLI generate --hwid <ID> [--type <Type>] [--email <Email>] [--label <Label>] [--days <Days>]");
            Console.WriteLine("");
            Console.WriteLine("Usage (Inspect):");
            Console.WriteLine("  AdRev.CLI inspect --key <LicenseKey>");
        }
    }
}




FILE: \AdRev.Core\Common\ResearchProjectService.cs
------------------------------------
using AdRev.Domain.Enums;
using AdRev.Domain.Models;
using System.IO;
using System.Text.Json;

namespace AdRev.Core.Common
{
    public class ResearchProjectService
    {
        private readonly string _storagePath;

        public ResearchProjectService()
        {
            var folder = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments), "AdRev", "Projects");
            Directory.CreateDirectory(folder);
            _storagePath = folder;
        }

        public ResearchProject CreateNew(string title, StudyType studyType, ProjectContext context, ScientificDomain domain, string authors, string institution, string? customPath = null)
        {
            var project = new ResearchProject
            {
                Title = title,
                StudyType = studyType,
                Context = context,
                Domain = domain,
                Authors = authors,
                Institution = institution,
                CreatedOn = DateTime.Now,
                Version = "1.0.0"
            };

            // Generate clean folder name based on Title + Date
            string safeTitle = string.Join("_", title.Split(Path.GetInvalidFileNameChars()));
            string folderName = $"{safeTitle}_{DateTime.Now:yyyyMMdd}";
            
            string baseDir = _storagePath;
            if (!string.IsNullOrWhiteSpace(customPath) && Directory.Exists(customPath))
            {
                baseDir = customPath;
            }

            string projectDir = Path.Combine(baseDir, folderName);
            if (!Directory.Exists(projectDir)) Directory.CreateDirectory(projectDir);

            // Create Scientific Folder Hierarchy
            Directory.CreateDirectory(Path.Combine(projectDir, "01_Protocol"));
            Directory.CreateDirectory(Path.Combine(projectDir, "02_Data", "Raw"));
            Directory.CreateDirectory(Path.Combine(projectDir, "02_Data", "Processed"));
            Directory.CreateDirectory(Path.Combine(projectDir, "03_Analysis"));
            Directory.CreateDirectory(Path.Combine(projectDir, "04_Manuscripts"));
            Directory.CreateDirectory(Path.Combine(projectDir, "99_Resources"));

            // Save Project File
            string fileName = "adrev_project.json";
            string filePath = Path.Combine(projectDir, fileName);
            project.FilePath = filePath;

            var json = JsonSerializer.Serialize(project, new JsonSerializerOptions { WriteIndented = true });
            File.WriteAllText(filePath, json);

            // Create Link if needed (if created outside default storage)
            if (baseDir != _storagePath)
            {
                var linkContent = new { LinkedPath = filePath };
                string linkFile = Path.Combine(_storagePath, $"Link_{DateTime.Now:yyyyMMddHHmmss}.json");
                File.WriteAllText(linkFile, JsonSerializer.Serialize(linkContent));
            }

            return project;
        }
        public ResearchProject CreateProjectFromProtocol(AdRev.Domain.Protocols.ResearchProtocol protocol)
        {
            if (protocol == null) throw new ArgumentNullException(nameof(protocol));

            var project = CreateNew(
                title: protocol.Title,
                studyType: protocol.StudyType,
                context: ProjectContext.Other, // Default or map if possible
                domain: protocol.Domain,
                authors: $"{protocol.PrincipalAuthor?.FirstName} {protocol.PrincipalAuthor?.LastName}",
                institution: protocol.PrincipalAuthor?.Institution ?? "Unknown"
            );

            // Populate Additional Data
            project.SourceProtocolId = protocol.Id;
            project.GeneralObjective = protocol.GeneralObjective;
            project.ProblemJustification = protocol.ProblemJustification ?? protocol.Context;
            project.DataAnalysisPlan = protocol.DataAnalysis;
            
            // Map other useful fields if they exist in Project model
            project.LimitationsContent = protocol.StudyLimitations;
            
            // Save updates
            SaveProject(project);

            return project;
        }

        public ResearchProject ImportFromFolder(string folderPath)
        {
            // 1. Check for standard "adrev_project.json"
            string standardFile = Path.Combine(folderPath, "adrev_project.json");
            if (File.Exists(standardFile))
            {
                 // Create Link
                var linkContent = new { LinkedPath = standardFile };
                string linkFile = Path.Combine(_storagePath, $"Link_Import_{Guid.NewGuid()}.json");
                File.WriteAllText(linkFile, JsonSerializer.Serialize(linkContent));
                
                var json = File.ReadAllText(standardFile);
                return JsonSerializer.Deserialize<ResearchProject>(json) ?? new ResearchProject();
            }

            // 2. Fallback: Check for legacy "Project_*.json"
            var existingFiles = Directory.GetFiles(folderPath, "Project_*.json");
            if (existingFiles.Any())
            {
                var linkContent = new { LinkedPath = existingFiles.First() };
                string linkFile = Path.Combine(_storagePath, $"Link_Import_{Guid.NewGuid()}.json");
                File.WriteAllText(linkFile, JsonSerializer.Serialize(linkContent));
                var json = File.ReadAllText(existingFiles.First());
                var proj = JsonSerializer.Deserialize<ResearchProject>(json);
                if (proj != null) proj.FilePath = existingFiles.First(); // Ensure path set
                return proj ?? new ResearchProject();
            }
            else
            {
                // 3. Import RAW folder -> Create Wrapper + Structure
                string dirName = new DirectoryInfo(folderPath).Name;
                // We create a NEW project structure INSIDE the selected folder to avoid moving files? 
                // OR we treat the folder AS the project root and add our structure.
                // Let's add our structure non-destructively.
                
                // Create Scientific Folder Hierarchy (if missing)
                Directory.CreateDirectory(Path.Combine(folderPath, "01_Protocol"));
                Directory.CreateDirectory(Path.Combine(folderPath, "02_Data", "Raw"));
                Directory.CreateDirectory(Path.Combine(folderPath, "02_Data", "Processed"));
                Directory.CreateDirectory(Path.Combine(folderPath, "03_Analysis"));
                Directory.CreateDirectory(Path.Combine(folderPath, "04_Manuscripts"));
                Directory.CreateDirectory(Path.Combine(folderPath, "99_Resources"));

                // Create Project File
                var project = new ResearchProject
                {
                    Title = dirName,
                    StudyType = StudyType.Mixed,
                    Context = ProjectContext.Other,
                    Domain = ScientificDomain.Biomedical,
                    Authors = "Imported User",
                    Institution = "Local",
                    CreatedOn = DateTime.Now,
                    Version = "1.0.0",
                    FilePath = Path.Combine(folderPath, "adrev_project.json")
                };

                var json = JsonSerializer.Serialize(project, new JsonSerializerOptions { WriteIndented = true });
                File.WriteAllText(project.FilePath, json);

                // Link it
                var linkContent = new { LinkedPath = project.FilePath };
                string linkFile = Path.Combine(_storagePath, $"Link_Import_{Guid.NewGuid()}.json");
                File.WriteAllText(linkFile, JsonSerializer.Serialize(linkContent));

                return project;
            }
        }

        public List<ResearchProject> GetAllProjects()
        {
            var projects = new List<ResearchProject>();
            if (!Directory.Exists(_storagePath)) return projects;

            // 1. Load Local Projects (Legacy + New)
            var files = Directory.GetFiles(_storagePath, "Project_*.json").ToList();
            files.AddRange(Directory.GetFiles(_storagePath, "adrev_project.json")); // unlikely in root but possible

            foreach (var file in files)
            {
                try
                {
                    var json = File.ReadAllText(file);
                    var project = JsonSerializer.Deserialize<ResearchProject>(json);
                    if (project != null)
                    {
                        project.FilePath = file;
                        projects.Add(project);
                    }
                }
                catch { /* Skip */ }
            }

            // 2. Load Linked Projects
            var links = Directory.GetFiles(_storagePath, "Link_*.json");
            foreach (var link in links)
            {
                try
                {
                    var jsonLink = File.ReadAllText(link);
                    using (JsonDocument doc = JsonDocument.Parse(jsonLink))
                    {
                        if (doc.RootElement.TryGetProperty("LinkedPath", out JsonElement pathEl))
                        {
                            string? targetPath = pathEl.GetString();
                            if (!string.IsNullOrEmpty(targetPath) && File.Exists(targetPath))
                            {
                                var jsonProj = File.ReadAllText(targetPath);
                                var project = JsonSerializer.Deserialize<ResearchProject>(jsonProj);
                                if (project != null)
                                {
                                    project.FilePath = targetPath;
                                    // Avoid duplicates if somehow linked and local overlap
                                    if (!projects.Any(p => p.FilePath == targetPath))
                                        projects.Add(project);
                                }
                            }
                        }
                    }
                }
                catch { /* Skip broken links */ }
            }

            return projects.OrderByDescending(p => p.CreatedOn).ToList();
        }

        public void SaveProject(ResearchProject project)
        {
            if (project != null && !string.IsNullOrEmpty(project.FilePath))
            {
                var json = JsonSerializer.Serialize(project, new JsonSerializerOptions { WriteIndented = true });
                File.WriteAllText(project.FilePath, json);
            }
        }

        public void DeleteProject(ResearchProject project)
        {
            if (project != null && !string.IsNullOrEmpty(project.FilePath) && File.Exists(project.FilePath))
            {
                File.Delete(project.FilePath);
            }
        }
    }
}





FILE: \AdRev.Core\Extensions\EnumExtensions.cs
------------------------------------
using System;
using System.ComponentModel;
using System.Reflection;

namespace AdRev.Core.Extensions
{
    public static class EnumExtensions
    {
        public static string GetDescription(this Enum value)
        {
            FieldInfo? fi = value.GetType().GetField(value.ToString());

            if (fi == null) return value.ToString();

            DescriptionAttribute[] attributes = (DescriptionAttribute[])fi.GetCustomAttributes(typeof(DescriptionAttribute), false);

            if (attributes != null && attributes.Length > 0)
                return attributes[0].Description;
            else
                return value.ToString();
        }
    }
}




FILE: \AdRev.Core\Methodology\MethodologyService.cs
------------------------------------
using AdRev.Domain.Methodology;
using AdRev.Domain.Protocols;

namespace AdRev.Core.Methodology
{
    public class MethodologyService
    {
        public MethodologyCheck CheckProtocol(ResearchProtocol protocol)
        {
            return new MethodologyCheck(protocol);
        }
    }
}




FILE: \AdRev.Core\Protocols\ProtocolService.cs
------------------------------------
using AdRev.Domain.Protocols;
using System.IO;
using System.Text.Json;

namespace AdRev.Core.Protocols
{
    public class ProtocolService
    {
        private readonly string _storagePath;

        public ProtocolService()
        {
            var folder = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments), "AdRev", "Protocols");
            Directory.CreateDirectory(folder);
            _storagePath = folder;
        }

        public ResearchProtocol Create(ResearchProtocol protocol, string? projectName = null)
        {
            // ID is already generated in Model constructor as GUID
            if (string.IsNullOrEmpty(protocol.Id))
            {
                protocol.Id = Guid.NewGuid().ToString();
            }
            
            // Determine Folder Path
            string targetFolder = _storagePath; // Default "Protocols"
            
            if (!string.IsNullOrWhiteSpace(projectName))
            {
                // Sanitize Project Name
                var safeName = string.Join("_", projectName.Split(Path.GetInvalidFileNameChars()));
                // Use a dedicated Projects folder structure ? Or just mix in Protocols ? 
                // Let's make a dedicated Project Folder: AdRev/Projects/[ProjectName]
                
                var projectsRoot = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments), "AdRev", "Projects");
                var projectDir = Path.Combine(projectsRoot, safeName); // Uniqueness?
                
                // Ensure unique if new, or use existing if updating? 
                // For simplified flow, assume 1 project = 1 folder.
                Directory.CreateDirectory(projectDir);
                
                // Create References subfolder
                Directory.CreateDirectory(Path.Combine(projectDir, "References"));
                
                targetFolder = projectDir;
            }

            var fileName = $"Protocol_{protocol.Id}.json"; // Fixed name so we overwrite checks? OR Timestamped?
            // User requested "keep documents... access at any time". Overwriting 'latest' seems better for a "Save" button than creating history files. Or maybe maintain history.
            // Let's stick to unique file for now, or maybe simplified "protocol.json" if inside a project folder?
            // Let's keep ID to be safe from conflict.
            
            var filePath = Path.Combine(targetFolder, fileName);

            var json = JsonSerializer.Serialize(protocol, new JsonSerializerOptions { WriteIndented = true });
            File.WriteAllText(filePath, json);

            return protocol;
        }

        public List<ResearchProtocol> GetAllProtocols()
        {
            var protocols = new List<ResearchProtocol>();
            if (!Directory.Exists(_storagePath)) return protocols;

            // Search in default folder
            // Use search pattern for json files that look like protocols
            var files = Directory.GetFiles(_storagePath, "Protocol_*.json", SearchOption.AllDirectories);
            
            foreach (var file in files) 
            {
                try 
                {
                    var json = File.ReadAllText(file);
                    // Simple check or try deserialize
                    var p = JsonSerializer.Deserialize<ResearchProtocol>(json);
                    if (p != null) protocols.Add(p);
                }
                catch { }
            }
            // Sort by Date Descending
            protocols.Sort((a, b) => b.CreatedAt.CompareTo(a.CreatedAt));
            return protocols;
        }
    }
}




FILE: \AdRev.Core\Protocols\ProtocolValidator.cs
------------------------------------
using AdRev.Domain.Protocols;
using System.Collections.Generic;
using System.Linq;

namespace AdRev.Core.Protocols
{
    public class ValidationResult
    {
        public int Score { get; set; }
        public List<string> Errors { get; set; } = new List<string>();
        public List<string> Suggestions { get; set; } = new List<string>();

        // Helper methods for convenience, assuming they are intended to be added or already exist
        public void AddError(string error) => Errors.Add(error);
        public void AddSuggestion(string suggestion) => Suggestions.Add(suggestion);
    }

    public class ProtocolValidator
    {
        // This method was part of the user's provided snippet but seems to be a placeholder
        // for a refactoring that is not part of the current instruction.
        // private ValidationResult CheckBloomTaxonomy(ResearchProtocol protocol, ValidationResult result)
        // {
        //     return result;
        // }

        private void CheckStudyDesignCompliance(ResearchProtocol protocol, ValidationResult result)
        {
            // Assuming EpidemiologicalStudyType enum is defined in AdRev.Domain.Protocols or a related namespace
            // For this change, I'll assume it's accessible.
            if (protocol.EpidemiologyType == AdRev.Domain.Enums.EpidemiologicalStudyType.None) return;

            string methodology = (protocol.StudySetting + " " + protocol.StudyPopulation + " " + protocol.DataCollection + " " + protocol.SamplingMethod).ToLower();
            string objectives = (protocol.GeneralObjective + " " + protocol.SpecificObjectives).ToLower();

            // 1. Essais Cliniques / ExpÈrimentales
            if (protocol.EpidemiologyType == AdRev.Domain.Enums.EpidemiologicalStudyType.RandomizedControlledTrial ||
                protocol.EpidemiologyType == AdRev.Domain.Enums.EpidemiologicalStudyType.QuasiExperimental)
            {
                if (!methodology.Contains("randomis") && protocol.EpidemiologyType == AdRev.Domain.Enums.EpidemiologicalStudyType.RandomizedControlledTrial)
                {
                    result.AddError("? Pour un Essai RandomisÈ, vous devez dÈcrire la mÈthode de RANDOMISATION (blocs, simple, table...).");
                    result.Score -= 10;
                }
                if (!methodology.Contains("aveugle") && !methodology.Contains("insu") && !methodology.Contains("ouvert"))
                {
                    result.AddError("? PrÈcisez si l'Ètude est en simple/double AVEUGLE (insu) ou en OUVERT.");
                    result.Score -= 5;
                }
                if (!methodology.Contains("groupe") && !methodology.Contains("bras"))
                {
                     result.AddSuggestion("?? Mentionnez clairement les GROUPES (Intervention vs TÈmoin/ContrÙle).");
                }
            }

            // 2. Cas-TÈmoins
            else if (protocol.EpidemiologyType == AdRev.Domain.Enums.EpidemiologicalStudyType.CaseControl)
            {
                if (!methodology.Contains("cas") || !methodology.Contains("tÈmoin") && !methodology.Contains("temoin"))
                {
                    result.AddError("? Une Ètude Cas-TÈmoins exige une dÈfinition stricte des 'CAS' et des 'T…MOINS'.");
                    result.Score -= 10;
                }
                if (!methodology.Contains("apparie") && !methodology.Contains("match"))
                {
                    result.AddSuggestion("?? Avez-vous prÈvu un APPARIEMENT (matching) entre cas et tÈmoins ? Si non, justifiez.");
                }
                if (!protocol.DataAnalysis.ToLower().Contains("odds") && !protocol.DataAnalysis.ToLower().Contains("rapport de cote"))
                {
                     result.AddError("? L'analyse statistique d'une Ètude Cas-TÈmoins doit mentionner le calcul de l'ODDS RATIO (OR).");
                     result.Score -= 5;
                }
            }

            // 3. Cohorte
            else if (protocol.EpidemiologyType == AdRev.Domain.Enums.EpidemiologicalStudyType.CohortProspective ||
                     protocol.EpidemiologyType == AdRev.Domain.Enums.EpidemiologicalStudyType.CohortRetrospective)
            {
                if (!methodology.Contains("suivi") && !methodology.Contains("suivre") && !methodology.Contains("durÈe"))
                {
                    result.AddError("? Une Ètude de Cohorte nÈcessite la mnetion d'une pÈriode de SUIVI.");
                    result.Score -= 5;
                }
                if (!methodology.Contains("expos"))
                {
                    result.AddError("? DÈfinissez clairement les groupes EXPOS…S et NON-EXPOS…S.");
                    result.Score -= 5;
                }
                if (!protocol.DataAnalysis.ToLower().Contains("relatif") && !protocol.DataAnalysis.ToLower().Contains("incidence"))
                {
                     result.AddSuggestion("?? L'analyse devrait viser le calcul du RISQUE RELATIF ou du Ratio d'Incidence.");
                }
            }
            
            // 4. Transversale
            else if (protocol.EpidemiologyType == AdRev.Domain.Enums.EpidemiologicalStudyType.CrossSectionalDescriptive)
            {
                 if (!methodology.Contains("pÈriode") && !methodology.Contains("date"))
                 {
                     result.AddSuggestion("?? Une Ètude transversale est une 'photographie'. PrÈcisez bien la P…RIODE de collecte.");
                 }
            }
        }

        public ValidationResult Validate(ResearchProtocol protocol)
        {
            var result = new ValidationResult { Score = 100 };
            var errors = result.Errors;
            var suggestions = result.Suggestions;

            // 1. Titre (Impact: 10 pts)
            if (string.IsNullOrWhiteSpace(protocol.Title))
            {
                errors.Add("? Titre manquant.");
                result.Score -= 10;
            }
            else if (protocol.Title.Length < 15)
            {
                suggestions.Add("?? Le titre est trËs court. Assurez-vous qu'il contient les variables principales et la population d'Ètude.");
                result.Score -= 5;
            }

            // 1 bis. Introduction StructurÈe (Impact: 20 pts)
            int introLength = (protocol.Context?.Length ?? 0) + (protocol.ProblemJustification?.Length ?? 0);
            
            if (string.IsNullOrWhiteSpace(protocol.Context))
            {
                 errors.Add("? Contexte manquant.");
                 result.Score -= 10;
            }
            if (string.IsNullOrWhiteSpace(protocol.ProblemJustification))
            {
                 errors.Add("? ProblÈmatique et Justification manquantes.");
                 result.Score -= 10;
            }

            // VÈrification longueur (Max 2 pages A4 ~ 2000 mots approx)
            int wordCount = (protocol.Context + " " + protocol.ProblemJustification)
                            .Split(new[] { ' ', '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries)
                            .Length;

            if (wordCount > 2000)
            {
                suggestions.Add($"?? L'introduction est trop longue ({wordCount} mots). Essayez de rester sous les 2000 mots.");
                result.Score -= 5;
            }

            // 2. Questions de Recherche (Impact: 15 pts)
            if (string.IsNullOrWhiteSpace(protocol.ResearchQuestion))
            {
                errors.Add("? Questions de recherche manquantes.");
                result.Score -= 15;
            }
            else
            {
                int questionCount = protocol.ResearchQuestion.Count(c => c == '?');
                if (questionCount > 3)
                {
                    errors.Add($"? Trop de questions de recherche ({questionCount}). Le maximum autorisÈ est de 3.");
                    result.Score -= 10;
                }
                else if (questionCount == 0)
                {
                     suggestions.Add("?? Aucune question identifiÈe (pas de point d'interrogation ?).");
                }
            }

            // 2 bis. HypothËses (Impact: 10 pts)
            if (!string.IsNullOrWhiteSpace(protocol.Hypotheses))
            {
                // Estimation grossiËre par saut de ligne
                var lines = protocol.Hypotheses.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
                if (lines.Length > 2)
                {
                     suggestions.Add($"?? VÈrifiez le nombre d'hypothËses. Le maximum recommandÈ est de 2.");
                     result.Score -= 5;
                }
            }
            
            // 3. Objectifs (Impact: 20 pts) - Analyse Taxonomique
            var bloomVerbs = GetBloomVerbs();
            
            // A. Analyse Objectif GÈnÈral
            if (string.IsNullOrWhiteSpace(protocol.GeneralObjective))
            {
                errors.Add("? Objectif gÈnÈral manquant.");
                result.Score -= 10;
            }
            else
            {
                var goLines = protocol.GeneralObjective.Split(new[] { '\r', '\n', '.' }, StringSplitOptions.RemoveEmptyEntries)
                                                       .Where(l => l.Trim().Length > 5).ToArray();
                
                if (goLines.Length > 2)
                {
                    errors.Add($"? Trop d'objectifs gÈnÈraux ({goLines.Length}). Maximum autorisÈ : 2.");
                    result.Score -= 5;
                }

                // VÈrification du verbe de l'OG
                foreach (var line in goLines)
                {
                    var firstWord = line.Trim().Split(' ')[0].ToLower();
                    if (protocol.StudyType == AdRev.Domain.Enums.StudyType.Quantitative && (firstWord.StartsWith("comprend") || firstWord.StartsWith("explor")))
                    {
                        suggestions.Add($"?? IncohÈrence : Pour une Ètude Quantitative, Èvitez le verbe '{firstWord}'. PrÈfÈrez 'Mesurer', 'Quantifier', 'DÈterminer'.");
                        result.Score -= 2;
                    }
                }
            }

            // B. Analyse Objectifs SpÈcifiques
            if (string.IsNullOrWhiteSpace(protocol.SpecificObjectives))
            {
                errors.Add("? Objectifs spÈcifiques manquants.");
                result.Score -= 5;
            }
            else
            {
                var soLines = protocol.SpecificObjectives.Split(new[] { '\r', '\n', ';' }, StringSplitOptions.RemoveEmptyEntries)
                                                         .Where(l => l.Trim().Length > 3).ToArray();

                int goCount = Math.Max(1, protocol.GeneralObjective.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries).Length);
                int maxSo = goCount * 4;

                if (soLines.Length > maxSo)
                {
                    errors.Add($"? Trop d'objectifs spÈcifiques ({soLines.Length}). Max recommandÈ : 4 par objectif gÈnÈral (Total Max ici : {maxSo}).");
                    result.Score -= 5;
                }

                foreach (var line in soLines)
                {
                    var firstWord = line.Trim().TrimStart('-', '*', 'ï', ' ').Split(' ')[0].ToLower();
                    
                    if (bloomVerbs.Keys.Any(k => firstWord.StartsWith(k)))
                    {
                         // Verbe reconnu, c'est bien
                    }
                    else
                    {
                        // suggestions.Add($"?? Suggestion : '{firstWord}' ne figure pas dans la liste standard de Bloom.");
                    }
                }
            }

            // DÈfinition des Concepts (Bonus ou pÈnalitÈ lÈgËre)
            if (string.IsNullOrWhiteSpace(protocol.ConceptDefinitions))
            {
                suggestions.Add("?? Pensez ‡ dÈfinir les concepts clÈs pour clarifier votre approche.");
                result.Score -= 2;
            }
            else if (protocol.SpecificObjectives.Split(';').Length < 2 && !protocol.SpecificObjectives.Contains("\n"))
            {
                suggestions.Add("?? Il est recommandÈ d'avoir au moins 2 ou 3 objectifs spÈcifiques pour opÈrationnaliser l'objectif gÈnÈral.");
                result.Score -= 2;
            }

            // 4. MÈthodologie DÈtaillÈe (Impact: 40 pts) - Le cúur scientifique
            bool methoIncomplete = false;
            
            if (string.IsNullOrWhiteSpace(protocol.StudySetting)) { errors.Add("? Cadre de l'Ètude (Lieu/PÈriode) manquant."); methoIncomplete = true; }
            if (string.IsNullOrWhiteSpace(protocol.StudyPopulation)) { errors.Add("? Population d'Ètude manquante."); methoIncomplete = true; }
            
            if (string.IsNullOrWhiteSpace(protocol.InclusionCriteria) && string.IsNullOrWhiteSpace(protocol.ExclusionCriteria)) 
            { 
                suggestions.Add("?? Aucun critËre d'ÈligibilitÈ (inclusion/exclusion) dÈfini."); 
                result.Score -= 5; 
            }

            if (string.IsNullOrWhiteSpace(protocol.SamplingMethod))
            {
                errors.Add("? MÈthode d'Èchantillonnage manquante.");
                methoIncomplete = true;
            }
            else if (!protocol.SamplingMethod.Any(char.IsDigit) && !protocol.SamplingMethod.ToLower().Contains("exhaustif"))
            {
                suggestions.Add("?? Pensez ‡ prÈciser la taille de l'Èchantillon (chiffre) ou si c'est exhaustif.");
            }

            if (string.IsNullOrWhiteSpace(protocol.DataAnalysis))
            {
                errors.Add("? Plan d'analyse des donnÈes manquant.");
                methoIncomplete = true;
            }

            if (methoIncomplete)
            {
                result.Score -= 30;
            }
            else
            {
                // Bonus de cohÈrence si tout est rempli
                result.Score += 5;
            }

            // 5. Structure et Rigueur (20 pts)
            // Intro check replaced by specific section checks above
            if (string.IsNullOrWhiteSpace(protocol.Ethics)) { suggestions.Add("?? ConsidÈrations Èthiques non mentionnÈes."); result.Score -= 5; }
            if (string.IsNullOrWhiteSpace(protocol.References)) { errors.Add("? RÈfÈrences bibliographiques manquantes (‡ dÈbuter dËs l'intro)."); result.Score -= 10; }

            // Score plancher ‡ 0
            if (result.Score < 0) result.Score = 0;

            return result;
        }

        private Dictionary<string, int> GetBloomVerbs()
        {
            return new Dictionary<string, int>
            {
                // Niveau 1 : Connaissance
                { "dÈfinir", 1 }, { "lister", 1 }, { "nommer", 1 }, { "identifier", 1 },
                // Niveau 2 : ComprÈhension
                { "dÈcrire", 2 }, { "expliquer", 2 }, { "discuter", 2 },
                // Niveau 3 : Application
                { "appliquer", 3 }, { "dÈmontrer", 3 }, { "illustrer", 3 }, { "utiliser", 3 },
                // Niveau 4 : Analyse
                { "analyser", 4 }, { "comparer", 4 }, { "distinguer", 4 }, { "examiner", 4 },
                // Niveau 5 : …valuation / SynthËse
                { "Èvaluer", 5 }, { "estimer", 5 }, { "juger", 5 }, { "valider", 5 }, { "concevoir", 5 }, { "formuler", 5 }
            };
        }
    }
}




FILE: \AdRev.Core\Protocols\SamplingDescriptionGenerator.cs
------------------------------------
using AdRev.Domain.Enums;
using AdRev.Domain.Protocols;
using System;
using System.Linq;
using System.Text;

namespace AdRev.Core.Protocols
{
    /// <summary>
    /// Service pour g√©n√©rer des descriptions textuelles de la m√©thodologie d'√©chantillonnage
    /// </summary>
    public class SamplingDescriptionGenerator
    {
        /// <summary>
        /// G√©n√®re une description compl√®te de la m√©thodologie d'√©chantillonnage
        /// incluant les ajustements pour l'effet de plan et les perdus de vue
        /// </summary>
        public string GenerateFullDescription(ResearchProtocol protocol, int baseSampleSize)
        {
            var sb = new StringBuilder();
            bool isQualitative = protocol.StudyType == StudyType.Qualitative; // Assumant que cet enum existe ou similar

            // Type d'√©chantillonnage
            sb.Append(GetSamplingTypeDescription(protocol.SamplingType, isQualitative));

            // √âtude qualitative : Mention de la saturation
            if (isQualitative)
            {
                sb.Append(" La taille d'√©chantillon pr√©visionnelle est bas√©e sur le principe de saturation des donn√©es ");
                if (protocol.SamplingType == SamplingType.Purposive) 
                    sb.Append("(diversification maximale jusqu'√† redondance de l'information).");
                else
                    sb.Append("plut√¥t que sur une repr√©sentativit√© statistique.");
            }

            // √âtude multicentrique
            if (protocol.IsMulticentric)
            {
                var centers = protocol.StudyCenters.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
                int centerCount = centers.Length;
                
                // Adaptation terminologique pour le qualitatif
                string centerTerm = isQualitative ? "sites d'enqu√™te" : "centres";
                
                sb.Append($" Cette √©tude multicentrique se d√©roulera dans {centerCount} {centerTerm}{(centerCount > 1 && !isQualitative ? "s" : "")}");
                
                if (centerCount > 0 && centerCount <= 5)
                {
                    sb.Append($" ({string.Join(", ", centers.Take(3))}{(centerCount > 3 ? ", etc." : "")})");
                }
                sb.Append(".");
            }

            // Stratification (Qualitatif : souvent appel√© "Diversification")
            if (protocol.IsStratified && !string.IsNullOrWhiteSpace(protocol.StratificationCriteria))
            {
                if (isQualitative)
                    sb.Append($" La s√©lection des participants sera diversifi√©e selon : {protocol.StratificationCriteria} (√©chantillonnage raisonn√© stratifi√©).");
                else
                    sb.Append($" La population sera stratifi√©e selon : {protocol.StratificationCriteria}.");
            }

            // √âchantillonnage en grappe
            if (protocol.IsClusterSampling)
            {
                if (isQualitative)
                {
                     sb.Append($" Une approche par sites/groupes (grappes) sera utilis√©e.");
                     if (protocol.ClusterSize > 0)
                        sb.Append($" Chaque groupe de discussion (Focus Group) comptera environ {protocol.ClusterSize} participants.");
                }
                else
                {
                    sb.Append($" L'√©chantillonnage en grappe sera utilis√©");
                    if (protocol.ClusterSize > 0)
                        sb.Append($", avec une taille moyenne de {protocol.ClusterSize} sujets par grappe");
                    sb.Append(".");
                }
                
                // Ajustement pour design effect (Uniquement Quantitatif)
                if (!isQualitative && protocol.DesignEffect > 1.0)
                {
                    int adjustedSize = (int)Math.Ceiling(baseSampleSize * protocol.DesignEffect);
                    sb.Append($" Un effet de plan (Design Effect) de {protocol.DesignEffect:F2} a √©t√© appliqu√©, " +
                             $"augmentant la taille d'√©chantillon de {baseSampleSize} √† {adjustedSize} sujets.");
                    baseSampleSize = adjustedSize;
                }
            }

            // Ajustement pour perdus de vue / abandons
            if (protocol.ExpectedLossRate > 0)
            {
                int finalSize = (int)Math.Ceiling(baseSampleSize / (1.0 - protocol.ExpectedLossRate / 100.0));
                
                if (isQualitative)
                     sb.Append($" En anticipant un taux d'abandon ou de refus de {protocol.ExpectedLossRate:F0}%, " +
                         $"nous visons de recruter environ {finalSize} participants pour atteindre la saturation.");
                else
                    sb.Append($" En anticipant un taux de perdus de vue de {protocol.ExpectedLossRate:F0}%, " +
                         $"la taille finale de l'√©chantillon sera de {finalSize} sujets.");
            }

            return sb.ToString().Trim();
        }

        /// <summary>
        /// G√©n√®re une description courte du type d'√©chantillonnage
        /// </summary>
        private string GetSamplingTypeDescription(SamplingType samplingType, bool isQualitative = false)
        {
            switch (samplingType)
            {
                case SamplingType.SimpleRandom:
                    return "Un √©chantillonnage al√©atoire simple sera utilis√©, garantissant une probabilit√© √©gale de s√©lection pour chaque sujet.";
                
                case SamplingType.Systematic:
                    return "Un √©chantillonnage syst√©matique sera utilis√©, avec une s√©lection r√©guli√®re des sujets selon un intervalle pr√©d√©fini.";
                
                case SamplingType.Stratified:
                    return isQualitative 
                        ? "Un √©chantillonnage raisonn√© stratifi√© sera utilis√© pour assurer la diversit√© des points de vue." 
                        : "Un √©chantillonnage stratifi√© sera utilis√© pour assurer la repr√©sentativit√© de tous les sous-groupes de la population.";
                
                case SamplingType.ClusterSampling:
                    return isQualitative
                        ? "Un √©chantillonnage par groupes (cluster) sera utilis√©, adapt√© notamment pour les Focus Groups."
                        : "Un √©chantillonnage en grappe (cluster sampling) sera utilis√©, avec une s√©lection de groupes naturels de la population.";
                
                case SamplingType.MultiStage:
                    return "Un √©chantillonnage √† plusieurs degr√©s sera utilis√©, avec une s√©lection progressive en plusieurs √©tapes.";
                
                case SamplingType.StratifiedCluster:
                    return "Un √©chantillonnage stratifi√© en grappes sera utilis√©, combinant les avantages de la stratification et de l'√©chantillonnage en grappe.";
                
                case SamplingType.Convenience:
                    return isQualitative
                        ? "Un √©chantillonnage de convenance sera utilis√©, s√©lectionnant les participants disponibles et volontaires pour les entretiens."
                        : "Un √©chantillonnage de convenance sera utilis√©, avec une s√©lection des sujets facilement accessibles.";
                
                case SamplingType.Purposive:
                    return "Un √©chantillonnage raisonn√© (purposive) sera utilis√©, avec une s√©lection intentionnelle de sujets " + 
                           (isQualitative ? "capables d'apporter une information riche sur le ph√©nom√®ne √©tudi√©." : "ayant des caract√©ristiques sp√©cifiques.");
                
                case SamplingType.Snowball:
                    return "Un √©chantillonnage ¬´ boule de neige ¬ª sera utilis√©, o√π les participants recrutent d'autres participants (utile pour les populations difficiles d'acc√®s).";
                
                case SamplingType.Quota:
                    return "Un √©chantillonnage par quotas sera utilis√© pour respecter des proportions pr√©d√©finies dans l'√©chantillon.";
                
                case SamplingType.Census:
                    return "Un recensement exhaustif de la population sera r√©alis√© (pas d'√©chantillonnage).";
                
                default:
                    return "La m√©thode d'√©chantillonnage sera pr√©cis√©e ult√©rieurement.";
            }
        }

        /// <summary>
        /// Calcule le nombre de grappes n√©cessaires
        /// </summary>
        public int CalculateNumberOfClusters(int totalSampleSize, int averageClusterSize)
        {
            if (averageClusterSize <= 0) return 0;
            return (int)Math.Ceiling((double)totalSampleSize / averageClusterSize);
        }

        /// <summary>
        /// Calcule la taille ajust√©e pour l'effet de design
        /// </summary>
        public int CalculateDesignEffectAdjustedSize(int baseSampleSize, double designEffect)
        {
            return (int)Math.Ceiling(baseSampleSize * designEffect);
        }

        /// <summary>
        /// Calcule la taille finale avec ajustement pour perdus de vue
        /// </summary>
        public int CalculateLossAdjustedSize(int sampleSize, double expectedLossRatePercent)
        {
            if (expectedLossRatePercent <= 0 || expectedLossRatePercent >= 100) return sampleSize;
            return (int)Math.Ceiling(sampleSize / (1.0 - expectedLossRatePercent / 100.0));
        }

        /// <summary>
        /// Calcule le Design Effect √† partir de l'ICC et de la taille de grappe
        /// </summary>
        public double CalculateDesignEffect(double icc, int averageClusterSize)
        {
            if (icc <= 0 || averageClusterSize <= 1) return 1.0;
            return 1.0 + (averageClusterSize - 1) * icc;
        }

        /// <summary>
        /// G√©n√®re des recommandations pour l'√©chantillonnage
        /// </summary>
        public string GenerateRecommendations(ResearchProtocol protocol)
        {
            var recommendations = new StringBuilder();

            // Recommandation sur l'effet de design
            if (protocol.IsClusterSampling && protocol.DesignEffect < 1.2)
            {
                recommendations.AppendLine("‚ö†Ô∏è L'effet de plan semble faible pour un √©chantillonnage en grappe. Valeurs typiques : 1.5-2.0");
            }

            // Recommandation sur les perdus de vue
            if (protocol.EpidemiologyType == EpidemiologicalStudyType.CohortProspective && protocol.ExpectedLossRate < 10)
            {
                recommendations.AppendLine("üí° Pour une cohorte prospective, consid√©rez un taux de perdus de vue d'au moins 10-15%");
            }

            // Recommandation multicentrique
            if (protocol.IsMulticentric && string.IsNullOrWhiteSpace(protocol.StudyCenters))
            {
                recommendations.AppendLine("‚ùó Veuillez lister les centres participants pour une √©tude multicentrique");
            }

            // Recommandation stratification
            if (protocol.IsStratified && string.IsNullOrWhiteSpace(protocol.StratificationCriteria))
            {
                recommendations.AppendLine("‚ùó Pr√©cisez les crit√®res de stratification (ex: √¢ge, sexe, r√©gion)");
            }

            return recommendations.ToString();
        }
    }
}




FILE: \AdRev.Core\Services\LicensingService.cs
------------------------------------
using System;
using System.IO;
using System.Management;
using System.Security.Cryptography;
using System.Text;
using System.Text.Json;
using Microsoft.Win32;
using AdRev.Domain.Models;

namespace AdRev.Core.Services
{
    public class LicensingService
    {
        private const string RegistryPath = @"Software\AdRev";
        private const string LicenseValueName = "LicenseData";
        private const string SecretSalt = "AdRev_Security_2026_Robust_Research_System_V2";

        public string GetHardwareId()
        {
            try
            {
                string hwid = string.Empty;
                using (var cpuSearcher = new ManagementObjectSearcher("SELECT ProcessorId FROM Win32_Processor"))
                {
                    foreach (var obj in cpuSearcher.Get())
                    {
                        hwid += obj["ProcessorId"]?.ToString() ?? "";
                        break;
                    }
                }
                using (var baseSearcher = new ManagementObjectSearcher("SELECT SerialNumber FROM Win32_BaseBoard"))
                {
                    foreach (var obj in baseSearcher.Get())
                    {
                        hwid += obj["SerialNumber"]?.ToString() ?? "";
                        break;
                    }
                }
                return HashString(hwid).Substring(0, 16).ToUpper();
            }
            catch
            {
                return HashString(Environment.MachineName).Substring(0, 16).ToUpper();
            }
        }

        public bool IsActivated(out string message)
        {
            message = string.Empty;
            string storedData = GetStoredLicenseData();
            if (string.IsNullOrEmpty(storedData))
            {
                message = "Aucune licence trouv√©e.";
                return false;
            }

            try
            {
                var metadata = DecryptAndValidate(storedData);
                if (metadata == null)
                {
                    message = "Licence corrompue ou invalide.";
                    return false;
                }

                // 1. Check HWID (Skip if Institutional/Enterprise for flexibility)
                if (metadata.Type != LicenseType.Enterprise && metadata.Hwid != GetHardwareId())
                {
                    message = "Cette licence n'est pas valide pour cet ordinateur.";
                    return false;
                }

                // 2. Check Expiry
                if (metadata.ExpiryDate < DateTime.UtcNow)
                {
                    if (metadata.Type == LicenseType.Trial)
                        message = $"Votre p√©riode d'essai a expir√© le {metadata.ExpiryDate.ToShortDateString()}.";
                    else
                        message = $"Votre licence annuelle a expir√© le {metadata.ExpiryDate.ToShortDateString()}.";
                    return false;
                }

                string label = !string.IsNullOrEmpty(metadata.FeaturesLabel) ? metadata.FeaturesLabel :
                               metadata.Type == LicenseType.Lifetime ? "Licence Professionnelle √† Vie" : 
                               metadata.Type == LicenseType.Annual ? "Licence Annuelle" :
                               metadata.Type == LicenseType.Student ? "Licence √âtudiant" :
                               metadata.Type == LicenseType.Enterprise ? "Licence Entreprise" :
                               "Essai Gratuit";
                               
                if (metadata.Type != LicenseType.Lifetime && metadata.Type != LicenseType.Enterprise)
                    label += $" (Expire le {metadata.ExpiryDate.ToShortDateString()})";

                if (!string.IsNullOrEmpty(metadata.RegisteredEmail))
                    label += $"\nEnregistr√© pour : {metadata.RegisteredEmail}";

                message = label;
                return true;
            }
            catch
            {
                message = "Erreur de validation de licence.";
                return false;
            }
        }

        public void StartTrial()
        {
            var metadata = new LicenseMetadata
            {
                Hwid = GetHardwareId(),
                Type = LicenseType.Trial,
                ExpiryDate = DateTime.UtcNow.AddDays(7),
                MaxSeats = 1
            };
            
            // Generate Signature (Updated v2 format)
            string dataToSign = $"{metadata.Hwid}|{metadata.Type}|{metadata.ExpiryDate:yyyy-MM-dd}|{metadata.MaxSeats}|{metadata.RegisteredEmail ?? ""}|{metadata.FeaturesLabel ?? ""}";
            metadata.Signature = HashString(dataToSign + SecretSalt);

            // Serialize & Encrypt
            string json = JsonSerializer.Serialize(metadata);
            string encrypted = EncryptString(json);
            
            SaveLicenseData(encrypted);
        }

        public bool Activate(string licenseKey)
        {
            var metadata = DecryptAndValidate(licenseKey);
            if (metadata != null)
            {
                // Verify if it belongs to this PC (unless it's an Enterprise key)
                if (metadata.Type != LicenseType.Enterprise && metadata.Hwid != GetHardwareId())
                    return false;

                SaveLicenseData(licenseKey);
                return true;
            }
            return false;
        }

        /// <summary>
        /// G√©n√®re une nouvelle licence crypt√©e (Pour usage CLI / Bot).
        /// </summary>
        public string GenerateLicense(string hwid, LicenseType type, int maxSeats, DateTime expiryDate, string email, string label)
        {
            var metadata = new LicenseMetadata
            {
                Hwid = hwid,
                Type = type,
                ExpiryDate = expiryDate,
                MaxSeats = maxSeats,
                RegisteredEmail = email,
                FeaturesLabel = label
            };

            // Generate Signature
            string dataToSign = $"{metadata.Hwid}|{metadata.Type}|{metadata.ExpiryDate:yyyy-MM-dd}|{metadata.MaxSeats}|{metadata.RegisteredEmail ?? ""}|{metadata.FeaturesLabel ?? ""}";
            metadata.Signature = HashString(dataToSign + SecretSalt);

            // Serialize & Encrypt
            string json = JsonSerializer.Serialize(metadata);
            return EncryptString(json);
        }

        /// <summary>
        /// D√©crypte une licence pour inspection (Support).
        /// </summary>
        public LicenseMetadata? InspectLicense(string licenseKey)
        {
            return DecryptAndValidate(licenseKey);
        }

        private LicenseMetadata? DecryptAndValidate(string encryptedKey)
        {
            try
            {
                string json = DecryptString(encryptedKey);
                var metadata = JsonSerializer.Deserialize<LicenseMetadata>(json);
                if (metadata == null) return null;

                // Verify Signature (Updated v2 format)
                string dataToSign = $"{metadata.Hwid}|{metadata.Type}|{metadata.ExpiryDate:yyyy-MM-dd}|{metadata.MaxSeats}|{metadata.RegisteredEmail ?? ""}|{metadata.FeaturesLabel ?? ""}";
                string expectedSignature = HashString(dataToSign + SecretSalt);

                if (metadata.Signature == expectedSignature)
                    return metadata;
            }
            catch { }
            return null;
        }

        private string HashString(string input)
        {
            using (var sha256 = SHA256.Create())
            {
                byte[] bytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(input));
                return BitConverter.ToString(bytes).Replace("-", "");
            }
        }

        private void SaveLicenseData(string data)
        {
            using (RegistryKey rk = Registry.CurrentUser.CreateSubKey(RegistryPath))
            {
                rk.SetValue(LicenseValueName, data);
            }
        }

        private string GetStoredLicenseData()
        {
            using (RegistryKey? rk = Registry.CurrentUser.OpenSubKey(RegistryPath))
            {
                return rk?.GetValue(LicenseValueName)?.ToString() ?? string.Empty;
            }
        }

        // Simple AES Encryption for the Payload
        private string EncryptString(string plainText)
        {
            byte[] iv = new byte[16];
            byte[] array;

            using (Aes aes = Aes.Create())
            {
                aes.Key = Encoding.UTF8.GetBytes(SecretSalt.Substring(0, 32));
                aes.IV = iv;

                ICryptoTransform encryptor = aes.CreateEncryptor(aes.Key, aes.IV);

                using (MemoryStream memoryStream = new MemoryStream())
                {
                    using (CryptoStream cryptoStream = new CryptoStream(memoryStream, encryptor, CryptoStreamMode.Write))
                    {
                        using (StreamWriter streamWriter = new StreamWriter(cryptoStream))
                        {
                            streamWriter.Write(plainText);
                        }
                        array = memoryStream.ToArray();
                    }
                }
            }
            return Convert.ToBase64String(array);
        }

        private string DecryptString(string cipherText)
        {
            byte[] iv = new byte[16];
            byte[] buffer = Convert.FromBase64String(cipherText);

            using (Aes aes = Aes.Create())
            {
                aes.Key = Encoding.UTF8.GetBytes(SecretSalt.Substring(0, 32));
                aes.IV = iv;
                ICryptoTransform decryptor = aes.CreateDecryptor(aes.Key, aes.IV);

                using (MemoryStream memoryStream = new MemoryStream(buffer))
                {
                    using (CryptoStream cryptoStream = new CryptoStream(memoryStream, decryptor, CryptoStreamMode.Read))
                    {
                        using (StreamReader streamReader = new StreamReader(cryptoStream))
                        {
                            return streamReader.ReadToEnd();
                        }
                    }
                }
            }
        }
    }
}




FILE: \AdRev.Core\Services\QualityService.cs
------------------------------------
using AdRev.Domain.Quality;
using AdRev.Domain.Protocols;
using AdRev.Domain.Enums;
using AdRev.Domain.Models;
using System.Collections.Generic;

namespace AdRev.Core.Services
{
    public class QualityService
    {
        public List<QualityChecklist> GetAllChecklists()
        {
            return new List<QualityChecklist>
            {
                GetCOREQ(),
                GetSTROBE(),
                GetPRISMA(),
                GetCARE(),
                GetSRQR(),
                GetCONSORT(),
                GetGRAMMS()
            };
        }

        public List<QualityChecklist> GetRecommendedChecklists(ResearchProject project)
        {
            var checklists = new List<QualityChecklist>();

            if (project.Domain == ScientificDomain.Biomedical)
            {
                if (project.StudyType == StudyType.Qualitative)
                {
                    checklists.Add(GetCOREQ());
                    checklists.Add(GetSRQR());
                }
                else if (project.StudyType == StudyType.Quantitative)
                {
                    if (project.EpidemiologyType == EpidemiologicalStudyType.RandomizedControlledTrial)
                    {
                        checklists.Add(GetCONSORT());
                        checklists.Add(GetSTROBE());
                    }
                    else
                    {
                        checklists.Add(GetSTROBE());
                        checklists.Add(GetCONSORT());
                    }
                }
                else // Mixed
                {
                    checklists.Add(GetGRAMMS());
                    checklists.Add(GetCOREQ());
                    checklists.Add(GetSTROBE());
                }
                checklists.Add(GetPRISMA());
                checklists.Add(GetCARE());
            }
            else if (project.Domain == ScientificDomain.History)
            {
                checklists.Add(GetHISTORIC()); // Heuristique & Critique Source
                if (project.StudyType == StudyType.Qualitative) checklists.Add(GetSRQR());
            }
            else if (project.Domain == ScientificDomain.Geography || project.Domain == ScientificDomain.SpacePhysics)
            {
                checklists.Add(GetSPATIAL()); // Qualit√© Spatial & Mod√©lisation
                if (project.StudyType == StudyType.Quantitative) checklists.Add(GetSTROBE());
            }
            else if (project.Domain == ScientificDomain.SocialSciences)
            {
                checklists.Add(GetSRQR());
                checklists.Add(GetSOCIOLOGY()); // Ethnography & Survey Ethics
                if (project.StudyType == StudyType.Mixed) checklists.Add(GetGRAMMS());
            }
            else
            {
                // General fallback
                checklists.Add(GetSRQR());
                checklists.Add(GetSTROBE());
                checklists.Add(GetGRAMMS());
            }

            return checklists;
        }

        private QualityChecklist GetCOREQ()
        {
            return new QualityChecklist
            {
                Name = "COREQ (32 items)",
                Description = "Consolidated criteria for reporting qualitative research (Entretiens & Focus Groups)",
                SourceUrl = "https://www.equator-network.org/reporting-guidelines/coreq",
                Sections = new List<ChecklistSection>
                {
                    // Domain 1: Research team and reflexivity
                    new ChecklistSection
                    {
                        Name = "Domaine 1 : √âquipe de recherche et r√©flexivit√©",
                        Items = new List<ChecklistItem>
                        {
                            // Personal Characteristics
                            new ChecklistItem { Id="1", Requirement="Interviewer/facilitateur", Description="Qui a men√© les entretiens ou les groupes de discussion ?"},
                            new ChecklistItem { Id="2", Requirement="Qualifications", Description="Quelles √©taient les qualifications du chercheur (MD, PhD) ?"},
                            new ChecklistItem { Id="3", Requirement="Profession", Description="Quelle √©tait leur profession au moment de l'√©tude ?"},
                            new ChecklistItem { Id="4", Requirement="Genre", Description="Le genre du chercheur √©tait-il pr√©cis√© ?"},
                            new ChecklistItem { Id="5", Requirement="Exp√©rience et formation", Description="Le chercheur avait-il de l'exp√©rience ou une formation qualitative ?"},
                            
                            // Relationship with participants
                            new ChecklistItem { Id="6", Requirement="Relation √©tablie", Description="Une relation a-t-elle √©t√© √©tablie avant le d√©but de l'√©tude ?"},
                            new ChecklistItem { Id="7", Requirement="Connaissance du chercheur", Description="Quels renseignements les participants avaient-ils sur le chercheur ?"},
                            new ChecklistItem { Id="8", Requirement="Caract√©ristiques de l'interviewer", Description="Quelles caract√©ristiques (biais, hypoth√®ses) ont √©t√© rapport√©es ?"}
                        }
                    },
                    // Domain 2: Study design
                    new ChecklistSection
                    {
                        Name = "Domaine 2 : Conception de l'√©tude",
                        Items = new List<ChecklistItem>
                        {
                            // Theoretical framework
                            new ChecklistItem { Id="9", Requirement="Orientation m√©thodologique", Description="Quelle m√©thode (Grounded Theory, Ph√©nom√©nologie...) ?"},
                            
                            // Participant selection
                            new ChecklistItem { Id="10", Requirement="√âchantillonnage", Description="Comment les participants ont-ils √©t√© s√©lectionn√©s ?"},
                            new ChecklistItem { Id="11", Requirement="M√©thode d'approche", Description="Comment ont-ils √©t√© approch√©s (mail, t√©l√©phone, face-√†-face) ?"},
                            new ChecklistItem { Id="12", Requirement="Taille de l'√©chantillon", Description="Combien de participants ?"},
                            new ChecklistItem { Id="13", Requirement="Non-participation", Description="Combien ont refus√© ou abandonn√© ?"},
                            
                            // Setting
                            new ChecklistItem { Id="14", Requirement="Cadre de collecte", Description="O√π les donn√©es ont-elles √©t√© collect√©es (domicile, clinique) ?"},
                            new ChecklistItem { Id="15", Requirement="Pr√©sence de tiers", Description="Y avait-il d'autres personnes pr√©sentes ?"},
                            new ChecklistItem { Id="16", Requirement="Description de l'√©chantillon", Description="Donn√©es d√©mographiques importantes fournies ?"},
                            
                            // Data collection
                            new ChecklistItem { Id="17", Requirement="Guide d'entretien", Description="Questions, prompts, guides utilis√©s ?"},
                            new ChecklistItem { Id="18", Requirement="Entretiens r√©p√©t√©s", Description="Les participants ont-ils √©t√© interrog√©s plusieurs fois ?"},
                            new ChecklistItem { Id="19", Requirement="Enregistrement audio/visuel", Description="La collecte a-t-elle √©t√© enregistr√©e ?"},
                            new ChecklistItem { Id="20", Requirement="Notes de terrain", Description="Des notes ont-elles √©t√© prises pendant ou apr√®s ?"},
                            new ChecklistItem { Id="21", Requirement="Dur√©e", Description="Quelle √©tait la dur√©e des entretiens ?"},
                            new ChecklistItem { Id="22", Requirement="Saturation des donn√©es", Description="La saturation a-t-elle √©t√© atteinte ?"},
                            new ChecklistItem { Id="23", Requirement="Retour des transcrits", Description="Les transcrits ont-ils √©t√© renvoy√©s aux participants pour correction ?"}
                        }
                    },
                    // Domain 3: Analysis and findings
                    new ChecklistSection
                    {
                        Name = "Domaine 3 : Analyse et r√©sultats",
                        Items = new List<ChecklistItem>
                        {
                            // Data analysis
                            new ChecklistItem { Id="24", Requirement="Nombre de codeurs", Description="Combien de chercheurs ont cod√© les donn√©es ?"},
                            new ChecklistItem { Id="25", Requirement="Arbre de codage", Description="La description de l'arbre de codage est-elle fournie ?"},
                            new ChecklistItem { Id="26", Requirement="D√©rivation des th√®mes", Description="Les th√®mes ont-ils √©t√© identifi√©s √† l'avance ou ont-ils √©merg√© ?"},
                            new ChecklistItem { Id="27", Requirement="Logiciel", Description="Quel logiciel a √©t√© utilis√© (NVivo, Atlas.ti) ?"},
                            new ChecklistItem { Id="28", Requirement="V√©rification par les participants", Description="Les participants ont-ils valid√© les r√©sultats (Member checking) ?"},
                            
                            // Reporting
                            new ChecklistItem { Id="29", Requirement="Citations pr√©sent√©es", Description="Des citations (verbatims) illustrent-elles les th√®mes ?"},
                            new ChecklistItem { Id="30", Requirement="Coh√©rence donn√©es/r√©sultats", Description="Il y a-t-il une coh√©rence entre les donn√©es pr√©sent√©es et les r√©sultats ?"},
                            new ChecklistItem { Id="31", Requirement="Clart√© des th√®mes majeurs", Description="Les th√®mes majeurs sont-ils clairement pr√©sent√©s ?"},
                            new ChecklistItem { Id="32", Requirement="Clart√© des th√®mes mineurs", Description="Les th√®mes mineurs sont-ils discut√©s ?"}
                        }
                    }
                }
            };
        }

        private QualityChecklist GetSTROBE()
        {
            return new QualityChecklist
            {
                Name = "STROBE",
                Description = "Strengthening the Reporting of Observational Studies in Epidemiology (Transversales, Cohortes, Cas-T√©moins)",
                Sections = new List<ChecklistSection>
                {
                    new ChecklistSection
                    {
                        Name = "Introduction",
                        Items = new List<ChecklistItem> { 
                            new ChecklistItem { Id="1", Requirement="Contexte et Justification", Description="Expliquer le rationnel scientifique et th√©orique." },
                            new ChecklistItem { Id="2", Requirement="Objectifs", Description="Objectif principal et hypoth√®ses pr√©-sp√©cifi√©es." } 
                        }
                    },
                    new ChecklistSection
                    {
                        Name = "M√©thodes",
                        Items = new List<ChecklistItem> { 
                            new ChecklistItem { Id="3", Requirement="Type d'√©tude", Description="Conception de l'√©tude claire." },
                            new ChecklistItem { Id="4", Requirement="Cadre", Description="Lieux et dates de collecte." },
                            new ChecklistItem { Id="5", Requirement="Participants", Description="Crit√®res d'inclusion, d'exclusion, sources." },
                            new ChecklistItem { Id="6", Requirement="Variables", Description="Toutes les variables (r√©sultat, expositions, facteurs) d√©finies." },
                            new ChecklistItem { Id="7", Requirement="Sources de donn√©es", Description="Mesures, outils valid√©s ?" },
                            new ChecklistItem { Id="8", Requirement="Biais", Description="Efforts pour traiter les biais potentiels." },
                            new ChecklistItem { Id="9", Requirement="Taille d'√©tude", Description="Justification de la taille (calcul de puissance)." }
                        }
                    },
                     new ChecklistSection
                    {
                        Name = "R√©sultats",
                        Items = new List<ChecklistItem> { 
                            new ChecklistItem { Id="10", Requirement="Participants (Flowchart)", Description="Nombres √† chaque √©tape (√©ligibles, inclus, analys√©s)." },
                            new ChecklistItem { Id="11", Requirement="Donn√©es descriptives", Description="Caract√©ristiques socio-d√©mographiques." },
                            new ChecklistItem { Id="12", Requirement="R√©sultats principaux", Description="Estimations non ajust√©es et ajust√©es (IC 95%)." }
                        }
                    }
                    ,
                     new ChecklistSection
                    {
                        Name = "Discussion",
                        Items = new List<ChecklistItem> { 
                            new ChecklistItem { Id="18", Requirement="R√©sultats cl√©s", Description="R√©sum√© des principaux r√©sultats (r√©f√©rence aux objectifs)." },
                            new ChecklistItem { Id="19", Requirement="Limitations", Description="Biais, impr√©cisions, validit√© interne/externe." },
                            new ChecklistItem { Id="20", Requirement="Interpr√©tation", Description="Comparaison avec autres √©tudes, hypoth√®ses." },
                            new ChecklistItem { Id="21", Requirement="G√©n√©ralisabilit√©", Description="Validit√© externe (√† qui s'appliquent les r√©sultats ?)." }
                        }
                    }
                }
            };
        }

        private QualityChecklist GetPRISMA()
        {
            return new QualityChecklist
            {
                Name = "PRISMA",
                Description = "Preferred Reporting Items for Systematic Reviews and Meta-Analyses",
                Sections = new List<ChecklistSection>
                {
                    new ChecklistSection
                    {
                        Name = "Titre & R√©sum√©",
                        Items = new List<ChecklistItem> { 
                            new ChecklistItem { Id="1", Requirement="Titre", Description="Identifier le rapport comme une revue syst√©matique." },
                            new ChecklistItem { Id="2", Requirement="R√©sum√©", Description="R√©sum√© structur√© (m√©thodes, r√©sultats, conclusion)." }
                        }
                    },
                    new ChecklistSection
                    {
                        Name = "M√©thodes",
                        Items = new List<ChecklistItem> { 
                            new ChecklistItem { Id="5", Requirement="Crit√®res d'√©ligibilit√©", Description="PICO (Population, Intervention, Comparator, Outcome)." },
                            new ChecklistItem { Id="6", Requirement="Sources d'information", Description="Bases de donn√©es interrog√©es (PubMed, etc.), dates." },
                            new ChecklistItem { Id="7", Requirement="Strat√©gie de recherche", Description="Cha√Æne de recherche compl√®te pour au moins une base." },
                            new ChecklistItem { Id="8", Requirement="Processus de s√©lection", Description="Qui a tri√© ? (Doubles aveugle ?)" },
                            new ChecklistItem { Id="11", Requirement="√âvaluation du risque de biais", Description="Outils utilis√©s (ex: RoB 2, ROBINS-I)." }
                        }
                    },
                    new ChecklistSection
                    {
                        Name = "R√©sultats",
                        Items = new List<ChecklistItem> { 
                            new ChecklistItem { Id="16", Requirement="S√©lection des √©tudes", Description="Diagramme de flux (PRISMA Flow Diagram)." },
                            new ChecklistItem { Id="18", Requirement="Risque de biais", Description="Pr√©sentation des r√©sultats de l'√©valuation du biais." }
                        }
                    }
                }
            };
        }

        private QualityChecklist GetCARE()
        {
             return new QualityChecklist
            {
                Name = "CARE",
                Description = "Case Report Guidelines (Rapport de Cas)",
                Sections = new List<ChecklistSection>
                {
                    new ChecklistSection
                    {
                        Name = "√âl√©ments liminaires",
                        Items = new List<ChecklistItem> { 
                            new ChecklistItem { Id="1", Requirement="Titre", Description="Identifier le 'Case Report' dans le titre." },
                            new ChecklistItem { Id="2", Requirement="Mots-cl√©s", Description="2 √† 5 mots-cl√©s." }
                        }
                    },
                    new ChecklistSection
                    {
                        Name = "Pr√©sentation du cas",
                        Items = new List<ChecklistItem> { 
                            new ChecklistItem { Id="5a", Requirement="Informations patient", Description="Donn√©es d√©-identifi√©es, pr√©occupations principales." },
                            new ChecklistItem { Id="5b", Requirement="Histoire clinique", Description="Ant√©c√©dents pertinents." },
                            new ChecklistItem { Id="6", Requirement="Chronologie (Timeline)", Description="Chronologie des √©v√©nements cliniques." },
                            new ChecklistItem { Id="7", Requirement="√âvaluation Diagnostique", Description="M√©thodes diagnostiques, d√©fis, pronostic." },
                            new ChecklistItem { Id="8", Requirement="Intervention Th√©rapeutique", Description="Types, doses, dur√©e des traitements." },
                            new ChecklistItem { Id="9", Requirement="Suivi et R√©sultats", Description="R√©sultats √©valu√©s par clinicien et patient." }
                        }
                    },
                    new ChecklistSection
                    {
                        Name = "Discussion & Consentement",
                        Items = new List<ChecklistItem> { 
                            new ChecklistItem { Id="10", Requirement="Discussion", Description="Points forts, limites, litt√©rature." },
                            new ChecklistItem { Id="11", Requirement="Perspective Patient", Description="Opinion du patient sur son cas." },
                            new ChecklistItem { Id="12", Requirement="Consentement √©clair√©", Description="Le patient a-t-il sign√© un consentement ?" }
                        }
                    }
                }
            };
        }

        private QualityChecklist GetSRQR()
        {
            return new QualityChecklist
            {
                Name = "SRQR",
                Description = "Standards for Reporting Qualitative Research (21 items)",
                Sections = new List<ChecklistSection>
                {
                    new ChecklistSection
                    {
                        Name = "Titre & R√©sum√©",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="1", Requirement="Titre", Description="D√©crit clairement la recherche qualitative." },
                            new ChecklistItem { Id="2", Requirement="R√©sum√©", Description="R√©sum√© structur√© (Pobl√®me, Design, R√©sultats, Conclusion)." }
                        }
                    },
                    new ChecklistSection
                    {
                        Name = "Introduction",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="3", Requirement="Probl√©matique", Description="Justification de la recherche." },
                            new ChecklistItem { Id="4", Requirement="Question de recherche", Description="But et questions sp√©cifiques." }
                        }
                    },
                    new ChecklistSection
                    {
                        Name = "M√©thodes : Fondements",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="5", Requirement="Approche et Paradigme", Description="Ex: Ph√©nom√©nologie, Grounded Theory..." },
                            new ChecklistItem { Id="6", Requirement="Position du chercheur", Description="Biais potentiels, r√©flexivit√©." },
                            new ChecklistItem { Id="7", Requirement="Cadre de l'√©tude", Description="Lieu et contexte social." },
                            new ChecklistItem { Id="8", Requirement="√âchantillonnage", Description="Strat√©gie et crit√®res de s√©lection." }
                        }
                    },
                    new ChecklistSection
                    {
                        Name = "M√©thodes : Collecte & Analyse",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="9", Requirement="Instruments de collecte", Description="Outils utilis√©s (guide d'entretien, etc.)." },
                            new ChecklistItem { Id="10", Requirement="Proc√©dure de collecte", Description="Comment les donn√©es ont √©t√© recueillies." },
                            new ChecklistItem { Id="11", Requirement="Analyse des donn√©es", Description="M√©thode d'analyse (codage, th√©matique)." },
                            new ChecklistItem { Id="12", Requirement="Cr√©dibilit√© (Trustworthiness)", Description="Techniques : triangulation, validation par les pairs..." }
                        }
                    },
                    new ChecklistSection
                    {
                        Name = "√âthique & R√©sultats",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="13", Requirement="√âthique", Description="Comit√© d'√©thique et consentement." },
                            new ChecklistItem { Id="14", Requirement="R√©sultats/Findings", Description="Pr√©sentation claire des th√®mes." },
                            new ChecklistItem { Id="15", Requirement="Lien avec les donn√©es", Description="Utilisation de citations (verbatims)." }
                        }
                    }
                }
            };
        }
        private QualityChecklist GetCONSORT()
        {
            return new QualityChecklist
            {
                Name = "CONSORT",
                Description = "Consolidated Standards of Reporting Trials (Essais Randomis√©s)",
                Sections = new List<ChecklistSection>
                {
                    new ChecklistSection
                    {
                        Name = "Titre & R√©sum√©",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="1a", Requirement="Identification comme essai randomis√©", Description="Le titre doit inclure 'Essai Randomis√©'." },
                            new ChecklistItem { Id="1b", Requirement="R√©sum√© structur√©", Description="Pr√©sentation structur√©e du design, des m√©thodes et r√©sultats." }
                        }
                    },
                    new ChecklistSection
                    {
                        Name = "Introduction",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="2a", Requirement="Contexte scientifique", Description="Justification et √©tat des connaissances." },
                            new ChecklistItem { Id="2b", Requirement="Objectifs et Hypoth√®ses", Description="Objectifs pr√©cis et hypoth√®ses test√©es." }
                        }
                    },
                    new ChecklistSection
                    {
                        Name = "M√©thodes : Design & Participants",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="3a", Requirement="Design de l'essai", Description="Description (ex: parall√®le, factoriel) et ratio d'allocation." },
                            new ChecklistItem { Id="3b", Requirement="Changements de design", Description="Modifications apr√®s le d√©but de l'essai, avec justifications." },
                            new ChecklistItem { Id="4a", Requirement="Crit√®res d'√©ligibilit√©", Description="Crit√®res d'inclusion et d'exclusion des participants." },
                            new ChecklistItem { Id="4b", Requirement="Cadre et lieux", Description="O√π les donn√©es ont-elles √©t√© collect√©es ?" }
                        }
                    },
                    new ChecklistSection
                    {
                        Name = "M√©thodes : Interventions & Crit√®res",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="5", Requirement="Interventions", Description="D√©tails de l'intervention pour chaque groupe (suffisant pour r√©plication)." },
                            new ChecklistItem { Id="6a", Requirement="Crit√®res de jugement (Outcomes)", Description="D√©finition pr√©cise des crit√®res primaires et secondaires." },
                            new ChecklistItem { Id="6b", Requirement="Changement de crit√®res", Description="Toute modification des crit√®res apr√®s le d√©but." }
                        }
                    },
                    new ChecklistSection
                    {
                        Name = "M√©thodes : Taille d'√©chantillon",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="7a", Requirement="Calcul de la taille", Description="Comment la taille d'√©chantillon a √©t√© d√©termin√©e ?" },
                            new ChecklistItem { Id="7b", Requirement="Analyses int√©rimaires", Description="Directives d'arr√™t si applicables." }
                        }
                    },
                    new ChecklistSection
                    {
                        Name = "M√©thodes : Randomisation",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="8a", Requirement="G√©n√©ration de la s√©quence", Description="M√©thode utilis√©e (ex: table de nombres al√©atoires)." },
                            new ChecklistItem { Id="8b", Requirement="Type de randomisation", Description="D√©tails (ex: bloc, stratification)." },
                            new ChecklistItem { Id="9", Requirement="M√©canisme de secret d'allocation", Description="Comment la s√©quence a √©t√© cach√©e jusqu'√† l'assignation ?" },
                            new ChecklistItem { Id="10", Requirement="Mise en ≈ìuvre", Description="Qui a g√©n√©r√© la s√©quence, qui a recrut√© ?" }
                        }
                    },
                    new ChecklistSection
                    {
                        Name = "M√©thodes : Aveugle (Blinding)",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="11a", Requirement="Proc√©dure d'aveugle", Description="Qui √©tait en aveugle (participants, soignants, √©valuateurs) ?" },
                            new ChecklistItem { Id="11b", Requirement="Similitude des interventions", Description="Si applicable, description de la similitude." }
                        }
                    },
                    new ChecklistSection
                    {
                        Name = "M√©thodes : Analyses Statistiques",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="12a", Requirement="M√©thodes statistiques", Description="M√©thodes pour comparer les groupes sur les crit√®res primaires." },
                            new ChecklistItem { Id="12b", Requirement="Analyses additionnelles", Description="Analyses de sous-groupes, ajustements." }
                        }
                    }
                }
            };
        }
        private QualityChecklist GetGRAMMS()
        {
            return new QualityChecklist
            {
                Name = "GRAMMS",
                Description = "Good Reporting of A Mixed Methods Study (6 items)",
                Sections = new List<ChecklistSection>
                {
                    new ChecklistSection
                    {
                        Name = "Design Mixte",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="1", Requirement="Justification du design mixte", Description="Pourquoi utiliser √† la fois du quanti et du quali ?" },
                            new ChecklistItem { Id="2", Requirement="Description du design", Description="S√©quentiel, concomitant ? Quelle priorit√© ?" },
                            new ChecklistItem { Id="3", Requirement="M√©thodes d√©taill√©es", Description="√âchantillonnage et analyse pour chaque m√©thode." }
                        }
                    },
                    new ChecklistSection
                    {
                        Name = "Int√©gration",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="4", Requirement="Interface d'int√©gration", Description="O√π et comment les donn√©es se rejoignent-elles ?" },
                            new ChecklistItem { Id="5", Requirement="Compl√©mentarit√©", Description="Comment une m√©thode r√©pond aux limites de l'autre ?" },
                            new ChecklistItem { Id="6", Requirement="Plus-value", Description="Ce que le m√©lange a apport√© par rapport √† une seule m√©thode." }
                        }
                    }
                }
            };
        }

        private QualityChecklist GetHISTORIC()
        {
            return new QualityChecklist
            {
                Name = "Crit√©res de Recherche Historique",
                Description = "Critique de source et heuristique",
                Sections = new List<ChecklistSection>
                {
                    new ChecklistSection
                    {
                        Name = "Heuristique (Recherche des sources)",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="H1", Requirement="Diversit√© des sources", Description="Archives publiques, priv√©es, orales, iconographiques." },
                            new ChecklistItem { Id="H2", Requirement="Authenticit√©", Description="V√©rification du support et de la provenance." }
                        }
                    },
                    new ChecklistSection
                    {
                        Name = "Critique Externe & Interne",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="H3", Requirement="Critique d'origine", Description="Qui est l'auteur ? Quand ? O√π ?" },
                            new ChecklistItem { Id="H4", Requirement="Critique de restitution", Description="Le texte est-il original ou alt√©r√© ?" },
                            new ChecklistItem { Id="H5", Requirement="Critique de cr√©dibilit√©", Description="L'auteur √©tait-il t√©moin ? Avait-il un int√©r√™t √† mentir ?" }
                        }
                    }
                }
            };
        }

        private QualityChecklist GetSPATIAL()
        {
            return new QualityChecklist
            {
                Name = "Qualit√© de Recherche Spatiale (SIG/Physique)",
                Description = "Pr√©cision spatiale et rigueur des donn√©es",
                Sections = new List<ChecklistSection>
                {
                    new ChecklistSection
                    {
                        Name = "Donn√©es & G√©or√©f√©rencement",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="S1", Requirement="Syst√®me de coordonn√©es (CRS)", Description="Sp√©cification du syst√®me de projection utilis√©." },
                            new ChecklistItem { Id="S2", Requirement="Pr√©cision spatiale", Description="R√©solution des donn√©es (m√®tres, km, degr√©s)." }
                        }
                    },
                    new ChecklistSection
                    {
                        Name = "Mod√©lisation",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="S3", Requirement="Topologie", Description="V√©rification des erreurs de superposition/continuit√©." },
                            new ChecklistItem { Id="S4", Requirement="Validation terrain (Ground Truthing)", Description="Concordance entre mod√®le et r√©alit√©." }
                        }
                    }
                }
            };
        }

        private QualityChecklist GetSOCIOLOGY()
        {
            return new QualityChecklist
            {
                Name = "Rigueur en Sciences Sociales",
                Description = "Engagement et √©thique de terrain",
                Sections = new List<ChecklistSection>
                {
                    new ChecklistSection
                    {
                        Name = "Postures de recherche",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="SS1", Requirement="R√©flexivit√©", Description="Analyse de l'influence du chercheur sur le terrain." },
                            new ChecklistItem { Id="SS2", Requirement="Engagement prolong√©", Description="Temps pass√© sur le terrain pour la saturation." }
                        }
                    },
                    new ChecklistSection
                    {
                        Name = "√âthique sociale",
                        Items = new List<ChecklistItem>
                        {
                            new ChecklistItem { Id="SS3", Requirement="Anonymisation", Description="Protection stricte de l'identit√© des enqu√™t√©s." },
                            new ChecklistItem { Id="SS4", Requirement="Restitution", Description="Partage des r√©sultats avec la communaut√© √©tudi√©e." }
                        }
                    }
                }
            };
        }

        public void EvaluateProtocol(QualityChecklist checklist, ResearchProtocol protocol)
        {
            if (checklist == null || protocol == null) return;

            foreach (var section in checklist.Sections)
            {
                foreach (var item in section.Items)
                {
                    if (checklist.Name.Contains("COREQ"))
                        EvaluateCOREQ(item, protocol);
                    else if (checklist.Name.Contains("STROBE"))
                        EvaluateSTROBE(item, protocol);
                    else if (checklist.Name.Contains("CONSORT"))
                        EvaluateCONSORT(item, protocol);
                    else if (checklist.Name.Contains("SRQR"))
                        EvaluateSRQR(item, protocol);
                    else if (checklist.Name.Contains("GRAMMS"))
                        EvaluateGRAMMS(item, protocol);
                    else if (checklist.Name.Contains("PRISMA"))
                        EvaluatePRISMA(item, protocol);
                    else if (checklist.Name.Contains("CARE"))
                        EvaluateCARE(item, protocol);
                    else if (checklist.Name.Contains("Historique"))
                        EvaluateHISTORIC(item, protocol);
                    else if (checklist.Name.Contains("Spatiale"))
                        EvaluateSPATIAL(item, protocol);
                    else if (checklist.Name.Contains("Sociales"))
                        EvaluateSOCIOLOGY(item, protocol);
                }
            }
        }
        
        private void EvaluateHISTORIC(ChecklistItem item, ResearchProtocol protocol)
        {
            switch (item.Id)
            {
                case "H1": item.IsMet = !string.IsNullOrWhiteSpace(protocol.DataCollection); break;
                case "H2": item.IsMet = !string.IsNullOrWhiteSpace(protocol.StudySetting); break;
            }
        }

        private void EvaluateSPATIAL(ChecklistItem item, ResearchProtocol protocol)
        {
            switch (item.Id)
            {
                case "S1": item.IsMet = protocol.StudySetting?.ToLower().Contains("coordonn√©es") == true || protocol.StudySetting?.ToLower().Contains("projection") == true; break;
                case "S2": item.IsMet = !string.IsNullOrWhiteSpace(protocol.DataAnalysis); break;
            }
        }

        private void EvaluateSOCIOLOGY(ChecklistItem item, ResearchProtocol protocol)
        {
            switch (item.Id)
            {
                case "SS1": item.IsMet = !string.IsNullOrWhiteSpace(protocol.ConceptualModel); break;
                case "SS3": item.IsMet = protocol.Ethics?.ToLower().Contains("anonym") == true; break;
            }
        }

        private void EvaluateCOREQ(ChecklistItem item, ResearchProtocol protocol)
        {
            switch (item.Id)
            {
                // Domain 1: Research team
                // Items 1-8 relate to dynamic Author details or extra fields not yet in Protocol. 
                // We'll skip or set to false/check specific fields if available.

                // Domain 2: Study design
                case "9": // Orientation m√©thodologique
                    item.IsMet = protocol.QualitativeApproach != QualitativeApproach.Inductive; 
                    // Note: Inductive is default, so hard to know if user consciously chose it, but it's "filled".
                    // Let's assume Valid as it's a required Enum.
                    item.IsMet = true; 
                    break;
                case "10": // √âchantillonnage
                    item.IsMet = !string.IsNullOrWhiteSpace(protocol.SamplingMethod);
                    break;
                case "14": // Cadre de collecte
                    item.IsMet = !string.IsNullOrWhiteSpace(protocol.StudySetting);
                    break;
                case "17": // Guide d'entretien => DataCollection
                    item.IsMet = !string.IsNullOrWhiteSpace(protocol.DataCollection);
                    break;
            }
        }

        private void EvaluateSTROBE(ChecklistItem item, ResearchProtocol protocol)
        {
            switch (item.Id)
            {
                case "1": // Contexte et Justification
                    item.IsMet = !string.IsNullOrWhiteSpace(protocol.Context) && !string.IsNullOrWhiteSpace(protocol.ProblemJustification);
                    break;
                case "2": // Objectifs
                    item.IsMet = !string.IsNullOrWhiteSpace(protocol.GeneralObjective);
                    break;
                case "3": // Type d'√©tude
                    item.IsMet = true; // Enum always set
                    break;
                case "4": // Cadre
                    item.IsMet = !string.IsNullOrWhiteSpace(protocol.StudySetting);
                    break;
                case "5": // Participants
                    item.IsMet = !string.IsNullOrWhiteSpace(protocol.InclusionCriteria) && !string.IsNullOrWhiteSpace(protocol.ExclusionCriteria);
                    break;
                case "6": // Variables
                    item.IsMet = protocol.Variables != null && protocol.Variables.Count > 0;
                    break;
                case "9": // Taille d'√©tude
                    item.IsMet = !string.IsNullOrWhiteSpace(protocol.SamplingMethod);
                    break;
            }
        }

        private void EvaluateCONSORT(ChecklistItem item, ResearchProtocol protocol)
        {
            switch (item.Id)
            {
                case "1a": // Titre
                    item.IsMet = protocol.Title?.ToLower().Contains("random") == true;
                    break;
                case "2a": // Contexte
                    item.IsMet = !string.IsNullOrWhiteSpace(protocol.Context);
                    break;
                case "2b": // Objectifs
                    item.IsMet = !string.IsNullOrWhiteSpace(protocol.GeneralObjective);
                    break;
                case "4a": // √âligibilit√©
                    item.IsMet = !string.IsNullOrWhiteSpace(protocol.InclusionCriteria);
                    break;
                case "4b": // Cadre
                    item.IsMet = !string.IsNullOrWhiteSpace(protocol.StudySetting);
                    break;
                case "7a": // Taille
                    item.IsMet = !string.IsNullOrWhiteSpace(protocol.SamplingMethod);
                    break;
                case "12a": // Stats
                    item.IsMet = !string.IsNullOrWhiteSpace(protocol.DataAnalysis);
                    break;
            }
        }
        private void EvaluateSRQR(ChecklistItem item, ResearchProtocol protocol)
        {
             switch (item.Id)
            {
                case "1": item.IsMet = !string.IsNullOrWhiteSpace(protocol.Title); break;
                case "3": item.IsMet = !string.IsNullOrWhiteSpace(protocol.ProblemJustification); break;
                case "4": item.IsMet = !string.IsNullOrWhiteSpace(protocol.ResearchQuestion); break;
                case "8": item.IsMet = !string.IsNullOrWhiteSpace(protocol.SamplingMethod); break;
                case "11": item.IsMet = !string.IsNullOrWhiteSpace(protocol.DataAnalysis); break;
                case "13": item.IsMet = !string.IsNullOrWhiteSpace(protocol.Ethics); break;
            }
        }

        private void EvaluateGRAMMS(ChecklistItem item, ResearchProtocol protocol)
        {
            switch (item.Id)
            {
                case "1": item.IsMet = !string.IsNullOrWhiteSpace(protocol.ProblemJustification); break;
                case "3": item.IsMet = !string.IsNullOrWhiteSpace(protocol.SamplingMethod) && !string.IsNullOrWhiteSpace(protocol.DataAnalysis); break;
            }
        }

        private void EvaluatePRISMA(ChecklistItem item, ResearchProtocol protocol)
        {
            switch (item.Id)
            {
                case "1": item.IsMet = protocol.Title?.ToLower().Contains("systematic") == true || protocol.Title?.ToLower().Contains("revue") == true; break;
                case "5": item.IsMet = !string.IsNullOrWhiteSpace(protocol.InclusionCriteria); break;
                case "6": item.IsMet = !string.IsNullOrWhiteSpace(protocol.DataCollection); break;
            }
        }

        private void EvaluateCARE(ChecklistItem item, ResearchProtocol protocol)
        {
            switch (item.Id)
            {
                case "1": item.IsMet = protocol.Title?.ToLower().Contains("case") == true || protocol.Title?.ToLower().Contains("cas") == true; break;
                case "5a": item.IsMet = !string.IsNullOrWhiteSpace(protocol.StudyPopulation); break;
                case "8": item.IsMet = !string.IsNullOrWhiteSpace(protocol.DataCollection); break;
            }
        }
    }
}




FILE: \AdRev.Core\Services\QuestionnaireGenerator.cs
------------------------------------
using AdRev.Domain.Protocols;
using AdRev.Domain.Variables;
using AdRev.Domain.Enums;
using System.Text;
using System.Linq;
using System.Collections.Generic;
using System;

namespace AdRev.Core.Services
{
    public class QuestionnaireGenerator
    {
        public string GenerateMarkdownQuestionnaire(ResearchProtocol protocol)
        {
            var sb = new StringBuilder();

            // 1. En-t√™te
            sb.AppendLine("# FICHE D'ENQU√äTE / CAHIER D'OBSERVATION");
            sb.AppendLine("________________________________________________________________________________");
            sb.AppendLine($"**TITRE :** {protocol.Title}");
            sb.AppendLine($"**CODE √âTUDE :** {protocol.Id.Substring(0, 8).ToUpper()}");
            sb.AppendLine($"**DATE :** ____ / ____ / ________");
            sb.AppendLine($"**ENQU√äTEUR :** __________________________________");
            sb.AppendLine($"**N¬∞ ID PARTICIPANT :** |__|__|__|__|__|");
            sb.AppendLine("________________________________________________________________________________\n");

            if (protocol.Variables == null || !protocol.Variables.Any())
            {
                sb.AppendLine("*Aucune variable d√©finie pour le moment.*");
                return sb.ToString();
            }

            // 2. Regrouper par sections
            var groups = protocol.Variables
                .GroupBy(v => string.IsNullOrWhiteSpace(v.GroupName) ? "VARIABLES G√âN√âRALES" : v.GroupName)
                .OrderBy(g => g.Key == "VARIABLES G√âN√âRALES" ? 0 : 1); // G√©n√©ral en premier

            foreach (var group in groups)
            {
                sb.AppendLine($"## {group.Key.ToUpper()}");
                sb.AppendLine("--------------------------------------------------");

                foreach (var variable in group)
                {
                    sb.AppendLine(FormatVariable(variable));
                }
                sb.AppendLine(""); // Espace entre les groupes
            }

            // 3. Pied de page
            sb.AppendLine("________________________________________________________________________________");
            sb.AppendLine("FIN DE L'ENQU√äTE");
            sb.AppendLine("Merci de v√©rifier que toutes les questions obligatoires (*) sont remplies.");

            return sb.ToString();
        }

        private string FormatVariable(StudyVariable v)
        {
            var sb = new StringBuilder();
            
            // Marqueur obligatoire
            string req = v.IsRequired ? "(*)" : "";
            
            // Condition d'affichage (Visible uniquement si...)
            string condition = !string.IsNullOrWhiteSpace(v.VisibilityCondition) 
                ? $" [SI {v.VisibilityCondition}]" 
                : "";

            // Question
            sb.AppendLine($"**{v.Prompt}** {req}{condition}");
            
            // Zone de r√©ponse selon le type
            switch (v.Type)
            {
                case VariableType.Text:
                    sb.AppendLine($"   [__________________________________________________] (Texte)");
                    break;
                
                case VariableType.Memo:
                    sb.AppendLine($"   [__________________________________________________]");
                    sb.AppendLine($"   [__________________________________________________]");
                    sb.AppendLine($"   [__________________________________________________]");
                    break;
                
                case VariableType.QuantitativeDiscrete:
                case VariableType.QuantitativeContinuous:
                    sb.AppendLine($"   |__|__|__|__|__| {(v.Type == VariableType.QuantitativeContinuous ? ", |__|__|" : "")}");
                    break;
                
                case VariableType.QuantitativeTemporal:
                    sb.AppendLine($"   __ / __ / ____ (JJ/MM/AAAA)");
                    break;
                
                case VariableType.Time:
                    sb.AppendLine($"   __ : __ (HH:MM)");
                    break;
                
                case VariableType.QualitativeBinary:
                    sb.AppendLine($"   [ ] OUI    [ ] NON");
                    if (!string.IsNullOrWhiteSpace(v.SkipLogic))
                    {
                         sb.AppendLine($"   -> {v.SkipLogic}");
                    }
                    break;
                
                case VariableType.QualitativeNominal:
                case VariableType.QualitativeOrdinal:
                case VariableType.MultipleChoice:
                    if (!string.IsNullOrWhiteSpace(v.ChoiceOptions))
                    {
                        var options = v.ChoiceOptions.Split(new[] { ',', ';' }, StringSplitOptions.RemoveEmptyEntries);
                        foreach (var opt in options)
                        {
                            string box = v.Type == VariableType.MultipleChoice ? "[ ]" : "( )";
                            sb.AppendLine($"   {box} {opt.Trim()}");
                        }
                    }
                    else
                    {
                        sb.AppendLine($"   ( ) Option 1   ( ) Option 2   ( ) ...");
                    }
                    
                    // Affichage de la logique de saut si pr√©sente
                    if (!string.IsNullOrWhiteSpace(v.SkipLogic))
                    {
                         sb.AppendLine($"   -> {v.SkipLogic}");
                    }
                    break;
                
                case VariableType.Calculated:
                    sb.AppendLine($"   [ CALCUL AUTOMATIQUE ]");
                    if (!string.IsNullOrWhiteSpace(v.CalculationFormula))
                        sb.AppendLine($"   Formule : {v.CalculationFormula}");
                    break;
                
                default:
                    sb.AppendLine($"   [____________________]");
                    break;
            }

            // Nom de variable technique (discret)
            sb.AppendLine($"   _{v.Name}_");
            sb.AppendLine(""); // Espace apr√®s la question

            return sb.ToString();
        }
    }
}




FILE: \AdRev.Core\Services\StatisticsService.cs
------------------------------------
using System;
using System.Collections.Generic;
using System.Linq;
using MathNet.Numerics.Statistics;
using MathNet.Numerics.Distributions;
using MathNet.Numerics;

namespace AdRev.Core.Services
{
    public class StatisticsService
    {
        // --- Descriptive Statistics ---

        public Dictionary<string, double> CalculateDescriptiveStats(List<double> data)
        {
            if (data == null || data.Count == 0)
                return new Dictionary<string, double>();

            var stats = new Dictionary<string, double>();
            var s = new DescriptiveStatistics(data);
            
            stats["N"] = s.Count;
            stats["Mean"] = s.Mean;
            stats["Median"] = data.Median();
            stats["Min"] = s.Minimum;
            stats["Max"] = s.Maximum;
            stats["Variance"] = s.Variance;
            stats["StdDev"] = s.StandardDeviation;
            stats["Range"] = s.Maximum - s.Minimum;
            stats["Skewness"] = s.Skewness;
            stats["Kurtosis"] = s.Kurtosis;

            return stats;
        }

        public Dictionary<string, int> CalculateFrequencies(List<string> data)
        {
            if (data == null) return new Dictionary<string, int>();
            
            return data.GroupBy(x => x ?? "N/A")
                       .ToDictionary(g => g.Key, g => g.Count());
        }

        // --- Normality Test ---
        public (double statistic, double pValue, bool isNormal) CalculateShapiroWilk(List<double> data)
        {
             // Shapiro-Wilk is not directly in core MathNet, using approximation or switching to Jarque-Bera which is available if N is large.
             // For simplicity and dependency reduction, we can use a basic Jarque-Bera (Skewness/Kurtosis based) which is standard for large samples,
             // or check if MathNet provides it in newer versions. MathNet doesn't have Shapiro built-in.
             // We will implement Jarque-Bera:
             if (data.Count < 2) return (0, 0, false);

             double n = data.Count;
             double s = Statistics.Skewness(data);
             double k = Statistics.Kurtosis(data);
             
             double jb = (n / 6.0) * (Math.Pow(s, 2) + Math.Pow(k, 2) / 4.0);
             double pValue = 1.0 - ChiSquared.CDF(2, jb); // 2 degrees of freedom

             return (jb, pValue, pValue > 0.05);
        }

        // --- Inferential Statistics ---

        public double CalculatePearsonCorrelation(List<double> x, List<double> y)
        {
            return Correlation.Pearson(x, y);
        }

        public double CalculateSpearmanCorrelation(List<double> x, List<double> y)
        {
            return Correlation.Spearman(x, y);
        }

        /// <summary>
        /// Student's T-Test (Independent Samples)
        /// Returns t-statistic, dof, and P-Value (Two-Tailed)
        /// </summary>
        public (double tStat, double dof, double pValue) CalculateTTest(List<double> group1, List<double> group2)
        {
            if (group1.Count < 2 || group2.Count < 2) return (0, 0, 1.0);

            var s1 = new DescriptiveStatistics(group1);
            var s2 = new DescriptiveStatistics(group2);

            // Welch's T-Test (Unequal Variance assumption is safer)
            double vn1 = s1.Variance / s1.Count;
            double vn2 = s2.Variance / s2.Count;
            double stdErr = Math.Sqrt(vn1 + vn2);
            double t = (s1.Mean - s2.Mean) / stdErr;

            // Welch-Satterthwaite DoF
            double dofNumerator = Math.Pow(vn1 + vn2, 2);
            double dofDenominator = (Math.Pow(vn1, 2) / (s1.Count - 1)) + (Math.Pow(vn2, 2) / (s2.Count - 1));
            double dof = dofNumerator / dofDenominator;

            // Two-tailed P-Value
            double pValue = 2.0 * (1.0 - StudentT.CDF(0, 1, dof, Math.Abs(t)));

            return (t, dof, pValue);
        }

        /// <summary>
        /// Paired Samples T-Test
        /// </summary>
        public (double tStat, double dof, double pValue) CalculatePairedTTest(List<double> before, List<double> after)
        {
            if (before.Count != after.Count || before.Count < 2) return (0, 0, 1.0);

            var diffs = new List<double>();
            for(int i=0; i<before.Count; i++) diffs.Add(after[i] - before[i]);

            double meanDiff = diffs.Average();
            double stdErr = Statistics.StandardDeviation(diffs) / Math.Sqrt(diffs.Count);
            double t = meanDiff / stdErr;
            double dof = diffs.Count - 1;

            double pValue = 2.0 * (1.0 - StudentT.CDF(0, 1, dof, Math.Abs(t)));

            return (t, dof, pValue);
        }

        /// <summary>
        /// One-Way ANOVA
        /// Returns F-Statistic, dfBetween, dfWithin, P-Value
        /// </summary>
        public (double fStat, int dfBetween, int dfWithin, double pValue) CalculateOneWayANOVA(List<List<double>> groups)
        {
            var validGroups = groups.Where(g => g.Count > 0).ToList();
            int k = validGroups.Count;
            if (k < 2) return (0, 0, 0, 1.0);

            int N = validGroups.Sum(g => g.Count);
            double grandMean = validGroups.SelectMany(x => x).Average();

            double ssBetween = 0;
            double ssWithin = 0;

            foreach(var g in validGroups)
            {
                ssBetween += g.Count * Math.Pow(g.Average() - grandMean, 2);
                ssWithin += g.Sum(x => Math.Pow(x - g.Average(), 2));
            }

            int dfBetween = k - 1;
            int dfWithin = N - k;

            if (dfBetween == 0 || dfWithin == 0) return (0, 0, 0, 1.0);

            double msBetween = ssBetween / dfBetween;
            double msWithin = ssWithin / dfWithin;
            double f = msBetween / msWithin;

            double pValue = 1.0 - FisherSnedecor.CDF(dfBetween, dfWithin, f);

            return (f, dfBetween, dfWithin, pValue);
        }

        /// <summary>
        /// Mann-Whitney U Test with Normal Approximation
        /// </summary>
        public (double uStat, double zScore, double pValue) CalculateMannWhitneyU(List<double> group1, List<double> group2)
        {
             // Same manual implementation but with proper P-Value from Normal Distribution
             if (group1.Count == 0 || group2.Count == 0) return (0, 0, 1.0);
             
             // ... Rank Logic (Reusing previous logic for brevity, optimized) ...
             var combined = group1.Select(x => new { Val = x, Group = 1 })
                                .Concat(group2.Select(x => new { Val = x, Group = 2 }))
                                .OrderBy(x => x.Val)
                                .ToList();
            
             double[] ranks = new double[combined.Count];
             for (int i = 0; i < combined.Count; ) {
                 int j = i + 1;
                 while (j < combined.Count && Math.Abs(combined[j].Val - combined[i].Val) < 1e-9) j++;
                 double rankMean = (i + 1 + j) / 2.0;
                 for (int m = i; m < j; m++) ranks[m] = rankMean;
                 i = j;
             }

             double rankSum1 = 0;
             for(int i=0; i<combined.Count; i++) if (combined[i].Group == 1) rankSum1 += ranks[i];
             
             int n1 = group1.Count, n2 = group2.Count;
             double u1 = rankSum1 - (n1 * (n1 + 1)) / 2.0;
             double u = Math.Min(u1, (n1 * n2) - u1);

             double mu = (n1 * n2) / 2.0;
             double sigma = Math.Sqrt((n1 * n2 * (n1 + n2 + 1)) / 12.0);
             double z = (u - mu) / sigma;

             // Two-tailed P-Value from Normal
             double pValue = 2.0 * (1.0 - Normal.CDF(0, 1, Math.Abs(z)));

             return (u, z, pValue);
        }

        /// <summary>
        /// Chi-Square Test of Independence
        /// Returns Chi-Square statistic, DoF, P-Value
        /// </summary>
        public (double chiSquare, int dof, double pValue) CalculateChiSquare(List<string> var1, List<string> var2)
        {
             if (var1.Count != var2.Count) return (0, 0, 1.0);

             var distinct1 = var1.Distinct().OrderBy(x => x).ToList();
             var distinct2 = var2.Distinct().OrderBy(x => x).ToList();
             int rows = distinct1.Count; 
             int cols = distinct2.Count;
             if (rows < 2 || cols < 2) return (0,0, 1.0);

             int[,] observed = new int[rows, cols];
             int[] rowTotals = new int[rows];
             int[] colTotals = new int[cols];
             int grandTotal = var1.Count;

             for (int i = 0; i < grandTotal; i++)
             {
                 int r = distinct1.IndexOf(var1[i]);
                 int c = distinct2.IndexOf(var2[i]);
                 observed[r, c]++;
                 rowTotals[r]++;
                 colTotals[c]++;
             }

             double chiSq = 0;
             for (int r = 0; r < rows; r++)
             {
                 for (int c = 0; c < cols; c++)
                 {
                     double expected = (double)rowTotals[r] * colTotals[c] / grandTotal;
                     if (expected > 0) chiSq += Math.Pow(observed[r, c] - expected, 2) / expected;
                 }
             }

             int dof = (rows - 1) * (cols - 1);
             double pValue = 1.0 - ChiSquared.CDF(dof, chiSq);
             return (chiSq, dof, pValue);
        }

        public double CalculateCronbachAlpha(List<List<double>> itemScores)
        {
            // Same manual implementation (MathNet doesn't have Cronbach specifically standard)
             int k = itemScores.Count; 
             if (k < 2) return 0;
             int n = itemScores[0].Count;
             if (n < 2) return 0;

             double sumItemVariances = 0;
             var subjectTotalScores = new double[n];

             for(int j=0; j<k; j++)
             {
                 var scores = itemScores[j];
                 double sMean = scores.Average();
                 double sVar = scores.Sum(x => Math.Pow(x-sMean, 2)) / (n - 1);
                 sumItemVariances += sVar;
                 for(int i=0; i<n; i++) subjectTotalScores[i] += scores[i];
             }

             double meanTotal = subjectTotalScores.Average();
             double totalVariance = subjectTotalScores.Sum(x => Math.Pow(x - meanTotal, 2)) / (n - 1);

             if (totalVariance == 0) return 0;
             return (k / (double)(k - 1)) * (1 - (sumItemVariances / totalVariance));
        }

        // --- Regression ---
        // Using MathNet Fit for Regression

        public (double slope, double intercept, double rSquared) CalculateLinearRegression(List<double> x, List<double> y)
        {
            if (x.Count != y.Count) return (0,0,0);
            var p = Fit.Line(x.ToArray(), y.ToArray());
            var intercept = p.Item1;
            var slope = p.Item2;
            var r2 = GoodnessOfFit.RSquared(x.Select(val => intercept + slope * val), y);
            return (slope, intercept, r2);
        }

        /// <summary>
        /// Simple Logistic Regression using Gradient Descent (Binary Y: 0 or 1)
        /// Returns (Beta0, Beta1, Accuracy)
        /// </summary>
        public (double beta0, double beta1, double accuracy) CalculateLogisticRegression(List<double> x, List<double> y)
        {
            if (x.Count != y.Count) return (0,0,0);

            // Scale X for stability
            double minX = x.Min();
            double maxX = x.Max();
            var scaledX = x.Select(val => (val - minX) / (maxX - minX)).ToList();

            double b0 = 0; // Intercept
            double b1 = 0; // Slope
            double learningRate = 0.1;
            int epochs = 1000;
            int n = x.Count;

            for (int epoch = 0; epoch < epochs; epoch++)
            {
                double sumErr0 = 0;
                double sumErr1 = 0;

                for (int i = 0; i < n; i++)
                {
                    double linear = b0 + b1 * scaledX[i];
                    double prediction = 1.0 / (1.0 + Math.Exp(-linear)); // Sigmoid
                    double error = prediction - y[i];

                    sumErr0 += error;
                    sumErr1 += error * scaledX[i];
                }

                b0 -= learningRate * (sumErr0 / n);
                b1 -= learningRate * (sumErr1 / n);
            }

            // Rescale Beta1 to original scale roughly (approximation)
            b1 = b1 / (maxX - minX);
            b0 = b0 - b1 * minX;

            // Calculate Accuracy
            int correct = 0;
            for(int i=0; i<n; i++)
            {
                double prob = 1.0 / (1.0 + Math.Exp(-(b0 + b1*x[i])));
                double predictedClass = prob >= 0.5 ? 1.0 : 0.0;
                if (Math.Abs(predictedClass - y[i]) < 0.1) correct++;
            }

            return (b0, b1, (double)correct/n);
        }

        public (double[] betas, double rSquared) CalculateMultipleLinearRegression(List<double[]> x, List<double> y)
        {
             if (x.Count == 0) return (new double[0], 0);
             // Flatten X for MathNet
             int n = x.Count;
             int p = x[0].Length;
             
             // MathNet MultiDim Regression requires double[][]
             var xArr = x.ToArray();
             var yArr = y.ToArray();
             
             var betas = Fit.MultiDim(xArr, yArr, intercept: true);
             // Betas from Fit.MultiDim: [Intercept, b1, b2...]
             
             // Calculate R2 manually or via localized prediction
             double ssTotal = y.Sum(val => Math.Pow(val - y.Average(), 2));
             double ssRes = 0;
             for(int i=0; i<n; i++) {
                 double pred = betas[0];
                 for(int j=0; j<p; j++) pred += betas[j+1] * x[i][j];
                 ssRes += Math.Pow(y[i] - pred, 2);
             }
             double r2 = 1.0 - (ssRes / ssTotal);
             
             return (betas, r2);
        }

        public string GetSignificanceLevel(double pValue)
        {
            if (pValue < 0.001) return "*** (p < 0.001)";
            if (pValue < 0.01) return "** (p < 0.01)";
            if (pValue < 0.05) return "* (p < 0.05)";
            return "NS (Non Significatif)";
        }
    }
}




FILE: \AdRev.Desktop\Converters\ResponsiveConverters.cs
------------------------------------
using System;
using System.Globalization;
using System.Windows;
using System.Windows.Data;
using System.Windows.Media;

namespace AdRev.Desktop
{
    /// <summary>
    /// Converter to determine if window width should trigger compact mode
    /// </summary>
    public class WidthToCompactConverter : IValueConverter
    {
        private const double CompactModeThreshold = 1280;

        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value is double width)
            {
                return width < CompactModeThreshold;
            }
            return false;
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }

    /// <summary>
    /// Converter for responsive font sizing based on DPI
    /// </summary>
    public class DpiToFontSizeConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value is double baseFontSize && parameter is string multiplierStr)
            {
                if (double.TryParse(multiplierStr, out double multiplier))
                {
                    // Get DPI scaling factor
                    var mainWindow = Application.Current?.MainWindow;
                    if (mainWindow != null)
                    {
                        var dpiScale = VisualTreeHelper.GetDpi(mainWindow).DpiScaleX;
                        return baseFontSize * multiplier * dpiScale;
                    }
                }
            }
            return 14.0; // Default font size
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }

    /// <summary>
    /// Converter for responsive spacing based on available space
    /// </summary>
    public class ResponsiveSpacingConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value is double width)
            {
                // Scale spacing based on width
                if (width < 1024) return new Thickness(8);
                if (width < 1366) return new Thickness(16);
                return new Thickness(24);
            }
            return new Thickness(16);
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }
}




FILE: \AdRev.Desktop\Resources\Styles.xaml
------------------------------------
<ResourceDictionary xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
                    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
                    xmlns:system="clr-namespace:System;assembly=System.Runtime">

    <!-- Palette de couleurs apaisante -->
    <Color x:Key="PrimaryColor">#5A9F9A</Color> <!-- Soft Teal/Sage -->
    <Color x:Key="PrimaryDarkColor">#4A8A85</Color>
    <Color x:Key="SecondaryColor">#E8A598</Color> <!-- Warm Coral -->
    <Color x:Key="BackgroundColor">#F5F5F0</Color> <!-- Light Cream -->
    <Color x:Key="SurfaceColor">#FEFEFE</Color> <!-- Soft White -->
    <Color x:Key="SidebarColor">#E8F3F1</Color> <!-- Light Sage -->
    <Color x:Key="MenuBarColor">#B8C5D0</Color> <!-- Soft Blue-Gray -->
    <Color x:Key="ErrorColor">#D9907C</Color> <!-- Soft Red-Orange -->
    <Color x:Key="TextColor">#2C3E50</Color> <!-- Dark Gray -->
    <Color x:Key="SecondaryTextColor">#7F8C8D</Color> <!-- Medium Gray -->

    <LinearGradientBrush x:Key="PrimaryBrush" StartPoint="0,0" EndPoint="1,1">
        <GradientStop Color="#5A9F9A" Offset="0"/>
        <GradientStop Color="#6AB5AF" Offset="1"/>
    </LinearGradientBrush>
    <LinearGradientBrush x:Key="PrimaryDarkBrush" StartPoint="0,0" EndPoint="1,1">
        <GradientStop Color="#4A8A85" Offset="0"/>
        <GradientStop Color="#5A9F9A" Offset="1"/>
    </LinearGradientBrush>
    <SolidColorBrush x:Key="TextBrush" Color="{StaticResource TextColor}"/>
    <SolidColorBrush x:Key="SecondaryTextBrush" Color="{StaticResource SecondaryTextColor}"/>
    <SolidColorBrush x:Key="LightTextBrush" Color="#FFFFFF"/>
    <SolidColorBrush x:Key="BackgroundBrush" Color="{StaticResource BackgroundColor}"/>
    <SolidColorBrush x:Key="SurfaceBrush" Color="{StaticResource SurfaceColor}"/>
    <SolidColorBrush x:Key="SidebarBrush" Color="{StaticResource SidebarColor}"/>
    <SolidColorBrush x:Key="MenuBarBrush" Color="{StaticResource MenuBarColor}"/>
    <SolidColorBrush x:Key="SecondaryBrush" Color="{StaticResource SecondaryColor}"/>
    <SolidColorBrush x:Key="ErrorBrush" Color="{StaticResource ErrorColor}"/>

    <!-- Style Bouton Moderne -->
    <Style x:Key="ModernButtonStyle" TargetType="Button">
        <Setter Property="Background" Value="{StaticResource PrimaryBrush}"/>
        <Setter Property="Foreground" Value="{StaticResource LightTextBrush}"/>
        <Setter Property="FontSize" Value="14"/>
        <Setter Property="FontWeight" Value="SemiBold"/>
        <Setter Property="Padding" Value="16,10"/>
        <Setter Property="Margin" Value="5"/>
        <Setter Property="BorderThickness" Value="0"/>
        <Setter Property="Cursor" Value="Hand"/>
        <Setter Property="Effect">
            <Setter.Value>
                <DropShadowEffect BlurRadius="8" Color="#000000" ShadowDepth="2" Direction="270" Opacity="0.1"/>
            </Setter.Value>
        </Setter>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="Button">
                    <Border x:Name="border" Background="{TemplateBinding Background}" 
                            CornerRadius="8" 
                            Padding="{TemplateBinding Padding}">
                        <Border.RenderTransform>
                            <TranslateTransform x:Name="transform"/>
                        </Border.RenderTransform>
                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Border>
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter Property="Background" Value="{StaticResource PrimaryDarkBrush}"/>
                            <Trigger.EnterActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetName="transform" 
                                                       Storyboard.TargetProperty="Y" 
                                                       To="-2" Duration="0:0:0.15"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </Trigger.EnterActions>
                            <Trigger.ExitActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetName="transform" 
                                                       Storyboard.TargetProperty="Y" 
                                                       To="0" Duration="0:0:0.15"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </Trigger.ExitActions>
                        </Trigger>
                        <Trigger Property="IsPressed" Value="True">
                            <Setter Property="Opacity" Value="0.85"/>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <Style TargetType="Button" BasedOn="{StaticResource ModernButtonStyle}"/>


    <!-- Style TextBox Moderne -->
    <Style TargetType="TextBox">
        <Setter Property="Padding" Value="10"/>
        <Setter Property="Margin" Value="0,5,0,15"/>
        <Setter Property="FontSize" Value="14"/>
        <Setter Property="BorderThickness" Value="1"/>
        <Setter Property="BorderBrush" Value="#DDDDDD"/>
        <Setter Property="Background" Value="White"/>
        <Setter Property="Foreground" Value="#212121"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="TextBox">
                    <Grid>
                        <Border Background="{TemplateBinding Background}" 
                                BorderBrush="{TemplateBinding BorderBrush}" 
                                BorderThickness="{TemplateBinding BorderThickness}" 
                                CornerRadius="5">
                            <ScrollViewer x:Name="PART_ContentHost"/>
                        </Border>
                        <TextBlock x:Name="PlaceholderText"
                                   Text="{TemplateBinding Tag}"
                                   Foreground="Gray"
                                   IsHitTestVisible="False"
                                   Visibility="Collapsed"
                                   Margin="15,10,0,0"
                                   FontStyle="Italic"/>
                    </Grid>
                    <ControlTemplate.Triggers>
                        <MultiTrigger>
                            <MultiTrigger.Conditions>
                                <Condition Property="Text" Value=""/>
                                <Condition Property="IsFocused" Value="False"/>
                            </MultiTrigger.Conditions>
                            <Setter TargetName="PlaceholderText" Property="Visibility" Value="Visible"/>
                        </MultiTrigger>
                        <Trigger Property="IsFocused" Value="True">
                            <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrush}"/>
                            <Setter Property="BorderThickness" Value="2"/>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <!-- Style Label/TextBlock Titre -->
    <Style x:Key="HeaderTextStyle" TargetType="TextBlock">
        <Setter Property="FontSize" Value="24"/>
        <Setter Property="FontWeight" Value="Bold"/>
        <Setter Property="Foreground" Value="{StaticResource PrimaryBrush}"/>
        <Setter Property="Margin" Value="0,0,0,20"/>
    </Style>

    <Style x:Key="LabelStyle" TargetType="TextBlock">
        <Setter Property="FontSize" Value="14"/>
        <Setter Property="Foreground" Value="#212121"/>
        <Setter Property="Margin" Value="0,0,0,5"/>
        <Setter Property="FontWeight" Value="Medium"/>
    </Style>

    <!-- Sidebar Button Style -->
    <Style x:Key="SidebarButtonStyle" TargetType="RadioButton">
        <Setter Property="Height" Value="50"/>
        <Setter Property="Margin" Value="0,5"/>
        <Setter Property="Background" Value="Transparent"/>
        <Setter Property="Foreground" Value="#A0A0A0"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="RadioButton">
                    <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="10" Margin="10,0">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="40" />
                                <ColumnDefinition Width="*" />
                            </Grid.ColumnDefinitions>
                            <ContentPresenter Grid.Column="0" x:Name="icon" HorizontalAlignment="Center" VerticalAlignment="Center" Margin="5,0,0,0"/>
                            <ContentPresenter Grid.Column="1" VerticalAlignment="Center" Margin="10,0"/>
                        </Grid>
                    </Border>
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsChecked" Value="True">
                            <Setter TargetName="border" Property="Background" Value="#F0EEFF"/>
                            <Setter Property="Foreground" Value="{StaticResource PrimaryBrush}"/>
                        </Trigger>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter TargetName="border" Property="Background" Value="#F8F8F8"/>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <!-- Ribbon Tab Button Style -->
    <Style x:Key="RibbonTabButtonStyle" TargetType="RadioButton">
        <Setter Property="Height" Value="35"/>
        <Setter Property="Padding" Value="20,0"/>
        <Setter Property="Background" Value="Transparent"/>
        <Setter Property="Foreground" Value="#E0E0E0"/>
        <Setter Property="FontSize" Value="14"/>
        <Setter Property="FontWeight" Value="SemiBold"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="RadioButton">
                    <Border x:Name="border" Background="{TemplateBinding Background}" BorderBrush="Transparent" BorderThickness="0,0,0,3">
                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" Margin="{TemplateBinding Padding}"/>
                    </Border>
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsChecked" Value="True">
                            <Setter TargetName="border" Property="BorderBrush" Value="{StaticResource PrimaryBrush}"/>
                            <Setter Property="Foreground" Value="{StaticResource PrimaryBrush}"/>
                            <Setter TargetName="border" Property="Background" Value="White"/>
                        </Trigger>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter TargetName="border" Property="Background" Value="#33FFFFFF"/>
                            <Setter Property="Foreground" Value="White"/>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <!-- Ribbon Action Button Style -->
    <Style x:Key="RibbonActionButtonStyle" TargetType="Button">
        <Setter Property="Background" Value="Transparent"/>
        <Setter Property="Foreground" Value="Black"/>
        <Setter Property="FontSize" Value="12"/>
        <Setter Property="FontWeight" Value="Medium"/>
        <Setter Property="Padding" Value="12,4"/>
        <Setter Property="BorderThickness" Value="0"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="Button">
                    <Border x:Name="border" Background="{TemplateBinding Background}" CornerRadius="5">
                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center" Margin="{TemplateBinding Padding}"/>
                    </Border>
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter TargetName="border" Property="Background" Value="#E5E5E5"/>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <!-- Style Bouton Secondaire (Outline) -->
    <Style x:Key="SecondaryButtonStyle" TargetType="Button">
        <Setter Property="Background" Value="White"/>
        <Setter Property="Foreground" Value="{StaticResource PrimaryBrush}"/>
        <Setter Property="FontSize" Value="14"/>
        <Setter Property="FontWeight" Value="SemiBold"/>
        <Setter Property="Padding" Value="15,4"/>
        <Setter Property="MinHeight" Value="35"/>
        <Setter Property="Margin" Value="5"/>
        <Setter Property="BorderThickness" Value="2"/>
        <Setter Property="BorderBrush" Value="{StaticResource PrimaryBrush}"/>
        <Setter Property="Cursor" Value="Hand"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="Button">
                    <Border x:Name="border" Background="{TemplateBinding Background}" 
                            BorderBrush="{TemplateBinding BorderBrush}" 
                            BorderThickness="{TemplateBinding BorderThickness}" 
                            CornerRadius="8" 
                            Padding="{TemplateBinding Padding}">
                        <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                    </Border>
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsMouseOver" Value="True">
                            <Setter TargetName="border" Property="Background" Value="{StaticResource PrimaryBrush}"/>
                            <Setter Property="Foreground" Value="White"/>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

    <!-- Card Style -->
    <Style x:Key="CardStyle" TargetType="Border">
        <Setter Property="Background" Value="{StaticResource SurfaceBrush}"/>
        <Setter Property="CornerRadius" Value="12"/>
        <Setter Property="Padding" Value="24"/>
        <Setter Property="Margin" Value="8"/>
        <Setter Property="Effect">
            <Setter.Value>
                <DropShadowEffect BlurRadius="16" Color="#5A9F9A" ShadowDepth="2" Direction="270" Opacity="0.08"/>
            </Setter.Value>
        </Setter>
    </Style>

    <!-- Responsive Typography System -->
    <system:Double x:Key="FontSizeXSmall">10</system:Double>
    <system:Double x:Key="FontSizeSmall">12</system:Double>
    <system:Double x:Key="FontSizeMedium">14</system:Double>
    <system:Double x:Key="FontSizeLarge">16</system:Double>
    <system:Double x:Key="FontSizeXLarge">18</system:Double>
    <system:Double x:Key="FontSizeXXLarge">24</system:Double>
    <system:Double x:Key="FontSizeHuge">32</system:Double>

    <!-- Responsive Spacing System -->
    <Thickness x:Key="SpacingXSmall">4</Thickness>
    <Thickness x:Key="SpacingSmall">8</Thickness>
    <Thickness x:Key="SpacingMedium">16</Thickness>
    <Thickness x:Key="SpacingLarge">24</Thickness>
    <Thickness x:Key="SpacingXLarge">32</Thickness>

    <!-- Sidebar Responsive Style -->
    <Style x:Key="ResponsiveSidebarStyle" TargetType="Border">
        <Setter Property="Background" Value="{StaticResource SidebarBrush}"/>
        <Setter Property="MinWidth" Value="200"/>
        <Setter Property="MaxWidth" Value="300"/>
        <Setter Property="Width" Value="250"/>
    </Style>

    <!-- Touch-Friendly Button Style -->
    <Style x:Key="TouchButtonStyle" TargetType="Button" BasedOn="{StaticResource ModernButtonStyle}">
        <Setter Property="MinHeight" Value="44"/>
        <Setter Property="MinWidth" Value="44"/>
        <Setter Property="Padding" Value="20,12"/>
    </Style>

    <!-- Compact Mode Card -->
    <Style x:Key="CompactCardStyle" TargetType="Border" BasedOn="{StaticResource CardStyle}">
        <Setter Property="Padding" Value="16"/>
        <Setter Property="Margin" Value="4"/>
    </Style>

    <!-- Scientific Expander Style (Global) -->
    <Style x:Key="ScientificExpanderStyle" TargetType="Expander">
        <Setter Property="Background" Value="White"/>
        <Setter Property="BorderBrush" Value="#CFD8DC"/>
        <Setter Property="BorderThickness" Value="2"/>
        <Setter Property="Margin" Value="0,0,0,15"/>
        <Setter Property="IsExpanded" Value="True"/>
        <Setter Property="Template">
            <Setter.Value>
                <ControlTemplate TargetType="Expander">
                    <Border Background="{TemplateBinding Background}" 
                            BorderBrush="{TemplateBinding BorderBrush}" 
                            BorderThickness="{TemplateBinding BorderThickness}" 
                            CornerRadius="8">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>
                            
                            <!-- Header -->
                            <ToggleButton x:Name="HeaderSite" Grid.Row="0"
                                          Content="{TemplateBinding Header}"
                                          ContentTemplate="{TemplateBinding HeaderTemplate}"
                                          Background="{Binding Tag, RelativeSource={RelativeSource TemplatedParent}}" 
                                          Foreground="{Binding RelativeSource={RelativeSource TemplatedParent}, Path=Foreground}"
                                          FontWeight="Bold"
                                          Padding="15,10"
                                          HorizontalContentAlignment="Left"
                                          IsChecked="{Binding IsExpanded, Mode=TwoWay, RelativeSource={RelativeSource TemplatedParent}}">
                                <ToggleButton.Template>
                                    <ControlTemplate TargetType="ToggleButton">
                                        <Border Background="{TemplateBinding Background}" 
                                                CornerRadius="6,6,0,0"
                                                BorderBrush="{Binding RelativeSource={RelativeSource AncestorType=Expander}, Path=BorderBrush}"
                                                BorderThickness="0,0,0,1">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                
                                                <ContentPresenter Grid.Column="0" Content="{TemplateBinding Content}" VerticalAlignment="Center" Margin="5,0,0,0"/>
                                                
                                                <!-- Arrow Icon -->
                                                <Border Grid.Column="1" Width="24" Height="24" CornerRadius="12" Background="#20000000" Margin="10,0,0,0">
                                                    <TextBlock x:Name="Arrow" Text="‚ñº" 
                                                               HorizontalAlignment="Center" VerticalAlignment="Center" 
                                                               FontSize="10" Foreground="#555"/>
                                                </Border>
                                            </Grid>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsChecked" Value="False">
                                                <Setter TargetName="Arrow" Property="Text" Value="‚ñ∂"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </ToggleButton.Template>
                            </ToggleButton>

                            <!-- Content -->
                            <ContentPresenter x:Name="ExpandSite" Grid.Row="1" Visibility="Collapsed" Margin="0"/>
                        </Grid>
                    </Border>
                    <ControlTemplate.Triggers>
                        <Trigger Property="IsExpanded" Value="True">
                            <Setter TargetName="ExpandSite" Property="Visibility" Value="Visible"/>
                        </Trigger>
                        <Trigger Property="IsExpanded" Value="False">
                            <Setter TargetName="ExpandSite" Property="Visibility" Value="Collapsed"/>
                        </Trigger>
                    </ControlTemplate.Triggers>
                </ControlTemplate>
            </Setter.Value>
        </Setter>
    </Style>

</ResourceDictionary>




FILE: \AdRev.Desktop\Services\JournalService.cs
------------------------------------
using System.Collections.Generic;
using AdRev.Domain.Models;

namespace AdRev.Desktop.Services
{
    public class JournalService
    {
        public List<JournalSubmissionCriteria> GetCommonJournals()
        {
            return new List<JournalSubmissionCriteria>
            {
                // 1. Annals of Family Medicine
                new JournalSubmissionCriteria
                {
                    JournalName = "Annals of Family Medicine",
                    Publisher = "Annals",
                    Specialties = new List<string> { "Primary Care", "Family Medicine", "Public Health" },
                    MaxWordCountAbstract = 250,
                    MaxWordCountBody = 2500, // Range 1200-2500 generally
                    MaxFiguresAndTables = 5,
                    MaxReferences = 50, // Often ~30-50 for research
                    RequiresStructuredAbstract = true,
                    RequiredSections = new List<string> { "Introduction", "Methods", "Results", "Discussion", "Conclusion" },
                    CitationStyle = "AMA / ICMJE",
                    SubmissionUrl = "https://annfammed.org",
                    GuidelinesUrl = "https://annfammed.org/authors/"
                },

                // 2. The Lancet
                new JournalSubmissionCriteria
                {
                    JournalName = "The Lancet",
                    Publisher = "Elsevier",
                    Specialties = new List<string> { "General Medicine", "Global Health", "Clinical Research" },
                    MaxWordCountAbstract = 300,
                    MaxWordCountBody = 3500, // 4500 for RCTs
                    MaxFiguresAndTables = 5, // Typically constrained
                    MaxReferences = 30, // Strict on Research Letters, flexible on Articles but ~30 recommended/enforced based on context
                    RequiresStructuredAbstract = true,
                    RequiredSections = new List<string> { "Introduction", "Methods", "Results", "Discussion" }, 
                    CitationStyle = "Vancouver",
                    SubmissionUrl = "https://www.thelancet.com/authors/submit",
                    GuidelinesUrl = "https://www.thelancet.com/lancet/information-for-authors"
                },

                // 3. The BMJ
                new JournalSubmissionCriteria
                {
                    JournalName = "The BMJ",
                    Publisher = "BMJ",
                    Specialties = new List<string> { "General Medicine", "Health Policy", "Clinical Research" },
                    MaxWordCountAbstract = 300,
                    MaxWordCountBody = 4000, 
                    MaxFiguresAndTables = 6,
                    MaxReferences = 50, // Flexible
                    RequiresStructuredAbstract = true,
                    RequiredSections = new List<string> { "Design", "Setting", "Participants", "Interventions", "Outcomes", "Results", "Conclusions" },
                    CitationStyle = "Vancouver",
                    SubmissionUrl = "https://mc.manuscriptcentral.com/bmj",
                    GuidelinesUrl = "https://www.bmj.com/about-bmj/resources-authors"
                },

                // 4. The Lancet Regional Health - Africa
                new JournalSubmissionCriteria
                {
                    JournalName = "The Lancet Regional Health - Africa",
                    Publisher = "Elsevier",
                    Specialties = new List<string> { "General Medicine", "Public Health", "Infectious Disease" },
                    MaxWordCountAbstract = 300,
                    MaxWordCountBody = 3500,
                    MaxFiguresAndTables = 5,
                    MaxReferences = 50,
                    RequiresStructuredAbstract = true,
                    RequiredSections = new List<string> { "Introduction", "Methods", "Results", "Discussion", "Research in Context" },
                    CitationStyle = "Vancouver",
                    SubmissionUrl = "https://www.editorialmanager.com/tlrhafrica",
                    GuidelinesUrl = "https://www.thelancet.com/journals/lanafr/info/author-guidelines"
                },

                // 5. Qualitative Health Research
                new JournalSubmissionCriteria
                {
                    JournalName = "Qualitative Health Research",
                    Publisher = "SAGE",
                    Specialties = new List<string> { "Qualitative Methodology", "Social Sciences", "Health Services" },
                    MaxWordCountAbstract = 150,
                    MaxWordCountBody = 9000, // ~30 pages
                    MaxFiguresAndTables = 10, // Flexible
                    MaxReferences = 100, // No strict limit, usually generous
                    RequiresStructuredAbstract = false,
                    RequiredSections = new List<string> { "Introduction", "Literature Review", "Methods", "Findings", "Discussion", "Conclusion" },
                    CitationStyle = "APA",
                    SubmissionUrl = "https://mc.manuscriptcentral.com/qhr",
                    GuidelinesUrl = "https://journals.sagepub.com/author-instructions/QHR"
                },

                // 6. European Scientific Journal (ESJ)
                new JournalSubmissionCriteria
                {
                    JournalName = "European Scientific Journal",
                    Publisher = "European Scientific Institute",
                    Specialties = new List<string> { "Multidisciplinary", "Social Sciences", "Medical Sciences", "Humanities" },
                    MaxWordCountAbstract = 150, // Approximately
                    MaxWordCountBody = 8000, // 7-20 pages approx
                    MaxFiguresAndTables = 10, // Flexible
                    MaxReferences = 60, 
                    RequiresStructuredAbstract = false,
                    RequiredSections = new List<string> { "Introduction", "Methods", "Results", "Conclusion" },
                    CitationStyle = "APA",
                    SubmissionUrl = "https://eujournal.org/index.php/esj/about/submissions",
                    GuidelinesUrl = "https://eujournal.org/index.php/esj/about/submissions"
                }
            };
        }
    }
}




FILE: \AdRev.Desktop\Services\UserProfile.cs
------------------------------------

using System;

namespace AdRev.Desktop.Services
{
    public class UserProfile
    {
        public string Title { get; set; } = ""; // M. / Mme / Dr / Pr
        public string LastName { get; set; } = "";
        public string Email { get; set; } = "";
        
        public bool IsSet => !string.IsNullOrWhiteSpace(LastName);
    }
}




FILE: \AdRev.Desktop\Services\WordExportService.cs
------------------------------------
using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using DocumentFormat.OpenXml;
using DocumentFormat.OpenXml.Packaging;
using DocumentFormat.OpenXml.Wordprocessing;
using AdRev.Domain.Protocols;
using AdRev.Domain.Models;
using AdRev.Domain.Variables;
using AdRev.Domain.Enums;

namespace AdRev.Desktop.Services
{
    public class WordExportService
    {
        private const string MainFont = "Times New Roman";
        private const string FontSize = "24"; // 12pt * 2
        private const string LineSpacing = "360"; // 1.5 * 240

        public void ExportProtocolToWord(ResearchProtocol protocol, string filePath)
        {
            CreateWordDocument(filePath, (body) =>
            {
                AddMainTitle(body, "PROTOCOLE DE RECHERCHE");
                AddParagraph(body, $"Titre : {protocol.Title}", true);
                
                if (protocol.PrincipalAuthor != null)
                {
                    AddParagraph(body, $"Auteur Principal : {protocol.PrincipalAuthor.FirstName} {protocol.PrincipalAuthor.LastName}");
                    AddParagraph(body, $"Institution : {protocol.PrincipalAuthor.Institution}");
                }
                AddParagraph(body, "--------------------------------------------------");

                AddHeading(body, "1. INTRODUCTION ET PROBL√âMATIQUE");
                AddParagraph(body, protocol.Context);
                AddParagraph(body, protocol.ProblemJustification);

                AddHeading(body, "2. OBJECTIFS");
                AddParagraph(body, $"Objectif G√©n√©ral : {protocol.GeneralObjective}", true);
                AddParagraph(body, "Objectifs Sp√©cifiques :");
                AddParagraph(body, protocol.SpecificObjectives);

                AddHeading(body, "3. M√âTHODOLOGIE");
                AddParagraph(body, $"Type d'√©tude : {protocol.StudyType}");
                AddParagraph(body, $"Cadre : {protocol.StudySetting}");
                AddParagraph(body, $"Population : {protocol.StudyPopulation}");
                AddParagraph(body, protocol.InclusionCriteria);
                AddParagraph(body, protocol.ExclusionCriteria);
                AddParagraph(body, protocol.SamplingMethod);
                AddParagraph(body, protocol.DataCollection);
                AddParagraph(body, protocol.DataAnalysis);
                AddParagraph(body, protocol.Ethics);

                AddHeading(body, "4. DISCUSSION ET CONCLUSION");
                AddParagraph(body, protocol.StudyLimitations);
                AddParagraph(body, protocol.Conclusion);

                if (!string.IsNullOrWhiteSpace(protocol.References))
                {
                    AddPageBreak(body);
                    AddHeading(body, "R√âF√âRENCES BIBLIOGRAPHIQUES");
                    AddParagraph(body, protocol.References);
                }
            });
        }

        public void ExportGlobalReport(ResearchProject project, string filePath)
        {
            CreateWordDocument(filePath, (body) =>
            {
                // TITLE PAGE
                string titlePrefix = project.AcademicLevel switch
                {
                    AcademicLevel.Thesis => "TH√àSE DE DOCTORAT",
                    AcademicLevel.MasterMemoir => "M√âMOIRE DE MASTER",
                    AcademicLevel.ScientificArticle => "MANUSCRIT D'ARTICLE",
                    AcademicLevel.NGOReport => "RAPPORT D'IMPACT / HUMANITAIRE",
                    _ => "RAPPORT D'√âTUDE"
                };
                
                if (!string.IsNullOrEmpty(project.TargetJournalName) && project.AcademicLevel == AcademicLevel.ScientificArticle)
                {
                    titlePrefix += $"\n(Cible : {project.TargetJournalName})";
                }

                AddMainTitle(body, titlePrefix);
                AddParagraph(body, $"Titre : {project.Title}", true);
                AddParagraph(body, $"Auteur(s) : {project.Authors}");
                AddParagraph(body, $"Institution : {project.Institution}");
                AddParagraph(body, "--------------------------------------------------");

                // SECTION 0: EXECUTIVE SUMMARY (NGO ONLY)
                if (project.AcademicLevel == AcademicLevel.NGOReport)
                {
                    AddHeading(body, "R√âSUM√â EX√âCUTIF");
                    AddParagraph(body, "Synth√®se des points cl√©s et de l'impact (√† compl√©ter).", true);
                    AddParagraph(body, project.ConclusionContent); // Use conclusion as base for summary
                    AddPageBreak(body);
                }

                // SECTION 1: PROTOCOLE (SYNTH√àSE) -> INTRODUCTION & METHODOLOGIE IMRAD
                AddHeading(body, "I. CONTEXTE ET M√âTHODOLOGIE (IMRAD)");
                AddParagraph(body, "Introduction (Probl√©matique & Justification) :", true);
                AddParagraph(body, project.ProblemJustification ?? "Voir section Protocole"); 
                AddParagraph(body, $"Objectif G√©n√©ral : {project.GeneralObjective}");
                
                AddParagraph(body, "M√©thodologie d√©taill√©e :", true);
                AddParagraph(body, $"Type d'√©tude : {project.StudyType}");
                AddParagraph(body, project.DataAnalysisPlan);

                // SECTION 2: R√âSULTATS
                AddHeading(body, "II. R√âSULTATS");
                AddParagraph(body, "Pr√©sentation des donn√©es (Tableaux et Figures annuaels).");

                // SECTION 3: DISCUSSION
                AddHeading(body, "III. DISCUSSION");
                AddParagraph(body, project.DiscussionContent);
                AddParagraph(body, "Limites m√©thodologiques :", true);
                AddParagraph(body, project.LimitationsContent);

                // SECTION 5: CONCLUSION & RECOMMANDATIONS
                AddHeading(body, "V. CONCLUSION ET RECOMMANDATIONS");
                if (project.AcademicLevel == AcademicLevel.NGOReport)
                {
                     AddParagraph(body, "RECOMMANDATIONS OP√âRATIONNELLES", true);
                }
                AddParagraph(body, project.ConclusionContent);

                AddPageBreak(body);

                // SECTION 6: R√âF√âRENCES
                AddHeading(body, "VI. R√âF√âRENCES BIBLIOGRAPHIQUES");
                if (project.References != null && project.References.Any())
                {
                    foreach (var r in project.References.OrderBy(x => x.FormattedString))
                    {
                        AddParagraph(body, $"‚Ä¢ {r.FormattedString}");
                    }
                }
                else
                {
                    AddParagraph(body, "Aucune r√©f√©rence cit√©e.");
                }
            });
        }

        public void ExportVariableSheetToWord(ResearchProtocol protocol, string filePath)
        {
            CreateWordDocument(filePath, (body) =>
            {
                AddMainTitle(body, "FICHE DE CONCEPTION DE VARIABLE / CAHIER D'OBSERVATION");
                AddParagraph(body, $"Projet : {protocol.Title}", true);
                AddParagraph(body, "--------------------------------------------------");

                if (protocol.Variables == null || !protocol.Variables.Any())
                {
                    AddParagraph(body, "Aucune variable d√©finie.");
                    return;
                }

                var groups = protocol.Variables.GroupBy(v => string.IsNullOrWhiteSpace(v.GroupName) ? "G√âN√âRAL" : v.GroupName);
                foreach (var group in groups)
                {
                    AddHeading(body, $"SECTION : {group.Key.ToUpper()}");
                    foreach (var v in group)
                    {
                        string req = v.IsRequired ? " (*)" : "";
                        AddParagraph(body, $"{v.Prompt}{req}", true);
                        AddParagraph(body, $"   Type : {v.Type} | Nom : {v.Name}");
                        if (!string.IsNullOrEmpty(v.ChoiceOptions))
                            AddParagraph(body, $"   Options : {v.ChoiceOptions}");
                        AddParagraph(body, ""); // Spacer
                    }
                }
            });
        }

        private void CreateWordDocument(string filePath, Action<Body> populateAction)
        {
            using (WordprocessingDocument wordDocument = WordprocessingDocument.Create(filePath, WordprocessingDocumentType.Document))
            {
                MainDocumentPart mainPart = wordDocument.AddMainDocumentPart();
                mainPart.Document = new Document();
                Body body = mainPart.Document.AppendChild(new Body());

                populateAction(body);

                mainPart.Document.Save();
            }
        }

        private void AddMainTitle(Body body, string text)
        {
            Paragraph para = body.AppendChild(new Paragraph());
            ParagraphProperties pp = para.AppendChild(new ParagraphProperties(
                new Justification() { Val = JustificationValues.Center },
                new SpacingBetweenLines() { After = "480", Line = "360", LineRule = LineSpacingRuleValues.Auto }
                ));

            Run run = para.AppendChild(new Run());
            RunProperties rp = run.AppendChild(new RunProperties(
                new RunFonts() { Ascii = MainFont, HighAnsi = MainFont },
                new FontSize() { Val = "32" }, // 16pt
                new Bold()
                ));
            run.AppendChild(new Text(text ?? ""));
        }

        private void AddHeading(Body body, string text)
        {
            Paragraph para = body.AppendChild(new Paragraph());
            ParagraphProperties pp = para.AppendChild(new ParagraphProperties(
                new SpacingBetweenLines() { Before = "240", After = "120", Line = LineSpacing, LineRule = LineSpacingRuleValues.Auto }
                ));

            Run run = para.AppendChild(new Run());
            RunProperties rp = run.AppendChild(new RunProperties(
                new RunFonts() { Ascii = MainFont, HighAnsi = MainFont },
                new FontSize() { Val = "28" }, // 14pt
                new Bold()
                ));
            run.AppendChild(new Text(text ?? ""));
        }

        private void AddParagraph(Body body, string? text, bool bold = false)
        {
            if (string.IsNullOrEmpty(text)) return;

            string[] lines = text.Split(new[] { "\r\n", "\r", "\n" }, StringSplitOptions.None);
            foreach (var line in lines)
            {
                Paragraph para = body.AppendChild(new Paragraph());
                ParagraphProperties pp = para.AppendChild(new ParagraphProperties(
                    new SpacingBetweenLines() { Line = LineSpacing, LineRule = LineSpacingRuleValues.Auto },
                    new Justification() { Val = JustificationValues.Both }
                    ));

                Run run = para.AppendChild(new Run());
                RunProperties rp = run.AppendChild(new RunProperties(
                    new RunFonts() { Ascii = MainFont, HighAnsi = MainFont },
                    new FontSize() { Val = FontSize }
                    ));

                if (bold) rp.AppendChild(new Bold());
                
                run.AppendChild(new Text(line));
            }
        }

        private void AddPageBreak(Body body)
        {
            body.AppendChild(new Paragraph(new Run(new Break() { Type = BreakValues.Page })));
        }
    }
}




FILE: \AdRev.Desktop\Services\WritingAssistantService.cs
------------------------------------
using AdRev.Domain.Enums;
using AdRev.Domain.Models;
using System.Linq;

namespace AdRev.Desktop.Services
{
    public class WritingAssistantService
    {
        public class WritingTip
        {
            public string Title { get; set; } = string.Empty;
            public string Content { get; set; } = string.Empty;
            public string TenseHelp { get; set; } = string.Empty;
        }

        public static WritingTip GetTipForSection(string sectionName, AcademicLevel level, StudyType studyType, JournalSubmissionCriteria? journal = null)
        {
            var tip = new WritingTip();

            switch (sectionName.ToLower())
            {
                case "introduction":
                    tip.Title = "Logique de l'Introduction";
                    tip.Content = level == AcademicLevel.NGOReport 
                        ? "Concentrez-vous sur le contexte humanitaire/social et l'urgence de l'intervention."
                        : "Partez du contexte global vers votre probl√©matique sp√©cifique (Entonnoir).";
                    tip.TenseHelp = "Pr√©sent (faits √©tablis) et Pass√© Compos√© (√©tudes ant√©rieures).";
                    break;

                case "methodologie":
                    tip.Title = "Rigueur et Transparence";
                    string checklist = studyType == StudyType.Quantitative ? "STROBE (Obs.) ou CONSORT (Essais)" : "COREQ (Qualitatif)";
                    tip.Content = $"Assurez-vous de couvrir les crit√®res {checklist}. D√©crivez ce qui A √âT√â fait.";
                    tip.TenseHelp = "IMP√âRATIF : Passez du Futur au Pass√© Simple/Imparfait.";
                    
                    if (journal != null && journal.RequiredSections.Contains("Methods"))
                         tip.Content += $" Note : {journal.JournalName} exige une description pr√©cise des analyses statistiques.";
                    break;

                case "resultats":
                    tip.Title = "R√©sultats - Faits Bruts";
                    tip.Content = level == AcademicLevel.NGOReport
                        ? "Mettez en avant les indicateurs cl√©s de performance et l'impact direct."
                        : "Pr√©sentez les faits sans interpr√©tation. Utilisez Tableaux/Figures.";
                    tip.TenseHelp = "Pass√© Simple ou Pass√© Compos√© exclusif.";
                    break;

                case "discussion":
                    tip.Title = "Discussion et Contextualisation";
                    tip.Content = "Comparez vos r√©sultats √† la litt√©rature. Expliquez les limites.";
                    tip.TenseHelp = "M√©lange : Pass√© (vos r√©sultats) et Pr√©sent (litt√©rature).";
                    break;

                case "conclusion":
                    tip.Title = "Conclusion et Recommandations";
                    tip.Content = level == AcademicLevel.NGOReport
                        ? "Proposez des actions concr√®tes et op√©rationnelles pour le terrain."
                        : "Synth√®se de l'apport th√©orique et ouverture.";
                    tip.TenseHelp = "Pr√©sent (conclusion) et Conditionnel (recommandations).";
                    break;

                default:
                    tip.Title = "Conseil G√©n√©ral";
                    tip.Content = "Soyez clair, pr√©cis et concis.";
                    break;
            }

            // Journal Specific Constraints
            if (journal != null)
            {
                if (sectionName.ToLower() == "abstract" || sectionName.ToLower() == "resume")
                {
                    tip.Content += $"\n\nCONTRAINTE REVUE : Max {journal.MaxWordCountAbstract} mots.";
                }
            }

            return tip;
        }

        public static string SuggestPastTense(string futureVerb)
        {
            // Simple mapping for common research verbs
            var mapping = new Dictionary<string, string>
            {
                { "inclura", "a inclus / inclut" },
                { "collectera", "a collect√© / collecta" },
                { "analysera", "a analys√© / analysa" },
                { "√©valuera", "a √©valu√© / √©valua" },
                { "mesurera", "a mesur√© / mesura" },
                { "recrutera", "a recrut√© / recruta" },
                { "distribuera", "a distribu√© / distribua" }
            };

            return mapping.ContainsKey(futureVerb.ToLower()) ? mapping[futureVerb.ToLower()] : "V√©rifiez la concordance des temps (Pass√© Simple/Compos√©)";
        }
    }
}




FILE: \AdRev.Desktop\Views\Project\AnalysisView.xaml
------------------------------------
<UserControl x:Class="AdRev.Desktop.Views.Project.AnalysisView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:AdRev.Desktop"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1200">
    <TabControl BorderThickness="0" Background="Transparent" Padding="0">
        <!-- QUANTITATIVE ANALYSIS -->
        <TabItem Header="Analyse Quantitative">
            <Grid Background="#F5F7F8">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="300"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Sidebar: Plan d'Analyse -->
                <Grid Background="White">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <Border BorderBrush="#E0E0E0" BorderThickness="0,0,1,0" Grid.RowSpan="4"/>

                    <StackPanel Grid.Row="0">
                        <Grid Margin="15,15,15,10">
                             <TextBlock Text="Plan d'Analyse" FontSize="16" FontWeight="Bold" Foreground="{StaticResource PrimaryBrush}" VerticalAlignment="Center"/>
                        </Grid>
                    </StackPanel>

                    <StackPanel Grid.Row="1" Margin="20,0,20,10">
                        <TextBlock Text="Source de Donn√©es" Style="{StaticResource LabelStyle}"/>
                        <Button Click="ImportData_Click" Height="35" Margin="0,5,0,5" Background="White" BorderBrush="#DDD" BorderThickness="1" Cursor="Hand">
                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                <TextBlock Text="&#xE8E5;" FontFamily="Segoe MDL2 Assets" Margin="0,0,8,0" VerticalAlignment="Center" Foreground="{StaticResource PrimaryBrush}" FontSize="14"/>
                                <TextBlock Text="Importer Fichier" VerticalAlignment="Center" FontWeight="SemiBold" Foreground="#444"/>
                            </StackPanel>
                        </Button>
                        <TextBlock x:Name="ActiveDataSourceText" Text="Aucune donn√©e charg√©e" FontSize="11" Foreground="#888" TextTrimming="CharacterEllipsis"/>
                    </StackPanel>

                    <Expander Grid.Row="2" Style="{StaticResource ScientificExpanderStyle}" Header="Plan d'Analyse D√©fini" Tag="#EDE7F6" Foreground="#4527A0" Margin="15,0,15,10" IsExpanded="True">
                         <ScrollViewer VerticalScrollBarVisibility="Auto">
                             <ItemsControl x:Name="PlanItemsList">
                                 <!-- DataTemplate from original code -->
                             </ItemsControl>
                         </ScrollViewer>
                    </Expander>

                    <Expander Grid.Row="3" Header="Ajouter une Analyse" Style="{StaticResource ScientificExpanderStyle}" Tag="#F5F5F5">
                        <Border Padding="15">
                            <StackPanel>
                                <TextBlock Text="Titre" Style="{StaticResource LabelStyle}"/>
                                <TextBox x:Name="PlanTitleBox" Height="30" Margin="0,0,0,10"/>
                                <TextBlock Text="Test" Style="{StaticResource LabelStyle}"/>
                                <ComboBox x:Name="PlanTestTypeCombo" Height="30" Margin="0,0,0,10"/>
                                <Button Content="Ajouter" Click="AddToPlan_Click" Height="35"/>
                            </StackPanel>
                        </Border>
                    </Expander>
                </Grid>
                
                <!-- Main Preview Area -->
                <Grid Grid.Column="1" Background="#F3F4F6">
                    <FlowDocumentScrollViewer x:Name="AnalysisDocViewer" VerticalScrollBarVisibility="Auto">
                        <FlowDocument x:Name="AnalysisDoc" PagePadding="60" Background="White" ColumnWidth="2000" FontFamily="Times New Roman" FontSize="12">
                            <Paragraph TextAlignment="Center" Margin="0,0,0,30">
                                <Run Text="Rapport d'Analyse Statistique" FontSize="20" FontWeight="Bold" Foreground="#2c3e50"/>
                            </Paragraph>
                            <Paragraph>
                                <Run Text="Effectuez une analyse pour voir les r√©sultats." FontStyle="Italic" Foreground="Gray"/>
                            </Paragraph>
                        </FlowDocument>
                    </FlowDocumentScrollViewer>
                </Grid>
            </Grid>
        </TabItem>

        <!-- QUALITATIVE ANALYSIS -->
        <TabItem Header="Analyse Qualitative">
            <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="20">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <TextBlock Text="Tableau de Bord Analyse Qualitative" FontSize="24" FontWeight="Bold" Foreground="{StaticResource PrimaryBrush}" Margin="0,0,0,20"/>

                    <Grid Grid.Row="1" Margin="0,0,0,20">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        
                        <Border Style="{StaticResource CardStyle}" Margin="0,0,10,0">
                            <StackPanel>
                                <TextBlock Text="0" FontSize="32" FontWeight="Bold" Foreground="{StaticResource SecondaryBrush}" x:Name="TxtVerbatimCount"/>
                                <TextBlock Text="Verbatims Analys√©s" Foreground="#888"/>
                            </StackPanel>
                        </Border>
                        <Border Grid.Column="1" Style="{StaticResource CardStyle}" Margin="5,0,5,0">
                            <StackPanel>
                                <TextBlock Text="0" FontSize="32" FontWeight="Bold" Foreground="#E65100" x:Name="TxtCodeCount"/>
                                <TextBlock Text="Codes" Foreground="#888"/>
                            </StackPanel>
                        </Border>
                    </Grid>

                    <Grid Grid.Row="2">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="2*"/>
                            <ColumnDefinition Width="1*"/>
                        </Grid.ColumnDefinitions>
                        <Border Grid.Column="0" Style="{StaticResource CardStyle}" Height="300" Margin="0,0,15,0">
                             <Canvas x:Name="WordCloudCanvas">
                                 <TextBlock Text="Initialisation du nuage..." Canvas.Left="20" Canvas.Top="20"/>
                             </Canvas>
                        </Border>
                        <Border Grid.Column="1" Style="{StaticResource CardStyle}">
                            <StackPanel>
                                <TextBlock Text="Fr√©quence des Codes" FontWeight="Bold" Margin="0,0,0,10"/>
                                <ListBox x:Name="CodeFreqListBox" BorderThickness="0"/>
                            </StackPanel>
                        </Border>
                    </Grid>
                </Grid>
            </ScrollViewer>
        </TabItem>
    </TabControl>
</UserControl>




FILE: \AdRev.Desktop\Views\Project\AnalysisView.xaml.cs
------------------------------------
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Documents;
using System.Windows.Media;
using AdRev.Domain.Models;
using AdRev.Domain.Variables;
using AdRev.Domain.Enums;
using AdRev.Core.Services;
using Microsoft.Win32;

namespace AdRev.Desktop.Views.Project
{
    public partial class AnalysisView : UserControl
    {
        private ResearchProject? _project;
        private ObservableCollection<AnalysisPlanItem> _analysisPlan = new ObservableCollection<AnalysisPlanItem>();
        private List<Dictionary<string, object>> _projectData = new List<Dictionary<string, object>>();
        private ObservableCollection<StudyVariable> _importedVariables = new ObservableCollection<StudyVariable>();
        private StatisticsService _statsService = new StatisticsService();

        public AnalysisView()
        {
            InitializeComponent();
            PlanItemsList.ItemsSource = _analysisPlan;
            
            // Populate Test Types
            PlanTestTypeCombo.Items.Add(new ComboBoxItem { Content = "Description Simple", Tag = "Descriptif" });
            PlanTestTypeCombo.Items.Add(new ComboBoxItem { Content = "Comparaison de Moyennes (T-Test)", Tag = "Comparaison" });
            PlanTestTypeCombo.Items.Add(new ComboBoxItem { Content = "Test d'Association (Chi2)", Tag = "Association" });
            PlanTestTypeCombo.SelectedIndex = 0;
        }

        public void LoadProject(ResearchProject project)
        {
            _project = project;
            // Load plan from project if we add it to the model later
            // For now, it's local to the view
            UpdateAnalysisVariables();
        }

        private void UpdateAnalysisVariables()
        {
            // Update UI with available variables
            // In a real app, populate some variable selection combos
        }

        private void ImportData_Click(object sender, RoutedEventArgs e)
        {
            var openFileDialog = new OpenFileDialog { Filter = "CSV files (*.csv)|*.csv|All files (*.*)|*.*" };
            if (openFileDialog.ShowDialog() == true)
            {
                // Simple CSV parsing (mock)
                ActiveDataSourceText.Text = System.IO.Path.GetFileName(openFileDialog.FileName);
                _projectData = new List<Dictionary<string, object>>(); 
                // In a real app, use a proper CSV service
                 MessageBox.Show("Donn√©es import√©es avec succ√®s (Simulation).", "Importation");
            }
        }

        private void AddToPlan_Click(object sender, RoutedEventArgs e)
        {
            if (string.IsNullOrWhiteSpace(PlanTitleBox.Text)) return;

            var selectedType = PlanTestTypeCombo.SelectedItem as ComboBoxItem;
            if (selectedType == null) return;

            var newItem = new AnalysisPlanItem
            {
                Title = PlanTitleBox.Text,
                TestType = selectedType.Content?.ToString() ?? "N/A",
                Description = $"G√©n√©r√© le {DateTime.Now:dd/MM/yyyy}"
            };

            _analysisPlan.Add(newItem);
            PlanTitleBox.Text = string.Empty;
        }

        private void RunPlanItem_Click(object sender, RoutedEventArgs e)
        {
            if (sender is Button btn && btn.Tag is AnalysisPlanItem item)
            {
                ExecuteAnalysis(item);
            }
        }

        private void ExecuteAnalysis(AnalysisPlanItem item)
        {
            AnalysisDoc.Blocks.Clear();
            
            // Header
            AnalysisDoc.Blocks.Add(new Paragraph(new Run(item.Title)) { FontSize = 18, FontWeight = FontWeights.Bold, Foreground = Brushes.Navy, TextAlignment = TextAlignment.Center });
            AnalysisDoc.Blocks.Add(new Paragraph(new Run($"Test: {item.TestType} | Date: {DateTime.Now}")) { FontSize = 10, Foreground = Brushes.Gray, TextAlignment = TextAlignment.Center });

            if (_projectData.Count == 0)
            {
                AnalysisDoc.Blocks.Add(new Paragraph(new Run("Veuillez d'abord importer des donn√©es.")) { Foreground = Brushes.Orange, Margin = new Thickness(0, 20, 0, 0) });
                return;
            }

            // Mock rendering
            AnalysisDoc.Blocks.Add(new Paragraph(new Run("R√©sultats de l'analyse (Simul√©s pour la d√©mo)")) { Margin = new Thickness(0, 20, 0, 10), FontWeight = FontWeights.Bold });
            AnalysisDoc.Blocks.Add(new Paragraph(new Run("‚Ä¢ Population totale : " + _projectData.Count)));
            AnalysisDoc.Blocks.Add(new Paragraph(new Run("‚Ä¢ Test effectu√© avec succ√®s.")));
            
            item.IsExecuted = true;
            item.ResultSummary = "Ex√©cut√©";
        }

        private void GenerateSmartPlan_Click(object sender, RoutedEventArgs e)
        {
            // Simple logic from MainWindow
            _analysisPlan.Add(new AnalysisPlanItem { Title = "Description de l'√©chantillon", TestType = "Descriptif" });
            MessageBox.Show("Plan intelligent g√©n√©r√©.", "Succ√®s");
        }
    }
}




FILE: \AdRev.Desktop\Views\Project\DataEntryView.xaml
------------------------------------
<UserControl x:Class="AdRev.Desktop.Views.Project.DataEntryView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:AdRev.Desktop"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1200">
    <Grid Background="White">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="320"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto" MaxWidth="400"/>
        </Grid.ColumnDefinitions>

        <!-- Sidebar: Records List -->
        <Border BorderBrush="#E0E0E0" BorderThickness="0,0,1,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/> <!-- Header -->
                    <RowDefinition Height="Auto"/> <!-- Search -->
                    <RowDefinition Height="*"/>    <!-- List -->
                    <RowDefinition Height="Auto"/> <!-- Footer -->
                </Grid.RowDefinitions>
                
                <Border Padding="20,15" Background="#F8F9FA" BorderBrush="#EEE" BorderThickness="0,0,0,1">
                    <StackPanel>
                        <TextBlock Text="üìÅ Base de Donn√©es" FontWeight="Bold" FontSize="16" Foreground="#1976D2"/>
                        <TextBlock Text="Gestion des entr√©es" FontSize="11" Foreground="Gray"/>
                    </StackPanel>
                </Border>

                <Border Grid.Row="1" Padding="15">
                    <StackPanel>
                        <Button x:Name="BtnNewRecord" Click="BtnNewRecord_Click" Background="#E3F2FD" BorderBrush="#2196F3" Foreground="#1976D2" Height="40" Cursor="Hand">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="+" FontSize="18" FontWeight="Bold" Margin="0,-2,8,0"/>
                                <TextBlock Text="Nouveau Record" FontWeight="SemiBold"/>
                            </StackPanel>
                        </Button>
                        
                        <Border Margin="0,15,0,0" CornerRadius="4" BorderBrush="#DDD" BorderThickness="1" Background="#FAFAFA">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="üîç" VerticalAlignment="Center" Margin="8,0,5,0" Foreground="Gray"/>
                                <TextBox x:Name="TxtSearchRecords" Grid.Column="1" BorderThickness="0" Background="Transparent" Padding="5" Tag="Rechercher..." TextChanged="TxtSearchRecords_TextChanged"/>
                            </Grid>
                        </Border>
                    </StackPanel>
                </Border>

                <ListBox x:Name="RecordsListBox" Grid.Row="2" BorderThickness="0" Background="Transparent" Padding="5" SelectionChanged="RecordsListBox_SelectionChanged">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border Padding="12,10" Background="White" BorderBrush="#EEE" BorderThickness="1" CornerRadius="4" Margin="0,0,0,5">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Ellipse Width="35" Height="35" Fill="#E3F2FD" Margin="0,0,12,0" VerticalAlignment="Center"/>
                                    <TextBlock Text="üìÑ" VerticalAlignment="Center" HorizontalAlignment="Center" Margin="-47,0,12,0" Foreground="#1976D2" FontSize="16"/>
                                    
                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <TextBlock Text="{Binding RecordName}" FontWeight="Bold" FontSize="13" Foreground="#333"/>
                                        <TextBlock Text="{Binding Timestamp}" FontSize="10" Foreground="Gray"/>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>

                <Border Grid.Row="3" Padding="10" Background="#F5F5F5" BorderBrush="#EEE" BorderThickness="0,1,0,0">
                    <TextBlock x:Name="TxtRecordCount" Text="0 entr√©e(s) enregistr√©e(s)" FontSize="10" Foreground="Gray" HorizontalAlignment="Center"/>
                </Border>
            </Grid>
        </Border>

        <!-- Main Content: Form -->
        <Grid Grid.Column="1">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <Border Background="White" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1" Padding="20,10">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="üè∑Ô∏è Nom de l'enregistrement :" VerticalAlignment="Center" Margin="0,0,10,0" FontWeight="SemiBold" Foreground="#555"/>
                        <TextBox x:Name="TxtRecordName" Width="250" Padding="8,5" BorderBrush="#DDD" VerticalAlignment="Center" Tag="Ex: Patient_001, Site_A_Obs_1"/>
                    </StackPanel>

                    <StackPanel Grid.Column="2" Orientation="Horizontal">
                        <Button Content="üìê Concepteur" Click="OpenVariableDesigner_Click" Margin="0,0,10,0" Padding="15,5" Background="White" BorderBrush="#2196F3" Foreground="#2196F3" FontWeight="SemiBold"/>
                        <Button x:Name="BtnSaveRecordActual" Content="üíæ Sauvegarder l'entr√©e" Click="BtnSaveRecord_Click" Padding="20,8" Background="#2196F3" Foreground="White" BorderThickness="0" FontWeight="Bold"/>
                    </StackPanel>
                </Grid>
            </Border>

            <Expander Grid.Row="1" Style="{StaticResource ScientificExpanderStyle}" Header="Formulaire de Saisie" Tag="#E8EAF6" Foreground="#1A237E" IsExpanded="True" Margin="20">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="10">
                    <StackPanel x:Name="DataEntryFormPanel" MaxWidth="800" HorizontalAlignment="Left">
                        <TextBlock Text="Veuillez d√©finir les variables dans le 'Concepteur de Variables' pour g√©n√©rer le formulaire." Foreground="#888" FontStyle="Italic"/>
                    </StackPanel>
                </ScrollViewer>
            </Expander>
        </Grid>

        <!-- Map Panel -->
        <Border x:Name="MapPanel" Grid.Column="2" Background="White" BorderBrush="#E0E0E0" BorderThickness="1,0,0,0" Visibility="Collapsed" Width="300">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                <Border Padding="10" Background="#F8F9FA" BorderBrush="#EEE" BorderThickness="0,0,0,1">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="üìç Localisation" FontWeight="Bold" VerticalAlignment="Center"/>
                        <Button Content="Fermer" Click="CloseDataEntryMap_Click" Margin="10,0,0,0" Padding="5,2" FontSize="10"/>
                    </StackPanel>
                </Border>
                <WebBrowser x:Name="MapBrowserDataEntry" Grid.Row="1"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>




FILE: \AdRev.Desktop\Views\Project\DataEntryView.xaml.cs
------------------------------------
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.RegularExpressions;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media;
using System.Runtime.InteropServices;
using AdRev.Domain.Enums;
using AdRev.Domain.Variables;
using AdRev.Domain.Models;
using Microsoft.Win32;

namespace AdRev.Desktop.Views.Project
{
    public partial class DataEntryView : UserControl
    {
        [DllImport("winmm.dll")]
        private static extern long record(string command, string returnString, int returnLength, int hwndCallback);

        private ResearchProject? _project;
        private bool _isRecording = false;
        private System.Windows.Threading.DispatcherTimer? _recordingTimer;
        private DateTime _recordingStartTime;
        private TextBlock? _recordingStatusText;
        private TextBlock? _recordingTimerText;

        public DataEntryView()
        {
            InitializeComponent();
        }

        public void LoadProject(ResearchProject project)
        {
            _project = project;
            GenerateDataEntryForm();
            LoadRecords();
        }

        private void LoadRecords()
        {
            RecordsListBox.Items.Clear();
            // In a real app, load from project data
            TxtRecordCount.Text = "0 entr√©e(s) enregistr√©e(s)";
        }

        private void GenerateDataEntryForm()
        {
            DataEntryFormPanel.Children.Clear();

            if (_project != null && (_project.StudyType == StudyType.Qualitative || _project.StudyType == StudyType.Mixed))
            {
                RenderAudioRecorder();
            }

            if (_project == null || _project.Variables.Count == 0)
            {
                DataEntryFormPanel.Children.Add(new TextBlock 
                { 
                    Text = "Aucune variable d√©finie. Utilisez le 'Concepteur de Variables' pour cr√©er votre formulaire.",
                    Foreground = Brushes.Gray,
                    FontStyle = FontStyles.Italic
                });
                return;
            }

            var groups = _project.Variables.GroupBy(v => v.GroupName);

            foreach (var group in groups)
            {
                var groupBorder = new Border {
                    Background = new SolidColorBrush(Color.FromRgb(245, 247, 249)),
                    Padding = new Thickness(15, 10, 15, 10),
                    Margin = new Thickness(0, 15, 0, 15),
                    CornerRadius = new CornerRadius(6),
                    BorderBrush = new SolidColorBrush(Color.FromRgb(224, 230, 237)),
                    BorderThickness = new Thickness(1)
                };
                
                groupBorder.Child = new TextBlock { 
                    Text = string.IsNullOrWhiteSpace(group.Key) ? "Informations G√©n√©rales" : group.Key, 
                    FontWeight = FontWeights.Bold, 
                    Foreground = new SolidColorBrush(Color.FromRgb(30, 136, 229)),
                    FontSize = 14
                };
                
                DataEntryFormPanel.Children.Add(groupBorder);

                foreach (var variable in group)
                {
                    var fieldPanel = new StackPanel { Margin = new Thickness(10, 0, 0, 20) };
                    var labelText = variable.Prompt;
                    if (variable.IsRequired) labelText += " *";
                    
                    var label = new TextBlock
                    {
                        Text = labelText,
                        FontWeight = FontWeights.SemiBold,
                        Foreground = new SolidColorBrush(Color.FromRgb(55, 71, 79)),
                        Margin = new Thickness(0, 0, 0, 5),
                        FontSize = 13
                    };
                    fieldPanel.Children.Add(label);

                    UIElement? inputControl = null;
                    switch (variable.Type)
                    {
                        case VariableType.Text:
                            inputControl = new TextBox { Padding = new Thickness(5), Height = 30 };
                            break;
                        case VariableType.Memo:
                            inputControl = new TextBox { Padding = new Thickness(5), Height = 80, TextWrapping = TextWrapping.Wrap, AcceptsReturn = true };
                            break;
                        case VariableType.QualitativeBinary:
                            var spYesNo = new StackPanel { Orientation = Orientation.Horizontal };
                            spYesNo.Children.Add(new RadioButton { Content = "Oui", Margin = new Thickness(0,0,15,0) });
                            spYesNo.Children.Add(new RadioButton { Content = "Non" });
                            inputControl = spYesNo;
                            break;
                        // Add more cases from the original code
                        default:
                            inputControl = new TextBox { Height = 30 };
                            break;
                    }
                    
                    if (inputControl != null)
                        fieldPanel.Children.Add(inputControl);

                    DataEntryFormPanel.Children.Add(fieldPanel);
                }
            }
        }

        private void RenderAudioRecorder()
        {
            var recorderBorder = new Border
            {
                Background = new SolidColorBrush(Color.FromRgb(255, 243, 224)),
                BorderBrush = new SolidColorBrush(Color.FromRgb(255, 152, 0)),
                BorderThickness = new Thickness(1),
                CornerRadius = new CornerRadius(8),
                Padding = new Thickness(15),
                Margin = new Thickness(0, 0, 0, 20)
            };

            var grid = new Grid();
            grid.RowDefinitions.Add(new RowDefinition { Height = GridLength.Auto });
            grid.RowDefinitions.Add(new RowDefinition { Height = GridLength.Auto });

            var headerStack = new StackPanel { Orientation = Orientation.Horizontal, Margin = new Thickness(0, 0, 0, 15) };
            headerStack.Children.Add(new TextBlock { Text = "üéôÔ∏è", FontSize = 24, Margin = new Thickness(0, 0, 10, 0) });
            var titleStack = new StackPanel();
            titleStack.Children.Add(new TextBlock { Text = "Dictaphone Num√©rique", FontWeight = FontWeights.Bold, FontSize = 16, Foreground = new SolidColorBrush(Color.FromRgb(230, 81, 0)) });
            headerStack.Children.Add(titleStack);
            grid.Children.Add(headerStack);

            var controlsStack = new StackPanel { Orientation = Orientation.Horizontal, HorizontalAlignment = HorizontalAlignment.Center };
            Grid.SetRow(controlsStack, 1);
            
            var btnRecord = new Button { Content = "Enregistrer", Padding = new Thickness(15, 8, 15, 8) };
            _recordingStatusText = new TextBlock { Text = "Pr√™t", VerticalAlignment = VerticalAlignment.Center, Margin = new Thickness(10,0,0,0) };
            _recordingTimerText = new TextBlock { Text = "00:00", VerticalAlignment = VerticalAlignment.Center, Visibility = Visibility.Collapsed, Margin = new Thickness(10,0,0,0) };

            btnRecord.Click += (s, e) => ToggleRecording(btnRecord);

            controlsStack.Children.Add(btnRecord);
            controlsStack.Children.Add(_recordingStatusText);
            controlsStack.Children.Add(_recordingTimerText);

            grid.Children.Add(controlsStack);
            recorderBorder.Child = grid;

            DataEntryFormPanel.Children.Add(recorderBorder);
        }

        private void ToggleRecording(Button btn)
        {
            if (!_isRecording)
            {
                record("open new type waveaudio alias recsound", "", 0, 0);
                record("record recsound", "", 0, 0);
                _isRecording = true;
                _recordingStartTime = DateTime.Now;
                btn.Content = "Arr√™ter & Sauvegarder";
                _recordingStatusText!.Text = "Enregistrement...";
                _recordingTimerText!.Visibility = Visibility.Visible;
                
                if (_recordingTimer == null)
                {
                    _recordingTimer = new System.Windows.Threading.DispatcherTimer();
                    _recordingTimer.Interval = TimeSpan.FromSeconds(1);
                    _recordingTimer.Tick += (s, args) => {
                        var ts = DateTime.Now - _recordingStartTime;
                        _recordingTimerText.Text = $"{(int)ts.TotalMinutes:00}:{ts.Seconds:00}";
                    };
                }
                _recordingTimer.Start();
            }
            else
            {
                var saveDialog = new SaveFileDialog { Filter = "Fichier Audio (*.wav)|*.wav" };
                if (saveDialog.ShowDialog() == true)
                {
                    record("save recsound " + saveDialog.FileName, "", 0, 0);
                    record("close recsound", "", 0, 0);
                }
                else record("close recsound", "", 0, 0);

                _isRecording = false;
                _recordingTimer?.Stop();
                btn.Content = "Enregistrer";
                _recordingStatusText!.Text = "Pr√™t";
                _recordingTimerText!.Visibility = Visibility.Collapsed;
            }
        }

        private void BtnNewRecord_Click(object sender, RoutedEventArgs e)
        {
            TxtRecordName.Text = string.Empty;
            GenerateDataEntryForm();
        }

        private void BtnSaveRecord_Click(object sender, RoutedEventArgs e)
        {
            if (string.IsNullOrWhiteSpace(TxtRecordName.Text)) return;
            var record = new { RecordName = TxtRecordName.Text, Timestamp = DateTime.Now.ToString() };
            RecordsListBox.Items.Insert(0, record);
            TxtRecordCount.Text = $"{RecordsListBox.Items.Count} entr√©e(s) enregistr√©e(s)";
            TxtRecordName.Text = string.Empty;
        }

        private void TxtSearchRecords_TextChanged(object sender, TextChangedEventArgs e)
        {
            // Simple filtering logic
        }

        private void RecordsListBox_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            // Load selected record
        }

        private void OpenVariableDesigner_Click(object sender, RoutedEventArgs e)
        {
            // Potentially open VariableDesignView or a designer window
        }

        private void CloseDataEntryMap_Click(object sender, RoutedEventArgs e)
        {
            MapPanel.Visibility = Visibility.Collapsed;
        }
    }
}




FILE: \AdRev.Desktop\Views\Project\DiscussionView.xaml
------------------------------------
<UserControl x:Class="AdRev.Desktop.Views.Project.DiscussionView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:AdRev.Desktop"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1200">
    <Grid Background="#F4F7F9">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="*"/>    <!-- Main Studio -->
        </Grid.RowDefinitions>

        <Border Background="White" Padding="25,12" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1">
            <Grid>
                 <StackPanel>
                    <TextBlock Text="STUDIO D'INTERPR√âTATION SCIENTIFIQUE" FontSize="18" FontWeight="ExtraBold" Foreground="#1A237E"/>
                    <TextBlock Text="√âdition de la discussion et gestion bibliographique" FontSize="10" Foreground="#78909C"/>
                </StackPanel>
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                    <Button Click="GenerateSmartDiscussion_Click" Content="‚ú® Structure IA" Margin="0,0,10,0" Padding="15,5"/>
                    <Button Click="SaveDiscussion_Click" Content="üíæ Sauvegarder" Padding="15,5" Background="{StaticResource PrimaryBrush}" Foreground="White"/>
                </StackPanel>
            </Grid>
        </Border>

        <Grid Grid.Row="1" Margin="15">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2.5*"/> <!-- Editor -->
                <ColumnDefinition Width="1.5*"/> <!-- Library & Support -->
            </Grid.ColumnDefinitions>

            <Grid Grid.Column="0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <TabControl x:Name="DiscussionTabControl" BorderThickness="0" Background="Transparent">
                    <TabItem Header="Discussion Principale">
                        <TextBox x:Name="TxtDiscussionMain" AcceptsReturn="True" TextWrapping="Wrap" ScrollViewer.VerticalScrollBarVisibility="Auto" Padding="20" FontSize="14" FontFamily="Georgia"/>
                    </TabItem>
                    <TabItem Header="Forces &amp; Limites">
                        <TextBox x:Name="TxtDiscussionLimits" AcceptsReturn="True" TextWrapping="Wrap" ScrollViewer.VerticalScrollBarVisibility="Auto" Padding="20" FontSize="14" FontFamily="Georgia"/>
                    </TabItem>
                </TabControl>
            </Grid>

            <Grid Grid.Column="1" Margin="15,0,0,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="1.2*"/>
                </Grid.RowDefinitions>

                <Border Background="White" CornerRadius="8" Padding="15" Margin="0,0,0,15">
                    <StackPanel>
                        <TextBlock Text="üìö Ajouter une Citation" FontWeight="Bold" Margin="0,0,0,10"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBox x:Name="TxtDoiSearch" Tag="DOI ou Titre..." Height="30" VerticalContentAlignment="Center"/>
                            <Button Grid.Column="1" Content="+" Click="QuickAddCitation_Click" Width="30" Margin="5,0,0,0"/>
                        </Grid>
                    </StackPanel>
                </Border>

                <Border Grid.Row="1" Background="White" CornerRadius="8" Padding="15" Margin="0,0,0,15">
                     <DockPanel>
                        <TextBlock Text="üìñ Bibliographie du Projet" FontWeight="Bold" DockPanel.Dock="Top" Margin="0,0,0,10"/>
                        <ListBox x:Name="CitationsListBox" BorderThickness="0">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Border BorderBrush="#EEE" BorderThickness="0,0,0,1" Padding="0,5">
                                        <Grid>
                                            <StackPanel>
                                                <TextBlock Text="{Binding Title}" FontWeight="SemiBold" TextTrimming="CharacterEllipsis"/>
                                                <TextBlock Text="{Binding Authors}" FontSize="10" Foreground="Gray"/>
                                            </StackPanel>
                                            <Button Content="Ins√©rer" Click="InsertCitation_Click" HorizontalAlignment="Right" VerticalAlignment="Center" FontSize="10" Tag="{Binding}"/>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </DockPanel>
                </Border>

                <Border Grid.Row="2" Background="#E3F2FD" CornerRadius="8" Padding="15">
                    <StackPanel>
                        <TextBlock Text="üí° Aide √† la R√©daction" FontWeight="Bold" Foreground="#1976D2" Margin="0,0,0,10"/>
                        <TextBlock x:Name="TxtDiscussionExpertTips" TextWrapping="Wrap" FontSize="12" Foreground="#444"/>
                    </StackPanel>
                </Border>
            </Grid>
        </Grid>
    </Grid>
</UserControl>




FILE: \AdRev.Desktop\Views\Project\DiscussionView.xaml.cs
------------------------------------
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.RegularExpressions;
using System.Windows;
using System.Windows.Controls;
using AdRev.Domain.Models;
using AdRev.Domain.Enums;

namespace AdRev.Desktop.Views.Project
{
    public partial class DiscussionView : UserControl
    {
        private ResearchProject? _project;

        public DiscussionView()
        {
            InitializeComponent();
        }

        public void LoadProject(ResearchProject project)
        {
            _project = project;
            LoadDiscussionData();
        }

        private void LoadDiscussionData()
        {
            if (_project == null) return;

            TxtDiscussionMain.Text = _project.DiscussionContent;
            TxtDiscussionLimits.Text = _project.LimitationsContent;
            CitationsListBox.ItemsSource = _project.References;

            UpdateDiscussionSupport();
        }

        private void UpdateDiscussionSupport()
        {
            if (_project == null) return;

            var sb = new System.Text.StringBuilder();
            sb.AppendLine("‚ú® CONSEILS D'EXPERT :");
            if (_project.StudyType == StudyType.Quantitative)
            {
                sb.AppendLine("‚Ä¢ Discutez la validit√© interne et les biais de s√©lection.");
                sb.AppendLine("‚Ä¢ Comparez vos p-values avec la litt√©rature.");
            }
            else
            {
                sb.AppendLine("‚Ä¢ Soulignez la richesse des verbatims.");
                sb.AppendLine("‚Ä¢ Discutez de votre propre r√©flexit√©.");
            }
            
            TxtDiscussionExpertTips.Text = sb.ToString();
        }

        private void QuickAddCitation_Click(object sender, RoutedEventArgs e)
        {
            if (_project == null || string.IsNullOrWhiteSpace(TxtDoiSearch.Text)) return;

            var citation = new Citation
            {
                Title = "R√©f√©rence : " + TxtDoiSearch.Text,
                Authors = "Auteur Inconnu",
                Year = DateTime.Now.Year.ToString(),
                Doi = TxtDoiSearch.Text
            };

            _project.References.Add(citation);
            CitationsListBox.ItemsSource = null;
            CitationsListBox.ItemsSource = _project.References;
            TxtDoiSearch.Clear();
        }

        private void InsertCitation_Click(object sender, RoutedEventArgs e)
        {
            if (sender is Button btn && btn.Tag is Citation citation)
            {
                var target = TxtDiscussionMain; // Or check focused one
                int caret = target.CaretIndex;
                string marker = $" [{citation.Authors}, {citation.Year}]";
                target.Text = target.Text.Insert(caret, marker);
                target.CaretIndex = caret + marker.Length;
                target.Focus();
            }
        }

        private void GenerateSmartDiscussion_Click(object sender, RoutedEventArgs e)
        {
            var sb = new System.Text.StringBuilder();
            sb.AppendLine("1. R√âSUM√â DES R√âSULTATS CL√âS");
            sb.AppendLine("- Rappel de l'objectif principal.");
            sb.AppendLine();
            sb.AppendLine("2. COMPARAISON AVEC LA LITT√âRATURE");
            sb.AppendLine("- [Citer des √©tudes similaires]");
            
            TxtDiscussionMain.Text = sb.ToString();
        }

        private void SaveDiscussion_Click(object sender, RoutedEventArgs e)
        {
            if (_project == null) return;
            _project.DiscussionContent = TxtDiscussionMain.Text;
            _project.LimitationsContent = TxtDiscussionLimits.Text;
            MessageBox.Show("R√©dacteur sauvegard√©.", "Succ√®s");
        }
    }
}




FILE: \AdRev.Desktop\Views\Project\FinalReportView.xaml
------------------------------------
<UserControl x:Class="AdRev.Desktop.Views.Project.FinalReportView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:AdRev.Desktop"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1200">
    <Grid Background="#F5F7F8">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <Border Grid.Row="0" Background="White" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1" Padding="25">
            <StackPanel>
                <TextBlock Text="G√©n√©ration du Rapport d'√âtude" FontSize="22" FontWeight="Bold" Foreground="#2C3E50"/>
                <TextBlock Text="Finalisez votre travail en exportant le rapport complet au format Word." Foreground="#666" Margin="0,5,0,0"/>
            </StackPanel>
        </Border>

        <Grid Grid.Row="1" Margin="20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/> <!-- Main Editor -->
                <ColumnDefinition Width="20"/>
                <ColumnDefinition Width="1.2*"/> <!-- Assistant Panel -->
            </Grid.ColumnDefinitions>

            <!-- Left: Report Configuration & Content -->
            <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="0,0,10,0">
                <StackPanel>
                    <!-- Configuration Card -->
                    <Border Style="{StaticResource CardStyle}" Margin="0,0,0,20">
                        <StackPanel>
                            <TextBlock Text="Structure Acad√©mique &amp; Logique Scientifique" FontWeight="Bold" FontSize="16" Margin="0,0,0,15" Foreground="{StaticResource PrimaryBrush}"/>
                            
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <StackPanel Margin="0,0,10,0">
                                    <TextBlock Text="Niveau de Recherche" Style="{StaticResource LabelStyle}"/>
                                    <ComboBox x:Name="AcademicLevelCombo" Height="35" SelectionChanged="AcademicLevelCombo_SelectionChanged" Cursor="Hand"/>
                                    
                                    <StackPanel x:Name="TargetJournalPanel" Margin="0,10,0,0" Visibility="Collapsed">
                                        <TextBlock Text="Revue Cible (Pour Article)" Style="{StaticResource LabelStyle}" Foreground="#1976D2"/>
                                        <ComboBox x:Name="TargetJournalCombo" Height="35" DisplayMemberPath="JournalName" SelectionChanged="TargetJournalCombo_SelectionChanged" Cursor="Hand"/>
                                        <TextBlock Text="Les crit√®res (mots-cl√©s, structure) seront appliqu√©s." FontSize="10" Foreground="#78909C" Margin="0,2,0,0" FontStyle="Italic"/>
                                    </StackPanel>
                                </StackPanel>
                                
                                <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                    <TextBlock Text="Statut de R√©daction" Style="{StaticResource LabelStyle}"/>
                                    <TextBlock x:Name="ReportProjectStatusText" Text="Phase de Finalisation" Foreground="#2E7D32" FontWeight="SemiBold" VerticalAlignment="Center" Margin="0,8,0,0"/>
                                </StackPanel>
                            </Grid>
                        </StackPanel>
                    </Border>

                    <!-- Conclusion Card -->
                    <Border Style="{StaticResource CardStyle}" Margin="0,0,0,20">
                        <StackPanel>
                            <TextBlock Text="Conclusion et Recommandations (Logique Scientifique)" FontWeight="Bold" FontSize="16" Margin="0,0,0,10" Foreground="#1565C0"/>
                            <TextBlock Text="R√©sumez l'apport de l'√©tude par rapport aux objectifs et proposez des recommandations concr√®tes." FontSize="11" Foreground="#777" Margin="0,0,0,10" FontStyle="Italic"/>
                            <TextBox x:Name="TxtFinalConclusion" MinHeight="250" TextWrapping="Wrap" AcceptsReturn="True" 
                                     FontSize="14" FontFamily="Times New Roman" Padding="15" BorderBrush="#BBDEFB"
                                     GotFocus="ReportBox_GotFocus"/>
                        </StackPanel>
                    </Border>

                    <!-- Export Card -->
                    <Border Style="{StaticResource CardStyle}" Background="#E3F2FD" BorderBrush="#BBDEFB">
                        <StackPanel>
                            <TextBlock Text="G√©n√©ration du Document Final" FontWeight="Bold" FontSize="16" Margin="0,0,0,10"/>
                            <TextBlock Text="Le rapport Word inclura les sections Protocole, R√©sultats, Discussion et Conclusion selon les normes acad√©miques." Foreground="#555" Margin="0,0,0,20" TextWrapping="Wrap"/>
                            <Button x:Name="BtnExportFinalReport" Content="G√âN√âRER LE RAPPORT COMPLET (.DOCX)" Click="BtnExportFinalReport_Click" 
                                    Style="{StaticResource ModernButtonStyle}" Height="55" FontSize="14" FontWeight="Bold" Cursor="Hand"/>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </ScrollViewer>

            <!-- Right: Scientific Assistant Panel -->
            <Border Grid.Column="2" Background="White" CornerRadius="12" BorderBrush="#E0E0E0" BorderThickness="1" Padding="20">
                <StackPanel>
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,15">
                        <TextBlock Text="üî¨" FontSize="20" Margin="0,0,10,0"/>
                        <TextBlock Text="ASSISTANT SCIENTIFIQUE" FontWeight="Bold" Foreground="#37474F" VerticalAlignment="Center" FontSize="12"/>
                    </StackPanel>

                    <Border Background="#FFF8E1" CornerRadius="8" Padding="15" Margin="0,0,0,20" BorderBrush="#FFE082" BorderThickness="1">
                        <StackPanel>
                            <TextBlock x:Name="TxtWritingAssistantTitle" Text="S√©lectionnez une section" FontWeight="Bold" Foreground="#F57C00" Margin="0,0,0,8" FontSize="11"/>
                            <TextBlock x:Name="TxtWritingAssistantContent" Text="Cliquez dans une zone de texte pour recevoir des conseils de r√©daction et de logique scientifique." TextWrapping="Wrap" FontSize="11" Foreground="#5D4037" LineHeight="18"/>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</UserControl>




FILE: \AdRev.Desktop\Views\Project\FinalReportView.xaml.cs
------------------------------------
using System;
using System.Diagnostics;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using AdRev.Domain.Models;
using AdRev.Domain.Enums;
using AdRev.Core.Services;
using AdRev.Core.Common;
using AdRev.Desktop.Services;
using Microsoft.Win32;

namespace AdRev.Desktop.Views.Project
{
    public partial class FinalReportView : UserControl
    {
        private ResearchProject? _project;
        private readonly ResearchProjectService _projectService = new ResearchProjectService();

        public FinalReportView()
        {
            InitializeComponent();
            AcademicLevelCombo.ItemsSource = Enum.GetValues(typeof(AcademicLevel));
            AcademicLevelCombo.SelectedIndex = 0;
        }

        public void LoadProject(ResearchProject project)
        {
            _project = project;
            AcademicLevelCombo.SelectedItem = _project.AcademicLevel;
            TxtFinalConclusion.Text = _project.ConclusionContent;
        }

        private void AcademicLevelCombo_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (_project != null && AcademicLevelCombo.SelectedItem is AcademicLevel level)
            {
                _project.AcademicLevel = level;
                TargetJournalPanel.Visibility = (level == AcademicLevel.ScientificArticle) ? Visibility.Visible : Visibility.Collapsed;
            }
        }

        private void TargetJournalCombo_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            // Logic to update target journal in project
        }

        private void ReportBox_GotFocus(object sender, RoutedEventArgs e)
        {
            if (sender is TextBox tb)
            {
                TxtWritingAssistantTitle.Text = "Conseils pour la Conclusion";
                TxtWritingAssistantContent.Text = "La conclusion doit r√©pondre √† la question de recherche initiale. √âvitez d'introduire de nouveaux r√©sultats ici.";
            }
        }

        private void BtnExportFinalReport_Click(object sender, RoutedEventArgs e)
        {
            if (_project == null) return;

            _project.ConclusionContent = TxtFinalConclusion.Text;

            var sfd = new SaveFileDialog
            {
                Filter = "Word Document (*.docx)|*.docx",
                FileName = $"Rapport_{_project.Title}_{DateTime.Now:yyyyMMdd}.docx"
            };

            if (sfd.ShowDialog() == true)
            {
                try
                {
                    Mouse.OverrideCursor = Cursors.Wait;
                    var exporter = new WordExportService();
                    exporter.ExportGlobalReport(_project, sfd.FileName);
                    
                    MessageBox.Show("Le rapport a √©t√© g√©n√©r√© avec succ√®s.", "Export R√©ussi");
                    
                    Process.Start(new ProcessStartInfo { FileName = sfd.FileName, UseShellExecute = true });
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Erreur lors de l'exportation : {ex.Message}", "Erreur");
                }
                finally
                {
                    Mouse.OverrideCursor = null;
                }
            }
        }
    }
}




FILE: \AdRev.Desktop\Views\Project\JournalArticleView.xaml
------------------------------------
<UserControl x:Class="AdRev.Desktop.Views.Project.JournalArticleView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:AdRev.Desktop"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1200">
    <Grid Background="#F5F7F8">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="300"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Sidebar: Journal Config -->
        <Border Background="White" BorderBrush="#E0E0E0" BorderThickness="0,0,1,0" Padding="20">
            <StackPanel>
                <TextBlock Text="Cible de Publication" FontSize="18" FontWeight="Bold" Foreground="{StaticResource PrimaryBrush}" Margin="0,0,0,20"/>
                
                <TextBlock Text="S√©lectionner une Revue" Style="{StaticResource LabelStyle}"/>
                <ComboBox x:Name="ReportJournalCombo" Height="35" Margin="0,0,0,20" SelectionChanged="ReportJournalCombo_SelectionChanged" DisplayMemberPath="JournalName"/>
                
                <!-- Criteria Summary in Sidebar -->
                <Border Background="#E8F5E9" Padding="15" CornerRadius="5" x:Name="JournalSummaryPanel" Visibility="Collapsed">
                     <StackPanel>
                        <TextBlock Text="Contraintes Cl√©s" FontWeight="Bold" Foreground="#2E7D32" Margin="0,0,0,10"/>
                        <TextBlock x:Name="JournalConstraintsText" Text="..." FontSize="12" TextWrapping="Wrap" Foreground="#333"/>
                        <TextBlock x:Name="JournalUrlLink" Text="Site de soumission ‚Üó" Foreground="Blue" TextDecorations="Underline" Cursor="Hand" Margin="0,10,0,0" MouseLeftButtonUp="JournalUrlLink_Click"/>
                     </StackPanel>
                </Border>
            </StackPanel>
        </Border>

        <!-- Main Content: Writing Studio -->
        <Grid Grid.Column="1" Background="White">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <!-- Toolbar -->
                <RowDefinition Height="*"/>    <!-- Editor -->
                <RowDefinition Height="Auto"/> <!-- Status -->
            </Grid.RowDefinitions>

            <!-- Toolbar -->
            <Border BorderBrush="#EEE" BorderThickness="0,0,0,1" Padding="15,10">
                <StackPanel Orientation="Horizontal">
                    <TextBlock x:Name="JournalTitleText" Text="R√©daction" FontWeight="Bold" FontSize="16" VerticalAlignment="Center" Margin="0,0,20,0"/>
                    
                    <Button Content="‚ú® G√©n√©rer Structure" Click="GenerateStructure_Click" Background="#E3F2FD" Foreground="#1565C0" BorderThickness="0" Padding="10,5" Margin="0,0,10,0"/>
                    
                    <Button Content="üíæ Sauvegarder Brouillon" Click="SaveDraft_Click" Background="Transparent" Foreground="#666" BorderThickness="1" BorderBrush="#DDD" Padding="10,5"/>
                </StackPanel>
            </Border>

            <!-- Editor -->
            <RichTextBox x:Name="ArticleEditor" Grid.Row="1" BorderThickness="0" Padding="40" FontSize="14" FontFamily="Calibri" VerticalScrollBarVisibility="Auto">
                <FlowDocument>
                    <Paragraph Foreground="#888" FontStyle="Italic">
                        S√©lectionnez une revue √† gauche pour charger le mod√®le de r√©daction.
                    </Paragraph>
                </FlowDocument>
            </RichTextBox>
            
            <!-- Status Bar for Word Count -->
             <Border Grid.Row="2" Background="#FAFAFA" BorderBrush="#EEE" BorderThickness="0,1,0,0" Padding="15,10">
                <Grid>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <TextBlock x:Name="WordCountText" Text="0 mots" Foreground="#888" FontSize="11" VerticalAlignment="Center"/>
                        <TextBlock Text=" | " Foreground="#DDD" Margin="10,0" VerticalAlignment="Center"/>
                        <TextBlock x:Name="TargetWordCountText" Text="Cible : -" Foreground="#888" FontSize="11" VerticalAlignment="Center"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</UserControl>




FILE: \AdRev.Desktop\Views\Project\JournalArticleView.xaml.cs
------------------------------------
using System;
using System.Collections.Generic;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Documents;
using System.Windows.Media;
using AdRev.Domain.Models;
using AdRev.Desktop.Services;

namespace AdRev.Desktop.Views.Project
{
    public partial class JournalArticleView : UserControl
    {
        private ResearchProject? _project;
        private readonly JournalService _journalService = new JournalService();

        public JournalArticleView()
        {
            InitializeComponent();
            LoadJournals();
        }

        private void LoadJournals()
        {
            var journals = _journalService.GetCommonJournals();
            ReportJournalCombo.ItemsSource = journals;
        }

        public void LoadProject(ResearchProject project)
        {
            _project = project;
        }

        private void ReportJournalCombo_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (ReportJournalCombo.SelectedItem is JournalSubmissionCriteria journal)
            {
                JournalTitleText.Text = $"√âcriture pour : {journal.JournalName}";
                JournalSummaryPanel.Visibility = Visibility.Visible;
                JournalConstraintsText.Text = $"Abstract: {journal.MaxWordCountAbstract} mots\n" +
                                              $"Corps: {journal.MaxWordCountBody} mots\n" +
                                              $"Style: {journal.CitationStyle}\n" +
                                              $"R√©f. Max: {journal.MaxReferences}";
                JournalUrlLink.Tag = journal.GuidelinesUrl;
                TargetWordCountText.Text = $"Cible : {journal.MaxWordCountBody} mots";
            }
        }

        private void JournalUrlLink_Click(object sender, System.Windows.Input.MouseButtonEventArgs e)
        {
            if (JournalUrlLink.Tag is string url && !string.IsNullOrEmpty(url))
            {
                try
                {
                    System.Diagnostics.Process.Start(new System.Diagnostics.ProcessStartInfo { FileName = url, UseShellExecute = true });
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Impossible d'ouvrir le lien : {ex.Message}", "Erreur");
                }
            }
        }

        private void GenerateStructure_Click(object sender, RoutedEventArgs e)
        {
            if (ReportJournalCombo.SelectedItem is JournalSubmissionCriteria journal)
            {
                GenerateArticleSkeleton(journal);
            }
            else
            {
                MessageBox.Show("Veuillez s√©lectionner une revue d'abord.");
            }
        }

        private void GenerateArticleSkeleton(JournalSubmissionCriteria journal)
        {
            var doc = new FlowDocument();
            
            // Title
            var titlePara = new Paragraph(new Run("[TITRE DE L'ARTICLE]")) { FontSize = 24, FontWeight = FontWeights.Bold, TextAlignment = TextAlignment.Center, Margin = new Thickness(0,0,0,20) };
            doc.Blocks.Add(titlePara);

            // Abstract
            var absHeader = new Paragraph(new Run("ABSTRACT")) { FontSize = 14, FontWeight = FontWeights.Bold, Foreground = Brushes.Gray };
            doc.Blocks.Add(absHeader);
            doc.Blocks.Add(new Paragraph(new Run($"({(journal.RequiresStructuredAbstract ? "Structur√©" : "Libre")} - Max {journal.MaxWordCountAbstract} mots)")) { FontStyle = FontStyles.Italic, Foreground = Brushes.LightGray });
            doc.Blocks.Add(new Paragraph(new Run("")));

            // Sections
            foreach(var sec in journal.RequiredSections)
            {
                var header = new Paragraph(new Run(sec.ToUpper())) { FontSize = 18, FontWeight = FontWeights.Bold, Margin = new Thickness(0, 20, 0, 10), Foreground = Brushes.Navy };
                doc.Blocks.Add(header);
                doc.Blocks.Add(new Paragraph(new Run("Commencez √† r√©diger ici...")));
            }

            ArticleEditor.Document = doc;
        }

        private void SaveDraft_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("Brouillon sauvegard√© (Simulation).", "AdRev");
        }
    }
}




FILE: \AdRev.Desktop\Views\Project\ProtocolView.xaml
------------------------------------
<UserControl x:Class="AdRev.Desktop.Views.Project.ProtocolView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:AdRev.Desktop"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1100">
    <UserControl.Resources>
        <local:EnumDescriptionConverter x:Key="EnumDescriptionConverter"/>
        
        <Style TargetType="{x:Type TextBox}">
            <Setter Property="FontFamily" Value="Times New Roman"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Padding" Value="5"/>
        </Style>

        <Style TargetType="{x:Type RichTextBox}">
             <Setter Property="FontFamily" Value="Times New Roman"/>
             <Setter Property="FontSize" Value="12"/>
             <Setter Property="Block.LineHeight" Value="18"/>
        </Style>

        <Style x:Key="LabelStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="#333"/>
            <Setter Property="Margin" Value="0,0,0,5"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="FontFamily" Value="Segoe UI"/>
        </Style>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- 0: Menu -->
            <RowDefinition Height="*"/>    <!-- 1: Content -->
            <RowDefinition Height="Auto"/> <!-- 2: Footer -->
        </Grid.RowDefinitions>

        <!-- Menu Bar (Onglets) -->
        <Border Grid.Row="0" Background="#F8F9FA" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1" Padding="5">
             <Menu Background="Transparent">
                <MenuItem Header="Fichier" FontSize="14" Margin="5,0,10,0">
                    <MenuItem x:Name="MenuFileNew" Header="Nouveau" Click="MenuFileNew_Click"/>
                    <MenuItem x:Name="MenuFileSave" Header="Enregistrer" Click="CreateProtocol_Click"/>
                    <MenuItem x:Name="MenuFileExport" Header="Exporter en Word (.docx)" Click="ExportWord_Click"/>
                </MenuItem>
                
                <MenuItem Header="√âdition" FontSize="14" Margin="5,0,10,0">
                    <MenuItem Header="Copier" Command="ApplicationCommands.Copy"/>
                    <MenuItem Header="Coller" Command="ApplicationCommands.Paste"/>
                </MenuItem>

                <MenuItem x:Name="MenuDiscussion" Header="Assistant Discussion üí¨" 
                          FontSize="14" 
                          FontWeight="Bold" 
                          Foreground="{StaticResource PrimaryBrush}" 
                          Margin="20,0,10,0"
                          Click="MenuDiscussion_Click"
                          ToolTip="Ouvrir la fen√™tre d'aide √† la discussion"/>
            </Menu>
        </Border>

        <!-- Contenu Principal : Multi-Vues -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Navigation Lat√©rale -->
            <Border Grid.Column="0" Background="White" BorderBrush="#EEEEEE" BorderThickness="0,0,1,0" Padding="0,15,0,0">
                <ListBox x:Name="SideMenuListBox" BorderThickness="0" Background="Transparent" ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                    <ListBox.Resources>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Padding" Value="20,12"/>
                            <Setter Property="FontSize" Value="14"/>
                            <Setter Property="Cursor" Value="Hand"/>
                            <Setter Property="Margin" Value="0,2"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border x:Name="bd" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="0" Padding="{TemplateBinding Padding}">
                                            <ContentPresenter HorizontalAlignment="Left" VerticalAlignment="Center"/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter TargetName="bd" Property="Background" Value="#E3F2FD"/>
                                                <Setter TargetName="bd" Property="BorderBrush" Value="#2196F3"/>
                                                <Setter TargetName="bd" Property="BorderThickness" Value="4,0,0,0"/>
                                                <Setter Property="Foreground" Value="#1976D2"/>
                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                            </Trigger>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="bd" Property="Background" Value="#F5F5F5"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.Resources>
                    
                    <ListBoxItem Content="1. Informations G√©n√©rales" Tag="1"/>
                    <ListBoxItem Content="2. Introduction &amp; Contexte" Tag="2"/>
                    <ListBoxItem Content="3. Objectifs de l'√âtude" Tag="3"/>
                    <ListBoxItem Content="4. Cadre Conceptuel" Tag="4"/>
                    <ListBoxItem Content="5. Design &amp; Cadre" Tag="5"/>
                    <ListBoxItem Content="6. Population &amp; Crit√®res" Tag="6"/>
                    <ListBoxItem Content="7. Echantillonnage" Tag="7"/>
                    <ListBoxItem Content="8. Collecte de donn√©es" Tag="8"/>
                    <ListBoxItem Content="9. Budget &amp; Ressources" Tag="9"/>
                    <ListBoxItem Content="10. Consid√©rations √âthiques" Tag="10"/>
                    <ListBoxItem Content="11. Plan d'Analyse (SAP/TAP)" Tag="11"/>
                    <ListBoxItem Content="12. R√©sultats Attendus" Tag="12"/>
                    <ListBoxItem Content="13. Conclusion" Tag="13"/>
                    <ListBoxItem Content="14. R√©f√©rences" Tag="14"/>
                </ListBox>
            </Border>

            <!-- Zone Contenu -->
            <Grid Grid.Column="1" Margin="30,20,30,20">
                <!-- √âTAPE 1 : INFORMATIONS G√âN√âRALES -->
                <ScrollViewer x:Name="View_Step1" VerticalScrollBarVisibility="Auto" Visibility="Visible">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="√âtape 1/14 : Informations G√©n√©rales" Tag="#E3F2FD" Foreground="#1565C0">
                            <StackPanel>
                                <StackPanel Margin="0,0,0,15">
                                     <StackPanel Margin="0,0,0,15">
                                         <TextBlock Text="Titre du protocole" Style="{StaticResource LabelStyle}" FontWeight="SemiBold"/>
                                         <TextBox x:Name="TitleTextBox" Height="40" FontSize="14" VerticalContentAlignment="Center" Padding="5" Tag="Sujet de recherche, Titre complet du protocole..."/>
                                     </StackPanel>
                                     <StackPanel Margin="0,0,0,10">
                                         <TextBlock Text="Domaine de Recherche" Style="{StaticResource LabelStyle}" FontWeight="SemiBold"/>
                                         <ComboBox x:Name="DomainComboBox" Height="35" VerticalContentAlignment="Center" Padding="10,0" SelectionChanged="DomainComboBox_SelectionChanged" SelectedIndex="0">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                         </ComboBox>
                                     </StackPanel>
                                     <StackPanel Margin="0,0,0,10">
                                         <TextBlock Text="Style de R√©f√©rence Bibliographique" Style="{StaticResource LabelStyle}" FontWeight="SemiBold"/>
                                         <ComboBox x:Name="RefStyleComboStep1" Height="35" VerticalContentAlignment="Center" Padding="10,0" SelectionChanged="RefStyleCombo_SelectionChanged" SelectedIndex="0">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding}"/>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                         </ComboBox>
                                     </StackPanel>
                                </StackPanel>
                                <Rectangle Height="1" Fill="#EEEEEE" Margin="0,10,0,20"/>
                                <TextBlock Text="Auteur Principal" Style="{StaticResource HeaderTextStyle}" FontSize="16" Margin="0,0,0,10"/>
                                <Grid Margin="0,0,0,15">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="80"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="5"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="Titre" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                        <ComboBox x:Name="AuthorTitleBox" SelectedIndex="0" Height="30" VerticalContentAlignment="Center">
                                            <ComboBoxItem Content="Dr"/>
                                            <ComboBoxItem Content="Pr"/>
                                            <ComboBoxItem Content="M."/>
                                            <ComboBoxItem Content="Mme"/>
                                            <ComboBoxItem Content="Mlle"/>
                                        </ComboBox>
                                    </StackPanel>
                                    <StackPanel Grid.Column="2">
                                        <TextBlock Text="Pr√©nom" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                         <TextBox x:Name="AuthorFirstNameBox" Height="30" Tag="Pr√©nom"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="4">
                                        <TextBlock Text="Nom" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                         <TextBox x:Name="AuthorLastNameBox" Height="30" Tag="Nom"/>
                                    </StackPanel>
                                    <StackPanel Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="3">
                                        <TextBlock Text="Institution" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                         <TextBox x:Name="AuthorInstitutionBox" Height="30" ToolTip="Universit√©, H√¥pital, Centre de recherche..." Tag="Affiliation Institutionnelle"/>
                                    </StackPanel>
                                    <StackPanel Grid.Row="2" Grid.Column="4">
                                        <TextBlock Text="Email" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                         <TextBox x:Name="AuthorEmailBox" Height="30" ToolTip="email@exemple.com" Tag="contact@exemple.com"/>
                                    </StackPanel>
                                </Grid>
                                <TextBlock Text="Co-Auteurs" Style="{StaticResource HeaderTextStyle}" FontSize="16" Margin="0,10,0,5"/>
                                <Border Background="#F9F9F9" BorderBrush="#EEEEEE" BorderThickness="1" CornerRadius="5" Padding="15">
                                    <StackPanel>
                                        <TextBlock Text="Ajouter un co-auteur :" Style="{StaticResource LabelStyle}" FontSize="12" FontWeight="Bold" Margin="0,0,0,10"/>
                                        <Grid Margin="0,0,0,5">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/> 
                                                <ColumnDefinition Width="*"/> 
                                                <ColumnDefinition Width="1.5*"/> 
                                                <ColumnDefinition Width="1.5*"/> 
                                                <ColumnDefinition Width="Auto"/> 
                                            </Grid.ColumnDefinitions>
                                             <TextBox x:Name="CoAuthFirst" Margin="0,0,5,0" Height="30" ToolTip="Pr√©nom" Tag="Pr√©nom"/>
                                             <TextBox x:Name="CoAuthLast" Grid.Column="1" Margin="0,0,5,0" Height="30" ToolTip="Nom" Tag="Nom"/>
                                             <TextBox x:Name="CoAuthInst" Grid.Column="2" Margin="0,0,5,0" Height="30" ToolTip="Institution" Tag="Institution"/>
                                             <TextBox x:Name="CoAuthEmail" Grid.Column="3" Margin="0,0,5,0" Height="30" ToolTip="Email" Tag="Email"/>
                                            <Button Grid.Column="4" Content="‚ûï" Click="AddCoAuthor_Click" Width="40" Height="30" Background="#DDDDDD" ToolTip="Ajouter"/>
                                        </Grid>
                                        <ListBox x:Name="CoAuthorsListBox" Height="100" BorderThickness="1" BorderBrush="#EEEEEE" Background="White">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding}" FontSize="12" Padding="5"/>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                        <Button Content="üóëÔ∏è Retirer la s√©lection" Click="RemoveCoAuthor_Click" HorizontalAlignment="Right" Margin="0,5,0,0" FontSize="11" Background="Transparent" BorderThickness="0" Foreground="#CC3333" Cursor="Hand"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- √âTAPE 2 : INTRODUCTION -->
                <ScrollViewer x:Name="View_Introduction" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="√âtape 2/14 : Introduction &amp; Contexte" Tag="#E1F5FE" Foreground="#0277BD">
                             <StackPanel>
                                <TextBlock Text="Structure de l'Introduction (Max 2000 mots)" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                <Grid Margin="0,0,0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="1. Contexte (D√©finitions principales...)" Style="{StaticResource LabelStyle}" VerticalAlignment="Center"/>
                                    <Button Grid.Column="1" Content="‚ûï Citer une source" Click="AddCitation_Click" Tag="Context" Height="25" FontSize="11" Padding="10,0" Background="#E0E0E0" Foreground="Black" Margin="0"/>
                                </Grid>
                                 <TextBox x:Name="ContextTextBox" Height="300" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15" VerticalScrollBarVisibility="Auto" Tag="D√©crivez l'√©tat actuel des connaissances, les d√©finitions et le contexte global de votre √©tude..."/>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="2. Justification du Probl√®me (Donn√©es, Lacunes...)" Style="{StaticResource LabelStyle}"/>
                                    <Button Grid.Column="1" Content="‚ûï Citer" Click="AddCitation_Click" Tag="ProblemTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                 <TextBox x:Name="ProblemTextBox" Height="80" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="Quelle est la lacune ou le probl√®me sp√©cifique que cette √©tude vise √† r√©soudre ?"/>
                                <TextBlock Text="3. Question de Recherche (Max 3)" Style="{StaticResource LabelStyle}"/>
                                 <TextBox x:Name="ResearchQuestionTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="Ex: Quel est l'impact de X sur Y dans la population Z ?"/>
                                <TextBlock Text="4. Hypoth√®ses (Max 2)" Style="{StaticResource LabelStyle}"/>
                                 <TextBox x:Name="HypothesesTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="Ex: Il existe une corr√©lation positive entre..."/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- √âTAPE 3 : OBJECTIFS -->
                <ScrollViewer x:Name="View_Objectives" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="√âtape 3/14 : Objectifs de l'√âtude" Tag="#E8F5E9" Foreground="#2E7D32">
                            <StackPanel>
                                <TextBlock Text="Objectifs de l'√©tude" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                <TextBlock Text="Objectif G√©n√©ral (Max 2)" Style="{StaticResource LabelStyle}" FontWeight="Bold"/>
                                <TextBlock Text="Utilisez des verbes d'action pr√©cis (Taxonomie de Bloom)." FontSize="10" Foreground="#666" Margin="0,0,0,2"/>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,2">
                                    <TextBlock x:Name="OGCountAlert" Text="‚ö†Ô∏è Attention : Limitez-vous √† 3 Objectifs G√©n√©raux." Foreground="Red" FontWeight="Bold" FontSize="11" Visibility="Collapsed" Margin="0,0,10,0"/>
                                    <TextBlock x:Name="OGBloomAlert" Text="‚ö†Ô∏è Utilisez un verbe d'action Bloom." Foreground="#FF8C00" FontWeight="Bold" FontSize="11" Visibility="Collapsed"/>
                                </StackPanel>
                                 <TextBox x:Name="GeneralObjectiveTextBox" Height="120" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" 
                                          TextChanged="GeneralObjectiveTextBox_TextChanged" Text=""
                                          PreviewKeyDown="ObjectiveTextBox_PreviewKeyDown" Tag="OG1: D√©terminer l'efficacit√© de..."/>
                                <TextBlock Text="Objectifs Sp√©cifiques (Max 4 par OG)" Style="{StaticResource LabelStyle}" FontWeight="Bold"/>
                                <TextBlock x:Name="OSSuggestions" Text="üí° Verbes sugg√©r√©s : ..." FontSize="11" Foreground="#1565C0" FontStyle="Italic" Margin="0,0,0,2" Visibility="Collapsed"/>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock x:Name="OSCountAlert" Text="‚ö†Ô∏è Attention : Max 4 OS par OG recommand√©s." Foreground="Red" FontWeight="Bold" FontSize="11" Visibility="Collapsed" Margin="0,0,10,0"/>
                                        <TextBlock x:Name="OSBloomAlert" Text="‚ö†Ô∏è Utilisez des verbes d'action Bloom." Foreground="#FF8C00" FontWeight="Bold" FontSize="11" Visibility="Collapsed"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                                        <Button Content="Lier aux OG üîó" Click="LinkOSToOG_Click" FontSize="10" Padding="5,2" Background="#E3F2FD" BorderBrush="#2196F3" Foreground="#1565C0" Margin="0,0,5,0"/>
                                        <Button Content="üî¢ Ajuster N¬∞" Click="RenumberOS_Click" FontSize="10" Padding="5,2" Background="#FFF3E0" BorderBrush="#FF9800" Foreground="#E65100" ToolTip="Renum√©rote automatiquement les OS (ex: corrige les doublons ou sauts)"/>
                                    </StackPanel>
                                </Grid>
                                 <TextBox x:Name="SpecificObjectivesTextBox" Height="250" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10"
                                          TextChanged="SpecificObjectivesTextBox_TextChanged" Text=""
                                          PreviewKeyDown="ObjectiveTextBox_PreviewKeyDown" Tag="OS1: Comparer les taux de..."/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- √âTAPE 4 : CADRE CONCEPTUEL -->
                <ScrollViewer x:Name="View_ConceptualModel" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                     <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="√âtape 4/14 : Cadre Conceptuel" Tag="#E8EAF6" Foreground="#283593">
                             <StackPanel>
                                <TextBlock Text="D√©finition des Concepts Cl√©s" Style="{StaticResource LabelStyle}"/>
                                 <TextBox x:Name="ConceptsTextBox" Height="100" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15" Tag="D√©finissez les variables ind√©pendantes, d√©pendantes et les concepts th√©oriques majeurs..."/>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Mod√®le Conceptuel (Optionnel)" Style="{StaticResource LabelStyle}"/>
                                    <Button Grid.Column="1" Content="‚ûï Citer" Click="AddCitation_Click" Tag="ConceptualModelTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                 <TextBlock Text="D√©crivez les relations entre les variables." FontSize="10" Foreground="#666" Margin="0,0,0,5"/>
                                <TextBox x:Name="ConceptualModelTextBox" Height="100" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="Expliquez comment les variables interagissent entre elles (Sch√©ma ou texte)..."/>
                            </StackPanel>
                        </Expander>
                     </StackPanel>
                </ScrollViewer>

                <!-- √âTAPE 5 : METHODOLOGIE - Design & Cadre -->
                <ScrollViewer x:Name="View_Methodology_Design" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="√âtape 5/14 : M√©thodologie - Design &amp; Cadre" Tag="#E8F5E9" Foreground="#2E7D32">
                            <StackPanel>
                                <TextBlock Text="Type d'√©tude (Approche)" Style="{StaticResource LabelStyle}" FontWeight="SemiBold"/>
                                <ComboBox x:Name="StudyTypeComboBox" Height="40" Padding="10" VerticalContentAlignment="Center" FontSize="14" Margin="0,0,0,10" SelectionChanged="StudyTypeComboBox_SelectionChanged">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                                <StackPanel x:Name="QualitativeTypePanel" Visibility="Collapsed" Margin="0,0,0,15">
                                    <TextBlock Text="Approche Qualitative" Style="{StaticResource LabelStyle}" FontWeight="SemiBold" Foreground="{StaticResource SecondaryBrush}"/>
                                    <ComboBox x:Name="QualitativeApproachComboBox" Height="40" Padding="10" VerticalContentAlignment="Center" FontSize="14" SelectionChanged="RefreshAudit_LostFocus">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </StackPanel>
                                <StackPanel x:Name="EpidemiologyTypePanel" Visibility="Collapsed" Margin="0,0,0,15">
                                    <TextBlock x:Name="DesignPrecisionLabel" Text="Pr√©cision du Devis (M√©thodologie)" Style="{StaticResource LabelStyle}" FontWeight="SemiBold" Foreground="{StaticResource SecondaryBrush}"/>
                                    <ComboBox x:Name="EpidemiologyTypeComboBox" Height="40" Padding="10" VerticalContentAlignment="Center" FontSize="14" SelectionChanged="EpidemiologyTypeComboBox_SelectionChanged">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </StackPanel>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                       <ColumnDefinition Width="*"/>
                                       <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Cadre de l'√©tude (Lieu, P√©riode)" Style="{StaticResource LabelStyle}"/>
                                    <Button Grid.Column="1" Content="‚ûï Citer" Click="AddCitation_Click" Tag="StudySettingTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                <TextBox x:Name="StudySettingTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" LostFocus="RefreshAudit_LostFocus" Tag="O√π et quand se d√©roule l'√©tude ? (Ville, H√¥pital, Services concern√©s...)"/>
                                <Border x:Name="PanelQualityGuidelines" Visibility="Collapsed" Background="#E8F5E9" BorderBrush="#4CAF50" BorderThickness="1" CornerRadius="5" Padding="15" Margin="0,15,0,0">
                                    <StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                            <TextBlock Text="‚úÖ Crit√®res de Qualit√© M√©thodologique" FontWeight="Bold" FontSize="14" Foreground="#2E7D32" VerticalAlignment="Center"/>
                                            <TextBlock x:Name="QualityStandardName" Text="(COREQ/STROBE)" Foreground="#2E7D32" Margin="10,0,0,0" VerticalAlignment="Center" FontStyle="Italic"/>
                                        </StackPanel>
                                        <TextBlock Text="Cochez les √©l√©ments au fur et √† mesure que vous les int√©grez :" FontSize="11" Foreground="#555" Margin="0,0,0,10"/>
                                        <ScrollViewer MaxHeight="300" VerticalScrollBarVisibility="Auto">
                                            <StackPanel x:Name="QualityGuidelinesList"/>
                                        </ScrollViewer>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- √âTAPE 6 : METHODOLOGIE - Population & Crit√®res -->
                <ScrollViewer x:Name="View_Methodology_Population" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="√âtape 6/14 : M√©thodologie - Population &amp; Crit√®res" Tag="#F1F8E9" Foreground="#33691E">
                            <StackPanel>
                                <TextBlock Text="Population d'√©tude" Style="{StaticResource LabelStyle}"/>
                                 <TextBox x:Name="PopulationTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="D√©finissez la population source et la population cible (ex: Patients diab√©tiques de type 2)..."/>
                                <Border Background="#F5F5F5" BorderBrush="#DDDDDD" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,0,0,15">
                                    <StackPanel>
                                        <CheckBox x:Name="IsMulticentricCheckBox" Content="√âtude Multicentrique" FontWeight="SemiBold" Margin="0,0,0,10" Checked="IsMulticentricCheckBox_Checked" Unchecked="IsMulticentricCheckBox_Unchecked"/>
                                        <StackPanel x:Name="MulticentricDetailsPanel" Visibility="Collapsed">
                                            <TextBlock Text="Centres participants (un par ligne) :" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                             <TextBox x:Name="StudyCentersTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" ToolTip="Listez les centres participants √† l'√©tude" Tag="Ex: CHU A, Centre M√©dical B, etc."/>
                                        </StackPanel>
                                    </StackPanel>
                                </Border>
                                <Grid Margin="0,0,0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="10"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel Grid.Column="0">
                                        <Grid Margin="0,0,0,2">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="Crit√®res d'Inclusion" Style="{StaticResource LabelStyle}"/>
                                            <Button Grid.Column="1" Content="‚ûï Citer" Click="AddCitation_Click" Tag="InclusionTextBox" Height="22" FontSize="10" Padding="5,0" Background="#E0E0E0" Foreground="Black"/>
                                        </Grid>
                                         <TextBox x:Name="InclusionTextBox" Height="80" TextWrapping="Wrap" AcceptsReturn="True" Tag="Ex: √Çge > 18 ans, Consentement sign√©..."/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="2">
                                        <TextBlock Text="Crit√®res de Non-Inclusion" Style="{StaticResource LabelStyle}"/>
                                         <TextBox x:Name="ExclusionTextBox" Height="80" TextWrapping="Wrap" AcceptsReturn="True" Tag="Ex: Comorbidit√©s graves, Grossesse..."/>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- √âTAPE 7 : METHODOLOGIE - Echantillonnage -->
                <ScrollViewer x:Name="View_Methodology_Sampling" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="√âtape 7/14 : M√©thodologie - Echantillonnage" Tag="#FFF8E1" Foreground="#FF6F00">
                            <StackPanel>
                                <Border Background="#FFF9E6" BorderBrush="#FFD700" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,0,0,15">
                                    <StackPanel>
                                        <TextBlock Text="‚öôÔ∏è Configuration de l'√âchantillonnage" FontWeight="Bold" FontSize="13" Margin="0,0,0,10"/>
                                        <TextBlock Text="Type d'√©chantillonnage :" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                        <ComboBox x:Name="SamplingTypeComboBox" Height="32" Padding="8" VerticalContentAlignment="Center" FontSize="12" Margin="0,0,0,10" SelectionChanged="SamplingTypeComboBox_SelectionChanged">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>
                                        <StackPanel x:Name="StratificationPanel" Visibility="Collapsed" Margin="0,0,0,10">
                                            <CheckBox x:Name="IsStratifiedCheckBox" Content="√âchantillonnage stratifi√©" FontSize="11" Margin="0,0,0,5" Checked="IsStratifiedCheckBox_Checked" Unchecked="IsStratifiedCheckBox_Unchecked"/>
                                            <StackPanel x:Name="StratificationDetailsPanel" Visibility="Collapsed">
                                                <TextBlock Text="Crit√®res de stratification :" FontSize="10" Foreground="#666" Margin="15,0,0,2"/>
                                                <TextBox x:Name="StratificationCriteriaTextBox" Height="40" TextWrapping="Wrap" AcceptsReturn="True" Margin="15,0,0,0" FontSize="11" ToolTip="Ex: √Çge, Sexe, R√©gion g√©ographique..."/>
                                            </StackPanel>
                                        </StackPanel>
                                        <StackPanel x:Name="ClusterPanel" Visibility="Collapsed" Margin="0,0,0,10">
                                            <CheckBox x:Name="IsClusterCheckBox" Content="√âchantillonnage en grappe" FontSize="11" Margin="0,0,0,5" Checked="IsClusterCheckBox_Checked" Unchecked="IsClusterCheckBox_Unchecked"/>
                                            <StackPanel x:Name="ClusterDetailsPanel" Visibility="Collapsed">
                                                <Grid Margin="15,0,0,0">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="10"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>
                                                    <StackPanel>
                                                        <TextBlock Text="Taille moyenne des grappes :" FontSize="10" Foreground="#666"/>
                                                        <TextBox x:Name="ClusterSizeTextBox" Height="28" FontSize="11" Foreground="Black" ToolTip="Nombre moyen de sujets par grappe"/>
                                                    </StackPanel>
                                                    <StackPanel Grid.Column="2">
                                                        <TextBlock Text="Effet de plan (Design Effect) :" FontSize="10" Foreground="#666"/>
                                                        <TextBox x:Name="DesignEffectTextBox" Text="1.5" Height="28" FontSize="11" Foreground="Black" ToolTip="G√©n√©ralement entre 1.5 et 2.0"/>
                                                    </StackPanel>
                                                </Grid>
                                            </StackPanel>
                                        </StackPanel>
                                        <Border Background="White" BorderBrush="#FFD700" BorderThickness="1" CornerRadius="4" Margin="0,10,0,0" Padding="10">
                                            <StackPanel>
                                                <TextBlock Text="Gestion des perdus de vue (Attrition)" FontWeight="Bold" FontSize="12" Margin="0,0,0,5"/>
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="15"/>
                                                        <ColumnDefinition Width="80"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Text="Taux estim√© :" VerticalAlignment="Center"/>
                                                    <TextBox Grid.Column="2" x:Name="ExpectedLossRateTextBox" Text="10" Height="35" FontSize="14" FontWeight="Bold" Foreground="Black" Background="White" BorderBrush="Gray" BorderThickness="1" VerticalContentAlignment="Center" HorizontalContentAlignment="Center" Padding="0"/>
                                                    <TextBlock Grid.Column="3" Text="%" VerticalAlignment="Center" Margin="5,0,0,0" FontSize="14"/>
                                                </Grid>
                                                <TextBlock Text="Ce taux sera ajout√© √† la taille calcul√©e pour garantir la puissance statistique." FontSize="10" Foreground="#777" Margin="0,3,0,0" FontStyle="Italic"/>
                                            </StackPanel>
                                        </Border>
                                    </StackPanel>
                                </Border>
                                <Border Background="#F0F4C3" CornerRadius="5" Padding="15" Margin="0,0,0,10" BorderBrush="#CDDC39" BorderThickness="1">
                                    <StackPanel>
                                        <TextBlock Text="‚ûó Assistant de Calcul de Taille d'√âchantillon" FontWeight="Bold" FontSize="14" Foreground="#827717" Margin="0,0,0,10"/>
                                        <Grid Margin="0,0,0,10">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <ColumnDefinition Width="*"/>
                                            </Grid.ColumnDefinitions>
                                            <TextBlock Text="M√©thode :" VerticalAlignment="Center" Margin="0,0,10,0" FontWeight="SemiBold"/>
                                            <ComboBox Grid.Column="1" x:Name="CalculatorSelector" Height="35" VerticalContentAlignment="Center" SelectionChanged="CalculatorSelector_SelectionChanged">
                                                <ComboBoxItem Content="Aucun (Saisie libre)" Tag="None" IsSelected="True"/>
                                                <ComboBoxItem Content="Estimation d'une Pr√©valence (Cochran/Schwartz)" Tag="Cochran"/>
                                                <ComboBoxItem Content="Comparaison de 2 Proportions (Analytique)" Tag="Comparison"/>
                                            </ComboBox>
                                        </Grid>
                                    </StackPanel>
                                </Border>
                                <Border x:Name="PanelCochran" Visibility="Collapsed" Background="#F0F8FF" BorderBrush="#ADD8E6" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,0,0,10">
                                    <StackPanel>
                                        <TextBlock Text="Formule de Cochran / Schwartz (Population Finie ou Infinie)" FontSize="11" Foreground="#555" Margin="0,0,0,5"/>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <StackPanel Margin="0,0,5,0">
                                                <TextBlock Text="Pr√©valence p (%)" FontSize="10"/>
                                                <TextBox x:Name="Calc_Cochran_P" Text="50" Foreground="Black" ToolTip="Ex: 50 pour 50%"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="1" Margin="0,0,5,0">
                                                <TextBlock Text="Pr√©cision d (%)" FontSize="10"/>
                                                <TextBox x:Name="Calc_Cochran_D" Text="5" Foreground="Black" ToolTip="Marge d'erreur, ex: 5%"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="2" Margin="0,0,5,0">
                                                <TextBlock Text="Population N" FontSize="10" FontWeight="Bold"/>
                                                <TextBox x:Name="Calc_Cochran_N" Text="" Foreground="Black" ToolTip="Laisser vide si inconnue/infinie"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="3" Margin="0,0,5,0">
                                                <TextBlock Text="Confiance (Z)" FontSize="10"/>
                                                <ComboBox x:Name="Calc_Cochran_Z" SelectedIndex="1">
                                                    <ComboBoxItem Content="90%" Tag="1.65"/>
                                                    <ComboBoxItem Content="95%" Tag="1.96"/>
                                                    <ComboBoxItem Content="99%" Tag="2.58"/>
                                                </ComboBox>
                                            </StackPanel>
                                            <Button Grid.Column="4" Content="Calculer" Click="CalculateCochran_Click" Padding="10,0" VerticalAlignment="Bottom" Height="22"/>
                                        </Grid>
                                        <TextBlock x:Name="ResultCochran" Text="N = ?" FontWeight="Bold" Foreground="#007ACC" Margin="0,5,0,0" HorizontalAlignment="Right"/>
                                    </StackPanel>
                                </Border>
                                <Border x:Name="PanelComparison" Visibility="Collapsed" Background="#FFF5E5" BorderBrush="#FFDAB9" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,0,0,10">
                                    <StackPanel>
                                        <TextBlock Text="Comparaison de Deux Proportions (Cas-T√©moins / Cohorte)" FontSize="11" Foreground="#555" Margin="0,0,0,5"/>
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <StackPanel Margin="0,0,5,0">
                                                <TextBlock Text="P1 (Expos√©s/Cas) %" FontSize="10"/>
                                                <TextBox x:Name="Calc_Comp_P1" Text="30" Foreground="Black"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="1" Margin="0,0,5,0">
                                                <TextBlock Text="P2 (T√©moins/Non) %" FontSize="10"/>
                                                <TextBox x:Name="Calc_Comp_P2" Text="15" Foreground="Black"/>
                                            </StackPanel>
                                            <StackPanel Grid.Column="2" Margin="0,0,5,0">
                                                <TextBlock Text="Confiance (Alpha)" FontSize="10"/>
                                                <ComboBox x:Name="Calc_Comp_Alpha" SelectedIndex="1">
                                                    <ComboBoxItem Content="5% (1.96)" Tag="1.96"/>
                                                    <ComboBoxItem Content="1% (2.58)" Tag="2.58"/>
                                                </ComboBox>
                                            </StackPanel>
                                            <StackPanel Grid.Column="3" Margin="0,0,5,0">
                                                <TextBlock Text="Puissance (1-Beta)" FontSize="10"/>
                                                <ComboBox x:Name="Calc_Comp_Power" SelectedIndex="1">
                                                    <ComboBoxItem Content="80% (0.84)" Tag="0.84"/>
                                                    <ComboBoxItem Content="90% (1.28)" Tag="1.28"/>
                                                </ComboBox>
                                            </StackPanel>
                                            <StackPanel Grid.Column="4" VerticalAlignment="Bottom">
                                                <CheckBox x:Name="Chk_Matched" Content="Appari√© ?" ToolTip="Cocher si Cas et T√©moins sont appari√©s (Matching)" FontSize="10" Margin="0,0,0,5"/>
                                                <Button Content="Calculer" Click="CalculateComparison_Click" Padding="10,0" Height="22"/>
                                            </StackPanel>
                                        </Grid>
                                        <TextBlock x:Name="ResultComparison" Text="N par groupe = ?" FontWeight="Bold" Foreground="#D2691E" Margin="0,5,0,0" HorizontalAlignment="Right"/>
                                    </StackPanel>
                                </Border>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Texte final sur l'√©chantillonnage :" Style="{StaticResource LabelStyle}"/>
                                    <Button Grid.Column="1" Content="‚ûï Citer" Click="AddCitation_Click" Tag="SamplingTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                 <TextBox x:Name="SamplingTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="D√©taillez la proc√©dure de s√©lection des participants (ex: tirage au sort, recrutement cons√©cutif...)"/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- √âTAPE 8 : METHODOLOGIE - Collecte de donn√©es -->
                <ScrollViewer x:Name="View_Methodology_Data" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="√âtape 8/13 : M√©thodologie - Collecte de donn√©es" Tag="#E0F2F1" Foreground="#00695C">
                            <StackPanel>
                                <Border Background="#E8F5E9" CornerRadius="5" Padding="10" Margin="0,0,0,15" BorderBrush="#4CAF50" BorderThickness="1">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel>
                                            <TextBlock Text="üìù Dictionnaire des Variables / Masque de Saisie" FontWeight="Bold" Foreground="#2E7D32"/>
                                            <TextBlock Text="D√©finissez les variables de l'√©tude (comme dans Epi Info 'Make View')" FontSize="11" Foreground="#555"/>
                                        </StackPanel>
                                        <Button Grid.Column="1" Content="Ouvrir le Concepteur" Padding="15,5" Background="#4CAF50" Foreground="White" BorderThickness="0" Click="OpenVariableDesigner_Click" Cursor="Hand">
                                            <Button.Resources>
                                                <Style TargetType="Border">
                                                    <Setter Property="CornerRadius" Value="4"/>
                                                </Style>
                                            </Button.Resources>
                                        </Button>
                                    </Grid>
                                </Border>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Proc√©dures de Collecte" Style="{StaticResource LabelStyle}"/>
                                    <Button Grid.Column="1" Content="‚ûï Citer" Click="AddCitation_Click" Tag="DataCollectionTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                 <TextBox x:Name="DataCollectionTextBox" Height="250" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10" Tag="D√©crivez les outils (Questionnaires, Mesures cliniques) et les proc√©dures de collecte..."/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- √âTAPE 9 : BUDGET -->
                <ScrollViewer x:Name="View_Budget" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="√âtape 9/14 : Budget &amp; Ressources" Tag="#FFF3E0" Foreground="#EF6C00">
                            <StackPanel>
                                <TextBlock Text="Estimation des Ressources &amp; Budget" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                <Border x:Name="BudgetSuggestionsPanel" Background="#E3F2FD" BorderBrush="#2196F3" BorderThickness="1" CornerRadius="5" Padding="15" Margin="0,0,0,15">
                                    <StackPanel>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                            <TextBlock Text="üí° Suggestions bas√©es sur votre m√©thode :" FontWeight="Bold" Foreground="#1565C0"/>
                                            <TextBlock x:Name="BudgetSuggestionType" Text="(Type)" Margin="5,0,0,0" FontStyle="Italic" Foreground="#1565C0"/>    
                                        </StackPanel>
                                        <TextBlock x:Name="BudgetSuggestionsText" Text="‚Ä¢ Personnel..." TextWrapping="Wrap" FontSize="13"/>
                                    </StackPanel>
                                </Border>
                                <TextBlock Text="D√©tail du Budget" Style="{StaticResource LabelStyle}"/>
                                <TextBox x:Name="BudgetTextBox" Height="200" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15" VerticalContentAlignment="Top" Padding="10"/>
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Total Estim√© (Devise locale) :" VerticalAlignment="Center" FontWeight="Bold"/>
                                    <TextBox Grid.Column="1" x:Name="BudgetTotalBox" Margin="10,0,0,0" Height="30" Width="150" HorizontalAlignment="Left"/>
                                </Grid>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- √âTAPE 10 : CONSIDERATIONS ETHIQUES -->
                <ScrollViewer x:Name="View_Ethics" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                     <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="√âtape 10/14 : Consid√©rations √âthiques" Tag="#FFEBEE" Foreground="#C62828">
                            <StackPanel>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Consid√©rations √âthiques" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                    <Button Grid.Column="1" Content="‚ûï Citer" Click="AddCitation_Click" Tag="EthicsTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                <TextBlock Text="D√©crivez les mesures prises pour prot√©ger les participants (consentement, confidentialit√©, approbation √©thique...)." FontSize="11" Foreground="#666" Margin="0,0,0,5"/>
                                <TextBox x:Name="EthicsTextBox" Height="150" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15"/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- √âTAPE 11 : PLAN D'ANALYSE -->
                <ScrollViewer x:Name="View_DataAnalysis" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="√âtape 11/14 : Plan d'Analyse des Donn√©es" Tag="#EDE7F6" Foreground="#4527A0">
                            <StackPanel>
                                <TextBlock Text="Cette section est CRUCIALE : elle d√©finit comment vous allez r√©pondre √† vos objectifs." FontSize="11" Foreground="#666" Margin="0,0,0,15" FontStyle="Italic"/>
                                <Grid Margin="0,0,0,5">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Description du Plan d'Analyse" Style="{StaticResource LabelStyle}" VerticalAlignment="Center"/>
                                    <Button Grid.Column="1" Content="‚ú® G√©n√©rer Plan Automatique" Click="GenerateProtocolPlan_Click" Height="25" FontSize="11" Padding="12,0" Margin="0,0,8,0" Background="#FFF3E0" Foreground="#E65100" BorderBrush="#FFCC80" BorderThickness="1"/>
                                    <Button Grid.Column="2" Content="‚ûï Citer" Click="AddCitation_Click" Tag="DataAnalysisTextBox" Height="25" FontSize="11" Padding="10,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                <TextBox x:Name="DataAnalysisTextBox" Height="350" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10" Tag="Le plan g√©n√©r√© appara√Ætra ici. Vous pouvez ensuite le modifier librement."/>
                                <Border Background="#E3F2FD" Padding="10" CornerRadius="5">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="‚ÑπÔ∏è" Margin="0,0,10,0"/>
                                        <TextBlock Text="Le plan r√©dig√© ici sera automatiquement disponible dans l'onglet 'Analyse' de la fen√™tre principale." FontSize="11" Foreground="#1565C0" TextWrapping="Wrap"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- √âTAPE 12 : RESULTATS ATTENDUS -->
                <ScrollViewer x:Name="View_Results" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="√âtape 12/14 : R√©sultats Attendus" Tag="#E0F7FA" Foreground="#006064">
                            <StackPanel>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="R√©sultats Attendus" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                    <Button Grid.Column="1" Content="‚ûï Citer" Click="AddCitation_Click" Tag="ExpectedResultsTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                <TextBlock Text="Quels sont les r√©sultats escompt√©s et leur impact ?" FontSize="11" Foreground="#666" Margin="0,0,0,5"/>
                                <TextBox x:Name="ExpectedResultsTextBox" Height="200" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15"/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- √âTAPE 13 : CONCLUSION -->
                <ScrollViewer x:Name="View_Conclusion" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="√âtape 13/13 : Conclusion" Tag="#ECEFF1" Foreground="#37474F">
                            <StackPanel>
                                <Grid Margin="0,0,0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="Conclusion" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                    <Button Grid.Column="1" Content="‚ûï Citer" Click="AddCitation_Click" Tag="ConclusionTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                                </Grid>
                                <TextBlock Text="Synth√®se, retomb√©es et recommandations." FontSize="11" Foreground="#666" Margin="0,0,0,5"/>
                                <TextBox x:Name="ConclusionTextBox" Height="200" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15"/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>

                <!-- √âTAPE 14 : REFERENCES -->
                <ScrollViewer x:Name="View_References" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                    <StackPanel MaxWidth="800">
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="√âtape 14/14 : R√©f√©rences Bibliographiques" Tag="#FAFAFA" Foreground="#424242">
                            <StackPanel>
                                <Grid Margin="0,0,0,10">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="R√©f√©rences Bibliographiques" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                    <ComboBox Grid.Column="1" x:Name="RefStyleComboStep14" Height="30" Width="150" VerticalContentAlignment="Center" SelectionChanged="RefStyleCombo_SelectionChanged" SelectedIndex="0"/>
                                </Grid>
                                <TextBlock Text="Liste g√©n√©r√©e automatiquement :" FontSize="11" Foreground="#666" Margin="0,0,0,5"/>
                                <TextBox x:Name="ReferencesTextBox" Height="500" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" VerticalScrollBarVisibility="Auto" IsReadOnly="False"/>
                                <Button Content="üîÑ R√©g√©n√©rer la liste" Click="RegenerateReferences_Click" HorizontalAlignment="Right" Width="150" Height="30" FontSize="12"/>
                            </StackPanel>
                        </Expander>
                    </StackPanel>
                </ScrollViewer>
            </Grid>
        </Grid>

        <!-- Barre d'action fixe en bas -->
        <Border Grid.Row="2" Background="White" BorderBrush="#EEEEEE" BorderThickness="0,1,0,0" Padding="15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Navigation Gauche -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Content="‚¨ÖÔ∏è Pr√©c√©dent" Click="PrevSection_Click" Height="40" Width="120" Margin="0,0,10,0" Background="#F0F0F0" Foreground="Black" BorderThickness="0"/>
                    <Button Content="Suivant ‚û°Ô∏è" Click="NextSection_Click" Height="40" Width="120" Background="#F0F0F0" Foreground="Black" BorderThickness="0"/>
                </StackPanel>

                <!-- Zone de messages de validation -->
                <ListBox Grid.Column="1" x:Name="ValidationMessagesListBox" BorderThickness="0" Background="Transparent" Foreground="{StaticResource ErrorBrush}" FontSize="12" MaxHeight="60" Margin="20,0,20,0" VerticalAlignment="Center"/>

                <!-- Bouton Action -->
                <Button Grid.Column="2" Content="Valider et Enregistrer" Click="CreateProtocol_Click" Height="45" Width="200" FontSize="15" FontWeight="Bold"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>




FILE: \AdRev.Desktop\Views\Project\ProtocolView.xaml.cs
------------------------------------
using System;
using System.Windows;
using System.Windows.Input;
using System.Windows.Controls;
using System.Windows.Media;
using System.Collections.Generic;
using System.Linq;
using AdRev.Core.Protocols;
using AdRev.Domain.Enums;
using AdRev.Domain.Protocols;
using AdRev.Domain.Models;
using AdRev.Core.Services;
using Microsoft.Win32;
using AdRev.Desktop.Services;
using System.Text.RegularExpressions;
using System.Text;

namespace AdRev.Desktop.Views.Project
{
    public partial class ProtocolView : UserControl
    {
        private readonly ProtocolService _service = new ProtocolService();
        private readonly QualityService _qualityService = new QualityService();
        private readonly WordExportService _wordExportService = new WordExportService();

        private System.Collections.ObjectModel.ObservableCollection<AdRev.Domain.Models.Author> _tempCoAuthors 
            = new System.Collections.ObjectModel.ObservableCollection<AdRev.Domain.Models.Author>();

        private System.Collections.Generic.List<AdRev.Domain.Variables.StudyVariable> _tempVariables 
            = new System.Collections.Generic.List<AdRev.Domain.Variables.StudyVariable>();

        private string _discussionPlan = string.Empty;
        private string _limitations = string.Empty;
        private List<AdRev.Domain.Models.Citation> _citations = new List<AdRev.Domain.Models.Citation>();
        private ReferenceStyle _lastStyle = ReferenceStyle.Vancouver;
        private bool _isSyncingStyle = false;

        private AdRev.Domain.Models.ResearchProject? _project;
        private FunctionalRole _currentRole = FunctionalRole.PrincipalInvestigator;
        private UserAccessLevel _currentAccessLevel = UserAccessLevel.Admin;
        private int _currentStep = 1;
        private const int TotalSteps = 14;

        public ProtocolView()
        {
            InitializeComponent();
            
            // Wire up selection changed and set initial index ONLY after components are initialized
            if (SideMenuListBox != null)
            {
                SideMenuListBox.SelectionChanged += SideMenu_SelectionChanged;
                SideMenuListBox.SelectedIndex = 0;
            }
        }

        public void LoadProject(AdRev.Domain.Models.ResearchProject project, FunctionalRole role = FunctionalRole.PrincipalInvestigator, UserAccessLevel access = UserAccessLevel.Admin)
        {
            _project = project;
            _currentRole = role;
            _currentAccessLevel = access;

            StudyTypeComboBox.ItemsSource = System.Enum.GetValues(typeof(StudyType));
            StudyTypeComboBox.SelectedIndex = 0;
            
            // Note: EpidemiologyTypeComboBox and QualitativeApproachComboBox might be null if not in XAML yet
            if (EpidemiologyTypeComboBox != null)
            {
                EpidemiologyTypeComboBox.ItemsSource = System.Enum.GetValues(typeof(EpidemiologicalStudyType));
                EpidemiologyTypeComboBox.SelectedIndex = 0;
            }

            // ... Initialize other combos ...
            
            CoAuthorsListBox.ItemsSource = _tempCoAuthors;

            if (_project != null)
            {
                TitleTextBox.Text = _project.Title;
                StudyTypeComboBox.SelectedItem = _project.StudyType;
                DomainComboBox.SelectedItem = _project.Domain;
                AuthorInstitutionBox.Text = _project.Institution;
                ProcessAuthors(_project.Authors);
            }
            
            RefStyleComboStep1.ItemsSource = System.Enum.GetValues(typeof(ReferenceStyle));
            RefStyleComboStep1.SelectedItem = ReferenceStyle.Vancouver;

            DomainComboBox.ItemsSource = System.Enum.GetValues(typeof(ScientificDomain));
            DomainComboBox.SelectedIndex = 0;

            UpdateView();
        }

        private void DomainComboBox_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            // Logic moved from ProtocolWindow
        }

        private void ProcessAuthors(string authorsCsv)
        {
            if (string.IsNullOrWhiteSpace(authorsCsv)) return;
            var names = authorsCsv.Split(new[] { ',' }, System.StringSplitOptions.RemoveEmptyEntries);
            foreach (var name in names)
            {
                var trimmed = name.Trim();
                if (string.IsNullOrEmpty(trimmed)) continue;
                
                var parts = trimmed.Split(' ');
                string first = parts[0];
                string last = parts.Length > 1 ? string.Join(" ", parts.Skip(1)) : "";

                _tempCoAuthors.Add(new AdRev.Domain.Models.Author 
                { 
                    FirstName = first, 
                    LastName = last,
                    Institution = _project?.Institution ?? ""
                });
            }
        }

        private void AddCoAuthor_Click(object sender, RoutedEventArgs e)
        {
            if (!string.IsNullOrWhiteSpace(CoAuthFirst.Text) && !string.IsNullOrWhiteSpace(CoAuthLast.Text))
            {
                _tempCoAuthors.Add(new Author 
                { 
                    FirstName = CoAuthFirst.Text, 
                    LastName = CoAuthLast.Text,
                    Institution = CoAuthInst.Text,
                    Email = CoAuthEmail.Text
                });
                
                CoAuthFirst.Clear();
                CoAuthLast.Clear();
                CoAuthInst.Clear();
                CoAuthEmail.Clear();
            }
        }

        private void RemoveCoAuthor_Click(object sender, RoutedEventArgs e)
        {
            if (CoAuthorsListBox.SelectedItem is Author author)
            {
                _tempCoAuthors.Remove(author);
            }
        }

        private void SideMenu_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (SideMenuListBox.SelectedItem is ListBoxItem item && item.Tag != null)
            {
                if (int.TryParse(item.Tag.ToString(), out int step))
                {
                    _currentStep = step;
                    UpdateView();
                }
            }
        }

        private void UpdateView()
        {
            // Reset all to Collapsed
            if (View_Step1 != null) View_Step1.Visibility = Visibility.Collapsed;
            if (View_Introduction != null) View_Introduction.Visibility = Visibility.Collapsed;
            if (View_Objectives != null) View_Objectives.Visibility = Visibility.Collapsed;
            if (View_ConceptualModel != null) View_ConceptualModel.Visibility = Visibility.Collapsed;
            if (View_Methodology_Design != null) View_Methodology_Design.Visibility = Visibility.Collapsed;
            if (View_Methodology_Population != null) View_Methodology_Population.Visibility = Visibility.Collapsed;
            if (View_Methodology_Sampling != null) View_Methodology_Sampling.Visibility = Visibility.Collapsed;
            if (View_Methodology_Data != null) View_Methodology_Data.Visibility = Visibility.Collapsed;
            if (View_Budget != null) View_Budget.Visibility = Visibility.Collapsed;
            if (View_Ethics != null) View_Ethics.Visibility = Visibility.Collapsed;
            if (View_DataAnalysis != null) View_DataAnalysis.Visibility = Visibility.Collapsed;
            if (View_Results != null) View_Results.Visibility = Visibility.Collapsed;
            if (View_Conclusion != null) View_Conclusion.Visibility = Visibility.Collapsed;
            if (View_References != null) View_References.Visibility = Visibility.Collapsed;

            // Sync Side Menu if needed
            if (SideMenuListBox != null && SideMenuListBox.SelectedIndex != _currentStep - 1)
            {
                SideMenuListBox.SelectedIndex = _currentStep - 1;
            }

            // Show current
            switch (_currentStep)
            {
                case 1: if (View_Step1 != null) View_Step1.Visibility = Visibility.Visible; break;
                case 2: if (View_Introduction != null) View_Introduction.Visibility = Visibility.Visible; break;
                case 3: if (View_Objectives != null) View_Objectives.Visibility = Visibility.Visible; break;
                case 4: if (View_ConceptualModel != null) View_ConceptualModel.Visibility = Visibility.Visible; break;
                case 5: 
                    if (View_Methodology_Design != null) View_Methodology_Design.Visibility = Visibility.Visible;
                    UpdateQualityGuidelines((StudyType)StudyTypeComboBox.SelectedItem);
                    break;
                case 6: if (View_Methodology_Population != null) View_Methodology_Population.Visibility = Visibility.Visible; break;
                case 7: if (View_Methodology_Sampling != null) View_Methodology_Sampling.Visibility = Visibility.Visible; break;
                case 8: if (View_Methodology_Data != null) View_Methodology_Data.Visibility = Visibility.Visible; break;
                case 9: 
                    if (View_Budget != null) View_Budget.Visibility = Visibility.Visible; 
                    UpdateBudgetView();
                    break;
                case 10: if (View_Ethics != null) View_Ethics.Visibility = Visibility.Visible; break;
                case 11: if (View_DataAnalysis != null) View_DataAnalysis.Visibility = Visibility.Visible; break;
                case 12: if (View_Results != null) View_Results.Visibility = Visibility.Visible; break;
                case 13: if (View_Conclusion != null) View_Conclusion.Visibility = Visibility.Visible; break;
                case 14: if (View_References != null) View_References.Visibility = Visibility.Visible; break;
            }

            // Apply Permissions
            bool canEdit = CanUserEditStep(_currentStep);
            SetProtocolReadOnly(!canEdit);
        }

        private void NextSection_Click(object sender, RoutedEventArgs e)
        {
            if (_currentStep < TotalSteps)
            {
                _currentStep++;
                UpdateView();
            }
        }

        private void PrevSection_Click(object sender, RoutedEventArgs e)
        {
            if (_currentStep > 1)
            {
                _currentStep--;
                UpdateView();
            }
        }

        private void CreateProtocol_Click(object sender, RoutedEventArgs e)
        {
            ValidationMessagesListBox.Items.Clear();
            var protocol = BuildProtocolFromUI();
            var validator = new AdRev.Core.Protocols.ProtocolValidator();
            var validationResult = validator.Validate(protocol);

            if (validationResult.Score == 100)
            {
                 ValidationMessagesListBox.Items.Add($"üåü EXCELLENT TRAVAIL ! Score Qualit√© : 100/100");
                 ValidationMessagesListBox.Items.Add("Le protocole respecte tous les crit√®res de qualit√©.");
            }
            else
            {
                ValidationMessagesListBox.Items.Add($"üìä Score Qualit√© : {validationResult.Score}/100");
                foreach (var err in validationResult.Errors) ValidationMessagesListBox.Items.Add(err);
                foreach (var sug in validationResult.Suggestions) ValidationMessagesListBox.Items.Add(sug);
            }

            if (validationResult.Errors.Count == 0)
            {
                 string pName = _project != null ? _project.Title : ("Projet_" + DateTime.Now.ToString("yyyyMMdd"));
                 _service.Create(protocol, pName);
                 if (_project != null)
                 {
                     _project.GeneralObjective = protocol.GeneralObjective;
                     _project.SpecificObjectives = protocol.SpecificObjectives;
                     _project.DataAnalysisPlan = protocol.DataAnalysis;
                 }
                 ValidationMessagesListBox.Items.Add($"üíæ Protocole enregistr√© avec succ√®s (ID: {protocol.Id})");
            }
            else
            {
                 ValidationMessagesListBox.Items.Add("üõë Veuillez corriger les erreurs critiques (‚ùå) avant l'enregistrement.");
            }
        }

        private void ExportWord_Click(object sender, RoutedEventArgs e)
        {
            var protocol = BuildProtocolFromUI();
            var dialog = new SaveFileDialog { Filter = "Word Document|*.docx", FileName = $"Protocole_{_project?.Title ?? "Nouveau"}.docx" };
            if (dialog.ShowDialog() == true)
            {
                _wordExportService.ExportProtocolToWord(protocol, dialog.FileName);
                MessageBox.Show("Exportation termin√©e !");
            }
        }

        private void MenuFileNew_Click(object sender, RoutedEventArgs e)
        {
            if (MessageBox.Show("Voulez-vous vraiment r√©initialiser le protocole ?", "Nouveau", MessageBoxButton.YesNo) == MessageBoxResult.Yes)
            {
                TitleTextBox.Clear();
                ContextTextBox.Clear();
                ProblemTextBox.Clear();
                ResearchQuestionTextBox.Clear();
                HypothesesTextBox.Clear();
                GeneralObjectiveTextBox.Clear();
                SpecificObjectivesTextBox.Clear();
                ConceptsTextBox.Clear();
                ConceptualModelTextBox.Clear();
                PopulationTextBox.Clear();
                InclusionTextBox.Clear();
                ExclusionTextBox.Clear();
                SamplingTextBox.Clear();
                DataCollectionTextBox.Clear();
                DataAnalysisTextBox.Clear();
                BudgetTextBox.Clear();
                EthicsTextBox.Clear();
                ExpectedResultsTextBox.Clear();
                ConclusionTextBox.Clear();
                ReferencesTextBox.Clear();
                _citations.Clear();
                _tempCoAuthors.Clear();
                _tempVariables.Clear();
                UpdateView();
            }
        }

        private void MenuDiscussion_Click(object sender, RoutedEventArgs e)
        {
             var type = StudyTypeComboBox.SelectedItem is StudyType st ? st : StudyType.Quantitative;
             var obj = SpecificObjectivesTextBox.Text;
             var style = RefStyleComboStep1.SelectedItem as ReferenceStyle? ?? ReferenceStyle.Vancouver;
             int nextIndex = _citations.Count + 1;
             
             var win = new DiscussionWindow(type, obj, _discussionPlan, _limitations, nextIndex, style);
             if (win.ShowDialog() == true)
             {
                 _discussionPlan = win.DiscussionPlan;
                 _limitations = win.Limitations;
                 if (win.NewCitations.Any())
                 {
                     _citations.AddRange(win.NewCitations);
                     RegenerateReferencesList();
                 }
                 ValidationMessagesListBox.Items.Add("‚úÖ Discussion mise √† jour !");
             }
        }
        
        private void UpdateQualityGuidelines(StudyType studyType)
        {
            if (PanelQualityGuidelines == null) return;
            
            var currentProtocol = BuildProtocolFromUI();

            var dummyProject = new AdRev.Domain.Models.ResearchProject 
            { 
                StudyType = studyType,
                Domain = DomainComboBox.SelectedItem != null ? (ScientificDomain)DomainComboBox.SelectedItem : ScientificDomain.Biomedical
            };
            var checklists = _qualityService.GetRecommendedChecklists(dummyProject);

            if (checklists == null || checklists.Count == 0)
            {
                PanelQualityGuidelines.Visibility = Visibility.Collapsed;
                return;
            }

            var primaryChecklist = checklists.First();
            _qualityService.EvaluateProtocol(primaryChecklist, currentProtocol);

            QualityStandardName.Text = $"({primaryChecklist.Name})";
            QualityGuidelinesList.Children.Clear();

            foreach (var section in primaryChecklist.Sections)
            {
                var txtSection = new TextBlock 
                { 
                    Text = section.Name, 
                    FontWeight = FontWeights.Bold, 
                    Margin = new Thickness(0, 10, 0, 5),
                    Foreground = (Brush)Application.Current.Resources["PrimaryBrush"]
                };
                QualityGuidelinesList.Children.Add(txtSection);

                foreach (var item in section.Items)
                {
                    var cb = new CheckBox 
                    { 
                        Content = new TextBlock { Text = item.Requirement, TextWrapping = TextWrapping.Wrap },
                        Margin = new Thickness(10, 0, 0, 5),
                        IsChecked = item.IsMet,
                        ToolTip = item.IsMet ? "Crit√®re automatiquement valid√© par le contenu saisi" : "Ce crit√®re ne semble pas encore rempli"
                    };
                    QualityGuidelinesList.Children.Add(cb);
                }
            }

            PanelQualityGuidelines.Visibility = Visibility.Visible;
        }

        private void UpdateBudgetView()
        {
            if (BudgetSuggestionType == null || BudgetSuggestionsText == null) return;

            var studyType = (StudyType)StudyTypeComboBox.SelectedItem;
            string suggestions = "";
            string typeDesc = "";

            if (studyType == StudyType.Qualitative)
            {
                typeDesc = "√âtude Qualitative";
                suggestions = "‚Ä¢ √âquipement d'enregistrement (Dictaphones, Cam√©ras)\n" +
                              "‚Ä¢ Frais de d√©placement pour les entretiens (Focus Groups, IDI)\n" +
                              "‚Ä¢ Co√ªts de transcription et traduction\n" +
                              "‚Ä¢ Compensation des participants (collation, transport)\n" +
                              "‚Ä¢ Logiciel d'analyse (NVivo, Atlas.ti)...";
            }
            else if (studyType == StudyType.Quantitative)
            {
                typeDesc = "√âtude Quantitative";
                suggestions = "‚Ä¢ Impression des questionnaires (papier) ou Tablettes (ODK/Kobo)\n" +
                              "‚Ä¢ Formation et Per diem des enqu√™teurs\n" +
                              "‚Ä¢ Superviseurs de terrain\n" +
                              "‚Ä¢ Transport et Logistique de terrain\n" +
                              "‚Ä¢ Saisie et Nettoyage des donn√©es (Data Clerk)...";
            }
            else 
            {
                typeDesc = "M√âTHODE MIXTE";
                suggestions = "‚Ä¢ Combinaison des co√ªts Quantitatifs et Qualitatifs\n" +
                              "‚Ä¢ R√©unions de coordination pour l'int√©gration des donn√©es...";
            }

            BudgetSuggestionType.Text = $"({typeDesc})";
            BudgetSuggestionsText.Text = suggestions;
        }

        private bool CanUserEditStep(int step)
        {
            if (_currentAccessLevel == UserAccessLevel.Admin) return true;
            if (_currentAccessLevel == UserAccessLevel.Viewer) return false;

            switch (_currentRole)
            {
                case FunctionalRole.PrincipalInvestigator:
                    return true;
                case FunctionalRole.Methodologist:
                    return (step != 9);
                case FunctionalRole.Statistician:
                    return (step == 7 || step == 8 || step == 11 || step == 12);
                case FunctionalRole.DataManager:
                    return (step == 1 || step == 8 || step == 9 || step == 11);
                case FunctionalRole.CoInvestigator:
                    return (step != 9 && step != 10);
                case FunctionalRole.Student:
                    return (step <= 6 || step == 12 || step == 13);
                default:
                    return false;
            }
        }

        private void SetProtocolReadOnly(bool isReadOnly)
        {
            foreach (var tb in FindVisualChildren<TextBox>(this))
            {
                tb.IsReadOnly = isReadOnly;
                tb.Opacity = isReadOnly ? 0.8 : 1.0;
            }

            foreach (var cb in FindVisualChildren<ComboBox>(this))
            {
                cb.IsEnabled = !isReadOnly;
                cb.Opacity = isReadOnly ? 0.8 : 1.0;
            }

            foreach (var btn in FindVisualChildren<Button>(this))
            {
                if (btn.Content is string s && (s.Contains("‚ûï") || s.Contains("üóëÔ∏è") || s.Contains("Calculer") || s.Contains("G√©n√©rer")))
                {
                    btn.IsEnabled = !isReadOnly;
                }
            }
        }

        private IEnumerable<T> FindVisualChildren<T>(DependencyObject? depObj) where T : DependencyObject
        {
            if (depObj != null)
            {
                for (int i = 0; i < VisualTreeHelper.GetChildrenCount(depObj); i++)
                {
                    DependencyObject child = VisualTreeHelper.GetChild(depObj, i);
                    if (child != null)
                    {
                        if (child is T t) yield return t;
                        foreach (T childOfChild in FindVisualChildren<T>(child)) yield return childOfChild;
                    }
                }
            }
        }

        private void RefStyleCombo_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (_isSyncingStyle) return;
            
            if (sender is ComboBox cb && cb.SelectedItem is ReferenceStyle style)
            {
                _isSyncingStyle = true;
                if (RefStyleComboStep1 != null && RefStyleComboStep1 != cb) RefStyleComboStep1.SelectedItem = style;
                if (RefStyleComboStep14 != null && RefStyleComboStep14 != cb) RefStyleComboStep14.SelectedItem = style;
                
                UpdateTextCitations(_lastStyle, style);
                _lastStyle = style;
                _isSyncingStyle = false;
                RegenerateReferencesList();
            }
        }

        // --- Objectives Logic ---

        private void ObjectiveTextBox_PreviewKeyDown(object sender, KeyEventArgs e)
        {
            if (e.Key == Key.Enter)
            {
                var textBox = sender as TextBox;
                if (textBox == null) return;

                string? prefixType = textBox.Tag as string;
                if (string.IsNullOrEmpty(prefixType)) return;

                int caretIndex = textBox.CaretIndex;
                int lineIndex = textBox.GetLineIndexFromCharacterIndex(caretIndex);
                string currentLineText = textBox.GetLineText(lineIndex).Trim();

                string nextPrefix = "";

                if (prefixType == "OS")
                {
                    var match = Regex.Match(currentLineText, @"OS(\d+)\.(\d+)");
                    if (match.Success)
                    {
                        int group = int.Parse(match.Groups[1].Value);
                        int sub = int.Parse(match.Groups[2].Value);
                        nextPrefix = $"OS{group}.{sub + 1}: ";
                    }
                    else
                    {
                        for (int i = lineIndex - 1; i >= 0; i--)
                        {
                            string l = textBox.GetLineText(i).Trim();
                            var mUp = Regex.Match(l, @"OS(\d+)\.(\d+)");
                            if (mUp.Success)
                            {
                                int g = int.Parse(mUp.Groups[1].Value);
                                int s = int.Parse(mUp.Groups[2].Value);
                                nextPrefix = $"OS{g}.{s + 1}: ";
                                break;
                            }
                            var mHead = Regex.Match(l, @"Pour.*(?:OG|Objectif)\s*(\d+)");
                            if (mHead.Success)
                            {
                                int g = int.Parse(mHead.Groups[1].Value);
                                nextPrefix = $"OS{g}.1: ";
                                break;
                            }
                        }
                    }

                    if (string.IsNullOrEmpty(nextPrefix))
                    {
                         int count = textBox.Text.Split('\n').Count(l => l.Trim().StartsWith("OS"));
                         nextPrefix = $"OS{count + 1}: "; 
                    }
                }
                else
                {
                    int count = 0;
                    var lines = textBox.Text.Split('\n');
                    foreach(var line in lines) if (line.Trim().StartsWith("OG")) count++;
                    nextPrefix = $"OG{count + 1}: ";
                }

                e.Handled = true;
                string insertion = $"\n{nextPrefix}";
                int insPoint = textBox.CaretIndex;
                textBox.Text = textBox.Text.Insert(insPoint, insertion);
                textBox.CaretIndex = insPoint + insertion.Length;
            }
        }

        private void GeneralObjectiveTextBox_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (OGCountAlert == null || OGBloomAlert == null) return;
            
            var text = GeneralObjectiveTextBox.Text;
            var lines = text.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
            int ogCount = lines.Count(l => l.Trim().StartsWith("OG"));

            OGCountAlert.Visibility = ogCount > 3 ? Visibility.Visible : Visibility.Collapsed;

            bool anyInvalid = false;
            foreach(var line in lines)
            {
                if (line.Trim().StartsWith("OG") && !CheckBloomVerb(line, "OG"))
                {
                    anyInvalid = true;
                    break;
                }
            }
            OGBloomAlert.Visibility = anyInvalid ? Visibility.Visible : Visibility.Collapsed;
            SuggestOSVerbs(text);
        }

        private void SpecificObjectivesTextBox_TextChanged(object sender, TextChangedEventArgs e)
        {
             if (OSCountAlert == null || OSBloomAlert == null) return;
            
            var text = SpecificObjectivesTextBox.Text;
            var lines = text.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
            
            var groups = lines.Where(l => l.Trim().StartsWith("OS"))
                               .GroupBy(l => l.Trim().Split('.')[0])
                               .ToDictionary(g => g.Key, g => g.Count());
            
            bool tooMany = false;
            string alertMsg = "";
            foreach(var kvp in groups)
            {
                if (kvp.Value > 4)
                {
                    tooMany = true;
                    alertMsg = $"‚ö†Ô∏è Trop d'OS pour {kvp.Key} (Max 4). Actuel: {kvp.Value}";
                    break; 
                }
            }

            if (tooMany)
            {
                OSCountAlert.Text = alertMsg;
                OSCountAlert.Visibility = Visibility.Visible;
            }
            else
            {
                int totalOS = lines.Count(l => l.Trim().StartsWith("OS"));
                int ogCount = GeneralObjectiveTextBox.Text.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries).Count(l => l.Trim().StartsWith("OG"));
                if (ogCount == 0) ogCount = 1;
                
                if (totalOS > ogCount * 4) 
                {
                     OSCountAlert.Text = "‚ö†Ô∏è Attention : Titre global > 4 OS par OG.";
                     OSCountAlert.Visibility = Visibility.Visible;
                }
                else
                {
                    OSCountAlert.Visibility = Visibility.Collapsed;
                }
            }

            bool anyInvalid = false;
            foreach(var line in lines)
            {
                if (line.Trim().StartsWith("OS") && !CheckBloomVerb(line, "OS"))
                {
                    anyInvalid = true;
                    break;
                }
            }
            OSBloomAlert.Visibility = anyInvalid ? Visibility.Visible : Visibility.Collapsed;
        }

        private void RenumberOS_Click(object sender, RoutedEventArgs e)
        {
            var text = SpecificObjectivesTextBox.Text;
            if (string.IsNullOrWhiteSpace(text)) return;

            var lines = text.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
            var sb = new StringBuilder();

            int currentGroup = 1;
            int currentSub = 1;

            foreach(var line in lines)
            {
                string l = line.Trim();

                if (l.StartsWith("---") || l.Contains("OG"))
                {
                    var m = Regex.Match(l, @"(\d+)");
                    if (m.Success) currentGroup = int.Parse(m.Value);
                    
                    currentSub = 1;
                    sb.AppendLine(l);
                    continue;
                }

                if (l.StartsWith("OS"))
                {
                    var mContent = Regex.Match(l, @"^OS[\d\.]+[:\s]*(.*)");
                    string content = mContent.Success ? mContent.Groups[1].Value : l;
                    if (string.IsNullOrWhiteSpace(content)) continue;

                    sb.AppendLine($"OS{currentGroup}.{currentSub}: {content}");
                    currentSub++;
                }
                else
                {
                     sb.AppendLine($"OS{currentGroup}.{currentSub}: {l}");
                     currentSub++;
                }
            }
            SpecificObjectivesTextBox.Text = sb.ToString();
        }
        
        private void LinkOSToOG_Click(object sender, RoutedEventArgs e)
        {
             var ogText = GeneralObjectiveTextBox.Text;
             var ogLines = ogText.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries)
                                 .Where(l => l.Trim().StartsWith("OG"))
                                 .ToList();
             
             if (ogLines.Count == 0)
             {
                 MessageBox.Show("Veuillez d'abord d√©finir au moins un Objectif G√©n√©ral (OG1...).");
                 return;
             }
             
             var sb = new StringBuilder();
             if (SpecificObjectivesTextBox.Text.Length < 10)
             {
                 int i = 1;
                 foreach(var og in ogLines)
                 {
                     sb.AppendLine($"--- Pour {og.Trim().Split(':')[0]} ---");
                     sb.AppendLine($"OS{i}.1: ");
                     sb.AppendLine($"OS{i}.2: ");
                     sb.AppendLine();
                     i++;
                 }
                 SpecificObjectivesTextBox.Text = sb.ToString();
             }
             else
             {
                 if (MessageBox.Show("Voulez-vous reformater la zone d'objectifs sp√©cifiques ?", "Reformater", MessageBoxButton.YesNo) == MessageBoxResult.Yes)
                 {
                     int i = 1;
                     foreach(var og in ogLines)
                     {
                         sb.AppendLine($"--- Pour {og.Trim().Split(':')[0]} ---");
                         sb.AppendLine($"OS{i}.1: ");
                         sb.AppendLine($"OS{i}.2: ");
                         i++;
                     }
                     sb.AppendLine();
                     sb.AppendLine("--- Ancien contenu ---");
                     sb.AppendLine(SpecificObjectivesTextBox.Text);
                     SpecificObjectivesTextBox.Text = sb.ToString(); 
                 }
             }
        }

        private bool CheckBloomVerb(string line, string type)
        {
            int colonIndex = line.IndexOf(':');
            string content = colonIndex >= 0 ? line.Substring(colonIndex + 1).Trim() : line.Trim();
            if (string.IsNullOrWhiteSpace(content)) return true;

            var firstWord = content.Split(' ')[0].ToLower();
            var bloomGeneral = new[] { "√©valuer", "analyser", "d√©terminer", "√©tudier", "comparer", "identifier", "comprendre", "explorer", "illustrer", "d√©crire" };
            var bloomSpecific = new[] { "calculer", "lister", "d√©finir", "citer", "nommer", "classer", "estimer", "quantifier", "v√©rifier", "interpr√©ter", "caract√©riser" };
            var allBloom = bloomGeneral.Concat(bloomSpecific).ToArray();
            return allBloom.Any(v => firstWord.StartsWith(v));
        }

        private void SuggestOSVerbs(string ogText)
        {
            if (OSSuggestions == null) return;
            
            string suggestions = "üí° Verbes sugg√©r√©s : ";
            if (ogText.ToLower().Contains("comparer")) suggestions += "D√©crire (groupes), Mesurer (diff√©rences), Tester (hypoth√®se)...";
            else if (ogText.ToLower().Contains("√©valuer")) suggestions += "Estimer, Calculer, Identifier (facteurs)...";
            else if (ogText.ToLower().Contains("d√©crire")) suggestions += "Lister, Caract√©riser, Classifier...";
            else suggestions += "Quantifier, V√©rifier, D√©terminer...";

            OSSuggestions.Text = suggestions;
            OSSuggestions.Visibility = Visibility.Visible;
        }

        // --- Calculators Logic ---

        private void CalculatorSelector_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (PanelCochran == null || PanelComparison == null) return;
            
            PanelCochran.Visibility = Visibility.Collapsed;
            PanelComparison.Visibility = Visibility.Collapsed;

            if (CalculatorSelector.SelectedItem is ComboBoxItem item)
            {
                string? tag = item.Tag?.ToString();
                if (tag == "Cochran") PanelCochran.Visibility = Visibility.Visible;
                else if (tag == "Comparison") PanelComparison.Visibility = Visibility.Visible;
            }
        }

        private void CalculateCochran_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                double p = double.Parse(Calc_Cochran_P.Text) / 100.0;
                double d = double.Parse(Calc_Cochran_D.Text) / 100.0;
                double N_pop = 0;
                if (!string.IsNullOrWhiteSpace(Calc_Cochran_N.Text)) double.TryParse(Calc_Cochran_N.Text, out N_pop);

                var selectedItem = (ComboBoxItem)Calc_Cochran_Z.SelectedItem;
                double z = double.Parse(selectedItem.Tag?.ToString() ?? "1.96", System.Globalization.CultureInfo.InvariantCulture);

                double n0 = (Math.Pow(z, 2) * p * (1 - p)) / Math.Pow(d, 2);
                double nFinal = n0;
                string formulaUsed = "Cochran (population infinie)";

                if (N_pop > 0)
                {
                    nFinal = n0 / (1 + ((n0 - 1) / N_pop));
                    formulaUsed = $"Schwartz (population finie N={N_pop})";
                }

                int nCeiling = (int)Math.Ceiling(nFinal);
                ResultCochran.Text = $"N requis = {nCeiling} sujets";
                SamplingTextBox.Text = $"La taille d'√©chantillon minimal a √©t√© calcul√©e selon la formule de {formulaUsed}. " +
                                       $"Avec une pr√©valence attendue de {p*100}%, une marge d'erreur de {d*100}% et un niveau de confiance de 95% (Z={z}), " +
                                       $"le nombre de sujets requis est de {nCeiling}.";
            }
            catch { MessageBox.Show("V√©rifiez vos valeurs num√©riques."); }
        }

        private void CalculateComparison_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                double p1 = double.Parse(Calc_Comp_P1.Text) / 100.0;
                double p2 = double.Parse(Calc_Comp_P2.Text) / 100.0;
                var itemAlpha = (ComboBoxItem)Calc_Comp_Alpha.SelectedItem;
                double zAlpha = double.Parse(itemAlpha.Tag?.ToString() ?? "1.96", System.Globalization.CultureInfo.InvariantCulture); 
                var itemBeta = (ComboBoxItem)Calc_Comp_Power.SelectedItem;
                double zBeta = double.Parse(itemBeta.Tag?.ToString() ?? "1.28", System.Globalization.CultureInfo.InvariantCulture);

                bool isMatched = Chk_Matched.IsChecked == true;
                double nFinal = 0;

                if (!isMatched)
                {
                    double numerator = Math.Pow(zAlpha + zBeta, 2) * ( (p1*(1-p1)) + (p2*(1-p2)) );
                    double denominator = Math.Pow(p1 - p2, 2);
                    if (denominator == 0) return;
                    nFinal = Math.Ceiling(numerator / denominator);
                    ResultComparison.Text = $"N = {nFinal} par groupe (Total: {nFinal*2})";
                    SamplingTextBox.Text = $"Pour mettre en √©vidence une diff√©rence entre P1={Calc_Comp_P1.Text}% et P2={Calc_Comp_P2.Text}% " +
                                           $"avec une puissance de 80% et un risque alpha de 5%, la taille d'√©chantillon requise est de {nFinal} sujets par groupe.";
                }
                else
                {
                    double phi = 0.2; 
                    double term1 = p1 * (1 - p1);
                    double term2 = p2 * (1 - p2);
                    double termCorr = 2 * phi * Math.Sqrt(term1 * term2);
                    double numerator = Math.Pow(zAlpha + zBeta, 2) * (term1 + term2 - termCorr);
                    double denominator = Math.Pow(p1 - p2, 2);
                    if (denominator == 0) return;
                    nFinal = Math.Ceiling(numerator / denominator);
                    ResultComparison.Text = $"N = {nFinal} PAIRES";
                    SamplingTextBox.Text = $"S'agissant d'une √©tude appari√©e, avec P1={Calc_Comp_P1.Text}% et P2={Calc_Comp_P2.Text}%, " +
                                           $"il est n√©cessaire d'inclure {nFinal} PAIRES de sujets.";
                }
            }
            catch { MessageBox.Show("Erreur de calcul."); }
        }

        // --- Citation Management ---

        private void AddCitation_Click(object sender, RoutedEventArgs e)
        {
            var btn = sender as Button;
            var targetTag = btn?.Tag?.ToString();
            TextBox? targetBox = null;

            if (targetTag == "Context") targetBox = ContextTextBox;
            else if (targetTag == "ProblemTextBox") targetBox = ProblemTextBox;
            else if (targetTag == "StudySettingTextBox") targetBox = StudySettingTextBox;
            else if (targetTag == "ConceptualModelTextBox") targetBox = ConceptualModelTextBox;
            else if (targetTag == "InclusionTextBox") targetBox = InclusionTextBox;
            else if (targetTag == "SamplingTextBox") targetBox = SamplingTextBox;
            else if (targetTag == "DataCollectionTextBox") targetBox = DataCollectionTextBox;
            else if (targetTag == "EthicsTextBox") targetBox = EthicsTextBox;
            else if (targetTag == "DataAnalysisTextBox") targetBox = DataAnalysisTextBox;
            else if (targetTag == "ExpectedResultsTextBox") targetBox = ExpectedResultsTextBox;
            else if (targetTag == "ConclusionTextBox") targetBox = ConclusionTextBox;

            var style = RefStyleComboStep1.SelectedItem as ReferenceStyle? ?? ReferenceStyle.Vancouver;
            var win = new CitationEntryWindow();
            if (win.ShowDialog() == true && win.ResultCitations.Any())
            {
                foreach (var cit in win.ResultCitations)
                {
                    _citations.Add(cit);
                    
                    if (targetBox != null)
                    {
                        string marker = (style == ReferenceStyle.Vancouver) ? $"[{_citations.Count}]" : $"({cit.Authors}, {cit.Year})";
                        int caret = targetBox.CaretIndex;
                        targetBox.Text = targetBox.Text.Insert(caret, " " + marker);
                        targetBox.CaretIndex = caret + marker.Length + 1;
                    }
                }
                RegenerateReferencesList();
            }
        }

        private void RegenerateReferences_Click(object sender, RoutedEventArgs e) => RegenerateReferencesList();

        private void RegenerateReferencesList()
        {
            if (ReferencesTextBox == null) return;
            var style = RefStyleComboStep1.SelectedItem as ReferenceStyle? ?? ReferenceStyle.Vancouver;
            var sb = new StringBuilder();
            for (int i = 0; i < _citations.Count; i++)
            {
                var c = _citations[i];
                if (style == ReferenceStyle.Vancouver) sb.AppendLine($"{i + 1}. {c.Authors}. {c.Title}. {c.Journal}. {c.Year};{c.Volume}({c.Issue}):{c.Pages}.");
                else sb.AppendLine($"{c.Authors} ({c.Year}). {c.Title}. {c.Journal}, {c.Volume}({c.Issue}), {c.Pages}.");
            }
            ReferencesTextBox.Text = sb.ToString();
        }

        private void UpdateTextCitations(ReferenceStyle oldStyle, ReferenceStyle newStyle)
        {
            var boxes = new List<TextBox> { ContextTextBox, ProblemTextBox, ResearchQuestionTextBox, HypothesesTextBox, GeneralObjectiveTextBox, SpecificObjectivesTextBox, ConceptsTextBox, ConceptualModelTextBox, StudySettingTextBox, PopulationTextBox, StudyCentersTextBox, InclusionTextBox, ExclusionTextBox, SamplingTextBox, DataCollectionTextBox, DataAnalysisTextBox, BudgetTextBox, EthicsTextBox, ExpectedResultsTextBox, ConclusionTextBox };
            foreach (var box in boxes)
            {
                if (box == null || string.IsNullOrEmpty(box.Text)) continue;
                string text = box.Text;
                for (int i = 0; i < _citations.Count; i++)
                {
                    var cit = _citations[i];
                    string oldMarker = (oldStyle == ReferenceStyle.Vancouver) ? $"[{i + 1}]" : $"({cit.Authors}, {cit.Year})";
                    string newMarker = (newStyle == ReferenceStyle.Vancouver) ? $"[{i + 1}]" : $"({cit.Authors}, {cit.Year})";
                    if (text.Contains(oldMarker)) text = text.Replace(oldMarker, newMarker);
                }
                box.Text = text;
            }
            if (!string.IsNullOrEmpty(_discussionPlan)) _discussionPlan = UpdateStringCitations(_discussionPlan, oldStyle, newStyle);
            if (!string.IsNullOrEmpty(_limitations)) _limitations = UpdateStringCitations(_limitations, oldStyle, newStyle);
        }

        private string UpdateStringCitations(string text, ReferenceStyle oldStyle, ReferenceStyle newStyle)
        {
            if (string.IsNullOrEmpty(text)) return text;
            for (int i = 0; i < _citations.Count; i++)
            {
                var cit = _citations[i];
                string oldMarker = (oldStyle == ReferenceStyle.Vancouver) ? $"[{i + 1}]" : $"({cit.Authors}, {cit.Year})";
                string newMarker = (newStyle == ReferenceStyle.Vancouver) ? $"[{i + 1}]" : $"({cit.Authors}, {cit.Year})";
                if (text.Contains(oldMarker)) text = text.Replace(oldMarker, newMarker);
            }
            return text;
        }

        // --- Protocol Building ---

        private ResearchProtocol BuildProtocolFromUI()
        {
            return new ResearchProtocol
            {
                Id = Guid.NewGuid().ToString(),
                ProjectId = _project?.Id,
                Title = TitleTextBox?.Text ?? "",
                StudyType = StudyTypeComboBox?.SelectedItem is StudyType st ? st : StudyType.Quantitative,
                Domain = DomainComboBox?.SelectedItem is ScientificDomain sd ? sd : ScientificDomain.Biomedical,
                PrincipalAuthor = new Author { FirstName = AuthorFirstNameBox?.Text ?? "", LastName = AuthorLastNameBox?.Text ?? "", Institution = AuthorInstitutionBox?.Text ?? "", Email = AuthorEmailBox?.Text ?? "" },
                Context = ContextTextBox?.Text ?? "",
                ProblemJustification = ProblemTextBox?.Text ?? "",
                ResearchQuestion = ResearchQuestionTextBox?.Text ?? "",
                Hypotheses = HypothesesTextBox?.Text ?? "",
                GeneralObjective = GeneralObjectiveTextBox?.Text ?? "",
                SpecificObjectives = SpecificObjectivesTextBox?.Text ?? "",
                ConceptDefinitions = ConceptsTextBox?.Text ?? "",
                StudySetting = StudySettingTextBox?.Text ?? "",
                ConceptualModel = ConceptualModelTextBox?.Text ?? "",
                IsMulticentric = IsMulticentricCheckBox?.IsChecked == true,
                StudyCenters = StudyCentersTextBox?.Text ?? "",
                StudyPopulation = PopulationTextBox?.Text ?? "",
                InclusionCriteria = InclusionTextBox?.Text ?? "",
                ExclusionCriteria = ExclusionTextBox?.Text ?? "",
                SamplingType = SamplingTypeComboBox?.SelectedItem is SamplingType sm ? sm : SamplingType.None,
                IsStratified = IsStratifiedCheckBox?.IsChecked == true,
                StratificationCriteria = StratificationCriteriaTextBox?.Text ?? "",
                IsClusterSampling = IsClusterCheckBox?.IsChecked == true,
                ClusterSize = int.TryParse(ClusterSizeTextBox?.Text, out int cs) ? cs : 0,
                DesignEffect = double.TryParse(DesignEffectTextBox?.Text, out double de) ? de : 1.0,
                ExpectedLossRate = double.TryParse(ExpectedLossRateTextBox?.Text, out double lr) ? lr : 0.0,
                SamplingMethod = SamplingTextBox?.Text ?? "",
                DataCollection = DataCollectionTextBox?.Text ?? "",
                DataAnalysis = DataAnalysisTextBox?.Text ?? "",
                DiscussionPlan = _discussionPlan,
                StudyLimitations = _limitations,
                Budget = BudgetTextBox?.Text ?? "",
                Ethics = EthicsTextBox?.Text ?? "",
                ExpectedResults = ExpectedResultsTextBox?.Text ?? "",
                Conclusion = ConclusionTextBox?.Text ?? "",
                References = ReferencesTextBox?.Text ?? "",
                ReferenceStyle = RefStyleComboStep1?.SelectedItem is ReferenceStyle rs ? rs : ReferenceStyle.Vancouver,
                Citations = _citations
            };
        }

        // --- SAP/TAP Generation ---

        private void GenerateProtocolPlan_Click(object sender, RoutedEventArgs e)
        {
            string specObjs = SpecificObjectivesTextBox.Text;
            if (string.IsNullOrWhiteSpace(specObjs)) { MessageBox.Show("D√©finissez d'abord vos Objectifs Sp√©cifiques (√âtape 3)."); return; }
            var studyType = (StudyType)StudyTypeComboBox.SelectedItem;
            var sb = new StringBuilder();
            if (studyType == StudyType.Qualitative) GenerateThematicAnalysisPlan(sb, specObjs);
            else GenerateStatisticalAnalysisPlan(sb, specObjs);
            DataAnalysisTextBox.Text = sb.ToString();
            MessageBox.Show("Plan d'analyse g√©n√©r√© !");
        }

        private void GenerateThematicAnalysisPlan(StringBuilder sb, string specObjs)
        {
            sb.AppendLine("PLAN D'ANALYSE TH√âMATIQUE (TAP) - Cadre de Braun & Clarke");
            sb.AppendLine("==============================================");
            sb.AppendLine("1. Familiarisation; 2. Codage; 3. Recherche de th√®mes; 4. Revue; 5. D√©finition; 6. Rapport.");
            sb.AppendLine("\nAnalyses sp√©cifiques :");
            int idx = 1;
            foreach (var line in specObjs.Split('\n')) 
                if (!string.IsNullOrWhiteSpace(line) && line.Contains(":")) sb.AppendLine($"{idx++}. Pour : {line.Trim()}\n   -> Exploration th√©matique r√©flexive.");
        }

        private void GenerateStatisticalAnalysisPlan(StringBuilder sb, string specObjs)
        {
            sb.AppendLine("PLAN D'ANALYSE STATISTIQUE (SAP)");
            sb.AppendLine("==================================");
            sb.AppendLine("1. ANALYSE DESCRIPTIVE : Fr√©quences, Moyennes/M√©dianes.");
            sb.AppendLine("2. ANALYSES INF√âRENTIELLES :");
            int idx = 1;
            foreach (var line in specObjs.Split('\n'))
            {
                if (string.IsNullOrWhiteSpace(line) || !line.Contains(":")) continue;
                sb.Append($"2.{idx++} Pour : {line.Trim()}\n   -> Test sugg√©r√© : ");
                string l = line.ToLower();
                if (l.Contains("comparer")) sb.AppendLine("T-Test / ANOVA / Chi2.");
                else if (l.Contains("associer") || l.Contains("facteur")) sb.AppendLine("R√©gression / Chi2.");
                else sb.AppendLine("Estimation IC95%.");
            }
        }

        // --- Other Handlers ---

        private void OpenVariableDesigner_Click(object sender, RoutedEventArgs e)
        {
            var win = new VariableDesignerWindow(_tempVariables, _project?.Title ?? "Nouveau Projet");
            if (win.ShowDialog() == true) _tempVariables = win.Variables.ToList();
        }

        private void StudyTypeComboBox_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (QualitativeTypePanel == null || EpidemiologyTypePanel == null) return;
            var st = (StudyType)StudyTypeComboBox.SelectedItem;
            QualitativeTypePanel.Visibility = st == StudyType.Qualitative ? Visibility.Visible : Visibility.Collapsed;
            EpidemiologyTypePanel.Visibility = st == StudyType.Quantitative ? Visibility.Visible : Visibility.Collapsed;
            UpdateQualityGuidelines(st);
        }

        private void EpidemiologyTypeComboBox_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
             UpdateQualityGuidelines((StudyType)StudyTypeComboBox.SelectedItem);
        }

        private void SamplingTypeComboBox_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (StratificationPanel == null || ClusterPanel == null) return;
            var type = (SamplingType)SamplingTypeComboBox.SelectedItem;
            StratificationPanel.Visibility = (type == SamplingType.Stratified || type == SamplingType.StratifiedCluster) ? Visibility.Visible : Visibility.Collapsed;
            ClusterPanel.Visibility = (type == SamplingType.ClusterSampling || type == SamplingType.StratifiedCluster || type == SamplingType.MultiStage) ? Visibility.Visible : Visibility.Collapsed;
        }

        private void IsMulticentricCheckBox_Checked(object sender, RoutedEventArgs e) { if (MulticentricDetailsPanel != null) MulticentricDetailsPanel.Visibility = Visibility.Visible; }
        private void IsMulticentricCheckBox_Unchecked(object sender, RoutedEventArgs e) { if (MulticentricDetailsPanel != null) MulticentricDetailsPanel.Visibility = Visibility.Collapsed; }
        private void IsStratifiedCheckBox_Checked(object sender, RoutedEventArgs e) { if (StratificationDetailsPanel != null) StratificationDetailsPanel.Visibility = Visibility.Visible; }
        private void IsStratifiedCheckBox_Unchecked(object sender, RoutedEventArgs e) { if (StratificationDetailsPanel != null) StratificationDetailsPanel.Visibility = Visibility.Collapsed; }
        private void IsClusterCheckBox_Checked(object sender, RoutedEventArgs e) { if (ClusterDetailsPanel != null) ClusterDetailsPanel.Visibility = Visibility.Visible; }
        private void IsClusterCheckBox_Unchecked(object sender, RoutedEventArgs e) { if (ClusterDetailsPanel != null) ClusterDetailsPanel.Visibility = Visibility.Collapsed; }
        private void RefreshAudit_LostFocus(object sender, RoutedEventArgs e) => UpdateQualityGuidelines((StudyType)StudyTypeComboBox.SelectedItem);
    }
}




FILE: \AdRev.Desktop\Views\Project\QualitativeAnalysisView.xaml
------------------------------------
<UserControl x:Class="AdRev.Desktop.Views.Project.QualitativeAnalysisView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:AdRev.Desktop"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1200">
    <ScrollViewer VerticalScrollBarVisibility="Auto" Background="#F1F4F6">
        <Grid Margin="30">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <!-- Title -->
                <RowDefinition Height="Auto"/> <!-- Stats Cards -->
                <RowDefinition Height="*"/>    <!-- Visuals -->
            </Grid.RowDefinitions>

            <StackPanel Margin="0,0,0,30">
                <TextBlock Text="Tableau de Bord Qualitatif" FontSize="28" FontWeight="Bold" Foreground="#2C3E50"/>
                <TextBlock Text="Synth√®se de l'analyse qualitative et th√®mes √©mergents" FontSize="14" Foreground="#7F8C8D"/>
            </StackPanel>

            <!-- Cards -->
            <Grid Grid.Row="1" Margin="0,0,0,20">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <Border Style="{StaticResource CardStyle}" Margin="0,0,10,0">
                    <StackPanel>
                        <TextBlock Text="0" FontSize="32" FontWeight="Bold" Foreground="{StaticResource SecondaryBrush}" x:Name="TxtVerbatimCount"/>
                        <TextBlock Text="Verbatims Analys√©s" Foreground="#888"/>
                    </StackPanel>
                </Border>
                <Border Grid.Column="1" Style="{StaticResource CardStyle}" Margin="5,0,5,0">
                    <StackPanel>
                        <TextBlock Text="0" FontSize="32" FontWeight="Bold" Foreground="#E65100" x:Name="TxtCodeCount"/>
                        <TextBlock Text="Codes Identifi√©s" Foreground="#888"/>
                    </StackPanel>
                </Border>
                <Border Grid.Column="2" Style="{StaticResource CardStyle}" Margin="10,0,0,0">
                    <StackPanel>
                        <TextBlock Text="0" FontSize="32" FontWeight="Bold" Foreground="{StaticResource PrimaryBrush}" x:Name="TxtThemeCount"/>
                        <TextBlock Text="Th√®mes Majeurs" Foreground="#888"/>
                    </StackPanel>
                </Border>
            </Grid>

            <Grid Grid.Row="2">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*"/>
                    <ColumnDefinition Width="1*"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Grid.Column="0" Margin="0,0,15,0">
                    <Border Style="{StaticResource CardStyle}" Margin="0,0,0,20" Height="300">
                        <Grid>
                            <TextBlock Text="Nuage de Mots (Fr√©quence)" FontSize="16" FontWeight="Bold" VerticalAlignment="Top"/>
                            <Canvas x:Name="WordCloudCanvas" Margin="0,30,0,0">
                                <TextBlock Text="Aucune donn√©e" FontSize="14" Foreground="#CCC" Canvas.Left="10" Canvas.Top="10"/>
                            </Canvas>
                        </Grid>
                    </Border>
                    
                    <Border Style="{StaticResource CardStyle}">
                        <StackPanel x:Name="EmergingThemesPanel">
                            <TextBlock Text="Th√®mes √âmergents (IA)" FontSize="16" FontWeight="Bold" Margin="0,0,0,10"/>
                            <TextBlock Text="Aucun th√®me identifi√©" FontStyle="Italic" Foreground="#AAA" HorizontalAlignment="Center" Margin="0,20"/>
                        </StackPanel>
                    </Border>
                </StackPanel>
                
                <StackPanel Grid.Column="1">
                    <Border Style="{StaticResource CardStyle}">
                        <StackPanel>
                            <TextBlock Text="Fr√©quence des Codes" FontSize="16" FontWeight="Bold" Margin="0,0,0,15"/>
                            <ListBox x:Name="CodeFrequencyList" BorderThickness="0" Background="Transparent" AlternationCount="2"/>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Grid>
        </Grid>
    </ScrollViewer>
</UserControl>




FILE: \AdRev.Desktop\Views\Project\QualitativeAnalysisView.xaml.cs
------------------------------------
using System;
using System.Collections.Generic;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Documents;
using System.Windows.Media;
using AdRev.Domain.Models;

namespace AdRev.Desktop.Views.Project
{
    public partial class QualitativeAnalysisView : UserControl
    {
        private ResearchProject? _project;

        public QualitativeAnalysisView()
        {
            InitializeComponent();
        }

        public void LoadProject(ResearchProject project)
        {
            _project = project;
            UpdateDashboard();
        }

        private void UpdateDashboard()
        {
            if (_project == null) return;

            // Mock/Simplified calculation
            int verbatimCount = _project.QualitativeSources?.Count ?? 0;
            int codeCount = _project.QualitativeCodes?.Count ?? 0;
            
            TxtVerbatimCount.Text = verbatimCount.ToString();
            TxtCodeCount.Text = codeCount.ToString();
            TxtThemeCount.Text = "0"; // Theme property no longer exists on QualitativeCode

            // Word Cloud & Frequency would need actual content parsing
            // For now, we show placeholders or basic list
            CodeFrequencyList.Items.Clear();
            if (_project.QualitativeCodes != null)
            {
                foreach (var code in _project.QualitativeCodes.Take(10))
                {
                    CodeFrequencyList.Items.Add($"{code.Name} ({new Random().Next(1, 10)})");
                }
            }
        }
    }
}




FILE: \AdRev.Desktop\Views\Project\QualitativeCodingView.xaml
------------------------------------
<UserControl x:Class="AdRev.Desktop.Views.Project.QualitativeCodingView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:AdRev.Desktop"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1200">
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="250"/> <!-- Sources List -->
            <ColumnDefinition Width="*"/>   <!-- Editor -->
            <ColumnDefinition x:Name="ColQualMap" Width="0"/> <!-- Map column, hidden by default -->
            <ColumnDefinition Width="280"/> <!-- Codebook -->
        </Grid.ColumnDefinitions>

         <!-- LEFT: Project Explorer -->
        <Border Background="#F9F9F9" BorderBrush="#EEE" BorderThickness="0,0,1,0" Padding="15">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <StackPanel Grid.Row="0">
                    <TextBlock Text="Explorateur" FontWeight="Bold" Margin="0,0,0,15" FontSize="14" Foreground="#333"/>
                    
                    <Expander Header="Cas &amp; Classifications" IsExpanded="False" Margin="0,0,0,10" Background="Transparent" BorderThickness="0">
                        <StackPanel Margin="10,5,0,0">
                            <Button Content="Noeuds de Cas (Cases)" HorizontalAlignment="Left" Background="Transparent" BorderThickness="0" FontSize="13" Margin="0,2" Foreground="#444" Cursor="Hand"/>
                            <Button Content="Feuilles de Classification" HorizontalAlignment="Left" Background="Transparent" BorderThickness="0" FontSize="13" Margin="0,2" Foreground="#444" Cursor="Hand"/>
                        </StackPanel>
                    </Expander>

                    <Separator Background="#E0E0E0" Margin="0,0,0,10"/>

                    <TextBlock Text="Sources" FontWeight="SemiBold" Margin="0,0,0,8" Foreground="#555"/>
                    <UniformGrid Columns="2" Margin="0,0,0,10">
                        <Button x:Name="BtnImportFiles" Click="ImportFiles_Click" Content="+ Fichiers" Margin="0,0,5,0"/>
                        <Button x:Name="BtnImportFolder" Click="ImportFolder_Click" Content="+ Dossier" Margin="5,0,0,0"/>
                    </UniformGrid>
                    
                    <TextBlock Text="Saisie Rapide" FontWeight="SemiBold" Margin="0,10,0,8" Foreground="#555"/>
                    <Button x:Name="BtnNewInterview" Click="NewInterview_Click" Content="Entretien Individuel" HorizontalAlignment="Left" Background="Transparent" BorderThickness="0" FontSize="13" Margin="0,2" Foreground="#444" Cursor="Hand"/>
                    <Button x:Name="BtnNewFocusGroup" Click="NewFocusGroup_Click" Content="Focus Group" HorizontalAlignment="Left" Background="Transparent" BorderThickness="0" FontSize="13" Margin="0,2" Foreground="#444" Cursor="Hand"/>
                </StackPanel>
                
                <ListBox x:Name="SourceFilesList" Grid.Row="1" Background="Transparent" BorderThickness="0" SelectionChanged="SourceFilesList_SelectionChanged">
                    <!-- Les fichiers import√©s appara√Ætront ici -->
                </ListBox>
            </Grid>
        </Border>

        <!-- CENTER: Coding Editor -->
        <Grid Grid.Column="1" Background="White">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/> <!-- Media Controls -->
            </Grid.RowDefinitions>
            
            <Border BorderBrush="#EEE" BorderThickness="0,0,0,1" Padding="10">
                <StackPanel Orientation="Horizontal">
                    <TextBlock x:Name="CurrentFileNameTextBlock" Text="Aucun fichier" FontWeight="Bold" VerticalAlignment="Center" Margin="10,0,20,0"/>
                    <TextBlock x:Name="CodingHintTextBlock" Text="S√©lectionnez du texte et cliquez sur un code √† droite pour encoder." Foreground="#444" VerticalAlignment="Center" FontStyle="Italic"/>
                </StackPanel>
            </Border>

            <Grid Grid.Row="1">
                <RichTextBox x:Name="CodingRichTextBox" BorderThickness="0" Padding="30" FontSize="16" FontFamily="Calibri">
                    <FlowDocument>
                        <Paragraph>Importez un fichier texte ou Word pour commencer le codage qualitatif.</Paragraph>
                    </FlowDocument>
                </RichTextBox>
                <Image x:Name="CodingImageHost" Stretch="Uniform" Visibility="Collapsed" Margin="20"/>
                <Grid x:Name="CodingVideoHost" Visibility="Collapsed" Background="Black">
                    <MediaElement x:Name="CodingMediaElement" LoadedBehavior="Manual" Stretch="Uniform"/>
                </Grid>
            </Grid>

            <Border x:Name="MediaControlsPanel" Grid.Row="2" Background="#F1F1F1" Padding="10" Visibility="Collapsed">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                    <Button Content="Play" Click="MediaPlay_Click" Width="60" Margin="5,0"/>
                    <Button Content="Pause" Click="MediaPause_Click" Width="60" Margin="5,0"/>
                    <Button Content="Stop" Click="MediaStop_Click" Width="60" Margin="5,0"/>
                </StackPanel>
            </Border>
        </Grid>

        <!-- RIGHT: Codebook -->
        <Border Grid.Column="3" Background="#F9F9F9" BorderBrush="#EEE" BorderThickness="1,0,0,0" Padding="15">
            <StackPanel>
                <TextBlock Text="Codes &amp; Th√®mes" FontWeight="Bold" Margin="0,0,0,15"/>
                
                <StackPanel x:Name="CodeListPanel">
                    <!-- Les codes et th√®mes appara√Ætront ici -->
                </StackPanel>

                <Border x:Name="NewCodeInputPanel" Visibility="Collapsed" Background="White" BorderBrush="#DDD" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,15,0,0">
                    <StackPanel>
                        <TextBlock Text="Th√®me :" FontSize="12" Margin="0,0,0,5"/>
                        <ComboBox x:Name="NewCodeThemeComboBox" IsEditable="True" Margin="0,0,0,10" Height="30"/>
                        <TextBlock Text="Code :" FontSize="12" Margin="0,0,0,5"/>
                        <TextBox x:Name="NewCodeNameTextBox" Margin="0,0,0,10" Height="30"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button Content="Annuler" Click="CancelNewCode_Click" Background="Transparent" Margin="0,0,5,0"/>
                            <Button Content="Ajouter" Click="ConfirmNewCode_Click"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
                
                <Button x:Name="BtnNewCode" Content="+ Nouveau Code" Click="ShowNewCodePanel_Click" Margin="0,20,0,0"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>




FILE: \AdRev.Desktop\Views\Project\QualitativeCodingView.xaml.cs
------------------------------------
using System;
using System.Collections.Generic;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Documents;
using System.Windows.Media;
using AdRev.Domain.Models;
using AdRev.Domain.Variables;
using AdRev.Domain.Enums;
using Microsoft.Win32;

namespace AdRev.Desktop.Views.Project
{
    public partial class QualitativeCodingView : UserControl
    {
        private ResearchProject? _project;

        public QualitativeCodingView()
        {
            InitializeComponent();
        }

        public void LoadProject(ResearchProject project)
        {
            _project = project;
            UpdateQualitativeSourcesUI();
        }

        private void UpdateQualitativeSourcesUI()
        {
            SourceFilesList.Items.Clear();
            if (_project == null) return;

            foreach (var source in _project.QualitativeSources)
            {
                var item = new ListBoxItem
                {
                    Content = source.Name,
                    Tag = source
                };
                SourceFilesList.Items.Add(item);
            }
        }

        private void ImportFiles_Click(object sender, RoutedEventArgs e)
        {
            if (_project == null) return;

            var openFileDialog = new OpenFileDialog
            {
                Multiselect = true,
                Filter = "Tous les fichiers|*.*|Documents Word|*.docx;*.doc|Fichiers Texte|*.txt|Images|*.jpg;*.png;*.bmp|Vid√©os|*.mp4;*.avi;*.mov"
            };

            if (openFileDialog.ShowDialog() == true)
            {
                foreach (string filename in openFileDialog.FileNames)
                {
                    _project.QualitativeSources.Add(new QualitativeSource
                    {
                        Name = System.IO.Path.GetFileName(filename),
                        FilePath = filename,
                        Type = System.IO.Path.GetExtension(filename).TrimStart('.').ToUpper(),
                        ImportDate = DateTime.Now
                    });
                }
                UpdateQualitativeSourcesUI();
            }
        }

        private void ImportFolder_Click(object sender, RoutedEventArgs e)
        {
            // Implementation similar to MainWindow
        }

        private void SourceFilesList_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (SourceFilesList.SelectedItem is ListBoxItem item && item.Tag is QualitativeSource source)
            {
                CurrentFileNameTextBlock.Text = source.Name;
                DisplaySource(source);
            }
        }

        private void DisplaySource(QualitativeSource source)
        {
            CodingRichTextBox.Visibility = Visibility.Collapsed;
            CodingImageHost.Visibility = Visibility.Collapsed;
            CodingVideoHost.Visibility = Visibility.Collapsed;
            MediaControlsPanel.Visibility = Visibility.Collapsed;

            string ext = System.IO.Path.GetExtension(source.FilePath).ToLower();

            if (ext == ".jpg" || ext == ".png" || ext == ".bmp")
            {
                CodingImageHost.Visibility = Visibility.Visible;
                CodingImageHost.Source = new System.Windows.Media.Imaging.BitmapImage(new Uri(source.FilePath));
            }
            else if (ext == ".mp4" || ext == ".avi" || ext == ".mov")
            {
                CodingVideoHost.Visibility = Visibility.Visible;
                MediaControlsPanel.Visibility = Visibility.Visible;
                CodingMediaElement.Source = new Uri(source.FilePath);
                CodingMediaElement.Play();
            }
            else
            {
                CodingRichTextBox.Visibility = Visibility.Visible;
                if (System.IO.File.Exists(source.FilePath))
                {
                    string text = System.IO.File.ReadAllText(source.FilePath);
                    CodingRichTextBox.Document.Blocks.Clear();
                    CodingRichTextBox.Document.Blocks.Add(new Paragraph(new Run(text)));
                }
            }
        }

        private void MediaPlay_Click(object sender, RoutedEventArgs e) => CodingMediaElement.Play();
        private void MediaPause_Click(object sender, RoutedEventArgs e) => CodingMediaElement.Pause();
        private void MediaStop_Click(object sender, RoutedEventArgs e) => CodingMediaElement.Stop();

        private void ShowNewCodePanel_Click(object sender, RoutedEventArgs e)
        {
            NewCodeThemeComboBox.Items.Clear();
            NewCodeInputPanel.Visibility = Visibility.Visible;
            BtnNewCode.Visibility = Visibility.Collapsed;
        }

        private void CancelNewCode_Click(object sender, RoutedEventArgs e)
        {
            NewCodeInputPanel.Visibility = Visibility.Collapsed;
            BtnNewCode.Visibility = Visibility.Visible;
        }

        private void ConfirmNewCode_Click(object sender, RoutedEventArgs e)
        {
            // Logic to add code to project and UI
            NewCodeInputPanel.Visibility = Visibility.Collapsed;
            BtnNewCode.Visibility = Visibility.Visible;
        }

        private void NewInterview_Click(object sender, RoutedEventArgs e) { /* ... */ }
        private void NewFocusGroup_Click(object sender, RoutedEventArgs e) { /* ... */ }
    }
}




FILE: \AdRev.Desktop\Views\Project\QualityCheckView.xaml
------------------------------------
<UserControl x:Class="AdRev.Desktop.Views.Project.QualityCheckView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:AdRev.Desktop"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1200">
    <Grid Background="#F5F7F8">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="300"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Sidebar -->
        <Border Background="White" BorderBrush="#E0E0E0" BorderThickness="0,0,1,0" Padding="20">
            <StackPanel>
                <TextBlock Text="Contr√¥le Qualit√©" FontSize="18" FontWeight="Bold" Foreground="{StaticResource PrimaryBrush}" Margin="0,0,0,5"/>
                <TextBlock Text="V√©rifiez la conformit√© de votre protocole." FontSize="12" Foreground="Gray" Margin="0,0,0,20"/>

                <TextBlock Text="R√©f√©rentiel / Checklist" Style="{StaticResource LabelStyle}"/>
                <ComboBox x:Name="QualityChecklistCombo" Height="35" Margin="0,0,0,10" SelectionChanged="QualityChecklistCombo_SelectionChanged" DisplayMemberPath="Name"/>
                <TextBlock x:Name="QualityChecklistDesc" Text="Description du r√©f√©rentiel..." FontSize="11" Foreground="#888" TextWrapping="Wrap" Margin="0,0,0,20"/>

                <Border Background="#E8F5E9" Padding="15" CornerRadius="5" Margin="0,20,0,0">
                    <StackPanel>
                        <TextBlock Text="Score de Qualit√©" FontWeight="Bold" Foreground="#2E7D32"/>
                        <TextBlock x:Name="QualityScoreText" Text="0 / 0" FontSize="24" FontWeight="Bold" Foreground="#2E7D32" Margin="0,5"/>
                        <ProgressBar x:Name="QualityScoreProgress" Height="8" Foreground="#2E7D32" Background="#C8E6C9"/>
                    </StackPanel>
                </Border>
            </StackPanel>
        </Border>

        <!-- Main Content -->
        <ScrollViewer Grid.Column="1" Padding="30">
            <StackPanel>
                <TextBlock x:Name="QualityChecklistTitle" Text="Checklist" FontSize="24" FontWeight="Bold" Foreground="#333" Margin="0,0,0,20"/>
                
                <!-- Dynamic Items Container -->
                <StackPanel x:Name="QualityItemsPanel"/>

                <Button Content="G√©n√©rer Rapport de Conformit√©" Click="GenerateQualityReport_Click" HorizontalAlignment="Left" Margin="0,30,0,0" Padding="20,10" Background="{StaticResource SecondaryBrush}" Foreground="White">
                    <Button.Resources>
                        <Style TargetType="Border"><Setter Property="CornerRadius" Value="4"/></Style>
                    </Button.Resources>
                </Button>
            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>




FILE: \AdRev.Desktop\Views\Project\QualityCheckView.xaml.cs
------------------------------------
using System;
using System.Collections.Generic;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Media;
using AdRev.Domain.Models;
using AdRev.Domain.Quality;
using AdRev.Core.Services;

namespace AdRev.Desktop.Views.Project
{
    public partial class QualityCheckView : UserControl
    {
        private ResearchProject? _project;
        private readonly QualityService _qualityService = new QualityService();

        public QualityCheckView()
        {
            InitializeComponent();
        }

        public void LoadProject(ResearchProject project)
        {
            _project = project;
            LoadChecklists();
        }

        private void LoadChecklists()
        {
            if (_project == null) return;

            var checklists = _qualityService.GetRecommendedChecklists(_project);
            if (!checklists.Any())
            {
                checklists = _qualityService.GetAllChecklists();
            }

            QualityChecklistCombo.ItemsSource = checklists;
            if (checklists.Count > 0)
                QualityChecklistCombo.SelectedIndex = 0;
        }

        private void QualityChecklistCombo_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (QualityChecklistCombo.SelectedItem is QualityChecklist checklist)
            {
                QualityChecklistDesc.Text = checklist.Description;
                QualityChecklistTitle.Text = $"Checklist : {checklist.Name}";
                RenderQualityChecklist(checklist);
            }
        }

        private void RenderQualityChecklist(QualityChecklist checklist)
        {
            QualityItemsPanel.Children.Clear();

            foreach (var section in checklist.Sections)
            {
                // Section Header
                var secHeader = new TextBlock 
                { 
                    Text = section.Name, 
                    FontSize = 16, 
                    FontWeight = FontWeights.Bold, 
                    Foreground = Brushes.Navy,
                    Margin = new Thickness(0, 15, 0, 10)
                };
                QualityItemsPanel.Children.Add(secHeader);

                // Items
                foreach (var item in section.Items)
                {
                    var itemPanel = new StackPanel { Margin = new Thickness(10, 0, 0, 15) };
                    
                    var cb = new CheckBox 
                    { 
                        Content = new TextBlock { Text = item.Requirement, TextWrapping = TextWrapping.Wrap },
                        IsChecked = item.IsMet,
                        FontSize = 14
                    };
                    
                    cb.Checked += (s, ev) => { item.IsMet = true; UpdateQualityScore(checklist); };
                    cb.Unchecked += (s, ev) => { item.IsMet = false; UpdateQualityScore(checklist); };

                    itemPanel.Children.Add(cb);

                    if (!string.IsNullOrEmpty(item.Description))
                    {
                        itemPanel.Children.Add(new TextBlock 
                        { 
                            Text = item.Description, 
                            FontSize = 11, 
                            Foreground = Brushes.Gray, 
                            Margin = new Thickness(25, 2, 0, 0),
                            TextWrapping = TextWrapping.Wrap
                        });
                    }

                    QualityItemsPanel.Children.Add(itemPanel);
                }
            }
            UpdateQualityScore(checklist);
        }

        private void UpdateQualityScore(QualityChecklist checklist)
        {
            int total = 0;
            int met = 0;

            foreach (var section in checklist.Sections)
            {
                total += section.Items.Count;
                met += section.Items.Count(i => i.IsMet);
            }

            QualityScoreText.Text = $"{met} / {total}";
            QualityScoreProgress.Maximum = total;
            QualityScoreProgress.Value = met;
        }

        private void GenerateQualityReport_Click(object sender, RoutedEventArgs e)
        {
            MessageBox.Show("Rapport de conformit√© g√©n√©r√© (Simulation).", "AdRev Quality");
        }
    }
}




FILE: \AdRev.Desktop\Views\Project\VariableDesignView.xaml
------------------------------------
<UserControl x:Class="AdRev.Desktop.Views.Project.VariableDesignView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:AdRev.Desktop"
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1200">
    <UserControl.Resources>
        <local:EnumDescriptionConverter x:Key="EnumDescriptionConverter"/>
        
        <Style x:Key="SectionHeaderStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryDarkBrush}"/>
            <Setter Property="Margin" Value="0,0,0,10"/>
        </Style>
    </UserControl.Resources>

    <Grid Margin="20">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="320"/> <!-- List Sidebar -->
            <ColumnDefinition Width="420"/> <!-- Editor -->
            <ColumnDefinition Width="*"/>   <!-- Preview -->
        </Grid.ColumnDefinitions>

        <!-- LEFT: Variable List -->
        <Border Grid.Column="0" Margin="0,0,10,0" Style="{StaticResource CardStyle}">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <TextBlock Text="DICTIONNAIRE" Style="{StaticResource SectionHeaderStyle}" Margin="15,15,15,10"/>
                
                <ListBox x:Name="VariablesListBox" Grid.Row="1" BorderThickness="0" Background="Transparent" SelectionChanged="VariablesListBox_SelectionChanged" HorizontalContentAlignment="Stretch" Padding="5">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border Padding="10" Margin="0,2" CornerRadius="6" x:Name="ItemBorder">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="30"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <Border Width="24" Height="24" CornerRadius="12" Background="#E8EAF6" HorizontalAlignment="Left">
                                        <TextBlock Text="V" Foreground="{StaticResource PrimaryBrush}" FontWeight="Bold" FontSize="10" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                    </Border>
                                    <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                        <TextBlock Text="{Binding Prompt}" FontWeight="SemiBold" FontSize="12" TextTrimming="CharacterEllipsis"/>
                                        <TextBlock Text="{Binding Name}" FontSize="10" Foreground="Gray"/>
                                    </StackPanel>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>

                <Grid Grid.Row="2" Margin="15">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    <Button x:Name="BtnAddVariable" Click="BtnAddVariable_Click" Style="{StaticResource ModernButtonStyle}" Background="{StaticResource SecondaryBrush}">
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="&#xE710;" FontFamily="Segoe MDL2 Assets" Margin="0,0,8,0"/>
                            <TextBlock Text="Ajouter une Variable"/>
                        </StackPanel>
                    </Button>
                    <Button x:Name="BtnDeleteVariable" Grid.Column="1" Click="BtnDeleteVariable_Click" Margin="10,0,0,0" Width="40" Background="#FFEBEE" Foreground="#D32F2F" BorderBrush="#FFCDD2" ToolTip="Supprimer">
                        <TextBlock Text="&#xE74D;" FontFamily="Segoe MDL2 Assets"/>
                    </Button>
                </Grid>
            </Grid>
        </Border>

        <!-- CENTER: Editor -->
        <ScrollViewer Grid.Column="1" Margin="10,0" VerticalScrollBarVisibility="Auto">
            <Border Style="{StaticResource CardStyle}" Padding="25">
                <StackPanel x:Name="EditorPanel" IsEnabled="False">
                    <TextBlock Text="CONFIGURATEUR" Style="{StaticResource SectionHeaderStyle}"/>
                    
                    <Expander Style="{StaticResource ScientificExpanderStyle}" Header="Informations G√©n√©rales" Tag="#E3F2FD" Foreground="#1565C0" IsExpanded="True" Margin="0,0,0,15">
                        <StackPanel Margin="10">
                            <TextBlock Text="Question (Libell√©)" Style="{StaticResource LabelStyle}"/>
                            <TextBox x:Name="TxtPrompt" TextChanged="TxtPrompt_TextChanged" Height="60" TextWrapping="Wrap" AcceptsReturn="True"/>
                            
                            <Grid Margin="0,15,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="15"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel>
                                    <TextBlock Text="Nom Technique" Style="{StaticResource LabelStyle}"/>
                                    <TextBox x:Name="TxtName" CharacterCasing="Upper"/>
                                </StackPanel>
                                <StackPanel Grid.Column="2">
                                    <TextBlock Text="Type de Donn√©e" Style="{StaticResource LabelStyle}"/>
                                    <ComboBox x:Name="CmbType" SelectionChanged="CmbType_SelectionChanged">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </StackPanel>
                            </Grid>
                            
                            <TextBlock Text="Groupe / Section" Style="{StaticResource LabelStyle}" Margin="0,15,0,5"/>
                            <TextBox x:Name="TxtGroup" TextChanged="TxtGroup_TextChanged"/>
                            
                            <CheckBox x:Name="ChkRequired" Content="Variable Obligatoire (*)" Margin="0,15,0,0" FontWeight="Bold" Click="ChkRequired_Click" Foreground="#D32F2F"/>
                        </StackPanel>
                    </Expander>

                    <Expander Style="{StaticResource ScientificExpanderStyle}" Header="Logique et Visibilit√©" Tag="#FFE0B2" Foreground="#E65100" Margin="0,0,0,15">
                        <StackPanel Margin="10">
                            <TextBlock Text="Condition d'Affichage" Style="{StaticResource LabelStyle}"/>
                            <TextBox x:Name="TxtCondition" TextChanged="TxtCondition_TextChanged" ToolTip="Ex: [SEXE] = 'F'"/>
                            <TextBlock Text="Laissez vide pour une visibilit√© permanente." FontSize="10" Foreground="Gray" FontStyle="Italic"/>

                            <TextBlock Text="Logique de Saut (Skip)" Style="{StaticResource LabelStyle}" Margin="0,15,0,5"/>
                            <TextBox x:Name="TxtSkipLogic" TextChanged="TxtSkipLogic_TextChanged" ToolTip="Ex: Aller √† la section B"/>
                        </StackPanel>
                    </Expander>

                    <!-- Param√®tres Sp√©cifiques -->
                    <Border x:Name="OptionsPanel" Background="#F8F9FA" CornerRadius="8" Padding="15" BorderBrush="#E0E0E0" BorderThickness="1">
                        <StackPanel>
                            <TextBlock Text="PARAM√àTRES AVANC√âS" FontWeight="Bold" FontSize="11" Foreground="#546E7A" Margin="0,0,0,10"/>
                            
                            <StackPanel x:Name="PanelChoices" Visibility="Collapsed">
                                <TextBlock Text="Options de r√©ponse (S√©parez par des virgules)" Style="{StaticResource LabelStyle}"/>
                                <TextBox x:Name="TxtChoices" Height="80" TextWrapping="Wrap" AcceptsReturn="True" TextChanged="TxtChoices_TextChanged"/>
                            </StackPanel>

                            <StackPanel x:Name="PanelNumeric" Visibility="Collapsed">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="20"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel>
                                        <TextBlock Text="Min" Style="{StaticResource LabelStyle}"/>
                                        <TextBox x:Name="TxtMin" TextChanged="TxtMin_TextChanged"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="2">
                                        <TextBlock Text="Max" Style="{StaticResource LabelStyle}"/>
                                        <TextBox x:Name="TxtMax" TextChanged="TxtMax_TextChanged"/>
                                    </StackPanel>
                                </Grid>
                            </StackPanel>

                            <StackPanel x:Name="PanelCalculated" Visibility="Collapsed">
                                <TextBlock Text="Formule Math√©matique" Style="{StaticResource LabelStyle}"/>
                                <TextBox x:Name="TxtFormula" Height="60" TextWrapping="Wrap" AcceptsReturn="True" TextChanged="TxtFormula_TextChanged" Background="#E8EAF6"/>
                            </StackPanel>
                            
                            <StackPanel x:Name="PanelQualitativeDeductive" Visibility="Collapsed">
                                <TextBlock Text="Classification Scientifique" Style="{StaticResource LabelStyle}"/>
                                <TextBox x:Name="TxtTheme" TextChanged="TxtTheme_TextChanged" Tag="Th√®me" Margin="0,0,0,8"/>
                                <TextBox x:Name="TxtSubTheme" TextChanged="TxtSubTheme_TextChanged" Tag="Sous-th√®me"/>
                            </StackPanel>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </Border>
        </ScrollViewer>

        <!-- RIGHT: Live Preview -->
        <Grid Grid.Column="2" Margin="10,0,0,0">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            
            <Border Background="{StaticResource PrimaryBrush}" Padding="15,10" CornerRadius="8,8,0,0">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="&#xE890;" FontFamily="Segoe MDL2 Assets" Foreground="White" VerticalAlignment="Center" Margin="0,0,10,0" FontSize="16"/>
                    <TextBlock Text="APER√áU SCIENTIFIQUE" Foreground="White" FontWeight="Bold" FontSize="12" VerticalAlignment="Center"/>
                </StackPanel>
            </Border>
            
            <Border Grid.Row="1" Background="White" BorderBrush="{StaticResource PrimaryBrush}" BorderThickness="1,0,1,1" CornerRadius="0,0,8,8">
                <TextBox x:Name="TxtPreview" 
                         BorderThickness="0"
                         FontFamily="Times New Roman" 
                         FontSize="14" 
                         Padding="30" 
                         AcceptsReturn="True" 
                         VerticalScrollBarVisibility="Auto" 
                         IsReadOnly="True" 
                         TextWrapping="Wrap"
                         Background="White"
                         Foreground="#333"/>
            </Border>
        </Grid>
    </Grid>
</UserControl>




FILE: \AdRev.Desktop\Views\Project\VariableDesignView.xaml.cs
------------------------------------
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using AdRev.Domain.Enums;
using AdRev.Domain.Variables;
using AdRev.Domain.Models;

namespace AdRev.Desktop.Views.Project
{
    public partial class VariableDesignView : UserControl
    {
        public ObservableCollection<StudyVariable> Variables { get; private set; } = new ObservableCollection<StudyVariable>();
        private StudyVariable? _selectedVariable;
        private bool _isQualitativeDeductive;

        public VariableDesignView()
        {
            InitializeComponent();
            VariablesListBox.ItemsSource = Variables;
            CmbType.ItemsSource = Enum.GetValues(typeof(VariableType));
            UpdateOptionPanelsVisibility();
        }

        public void LoadProject(ResearchProject project)
        {
            if (project == null) return;
            LoadVariables(project.Variables ?? new List<StudyVariable>(), project.StudyType == StudyType.Qualitative);
        }

        public void LoadVariables(List<StudyVariable> existingVariables, bool isQualitativeDeductive = false)
        {
            _isQualitativeDeductive = isQualitativeDeductive;
            Variables.Clear();
            if (existingVariables != null)
            {
                foreach (var v in existingVariables) Variables.Add(v);
            }

            if (Variables.Count > 0)
                VariablesListBox.SelectedIndex = 0;
            
            UpdatePreview();
        }

        private void BtnAddVariable_Click(object sender, RoutedEventArgs e)
        {
            var newVar = new StudyVariable
            {
                Name = "VAR_" + (Variables.Count + 1),
                Prompt = "Nouvelle Question",
                Type = VariableType.Text
            };
            Variables.Add(newVar);
            VariablesListBox.SelectedItem = newVar;
        }

        private void BtnDeleteVariable_Click(object sender, RoutedEventArgs e)
        {
            if (VariablesListBox.SelectedItem is StudyVariable selected)
            {
                Variables.Remove(selected);
                UpdatePreview();
            }
        }

        private void VariablesListBox_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            _selectedVariable = VariablesListBox.SelectedItem as StudyVariable;
            EditorPanel.IsEnabled = (_selectedVariable != null);

            if (_selectedVariable != null)
            {
                TxtPrompt.Text = _selectedVariable.Prompt;
                TxtName.Text = _selectedVariable.Name;
                CmbType.SelectedItem = _selectedVariable.Type;
                TxtGroup.Text = _selectedVariable.GroupName;
                ChkRequired.IsChecked = _selectedVariable.IsRequired;
                TxtCondition.Text = _selectedVariable.VisibilityCondition;
                TxtSkipLogic.Text = _selectedVariable.SkipLogic;
                TxtChoices.Text = _selectedVariable.ChoiceOptions;
                TxtMin.Text = _selectedVariable.MinValue?.ToString() ?? "";
                TxtMax.Text = _selectedVariable.MaxValue?.ToString() ?? "";
                TxtFormula.Text = _selectedVariable.CalculationFormula;
                TxtTheme.Text = _selectedVariable.Theme;
                TxtSubTheme.Text = _selectedVariable.SubTheme;

                UpdateOptionPanelsVisibility();
            }
            UpdatePreview();
        }

        private void UpdateOptionPanelsVisibility()
        {
            if (PanelChoices == null) return;

            PanelChoices.Visibility = Visibility.Collapsed;
            PanelNumeric.Visibility = Visibility.Collapsed;
            PanelCalculated.Visibility = Visibility.Collapsed;
            PanelQualitativeDeductive.Visibility = Visibility.Collapsed;

            if (_selectedVariable == null) return;

            switch (_selectedVariable.Type)
            {
                case VariableType.QualitativeNominal:
                case VariableType.MultipleChoice:
                case VariableType.QualitativeBinary:
                    PanelChoices.Visibility = Visibility.Visible;
                    break;
                case VariableType.QuantitativeContinuous:
                case VariableType.QuantitativeDiscrete:
                    PanelNumeric.Visibility = Visibility.Visible;
                    break;
                case VariableType.Calculated:
                    PanelCalculated.Visibility = Visibility.Visible;
                    break;
                case VariableType.Memo:
                    if (_isQualitativeDeductive)
                        PanelQualitativeDeductive.Visibility = Visibility.Visible;
                    break;
            }
        }

        private void UpdatePreview()
        {
            if (TxtPreview == null) return;

            var sb = new System.Text.StringBuilder();
            sb.AppendLine("DICTIONNAIRE DE VARIABLES");
            sb.AppendLine("=========================");
            sb.AppendLine();

            foreach (var v in Variables)
            {
                sb.AppendLine($"{v.Name} : {v.Prompt}");
                sb.AppendLine($"  Type: {v.Type}");
                if (!string.IsNullOrEmpty(v.GroupName)) sb.AppendLine($"  Groupe: {v.GroupName}");
                if (!string.IsNullOrEmpty(v.ChoiceOptions)) sb.AppendLine($"  Options: {v.ChoiceOptions}");
                sb.AppendLine();
            }

            TxtPreview.Text = sb.ToString();
        }

        private void TxtPrompt_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_selectedVariable != null) { _selectedVariable.Prompt = TxtPrompt.Text; UpdatePreview(); }
        }

        private void TxtGroup_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_selectedVariable != null) { _selectedVariable.GroupName = TxtGroup.Text; UpdatePreview(); }
        }

        private void CmbType_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (_selectedVariable != null && CmbType.SelectedItem is VariableType type)
            {
                _selectedVariable.Type = type;
                UpdateOptionPanelsVisibility();
                UpdatePreview();
            }
        }

        private void TxtChoices_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_selectedVariable != null)
            {
                _selectedVariable.ChoiceOptions = TxtChoices.Text;
                UpdatePreview();
            }
        }

        private void TxtMin_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_selectedVariable != null && double.TryParse(TxtMin.Text, out double min)) _selectedVariable.MinValue = min;
        }

        private void TxtMax_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_selectedVariable != null && double.TryParse(TxtMax.Text, out double max)) _selectedVariable.MaxValue = max;
        }

        private void ChkRequired_Click(object sender, RoutedEventArgs e)
        {
            if (_selectedVariable != null) _selectedVariable.IsRequired = ChkRequired.IsChecked ?? false;
        }

        private void TxtCondition_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_selectedVariable != null) _selectedVariable.VisibilityCondition = TxtCondition.Text;
        }

        private void TxtSkipLogic_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_selectedVariable != null) _selectedVariable.SkipLogic = TxtSkipLogic.Text;
        }

        private void TxtFormula_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_selectedVariable != null) _selectedVariable.CalculationFormula = TxtFormula.Text;
        }

        private void TxtTheme_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_selectedVariable != null) _selectedVariable.Theme = TxtTheme.Text;
        }

        private void TxtSubTheme_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_selectedVariable != null) _selectedVariable.SubTheme = TxtSubTheme.Text;
        }
    }
}




FILE: \AdRev.Desktop\Windows\ProjectWindow.xaml
------------------------------------
<Window x:Class="AdRev.Desktop.Windows.ProjectWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AdRev.Desktop"
        xmlns:win="clr-namespace:AdRev.Desktop.Windows"
        xmlns:project="clr-namespace:AdRev.Desktop.Views.Project"
        mc:Ignorable="d"
        Title="AdRev Project" Height="700" Width="1100"
        MinHeight="600" MinWidth="1000"
        WindowStartupLocation="CenterScreen"
        Background="{StaticResource BackgroundBrush}">

    <WindowChrome.WindowChrome>
        <WindowChrome CaptionHeight="40" ResizeBorderThickness="8" CornerRadius="0" GlassFrameThickness="0"/>
    </WindowChrome.WindowChrome>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Title Bar -->
            <RowDefinition Height="Auto"/> <!-- Progress Stepper -->
            <RowDefinition Height="Auto"/> <!-- Ribbon -->
            <RowDefinition Height="*"/>    <!-- Content -->
            <RowDefinition Height="25"/>   <!-- Status Bar -->
        </Grid.RowDefinitions>

        <!-- 1. TOP TITLE BAR -->
        <Border Grid.Row="0" Background="{StaticResource PrimaryDarkBrush}" Padding="10,5,10,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,30,5" WindowChrome.IsHitTestVisibleInChrome="True">
                     <TextBlock Text="AdRev Project" Foreground="White" FontSize="16" FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,10,0"/>
                     <TextBlock x:Name="TxtProjectTitleHeader" Text="Project Name" Foreground="#B0BEC5" FontSize="14" VerticalAlignment="Center" FontStyle="Italic"/>
                </StackPanel>

                <!-- Project Quick Actions -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" WindowChrome.IsHitTestVisibleInChrome="True">
                     <Button Content="&#xE74E;" Click="QuickSave_Click" ToolTip="Enregistrer" Background="Transparent" Foreground="#E0E0E0" BorderThickness="0" FontFamily="Segoe MDL2 Assets" FontSize="14" Margin="0,0,5,0" Padding="5"/>
                </StackPanel>

                <!-- Window Controls -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Top" Margin="0,-5,-10,0">
                    <Button Style="{StaticResource WindowControlButtonStyle}" Content="&#xE921;" Click="Minimize_Click" ToolTip="R√©duire"/>
                    <Button Style="{StaticResource WindowControlButtonStyle}" Content="&#xE922;" Click="Maximize_Click" ToolTip="Agrandir/Restaurer"/>
                    <Button Style="{StaticResource CloseButtonStyle}" Content="&#xE8BB;" Click="Close_Click" ToolTip="Fermer"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- 2. PROGRESS STEPPER -->
        <Border Grid.Row="1" Background="White" BorderBrush="#DDD" BorderThickness="0,0,0,1" Padding="20,10">
            <Grid HorizontalAlignment="Center">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/> <!-- Protocol -->
                    <ColumnDefinition Width="60"/>   <!-- Line -->
                    <ColumnDefinition Width="Auto"/> <!-- Variables -->
                    <ColumnDefinition Width="60"/>   <!-- Line -->
                    <ColumnDefinition Width="Auto"/> <!-- Data -->
                    <ColumnDefinition Width="60"/>   <!-- Line -->
                    <ColumnDefinition Width="Auto"/> <!-- Analysis -->
                    <ColumnDefinition Width="60"/>   <!-- Line -->
                    <ColumnDefinition Width="Auto"/> <!-- Report -->
                </Grid.ColumnDefinitions>

                <!-- Protocol Step -->
                <StackPanel x:Name="StepProtocol" Grid.Column="0" Opacity="1">
                    <Ellipse Width="24" Height="24" Fill="{StaticResource PrimaryBrush}" HorizontalAlignment="Center"/>
                    <TextBlock Text="1" Foreground="White" FontWeight="Bold" FontSize="12" HorizontalAlignment="Center" Margin="0,-22,0,0"/>
                    <TextBlock Text="PROTOCOLE" FontSize="10" FontWeight="Bold" Foreground="{StaticResource PrimaryBrush}" Margin="0,8,0,0" HorizontalAlignment="Center"/>
                </StackPanel>
                <Rectangle Grid.Column="1" Height="2" Fill="#EEE" VerticalAlignment="Center" Margin="5,0,5,20"/>

                <!-- Variables Step -->
                <StackPanel x:Name="StepVariables" Grid.Column="2" Opacity="0.4">
                    <Ellipse Width="24" Height="24" Fill="#CCC" HorizontalAlignment="Center"/>
                    <TextBlock Text="2" Foreground="White" FontWeight="Bold" FontSize="12" HorizontalAlignment="Center" Margin="0,-22,0,0"/>
                    <TextBlock Text="VARIABLES" FontSize="10" FontWeight="Bold" Foreground="#888" Margin="0,8,0,0" HorizontalAlignment="Center"/>
                </StackPanel>
                <Rectangle Grid.Column="3" Height="2" Fill="#EEE" VerticalAlignment="Center" Margin="5,0,5,20"/>

                <!-- Data Step -->
                <StackPanel x:Name="StepData" Grid.Column="4" Opacity="0.4">
                    <Ellipse Width="24" Height="24" Fill="#CCC" HorizontalAlignment="Center"/>
                    <TextBlock Text="3" Foreground="White" FontWeight="Bold" FontSize="12" HorizontalAlignment="Center" Margin="0,-22,0,0"/>
                    <TextBlock Text="COLLECTE" FontSize="10" FontWeight="Bold" Foreground="#888" Margin="0,8,0,0" HorizontalAlignment="Center"/>
                </StackPanel>
                <Rectangle Grid.Column="5" Height="2" Fill="#EEE" VerticalAlignment="Center" Margin="5,0,5,20"/>

                <!-- Analysis Step -->
                <StackPanel x:Name="StepAnalysis" Grid.Column="6" Opacity="0.4">
                    <Ellipse Width="24" Height="24" Fill="#CCC" HorizontalAlignment="Center"/>
                    <TextBlock Text="4" Foreground="White" FontWeight="Bold" FontSize="12" HorizontalAlignment="Center" Margin="0,-22,0,0"/>
                    <TextBlock Text="ANALYSE" FontSize="10" FontWeight="Bold" Foreground="#888" Margin="0,8,0,0" HorizontalAlignment="Center"/>
                </StackPanel>
                <Rectangle Grid.Column="7" Height="2" Fill="#EEE" VerticalAlignment="Center" Margin="5,0,5,20"/>

                <!-- Report Step -->
                <StackPanel x:Name="StepReport" Grid.Column="8" Opacity="0.4">
                    <Ellipse Width="24" Height="24" Fill="#CCC" HorizontalAlignment="Center"/>
                    <TextBlock Text="5" Foreground="White" FontWeight="Bold" FontSize="12" HorizontalAlignment="Center" Margin="0,-22,0,0"/>
                    <TextBlock Text="PUBLICATION" FontSize="10" FontWeight="Bold" Foreground="#888" Margin="0,8,0,0" HorizontalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- 3. RIBBON FOR PROJECT (Simplified or Moved from MainWindow) -->
        <Border Grid.Row="2" Background="{StaticResource MenuBarBrush}" BorderBrush="#DDD" BorderThickness="0,0,0,1" Padding="12,5">
            <StackPanel Orientation="Horizontal" Height="50">
                 <!-- Tabs will control the content below -->
                <RadioButton x:Name="RibbonStep1" Style="{StaticResource RibbonTabButtonStyle}" Content="Protocole" IsChecked="True" Checked="Ribbon_Checked" Tag="0"/>
                <RadioButton x:Name="RibbonStep2" Style="{StaticResource RibbonTabButtonStyle}" Content="Variables" Checked="Ribbon_Checked" Tag="1"/>
                <RadioButton x:Name="RibbonStep3" Style="{StaticResource RibbonTabButtonStyle}" Content="Saisie" Checked="Ribbon_Checked" Tag="2"/>
                <RadioButton x:Name="RibbonStep4" Style="{StaticResource RibbonTabButtonStyle}" Content="Stats" Checked="Ribbon_Checked" Tag="3"/>
                <RadioButton x:Name="RibbonStep5" Style="{StaticResource RibbonTabButtonStyle}" Content="Quali Dashboard" Checked="Ribbon_Checked" Tag="4"/>
                <RadioButton x:Name="RibbonStep5b" Style="{StaticResource RibbonTabButtonStyle}" Content="Atelier Codage" Checked="Ribbon_Checked" Tag="5"/>
                <RadioButton x:Name="RibbonStep6" Style="{StaticResource RibbonTabButtonStyle}" Content="Discussion" Checked="Ribbon_Checked" Tag="6"/>
                <RadioButton x:Name="RibbonStep7" Style="{StaticResource RibbonTabButtonStyle}" Content="Rapport" Checked="Ribbon_Checked" Tag="7"/>
                <RadioButton x:Name="RibbonStep8" Style="{StaticResource RibbonTabButtonStyle}" Content="Article" Checked="Ribbon_Checked" Tag="8"/>
                <RadioButton x:Name="RibbonStep9" Style="{StaticResource RibbonTabButtonStyle}" Content="Qualit√©" Checked="Ribbon_Checked" Tag="9"/>
            </StackPanel>
        </Border>

        <!-- 4. PROJECT CONTENT TABS -->
        <TabControl x:Name="ProjectTabControl" Grid.Row="3" Background="Transparent" BorderThickness="0" Margin="0,-1,0,0">
            <TabControl.Template>
                <ControlTemplate TargetType="TabControl">
                    <ContentPresenter ContentSource="SelectedContent" />
                </ControlTemplate>
            </TabControl.Template>

            <TabItem x:Name="TabProtocol">
                <project:ProtocolView x:Name="ViewProtocol"/>
            </TabItem>
            <TabItem x:Name="TabVariables">
                <project:VariableDesignView x:Name="ViewVariableDesign"/>
            </TabItem>
            <TabItem x:Name="TabDataEntry">
                <project:DataEntryView x:Name="ViewDataEntry"/>
            </TabItem>
            <TabItem x:Name="TabAnalysis">
                <project:AnalysisView x:Name="ViewAnalysis"/>
            </TabItem>
            <TabItem x:Name="TabQualitativeAnalysis">
                <project:QualitativeAnalysisView x:Name="ViewQualitativeAnalysis"/>
            </TabItem>
            <TabItem x:Name="TabQualitativeCoding">
                <project:QualitativeCodingView x:Name="ViewQualitativeCoding"/>
            </TabItem>
            <TabItem x:Name="TabDiscussion">
                <project:DiscussionView x:Name="ViewDiscussion"/>
            </TabItem>
            <TabItem x:Name="TabFinalReport">
                <project:FinalReportView x:Name="ViewFinalReport"/>
            </TabItem>
            <TabItem x:Name="TabJournal">
                <project:JournalArticleView x:Name="ViewJournalArticle"/>
            </TabItem>
            <TabItem x:Name="TabQuality">
                <project:QualityCheckView x:Name="ViewQualityCheck"/>
            </TabItem>
        </TabControl>

        <!-- 5. STATUS BAR -->
        <StatusBar Grid.Row="4" Background="#F0F4F8">
            <StatusBarItem>
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="Statut du Projet :" Foreground="#555" Margin="0,0,5,0"/>
                    <TextBlock x:Name="StatusBarProjectStatus" Text="En cours" FontWeight="SemiBold" Foreground="{StaticResource PrimaryBrush}"/>
                </StackPanel>
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right">
                <TextBlock x:Name="StatusBarLastSaved" Text="Derni√®re sauvegarde : Jamais" Foreground="#888"/>
            </StatusBarItem>
        </StatusBar>
    </Grid>
</Window>




FILE: \AdRev.Desktop\Windows\ProjectWindow.xaml.cs
------------------------------------
using System;
using System.Windows;
using System.Windows.Controls;
using AdRev.Domain.Models;
using AdRev.Domain.Enums;
using AdRev.Core.Common;

namespace AdRev.Desktop.Windows
{
    public partial class ProjectWindow : Window
    {
        private ResearchProject _project;
        private readonly ResearchProjectService _projectService = new ResearchProjectService();

        public ProjectWindow(ResearchProject project)
        {
            InitializeComponent();
            _project = project;
            LoadProject();
        }

        private void LoadProject()
        {
            if (_project == null) return;
            TxtProjectTitleHeader.Text = _project.Title;
            StatusBarProjectStatus.Text = _project.Status.ToString();
            
            // Pass project to all views
            ViewProtocol.LoadProject(_project);
            ViewVariableDesign.LoadProject(_project);
            ViewDataEntry.LoadProject(_project);
            ViewAnalysis.LoadProject(_project);
            ViewQualitativeAnalysis.LoadProject(_project);
            ViewQualitativeCoding.LoadProject(_project);
            ViewDiscussion.LoadProject(_project);
            ViewFinalReport.LoadProject(_project);
            ViewJournalArticle.LoadProject(_project);
            ViewQualityCheck.LoadProject(_project);

            // Initial progress update
            UpdateProgress();
        }

        private void UpdateProgress()
        {
            // Reset all
            StepProtocol.Opacity = 0.4;
            StepVariables.Opacity = 0.4;
            StepData.Opacity = 0.4;
            StepAnalysis.Opacity = 0.4;
            StepReport.Opacity = 0.4;

            // Simple logic for progress visualization
            StepProtocol.Opacity = 1.0; 
            if (_project.Variables != null && _project.Variables.Count > 0) StepVariables.Opacity = 1.0;
            // Add more conditions as needed...
        }

        private void Ribbon_Checked(object sender, RoutedEventArgs e)
        {
            if (!IsLoaded) return;
            if (sender is RadioButton rb && ProjectTabControl != null && rb.Tag != null)
            {
                if (int.TryParse(rb.Tag.ToString(), out int index))
                {
                    ProjectTabControl.SelectedIndex = index;
                }
            }
        }

        private void QuickSave_Click(object sender, RoutedEventArgs e)
        {
            _projectService.SaveProject(_project);
            StatusBarLastSaved.Text = $"Derni√®re sauvegarde : {DateTime.Now:HH:mm:ss}";
        }

        private void Minimize_Click(object sender, RoutedEventArgs e) => WindowState = WindowState.Minimized;
        private void Maximize_Click(object sender, RoutedEventArgs e) => WindowState = WindowState == WindowState.Maximized ? WindowState.Normal : WindowState.Maximized;
        private void Close_Click(object sender, RoutedEventArgs e) => Close();
    }
}




FILE: \AdRev.Desktop\Windows\ProtocolSelectionWindow.xaml
------------------------------------
<Window x:Class="AdRev.Desktop.Windows.ProtocolSelectionWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="S√©lectionner un Protocole" Height="400" Width="600"
        WindowStartupLocation="CenterOwner" ResizeMode="NoResize" WindowStyle="ToolWindow">
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <TextBlock Text="Choisissez le protocole √† convertir en projet :" FontWeight="Bold" FontSize="14" Margin="0,0,0,15"/>
        
        <ListBox x:Name="ProtocolsList" Grid.Row="1" Margin="0,0,0,15" BorderBrush="#DDD" BorderThickness="1">
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <StackPanel Margin="5">
                        <TextBlock Text="{Binding Title}" FontWeight="Bold"/>
                        <TextBlock Text="{Binding CreatedAt, StringFormat='{}Cr√©√© le {0:g}'}" FontSize="11" Foreground="Gray"/>
                    </StackPanel>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>
        
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right">
            <Button Content="Annuler" IsCancel="True" Width="100" Height="30" Margin="0,0,10,0"/>
            <Button Content="Convertir" Click="BtnConvert_Click" IsDefault="True" Width="100" Height="30" Background="#FF9800" Foreground="White" FontWeight="Bold"/>
        </StackPanel>
    </Grid>
</Window>




FILE: \AdRev.Desktop\Windows\ProtocolSelectionWindow.xaml.cs
------------------------------------
using System;
using System.Collections.Generic;
using System.Windows;
using AdRev.Domain.Protocols;

namespace AdRev.Desktop.Windows
{
    public partial class ProtocolSelectionWindow : Window
    {
        public ResearchProtocol? SelectedProtocol { get; private set; }

        public ProtocolSelectionWindow(IEnumerable<ResearchProtocol> protocols)
        {
            InitializeComponent();
            ProtocolsList.ItemsSource = protocols;
        }

        private void BtnConvert_Click(object sender, RoutedEventArgs e)
        {
            if (ProtocolsList.SelectedItem is ResearchProtocol protocol)
            {
                SelectedProtocol = protocol;
                DialogResult = true;
                Close();
            }
            else
            {
                MessageBox.Show("Veuillez s√©lectionner un protocole.", "Attention", MessageBoxButton.OK, MessageBoxImage.Warning);
            }
        }
    }
}




FILE: \AdRev.Desktop\ActivationWindow.xaml
------------------------------------
<Window x:Class="AdRev.Desktop.ActivationWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Activation AdRev" Height="580" Width="420"
        WindowStyle="None" ResizeMode="NoResize"
        WindowStartupLocation="CenterScreen"
        AllowsTransparency="True" Background="Transparent">
    
    <Window.Resources>
        <Style x:Key="ModernButton" TargetType="Button">
            <Setter Property="Background" Value="#7C4DFF"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="Padding" Value="20,10"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}" CornerRadius="8">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#6A3DE8"/>
                </Trigger>
            </Style.Triggers>
        </Style>
    </Window.Resources>

    <Border CornerRadius="20" Background="#1E1E2E" BorderBrush="#7C4DFF" BorderThickness="2" Padding="25">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Header -->
            <StackPanel Grid.Row="0" Margin="0,0,0,20">
                <TextBlock Text="üîí" FontSize="48" HorizontalAlignment="Center" Margin="0,0,0,5"/>
                <TextBlock Text="Activation d'AdRev" FontSize="22" FontWeight="Bold" Foreground="White" HorizontalAlignment="Center"/>
                <TextBlock Text="Veuillez activer votre licence" Foreground="#A0A0B0" HorizontalAlignment="Center" FontSize="12"/>
            </StackPanel>

            <!-- Content -->
            <StackPanel Grid.Row="1">
                <TextBlock Text="Hardware ID (HWID) :" Foreground="#A0A0B0" FontSize="11" Margin="0,0,0,5"/>
                <Border Background="#2B2B3B" CornerRadius="8" Padding="12,8" Margin="0,0,0,15">
                    <Grid>
                        <TextBlock x:Name="HwidText" Text="..." Foreground="White" FontWeight="SemiBold" VerticalAlignment="Center" FontSize="13"/>
                        <Button Content="Copier" Click="CopyHwid_Click" HorizontalAlignment="Right" Background="Transparent" Foreground="#7C4DFF" BorderThickness="0" FontSize="11" Cursor="Hand" FontWeight="Bold"/>
                    </Grid>
                </Border>
                
                <TextBlock Text="Code d'Activation :" Foreground="#A0A0B0" FontSize="11" Margin="0,0,0,5"/>
                <TextBox x:Name="LicenseKeyBox" 
                         Height="70" 
                         FontSize="11" 
                         TextWrapping="Wrap"
                         AcceptsReturn="True"
                         VerticalContentAlignment="Top" 
                         Padding="8" 
                         Background="#2B2B3B" 
                         Foreground="#00E676" 
                         BorderBrush="#3B3B4B" 
                         BorderThickness="1"
                         VerticalScrollBarVisibility="Auto">
                    <TextBox.Resources>
                        <Style TargetType="{x:Type Border}">
                            <Setter Property="CornerRadius" Value="8"/>
                        </Style>
                    </TextBox.Resources>
                </TextBox>
                
                <Button Content="ACTIVER MAINTENANT" 
                        Click="Activate_Click"
                        Style="{StaticResource ModernButton}" 
                        Height="45" 
                        Margin="0,20,0,0"
                        FontSize="16" FontWeight="Black"/>
            </StackPanel>

            <!-- Footer -->
            <StackPanel Grid.Row="2" Margin="0,20,0,0">
                <TextBlock Text="Besoin d'aide ? support@adrev.com" 
                           Foreground="#707080" FontSize="11" HorizontalAlignment="Center"/>
                <Button Content="Quitter" Click="Exit_Click" Background="Transparent" Foreground="#606070" BorderThickness="0" Margin="0,10,0,0" Cursor="Hand"/>
            </StackPanel>
        </Grid>
    </Border>
</Window>




FILE: \AdRev.Desktop\ActivationWindow.xaml.cs
------------------------------------
using System;
using System.Windows;
using AdRev.Core.Services;

namespace AdRev.Desktop
{
    public partial class ActivationWindow : Window
    {
        private readonly LicensingService _licensingService = new LicensingService();

        public ActivationWindow()
        {
            InitializeComponent();
            HwidText.Text = _licensingService.GetHardwareId();
            
            // Check current status
            if (_licensingService.IsActivated(out string status))
            {
                // Technically shouldn't be here if App.xaml.cs works, but good for feedback
                LicenseKeyBox.Text = "LOGICIEL ACTIV√â";
                LicenseKeyBox.IsEnabled = false;
            }
        }

        private void CopyHwid_Click(object sender, RoutedEventArgs e)
        {
            Clipboard.SetText(HwidText.Text);
            MessageBox.Show("Identifiant mat√©riel copi√© dans le presse-papier.", "Info", MessageBoxButton.OK, MessageBoxImage.Information);
        }

        private void Activate_Click(object sender, RoutedEventArgs e)
        {
            string key = LicenseKeyBox.Text.Trim();
            if (string.IsNullOrEmpty(key))
            {
                MessageBox.Show("Veuillez entrer un code d'activation.", "Champs requis", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            if (_licensingService.Activate(key))
            {
                MessageBox.Show("AdRev a √©t√© activ√© avec succ√®s ! Merci de votre confiance.", "Activation R√©ussie", MessageBoxButton.OK, MessageBoxImage.Information);
                this.DialogResult = true;
                this.Close();
            }
            else
            {
                MessageBox.Show("Code d'activation invalide ou expir√© pour cet ordinateur.", "Erreur d'activation", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void Exit_Click(object sender, RoutedEventArgs e)
        {
            Application.Current.Shutdown();
        }

        protected override void OnMouseLeftButtonDown(System.Windows.Input.MouseButtonEventArgs e)
        {
            base.OnMouseLeftButtonDown(e);
            this.DragMove();
        }
    }
}




FILE: \AdRev.Desktop\App.xaml
------------------------------------
<Application x:Class="AdRev.Desktop.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:local="clr-namespace:AdRev.Desktop">
    <Application.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="/Resources/Styles.xaml"/>
            </ResourceDictionary.MergedDictionaries>

            <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
            <local:EnumDescriptionConverter x:Key="EnumDescriptionConverter"/>
            <local:WidthToCompactConverter x:Key="WidthToCompactConverter"/>
            <local:ResponsiveSpacingConverter x:Key="ResponsiveSpacingConverter"/>
            <local:DpiToFontSizeConverter x:Key="DpiToFontSizeConverter"/>

            <Style x:Key="WindowControlButtonStyle" TargetType="Button">
                <Setter Property="Width" Value="46"/>
                <Setter Property="Height" Value="32"/>
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="Foreground" Value="#E0E0E0"/>
                <Setter Property="FontFamily" Value="Segoe MDL2 Assets"/>
                <Setter Property="FontSize" Value="10"/>
                <Setter Property="BorderThickness" Value="0"/>
                <Setter Property="WindowChrome.IsHitTestVisibleInChrome" Value="True"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border Background="{TemplateBinding Background}">
                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                            </Border>
                            <ControlTemplate.Triggers>
                                <Trigger Property="IsMouseOver" Value="True">
                                    <Setter Property="Background" Value="#33FFFFFF"/>
                                    <Setter Property="Foreground" Value="White"/>
                                </Trigger>
                            </ControlTemplate.Triggers>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="CloseButtonStyle" TargetType="Button" BasedOn="{StaticResource WindowControlButtonStyle}">
                <Style.Triggers>
                    <Trigger Property="IsMouseOver" Value="True">
                        <Setter Property="Background" Value="#E81123"/>
                        <Setter Property="Foreground" Value="White"/>
                    </Trigger>
                </Style.Triggers>
            </Style>

        </ResourceDictionary>
    </Application.Resources>
</Application>




FILE: \AdRev.Desktop\App.xaml.cs
------------------------------------
using System.Configuration;
using System.Data;
using System.Windows;

namespace AdRev.Desktop
{
    /// <summary>
    /// Interaction logic for App.xaml
    /// </summary>
    public partial class App : Application
    {
        private readonly AdRev.Core.Services.LicensingService _licensingService = new AdRev.Core.Services.LicensingService();

        public App()
        {
            this.DispatcherUnhandledException += App_DispatcherUnhandledException;
        }

        protected override void OnStartup(StartupEventArgs e)
        {
            base.OnStartup(e);

            // 1. Check if License is Valid
            if (!_licensingService.IsActivated(out string _))
            {
                // Show Activation Window
                var activationWindow = new ActivationWindow();
                bool? result = activationWindow.ShowDialog();

                if (result != true)
                {
                    // User closed activation or it failed
                    Shutdown();
                    return;
                }
            }

            // 2. License OK, show MainWindow
            MainWindow main = new MainWindow();
            main.Show();
        }

        private void App_DispatcherUnhandledException(object sender, System.Windows.Threading.DispatcherUnhandledExceptionEventArgs e)
        {
            var ex = e.Exception;
            string message = ex.Message;
            while (ex.InnerException != null)
            {
                ex = ex.InnerException;
                message += "\n\nInner Exception: " + ex.Message;
            }

            MessageBox.Show($"Une erreur inattendue est survenue : {message}\n\n{ex.StackTrace}", "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
            e.Handled = true;
        }
    }
}




FILE: \AdRev.Desktop\AssemblyInfo.cs
------------------------------------
using System.Windows;

[assembly: ThemeInfo(
    ResourceDictionaryLocation.None,            //where theme specific resource dictionaries are located
                                                //(used if a resource is not found in the page,
                                                // or application resource dictionaries)
    ResourceDictionaryLocation.SourceAssembly   //where the generic resource dictionary is located
                                                //(used if a resource is not found in the page,
                                                // app, or any theme specific resource dictionaries)
)]




FILE: \AdRev.Desktop\CitationEntryWindow.xaml
------------------------------------
<Window x:Class="AdRev.Desktop.CitationEntryWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Ajouter une R√©f√©rence" Height="700" Width="600"
        WindowStartupLocation="CenterScreen" ResizeMode="NoResize"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        MouseDown="Window_MouseDown">
    
    <Border Background="White" CornerRadius="20" BorderBrush="#DDD" BorderThickness="1">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <!-- Header -->
                <RowDefinition Height="*"/>    <!-- Content -->
                <RowDefinition Height="Auto"/> <!-- Actions -->
            </Grid.RowDefinitions>

            <!-- Custom Header -->
            <Border Grid.Row="0" Background="{StaticResource PrimaryBrush}" CornerRadius="19,19,0,0" Padding="20,15">
                <Grid>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="üìö" FontSize="20" VerticalAlignment="Center" Margin="0,0,12,0"/>
                        <TextBlock Text="Ajouter une R√©f√©rence" FontSize="18" FontWeight="Bold" Foreground="White" VerticalAlignment="Center"/>
                    </StackPanel>
                    <Button Content="‚úï" Click="Cancel_Click" HorizontalAlignment="Right" Background="Transparent" Foreground="White" BorderThickness="0" FontSize="16" Cursor="Hand"/>
                </Grid>
            </Border>

            <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto" Padding="25">
                <StackPanel>
                    <!-- Search Card -->
                    <Border Background="#F8F9FA" CornerRadius="12" Padding="15" Margin="0,0,0,25">
                        <StackPanel>
                            <TextBlock Text="Recherche Automatique" FontWeight="Bold" Margin="0,0,0,10" Foreground="{StaticResource PrimaryBrush}"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel>
                                    <TextBlock Text="DOI, PMID ou Titre" Style="{StaticResource LabelStyle}" FontSize="12"/>
                                    <TextBox x:Name="CitDoiBox" Height="40" Margin="0" Tag="Ex: 10.1038/nature12345"/>
                                </StackPanel>
                                <Button Grid.Column="1" Content="üîç Rechercher" Click="SearchDoi_Click" Style="{StaticResource ModernButtonStyle}" Height="40" Width="120" Margin="10,18,0,0" FontSize="12"/>
                            </Grid>
                        </StackPanel>
                    </Border>

                    <Separator Margin="0,0,0,25" Opacity="0.5"/>

                    <!-- Manual Fields -->
                    <TextBlock Text="Saisie Manuelle" FontWeight="Bold" Margin="0,0,0,15" Foreground="{StaticResource PrimaryBrush}"/>
                    
                    <TextBlock Text="Auteurs" Style="{StaticResource LabelStyle}"/>
                    <TextBox x:Name="CitAuthorsBox" Tag="Smith J, Doe A..."/>

                    <TextBlock Text="Ann√©e" Style="{StaticResource LabelStyle}"/>
                    <TextBox x:Name="CitYearBox" Width="100" HorizontalAlignment="Left" Tag="2024"/>

                    <TextBlock Text="Titre de l'article / Ouvrage" Style="{StaticResource LabelStyle}"/>
                    <TextBox x:Name="CitTitleBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Tag="Titre complet du document..."/>

                    <TextBlock Text="Source / Journal" Style="{StaticResource LabelStyle}"/>
                    <TextBox x:Name="CitSourceBox" Tag="Lancet, Nature, EM-Consulte..."/>

                    <!-- Pending Group Card -->
                    <Border Background="#E8EAF6" CornerRadius="12" Padding="15" Margin="0,20,0,0">
                        <StackPanel>
                             <Button Content="‚¨áÔ∏è Ajouter ce document √† la citation group√©e" Click="AddToPending_Click" Style="{StaticResource SecondaryButtonStyle}" HorizontalAlignment="Center" Margin="0,0,0,15"/>
                             
                             <TextBlock Text="Documents s√©lectionn√©s pour cette citation :" FontSize="11" FontWeight="Bold" Foreground="#3F51B5" Margin="0,0,0,8"/>
                             <ListBox x:Name="PendingCitationsBox" Height="100" Background="Transparent" BorderThickness="0">
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="White" CornerRadius="5" Margin="0,0,0,5" Padding="8">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="üìÑ" Margin="0,0,10,0"/>
                                                <TextBlock Text="{Binding Title}" FontSize="11" FontWeight="Medium" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                             </ListBox>
                        </StackPanel>
                    </Border>
                </StackPanel>
            </ScrollViewer>

            <!-- Footer Actions -->
            <Border Grid.Row="2" Background="#F5F5F5" Padding="25,15" CornerRadius="0,0,19,19">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <Button Content="Annuler" Click="Cancel_Click" Style="{StaticResource SecondaryButtonStyle}" Width="100" Height="40" Margin="0,0,15,0"/>
                    <Button Content="Ins√©rer dans le texte" Click="Confirm_Click" Style="{StaticResource ModernButtonStyle}" Width="180" Height="40" FontWeight="Bold"/>
                </StackPanel>
            </Border>
        </Grid>
    </Border>
</Window>




FILE: \AdRev.Desktop\CitationEntryWindow.xaml.cs
------------------------------------
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Net.Http;
using System.Text.Json;
using System.Windows;
using AdRev.Domain.Models;

namespace AdRev.Desktop
{
    public partial class CitationEntryWindow : Window
    {
        public List<Citation> ResultCitations { get; private set; } = new List<Citation>();

        private ObservableCollection<Citation> _pendingGroup = new ObservableCollection<Citation>();

        public CitationEntryWindow()
        {
            InitializeComponent();
            PendingCitationsBox.ItemsSource = _pendingGroup;
        }

        private async void SearchDoi_Click(object sender, RoutedEventArgs e)
        {
            string query = CitDoiBox.Text.Trim();
            if (string.IsNullOrEmpty(query))
            {
                 MessageBox.Show("Veuillez entrer un DOI, un PMID ou un Titre.", "Recherche Manquante");
                 return;
            }

            // Cleanup DOI URL
            query = query.Replace("https://doi.org/", "").Replace("http://dx.doi.org/", "");
            
            // Detect Type
            bool isPmid = query.All(char.IsDigit) && query.Length < 10 && query.Length > 0;
            bool isDoi = query.Contains("10.") || query.Contains("/");

            try 
            {
                CitAuthorsBox.Text = "Recherche en cours...";
                
                using var client = new HttpClient();
                client.DefaultRequestHeaders.Add("User-Agent", "AdRev/1.0 (mailto:contact@adrev.com)");

                JsonDocument? doc = null;
                
                if (isPmid)
                {
                    var json = await client.GetStringAsync($"https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed&id={query}&retmode=json");
                    var root = JsonDocument.Parse(json);
                    
                    if (root.RootElement.TryGetProperty("result", out var result) && result.TryGetProperty(query, out var item))
                    {
                         if (item.TryGetProperty("title", out var t)) CitTitleBox.Text = t.GetString();
                         if (item.TryGetProperty("source", out var s)) CitSourceBox.Text = s.GetString();
                         if (item.TryGetProperty("pubdate", out var d)) 
                         {
                             var ds = d.GetString() ?? "";
                             if (ds.Length >= 4) CitYearBox.Text = ds.Substring(0, 4);
                         }
                         if (item.TryGetProperty("authors", out var authorsAuth))
                         {
                              var authorList = new List<string>();
                              foreach(var auth in authorsAuth.EnumerateArray())
                              {
                                  if (auth.TryGetProperty("name", out var n)) authorList.Add(n.GetString() ?? string.Empty);
                              }
                               if (authorList.Count > 3) 
                                    CitAuthorsBox.Text = string.Join(", ", authorList.Take(3)) + " et al.";
                                else
                                    CitAuthorsBox.Text = string.Join(", ", authorList);
                         }
                    }
                    else
                    {
                         MessageBox.Show("Aucun r√©sultat trouv√© sur PubMed.", "Info");
                         CitAuthorsBox.Text = "";
                    }
                }
                else
                {
                    string url = isDoi ? $"https://api.crossref.org/works/{query}" : $"https://api.crossref.org/works?query.bibliographic={System.Uri.EscapeDataString(query)}&rows=1";
                    
                    var json = await client.GetStringAsync(url);
                    doc = JsonDocument.Parse(json);
                    
                    JsonElement message = default;
                    
                    if (isDoi)
                    {
                        if (doc.RootElement.TryGetProperty("message", out var m)) message = m;
                    }
                    else
                    {
                        if (doc.RootElement.TryGetProperty("message", out var m) && m.TryGetProperty("items", out var items) && items.GetArrayLength() > 0)
                        {
                            message = items[0];
                        }
                    }

                    if (message.ValueKind != JsonValueKind.Undefined)
                    {
                        if (message.TryGetProperty("title", out var titles) && titles.GetArrayLength() > 0)
                            CitTitleBox.Text = titles[0].GetString();

                        if (message.TryGetProperty("author", out var authors))
                        {
                            var authorList = new List<string>();
                            foreach(var auth in authors.EnumerateArray())
                            {
                                string? family = auth.TryGetProperty("family", out var f) ? f.GetString() : "";
                                string? given = auth.TryGetProperty("given", out var g) ? g.GetString() : "";
                                if (!string.IsNullOrEmpty(family)) 
                                    authorList.Add($"{family} {given?.FirstOrDefault()}");
                            }
                            if (authorList.Count > 3) 
                                CitAuthorsBox.Text = string.Join(", ", authorList.Take(3)) + " et al.";
                            else
                                CitAuthorsBox.Text = string.Join(", ", authorList);
                        }
                        
                        var dateProp = message.TryGetProperty("published-print", out var pp) ? pp : 
                                       (message.TryGetProperty("created", out var c) ? c : default);
                                       
                        if (dateProp.ValueKind != JsonValueKind.Undefined && dateProp.TryGetProperty("date-parts", out var parts))
                        {
                            if (parts.GetArrayLength() > 0 && parts[0].GetArrayLength() > 0)
                                CitYearBox.Text = parts[0][0].ToString();
                        }

                        if (message.TryGetProperty("container-title", out var containers) && containers.GetArrayLength() > 0)
                            CitSourceBox.Text = containers[0].GetString();
                        else if (message.TryGetProperty("publisher", out var pub))
                             CitSourceBox.Text = pub.GetString();
                    }
                    else
                    {
                         MessageBox.Show("Aucun r√©sultat trouv√©.", "Info");
                         CitAuthorsBox.Text = "";
                    }
                }
            } 
            catch (Exception ex) 
            {
                MessageBox.Show("Erreur : " + ex.Message, "Erreur API");
                CitAuthorsBox.Text = ""; 
            }
        }

        private void AddToPending_Click(object sender, RoutedEventArgs e)
        {
            if (string.IsNullOrWhiteSpace(CitAuthorsBox.Text) || string.IsNullOrWhiteSpace(CitYearBox.Text))
            {
                MessageBox.Show("Auteurs et Ann√©e requis.", "Manquant", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            var cit = new Citation
            {
                Authors = CitAuthorsBox.Text,
                Year = CitYearBox.Text,
                Title = CitTitleBox.Text,
                Source = CitSourceBox.Text
            };
            if (string.IsNullOrEmpty(cit.Title)) cit.Title = "Sans titre";

            _pendingGroup.Add(cit);

            // Clear
            CitDoiBox.Text = "";
            CitAuthorsBox.Text = "";
            CitYearBox.Text = "";
            CitTitleBox.Text = "";
            CitSourceBox.Text = "";
            CitDoiBox.Focus();
        }

        private void Confirm_Click(object sender, RoutedEventArgs e)
        {
            // Add current fields if likely forgotten
            if (!string.IsNullOrWhiteSpace(CitAuthorsBox.Text))
            {
                AddToPending_Click(sender, e);
            }

            if (_pendingGroup.Count == 0)
            {
                MessageBox.Show("Liste vide.", "Info");
                return;
            }

            ResultCitations = _pendingGroup.ToList();
            DialogResult = true;
            Close();
        }

        private void Cancel_Click(object sender, RoutedEventArgs e)
        {
            DialogResult = false;
            Close();
        }

        private void Window_MouseDown(object sender, System.Windows.Input.MouseButtonEventArgs e)
        {
            if (e.ChangedButton == System.Windows.Input.MouseButton.Left)
                this.DragMove();
        }
    }
}




FILE: \AdRev.Desktop\DiscussionWindow.xaml
------------------------------------
<Window x:Class="AdRev.Desktop.DiscussionWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:AdRev.Desktop"
        Title="Assistant Discussion" Height="750" Width="1000"
        WindowStartupLocation="CenterScreen"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent">

    <Border Background="{StaticResource BackgroundBrush}" CornerRadius="20" BorderBrush="#DDD" BorderThickness="1">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <!-- Custom Title Bar -->
                <RowDefinition Height="*"/>    <!-- Content -->
                <RowDefinition Height="Auto"/> <!-- Footer -->
            </Grid.RowDefinitions>

            <!-- Custom Title Bar / Header -->
            <Border Grid.Row="0" Background="{StaticResource PrimaryBrush}" CornerRadius="19,19,0,0" Padding="20,15">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="üí¨" FontSize="24" VerticalAlignment="Center" Margin="0,0,15,0"/>
                        <StackPanel VerticalAlignment="Center">
                            <TextBlock Text="Assistant Discussion &amp; Commentaires" FontSize="20" FontWeight="Bold" Foreground="White"/>
                            <TextBlock Text="√âlaborez vos arguments scientifiques avec l'assistance AdRev" FontSize="12" Foreground="#AACCFF"/>
                        </StackPanel>
                    </StackPanel>

                    <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Top">
                        <Button Content="‚úï" Click="Close_Click" Width="30" Height="30" Background="Transparent" Foreground="White" BorderThickness="0" FontSize="16" FontWeight="Bold" Cursor="Hand"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- Main Content Area -->
            <Grid Grid.Row="1" Margin="25">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="1.8*"/> <!-- Main Editor -->
                    <ColumnDefinition Width="30"/>    <!-- Spacer -->
                    <ColumnDefinition Width="1.2*"/> <!-- Support / AI Panes -->
                </Grid.ColumnDefinitions>

                <!-- Left Column: Writing Area -->
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <!-- Top Illustration -->
                        <Border CornerRadius="12" Margin="0,0,0,25" Height="150" ClipToBounds="True">
                             <Image Source="{Binding ImageSource}" Stretch="UniformToFill" Opacity="0.9">
                                 <!-- We will set the ImageSource in code-behind if needed, or use a static resource if we move the file -->
                                 <!-- Since it's dynamic, I'll update the code-behind to set this -->
                             </Image>
                             <!-- Fallback design if image fails -->
                             <Border.Background>
                                 <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                     <GradientStop Color="#1A237E" Offset="0"/>
                                     <GradientStop Color="#4A148C" Offset="1"/>
                                 </LinearGradientBrush>
                             </Border.Background>
                        </Border>

                        <!-- Main Writing Tabs -->
                        <TabControl Background="Transparent" BorderThickness="0" Margin="0,0,0,20">
                            <!-- Tab 1: Global Draft -->
                            <TabItem Header="√âbauche Globale">
                                <Border Style="{StaticResource CardStyle}" Margin="0,10,0,0">
                                    <StackPanel>
                                        <Grid Margin="0,0,0,12">
                                            <StackPanel Orientation="Horizontal">
                                                <TextBlock Text="üìÑ Plan de Discussion G√©n√©ral" Style="{StaticResource LabelStyle}" VerticalAlignment="Center"/>
                                                <TextBlock Text="(Vue d'ensemble et synth√®se)" FontSize="10" Foreground="#888" VerticalAlignment="Center" Margin="10,0,0,0"/>
                                            </StackPanel>
                                            <Button HorizontalAlignment="Right" Content="+ Citer" Click="AddCitation_Click" Tag="DiscussionPlanTextBox" Style="{StaticResource SecondaryButtonStyle}" Padding="10,2" FontSize="11" Height="25"/>
                                        </Grid>
                                        <TextBox x:Name="DiscussionPlanTextBox" Height="300" TextWrapping="Wrap" AcceptsReturn="True" 
                                                 Tag="D√©crivez ici l'interpr√©tation de vos r√©sultats, la comparaison avec d'autres √©tudes..."
                                                 FontSize="14" FontFamily="Times New Roman"/>
                                    </StackPanel>
                                </Border>
                            </TabItem>

                            <!-- Tab 2: Writing by Objectives -->
                            <TabItem Header="Par Objectif Sp√©cifique">
                                <Border Style="{StaticResource CardStyle}" Margin="0,10,0,0">
                                    <StackPanel>
                                        <Grid Margin="0,0,0,15">
                                            <TextBlock Text="üéØ Interpr√©tation par Objectif" Style="{StaticResource LabelStyle}" VerticalAlignment="Center"/>
                                            <Button HorizontalAlignment="Right" Content="Fusionner tout" Click="MergeObjectives_Click" Style="{StaticResource SecondaryButtonStyle}" Padding="10,2" FontSize="11" Height="25"/>
                                        </Grid>
                                        
                                        <ItemsControl x:Name="ObjectivesItemsControl" ItemsSource="{Binding ObjectiveItems}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border BorderBrush="#F0F0F0" BorderThickness="0,0,0,1" Padding="0,0,0,15" Margin="0,0,0,15">
                                                        <StackPanel>
                                                            <TextBlock Text="{Binding ObjectiveTitle}" FontWeight="Bold" Foreground="{StaticResource PrimaryDarkBrush}" Margin="0,0,0,8" TextWrapping="Wrap"/>
                                                            <TextBox Text="{Binding Content, UpdateSourceTrigger=PropertyChanged}" 
                                                                     Height="100" TextWrapping="Wrap" AcceptsReturn="True" 
                                                                     FontSize="13" FontFamily="Times New Roman"
                                                                     Tag="Commentez ce r√©sultat par rapport √† l'objectif..."/>
                                                        </StackPanel>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>
                                </Border>
                            </TabItem>
                        </TabControl>

                        <!-- Limitations Card -->
                        <Border Style="{StaticResource CardStyle}">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel>
                                    <Grid Margin="0,0,0,12">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="‚ö†Ô∏è Limites de l'√©tude (Biais, Validit√©)" Style="{StaticResource LabelStyle}" VerticalAlignment="Center"/>
                                        </StackPanel>
                                        <Button HorizontalAlignment="Right" Content="+ Citer" Click="AddCitation_Click" Tag="LimitationsTextBox" Style="{StaticResource SecondaryButtonStyle}" Padding="10,2" FontSize="11" Height="25"/>
                                    </Grid>
                                    <TextBox x:Name="LimitationsTextBox" Height="120" TextWrapping="Wrap" AcceptsReturn="True"
                                             Tag="Biais de s√©lection, de rappel, perdus de vue... Analyse de la validit√© interne et externe."
                                             FontSize="14" FontFamily="Times New Roman"/>
                                </StackPanel>
                                <Image Grid.Column="1" Source="{Binding LimitationsImageSource}" Width="100" Height="100" Margin="15,0,0,0" VerticalAlignment="Center" Opacity="0.8"/>
                            </Grid>
                        </Border>
                    </StackPanel>
                </ScrollViewer>

                <!-- Right Column: AI Assistant & Norms -->
                <ScrollViewer Grid.Column="2" VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <!-- Magic Button -->
                        <Button Click="GeneratePlan_Click" Margin="0,0,0,20" Height="50" Cursor="Hand">
                            <Button.Background>
                                <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                    <GradientStop Color="#FF9800" Offset="0"/>
                                    <GradientStop Color="#F57C00" Offset="1"/>
                                </LinearGradientBrush>
                            </Button.Background>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="‚ú®" FontSize="20" Margin="0,0,10,0"/>
                                <TextBlock Text="G√©n√©rer une structure intelligente" FontWeight="Bold" Foreground="White" VerticalAlignment="Center"/>
                            </StackPanel>
                        </Button>

                        <!-- Norms Card -->
                        <Border Background="White" CornerRadius="12" Margin="0,0,0,20" Padding="15">
                            <Border.Effect>
                                <DropShadowEffect BlurRadius="10" Color="#E3F2FD" Opacity="0.5" ShadowDepth="2"/>
                            </Border.Effect>
                            <StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <TextBlock Text="üìò" FontSize="18" Margin="0,0,8,0"/>
                                    <TextBlock Text="Normes de Publication" FontWeight="Bold" Foreground="#1976D2" VerticalAlignment="Center"/>
                                </StackPanel>
                                <TextBlock x:Name="NormsText" Text="Chargement..." TextWrapping="Wrap" FontSize="12" Foreground="#455A64" LineHeight="18"/>
                                <Border Height="1" Background="#E0E0E0" Margin="0,15"/>
                                <TextBlock Text="Ces crit√®res sont extraits des checklists COREQ/STROBE recommand√©es pour votre √©tude." FontSize="10" Foreground="#999" FontStyle="Italic" TextWrapping="Wrap"/>
                            </StackPanel>
                        </Border>

                        <!-- Expert Card -->
                        <Border Background="#FFF8E1" CornerRadius="12" Padding="15" BorderBrush="#FFE082" BorderThickness="1">
                             <StackPanel>
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                    <TextBlock Text="üí°" FontSize="18" Margin="0,0,8,0"/>
                                    <TextBlock Text="Conseils d'Expert" FontWeight="Bold" Foreground="#F57C00" VerticalAlignment="Center"/>
                                </StackPanel>
                                <TextBlock x:Name="ExpertText" Text="Chargement..." TextWrapping="Wrap" FontSize="12" Foreground="#5D4037" LineHeight="18"/>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </ScrollViewer>
            </Grid>

            <!-- Footer Actions -->
            <Border Grid.Row="2" Background="White" Padding="25,15" CornerRadius="0,0,19,19" BorderBrush="#EEE" BorderThickness="0,1,0,0">
                <Grid>
                    <TextBlock Text="Les modifications sont enregistr√©es localement dans votre protocole." VerticalAlignment="Center" Foreground="#AAA" FontSize="11" FontStyle="Italic"/>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button Content="Annuler" IsCancel="True" Style="{StaticResource SecondaryButtonStyle}" Width="120" Height="40" Margin="0,0,15,0"/>
                        <Button Content="Valider &amp; Enregistrer" Click="Save_Click" Style="{StaticResource ModernButtonStyle}" Width="200" Height="40" FontWeight="Bold"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>
    </Border>
</Window>




FILE: \AdRev.Desktop\DiscussionWindow.xaml.cs
------------------------------------
using System;
using System.Windows;
using System.Linq;
using AdRev.Domain.Enums;
using AdRev.Domain.Models;
using AdRev.Core.Services;
using System.Collections.Generic;

namespace AdRev.Desktop
{
    public partial class DiscussionWindow : Window
    {
        private readonly QualityService _qualityService = new QualityService();
        private readonly StudyType _studyType;
        private readonly string _objectives;
        public System.Collections.ObjectModel.ObservableCollection<ObjectiveItem> ObjectiveItems { get; set; } = new System.Collections.ObjectModel.ObservableCollection<ObjectiveItem>();

        public class ObjectiveItem : System.ComponentModel.INotifyPropertyChanged
        {
            public string ObjectiveTitle { get; set; } = "";
            private string _content = "";
            public string Content 
            { 
                get => _content; 
                set { _content = value; OnPropertyChanged(nameof(Content)); } 
            }

            public event System.ComponentModel.PropertyChangedEventHandler? PropertyChanged;
            protected void OnPropertyChanged(string name) => PropertyChanged?.Invoke(this, new System.ComponentModel.PropertyChangedEventArgs(name));
        }
        
        public string DiscussionPlan { get; private set; } = string.Empty;
        public string Limitations { get; private set; } = string.Empty;
        
        // Citation support
        public List<Citation> NewCitations { get; private set; } = new List<Citation>();
        private int _nextCitationIndex;
        private ReferenceStyle _currentStyle;
        private System.Windows.Controls.TextBox? _targetBox;

        public string ImageSource { get; set; } = "pack://application:,,,/AdRev.Desktop;component/Assets/Discussion/discussion_assistant_header_1768519440517.png";
        public string LimitationsImageSource { get; set; } = "pack://application:,,,/AdRev.Desktop;component/Assets/Discussion/discussion_limitations_icon_1768519561449.png";

        public DiscussionWindow(StudyType studyType, string specificObjectives, string currentPlan, string currentLimitations, int nextCitationIndex, ReferenceStyle style)
        {
            InitializeComponent();
            this.DataContext = this;
            _studyType = studyType;
            _objectives = specificObjectives;
            _nextCitationIndex = nextCitationIndex;
            _currentStyle = style;

            DiscussionPlanTextBox.Text = currentPlan;
            LimitationsTextBox.Text = currentLimitations;

            InitializeObjectiveItems();
            LoadSupportPath();
        }

        private void InitializeObjectiveItems()
        {
            if (string.IsNullOrWhiteSpace(_objectives)) return;

            var lines = _objectives.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
            foreach (var line in lines)
            {
                string clean = line.Trim();
                if (clean.StartsWith("‚Ä¢") || clean.StartsWith("-")) clean = clean.Substring(1).Trim();
                if (clean.Length > 5)
                {
                    ObjectiveItems.Add(new ObjectiveItem { ObjectiveTitle = clean });
                }
            }
        }

        private void MergeObjectives_Click(object sender, RoutedEventArgs e)
        {
            var sb = new System.Text.StringBuilder(DiscussionPlanTextBox.Text);
            if (sb.Length > 0 && !sb.ToString().EndsWith("\n")) sb.AppendLine();

            foreach (var item in ObjectiveItems)
            {
                if (!string.IsNullOrWhiteSpace(item.Content))
                {
                    sb.AppendLine($"--- {item.ObjectiveTitle} ---");
                    sb.AppendLine(item.Content);
                    sb.AppendLine();
                }
            }
            DiscussionPlanTextBox.Text = sb.ToString();
            MessageBox.Show("Les interpr√©tations par objectif ont √©t√© ajout√©es √† l'√©bauche globale.", "Fusion r√©ussie");
        }

        private void Close_Click(object sender, RoutedEventArgs e)
        {
            this.Close();
        }

        protected override void OnMouseLeftButtonDown(System.Windows.Input.MouseButtonEventArgs e)
        {
            base.OnMouseLeftButtonDown(e);
            if (e.ButtonState == System.Windows.Input.MouseButtonState.Pressed)
                DragMove();
        }



        private void LoadSupportPath()
        {
            var dummyProject = new ResearchProject { StudyType = _studyType };
            var checklists = _qualityService.GetRecommendedChecklists(dummyProject);

            var sbNorms = new System.Text.StringBuilder();
            var sbExpert = new System.Text.StringBuilder();

            // Normes
            if (checklists != null)
            {
                foreach(var list in checklists)
                {
                    var discSection = list.Sections.FirstOrDefault(s => s.Name.Contains("Discussion") || s.Name.Contains("Reporting") || s.Name.Contains("Analyse"));
                    if (discSection != null)
                    {
                        sbNorms.AppendLine($"--- {list.Name} ---");
                        foreach(var item in discSection.Items)
                        {
                           if(item.Requirement.Contains("R√©sultat") || item.Requirement.Contains("Limitation") || item.Requirement.Contains("Interpr√©tation"))
                                sbNorms.AppendLine($"‚Ä¢ {item.Requirement}");
                        }
                    }
                }
            }
            if (sbNorms.Length == 0) sbNorms.Append("Aucune norme sp√©cifique d√©tect√©e.");

            // Id√©es Expert
            sbExpert.AppendLine("‚Ä¢ Commencez par un r√©sum√© factuel.");
            if (_studyType == StudyType.Quantitative)
            {
                sbExpert.AppendLine("‚Ä¢ Discutez la validit√© interne.");
                sbExpert.AppendLine("‚Ä¢ Comparez avec la litt√©rature.");
                sbExpert.AppendLine("‚Ä¢ G√©n√©ralisabilit√©.");
            }
            else if (_studyType == StudyType.Qualitative)
            {
                sbExpert.AppendLine("‚Ä¢ R√©flexivit√© du chercheur.");
                sbExpert.AppendLine("‚Ä¢ Int√©gration th√©orique.");
                sbExpert.AppendLine("‚Ä¢ Transf√©rabilit√©.");
            }

            NormsText.Text = sbNorms.ToString();
            ExpertText.Text = sbExpert.ToString();
        }

        private void GeneratePlan_Click(object sender, RoutedEventArgs e)
        {
             var sb = new System.Text.StringBuilder();
             
             sb.AppendLine("1. RESUME DES RESULTATS");
             sb.AppendLine("- Rappel succinct du r√©sultat principal.");
             sb.AppendLine("");

             sb.AppendLine("2. COMPARAISON AVEC LA LITTERATURE");
             if (!string.IsNullOrWhiteSpace(_objectives))
             {
                 var lines = _objectives.Split(new[] {'\r', '\n'}, StringSplitOptions.RemoveEmptyEntries);
                 foreach(var line in lines)
                 {
                     string clean = line.Replace("‚Ä¢", "").Replace("-", "").Trim();
                     if (clean.Length > 5)
                         sb.AppendLine($"- Point pour : {clean}");
                 }
             }
             else
             {
                 sb.AppendLine("- Discutez chaque objectif sp√©cifique.");
             }
             sb.AppendLine("");

             sb.AppendLine("3. FORCES ET LIMITES");
             sb.AppendLine("- Forces m√©thodologiques.");
             sb.AppendLine("- Limites (Biais...)");
             sb.AppendLine("");

             sb.AppendLine("4. IMPLICATIONS");
             sb.AppendLine("- Recommandations.");

             DiscussionPlanTextBox.Text = sb.ToString();
        }

        private void AddCitation_Click(object sender, RoutedEventArgs e)
        {
             if (sender is System.Windows.Controls.Button btn && btn.Tag is string boxName)
            {
                _targetBox = this.FindName(boxName) as System.Windows.Controls.TextBox;
            }

            var dialog = new CitationEntryWindow();
            if (dialog.ShowDialog() == true && dialog.ResultCitations.Any())
            {
                var added = dialog.ResultCitations;
                NewCitations.AddRange(added);

                List<int> addedIndices = new List<int>();
                foreach(var c in added)
                {
                    addedIndices.Add(_nextCitationIndex++);
                }

                if (_targetBox != null)
                {
                   int caretIndex = _targetBox.CaretIndex;
                   string marker = "";

                   if (IsNumericStyle(_currentStyle) || _currentStyle == ReferenceStyle.MHRA)
                   {
                       if (addedIndices.Count == 1) marker = $" [{addedIndices[0]}]";
                       else marker = $" [{string.Join(", ", addedIndices)}]";
                   }
                   else if (_currentStyle == ReferenceStyle.Chicago)
                   {
                        var parts = added.Select(c => $"{c.Authors} {c.Year}");
                        marker = $" ({string.Join("; ", parts)})";
                   }
                   else if (_currentStyle == ReferenceStyle.MLA)
                   {
                        var parts = added.Select(c => $"{c.Authors}");
                        marker = $" ({string.Join("; ", parts)})";
                   }
                   else if (_currentStyle == ReferenceStyle.Elsevier)
                   {
                        var parts = added.Select(c => $"{c.Authors}, {c.Year}");
                        marker = $" ({string.Join("; ", parts)})";
                   }
                   else
                   {
                       var parts = added.Select(c => $"{c.Authors}, {c.Year}");
                       marker = $" ({string.Join("; ", parts)})";
                   }

                   _targetBox.Text = _targetBox.Text.Insert(caretIndex, marker);
                   _targetBox.CaretIndex = caretIndex + marker.Length;
                   _targetBox.Focus();
                }
            }
        }

        private bool IsNumericStyle(ReferenceStyle style)
        {
            return style == ReferenceStyle.Vancouver || style == ReferenceStyle.IEEE || 
                   style == ReferenceStyle.AMA || style == ReferenceStyle.Nature || 
                   style == ReferenceStyle.Science || style == ReferenceStyle.ISO690_Numeric ||
                   style == ReferenceStyle.ACS;
        }

        private void Save_Click(object sender, RoutedEventArgs e)
        {
            DiscussionPlan = DiscussionPlanTextBox.Text;
            Limitations = LimitationsTextBox.Text;
            DialogResult = true;
            Close();
        }
    }
}




FILE: \AdRev.Desktop\EnumDescriptionConverter.cs
------------------------------------
using System;
using System.ComponentModel;
using System.Globalization;
using System.Reflection;
using System.Windows.Data;

namespace AdRev.Desktop
{
    public class EnumDescriptionConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            if (value == null) return string.Empty;

            var type = value.GetType();
            if (!type.IsEnum) return value.ToString() ?? string.Empty;

            var name = value.ToString();
            if (name == null) return string.Empty;

            var fieldInfo = type.GetField(name);
            if (fieldInfo == null) return name;

            var attributes = (DescriptionAttribute[]?)fieldInfo.GetCustomAttributes(typeof(DescriptionAttribute), false);

            return (attributes != null && attributes.Length > 0) ? attributes[0].Description : name;
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            return value;
        }
    }
}




FILE: \AdRev.Desktop\HelpWindow.xaml
------------------------------------
<Window x:Class="AdRev.Desktop.HelpWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Centre d'Aide AdRev - Documentation &amp; Support" Height="700" Width="1000"
        WindowStartupLocation="CenterScreen"
        Background="#F4F6F9"
        FontFamily="Segoe UI">

    <Window.Resources>
        <!-- Custom Styles specific to Help Window -->
        <Style x:Key="SidebarHeaderStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="#90A4AE"/>
            <Setter Property="Margin" Value="20,15,0,5"/>

        </Style>

        <Style x:Key="SidebarItemContainerStyle" TargetType="ListBoxItem">
            <Setter Property="Padding" Value="20,8"/>
            <Setter Property="Margin" Value="10,2"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Foreground" Value="#455A64"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="ListBoxItem">
                        <Border Name="Border" Background="Transparent" CornerRadius="6" Padding="{TemplateBinding Padding}">
                            <ContentPresenter VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsSelected" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="#E3F2FD"/> <!-- Light Blue -->
                                <Setter Property="Foreground" Value="#1565C0"/> <!-- Dark Blue -->
                                <Setter Property="FontWeight" Value="SemiBold"/>
                            </Trigger>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter TargetName="Border" Property="Background" Value="#F5F5F5"/>
                                <Setter Property="Foreground" Value="Black"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="260"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- LEFT SIDEBAR -->
        <Border Background="White" BorderBrush="#ECEFF1" BorderThickness="0,0,1,0">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/> <!-- Branding -->
                    <RowDefinition Height="*"/>    <!-- Menu List -->
                    <RowDefinition Height="Auto"/> <!-- Footer Actions -->
                </Grid.RowDefinitions>

                <!-- Branding Header -->
                <StackPanel Grid.Row="0" Margin="25,30,25,20">
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                         <!-- Simple SVG-like path or icon -->
                        <TextBlock Text="üìò" FontSize="24" Margin="0,0,10,0" VerticalAlignment="Center"/> 
                        <TextBlock Text="AdRev" FontSize="24" FontWeight="Bold" Foreground="#263238" VerticalAlignment="Center"/>
                    </StackPanel>
                    <TextBlock Text="Centre de Documentation" FontSize="13" Foreground="#78909C"/>
                    
                    <!-- Search Input (Placeholder) -->
                    <Border Margin="0,20,0,0" Background="#F4F6F9" CornerRadius="8" Padding="10,6">
                        <TextBlock Text="üîç  Rechercher..." Foreground="#B0BEC5" FontStyle="Italic"/>
                    </Border>
                </StackPanel>

                <!-- Navigation List -->
                <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <!-- Section: GENERAL -->
                        <TextBlock Text="G√©n√©ral" Style="{StaticResource SidebarHeaderStyle}"/>
                        <ListBox x:Name="MenuGeneral" BorderThickness="0" Background="Transparent" ItemContainerStyle="{StaticResource SidebarItemContainerStyle}" SelectionChanged="Menu_SelectionChanged">
                            <ListBoxItem Tag="Intro">Introduction &amp; Accueil</ListBoxItem>
                            <ListBoxItem Tag="Dashboard">Tableau de Bord</ListBoxItem>
                        </ListBox>

                        <!-- Section: FONCTIONNALIT√âS -->
                        <TextBlock Text="Fonctionnalit√©s" Style="{StaticResource SidebarHeaderStyle}"/>
                        <ListBox x:Name="MenuFeatures" BorderThickness="0" Background="Transparent" ItemContainerStyle="{StaticResource SidebarItemContainerStyle}" SelectionChanged="Menu_SelectionChanged">
                            <ListBoxItem Tag="Protocol">√âditeur de Protocoles</ListBoxItem>
                            <ListBoxItem Tag="Data">Saisie de Donn√©es</ListBoxItem>
                            <ListBoxItem Tag="Analysis">Analyse Statistique</ListBoxItem>
                            <ListBoxItem Tag="Discussion">Discussion &amp; Rapports</ListBoxItem>
                        </ListBox>

                        <!-- Section: AIDE & SUPPORT -->
                        <TextBlock Text="Support" Style="{StaticResource SidebarHeaderStyle}"/>
                        <ListBox x:Name="MenuSupport" BorderThickness="0" Background="Transparent" ItemContainerStyle="{StaticResource SidebarItemContainerStyle}" SelectionChanged="Menu_SelectionChanged">
                            <ListBoxItem Tag="FAQ">Questions Fr√©quentes</ListBoxItem>
                            <ListBoxItem Tag="About">√Ä propos</ListBoxItem>
                        </ListBox>
                    </StackPanel>
                </ScrollViewer>

                <!-- Footer Actions -->
                <Border Grid.Row="2" Padding="20" BorderBrush="#ECEFF1" BorderThickness="0,1,0,0">
                     <Button Click="OpenPdfManual_Click" Style="{StaticResource ModernButtonStyle}" Background="#37474F" Margin="0">
                         <StackPanel Orientation="Horizontal">
                             <TextBlock Text="üìÑ" Margin="0,0,8,0"/>
                             <TextBlock Text="Ouvrir le Manuel PDF"/>
                         </StackPanel>
                     </Button>
                </Border>
            </Grid>
        </Border>

        <!-- RIGHT CONTENT AREA -->
        <Grid Grid.Column="1" Background="#FFFFFF">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/> <!-- Content Header -->
                <RowDefinition Height="*"/>    <!-- Scrollable Content -->
            </Grid.RowDefinitions>

            <!-- Header Banner -->
            <Border Grid.Row="0" Background="#FAFAFA" BorderBrush="#F0F0F0" BorderThickness="0,0,0,1" Padding="40,30">
                <StackPanel>
                    <TextBlock x:Name="TopicBreadcrumb" Text="Documentation > Introduction" FontSize="12" Foreground="#90A4AE" Margin="0,0,0,10" FontWeight="SemiBold"/>
                    <TextBlock x:Name="TopicTitle" Text="Bienvenue sur AdRev" FontSize="32" FontWeight="Bold" Foreground="#263238"/>
                </StackPanel>
            </Border>

            <!-- Main Content -->
            <ScrollViewer Grid.Row="1" Padding="40,30,40,40" VerticalScrollBarVisibility="Auto">
                 <!-- 
                    Using simple formatting tweaks:
                    Background=White, Foreground=Black specifically set.
                 -->
                <RichTextBox x:Name="ContentRichText" IsReadOnly="True" BorderThickness="0" Background="White" Foreground="Black" FontSize="16" FontFamily="Cambria" Padding="0">
                    <RichTextBox.Resources>
                        <Style TargetType="Paragraph">
                            <Setter Property="Margin" Value="0,0,0,15"/>
                            <Setter Property="LineHeight" Value="24"/>
                        </Style>
                    </RichTextBox.Resources>
                    <FlowDocument PagePadding="0">
                        <Paragraph Foreground="#555">S√©lectionnez un sujet dans le menu de gauche pour commencer.</Paragraph>
                    </FlowDocument>
                </RichTextBox>
            </ScrollViewer>
        </Grid>
    </Grid>
</Window>




FILE: \AdRev.Desktop\HelpWindow.xaml.cs
------------------------------------
using System;
using System.Diagnostics;
using System.IO;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Documents;
using System.Windows.Media;

namespace AdRev.Desktop
{
    public partial class HelpWindow : Window
    {
        public HelpWindow()
        {
            InitializeComponent();
            LoadTopic("Intro");
        }

        private void Menu_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (sender is ListBox listBox && listBox.SelectedItem is ListBoxItem item && item.Tag is string topic)
            {
                // Unselect others
                if (listBox != MenuGeneral) MenuGeneral.SelectedIndex = -1;
                if (listBox != MenuFeatures) MenuFeatures.SelectedIndex = -1;
                if (listBox != MenuSupport) MenuSupport.SelectedIndex = -1;

                // Restore selection if it was cleared by the above
                listBox.SelectedItem = item; 
                
                LoadTopic(topic);
                if (TopicBreadcrumb != null) TopicBreadcrumb.Text = $"Documentation > {item.Content}";
            }
        }

        public void LoadTopic(string topic)
        {
            if (TopicTitle == null || ContentRichText == null) return;

            FlowDocument doc = new FlowDocument();
            doc.FontFamily = new FontFamily("Segoe UI");
            doc.FontSize = 14;
            doc.PagePadding = new Thickness(0);

            switch (topic)
            {
                case "Intro":
                    TopicTitle.Text = "Bienvenue dans AdRev";
                    AddParagraph(doc, "AdRev est votre plateforme int√©gr√©e pour la recherche m√©dicale, con√ßue pour simplifier la conception de protocoles, la gestion de donn√©es et l'analyse statistique.", true);
                    AddImage(doc, "Assets/help_dashboard.png");
                    AddHeader(doc, "üöÄ D√©marrage Rapide");
                    AddParagraph(doc, "1. **Cr√©ation** : Commencez par cr√©er un nouveau projet depuis le tableau de bord.");
                    AddParagraph(doc, "2. **√âtapes** : Suivez le flux de travail guid√© : Protocole ‚Üí Variables ‚Üí Collecte ‚Üí Analyse ‚Üí Rapport.");
                    AddParagraph(doc, "3. **Sauvegarde** : Utilisez l'ic√¥ne de sauvegarde rapide dans la barre de titre pour ne rien perdre.");
                    break;

                case "Dashboard":
                    TopicTitle.Text = "Tableau de Bord Central";
                    AddParagraph(doc, "Le point d'entr√©e de tous vos travaux de recherche.", true);
                    AddHeader(doc, "√âl√©ments Cl√©s");
                    AddBullet(doc, "Projets R√©cents : Affiche vos derniers travaux avec leur statut d'avancement.");
                    AddBullet(doc, "Nouveau Projet : Lance l'assistant de cr√©ation guid√©e.");
                    AddBullet(doc, "Importation Directe : Pour analyser un fichier Excel/CSV sans cr√©er de projet complet.");
                    AddHeader(doc, "Statistiques de Session");
                    AddParagraph(doc, "La barre lat√©rale affiche des statistiques sur votre productivit√© et l'√©tat global de vos bases de donn√©es.");
                    break;

                case "Protocol":
                    TopicTitle.Text = "Conception du Protocole (IMRAD/SPIRIT)";
                    AddParagraph(doc, "L'√©diteur de protocole assure que votre √©tude respecte les standards scientifiques internationaux.", true);
                    AddImage(doc, "Assets/help_protocol.png");
                    AddHeader(doc, "Navigation par √âtapes");
                    AddParagraph(doc, "Le menu lat√©ral gauche vous permet de naviguer √† travers les 14 √©tapes cruciales :");
                    AddBullet(doc, "Introduction & Contexte : Justification scientifique de l'√©tude.");
                    AddBullet(doc, "Objectifs : D√©finition pr√©cise (G√©n√©ral et Sp√©cifiques).");
                    AddBullet(doc, "M√©thodologie : Type d'√©tude, population, et crit√®res d'√©ligibilit√©.");
                    AddBullet(doc, "√âchantillonnage : Utilisez les calculatrices (Cochran, etc.) pour d√©terminer la taille N.");
                    AddHeader(doc, "Citations Bibliographiques");
                    AddParagraph(doc, "Cliquez sur 'Citer' pour ajouter des r√©f√©rences. AdRev g√®re automatiquement les styles Vancouver et APA.");
                    break;

                case "Analysis":
                    TopicTitle.Text = "Analyse Statistique & Qualitative";
                    AddParagraph(doc, "Un outil de traitement de donn√©es puissant sans la complexit√© des logiciels traditionnels.", true);
                    AddImage(doc, "Assets/help_analysis.png");
                    AddHeader(doc, "Analyses Quantitatives");
                    AddBullet(doc, "Descriptives : Tableaux de fr√©quences, moyennes, √©cart-types.");
                    AddBullet(doc, "Inf√©rentielles : Automatisation des tests selon la nature des variables (Chi2, Student, ANOVA).");
                    AddBullet(doc, "Mod√©lisation : R√©gression lin√©aire et logistique simplifi√©e.");
                    AddHeader(doc, "Analyses Qualitatives");
                    AddParagraph(doc, "Utilisez l'Atelier de Codage pour identifier les th√®mes dans vos entretiens ou focus groups.");
                    break;

                case "Discussion":
                    TopicTitle.Text = "Aide √† la Discussion & Publication";
                    AddParagraph(doc, "L'√©tape finale pour transformer vos r√©sultats en publications scientifiques.", true);
                    AddHeader(doc, "Assistant Discussion üí¨");
                    AddParagraph(doc, "Un module interactif qui vous aide √† structurer vos arguments selon le sch√©ma IMRAD.");
                    AddHeader(doc, "Exportation Word");
                    AddParagraph(doc, "G√©n√©rez en un clic votre protocole, votre manuel de variables, ou votre manuscrit final au format .docx.");
                    break;

                case "FAQ":
                    TopicTitle.Text = "FAQ & Support";
                    AddHeader(doc, "Besoin d'aide ?");
                    AddParagraph(doc, "Pour toute question technique, veuillez contacter le support informatique du laboratoire ou consulter la documentation PDF compl√®te.");
                    AddParagraph(doc, "Version : 1.0 - Janvier 2026");
                    break;

                case "About":
                    TopicTitle.Text = "√Ä propos d'AdRev";
                    AddParagraph(doc, "AdRev Desktop App", true);
                    AddParagraph(doc, "Version 1.0.0 (√âdition Initiale)");
                    AddParagraph(doc, "¬© 2024-2026 AdRev Science Team. Tous droits r√©serv√©s.");
                    AddHeader(doc, "Cr√©dits");
                    AddParagraph(doc, "D√©velopp√© par l'√©quipe AdRev avec WPF & .NET 8.");
                    AddParagraph(doc, "Ic√¥nes par Segoe MDL2 Assets.");
                    break;
            }

            ContentRichText.Document = doc;
        }

        private void AddHeader(FlowDocument doc, string text)
        {
            var run = new Run(text) { Foreground = Brushes.Black };
            doc.Blocks.Add(new Paragraph(run) 
            { 
                FontSize = 18, 
                FontWeight = FontWeights.Bold, 
                Foreground = Brushes.Black,
                Margin = new Thickness(0, 20, 0, 10)
            });
        }

        private void AddParagraph(FlowDocument doc, string text, bool isBold = false)
        {
            var run = new Run(text);
            run.Foreground = Brushes.Black;
            var p = new Paragraph(run);
            p.Foreground = Brushes.Black;
            if (isBold) p.FontWeight = FontWeights.SemiBold;
            p.Margin = new Thickness(0, 0, 0, 10);
            doc.Blocks.Add(p);
        }

        private void AddBullet(FlowDocument doc, string text)
        {
            var list = new List();
            list.MarkerStyle = TextMarkerStyle.Disc;
            list.Margin = new Thickness(10, 0, 0, 0);
            var run = new Run(text);
            run.Foreground = Brushes.Black;
            var p = new Paragraph(run);
            p.Foreground = Brushes.Black;
            list.ListItems.Add(new ListItem(p));
            doc.Blocks.Add(list);
        }

        private void AddImage(FlowDocument doc, string assetPath)
        {
            try
            {
                var fullPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, assetPath);
                // Fallback if running from IDE/different path
                if (!File.Exists(fullPath)) fullPath = Path.GetFullPath(assetPath);

                if (File.Exists(fullPath))
                {
                    var bitmap = new System.Windows.Media.Imaging.BitmapImage(new Uri(fullPath));
                    var image = new Image { Source = bitmap, MaxWidth = 600, Stretch = Stretch.Uniform, Margin = new Thickness(0, 10, 0, 15) };
                    
                    var container = new InlineUIContainer(image);
                    var p = new Paragraph(container);
                    doc.Blocks.Add(p);
                }
            }
            catch { /* Silent fail for images */ }
        }

        private void OpenPdfManual_Click(object sender, RoutedEventArgs e)
        {
            string pdfPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "MANUEL_UTILISATEUR.pdf");
            string mdPath = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, "MANUEL_UTILISATEUR.md");

            string? fileToOpen = null;

            if (File.Exists(pdfPath))
            {
                fileToOpen = pdfPath;
            }
            else if (File.Exists("MANUEL_UTILISATEUR.pdf")) // Check current dir just in case
            {
                fileToOpen = Path.GetFullPath("MANUEL_UTILISATEUR.pdf");
            }
            else if (File.Exists(mdPath))
            {
                var result = MessageBox.Show("Le manuel PDF n'est pas encore g√©n√©r√©. Voulez-vous ouvrir la version texte (Markdown) ?", "PDF Introuvable", MessageBoxButton.YesNo, MessageBoxImage.Information);
                if (result == MessageBoxResult.Yes)
                {
                    fileToOpen = mdPath;
                }
                else return;
            }
            else
            {
                MessageBox.Show("Le manuel d'utilisation est introuvable.", "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
                return;
            }

            if (fileToOpen != null)
            {
                try
                {
                    Process.Start(new ProcessStartInfo(fileToOpen) { UseShellExecute = true });
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Erreur lors de l'ouverture du manuel : {ex.Message}", "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }
    }
}




FILE: \AdRev.Desktop\InterviewWindow.cs
------------------------------------
using System;
using System.Windows;
using System.Windows.Media;

namespace AdRev.Desktop
{
    // Simple placeholder window for Interview/Focus Group
    public class InterviewWindow : Window
    {
        public bool IsFocusGroup { get; }

        public InterviewWindow(bool isFocusGroup)
        {
            IsFocusGroup = isFocusGroup;
            Title = isFocusGroup ? "Focus Group Session" : "Entretien Individuel";
            Width = 800;
            Height = 600;
            WindowStartupLocation = WindowStartupLocation.CenterScreen;
            Background = Brushes.White;

            var grid = new System.Windows.Controls.Grid();
            grid.RowDefinitions.Add(new System.Windows.Controls.RowDefinition { Height = System.Windows.GridLength.Auto });
            grid.RowDefinitions.Add(new System.Windows.Controls.RowDefinition { Height = new System.Windows.GridLength(1, System.Windows.GridUnitType.Star) });

            // Header
            var header = new System.Windows.Controls.TextBlock 
            { 
                Text = Title, 
                FontSize = 24, 
                FontWeight = FontWeights.Bold, 
                Margin = new Thickness(20),
                Foreground = Brushes.DarkSlateBlue
            };
            grid.Children.Add(header);

            // Mock Content
            var content = new System.Windows.Controls.TextBlock
            {
                Text = isFocusGroup 
                    ? "Module de gestion de Focus Group en cours de d√©veloppement.\nFonctionnalit√©s pr√©vues : attribution des paroles, chronom√©trage, notes d'observation."
                    : "Module de transcription d'entretien individuel.\nFonctionnalit√©s pr√©vues : enregistrement audio, prise de notes synchronis√©e, codage √† la vol√©e.",
                Margin = new Thickness(20),
                FontSize = 14,
                Foreground = Brushes.Gray,
                TextWrapping = TextWrapping.Wrap
            };
            System.Windows.Controls.Grid.SetRow(content, 1);
            grid.Children.Add(content);

            Content = grid;
        }
    }
}




FILE: \AdRev.Desktop\MainWindow.xaml
------------------------------------
<Window x:Class="AdRev.Desktop.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AdRev.Desktop"
        mc:Ignorable="d"
        Title="AdRev - Science Suite" Height="750" Width="1200"
        MinHeight="650" MinWidth="1024"
        WindowStartupLocation="Manual"
        Closing="Window_Closing"
        Icon="pack://application:,,,/AdRev.Desktop;component/Assets/AppIcon.png"
        Background="{StaticResource BackgroundBrush}">

    <WindowChrome.WindowChrome>
        <WindowChrome CaptionHeight="40" ResizeBorderThickness="8" CornerRadius="0" GlassFrameThickness="0"/>
    </WindowChrome.WindowChrome>

    <Window.Resources>
        <!-- Resources moved to App.xaml -->
    </Window.Resources>
    
    <!-- Main Window Border (The Frame) -->
    <Border BorderBrush="{StaticResource PrimaryDarkBrush}" BorderThickness="1">
    <Grid>
        <!-- Background Logo Watermark -->
        <Grid.Background>
            <VisualBrush Opacity="0.12" Stretch="None" AlignmentX="Center" AlignmentY="Center">
                <VisualBrush.Visual>
                    <Grid Width="400" Height="400">
                        <Viewbox Width="400" Height="400">
                            <TextBlock Text="AdRev" 
                                      FontSize="120" 
                                      FontWeight="Black"
                                      Foreground="{StaticResource PrimaryBrush}"
                                      HorizontalAlignment="Center"
                                      VerticalAlignment="Center"
                                      RenderTransformOrigin="0.5,0.5">
                                <TextBlock.RenderTransform>
                                    <RotateTransform Angle="-45"/>
                                </TextBlock.RenderTransform>
                            </TextBlock>
                        </Viewbox>
                    </Grid>
                </VisualBrush.Visual>
            </VisualBrush>
        </Grid.Background>
        
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Title Bar / Tabs -->
            <RowDefinition Height="Auto"/> <!-- Ribbon Commands -->
            <RowDefinition Height="*"/>    <!-- Content -->
            <RowDefinition Height="25"/>   <!-- Status Bar -->
        </Grid.RowDefinitions>

        <!-- 1. TOP RIBBON TABS -->
        <Border Grid.Row="0" Background="{StaticResource PrimaryDarkBrush}" Padding="10,5,10,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/> <!-- Window Controls -->
                </Grid.ColumnDefinitions>
                
                <!-- Quick Access Toolbar + Title -->
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,30,5" WindowChrome.IsHitTestVisibleInChrome="True">
                     <TextBlock Text="AdRev" Foreground="White" FontSize="18" FontWeight="Black" VerticalAlignment="Center" Margin="0,0,15,0"/>
                     
                     <Button Content="&#xE74E;" Click="QuickSave_Click" ToolTip="Enregistrer" Background="Transparent" Foreground="#E0E0E0" BorderThickness="0" FontFamily="Segoe MDL2 Assets" FontSize="14" Margin="0,0,5,0" Padding="5"/>
                     <Button Content="&#xE8E5;" Click="QuickOpen_Click" ToolTip="Ouvrir" Background="Transparent" Foreground="#E0E0E0" BorderThickness="0" FontFamily="Segoe MDL2 Assets" FontSize="14" Margin="0,0,5,0" Padding="5"/>
                     <Button Content="&#xE72D;" Click="QuickShare_Click" ToolTip="Partager" Background="Transparent" Foreground="#E0E0E0" BorderThickness="0" FontFamily="Segoe MDL2 Assets" FontSize="14" Margin="0,0,5,0" Padding="5"/>
                </StackPanel>
                
                <!-- Tabs -->
                <StackPanel Grid.Column="1" Orientation="Horizontal" WindowChrome.IsHitTestVisibleInChrome="True">
                    <RadioButton x:Name="RibbonFile" Style="{StaticResource RibbonTabButtonStyle}" Content="Fichier" IsChecked="True" Checked="Ribbon_Checked"/>
                    <RadioButton x:Name="RibbonHelp" Style="{StaticResource RibbonTabButtonStyle}" Content="Aide" Checked="Ribbon_Checked"/>
                </StackPanel>

                <!-- Window Control Buttons (Top Right) -->
                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Top" Margin="0,-5,-10,0">
                    <Button Style="{StaticResource WindowControlButtonStyle}" Content="&#xE921;" Click="Minimize_Click" ToolTip="R√©duire"/>
                    <Button Style="{StaticResource WindowControlButtonStyle}" Content="&#xE922;" Click="Maximize_Click" ToolTip="Agrandir/Restaurer"/>
                    <Button Style="{StaticResource CloseButtonStyle}" Content="&#xE8BB;" Click="Close_Click" ToolTip="Fermer"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- 2. RIBBON COMMANDS PANEL -->
        <Border Grid.Row="1" Background="{StaticResource MenuBarBrush}" BorderBrush="#DDD" BorderThickness="0,0,0,1" Padding="12,5">
            <Grid Height="50">
                <!-- Group: FILE -->
                <StackPanel Orientation="Horizontal" Visibility="{Binding IsChecked, ElementName=RibbonFile, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <Button Style="{StaticResource RibbonActionButtonStyle}" Click="TabHome_Click">
                        <Button.Resources>
                            <TextBlock x:Key="Icon" Text="&#xE80F;" FontFamily="Segoe MDL2 Assets" FontSize="20"/>
                        </Button.Resources>
                        <TextBlock Text="Accueil"/>
                    </Button>
                    <Button x:Name="BtnNewProject" Style="{StaticResource RibbonActionButtonStyle}" Click="TabNewProject_Click">
                        <Button.Resources>
                            <TextBlock x:Key="Icon" Text="&#xE710;" FontFamily="Segoe MDL2 Assets" FontSize="20"/>
                        </Button.Resources>
                        <TextBlock Text="Nouveau Projet"/>
                    </Button>
                    <Button Style="{StaticResource RibbonActionButtonStyle}" Click="OpenTeamWindow_Click">
                        <Button.Resources>
                            <TextBlock x:Key="Icon" Text="üë•" FontSize="20"/>
                        </Button.Resources>
                        <TextBlock Text="√âquipe"/>
                    </Button>
                    <Border BorderBrush="#EEE" BorderThickness="1,0,0,0" Margin="10,5"/>
                    <Button x:Name="BtnCloudSync" Style="{StaticResource RibbonActionButtonStyle}" ToolTip="Partager ce projet sur le r√©seau">
                        <Button.Resources>
                            <TextBlock x:Key="Icon" Text="‚òÅÔ∏è" FontSize="20"/>
                        </Button.Resources>
                        <TextBlock Text="Partager"/>
                    </Button>
                </StackPanel>


                <!-- Group: HELP -->
                <StackPanel Orientation="Horizontal" Visibility="{Binding IsChecked, ElementName=RibbonHelp, Converter={StaticResource BooleanToVisibilityConverter}}">
                    <Button Style="{StaticResource RibbonActionButtonStyle}" Click="HelpAction_Click" Tag="Documentation">
                        <StackPanel>
                            <TextBlock Text="&#xE897;" FontFamily="Segoe MDL2 Assets" FontSize="18" HorizontalAlignment="Center"/>
                            <TextBlock Text="Documentation" FontSize="11" Margin="0,2,0,0"/>
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource RibbonActionButtonStyle}" Click="HelpAction_Click" Tag="Support">
                        <StackPanel>
                            <TextBlock Text="&#xE8F2;" FontFamily="Segoe MDL2 Assets" FontSize="18" HorizontalAlignment="Center"/>
                            <TextBlock Text="Support" FontSize="11" Margin="0,2,0,0"/>
                        </StackPanel>
                    </Button>
                    <Button Style="{StaticResource RibbonActionButtonStyle}" Click="HelpAction_Click" Tag="About">
                        <StackPanel>
                            <TextBlock Text="&#xE946;" FontFamily="Segoe MDL2 Assets" FontSize="18" HorizontalAlignment="Center"/>
                            <TextBlock Text="√Ä propos" FontSize="11" Margin="0,2,0,0"/>
                        </StackPanel>
                    </Button>
                </StackPanel>
            </Grid>
        </Border>

        <!-- 3. MAIN CONTENT AREA -->
        <TabControl x:Name="MainViewTabControl" Grid.Row="2" Background="Transparent" BorderThickness="0" Margin="0,-1,0,0">
            <TabControl.Template>
                <ControlTemplate TargetType="TabControl">
                    <ContentPresenter ContentSource="SelectedContent" />
                </ControlTemplate>
            </TabControl.Template>

            <!-- Accueil / Dashboard -->
            <TabItem x:Name="ViewDash">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="30" Background="#F5F7F8">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <!-- Dashboard Header Banner -->
                         <Border Grid.Row="0" Height="120" CornerRadius="10" Margin="0,0,0,15" ClipToBounds="True">
                             <Grid>
                                 <Image Source="pack://application:,,,/AdRev.Desktop;component/Assets/BannerIcon.png" Stretch="UniformToFill" Opacity="0.5"/>
                                 <Border Background="#2C3E50" Opacity="0.3"/>
                                 
                                 <!-- Linear Gradient Overlay for Readability -->
                                 <Border>
                                     <Border.Background>
                                         <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                             <GradientStop Color="#CC455A64" Offset="0.0"/>
                                             <GradientStop Color="#00455A64" Offset="0.7"/>
                                         </LinearGradientBrush>
                                     </Border.Background>
                                 </Border>
                                 
                                 <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="30,0">
                                    <!-- App Icon Prominent -->
                                    <!-- App Icon Prominent -->
                                     <Border Width="90" Height="90" CornerRadius="45" Background="White" BorderBrush="#29B6F6" BorderThickness="4" Margin="0,0,20,0">
                                         <Border.Effect>
                                             <DropShadowEffect BlurRadius="10" Color="#222" Opacity="0.3" ShadowDepth="3"/>
                                         </Border.Effect>
                                         <Image Source="pack://application:,,,/AdRev.Desktop;component/Assets/BannerIcon.png" Width="60" Height="60" HorizontalAlignment="Center" VerticalAlignment="Center" RenderOptions.BitmapScalingMode="HighQuality"/>
                                     </Border>

                                     <StackPanel VerticalAlignment="Center">
                                        <TextBlock x:Name="DashboardTitle" Text="Tableau de Bord Scientifique" FontSize="28" FontWeight="Bold" Foreground="White">
                                             <TextBlock.Effect>
                                                 <DropShadowEffect BlurRadius="5" Color="#333" Opacity="0.3" ShadowDepth="1"/>
                                             </TextBlock.Effect>
                                         </TextBlock>
                                         <TextBlock Text="Vue d'ensemble de vos recherches et analyses" FontSize="14" Foreground="#ECEFF1"/>
                                     </StackPanel>
                                 </StackPanel>
                             </Grid>
                         </Border>

                         <!-- Action Row: Description & Connect/RBAC -->
                         <Grid Grid.Row="1" Margin="5,0,5,25">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="320"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel VerticalAlignment="Center" Margin="0,0,20,0">
                                <TextBlock Text="AdRev Platform : Votre environnement de recherche" FontSize="18" FontWeight="Bold" Foreground="#444" Margin="0,0,0,10"/>
                                <TextBlock Text="AdRev est votre plateforme int√©gr√©e pour la recherche scientifique : conception de protocoles, gestion de donn√©es et analyses statistiques automatis√©es. Optimisez votre flux de travail scientifique en √©quipe." 
                                           FontSize="14" Foreground="#78909C" TextWrapping="Wrap" FontStyle="Italic"/>
                            </StackPanel>

                            <Border Grid.Column="1" Background="#EEF2F5" CornerRadius="12" Padding="20">
                                <Border.Effect>
                                    <DropShadowEffect BlurRadius="15" Color="#CFD8DC" Opacity="0.4" ShadowDepth="4"/>
                                </Border.Effect>
                                <StackPanel>
                                    <!-- License Section -->
                                    <Grid Margin="0,0,0,15">
                                        <StackPanel>
                                            <TextBlock Text="Licence AdRev üîë" FontSize="18" FontWeight="Bold" Foreground="#7C4DFF"/>
                                            <TextBlock x:Name="LicenseStatusText" Text="Chargement..." FontSize="11" Foreground="#546E7A"/>
                                        </StackPanel>
                                        <Button Content="‚öôÔ∏è" Click="OpenActivation_Click" HorizontalAlignment="Right" VerticalAlignment="Top" Background="Transparent" BorderThickness="0" ToolTip="G√©rer la licence"/>
                                    </Grid>
                                    
                                    <Rectangle Height="1" Fill="#CBD5E0" Margin="0,5,0,15"/>

                                    <Grid Margin="0,0,0,15">
                                        <StackPanel>
                                            <TextBlock Text="AdRev Connect üåê" FontSize="18" FontWeight="Bold" Foreground="#3F51B5"/>
                                            <TextBlock Text="Projets partag√©s" FontSize="11" Foreground="#546E7A"/>
                                        </StackPanel>
                                        <Border x:Name="StatusDot" HorizontalAlignment="Right" VerticalAlignment="Center" Width="10" Height="10" CornerRadius="5" Background="Gray"/>
                                    </Grid>

                                    <StackPanel x:Name="ServerLoginPanel">
                                        <TextBlock Text="Serveur / IP :" FontSize="11" Foreground="#546E7A" Margin="0,0,0,3"/>
                                        <TextBox x:Name="ServerUrlBox" Text="https://cloud.adrev.org" Padding="8" Margin="0,0,0,10" ToolTip="URL du serveur AdRev" 
                                                 Tag="Ex: https://cloud.adrev.org"
                                                 Background="White" Foreground="Black" BorderBrush="#3F51B5" BorderThickness="1.5"/>
                                        <Button Content="Connexion R√©seau" Style="{StaticResource ModernButtonStyle}" Height="35" FontSize="13"/>
                                    </StackPanel>

                                    <StackPanel x:Name="NetworkActivePanel" Visibility="Collapsed">
                                        <TextBlock Text="Connect√©" FontWeight="Bold" Foreground="#2E7D32" FontSize="12"/>
                                        <TextBlock x:Name="NetworkDetailText" Text="Serveur : cloud.adrev.org" FontSize="10" Foreground="#546E7A" Margin="0,2,0,10"/>
                                         <Button Content="D√©connecter" Style="{StaticResource ModernButtonStyle}" Background="#E53935" Foreground="White" Padding="10,5" FontSize="12"/>
                                    </StackPanel>
                                    
                                    <Rectangle Height="1" Fill="#CBD5E0" Margin="0,15"/>

                                    <!-- Collaboration Space -->
                                    <TextBlock Text="Collaboration Live" FontSize="11" FontWeight="Bold" Foreground="#37474F" Margin="0,0,0,8"/>
                                    <UniformGrid Columns="3" Margin="0,0,0,15">
                                        <Button ToolTip="R√©union Zoom" Background="#2D8CFF" BorderThickness="0" Padding="5" Margin="2" Tag="Zoom">
                                            <TextBlock Text="Z" FontWeight="Bold" Foreground="White" FontSize="14"/>
                                        </Button>
                                        <Button ToolTip="Microsoft Teams" Background="#6264A7" BorderThickness="0" Padding="5" Margin="2" Tag="Teams">
                                            <TextBlock Text="T" FontWeight="Bold" Foreground="White" FontSize="14"/>
                                        </Button>
                                        <Button ToolTip="Cisco Webex" Background="#000000" BorderThickness="0" Padding="5" Margin="2" Tag="Webex">
                                            <TextBlock Text="W" FontWeight="Bold" Foreground="White" FontSize="14"/>
                                        </Button>
                                    </UniformGrid>
                                    
                                    <!-- Collaboration tools only -->
                                </StackPanel>
                            </Border>
                         </Grid>
 
                         <!-- NEW: Version Information & Highlights -->
                         <Border Grid.Row="2" Background="White" CornerRadius="12" Padding="20" Margin="5,0,5,25" BorderBrush="#E0E0E0" BorderThickness="1">
                             <Border.Effect>
                                 <DropShadowEffect BlurRadius="12" Color="#DDD" Opacity="0.4" ShadowDepth="2"/>
                             </Border.Effect>
                             <StackPanel>
                                 <Grid>
                                     <TextBlock Text="Nouveaut√©s de la Version 1.0 (√âdition Initiale)" FontSize="18" FontWeight="Bold" Foreground="{StaticResource PrimaryBrush}" Margin="0,0,0,15"/>
                                     <Border HorizontalAlignment="Right" VerticalAlignment="Top" Background="#E3F2FD" CornerRadius="4" Padding="8,2" Margin="0,-5,0,0">
                                         <TextBlock Text="FIRST EDITION" FontSize="10" FontWeight="Bold" Foreground="#1565C0"/>
                                     </Border>
                                 </Grid>
                                 <Grid>
                                     <Grid.ColumnDefinitions>
                                         <ColumnDefinition Width="*"/>
                                         <ColumnDefinition Width="*"/>
                                         <ColumnDefinition Width="*"/>
                                     </Grid.ColumnDefinitions>
                                     
                                     <StackPanel Grid.Column="0" Margin="0,0,15,0">
                                         <TextBlock Text="‚ú® Protocole Intelligent" FontWeight="Bold" Foreground="#444" Margin="0,0,0,5"/>
                                         <TextBlock Text="Migration compl√®te du module de protocole avec validation Bloom et calculatrices int√©gr√©es." FontSize="11" Foreground="#666" TextWrapping="Wrap"/>
                                     </StackPanel>
                                     
                                     <StackPanel Grid.Column="1" Margin="0,0,15,0">
                                         <TextBlock Text="üìö Aide Intuitive" FontWeight="Bold" Foreground="#444" Margin="0,0,0,5"/>
                                         <TextBlock Text="Centre d'aide interactif avec guides visuels pour chaque √©tape de votre recherche." FontSize="11" Foreground="#666" TextWrapping="Wrap"/>
                                     </StackPanel>
                                     
                                     <StackPanel Grid.Column="2">
                                         <TextBlock Text="üöÄ Performance &amp; Stabilit√©" FontWeight="Bold" Foreground="#444" Margin="0,0,0,5"/>
                                         <TextBlock Text="Architecture optimis√©e pour Windows 11 et exportations Word ultra-rapides." FontSize="11" Foreground="#666" TextWrapping="Wrap"/>
                                     </StackPanel>
                                 </Grid>
                             </StackPanel>
                         </Border>

                         <!-- Stats & Actions Row -->
                         <Grid Grid.Row="3" Margin="0,0,0,30">
                             <Grid.ColumnDefinitions>
                                 <ColumnDefinition Width="*"/>
                                 <ColumnDefinition Width="*"/>
                                 <ColumnDefinition Width="1.2*"/>
                                 <ColumnDefinition Width="1.2*"/>
                             </Grid.ColumnDefinitions>
                             
                            <!-- Stat 1: Ongoing Projects with Mini Chart -->
                            <Border Grid.Column="0" Background="White" CornerRadius="12" Padding="20" Margin="0,0,15,0">
                                <Border.RenderTransform>
                                    <TranslateTransform Y="20"/>
                                </Border.RenderTransform>
                                <Border.Triggers>
                                    <EventTrigger RoutedEvent="Loaded">
                                        <BeginStoryboard>
                                            <Storyboard>
                                                <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" From="20" To="0" Duration="0:0:0.5" DecelerationRatio="0.5"/>
                                                <DoubleAnimation Storyboard.TargetProperty="Opacity" From="0" To="1" Duration="0:0:0.5"/>
                                            </Storyboard>
                                        </BeginStoryboard>
                                    </EventTrigger>
                                </Border.Triggers>
                                <Border.Effect><DropShadowEffect BlurRadius="15" Color="#CFD8DC" Opacity="0.4" ShadowDepth="4"/></Border.Effect>
                                <Grid>
                                    <StackPanel>
                                        <TextBlock Text="Projets En Cours" FontSize="15" FontWeight="SemiBold" Foreground="#78909C" Margin="0,0,0,10"/>
                                        <TextBlock x:Name="StatOngoing" Text="0" FontSize="42" FontWeight="Bold" Foreground="#3F51B5"/>
                                        <TextBlock Text="Actifs" FontSize="12" Foreground="#9FA8DA" Margin="2,0,0,0"/>
                                    </StackPanel>
                                    
                                    <!-- Pseudo Chart -->
                                    <Canvas Width="60" Height="40" HorizontalAlignment="Right" VerticalAlignment="Bottom" Opacity="0.8">
                                        <Polyline Points="0,40 10,25 20,30 30,10 40,20 50,5 60,0" Stroke="#3F51B5" StrokeThickness="2"/>
                                        <Polygon Points="0,40 10,25 20,30 30,10 40,20 50,5 60,0 60,40" Fill="#E8EAF6" Opacity="0.5"/>
                                        <Ellipse Width="6" Height="6" Fill="#3F51B5" Canvas.Left="57" Canvas.Top="-3"/>
                                    </Canvas>
                                </Grid>
                            </Border>

                            <!-- Stat 2: Validated Protocols with Success Ring -->
                            <Border Grid.Column="1" Background="White" CornerRadius="12" Padding="20" Margin="0,0,15,0">
                                <Border.Effect><DropShadowEffect BlurRadius="15" Color="#CFD8DC" Opacity="0.4" ShadowDepth="4"/></Border.Effect>
                                <Grid>
                                    <StackPanel>
                                        <TextBlock Text="Protocoles Valid√©s" FontSize="15" FontWeight="SemiBold" Foreground="#78909C" Margin="0,0,0,10"/>
                                        <TextBlock x:Name="StatValidated" Text="0" FontSize="42" FontWeight="Bold" Foreground="#43A047"/>
                                        <TextBlock Text="Termin√©s" FontSize="12" Foreground="#A5D6A7" Margin="2,0,0,0"/>
                                    </StackPanel>
                                    
                                     <!-- Pseudo Donut Chart -->
                                     <Grid HorizontalAlignment="Right" VerticalAlignment="Bottom" Width="50" Height="50" Opacity="0.9">
                                         <Ellipse Width="50" Height="50" Stroke="#E8F5E9" StrokeThickness="5"/>
                                         <Path Data="M 25,0 A 25,25 0 0 1 50,25" Stroke="#43A047" StrokeThickness="5" StrokeStartLineCap="Round" StrokeEndLineCap="Round" Margin="0,0,0,0"/>
                                         <TextBlock Text="%" FontSize="10" FontWeight="Bold" Foreground="#43A047" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                     </Grid>
                                </Grid>
                            </Border>
                             
                             <!-- Action Card: Import -->
                                    <Button Grid.Column="2" Background="White" BorderThickness="0" Cursor="Hand" Margin="0,0,15,0">
                                 <Button.Template>
                                     <ControlTemplate TargetType="Button">
                                         <Border Background="White" CornerRadius="10" BorderBrush="#2196F3" BorderThickness="1" Padding="15">
                                             <Border.Effect><DropShadowEffect BlurRadius="10" Color="#DDD" Opacity="0.3"/></Border.Effect>
                                             <Grid>
                                                 <Grid.ColumnDefinitions>
                                                     <ColumnDefinition Width="Auto"/>
                                                     <ColumnDefinition Width="*"/>
                                                 </Grid.ColumnDefinitions>
                                                 <Border Background="#E3F2FD" Width="50" Height="50" CornerRadius="25" Margin="0,0,15,0">
                                                     <TextBlock Text="üìä" FontSize="24" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                 </Border>
                                                 <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                     <TextBlock Text="Analyse Rapide" FontWeight="Bold" FontSize="16" Foreground="#1565C0"/>
                                                     <TextBlock Text="Importer une base de donn√©es CSV/Excel pour des tests imm√©diats." FontSize="11" Foreground="#777" TextWrapping="Wrap"/>
                                                 </StackPanel>
                                             </Grid>
                                         </Border>
                                     </ControlTemplate>
                                 </Button.Template>
                             </Button>

                            <!-- NEW: Import Folder Card -->
                            <Button Grid.Column="3" Click="ImportProjectFolder_Click" Background="White" BorderThickness="0" Cursor="Hand">
                                <Button.Template>
                                    <ControlTemplate TargetType="Button">
                                        <Border Background="White" CornerRadius="10" BorderBrush="#4CAF50" BorderThickness="1" Padding="15">
                                            <Border.Effect><DropShadowEffect BlurRadius="10" Color="#DDD" Opacity="0.3"/></Border.Effect>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <Border Background="#E8F5E9" Width="50" Height="50" CornerRadius="25" Margin="0,0,15,0">
                                                    <TextBlock Text="üìÇ" FontSize="24" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                </Border>
                                                <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                                    <TextBlock Text="Importer Dossier" FontWeight="Bold" FontSize="16" Foreground="#2E7D32"/>
                                                    <TextBlock Text="Charger un dossier de recherche existant depuis le PC." FontSize="11" Foreground="#777" TextWrapping="Wrap"/>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </ControlTemplate>
                                </Button.Template>
                            </Button> 

                         </Grid>
                        <!-- Projects Section -->
                        <StackPanel Grid.Row="3">
                             
                             <!-- Section Title & Action -->
                             <Grid Grid.Row="0" Margin="0,0,0,15">
                                 <TextBlock Text="VOS PROJETS R√âCENTS" FontSize="16" FontWeight="Bold" Foreground="#555" VerticalAlignment="Center"/>
                                 <Button HorizontalAlignment="Right" Click="TabNewProject_Click" Background="#2196F3" Foreground="White" BorderThickness="0" Padding="15,8" Cursor="Hand">
                                     <Button.Resources>
                                         <Style TargetType="Border">
                                             <Setter Property="CornerRadius" Value="20"/>
                                         </Style>
                                     </Button.Resources>
                                     <StackPanel Orientation="Horizontal">
                                         <TextBlock Text="+" Margin="0,0,5,0" FontWeight="Bold"/>
                                         <TextBlock Text="Nouveau Projet"/>
                                     </StackPanel>
                                 </Button>
                             </Grid>

                             <!-- LIST: TEAM Projects -->
                             <TextBlock Text="PROJETS D'√âQUIPE" FontSize="14" FontWeight="Bold" Foreground="#7986CB" Margin="0,0,0,10"/>
                             <ItemsControl x:Name="ProjectsListTeam" Grid.Row="1" Margin="0,0,0,25">
                                 <ItemsControl.ItemsPanel>
                                     <ItemsPanelTemplate>
                                         <WrapPanel/>
                                     </ItemsPanelTemplate>
                                 </ItemsControl.ItemsPanel>
                                 <ItemsControl.ItemTemplate>
                                     <DataTemplate>
                                         <Button Click="OpenProject_Click" Tag="{Binding}" Background="Transparent" BorderThickness="0" Margin="0,0,20,20" Cursor="Hand">
                                             <Button.Template>
                                                 <ControlTemplate TargetType="Button">
                                                     <Border Background="White" CornerRadius="12" Width="280" Height="160" BorderBrush="#E8EAF6" BorderThickness="1">
                                                         <Border.Effect>
                                                             <DropShadowEffect BlurRadius="15" Color="#C5CAE9" Opacity="0.4" ShadowDepth="3"/>
                                                         </Border.Effect>
                                                         <Grid>
                                                             <Grid.RowDefinitions>
                                                                 <RowDefinition Height="*"/>
                                                                 <RowDefinition Height="Auto"/>
                                                             </Grid.RowDefinitions>
                                                             
                                                             <!-- Color Strip -->
                                                             <Border Grid.Row="0" CornerRadius="12,12,0,0" Background="#E8EAF6" Padding="20">
                                                                 <StackPanel>
                                                                     <Border Background="#3F51B5" HorizontalAlignment="Left" CornerRadius="4" Padding="8,4" Margin="0,0,0,10">
                                                                         <TextBlock Text="√âQUIPE" FontSize="10" FontWeight="Bold" Foreground="White"/>
                                                                     </Border>
                                                                     <TextBlock Text="{Binding Title}" FontSize="16" FontWeight="Bold" TextWrapping="Wrap" MaxHeight="60" TextTrimming="CharacterEllipsis"/>
                                                                     <TextBlock Text="{Binding StudyType}" FontSize="12" Foreground="#7986CB" Margin="0,5,0,0"/>
                                                                 </StackPanel>
                                                             </Border>
                                                             
                                                             <!-- Footer -->
                                                             <Border Grid.Row="1" Padding="15,10" BorderBrush="#FAFAFA" BorderThickness="0,1,0,0">
                                                                  <Grid>
                                                                      <TextBlock Text="{Binding CreatedOn, StringFormat='Cr√©√© le {0:dd/MM/yyyy}'}" FontSize="11" Foreground="#AAA" VerticalAlignment="Center"/>
                                                                      <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                                                                          <TextBlock Text="üë•" Foreground="#7986CB" Margin="0,0,5,0"/>
                                                                      </StackPanel>
                                                                  </Grid>
                                                             </Border>
                                                         </Grid>
                                                     </Border>
                                                 </ControlTemplate>
                                             </Button.Template>
                                         </Button>
                                     </DataTemplate>
                                 </ItemsControl.ItemTemplate>
                             </ItemsControl>

                             <!-- LIST: INDIVIDUAL Projects -->
                             <TextBlock Text="PROJETS PERSONNELS" FontSize="14" FontWeight="Bold" Foreground="#90A4AE" Margin="0,0,0,10"/>
                             <ItemsControl x:Name="ProjectsListIndividual" Grid.Row="1" Margin="0,0,0,30">
                                 <ItemsControl.ItemsPanel>
                                     <ItemsPanelTemplate>
                                         <WrapPanel/>
                                     </ItemsPanelTemplate>
                                 </ItemsControl.ItemsPanel>
                                 <ItemsControl.ItemTemplate>
                                     <DataTemplate>
                                         <Button Click="OpenProject_Click" Tag="{Binding}" Background="Transparent" BorderThickness="0" Margin="0,0,20,20" Cursor="Hand">
                                             <Button.Template>
                                                 <ControlTemplate TargetType="Button">
                                                     <Border Background="White" CornerRadius="12" Width="280" Height="160" BorderBrush="#EEE" BorderThickness="1">
                                                         <Border.Effect>
                                                             <DropShadowEffect BlurRadius="15" Color="#DDD" Opacity="0.4" ShadowDepth="3"/>
                                                         </Border.Effect>
                                                         <Grid>
                                                             <Grid.RowDefinitions>
                                                                 <RowDefinition Height="*"/>
                                                                 <RowDefinition Height="Auto"/>
                                                             </Grid.RowDefinitions>
                                                             
                                                             <!-- Color Strip -->
                                                             <Border Grid.Row="0" CornerRadius="12,12,0,0" Background="#F8F9FA" Padding="20">
                                                                 <StackPanel>
                                                                     <Border Background="#E0E0E0" HorizontalAlignment="Left" CornerRadius="4" Padding="8,4" Margin="0,0,0,10">
                                                                         <TextBlock Text="PERSONNEL" FontSize="10" FontWeight="Bold" Foreground="#757575"/>
                                                                     </Border>
                                                                     <TextBlock Text="{Binding Title}" FontSize="16" FontWeight="Bold" TextWrapping="Wrap" MaxHeight="60" TextTrimming="CharacterEllipsis"/>
                                                                     <TextBlock Text="{Binding StudyType}" FontSize="12" Foreground="#888" Margin="0,5,0,0"/>
                                                                 </StackPanel>
                                                             </Border>
                                                             
                                                             <!-- Footer -->
                                                             <Border Grid.Row="1" Padding="15,10" BorderBrush="#FAFAFA" BorderThickness="0,1,0,0">
                                                                  <Grid>
                                                                      <TextBlock Text="{Binding CreatedOn, StringFormat='Cr√©√© le {0:dd/MM/yyyy}'}" FontSize="11" Foreground="#AAA" VerticalAlignment="Center"/>
                                                                      <TextBlock Text="üë§" HorizontalAlignment="Right" Foreground="#CCC"/>
                                                                  </Grid>
                                                             </Border>
                                                         </Grid>
                                                     </Border>
                                                 </ControlTemplate>
                                             </Button.Template>
                                         </Button>
                                     </DataTemplate>
                                 </ItemsControl.ItemTemplate>
                             </ItemsControl>

                             <!-- Completed Section -->
                             <TextBlock Grid.Row="2" Text="ARCHIVES / TERMIN√âS" FontSize="14" FontWeight="Bold" Foreground="#999" Margin="0,0,0,15"/>
                             <ItemsControl x:Name="ProjectsListCompleted" Grid.Row="3">
                                 <ItemsControl.ItemsPanel>
                                     <ItemsPanelTemplate>
                                         <WrapPanel/>
                                     </ItemsPanelTemplate>
                                 </ItemsControl.ItemsPanel>
                                 <ItemsControl.ItemTemplate>
                                      <!-- Simple List Style for Archives -->
                                      <DataTemplate>
                                         <Button Click="OpenProject_Click" Tag="{Binding}" Background="White" BorderBrush="#EEE" BorderThickness="1" Margin="0,0,15,10" Width="400" HorizontalContentAlignment="Stretch" Cursor="Hand">
                                              <Border Padding="15,10">
                                                  <Grid>
                                                  <Grid.ColumnDefinitions>
                                                      <ColumnDefinition Width="Auto"/>
                                                      <ColumnDefinition Width="*"/>
                                                      <ColumnDefinition Width="Auto"/>
                                                  </Grid.ColumnDefinitions>
                                                  <Border Background="#E8F5E9" CornerRadius="4" Padding="6,2" Margin="0,0,10,0">
                                                      <TextBlock Text="‚úì" Foreground="#2E7D32" FontWeight="Bold"/>
                                                  </Border>
                                                  <StackPanel Grid.Column="1">
                                                      <TextBlock Text="{Binding Title}" FontWeight="SemiBold"/>
                                                      <TextBlock Text="{Binding Institution}" FontSize="11" Foreground="#999"/>
                                                  </StackPanel>
                                                  <TextBlock Grid.Column="2" Text="{Binding CreatedOn, StringFormat='{}{0:yyyy}'}" Foreground="#CCC"/>
                                                  </Grid>
                                              </Border>
                                         </Button>
                                      </DataTemplate>
                                 </ItemsControl.ItemTemplate>
                             </ItemsControl>

                        </StackPanel>



                        <!-- Recent Projects Section -->
                        <Border Grid.Row="2" Background="White" CornerRadius="10" Padding="20" BorderBrush="#E0E0E0" BorderThickness="1">
                            <StackPanel>
                                <TextBlock Text="Projets R√©cents" FontSize="18" FontWeight="Bold" Foreground="#333" Margin="0,0,0,15"/>
                                
                                <ListBox x:Name="RecentProjectsListBox" BorderThickness="0" Background="Transparent">
                                    <ListBox.ItemContainerStyle>
                                        <Style TargetType="ListBoxItem">
                                            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                            <Setter Property="Padding" Value="0"/>
                                            <Setter Property="Margin" Value="0,0,0,10"/>
                                            <Setter Property="Background" Value="Transparent"/>
                                            <Setter Property="Template">
                                                <Setter.Value>
                                                    <ControlTemplate TargetType="ListBoxItem">
                                                        <Border Background="{TemplateBinding Background}" CornerRadius="5" BorderThickness="0">
                                                            <ContentPresenter/>
                                                        </Border>
                                                    </ControlTemplate>
                                                </Setter.Value>
                                            </Setter>
                                        </Style>
                                    </ListBox.ItemContainerStyle>
                                    <ListBox.ItemTemplate>
                                        <DataTemplate>
                                            <Border Padding="15" CornerRadius="8" Background="#FAFAFA" BorderBrush="#EEE" BorderThickness="1">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="50"/>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    
                                                    <!-- Icon -->
                                                    <Border Background="#E1F5FE" Width="40" Height="40" CornerRadius="20" HorizontalAlignment="Left">
                                                        <TextBlock Text="P" Foreground="#0277BD" FontWeight="Bold" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                    </Border>
                                                    
                                                    <!-- Info -->
                                                    <StackPanel Grid.Column="1" VerticalAlignment="Center" Margin="10,0,0,0">
                                                        <TextBlock Text="{Binding Title}" FontWeight="Bold" Foreground="#333" FontSize="14"/>
                                                        <StackPanel Orientation="Horizontal">
                                                            <TextBlock Text="{Binding StudyType}" FontSize="12" Foreground="#888"/>
                                                            <TextBlock Text=" ‚Ä¢ " Foreground="#CCC" Margin="5,0"/>
                                                            <TextBlock Text="{Binding CreatedOn, StringFormat='{}{0:dd MMM yyyy}'}" FontSize="12" Foreground="#888"/>
                                                        </StackPanel>
                                                    </StackPanel>
                                                    
                                                    <!-- Actions -->
                                                    <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center">
                                                        <Button Content="Ouvrir" Click="OpenProject_Click" Background="Transparent" Foreground="{StaticResource PrimaryBrush}" BorderThickness="0" FontWeight="SemiBold" Cursor="Hand" Margin="0,0,10,0"/>
                                                        <Button Content="&#xE74D;" Click="DeleteProject_Click" FontFamily="Segoe MDL2 Assets" Background="Transparent" Foreground="#EF5350" BorderThickness="0" ToolTip="Supprimer" Cursor="Hand"/>
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ListBox.ItemTemplate>
                                </ListBox>
                                
                                <!-- Empty State (Visible if needed via binding, currently static placeholder text won't work easily without visibility converter on listbox count, skipping for simplicity) -->
                            </StackPanel>
                        </Border>
                    </Grid>
                </ScrollViewer>
            </TabItem>

            <!-- Nouveau Projet -->
            <TabItem x:Name="ViewNewProject">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Background="#F5F7F8">
                    <Border Margin="30" HorizontalAlignment="Stretch" Style="{StaticResource CardStyle}">
                        <StackPanel>
                            <TextBlock Text="Initialisation du Nouveau Projet" FontSize="24" FontWeight="Bold" Foreground="{StaticResource PrimaryBrush}" Margin="0,0,0,25"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Margin="0,0,10,0">
                                    <TextBlock Text="Titre du projet" Style="{StaticResource LabelStyle}"/>
                                    <TextBox x:Name="TitleTextBox" Margin="0,5,0,20" Tag="Entrez le titre de votre projet de recherche ici..."/>
                                    <TextBlock Text="Contexte du Projet" Style="{StaticResource LabelStyle}"/>
                                    <ComboBox x:Name="ProjectContextComboBox" Height="40" Margin="0,5,0,20" Padding="10" VerticalContentAlignment="Center"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Margin="10,0,0,0">
                                    <TextBlock Text="Institution / Organisme" Style="{StaticResource LabelStyle}"/>
                                    <TextBox x:Name="InstitutionTextBox" Margin="0,5,0,20" Tag="Ex: Universit√© de Paris, H√¥pital Central..."/>
                                    <TextBlock Text="Domaine Scientifique" Style="{StaticResource LabelStyle}"/>
                                    <ComboBox x:Name="DomainComboBox" Height="40" Margin="0,5,0,20" Padding="10" VerticalContentAlignment="Center">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                    <TextBlock Text="Type d'√©tude" Style="{StaticResource LabelStyle}"/>
                                    <ComboBox x:Name="StudyTypeComboBox" Height="40" Margin="0,5,0,20" Padding="10" VerticalContentAlignment="Center">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                </StackPanel>
                            </Grid>
                            <TextBlock Text="Auteurs (s√©par√©s par des virgules)" Style="{StaticResource LabelStyle}"/>
                            <TextBox x:Name="AuthorsTextBox" Height="80" TextWrapping="Wrap" AcceptsReturn="True" Tag="Listez les auteurs (Nom Pr√©nom), s√©par√©s par des virgules..."/>
                            
                            <!-- Location Selection -->
                            <TextBlock Text="Emplacement du Projet (Local)" Style="{StaticResource LabelStyle}" Margin="0,15,0,0"/>
                            <Grid Margin="0,5,0,20">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBox x:Name="ProjectPathTextBox" IsReadOnly="True" Background="#F1F1F1" Text="Documents/AdRev/Projects (D√©faut)" Padding="10" VerticalContentAlignment="Center" Height="40"/>
                                <Button Grid.Column="1" Content="..." Width="40" Height="40" Margin="10,0,0,0" Click="BrowseProjectFolder_Click" ToolTip="Choisir un dossier sp√©cifique" Style="{StaticResource SecondaryButtonStyle}"/>
                            </Grid>

                            <Border Background="#FFE0B2" Padding="15" CornerRadius="8" Margin="0,0,0,20">
                                <StackPanel>
                                    <TextBlock Text="üöÄ Acc√©l√©ration" FontWeight="Bold" Foreground="#BF360C" FontSize="12" Margin="0,0,0,5"/>
                                    <TextBlock Text="Vous avez d√©j√† un protocole valid√© ?" FontSize="11" Foreground="#777" Margin="0,0,0,10"/>
                                    <Button Content="Convertir un Protocole en Projet" Style="{StaticResource SecondaryButtonStyle}" Background="#E65100" Foreground="White" Height="35"/>
                                </StackPanel>
                            </Border>

                            <Button Content="Valider et Cr√©er le Projet" Click="CreateProject_Click" Height="50" Margin="0,5,0,0"/>
                            <TextBlock x:Name="ResultTextBlock" Margin="0,15,0,0" Foreground="{StaticResource PrimaryBrush}" FontWeight="SemiBold" TextWrapping="Wrap" TextAlignment="Center"/>
                        </StackPanel>
                    </Border>
                </ScrollViewer>
            </TabItem>

                                <!-- TAB 6: BIBLIOTH√àQUE / PORTFOLIO -->
                <TabItem Header="Ma Biblioth√®que">
                    <Grid Margin="20">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/> <!-- Header -->
                            <RowDefinition Height="Auto"/> <!-- Filters -->
                            <RowDefinition Height="*"/>    <!-- DataGrid -->
                        </Grid.RowDefinitions>

                        <!-- Header -->
                        <Border Style="{StaticResource CardStyle}" Margin="0,0,0,20">
                            <StackPanel>
                                <TextBlock Text="Portfolio de Publications" FontWeight="Bold" FontSize="18" Foreground="{StaticResource PrimaryBrush}"/>
                                <TextBlock Text="Suivi des rapports valid√©s et articles publi√©s." FontSize="12" Foreground="#666" Margin="0,5,0,0"/>
                            </StackPanel>
                        </Border>

                        <!-- Filters -->
                        <StackPanel Grid.Row="1" Orientation="Horizontal" Margin="0,0,0,15">
                            <TextBlock Text="Filtrer :" VerticalAlignment="Center" Margin="0,0,10,0" FontWeight="SemiBold"/>
                            <ComboBox x:Name="LibraryStatusFilter" Width="150" Height="30" SelectedIndex="0" SelectionChanged="LibraryFilter_Changed" Margin="0,0,10,0">
                                <ComboBoxItem Content="Tous les Statuts"/>
                                <ComboBoxItem Content="Publi√©"/>
                                <ComboBoxItem Content="Accept√© / Valid√©"/>
                                <ComboBoxItem Content="Termin√©"/>
                            </ComboBox>
                            <Button Content="Actualiser" Width="100" Height="30" Click="BtnRefreshLibrary_Click" Style="{StaticResource ModernButtonStyle}"/>
                        </StackPanel>

                        <!-- DataGrid -->
                        <DataGrid x:Name="LibraryGrid" Grid.Row="2" AutoGenerateColumns="False" IsReadOnly="True" 
                                  HeadersVisibility="Column" GridLinesVisibility="Horizontal"
                                  BorderThickness="1" BorderBrush="#E0E0E0" Background="White">
                            <DataGrid.Resources>
                                <Style TargetType="DataGridColumnHeader">
                                    <Setter Property="Height" Value="35"/>
                                    <Setter Property="Padding" Value="10,0"/>
                                    <Setter Property="Background" Value="#F5F5F5"/>
                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                </Style>
                                <Style TargetType="DataGridCell">
                                    <Setter Property="Padding" Value="10"/>
                                    <Setter Property="Block.TextAlignment" Value="Center"/>
                                </Style>
                            </DataGrid.Resources>
                            <DataGrid.Columns>
                                <DataGridTextColumn Header="Date" Binding="{Binding CreatedOn, StringFormat=d}" Width="100"/>
                                <DataGridTextColumn Header="Titre du Projet" Binding="{Binding Title}" Width="*"/>
                                <DataGridTextColumn Header="Type" Binding="{Binding AcademicLevel}" Width="150"/>
                                <DataGridTextColumn Header="Revue / Cible" Binding="{Binding TargetJournalName}" Width="150"/>
                                <DataGridTextColumn Header="Rang" Binding="{Binding AuthorRank}" Width="60"/>
                                <DataGridTemplateColumn Header="Statut" Width="120">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Border Background="{StaticResource PrimaryBrush}" CornerRadius="4" Padding="8,4">
                                                <TextBlock Text="{Binding Status}" Foreground="White" HorizontalAlignment="Center" FontSize="11"/>
                                            </Border>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                <DataGridTemplateColumn Header="Actions" Width="140">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                                <Button Content="‚úî" ToolTip="Marquer comme Accept√©" Click="LibraryMarkAccepted_Click" Width="30" Margin="0,0,5,0" Style="{StaticResource SecondaryButtonStyle}" FontSize="12"/>
                                                <Button Content="üì¢" ToolTip="Marquer comme Publi√©" Click="LibraryMarkPublished_Click" Width="30" Margin="0,0,5,0" Style="{StaticResource SecondaryButtonStyle}" FontSize="12"/>
                                                <Button Content="üìÇ" ToolTip="Ouvrir le Projet" Click="BtnOpenProjectLibrary_Click" Width="30" Style="{StaticResource SecondaryButtonStyle}" FontSize="12"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                    </Grid>
                </TabItem>
            <TabItem x:Name="ViewHelp">
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="30" Background="#F5F7F8">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <StackPanel Margin="0,0,0,30">
                            <TextBlock Text="Centre d'Aide &amp; Ressources" FontSize="28" FontWeight="Bold" Foreground="#333"/>
                            <TextBlock Text="Tout ce dont vous avez besoin pour ma√Ætriser AdRev." Foreground="#666" FontSize="16"/>
                        </StackPanel>

                        <WrapPanel Grid.Row="1" HorizontalAlignment="Center">
                            <!-- Card 1: Documentation -->
                            <Button Tag="Documentation" Click="HelpAction_Click" Margin="20" Background="Transparent" BorderThickness="0" Padding="0">
                                <Border Width="260" Height="280" Background="White" CornerRadius="12" BorderBrush="#E0E0E0" BorderThickness="1">
                                    <Border.Effect><DropShadowEffect BlurRadius="12" Color="#DDD" Opacity="0.4" ShadowDepth="4"/></Border.Effect>
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="140"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>
                                        <Border Background="#E3F2FD" CornerRadius="12,12,0,0" Padding="25">
                                            <Image Source="Assets/help_doc.png" Stretch="Uniform" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                        <StackPanel Grid.Row="1" Margin="20" VerticalAlignment="Center">
                                            <TextBlock Text="Documentation" FontWeight="Bold" FontSize="18" HorizontalAlignment="Center" Margin="0,0,0,5"/>
                                            <TextBlock Text="Guides utilisateurs complets." Foreground="#666" FontSize="13" HorizontalAlignment="Center"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </Button>

                            <!-- Card 2: Tutorials -->
                             <Button Tag="Tutorials" Click="HelpAction_Click" Margin="20" Background="Transparent" BorderThickness="0" Padding="0">
                                <Border Width="260" Height="280" Background="White" CornerRadius="12" BorderBrush="#E0E0E0" BorderThickness="1">
                                    <Border.Effect><DropShadowEffect BlurRadius="12" Color="#DDD" Opacity="0.4" ShadowDepth="4"/></Border.Effect>
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="140"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>
                                        <Border Background="#E8F5E9" CornerRadius="12,12,0,0" Padding="25">
                                            <Image Source="Assets/help_tutorial.png" Stretch="Uniform" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                        <StackPanel Grid.Row="1" Margin="20" VerticalAlignment="Center">
                                            <TextBlock Text="Tutoriels Vid√©o" FontWeight="Bold" FontSize="18" HorizontalAlignment="Center" Margin="0,0,0,5"/>
                                            <TextBlock Text="Apprenez en regardant." Foreground="#666" FontSize="13" HorizontalAlignment="Center"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </Button>

                            <!-- Card 3: Support -->
                             <Button Tag="Support" Click="HelpAction_Click" Margin="20" Background="Transparent" BorderThickness="0" Padding="0">
                                <Border Width="260" Height="280" Background="White" CornerRadius="12" BorderBrush="#E0E0E0" BorderThickness="1">
                                    <Border.Effect><DropShadowEffect BlurRadius="12" Color="#DDD" Opacity="0.4" ShadowDepth="4"/></Border.Effect>
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="140"/>
                                            <RowDefinition Height="*"/>
                                        </Grid.RowDefinitions>
                                        <Border Background="#FFE0B2" CornerRadius="12,12,0,0" Padding="25">
                                            <Image Source="Assets/help_support.png" Stretch="Uniform" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                        <StackPanel Grid.Row="1" Margin="20" VerticalAlignment="Center">
                                            <TextBlock Text="Support Technique" FontWeight="Bold" FontSize="18" HorizontalAlignment="Center" Margin="0,0,0,5"/>
                                            <TextBlock Text="Une question ? Contactez-nous." Foreground="#666" FontSize="13" HorizontalAlignment="Center"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </Button>

                             <!-- Card 4: Subscription (NEW) -->
                             <Button Tag="Subscription" Click="HelpAction_Click" Margin="20" Background="Transparent" BorderThickness="0" Padding="0">
                                 <Border Width="260" Height="280" Background="White" CornerRadius="12" BorderBrush="#E0E0E0" BorderThickness="1">
                                     <Border.Effect><DropShadowEffect BlurRadius="12" Color="#DDD" Opacity="0.4" ShadowDepth="4"/></Border.Effect>
                                     <Grid>
                                         <Grid.RowDefinitions>
                                             <RowDefinition Height="140"/>
                                             <RowDefinition Height="*"/>
                                         </Grid.RowDefinitions>
                                         <Border Background="#F3E5F5" CornerRadius="12,12,0,0" Padding="25">
                                             <Image Source="Assets/help_license.png" Stretch="Uniform" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                         </Border>
                                         <StackPanel Grid.Row="1" Margin="20" VerticalAlignment="Center">
                                             <TextBlock Text="Abonnement" FontWeight="Bold" FontSize="18" HorizontalAlignment="Center" Margin="0,0,0,5"/>
                                             <TextBlock Text="G√©rez votre licence Pro / USB." Foreground="#666" FontSize="13" HorizontalAlignment="Center"/>
                                         </StackPanel>
                                     </Grid>
                                 </Border>
                             </Button>
                        </WrapPanel>
                    </Grid>
                </ScrollViewer>
            </TabItem>
        </TabControl>

        <!-- 4. STATUS BAR -->
        <Border Grid.Row="3" Background="{StaticResource PrimaryDarkBrush}" Padding="15,0">
            <Grid>
                <TextBlock Text="Pr√™t" Foreground="White" FontSize="11" VerticalAlignment="Center"/>
                <TextBlock Text="AdRev Science Suite v1.0.0 (First Edition) | ¬© 2024-2026 AdRev Team" Foreground="White" FontSize="11" VerticalAlignment="Center" HorizontalAlignment="Right"/>
            </Grid>
        </Border>
    </Grid>
    </Border>
</Window>





FILE: \AdRev.Desktop\MainWindow.xaml.cs
------------------------------------
using System;
using System.Collections.Generic;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using AdRev.Core.Common;
using AdRev.Domain.Enums;
using AdRev.Domain.Variables;
using AdRev.Domain.Models;
using System.Windows.Documents;
using System.Windows.Media;
using AdRev.Domain.Quality;
using AdRev.Core.Services;
using Microsoft.Win32;
using System.IO;
using System.Collections.ObjectModel;
using System.Text.Json;
using AdRev.Desktop.Services;
using System.Runtime.InteropServices;
using System.Text.RegularExpressions;
using AdRev.Core.Extensions;
using AdRev.Desktop.Windows;

namespace AdRev.Desktop
{
    public partial class MainWindow : Window
    {
        private readonly ResearchProjectService _projectService = new ResearchProjectService();
        private ResearchProject? _currentProject;
        private readonly AdRev.Core.Services.LicensingService _licensingService = new AdRev.Core.Services.LicensingService();
        private readonly AdRev.Core.Protocols.ProtocolService _protocolService = new AdRev.Core.Protocols.ProtocolService();

        // Fields for legacy features removed - clean state

        public MainWindow()
        {
            InitializeComponent();

            // Sizing and positioning: 10px margin top and bottom
            double workHeight = SystemParameters.WorkArea.Height;
            double workWidth = SystemParameters.WorkArea.Width;
            this.Height = workHeight - 20;
            this.Width = Math.Min(1280, workWidth - 40); // Maintain a reasonable maximum width
            this.Top = 10 + SystemParameters.WorkArea.Top;
            this.Left = (workWidth - this.Width) / 2 + SystemParameters.WorkArea.Left;

            StudyTypeComboBox.ItemsSource = Enum.GetValues(typeof(StudyType));
            StudyTypeComboBox.SelectedIndex = 0;

            ProjectContextComboBox.ItemsSource = System.Enum.GetValues(typeof(ProjectContext));
            ProjectContextComboBox.SelectedIndex = 0;

            DomainComboBox.ItemsSource = System.Enum.GetValues(typeof(ScientificDomain));
            DomainComboBox.SelectedIndex = 0;

            LoadProjects();
            
            // Force Startup View to Dashboard
            MainViewTabControl.SelectedItem = ViewDash;

            Loaded += MainWindow_Loaded;
            UpdateLicenseDisplay();
        }

        private void MainWindow_Loaded(object sender, RoutedEventArgs e)
        {
            CheckUserProfile();
            CheckLicense();
        }

        private void CheckLicense()
        {
            if (!_licensingService.IsActivated(out string status))
            {
                // Prompt verification
                WelcomeWindow prompt = new WelcomeWindow();
                // Optionally Pre-fill if profile exists? For now, clean slate for simplicity or re-registration.
                
                bool? result = prompt.ShowDialog();
                if (result != true || !_licensingService.IsActivated(out _))
                {
                    MessageBox.Show("Une licence valide est requise pour utiliser AdRev Desktop.\nL'application va se fermer.", "AccËs RefusÈ", MessageBoxButton.OK, MessageBoxImage.Error);
                    Application.Current.Shutdown();
                }
                else
                {
                    // Update Profile if changed in prompt
                    if (prompt.Profile != null) CheckUserProfile(); // Helper to reload or ensure persistence
                }
            }
            UpdateLicenseDisplay();        }

        private void CheckUserProfile()
        {
            string appData = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.ApplicationData), "AdRev");
            if (!Directory.Exists(appData)) Directory.CreateDirectory(appData);

            string profilePath = Path.Combine(appData, "user_profile.json");
            UserProfile? profile = null;

            if (File.Exists(profilePath))
            {
                try {
                    string json = File.ReadAllText(profilePath);
                    profile = JsonSerializer.Deserialize<UserProfile>(json);
                } catch { /* corrupted file */ }
            }

            if (profile == null || !profile.IsSet)
            {
                // First Run
                WelcomeWindow welcome = new WelcomeWindow();
                if (welcome.ShowDialog() == true)
                {
                    profile = welcome.Profile;
                    string json = JsonSerializer.Serialize(profile);
                    File.WriteAllText(profilePath, json);
                }
                else
                {
                    // If user cancels, maybe default?
                    profile = new UserProfile { Title = "", LastName = "Utilisateur" };
                }
            }

            // Update Greeting
            if (profile != null)
                UpdateGreeting(profile);
        }

        private void UpdateGreeting(UserProfile profile)
        {
            if (DashboardTitle == null) return;

            int hour = DateTime.Now.Hour;
            string greeting = (hour >= 18 || hour < 5) ? "Bonsoir" : "Bonjour";

            string namePart = "";
            if (!string.IsNullOrWhiteSpace(profile.Title)) namePart += profile.Title + " ";
            if (!string.IsNullOrWhiteSpace(profile.LastName)) namePart += profile.LastName;

            // "AdRev dit Bonjour Monsieur XY"
            DashboardTitle.Text = $"AdRev vous dit {greeting}, {namePart.Trim()}";
            DashboardTitle.FontSize = 24; // Adjust since text might be longer
        }

        private void LoadProjects()
        {
            var projects = _projectService.GetAllProjects().OrderByDescending(p => p.CreatedOn).ToList();
            
            // To dashboard recent items
            if (RecentProjectsListBox != null)
            {
                RecentProjectsListBox.ItemsSource = projects.Take(4);
            }
            
        
            // Dashboard Lists by Status/Team
            if (ProjectsListTeam != null)
            {
                ProjectsListTeam.ItemsSource = projects.Where(p => 
                    (p.Status != ProjectStatus.Completed && p.Status != ProjectStatus.Archived) && 
                    (p.Team != null && p.Team.Any())
                ).Take(6).ToList();
            }

            if (ProjectsListIndividual != null)
            {
                ProjectsListIndividual.ItemsSource = projects.Where(p => 
                    (p.Status != ProjectStatus.Completed && p.Status != ProjectStatus.Archived) && 
                    (p.Team == null || !p.Team.Any())
                ).Take(6).ToList();
            }
            
            if (ProjectsListCompleted != null)
            {
                ProjectsListCompleted.ItemsSource = projects.Where(p => p.Status == ProjectStatus.Completed || p.Status == ProjectStatus.Archived).Take(6).ToList();
            }

            // Dashboard Quick Stats
            if (StatOngoing != null) StatOngoing.Text = projects.Count(p => p.Status == ProjectStatus.Ongoing).ToString();
            if (StatValidated != null) StatValidated.Text = projects.Count(p => p.Status == ProjectStatus.Completed).ToString();


            // REFRESH LIBRARY
            RefreshLibrary(projects);
        }

        private void RefreshLibrary(List<ResearchProject>? allProjects = null)
        {
            if (LibraryGrid == null) return;
            var projects = allProjects ?? _projectService.GetAllProjects();

            // Filter logic
            if (LibraryStatusFilter != null && LibraryStatusFilter.SelectedIndex > 0)
            {
                if (LibraryStatusFilter.SelectedIndex == 1) // PubliÈ
                    projects = projects.Where(p => p.Status == ProjectStatus.Published).ToList();
                else if (LibraryStatusFilter.SelectedIndex == 2) // AcceptÈ
                    projects = projects.Where(p => p.Status == ProjectStatus.Accepted).ToList();
                else if (LibraryStatusFilter.SelectedIndex == 3) // TerminÈ
                    projects = projects.Where(p => p.Status == ProjectStatus.Completed).ToList();
            }
            else
            {
                // Default Library view: Show Published, Accepted, Completed
                projects = projects.Where(p => 
                    p.Status == ProjectStatus.Published || 
                    p.Status == ProjectStatus.Accepted || 
                    p.Status == ProjectStatus.Completed).ToList();
            }

            LibraryGrid.ItemsSource = projects.OrderByDescending(p => p.CreatedOn).ToList();
        }

        private void BtnRefreshLibrary_Click(object sender, RoutedEventArgs e)
        {
            LoadProjects(); // Will trigger RefreshLibrary
        }

        private void LibraryFilter_Changed(object sender, SelectionChangedEventArgs e)
        {
            if (!IsLoaded) return;
            LoadProjects();
        }

        private void BtnOpenProjectLibrary_Click(object sender, RoutedEventArgs e)
        {
             if (sender is Button btn && btn.DataContext is ResearchProject project)
             {
                 OpenProjectWindow(project);
             }
        }

        private void OpenProjectWindow(ResearchProject project)
        {
            // Optional: Check if a window is already open for this project
            ProjectWindow projectWin = new ProjectWindow(project);
            projectWin.Show();
        }

        private void LoadProjectIntoUI(ResearchProject project)
        {
            if (project == null) return;
            _currentProject = project;

            // Project-specific UI state is now managed by ProjectWindow
        }

        private void Ribbon_Checked(object sender, RoutedEventArgs e)
        {
            if (MainViewTabControl == null) return;

            // Navigation Logic: Switch Main View based on Ribbon Tab (Home Screen views only)
            if (RibbonFile != null && RibbonFile.IsChecked == true)
            {
                MainViewTabControl.SelectedItem = ViewDash;
            }
            else if (RibbonHelp != null && RibbonHelp.IsChecked == true)
            {
                MainViewTabControl.SelectedItem = ViewHelp;
            }
        }


        private void UpdateLicenseDisplay()
        {
            if (LicenseStatusText != null)
            {
                _licensingService.IsActivated(out string status);
                LicenseStatusText.Text = status;
            }
        }

        private void OpenActivation_Click(object sender, RoutedEventArgs e)
        {
            ActivationWindow activation = new ActivationWindow();
            if (activation.ShowDialog() == true)
            {
                UpdateLicenseDisplay();
            }
        }


        

        private void HelpAction_Click(object sender, RoutedEventArgs e)
        {
             if (sender is Button btn && btn.Tag is string action)
             {
                 if (action == "Documentation")
                 {
                     var helpWin = new HelpWindow();
                     helpWin.Owner = this;
                     helpWin.Show();
                 }
                 else if (action == "About")
                 {
                     var helpWin = new HelpWindow();
                     helpWin.Owner = this;
                     helpWin.Show();
                     helpWin.LoadTopic("About");
                 }
                 else
                 {
                     MessageBox.Show($"Action Support: {action}\n\n(Veuillez contacter le support informatique ‡ support@adrev.org)", "Support AdRev", MessageBoxButton.OK, MessageBoxImage.Information);
                 }
             }
        }

        // --- Quick Access Toolbar Handlers ---
        private void QuickSave_Click(object sender, RoutedEventArgs e) 
        {
             SaveFullProject();
             MessageBox.Show("Projet et donnÈes sauvegardÈs.", "AdRev");
        }
        private void QuickOpen_Click(object sender, RoutedEventArgs e) => MessageBox.Show("Ouvrir un projet.", "AdRev");
        private void QuickShare_Click(object sender, RoutedEventArgs e) => MessageBox.Show("Partage du projet.", "AdRev");
        private void QuickUndo_Click(object sender, RoutedEventArgs e) => MessageBox.Show("Annuler la derniËre action.", "AdRev");


        private void OpenTeamWindow_Click(object sender, RoutedEventArgs e)
        {
            if (_currentProject == null)
            {
                MessageBox.Show("Veuillez d'abord ouvrir ou crÈer un projet pour gÈrer l'Èquipe.", "Aucun projet ouvert", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            var win = new TeamWindow(_currentProject);
            win.Owner = this;
            win.ShowDialog();
        }

        private void TabHome_Click(object sender, RoutedEventArgs e) => MainViewTabControl.SelectedItem = ViewDash;
        private void TabNewProject_Click(object sender, RoutedEventArgs e) => MainViewTabControl.SelectedItem = ViewNewProject;


        // --- Utilities ---
        
        private TextBlock CreateHeader(string text) => new TextBlock { Text = text, FontSize = 18, FontWeight = FontWeights.Bold, Margin = new Thickness(0, 0, 0, 20), Foreground = (System.Windows.Media.Brush)Application.Current.Resources["PrimaryBrush"] };
        
        private TextBlock CreateError(string text) => new TextBlock { Text = "? " + text, Foreground = Brushes.Red, Margin = new Thickness(0, 10, 0, 0) };

        private Grid CreateInfoRow(string label, string value)
        {
            var g = new Grid { Margin = new Thickness(0, 2, 0, 2) };
            g.ColumnDefinitions.Add(new ColumnDefinition { Width = new GridLength(200) });
            g.ColumnDefinitions.Add(new ColumnDefinition { Width = GridLength.Auto });
            g.Children.Add(new TextBlock { Text = label, FontWeight = FontWeights.SemiBold });
            var v = new TextBlock { Text = value };
            Grid.SetColumn(v, 1);
            g.Children.Add(v);
            return g;
        }

        private static bool IsNumeric(VariableType type) => type == VariableType.QuantitativeDiscrete || type == VariableType.QuantitativeContinuous;



        








        private void Exit_Click(object sender, RoutedEventArgs e) => Application.Current.Shutdown();











        private void BrowseProjectFolder_Click(object sender, RoutedEventArgs e)
        {
            var dialog = new OpenFolderDialog();
            dialog.Title = "SÈlectionner le dossier du projet";
            dialog.Multiselect = false;
            
            if (dialog.ShowDialog() == true)
            {
                ProjectPathTextBox.Text = dialog.FolderName;
            }
        }

        private void ImportProjectFolder_Click(object sender, RoutedEventArgs e)
        {
            var dialog = new OpenFolderDialog();
            dialog.Title = "Importer un dossier projet existant";
            
            if (dialog.ShowDialog() == true)
            {
                try
                {
                    var project = _projectService.ImportFromFolder(dialog.FolderName);
                    LoadProjects();
                    MessageBox.Show($"Le projet '{project.Title}' a ÈtÈ importÈ avec succËs.", "SuccËs", MessageBoxButton.OK, MessageBoxImage.Information);
                }
                catch (Exception ex)
                {
                    MessageBox.Show($"Erreur lors de l'importation: {ex.Message}", "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
                }
            }
        }

        private void CreateProject_Click(object sender, RoutedEventArgs e)
        {
            var title = TitleTextBox.Text;

            if (string.IsNullOrWhiteSpace(title))
            {
                MessageBox.Show("Veuillez saisir un titre.");
                return;
            }

            var selectedStudyType = (StudyType)StudyTypeComboBox.SelectedItem;
            var selectedContext = (ProjectContext)ProjectContextComboBox.SelectedItem;
            var selectedDomain = (ScientificDomain)DomainComboBox.SelectedItem;
            var authors = AuthorsTextBox.Text;
            var institution = InstitutionTextBox.Text;
            
            string? customPath = null;
            if (ProjectPathTextBox.Text != "Documents/AdRev/Projects (DÈfaut)" && Directory.Exists(ProjectPathTextBox.Text))
            {
                customPath = ProjectPathTextBox.Text;
            }

            var project = _projectService.CreateNew(
                title,
                selectedStudyType,
                selectedContext,
                selectedDomain,
                authors,
                institution,
                customPath
            );

            _currentProject = project;

            ResultTextBlock.Text =
                $"Projet crÈÈ : {project.Title} ({project.StudyType})\nOuverture du projet...";
            
            LoadProjects();

            // Open Project Window
            OpenProjectWindow(project);

            // Switch to dashboard
            MainViewTabControl.SelectedItem = ViewDash;
        }

        private void OpenProject_Click(object sender, RoutedEventArgs e)
        {
            if (sender is Button btn && btn.DataContext is ResearchProject project)
            {
                OpenProjectWindow(project);
            }
        }



        private void DeleteProject_Click(object sender, RoutedEventArgs e)
        {
            if (sender is Button btn && btn.DataContext is ResearchProject project)
            {
                var result = MessageBox.Show($"Voulez-vous vraiment supprimer le projet '{project.Title}' ?", 
                    "Confirmation de suppression", MessageBoxButton.YesNo, MessageBoxImage.Warning);
                
                if (result == MessageBoxResult.Yes)
                {
                    _projectService.DeleteProject(project);
                    LoadProjects();
                    MessageBox.Show("Projet supprimÈ avec succËs.");
                }
            }
        }

        private void SaveFullProject()
        {
            if (_currentProject == null || string.IsNullOrEmpty(_currentProject.FilePath)) return;

            try
            {
                _projectService.SaveProject(_currentProject);
                // Folder structure is now handled by ProjectWindow or during creation
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur lors de la sauvegarde: {ex.Message}", "Erreur Sauvegarde", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        // Project-specific views have been moved to ProjectWindow





        // --- Custom Window Chrome Handlers ---
        private void Minimize_Click(object sender, RoutedEventArgs e) => WindowState = WindowState.Minimized;
        
        private void Maximize_Click(object sender, RoutedEventArgs e)
        {
            WindowState = WindowState == WindowState.Maximized ? WindowState.Normal : WindowState.Maximized;
        }

        private void Close_Click(object sender, RoutedEventArgs e) => Close();


        private void Window_Closing(object sender, System.ComponentModel.CancelEventArgs e)
        {
            var openProjectWindows = Application.Current.Windows.OfType<AdRev.Desktop.Windows.ProjectWindow>().ToList();
            if (openProjectWindows.Any())
            {
                var result = MessageBox.Show(
                    "Des fenÍtres de projet sont encore ouvertes. Voulez-vous vraiment fermer l'application principale ?\n(Toutes les fenÍtres de projet seront fermÈes)",
                    "Confirmation de Fermeture",
                    MessageBoxButton.YesNo,
                    MessageBoxImage.Warning);

                if (result == MessageBoxResult.No)
                {
                    e.Cancel = true;
                }
            }
        }




        private void LibraryMarkAccepted_Click(object sender, RoutedEventArgs e)
        {
            if (sender is FrameworkElement element && element.DataContext is ResearchProject project)
            {
                project.Status = ProjectStatus.Accepted;
                _projectService.SaveProject(project);
                LoadProjects();
                MessageBox.Show($"Le projet '{project.Title}' a ÈtÈ marquÈ comme AcceptÈ.", "Statut Mis ‡ Jour", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }

        private void LibraryMarkPublished_Click(object sender, RoutedEventArgs e)
        {
            if (sender is FrameworkElement element && element.DataContext is ResearchProject project)
            {
                project.Status = ProjectStatus.Published;
                if (!project.PublicationDate.HasValue) project.PublicationDate = DateTime.Now;
                
                _projectService.SaveProject(project);
                LoadProjects();
                MessageBox.Show($"Le projet '{project.Title}' a ÈtÈ marquÈ comme PubliÈ.", "Statut Mis ‡ Jour", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }
    }

}




FILE: \AdRev.Desktop\MANUEL_UTILISATEUR.md
------------------------------------
# üìò Manuel d'Utilisation - AdRev

Bienvenue dans **AdRev**, votre plateforme int√©gr√©e pour la recherche m√©dicale. Cette application a √©t√© con√ßue pour simplifier la conception de protocoles, la gestion de donn√©es et l'analyse statistique pour les chercheurs et professionnels de sant√©.

---

## üöÄ D√©marrage

1.  Lancez l'application via l'ex√©cutable `AdRev.Desktop.exe`.
2.  Vous arriverez sur le **Tableau de Bord Scientifique**.

---

## üè† Tableau de Bord

Le tableau de bord est votre centre de contr√¥le. Il affiche :
*   **Projets en cours** : Acc√®s rapide √† vos travaux r√©cents.
*   **Statistiques** : Vue d'ensemble de vos projets (En cours, Valid√©s).
*   **Analyse Rapide** : Importez directement des donn√©es pour une analyse imm√©diate sans cr√©er de projet complet.
*   **Navigation** : Utilisez le menu lat√©ral (Ic√¥nes Maison, Dossier, Analyse, Param√®tres) pour naviguer.

---

## üìù Gestion des Projets

### Cr√©er un Nouveau Projet
1.  Cliquez sur le bouton **"Nouveau Projet"** ou l'ic√¥ne `+` dans la barre lat√©rale.
2.  Remplissez les informations de base (Titre, Type d'√©tude).
3.  Le projet s'ouvre dans l'√©diteur.

### Ouvrir un Projet Existant
*   Depuis le tableau de bord, cliquez sur une carte de projet dans la liste "Projets R√©cents".
*   Ou allez dans l'onglet **Projets** (ic√¥ne Dossier) pour voir toute la liste.

---

## üìÑ √âditeur de Protocole

L'√©diteur de protocole vous guide √©tape par √©tape dans la r√©daction scientifique (Standard IMRAD/SPIRIT).

### √âtapes Cl√©s :
1.  **Infos G√©n√©rales** : Titre, Auteurs (Principal et Co-auteurs).
2.  **Introduction** : Contexte, Justification, Question de recherche, Hypoth√®ses.
3.  **Objectifs** : D√©finissez l'objectif g√©n√©ral et les objectifs sp√©cifiques (qui g√©n√©reront automatiquement le plan d'analyse !).
4.  **M√©thodologie** :
    *   **Design** : Type d'√©tude (Descriptive, Analytique, etc.).
    *   **Population** : Crit√®res d'inclusion et de non-inclusion.
    *   **√âchantillonnage** : Calculatrices int√©gr√©es (Cochran, Comparaison) pour d√©terminer la taille de l'√©chantillon.
    *   **Variables** : D√©finissez les variables collect√©es (dictionnaire de donn√©es).
5.  **Analyse** : Le plan d'analyse statistique (SAP) est pr√©-rempli intelligemment en fonction de vos objectifs.
6.  **Admin** : Budget, √âthique, Calendrier.

### üì§ Exportation Word
Une fois votre protocole r√©dig√© :
1.  Cliquez sur le menu **Fichier** en haut √† gauche.
2.  S√©lectionnez **Exporter en Word (.docx)**.
3.  Choisissez l'emplacement de sauvegarde. Un document parfaitement format√© sera g√©n√©r√©.

---

## üìä Analyse de Donn√©es

AdRev int√®gre des outils statistiques puissants :

### Importation
*   Support des fichiers **CSV**.
*   Cliquez sur "Importer Donn√©es" dans l'onglet Analyse.

### Tests Statistiques
Une fois les donn√©es import√©es ou variables d√©finies :
*   **Univari√©** : Fr√©quences, Moyennes, M√©dianes.
*   **Bivari√©** :
    *   **Chi2 / Fisher** : Pour comparer deux variables qualitatives.
    *   **Student (T-Test) / ANOVA** : Pour comparer des moyennes.
    *   **Corr√©lation** : Pour explorer le lien entre deux variables num√©riques.

---

## üí° Assistant de Discussion

Ne bloquez plus sur la r√©daction de la discussion !
1.  Ouvrez un projet.
2.  Dans le menu **Fichier** ou via le bouton d√©di√©, lancez l'**Assistant Discussion**.
3.  L'assistant vous posera des questions cibl√©es :
    *   *Quel est votre r√©sultat principal ?*
    *   *Comment se compare-t-il √† la litt√©rature ?*
    *   *Quelles sont les limites ?*
4.  Il g√©n√©rera ensuite un texte structur√© que vous pourrez ins√©rer directement dans votre protocole.

---

## ‚ÑπÔ∏è Support

Pour toute question ou rapport de bug, veuillez contacter l'√©quipe technique ou consulter la documentation interne du laboratoire.

*Version du manuel : 1.0 - Janvier 2026*




FILE: \AdRev.Desktop\MethodologyWindow.xaml
------------------------------------
<Window x:Class="AdRev.Desktop.MethodologyWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AdRev.Desktop"
        mc:Ignorable="d"
        Title="MethodologyWindow" Height="450" Width="800">
    <Grid Margin="20">
        <StackPanel>
            <TextBlock Text="ContrÙle de la mÈthodologie"
                   FontSize="20"
                   Margin="0,0,0,20" />

            <TextBlock Text="Titre du protocole :" />
            <TextBlock x:Name="TitleStatusTextBlock" Margin="0,0,0,10" />

            <TextBlock Text="Question de recherche :" />
            <TextBlock x:Name="ResearchQuestionStatusTextBlock" Margin="0,0,0,10" />

            <TextBlock Text="Objectif gÈnÈral :" />
            <TextBlock x:Name="GeneralObjectiveStatusTextBlock" Margin="0,0,0,10" />

            <TextBlock Text="Objectifs spÈcifiques :" />
            <TextBlock x:Name="SpecificObjectivesStatusTextBlock" Margin="0,0,0,10" />

            <TextBlock x:Name="OverallStatusTextBlock"
                   Margin="0,20,0,0"
                   FontWeight="Bold"
                   FontSize="16" />
        </StackPanel>
    </Grid>

</Window>




FILE: \AdRev.Desktop\MethodologyWindow.xaml.cs
------------------------------------
using System.Windows;
using AdRev.Core.Methodology;
using AdRev.Domain.Protocols;

namespace AdRev.Desktop
{
    public partial class MethodologyWindow : Window
    {
        private readonly MethodologyService _methodologyService;

        public MethodologyWindow(ResearchProtocol protocol)
        {
            InitializeComponent();
            _methodologyService = new MethodologyService();

            CheckProtocol(protocol);
        }

        private void CheckProtocol(ResearchProtocol protocol)
        {
            var check = _methodologyService.CheckProtocol(protocol);

            TitleStatusTextBlock.Text = check.TitleFilled ? "OK" : "Manquant";
            ResearchQuestionStatusTextBlock.Text = check.ResearchQuestionFilled ? "OK" : "Manquant";
            GeneralObjectiveStatusTextBlock.Text = check.GeneralObjectiveFilled ? "OK" : "Manquant";
            SpecificObjectivesStatusTextBlock.Text = check.SpecificObjectivesFilled ? "OK" : "Manquant";

            OverallStatusTextBlock.Text = check.IsValid() ? "Protocole valide ?" : "Protocole incomplet ?";
        }
    }
}




FILE: \AdRev.Desktop\ProtocolWindow.xaml
------------------------------------
<Window x:Class="AdRev.Desktop.ProtocolWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:AdRev.Desktop"
        Title="…diteur de Protocole" Height="700" Width="1100"
        WindowStartupLocation="CenterScreen"
        WindowStyle="None" ResizeMode="CanResize"
        Background="{StaticResource BackgroundBrush}">

    <Window.Resources>
        <!-- Role to Access Level Mapping simulation -->
        <local:EnumDescriptionConverter x:Key="EnumDescriptionConverter"/>
        
        <!-- Global Text Style Preference -->
        <Style TargetType="{x:Type TextBox}">
            <Setter Property="FontFamily" Value="Times New Roman"/>
            <Setter Property="FontSize" Value="12"/>
            <Setter Property="Padding" Value="5"/>
            <!-- LineHeight tricky in TextBox, usually depends on font metrics. Can simulate with Block.LineHeight if RichTextBox, but for TextBox just stick to Font. -->
        </Style>

        <!-- RichTextBox if used -->
        <Style TargetType="{x:Type RichTextBox}">
             <Setter Property="FontFamily" Value="Times New Roman"/>
             <Setter Property="FontSize" Value="12"/>
             <Setter Property="Block.LineHeight" Value="18"/> <!-- 1.5 spacing approx for 12pt -->
        </Style>

        <!-- Label Style Override -->
        <Style x:Key="LabelStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="Foreground" Value="#333"/>
            <Setter Property="Margin" Value="0,0,0,5"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="FontFamily" Value="Segoe UI"/> <!-- Labels keep UI font for readability -->
        </Style>

    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- 0: Title -->
            <RowDefinition Height="Auto"/> <!-- 1: Menu (Isolated) -->
            <RowDefinition Height="*"/>    <!-- 2: Content -->
            <RowDefinition Height="Auto"/> <!-- 3: Footer -->
        </Grid.RowDefinitions>

        <!-- En-tÍte -->
        <Border Grid.Row="0" Background="{StaticResource PrimaryBrush}" Padding="15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel VerticalAlignment="Center">
                    <TextBlock Text="…dition de Protocole de Recherche" Foreground="White" FontSize="18" FontWeight="Bold"/>
                    <TextBlock x:Name="ProjectTitleTextBlock" Text="Aucun projet liÈ" Foreground="#AACCFF" FontSize="12" Margin="0,2,0,0"/>
                </StackPanel>
                
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">
                    <StackPanel Orientation="Horizontal" Margin="0,0,20,0" x:Name="SharingRolePanel">
                        <TextBlock Text="Simuler en tant que :" Foreground="#AACCFF" FontSize="11" VerticalAlignment="Center" Margin="0,0,10,0"/>
                        
                        <ComboBox x:Name="ActiveRoleComboBox" Width="160" Height="28" FontSize="11" Margin="0,0,10,0" SelectionChanged="ActiveRoleAndAccess_SelectionChanged">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>

                        <ComboBox x:Name="ActiveAccessComboBox" Width="120" Height="28" FontSize="11" SelectionChanged="ActiveRoleAndAccess_SelectionChanged">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>
                    </StackPanel>
                    <Button Content="?" Click="Minimize_Click" Width="40" Height="30" Background="Transparent" Foreground="White" BorderThickness="0" Margin="0,0,5,0" FontWeight="Bold"/>
                    <Button Content="?" Click="Close_Click" Width="40" Height="30" Background="#CC3333" Foreground="White" BorderThickness="0" FontWeight="Bold"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- Menu Bar (Onglets) -->
        <Border Grid.Row="1" Background="#F8F9FA" BorderBrush="#E0E0E0" BorderThickness="0,0,0,1" Padding="5">
             <Menu Background="Transparent">
                <MenuItem Header="Fichier" FontSize="14" Margin="5,0,10,0">
                    <MenuItem x:Name="MenuFileNew" Header="Nouveau" Click="MenuFileNew_Click"/>
                    <MenuItem x:Name="MenuFileSave" Header="Enregistrer" Click="CreateProtocol_Click"/>
                    <MenuItem x:Name="MenuFileExport" Header="Exporter en Word (.docx)" Click="ExportWord_Click"/>
                    <Separator/>
                    <MenuItem Header="Quitter" Click="Close_Click"/>
                </MenuItem>
                
                <MenuItem Header="…dition" FontSize="14" Margin="5,0,10,0">
                    <MenuItem Header="Copier" Command="ApplicationCommands.Copy"/>
                    <MenuItem Header="Coller" Command="ApplicationCommands.Paste"/>
                </MenuItem>

                <!-- Assistant Discussion comme un 'Onglet' Menu Principal -->
                <MenuItem x:Name="MenuDiscussion" Header="Assistant Discussion ??" 
                          FontSize="14" 
                          FontWeight="Bold" 
                          Foreground="{StaticResource PrimaryBrush}" 
                          Margin="20,0,10,0"
                          Click="MenuDiscussion_Click"
                          ToolTip="Ouvrir la fenÍtre d'aide ‡ la discussion"/>
            </Menu>
        </Border>

        <!-- Contenu Principal : Multi-Vues -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="250"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Navigation LatÈrale -->
            <Border Grid.Column="0" Background="White" BorderBrush="#EEEEEE" BorderThickness="0,0,1,0" Padding="0,15,0,0">
                <ListBox x:Name="SideMenuListBox" BorderThickness="0" Background="Transparent" SelectionChanged="SideMenu_SelectionChanged" SelectedIndex="0" ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                    <ListBox.Resources>
                        <Style TargetType="ListBoxItem">
                            <Setter Property="Padding" Value="20,12"/>
                            <Setter Property="FontSize" Value="14"/>
                            <Setter Property="Cursor" Value="Hand"/>
                            <Setter Property="Margin" Value="0,2"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListBoxItem">
                                        <Border x:Name="bd" Background="{TemplateBinding Background}" BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="0" Padding="{TemplateBinding Padding}">
                                            <ContentPresenter HorizontalAlignment="Left" VerticalAlignment="Center"/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter TargetName="bd" Property="Background" Value="#E3F2FD"/>
                                                <Setter TargetName="bd" Property="BorderBrush" Value="#2196F3"/>
                                                <Setter TargetName="bd" Property="BorderThickness" Value="4,0,0,0"/>
                                                <Setter Property="Foreground" Value="#1976D2"/>
                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                            </Trigger>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="bd" Property="Background" Value="#F5F5F5"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListBox.Resources>
                    
                    <ListBoxItem Content="1. Informations GÈnÈrales" Tag="1"/>
                    <ListBoxItem Content="2. Introduction &amp; Contexte" Tag="2"/>
                    <ListBoxItem Content="3. Objectifs de l'…tude" Tag="3"/>
                    <ListBoxItem Content="4. Cadre Conceptuel" Tag="4"/>
                    <ListBoxItem Content="5. Design &amp; Cadre" Tag="5"/>
                    <ListBoxItem Content="6. Population &amp; CritËres" Tag="6"/>
                    <ListBoxItem Content="7. Echantillonnage" Tag="7"/>
                    <ListBoxItem Content="8. Collecte de donnÈes" Tag="8"/>
                    <ListBoxItem Content="9. Budget &amp; Ressources" Tag="9"/>
                    <ListBoxItem Content="10. ConsidÈrations …thiques" Tag="10"/>
                    <ListBoxItem Content="11. Plan d'Analyse (SAP/TAP)" Tag="11"/>
                    <ListBoxItem Content="12. RÈsultats Attendus" Tag="12"/>
                    <ListBoxItem Content="13. Conclusion" Tag="13"/>
                    <ListBoxItem Content="14. RÈfÈrences" Tag="14"/>
                </ListBox>
            </Border>

            <!-- Zone Contenu -->
            <Grid Grid.Column="1" Margin="30,20,30,20">
            
            <!-- …TAPE 1 : INFORMATIONS G…N…RALES -->
            <ScrollViewer x:Name="View_Step1" VerticalScrollBarVisibility="Auto" Visibility="Visible">
                <StackPanel MaxWidth="800">
                     <!-- Carte Informations GÈnÈrales -->
                    <Expander Style="{StaticResource ScientificExpanderStyle}" Header="…tape 1/14 : Informations GÈnÈrales" Tag="#E3F2FD" Foreground="#1565C0">
                        <StackPanel>
                            
                            <StackPanel Margin="0,0,0,15">
                                 <StackPanel Margin="0,0,0,15">
                                     <TextBlock Text="Titre du protocole" Style="{StaticResource LabelStyle}" FontWeight="SemiBold"/>
                                     <TextBox x:Name="TitleTextBox" Height="40" FontSize="14" VerticalContentAlignment="Center" Padding="5" Tag="Sujet de recherche, Titre complet du protocole..."/>
                                 </StackPanel>
                                 
                                 <StackPanel Margin="0,0,0,10">
                                     <TextBlock Text="Domaine de Recherche" Style="{StaticResource LabelStyle}" FontWeight="SemiBold"/>
                                     <ComboBox x:Name="DomainComboBox" Height="35" VerticalContentAlignment="Center" Padding="10,0" SelectionChanged="DomainComboBox_SelectionChanged" SelectedIndex="0">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                     </ComboBox>
                                 </StackPanel>

                                 <StackPanel Margin="0,0,0,10">
                                     <TextBlock Text="Style de RÈfÈrence Bibliographique" Style="{StaticResource LabelStyle}" FontWeight="SemiBold"/>
                                     <ComboBox x:Name="RefStyleComboStep1" Height="35" VerticalContentAlignment="Center" Padding="10,0" SelectionChanged="RefStyleCombo_SelectionChanged" SelectedIndex="0">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding}"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                     </ComboBox>
                                 </StackPanel>
                            </StackPanel>

                            <Rectangle Height="1" Fill="#EEEEEE" Margin="0,10,0,20"/>

                            <TextBlock Text="Auteur Principal" Style="{StaticResource HeaderTextStyle}" FontSize="16" Margin="0,0,0,10"/>
                            <Grid Margin="0,0,0,15">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="80"/>
                                    <ColumnDefinition Width="10"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="10"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="5"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="Titre" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                    <ComboBox x:Name="AuthorTitleBox" SelectedIndex="0" Height="30" VerticalContentAlignment="Center">
                                        <ComboBoxItem Content="Dr"/>
                                        <ComboBoxItem Content="Pr"/>
                                        <ComboBoxItem Content="M."/>
                                        <ComboBoxItem Content="Mme"/>
                                        <ComboBoxItem Content="Mlle"/>
                                    </ComboBox>
                                </StackPanel>
                                
                                <StackPanel Grid.Column="2">
                                    <TextBlock Text="PrÈnom" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                     <TextBox x:Name="AuthorFirstNameBox" Height="30" Tag="PrÈnom"/>
                                </StackPanel>
                                
                                <StackPanel Grid.Column="4">
                                    <TextBlock Text="Nom" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                     <TextBox x:Name="AuthorLastNameBox" Height="30" Tag="Nom"/>
                                </StackPanel>

                                <StackPanel Grid.Row="2" Grid.Column="0" Grid.ColumnSpan="3">
                                    <TextBlock Text="Institution" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                     <TextBox x:Name="AuthorInstitutionBox" Height="30" ToolTip="UniversitÈ, HÙpital, Centre de recherche..." Tag="Affiliation Institutionnelle"/>
                                </StackPanel>
                                
                                <StackPanel Grid.Row="2" Grid.Column="4">
                                    <TextBlock Text="Email" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                     <TextBox x:Name="AuthorEmailBox" Height="30" ToolTip="email@exemple.com" Tag="contact@exemple.com"/>
                                </StackPanel>
                            </Grid>

                            <TextBlock Text="Co-Auteurs" Style="{StaticResource HeaderTextStyle}" FontSize="16" Margin="0,10,0,5"/>
                            <Border Background="#F9F9F9" BorderBrush="#EEEEEE" BorderThickness="1" CornerRadius="5" Padding="15">
                                <StackPanel>
                                    <TextBlock Text="Ajouter un co-auteur :" Style="{StaticResource LabelStyle}" FontSize="12" FontWeight="Bold" Margin="0,0,0,10"/>
                                    
                                    <Grid Margin="0,0,0,5">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/> 
                                            <ColumnDefinition Width="*"/> 
                                            <ColumnDefinition Width="1.5*"/> 
                                            <ColumnDefinition Width="1.5*"/> 
                                            <ColumnDefinition Width="Auto"/> 
                                        </Grid.ColumnDefinitions>
                                        
                                         <TextBox x:Name="CoAuthFirst" Margin="0,0,5,0" Height="30" ToolTip="PrÈnom" Tag="PrÈnom"/>
                                         <TextBox x:Name="CoAuthLast" Grid.Column="1" Margin="0,0,5,0" Height="30" ToolTip="Nom" Tag="Nom"/>
                                         <TextBox x:Name="CoAuthInst" Grid.Column="2" Margin="0,0,5,0" Height="30" ToolTip="Institution" Tag="Institution"/>
                                         <TextBox x:Name="CoAuthEmail" Grid.Column="3" Margin="0,0,5,0" Height="30" ToolTip="Email" Tag="Email"/>
                                        
                                        <Button Grid.Column="4" Content="?" Click="AddCoAuthor_Click" Width="40" Height="30" Background="#DDDDDD" ToolTip="Ajouter"/>
                                    </Grid>
                                    
                                    <Grid Margin="0,0,0,10"> 
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="1.5*"/>
                                            <ColumnDefinition Width="1.5*"/>
                                            <ColumnDefinition Width="Auto"/> 
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="PrÈnom" FontSize="10" Foreground="#888" Margin="2,0,0,0"/>
                                        <TextBlock Grid.Column="1" Text="Nom" FontSize="10" Foreground="#888" Margin="2,0,0,0"/>
                                        <TextBlock Grid.Column="2" Text="Institution" FontSize="10" Foreground="#888" Margin="2,0,0,0"/>
                                        <TextBlock Grid.Column="3" Text="Email" FontSize="10" Foreground="#888" Margin="2,0,0,0"/>
                                    </Grid>

                                    <ListBox x:Name="CoAuthorsListBox" Height="100" BorderThickness="1" BorderBrush="#EEEEEE" Background="White">
                                        <ListBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding}" FontSize="12" Padding="5"/>
                                            </DataTemplate>
                                        </ListBox.ItemTemplate>
                                    </ListBox>
                                    <Button Content="??? Retirer la sÈlection" Click="RemoveCoAuthor_Click" HorizontalAlignment="Right" Margin="0,5,0,0" FontSize="11" Background="Transparent" BorderThickness="0" Foreground="#CC3333" Cursor="Hand"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </Expander>
                </StackPanel>
            </ScrollViewer>

            <!-- …TAPE 2 : INTRODUCTION -->
            <ScrollViewer x:Name="View_Introduction" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                <StackPanel MaxWidth="800">
                    <Expander Style="{StaticResource ScientificExpanderStyle}" Header="…tape 2/14 : Introduction &amp; Contexte" Tag="#E1F5FE" Foreground="#0277BD">
                         <StackPanel>
                            <TextBlock Text="Structure de l'Introduction (Max 2000 mots)" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                            
                            <Grid Margin="0,0,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="1. Contexte (DÈfinitions principales...)" Style="{StaticResource LabelStyle}" VerticalAlignment="Center"/>
                                <Button Grid.Column="1" Content="? Citer une source" Click="AddCitation_Click" Tag="Context" Height="25" FontSize="11" Padding="10,0" Background="#E0E0E0" Foreground="Black" Margin="0"/>
                            </Grid>
                             <TextBox x:Name="ContextTextBox" Height="300" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15" VerticalScrollBarVisibility="Auto" Tag="DÈcrivez l'Ètat actuel des connaissances, les dÈfinitions et le contexte global de votre Ètude..."/>

                            <Grid Margin="0,0,0,2">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="2. Justification du ProblËme (DonnÈes, Lacunes...)" Style="{StaticResource LabelStyle}"/>
                                <Button Grid.Column="1" Content="? Citer" Click="AddCitation_Click" Tag="ProblemTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                            </Grid>
                             <TextBox x:Name="ProblemTextBox" Height="80" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="Quelle est la lacune ou le problËme spÈcifique que cette Ètude vise ‡ rÈsoudre ?"/>

                            <TextBlock Text="3. Question de Recherche (Max 3)" Style="{StaticResource LabelStyle}"/>
                             <TextBox x:Name="ResearchQuestionTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="Ex: Quel est l'impact de X sur Y dans la population Z ?"/>

                            <TextBlock Text="4. HypothËses (Max 2)" Style="{StaticResource LabelStyle}"/>
                             <TextBox x:Name="HypothesesTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="Ex: Il existe une corrÈlation positive entre..."/>
                        </StackPanel>
                    </Expander>
                </StackPanel>
            </ScrollViewer>

            <!-- …TAPE 3 : OBJECTIFS -->
            <ScrollViewer x:Name="View_Objectives" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                <StackPanel MaxWidth="800">
                    <Expander Style="{StaticResource ScientificExpanderStyle}" Header="…tape 3/14 : Objectifs de l'…tude" Tag="#E8F5E9" Foreground="#2E7D32">
                        <StackPanel>
                            <TextBlock Text="Objectifs de l'Ètude" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                            
                            <TextBlock Text="Objectif GÈnÈral (Max 2)" Style="{StaticResource LabelStyle}" FontWeight="Bold"/>
                            <TextBlock Text="Utilisez des verbes d'action prÈcis (Taxonomie de Bloom)." FontSize="10" Foreground="#666" Margin="0,0,0,2"/>
                            
                            <!-- Alertes OG -->
                            <StackPanel Orientation="Horizontal" Margin="0,0,0,2">
                                <TextBlock x:Name="OGCountAlert" Text="?? Attention : Limitez-vous ‡ 3 Objectifs GÈnÈraux." Foreground="Red" FontWeight="Bold" FontSize="11" Visibility="Collapsed" Margin="0,0,10,0"/>
                                <TextBlock x:Name="OGBloomAlert" Text="?? Utilisez un verbe d'action Bloom." Foreground="#FF8C00" FontWeight="Bold" FontSize="11" Visibility="Collapsed"/>
                            </StackPanel>

                             <TextBox x:Name="GeneralObjectiveTextBox" Height="120" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" 
                                      TextChanged="GeneralObjectiveTextBox_TextChanged" Text=""
                                      PreviewKeyDown="ObjectiveTextBox_PreviewKeyDown" Tag="OG1: DÈterminer l'efficacitÈ de..."/>
 
                            <TextBlock Text="Objectifs SpÈcifiques (Max 4 par OG)" Style="{StaticResource LabelStyle}" FontWeight="Bold"/>
                            
                            <!-- Suggestions & Alertes OS -->
                            <TextBlock x:Name="OSSuggestions" Text="?? Verbes suggÈrÈs : ..." FontSize="11" Foreground="#1565C0" FontStyle="Italic" Margin="0,0,0,2" Visibility="Collapsed"/>
                            <Grid Margin="0,0,0,2">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock x:Name="OSCountAlert" Text="?? Attention : Max 4 OS par OG recommandÈs." Foreground="Red" FontWeight="Bold" FontSize="11" Visibility="Collapsed" Margin="0,0,10,0"/>
                                    <TextBlock x:Name="OSBloomAlert" Text="?? Utilisez des verbes d'action Bloom." Foreground="#FF8C00" FontWeight="Bold" FontSize="11" Visibility="Collapsed"/>
                                </StackPanel>
                                <StackPanel Grid.Column="1" Orientation="Horizontal">
                                    <Button Content="Lier aux OG ??" Click="LinkOSToOG_Click" FontSize="10" Padding="5,2" Background="#E3F2FD" BorderBrush="#2196F3" Foreground="#1565C0" Margin="0,0,5,0"/>
                                    <Button Content="?? Ajuster N∞" Click="RenumberOS_Click" FontSize="10" Padding="5,2" Background="#FFF3E0" BorderBrush="#FF9800" Foreground="#E65100" ToolTip="RenumÈrote automatiquement les OS (ex: corrige les doublons ou sauts)"/>
                                </StackPanel>
                            </Grid>

                             <TextBox x:Name="SpecificObjectivesTextBox" Height="250" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10"
                                      TextChanged="SpecificObjectivesTextBox_TextChanged" Text=""
                                      PreviewKeyDown="ObjectiveTextBox_PreviewKeyDown" Tag="OS1: Comparer les taux de..."/>
                        </StackPanel>
                    </Expander>
                </StackPanel>
            </ScrollViewer>

            <!-- …TAPE 4 : CADRE CONCEPTUEL -->
            <ScrollViewer x:Name="View_Step3" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                 <StackPanel MaxWidth="800">
                    <Expander Style="{StaticResource ScientificExpanderStyle}" Header="…tape 4/14 : Cadre Conceptuel" Tag="#E8EAF6" Foreground="#283593">
                         <StackPanel>
                            <TextBlock Text="DÈfinition des Concepts ClÈs" Style="{StaticResource LabelStyle}"/>
                             <TextBox x:Name="ConceptsTextBox" Height="100" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15" Tag="DÈfinissez les variables indÈpendantes, dÈpendantes et les concepts thÈoriques majeurs..."/>

                            <Grid Margin="0,0,0,2">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="ModËle Conceptuel (Optionnel)" Style="{StaticResource LabelStyle}"/>
                                <Button Grid.Column="1" Content="? Citer" Click="AddCitation_Click" Tag="ConceptualModelTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                            </Grid>
                             <TextBlock Text="DÈcrivez les relations entre les variables." FontSize="10" Foreground="#666" Margin="0,0,0,5"/>
                            <TextBox x:Name="ConceptualModelTextBox" Height="100" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="Expliquez comment les variables interagissent entre elles (SchÈma ou texte)..."/>
                        </StackPanel>
                    </Expander>
                 </StackPanel>
            </ScrollViewer>

            <!-- …TAPE 5 : METHODOLOGIE - Design & Cadre -->
            <ScrollViewer x:Name="View_Methodology_Design" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                <StackPanel MaxWidth="800">
                    <Expander Style="{StaticResource ScientificExpanderStyle}" Header="…tape 5/14 : MÈthodologie - Design &amp; Cadre" Tag="#E8F5E9" Foreground="#2E7D32">
                        <StackPanel>
                            <TextBlock Text="Type d'Ètude (Approche)" Style="{StaticResource LabelStyle}" FontWeight="SemiBold"/>
                            <ComboBox x:Name="StudyTypeComboBox" Height="40" Padding="10" VerticalContentAlignment="Center" FontSize="14" Margin="0,0,0,10" SelectionChanged="StudyTypeComboBox_SelectionChanged">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>

                            <StackPanel x:Name="QualitativeTypePanel" Visibility="Collapsed" Margin="0,0,0,15">
                                <TextBlock Text="Approche Qualitative" Style="{StaticResource LabelStyle}" FontWeight="SemiBold" Foreground="{StaticResource SecondaryBrush}"/>
                                <ComboBox x:Name="QualitativeApproachComboBox" Height="40" Padding="10" VerticalContentAlignment="Center" FontSize="14" SelectionChanged="RefreshAudit_LostFocus">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </StackPanel>

                            <StackPanel x:Name="EpidemiologyTypePanel" Visibility="Collapsed" Margin="0,0,0,15">
                                <TextBlock x:Name="DesignPrecisionLabel" Text="PrÈcision du Devis (MÈthodologie)" Style="{StaticResource LabelStyle}" FontWeight="SemiBold" Foreground="{StaticResource SecondaryBrush}"/>
                                <ComboBox x:Name="EpidemiologyTypeComboBox" Height="40" Padding="10" VerticalContentAlignment="Center" FontSize="14" SelectionChanged="EpidemiologyTypeComboBox_SelectionChanged">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>
                            </StackPanel>

                            <Grid Margin="0,0,0,2">
                                <Grid.ColumnDefinitions>
                                   <ColumnDefinition Width="*"/>
                                   <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Cadre de l'Ètude (Lieu, PÈriode)" Style="{StaticResource LabelStyle}"/>
                                <Button Grid.Column="1" Content="? Citer" Click="AddCitation_Click" Tag="StudySettingTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                            </Grid>
                            <TextBox x:Name="StudySettingTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" LostFocus="RefreshAudit_LostFocus" Tag="O˘ et quand se dÈroule l'Ètude ? (Ville, HÙpital, Services concernÈs...)"/>

                             <!-- Panneau Audit QualitÈ Dynamique -->
                            <Border x:Name="PanelQualityGuidelines" Visibility="Collapsed" Background="#E8F5E9" BorderBrush="#4CAF50" BorderThickness="1" CornerRadius="5" Padding="15" Margin="0,15,0,0">
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                        <TextBlock Text="? CritËres de QualitÈ MÈthodologique" FontWeight="Bold" FontSize="14" Foreground="#2E7D32" VerticalAlignment="Center"/>
                                        <TextBlock x:Name="QualityStandardName" Text="(COREQ/STROBE)" Foreground="#2E7D32" Margin="10,0,0,0" VerticalAlignment="Center" FontStyle="Italic"/>
                                    </StackPanel>
                                    
                                    <TextBlock Text="Cochez les ÈlÈments au fur et ‡ mesure que vous les intÈgrez :" FontSize="11" Foreground="#555" Margin="0,0,0,10"/>
                                    
                                    <ScrollViewer MaxHeight="300" VerticalScrollBarVisibility="Auto">
                                        <StackPanel x:Name="QualityGuidelinesList"/>
                                    </ScrollViewer>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </Expander>
                </StackPanel>
            </ScrollViewer>

            <!-- …TAPE 6 : METHODOLOGIE - Population & CritËres -->
            <ScrollViewer x:Name="View_Methodology_Population" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                <StackPanel MaxWidth="800">
                    <Expander Style="{StaticResource ScientificExpanderStyle}" Header="…tape 6/14 : MÈthodologie - Population &amp; CritËres" Tag="#F1F8E9" Foreground="#33691E">
                        <StackPanel>
                            <TextBlock Text="Population d'Ètude" Style="{StaticResource LabelStyle}"/>
                             <TextBox x:Name="PopulationTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="DÈfinissez la population source et la population cible (ex: Patients diabÈtiques de type 2)..."/>

                            <!-- Section …tude Multicentrique -->
                            <Border Background="#F5F5F5" BorderBrush="#DDDDDD" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,0,0,15">
                                <StackPanel>
                                    <CheckBox x:Name="IsMulticentricCheckBox" Content="…tude Multicentrique" FontWeight="SemiBold" Margin="0,0,0,10" Checked="IsMulticentricCheckBox_Checked" Unchecked="IsMulticentricCheckBox_Unchecked"/>
                                    
                                    <StackPanel x:Name="MulticentricDetailsPanel" Visibility="Collapsed">
                                        <TextBlock Text="Centres participants (un par ligne) :" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                         <TextBox x:Name="StudyCentersTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" ToolTip="Listez les centres participants ‡ l'Ètude" Tag="Ex: CHU A, Centre MÈdical B, etc."/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                            <Grid Margin="0,0,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="10"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <StackPanel Grid.Column="0">
                                    <Grid Margin="0,0,0,2">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="CritËres d'Inclusion" Style="{StaticResource LabelStyle}"/>
                                        <Button Grid.Column="1" Content="? Citer" Click="AddCitation_Click" Tag="InclusionTextBox" Height="22" FontSize="10" Padding="5,0" Background="#E0E0E0" Foreground="Black"/>
                                    </Grid>
                                     <TextBox x:Name="InclusionTextBox" Height="80" TextWrapping="Wrap" AcceptsReturn="True" Tag="Ex: ¬ge > 18 ans, Consentement signÈ..."/>
                                </StackPanel>
                                <StackPanel Grid.Column="2">
                                    <TextBlock Text="CritËres de Non-Inclusion" Style="{StaticResource LabelStyle}"/>
                                     <TextBox x:Name="ExclusionTextBox" Height="80" TextWrapping="Wrap" AcceptsReturn="True" Tag="Ex: ComorbiditÈs graves, Grossesse..."/>
                                </StackPanel>
                            </Grid>
                        </StackPanel>
                    </Expander>
                </StackPanel>
            </ScrollViewer>

            <!-- …TAPE 7 : METHODOLOGIE - Echantillonnage -->
            <ScrollViewer x:Name="View_Methodology_Sampling" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                <StackPanel MaxWidth="800">
                    <Expander Style="{StaticResource ScientificExpanderStyle}" Header="…tape 7/14 : MÈthodologie - Echantillonnage" Tag="#FFF8E1" Foreground="#FF6F00">
                        <StackPanel>
                             <!-- Section …chantillonnage AvancÈ -->
                            <Border Background="#FFF9E6" BorderBrush="#FFD700" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,0,0,15">
                                <StackPanel>
                                    <TextBlock Text="?? Configuration de l'…chantillonnage" FontWeight="Bold" FontSize="13" Margin="0,0,0,10"/>
                                    
                                    <TextBlock Text="Type d'Èchantillonnage :" Style="{StaticResource LabelStyle}" FontSize="11"/>
                                    <ComboBox x:Name="SamplingTypeComboBox" Height="32" Padding="8" VerticalContentAlignment="Center" FontSize="12" Margin="0,0,0,10" SelectionChanged="SamplingTypeComboBox_SelectionChanged">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>
                                    
                                    <!-- Options Stratification -->
                                    <StackPanel x:Name="StratificationPanel" Visibility="Collapsed" Margin="0,0,0,10">
                                        <CheckBox x:Name="IsStratifiedCheckBox" Content="…chantillonnage stratifiÈ" FontSize="11" Margin="0,0,0,5" Checked="IsStratifiedCheckBox_Checked" Unchecked="IsStratifiedCheckBox_Unchecked"/>
                                        <StackPanel x:Name="StratificationDetailsPanel" Visibility="Collapsed">
                                            <TextBlock Text="CritËres de stratification :" FontSize="10" Foreground="#666" Margin="15,0,0,2"/>
                                            <TextBox x:Name="StratificationCriteriaTextBox" Height="40" TextWrapping="Wrap" AcceptsReturn="True" Margin="15,0,0,0" FontSize="11" ToolTip="Ex: ¬ge, Sexe, RÈgion gÈographique..."/>
                                        </StackPanel>
                                    </StackPanel>
                                    
                                    <!-- Options Grappe -->
                                    <StackPanel x:Name="ClusterPanel" Visibility="Collapsed" Margin="0,0,0,10">
                                        <CheckBox x:Name="IsClusterCheckBox" Content="…chantillonnage en grappe" FontSize="11" Margin="0,0,0,5" Checked="IsClusterCheckBox_Checked" Unchecked="IsClusterCheckBox_Unchecked"/>
                                        <StackPanel x:Name="ClusterDetailsPanel" Visibility="Collapsed">
                                            <Grid Margin="15,0,0,0">
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="10"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <StackPanel>
                                                    <TextBlock Text="Taille moyenne des grappes :" FontSize="10" Foreground="#666"/>
                                                    <TextBox x:Name="ClusterSizeTextBox" Height="28" FontSize="11" Foreground="Black" ToolTip="Nombre moyen de sujets par grappe"/>
                                                </StackPanel>
                                                <StackPanel Grid.Column="2">
                                                    <TextBlock Text="Effet de plan (Design Effect) :" FontSize="10" Foreground="#666"/>
                                                    <TextBox x:Name="DesignEffectTextBox" Text="1.5" Height="28" FontSize="11" Foreground="Black" ToolTip="GÈnÈralement entre 1.5 et 2.0"/>
                                                </StackPanel>
                                            </Grid>
                                        </StackPanel>
                                    </StackPanel>
                                    
                            <!-- Taux de perdus de vue (AmÈliorÈ) -->
                            <Border Background="White" BorderBrush="#FFD700" BorderThickness="1" CornerRadius="4" Margin="0,10,0,0" Padding="10">
                                <StackPanel>
                                    <TextBlock Text="Gestion des perdus de vue (Attrition)" FontWeight="Bold" FontSize="12" Margin="0,0,0,5"/>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="15"/>
                                            <ColumnDefinition Width="80"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="Taux estimÈ :" VerticalAlignment="Center"/>
                                        <TextBox Grid.Column="2" x:Name="ExpectedLossRateTextBox" Text="10" Height="35" FontSize="14" FontWeight="Bold" Foreground="Black" Background="White" BorderBrush="Gray" BorderThickness="1" VerticalContentAlignment="Center" HorizontalContentAlignment="Center" Padding="0"/>
                                        <TextBlock Grid.Column="3" Text="%" VerticalAlignment="Center" Margin="5,0,0,0" FontSize="14"/>
                                    </Grid>
                                    <TextBlock Text="Ce taux sera ajoutÈ ‡ la taille calculÈe pour garantir la puissance statistique." FontSize="10" Foreground="#777" Margin="0,3,0,0" FontStyle="Italic"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </Border>

                    <!-- Selecteur de Calculateur -->
                    <Border Background="#F0F4C3" CornerRadius="5" Padding="15" Margin="0,0,0,10" BorderBrush="#CDDC39" BorderThickness="1">
                        <StackPanel>
                            <TextBlock Text="? Assistant de Calcul de Taille d'…chantillon" FontWeight="Bold" FontSize="14" Foreground="#827717" Margin="0,0,0,10"/>
                            
                            <Grid Margin="0,0,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="MÈthode :" VerticalAlignment="Center" Margin="0,0,10,0" FontWeight="SemiBold"/>
                                <ComboBox Grid.Column="1" x:Name="CalculatorSelector" Height="35" VerticalContentAlignment="Center" SelectionChanged="CalculatorSelector_SelectionChanged">
                                    <ComboBoxItem Content="Aucun (Saisie libre)" Tag="None" IsSelected="True"/>
                                    <ComboBoxItem Content="Estimation d'une PrÈvalence (Cochran/Schwartz)" Tag="Cochran"/>
                                    <ComboBoxItem Content="Comparaison de 2 Proportions (Analytique)" Tag="Comparison"/>
                                </ComboBox>
                            </Grid>

                        </StackPanel>
                    </Border>

                    <!-- Panneau Calculateur : COCHRAN / SCHWARTZ (Descriptif) -->
                            <Border x:Name="PanelCochran" Visibility="Collapsed" Background="#F0F8FF" BorderBrush="#ADD8E6" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,0,0,10">
                                <StackPanel>
                                    <TextBlock Text="Formule de Cochran / Schwartz (Population Finie ou Infinie)" FontSize="11" Foreground="#555" Margin="0,0,0,5"/>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <StackPanel Margin="0,0,5,0">
                                            <TextBlock Text="PrÈvalence p (%)" FontSize="10"/>
                                            <TextBox x:Name="Calc_Cochran_P" Text="50" Foreground="Black" ToolTip="Ex: 50 pour 50%"/>
                                        </StackPanel>
                                        
                                        <StackPanel Grid.Column="1" Margin="0,0,5,0">
                                            <TextBlock Text="PrÈcision d (%)" FontSize="10"/>
                                            <TextBox x:Name="Calc_Cochran_D" Text="5" Foreground="Black" ToolTip="Marge d'erreur, ex: 5%"/>
                                        </StackPanel>

                                        <StackPanel Grid.Column="2" Margin="0,0,5,0">
                                            <TextBlock Text="Population N" FontSize="10" FontWeight="Bold"/>
                                            <TextBox x:Name="Calc_Cochran_N" Text="" Foreground="Black" ToolTip="Laisser vide si inconnue/infinie"/>
                                        </StackPanel>

                                        <StackPanel Grid.Column="3" Margin="0,0,5,0">
                                            <TextBlock Text="Confiance (Z)" FontSize="10"/>
                                            <ComboBox x:Name="Calc_Cochran_Z" SelectedIndex="1">
                                                <ComboBoxItem Content="90%" Tag="1.65"/>
                                                <ComboBoxItem Content="95%" Tag="1.96"/>
                                                <ComboBoxItem Content="99%" Tag="2.58"/>
                                            </ComboBox>
                                        </StackPanel>

                                        <Button Grid.Column="4" Content="Calculer" Click="CalculateCochran_Click" Padding="10,0" VerticalAlignment="Bottom" Height="22"/>
                                    </Grid>
                                    <TextBlock x:Name="ResultCochran" Text="N = ?" FontWeight="Bold" Foreground="#007ACC" Margin="0,5,0,0" HorizontalAlignment="Right"/>
                                </StackPanel>
                            </Border>

                            <!-- Panneau Calculateur : COMPARAISON (Analytique) -->
                            <Border x:Name="PanelComparison" Visibility="Collapsed" Background="#FFF5E5" BorderBrush="#FFDAB9" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,0,0,10">
                                <StackPanel>
                                    <TextBlock Text="Comparaison de Deux Proportions (Cas-TÈmoins / Cohorte)" FontSize="11" Foreground="#555" Margin="0,0,0,5"/>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <StackPanel Margin="0,0,5,0">
                                            <TextBlock Text="P1 (ExposÈs/Cas) %" FontSize="10"/>
                                            <TextBox x:Name="Calc_Comp_P1" Text="30" Foreground="Black"/>
                                        </StackPanel>

                                        <StackPanel Grid.Column="1" Margin="0,0,5,0">
                                            <TextBlock Text="P2 (TÈmoins/Non) %" FontSize="10"/>
                                            <TextBox x:Name="Calc_Comp_P2" Text="15" Foreground="Black"/>
                                        </StackPanel>

                                        <StackPanel Grid.Column="2" Margin="0,0,5,0">
                                            <TextBlock Text="Confiance (Alpha)" FontSize="10"/>
                                            <ComboBox x:Name="Calc_Comp_Alpha" SelectedIndex="1">
                                                <ComboBoxItem Content="5% (1.96)" Tag="1.96"/>
                                                <ComboBoxItem Content="1% (2.58)" Tag="2.58"/>
                                            </ComboBox>
                                        </StackPanel>
                                        
                                        <StackPanel Grid.Column="3" Margin="0,0,5,0">
                                            <TextBlock Text="Puissance (1-Beta)" FontSize="10"/>
                                            <ComboBox x:Name="Calc_Comp_Power" SelectedIndex="1">
                                                <ComboBoxItem Content="80% (0.84)" Tag="0.84"/>
                                                <ComboBoxItem Content="90% (1.28)" Tag="1.28"/>
                                            </ComboBox>
                                        </StackPanel>

                                        <StackPanel Grid.Column="4" VerticalAlignment="Bottom">
                                            <CheckBox x:Name="Chk_Matched" Content="AppariÈ ?" ToolTip="Cocher si Cas et TÈmoins sont appariÈs (Matching)" FontSize="10" Margin="0,0,0,5"/>
                                            <Button Content="Calculer" Click="CalculateComparison_Click" Padding="10,0" Height="22"/>
                                        </StackPanel>
                                    </Grid>
                                    <TextBlock x:Name="ResultComparison" Text="N par groupe = ?" FontWeight="Bold" Foreground="#D2691E" Margin="0,5,0,0" HorizontalAlignment="Right"/>
                                </StackPanel>
                            </Border>

                            <Grid Margin="0,0,0,2">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Texte final sur l'Èchantillonnage :" Style="{StaticResource LabelStyle}"/>
                                <Button Grid.Column="1" Content="? Citer" Click="AddCitation_Click" Tag="SamplingTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                            </Grid>
                             <TextBox x:Name="SamplingTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" Tag="DÈtaillez la procÈdure de sÈlection des participants (ex: tirage au sort, recrutement consÈcutif...)"/>
                        </StackPanel>
                    </Expander>
                </StackPanel>
            </ScrollViewer>

            <!-- …TAPE 8 : METHODOLOGIE - Collecte de donnÈes -->
            <ScrollViewer x:Name="View_Methodology_Data" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                <StackPanel MaxWidth="800">
                    <Expander Style="{StaticResource ScientificExpanderStyle}" Header="…tape 8/13 : MÈthodologie - Collecte de donnÈes" Tag="#E0F2F1" Foreground="#00695C">
                        <StackPanel>
                            <!-- Nouveau bouton pour le masque de saisie -->
                            <Border Background="#E8F5E9" CornerRadius="5" Padding="10" Margin="0,0,0,15" BorderBrush="#4CAF50" BorderThickness="1">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel>
                                        <TextBlock Text="?? Dictionnaire des Variables / Masque de Saisie" FontWeight="Bold" Foreground="#2E7D32"/>
                                        <TextBlock Text="DÈfinissez les variables de l'Ètude (comme dans Epi Info 'Make View')" FontSize="11" Foreground="#555"/>
                                    </StackPanel>
                                    <Button Grid.Column="1" Content="Ouvrir le Concepteur" Padding="15,5" Background="#4CAF50" Foreground="White" BorderThickness="0" Click="OpenVariableDesigner_Click" Cursor="Hand">
                                        <Button.Resources>
                                            <Style TargetType="Border">
                                                <Setter Property="CornerRadius" Value="4"/>
                                            </Style>
                                        </Button.Resources>
                                    </Button>
                                </Grid>
                            </Border>

                            <Grid Margin="0,0,0,2">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="ProcÈdures de Collecte" Style="{StaticResource LabelStyle}"/>
                                <Button Grid.Column="1" Content="? Citer" Click="AddCitation_Click" Tag="DataCollectionTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                            </Grid>
                             <TextBox x:Name="DataCollectionTextBox" Height="250" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10" Tag="DÈcrivez les outils (Questionnaires, Mesures cliniques) et les procÈdures de collecte..."/>
                        </StackPanel>
                    </Expander>
                </StackPanel>
            </ScrollViewer>

            <!-- …TAPE 9 : BUDGET (Nouveau) -->
            <ScrollViewer x:Name="View_Budget" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                <StackPanel MaxWidth="800">
                    <Expander Style="{StaticResource ScientificExpanderStyle}" Header="…tape 9/14 : Budget &amp; Ressources" Tag="#FFF3E0" Foreground="#EF6C00">
                        <StackPanel>
                            <TextBlock Text="Estimation des Ressources &amp; Budget" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                            
                            <!-- Carte de suggestions dynamiques -->
                            <Border x:Name="BudgetSuggestionsPanel" Background="#E3F2FD" BorderBrush="#2196F3" BorderThickness="1" CornerRadius="5" Padding="15" Margin="0,0,0,15">
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                        <TextBlock Text="?? Suggestions basÈes sur votre mÈthode :" FontWeight="Bold" Foreground="#1565C0"/>
                                        <TextBlock x:Name="BudgetSuggestionType" Text="(Type)" Margin="5,0,0,0" FontStyle="Italic" Foreground="#1565C0"/>    
                                    </StackPanel>
                                    <TextBlock x:Name="BudgetSuggestionsText" Text="ï Personnel..." TextWrapping="Wrap" FontSize="13"/>
                                </StackPanel>
                            </Border>

                            <TextBlock Text="DÈtail du Budget" Style="{StaticResource LabelStyle}"/>
                            <TextBox x:Name="BudgetTextBox" Height="200" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15" VerticalContentAlignment="Top" Padding="10"/>
                            
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Total EstimÈ (Devise locale) :" VerticalAlignment="Center" FontWeight="Bold"/>
                                <TextBox Grid.Column="1" x:Name="BudgetTotalBox" Margin="10,0,0,0" Height="30" Width="150" HorizontalAlignment="Left"/>
                            </Grid>
                        </StackPanel>
                    </Expander>
                </StackPanel>
            </ScrollViewer>

            <!-- …TAPE 10 : CONCLUSION & ETHIQUE -->
            <!-- …TAPE 10 : CONSIDERATIONS ETHIQUES -->
            <ScrollViewer x:Name="View_Step10" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                 <StackPanel MaxWidth="800">
                    <Expander Style="{StaticResource ScientificExpanderStyle}" Header="…tape 10/14 : ConsidÈrations …thiques" Tag="#FFEBEE" Foreground="#C62828">
                        <StackPanel>
                            <Grid Margin="0,0,0,2">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="ConsidÈrations …thiques" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                <Button Grid.Column="1" Content="? Citer" Click="AddCitation_Click" Tag="EthicsTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                            </Grid>
                            <TextBlock Text="DÈcrivez les mesures prises pour protÈger les participants (consentement, confidentialitÈ, approbation Èthique...)." FontSize="11" Foreground="#666" Margin="0,0,0,5"/>
                            <TextBox x:Name="EthicsTextBox" Height="150" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15"/>
                        </StackPanel>
                    </Expander>
                </StackPanel>
            </ScrollViewer>

            <!-- …TAPE 11 : PLAN D'ANALYSE (IndÈpendant) -->
            <ScrollViewer x:Name="View_DataAnalysis" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                <StackPanel MaxWidth="800">
                    <Expander Style="{StaticResource ScientificExpanderStyle}" Header="…tape 11/14 : Plan d'Analyse des DonnÈes" Tag="#EDE7F6" Foreground="#4527A0">
                        <StackPanel>
                            <TextBlock Text="Cette section est CRUCIALE : elle dÈfinit comment vous allez rÈpondre ‡ vos objectifs." FontSize="11" Foreground="#666" Margin="0,0,0,15" FontStyle="Italic"/>
                            <Grid Margin="0,0,0,5">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Description du Plan d'Analyse" Style="{StaticResource LabelStyle}" VerticalAlignment="Center"/>
                                <Button Grid.Column="1" Content="? GÈnÈrer Plan Automatique" Click="GenerateProtocolPlan_Click" Height="25" FontSize="11" Padding="12,0" Margin="0,0,8,0" Background="#FFF3E0" Foreground="#E65100" BorderBrush="#FFCC80" BorderThickness="1"/>
                                <Button Grid.Column="2" Content="? Citer" Click="AddCitation_Click" Tag="DataAnalysisTextBox" Height="25" FontSize="11" Padding="10,0" Background="#E0E0E0" Foreground="Black"/>
                            </Grid>
                            <TextBox x:Name="DataAnalysisTextBox" Height="350" TextWrapping="Wrap" AcceptsReturn="True" VerticalScrollBarVisibility="Auto" Margin="0,0,0,10" Tag="Le plan gÈnÈrÈ apparaÓtra ici. Vous pouvez ensuite le modifier librement."/>
                            
                            <Border Background="#E3F2FD" Padding="10" CornerRadius="5">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="??" Margin="0,0,10,0"/>
                                    <TextBlock Text="Le plan rÈdigÈ ici sera automatiquement disponible dans l'onglet 'Analyse' de la fenÍtre principale." FontSize="11" Foreground="#1565C0" TextWrapping="Wrap"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </Expander>
                </StackPanel>
            </ScrollViewer>

            <!-- …TAPE 12 : RESULTATS ATTENDUS -->
            <ScrollViewer x:Name="View_Results" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                <StackPanel MaxWidth="800">
                    <Expander Style="{StaticResource ScientificExpanderStyle}" Header="…tape 12/14 : RÈsultats Attendus" Tag="#E0F7FA" Foreground="#006064">
                        <StackPanel>
                            <Grid Margin="0,0,0,2">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="RÈsultats Attendus" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                <Button Grid.Column="1" Content="? Citer" Click="AddCitation_Click" Tag="ExpectedResultsTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                            </Grid>
                            <TextBlock Text="Quels sont les rÈsultats escomptÈs et leur impact ?" FontSize="11" Foreground="#666" Margin="0,0,0,5"/>
                            <TextBox x:Name="ExpectedResultsTextBox" Height="200" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15"/>
                        </StackPanel>
                    </Expander>
                </StackPanel>
            </ScrollViewer>

            <!-- …TAPE 12 : CONCLUSION -->
            <ScrollViewer x:Name="View_Conclusion" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                <StackPanel MaxWidth="800">
                    <Expander Style="{StaticResource ScientificExpanderStyle}" Header="…tape 12/13 : Conclusion" Tag="#ECEFF1" Foreground="#37474F">
                        <StackPanel>
                            <Grid Margin="0,0,0,2">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="Conclusion" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                <Button Grid.Column="1" Content="? Citer" Click="AddCitation_Click" Tag="ConclusionTextBox" Height="22" FontSize="10" Padding="8,0" Background="#E0E0E0" Foreground="Black"/>
                            </Grid>
                            <TextBlock Text="SynthËse, retombÈes et recommandations." FontSize="11" Foreground="#666" Margin="0,0,0,5"/>
                            <TextBox x:Name="ConclusionTextBox" Height="200" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,15"/>
                        </StackPanel>
                    </Expander>
                </StackPanel>
            </ScrollViewer>

            <!-- …TAPE 13 : REFERENCES -->
            <ScrollViewer x:Name="View_References" VerticalScrollBarVisibility="Auto" Visibility="Collapsed">
                <StackPanel MaxWidth="800">
                    <Expander Style="{StaticResource ScientificExpanderStyle}" Header="…tape 13/13 : RÈfÈrences Bibliographiques" Tag="#FAFAFA" Foreground="#424242">
                        <StackPanel>
                            <Grid Margin="0,0,0,10">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="RÈfÈrences Bibliographiques" Style="{StaticResource HeaderTextStyle}" FontSize="16"/>
                                <ComboBox Grid.Column="1" x:Name="RefStyleComboStep13" Height="30" Width="150" VerticalContentAlignment="Center" SelectionChanged="RefStyleCombo_SelectionChanged" SelectedIndex="0"/>
                            </Grid>
                            
                            <TextBlock Text="Liste gÈnÈrÈe automatiquement :" FontSize="11" Foreground="#666" Margin="0,0,0,5"/>
                            <TextBox x:Name="ReferencesTextBox" Height="500" TextWrapping="Wrap" AcceptsReturn="True" Margin="0,0,0,10" VerticalScrollBarVisibility="Auto" IsReadOnly="False"/>
                            <Button Content="?? RÈgÈnÈrer la liste" Click="RegenerateReferences_Click" HorizontalAlignment="Right" Width="150" Height="30" FontSize="12"/>
                        </StackPanel>
                    </Expander>
                </StackPanel>
            </ScrollViewer>
            
            </Grid>
        </Grid>

        <!-- Barre d'action fixe en bas -->
        <Border Grid.Row="3" Background="White" BorderBrush="#EEEEEE" BorderThickness="0,1,0,0" Padding="15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <!-- Navigation Gauche -->
                <StackPanel Grid.Column="0" Orientation="Horizontal">
                    <Button Content="?? PrÈcÈdent" Click="PrevSection_Click" Height="40" Width="120" Margin="0,0,10,0" Background="#F0F0F0" Foreground="Black" BorderThickness="0"/>
                    <Button Content="Suivant ??" Click="NextSection_Click" Height="40" Width="120" Background="#F0F0F0" Foreground="Black" BorderThickness="0"/>
                </StackPanel>

                <!-- Zone de messages de validation -->
                <ListBox Grid.Column="1" x:Name="ValidationMessagesListBox" BorderThickness="0" Background="Transparent" Foreground="{StaticResource ErrorBrush}" FontSize="12" MaxHeight="60" Margin="20,0,20,0" VerticalAlignment="Center"/>

                <!-- Bouton Action -->
                <Button Grid.Column="2" Content="Valider et Enregistrer" Click="CreateProtocol_Click" Height="45" Width="200" FontSize="15" FontWeight="Bold"/>
            </Grid>
        </Border>

        <!-- Overlay de Citation supprimÈ ici, remplacÈ par CitationEntryWindow -->
    </Grid>
</Window>




FILE: \AdRev.Desktop\ProtocolWindow.xaml.cs
------------------------------------
using System.Windows;
using System.Windows.Input;
using System.Windows.Controls;
using System.Windows.Media;
using System.Collections.Generic;
using System.Linq;
using AdRev.Core.Protocols;
using AdRev.Domain.Enums;
using AdRev.Domain.Protocols;
using AdRev.Domain.Models;

using AdRev.Core.Services;
using System.Net.Http;
using System.Text.Json;
using Microsoft.Win32;
using AdRev.Desktop.Services;

namespace AdRev.Desktop
{
    public partial class ProtocolWindow : Window
    {
        private readonly ProtocolService _service = new ProtocolService();
        private readonly QualityService _qualityService = new QualityService();
        private readonly WordExportService _wordExportService = new WordExportService();

        // Liste temporaire pour l'UI
        private System.Collections.ObjectModel.ObservableCollection<AdRev.Domain.Models.Author> _tempCoAuthors 
            = new System.Collections.ObjectModel.ObservableCollection<AdRev.Domain.Models.Author>();

        // Liste temporaire pour les variables (Masque de Saisie)
        private System.Collections.Generic.List<AdRev.Domain.Variables.StudyVariable> _tempVariables 
            = new System.Collections.Generic.List<AdRev.Domain.Variables.StudyVariable>();

        // Stockage tampon pour la discussion (venant de la fenÍtre externe)
        private string _discussionPlan = string.Empty;
        private string _limitations = string.Empty;

        private AdRev.Domain.Models.ResearchProject? _project;
        private FunctionalRole _currentRole = FunctionalRole.PrincipalInvestigator;
        private UserAccessLevel _currentAccessLevel = UserAccessLevel.Admin;

        public ProtocolWindow() : this(new AdRev.Domain.Models.ResearchProject(), FunctionalRole.PrincipalInvestigator, UserAccessLevel.Admin) { }

        public ProtocolWindow(AdRev.Domain.Models.ResearchProject? project, FunctionalRole role = FunctionalRole.PrincipalInvestigator, UserAccessLevel access = UserAccessLevel.Admin)
        {
            InitializeComponent();
            _project = project;
            _currentRole = role;
            _currentAccessLevel = access;

            StudyTypeComboBox.ItemsSource = System.Enum.GetValues(typeof(StudyType));
            StudyTypeComboBox.SelectedIndex = 0;
            
            EpidemiologyTypeComboBox.ItemsSource = System.Enum.GetValues(typeof(EpidemiologicalStudyType));
            EpidemiologyTypeComboBox.SelectedIndex = 0;

            QualitativeApproachComboBox.ItemsSource = System.Enum.GetValues(typeof(QualitativeApproach));
            QualitativeApproachComboBox.SelectedIndex = 0;
            
            SamplingTypeComboBox.ItemsSource = System.Enum.GetValues(typeof(SamplingType));
            SamplingTypeComboBox.SelectedIndex = 0;
            UpdateSamplingTypes((StudyType)StudyTypeComboBox.SelectedItem);
            
            CoAuthorsListBox.ItemsSource = _tempCoAuthors;

            if (_project != null)
            {
                ProjectTitleTextBlock.Text = "Projet : " + _project.Title;
                TitleTextBox.Text = _project.Title;
                StudyTypeComboBox.SelectedItem = _project.StudyType;
                DomainComboBox.SelectedItem = _project.Domain;
                AuthorInstitutionBox.Text = _project.Institution;
                ProcessAuthors(_project.Authors);
            }
            
            RefStyleComboStep1.ItemsSource = System.Enum.GetValues(typeof(ReferenceStyle));
            RefStyleComboStep13.ItemsSource = System.Enum.GetValues(typeof(ReferenceStyle));
            
            // Default check
            RefStyleComboStep1.SelectedItem = ReferenceStyle.Vancouver;
            RefStyleComboStep13.SelectedItem = ReferenceStyle.Vancouver;

            DomainComboBox.ItemsSource = System.Enum.GetValues(typeof(ScientificDomain));
            DomainComboBox.SelectedIndex = 0;

            // Role selection for shared protocols simulation
            ActiveRoleComboBox.ItemsSource = System.Enum.GetValues(typeof(FunctionalRole));
            ActiveRoleComboBox.SelectedItem = _currentRole;

            ActiveAccessComboBox.ItemsSource = System.Enum.GetValues(typeof(UserAccessLevel));
            ActiveAccessComboBox.SelectedItem = _currentAccessLevel;

            // Only show role selection for shared projects (team projects)
            if (_project != null && (_project.Team != null && _project.Team.Any()))
            {
                SharingRolePanel.Visibility = Visibility.Visible;
            }
            else
            {
                SharingRolePanel.Visibility = Visibility.Collapsed;
            }

            ApplyPermissions();
        }

        private void ActiveRoleAndAccess_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (ActiveRoleComboBox == null || ActiveAccessComboBox == null) return;
            
            if (ActiveRoleComboBox.SelectedItem is FunctionalRole role && 
                ActiveAccessComboBox.SelectedItem is UserAccessLevel access)
            {
                _currentRole = role;
                _currentAccessLevel = access;
                ApplyPermissions();
            }
        }

        private void ApplyPermissions()
        {
            // Reset all to Visible first (Collaboration principle: see more, edit less)
            for (int i = 0; i < SideMenuListBox.Items.Count; i++)
            {
                if (SideMenuListBox.Items[i] is ListBoxItem item) item.Visibility = Visibility.Visible;
            }
            MenuFileNew.Visibility = Visibility.Visible;
            MenuFileSave.Visibility = Visibility.Visible;
            MenuDiscussion.Visibility = Visibility.Visible;

            // Simple RBAC by disabling sidebar items ONLY if truly irrelevant
            for (int i = 0; i < SideMenuListBox.Items.Count; i++)
            {
                var item = SideMenuListBox.Items[i] as ListBoxItem;
                if (item == null) continue;

                var tag = item.Tag?.ToString();
                if (string.IsNullOrEmpty(tag)) continue;

                int step = int.Parse(tag);
                bool canSee = true;

                switch (_currentRole)
                {
                    case FunctionalRole.Student:
                        // Hide internal stuff like budget/ethics for students if needed
                        canSee = (step != 9); 
                        break;
                    case FunctionalRole.Monitor:
                        // ARC sees medical/data parts, maybe not budget
                        canSee = (step != 9);
                        break;
                }

                item.Visibility = canSee ? Visibility.Visible : Visibility.Collapsed;
                
                // Visual feedback: if can see but not edit, maybe add a lock icon simulation?
                // For now, we'll just handle editability in UpdateView.
            }

            // Menu RBAC
            if (_currentAccessLevel == UserAccessLevel.Viewer || _currentRole == FunctionalRole.Student || _currentRole == FunctionalRole.Monitor)
            {
                MenuFileSave.Visibility = Visibility.Collapsed;
            }
            
            if (_currentRole == FunctionalRole.DataManager || _currentAccessLevel == UserAccessLevel.Viewer)
            {
                MenuDiscussion.Visibility = Visibility.Collapsed;
            }

            // Refresh the current view to apply read-only status to the active step
            UpdateView();
        }

        private bool CanUserEditStep(int step)
        {
            if (_currentAccessLevel == UserAccessLevel.Admin) return true;
            if (_currentAccessLevel == UserAccessLevel.Viewer) return false;

            // Editor level - Role based permissions
            switch (_currentRole)
            {
                case FunctionalRole.PrincipalInvestigator:
                    return true;
                case FunctionalRole.Methodologist:
                    // Can edit almost everything except maybe budget
                    return (step != 9);
                case FunctionalRole.Statistician:
                    // Sampling (7), Collecte (8), Analysis (11), Results (12)
                    return (step == 7 || step == 8 || step == 11 || step == 12);
                case FunctionalRole.DataManager:
                    // Info (1), Collecte (8), Budget (9), Analysis (11)
                    return (step == 1 || step == 8 || step == 9 || step == 11);
                case FunctionalRole.CoInvestigator:
                    // Most parts except administrative/budget/ethics
                    return (step != 9 && step != 10);
                case FunctionalRole.Student:
                    // Intro, Objectives, Design, Results
                    return (step <= 6 || step == 12 || step == 13);
                default:
                    return false;
            }
        }

        private void SetProtocolReadOnly(bool isReadOnly)
        {
            // Traverse the UI and set textboxes/comboboxes
            // This is a simplified version, ideally use a property on ViewModel
            
            foreach (var tb in FindVisualChildren<TextBox>(this))
            {
                tb.IsReadOnly = isReadOnly;
                tb.Opacity = isReadOnly ? 0.8 : 1.0;
            }

            foreach (var cb in FindVisualChildren<ComboBox>(this))
            {
                // ComboBox doesn't have IsReadOnly for selection, use IsEnabled
                // Except for our simulation ones!
                if (cb.Name == "ActiveRoleComboBox" || cb.Name == "ActiveAccessComboBox") continue;
                cb.IsEnabled = !isReadOnly;
                cb.Opacity = isReadOnly ? 0.8 : 1.0;
            }

            foreach (var btn in FindVisualChildren<Button>(this))
            {
                // Disable action buttons (Add co-author, calculate, etc.)
                if (btn.Name == "Minimize_Click" || btn.Name == "Close_Click" || btn.IsEnabled == false) continue;
                // Don't disable navigation buttons if we had them (Previous/Next)
                // But specifically creation/edit buttons
                if (btn.Content is string s && (s.Contains("?") || s.Contains("???") || s.Contains("Calculer") || s.Contains("GÈnÈrer")))
                {
                    btn.IsEnabled = !isReadOnly;
                }
            }
        }

        private IEnumerable<T> FindVisualChildren<T>(DependencyObject? depObj) where T : DependencyObject
        {
            if (depObj != null)
            {
                for (int i = 0; i < VisualTreeHelper.GetChildrenCount(depObj); i++)
                {
                    DependencyObject child = VisualTreeHelper.GetChild(depObj, i);
                    if (child != null)
                    {
                        if (child is T t)
                        {
                            yield return t;
                        }

                        foreach (T childOfChild in FindVisualChildren<T>(child))
                        {
                            yield return childOfChild;
                        }
                    }
                }
            }
        }
// ...
// (Warning: Need to target specific chunks separately or use multi_replace. Using multi_replace logic with separate chunks in one call? No, replace_file_content is one block. I will do separate calls or use multi_replace.)

// I will use multi_replace for this to save steps.

        private void DomainComboBox_SelectionChanged(object sender, System.Windows.Controls.SelectionChangedEventArgs e)
        {
            if (DomainComboBox.SelectedItem is ScientificDomain domain)
            {
                if (domain != ScientificDomain.Biomedical)
                {
                    DesignPrecisionLabel.Text = "Type de Design SpÈcifique";
                }
                else
                {
                    DesignPrecisionLabel.Text = "PrÈcision du Devis (MÈthodologie)";
                }
                
                // Refresh Audit
                if (StudyTypeComboBox != null) UpdateQualityGuidelines((StudyType)StudyTypeComboBox.SelectedItem);
            }
        }

        private void ProcessAuthors(string authorsCsv)
        {
            if (string.IsNullOrWhiteSpace(authorsCsv)) return;
            var names = authorsCsv.Split(new[] { ',' }, System.StringSplitOptions.RemoveEmptyEntries);
            foreach (var name in names)
            {
                var trimmed = name.Trim();
                if (string.IsNullOrEmpty(trimmed)) continue;
                
                var parts = trimmed.Split(' ');
                string first = parts[0];
                string last = parts.Length > 1 ? string.Join(" ", parts.Skip(1)) : "";

                _tempCoAuthors.Add(new AdRev.Domain.Models.Author 
                { 
                    FirstName = first, 
                    LastName = last,
                    Institution = _project?.Institution ?? ""
                });
            }
        }

        private void OpenVariableDesigner_Click(object sender, RoutedEventArgs e)
        {
            bool isQualitativeDeductive = false;
            
            if (StudyTypeComboBox.SelectedItem is StudyType st && (st == StudyType.Qualitative || st == StudyType.Mixed))
            {
                if (QualitativeApproachComboBox.SelectedItem is QualitativeApproach qa && qa == QualitativeApproach.Deductive)
                {
                    isQualitativeDeductive = true;
                }
            }

            var designer = new VariableDesignerWindow(_tempVariables, TitleTextBox.Text, isQualitativeDeductive);
            if (designer.ShowDialog() == true)
            {
                // Mise ‡ jour de la liste avec les nouvelles donnÈes
                _tempVariables = new System.Collections.Generic.List<AdRev.Domain.Variables.StudyVariable>(designer.Variables);
                MessageBox.Show($"{_tempVariables.Count} variables dÈfinies avec succËs.", "Variables SauvegardÈes", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }

        private void StudyTypeComboBox_SelectionChanged(object sender, System.Windows.Controls.SelectionChangedEventArgs e)
        {
            if (EpidemiologyTypePanel == null) return;

            var selected = (StudyType)StudyTypeComboBox.SelectedItem;
            
            // Reset to default (hidden)
            if (EpidemiologyTypePanel != null) EpidemiologyTypePanel.Visibility = Visibility.Collapsed;
            if (QualitativeTypePanel != null) QualitativeTypePanel.Visibility = Visibility.Collapsed;

            if (selected == StudyType.Quantitative)
            {
                if (EpidemiologyTypePanel != null) EpidemiologyTypePanel.Visibility = Visibility.Visible;
            }
            else if (selected == StudyType.Qualitative)
            {
                if (QualitativeTypePanel != null) QualitativeTypePanel.Visibility = Visibility.Visible;
                
                // Clear Quantitative inputs
                EpidemiologyTypeComboBox.SelectedIndex = 0; 
                if (PanelCochran != null) PanelCochran.Visibility = Visibility.Collapsed;
                if (PanelComparison != null) PanelComparison.Visibility = Visibility.Collapsed;
                if (CalculatorSelector != null) SelectCalculator("None");
            }
            else if (selected == StudyType.Mixed)
            {
                if (EpidemiologyTypePanel != null) EpidemiologyTypePanel.Visibility = Visibility.Visible;
                if (QualitativeTypePanel != null) QualitativeTypePanel.Visibility = Visibility.Visible;
            }

            UpdateSamplingTypes(selected);
            UpdateQualityGuidelines(selected);
        }

        // --- Logic Objectifs (Auto-Numbering & Validation) ---

        private void ObjectiveTextBox_PreviewKeyDown(object sender, KeyEventArgs e)
        {
            if (e.Key == Key.Enter)
            {
                var textBox = sender as System.Windows.Controls.TextBox;
                if (textBox == null) return;

                string? prefixType = textBox.Tag as string; // "OG" ou "OS"
                if (string.IsNullOrEmpty(prefixType)) return;

                // Grab current line to infer context
                int caretIndex = textBox.CaretIndex;
                int lineIndex = textBox.GetLineIndexFromCharacterIndex(caretIndex);
                string currentLineText = textBox.GetLineText(lineIndex).Trim();

                string nextPrefix = "";

                if (prefixType == "OS")
                {
                    // Advanced OS logic: Try to parse "OSx.y" from PREVIOUS line if current is empty?
                    // Or parse CURRENT line if user types "OS1.1: content[ENTER]"
                    
                    // Regex capture: OS(\d+)\.(\d+)
                    var match = System.Text.RegularExpressions.Regex.Match(currentLineText, @"OS(\d+)\.(\d+)");
                    if (match.Success)
                    {
                        int group = int.Parse(match.Groups[1].Value);
                        int sub = int.Parse(match.Groups[2].Value);
                        nextPrefix = $"OS{group}.{sub + 1}: ";
                    }
                    else
                    {
                        // Fallback: Check lines ABOVE for valid OSx.y or --- OGx ---
                        // This scan up helps if we just pressed enter on an empty line
                        for (int i = lineIndex - 1; i >= 0; i--)
                        {
                            string l = textBox.GetLineText(i).Trim();
                            var mUp = System.Text.RegularExpressions.Regex.Match(l, @"OS(\d+)\.(\d+)");
                            if (mUp.Success)
                            {
                                int g = int.Parse(mUp.Groups[1].Value);
                                int s = int.Parse(mUp.Groups[2].Value);
                                nextPrefix = $"OS{g}.{s + 1}: ";
                                break;
                            }
                            // Detect Header "--- Pour OG2"
                            // If we hit a header, restart at x.1
                            var mHead = System.Text.RegularExpressions.Regex.Match(l, @"Pour.*(?:OG|Objectif)\s*(\d+)");
                            if (mHead.Success)
                            {
                                int g = int.Parse(mHead.Groups[1].Value);
                                nextPrefix = $"OS{g}.1: ";
                                break;
                            }
                        }
                    }

                    // Worst case fallback
                    if (string.IsNullOrEmpty(nextPrefix))
                    {
                         // Count total lines starting with OS
                         int count = textBox.Text.Split('\n').Count(l => l.Trim().StartsWith("OS"));
                         nextPrefix = $"OS{count + 1}: "; 
                    }
                }
                else // OG
                {
                    // Standard linear logic for OG
                    int count = 0;
                    var lines = textBox.Text.Split('\n');
                    foreach(var line in lines) if (line.Trim().StartsWith("OG")) count++;
                    nextPrefix = $"OG{count + 1}: ";
                }

                e.Handled = true;
                string insertion = $"\n{nextPrefix}";
                
                // Safe insertion at caret
                int insPoint = textBox.CaretIndex;
                textBox.Text = textBox.Text.Insert(insPoint, insertion);
                textBox.CaretIndex = insPoint + insertion.Length;
            }
        }

        private void GeneralObjectiveTextBox_TextChanged(object sender, System.Windows.Controls.TextChangedEventArgs e)
        {
            if (OGCountAlert == null || OGBloomAlert == null) return;
            
            var text = GeneralObjectiveTextBox.Text;
            var lines = text.Split(new[] { '\r', '\n' }, System.StringSplitOptions.RemoveEmptyEntries);
            int ogCount = lines.Count(l => l.Trim().StartsWith("OG"));

            // 1. Validation nombre
            OGCountAlert.Visibility = ogCount > 3 ? Visibility.Visible : Visibility.Collapsed;

            // 2. Validation Bloom
            // Simple check: check if any line starts with a Bloom verb (after prefix)
            bool validBloom = lines.Length == 0 || lines.Any(l => CheckBloomVerb(l, "OG"));
            // For OGs, we want ALL to be valid generally, or at least one. Let's start with loose "at least one valid"
            // Or stricter: "Any line starting with OG must have a bloom verb"
            
            bool anyInvalid = false;
            foreach(var line in lines)
            {
                if (line.Trim().StartsWith("OG") && !CheckBloomVerb(line, "OG"))
                {
                    anyInvalid = true;
                    break;
                }
            }
            OGBloomAlert.Visibility = anyInvalid ? Visibility.Visible : Visibility.Collapsed;
            
            // Suggest verbs for OS based on OG (if any valid OG found)
            SuggestOSVerbs(text);
        }

        private void SpecificObjectivesTextBox_TextChanged(object sender, System.Windows.Controls.TextChangedEventArgs e)
        {
             if (OSCountAlert == null || OSBloomAlert == null) return;
            
            var text = SpecificObjectivesTextBox.Text;
            var lines = text.Split(new[] { '\r', '\n' }, System.StringSplitOptions.RemoveEmptyEntries);
            
            // 1. Validation structurÈe (Max 4 par OG)
            // On regroupe par "OSx"
            var groups = lines.Where(l => l.Trim().StartsWith("OS"))
                              .GroupBy(l => l.Trim().Split('.')[0]) // Groupe par "OS1", "OS2"...
                              .ToDictionary(g => g.Key, g => g.Count());
            
            bool tooMany = false;
            string alertMsg = "";
            foreach(var kvp in groups)
            {
                if (kvp.Value > 4)
                {
                    tooMany = true;
                    alertMsg = $"?? Trop d'OS pour {kvp.Key} (Max 4). Actuel: {kvp.Value}";
                    break; 
                }
            }

            if (tooMany)
            {
                OSCountAlert.Text = alertMsg;
                OSCountAlert.Visibility = Visibility.Visible;
            }
            else
            {
                // check global ratio just in case structure isn't used
                int totalOS = lines.Count(l => l.Trim().StartsWith("OS"));
                int ogCount = GeneralObjectiveTextBox.Text.Split(new[] { '\r', '\n' }, System.StringSplitOptions.RemoveEmptyEntries).Count(l => l.Trim().StartsWith("OG"));
                if (ogCount == 0) ogCount = 1;
                
                if (totalOS > ogCount * 4) 
                {
                     OSCountAlert.Text = "?? Attention : Titre global > 4 OS par OG.";
                     OSCountAlert.Visibility = Visibility.Visible;
                }
                else
                {
                    OSCountAlert.Visibility = Visibility.Collapsed;
                }
            }

             // 2. Bloom
            bool anyInvalid = false;
            foreach(var line in lines)
            {
                if (line.Trim().StartsWith("OS") && !CheckBloomVerb(line, "OS"))
                {
                    anyInvalid = true;
                    break;
                }
            }
            OSBloomAlert.Visibility = anyInvalid ? Visibility.Visible : Visibility.Collapsed;
        }

        private void RenumberOS_Click(object sender, RoutedEventArgs e)
        {
            var text = SpecificObjectivesTextBox.Text;
            if (string.IsNullOrWhiteSpace(text)) return;

            var lines = text.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
            var sb = new System.Text.StringBuilder();

            int currentGroup = 1; // Default
            int currentSub = 1;

            foreach(var line in lines)
            {
                string l = line.Trim();

                // Detect Separator/Header (set via LinkOSToOG or manual)
                if (l.StartsWith("---") || l.Contains("OG"))
                {
                    // Attempt to parse group ID from header (e.g. "Pour OG2")
                    var m = System.Text.RegularExpressions.Regex.Match(l, @"(\d+)");
                    if (m.Success) currentGroup = int.Parse(m.Value);
                    
                    currentSub = 1; // Reset sub index
                    sb.AppendLine(l); // Keep header
                    continue;
                }

                // Detect OS Content
                if (l.StartsWith("OS"))
                {
                    // Strip old prefix (OS x.y : content)
                    // Regex: ^OS\d+(\.\d+)?:?\s*(.*)
                    var mContent = System.Text.RegularExpressions.Regex.Match(l, @"^OS[\d\.]+[:\s]*(.*)");
                    string content = mContent.Success ? mContent.Groups[1].Value : l;
                    
                    if (string.IsNullOrWhiteSpace(content)) continue; // skip empty bullets

                    sb.AppendLine($"OS{currentGroup}.{currentSub}: {content}");
                    currentSub++;
                }
                else
                {
                    // Other text or pure content logic? 
                    // Assume it belongs to previous bullet or is a new one?
                    // Treat as new bullet for now to be safe
                     sb.AppendLine($"OS{currentGroup}.{currentSub}: {l}");
                     currentSub++;
                }
            }
            
            SpecificObjectivesTextBox.Text = sb.ToString();
        }
        
        private void LinkOSToOG_Click(object sender, RoutedEventArgs e)
        {
             // Helper: Read OGs and scaffold OS structure
             var ogText = GeneralObjectiveTextBox.Text;
             var ogLines = ogText.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries)
                                 .Where(l => l.Trim().StartsWith("OG"))
                                 .ToList();
             
             if (ogLines.Count == 0)
             {
                 MessageBox.Show("Veuillez d'abord dÈfinir au moins un Objectif GÈnÈral (OG1...).");
                 return;
             }
             
             var sb = new System.Text.StringBuilder();
             // Preserve existing content if it looks structured, otherwise clear? 
             // Let's just append or replace if empty/default
             
             if (SpecificObjectivesTextBox.Text.Length < 10) // "OS1: " is default
             {
                 int i = 1;
                 foreach(var og in ogLines)
                 {
                     sb.AppendLine($"--- Pour {og.Trim().Split(':')[0]} ---");
                     sb.AppendLine($"OS{i}.1: ");
                     sb.AppendLine($"OS{i}.2: ");
                     sb.AppendLine();
                     i++;
                 }
                 SpecificObjectivesTextBox.Text = sb.ToString();
             }
             else
             {
                 if (MessageBox.Show("Voulez-vous reformater la zone d'objectifs spÈcifiques ? Cela ajoutera une structure basÈe sur vos OG.", "Reformater", MessageBoxButton.YesNo) == MessageBoxResult.Yes)
                 {
                     int i = 1;
                     foreach(var og in ogLines)
                     {
                         sb.AppendLine($"--- Pour {og.Trim().Split(':')[0]} ---");
                         sb.AppendLine($"OS{i}.1: ");
                         sb.AppendLine($"OS{i}.2: ");
                         i++;
                     }
                     // Append old text at bottom for reference?
                     sb.AppendLine();
                     sb.AppendLine("--- Ancien contenu ---");
                     sb.AppendLine(SpecificObjectivesTextBox.Text);
                     SpecificObjectivesTextBox.Text = sb.ToString(); 
                 }
             }
        }


        private bool CheckBloomVerb(string line, string type)
        {
            // Remove prefix "OG1: "
            int colonIndex = line.IndexOf(':');
            string content = colonIndex >= 0 ? line.Substring(colonIndex + 1).Trim() : line.Trim();
            
            if (string.IsNullOrWhiteSpace(content)) return true; // Ignore empty

            var firstWord = content.Split(' ')[0].ToLower();
            
            // Bloom Lists (Simplified & Expanded for Quali)
            var bloomGeneral = new[] { "Èvaluer", "analyser", "dÈterminer", "Ètudier", "comparer", "identifier", "comprendre", "explorer", "illustrer", "dÈcrire" };
            var bloomSpecific = new[] { "calculer", "lister", "dÈfinir", "citer", "nommer", "classer", "estimer", "quantifier", "vÈrifier", "interprÈter", "caractÈriser" };
            
            // Merge for broad check, or specific
            var allBloom = bloomGeneral.Concat(bloomSpecific).ToArray();
            
            // Sophisticated check could stem the word, here strict match or startsWith
            return allBloom.Any(v => firstWord.StartsWith(v));
        }

        private void SuggestOSVerbs(string ogText)
        {
            if (OSSuggestions == null) return;
            
            string suggestions = "?? Verbes suggÈrÈs : ";
            
            if (ogText.ToLower().Contains("comparer"))
                suggestions += "DÈcrire (groupes), Mesurer (diffÈrences), Tester (hypothËse)...";
            else if (ogText.ToLower().Contains("Èvaluer"))
                suggestions += "Estimer, Calculer, Identifier (facteurs)...";
            else if (ogText.ToLower().Contains("dÈcrire"))
                suggestions += "Lister, CaractÈriser, Classifier...";
            else
                suggestions += "Quantifier, VÈrifier, DÈterminer...";

            OSSuggestions.Text = suggestions;
            OSSuggestions.Visibility = Visibility.Visible;
        }

        private void UpdateQualityGuidelines(StudyType studyType)
        {
            if (PanelQualityGuidelines == null) return;
            
            // Reconstruit le protocole actuel pour l'Èvaluation
            var currentProtocol = BuildProtocolFromUI();

            // Temporary project object to leverage the service selection logic
            var dummyProject = new AdRev.Domain.Models.ResearchProject 
            { 
                StudyType = studyType,
                Domain = DomainComboBox.SelectedItem != null ? (ScientificDomain)DomainComboBox.SelectedItem : ScientificDomain.Biomedical,
                EpidemiologyType = EpidemiologyTypeComboBox.SelectedItem != null ? (EpidemiologicalStudyType)EpidemiologyTypeComboBox.SelectedItem : EpidemiologicalStudyType.CrossSectionalDescriptive
            };
            var checklists = _qualityService.GetRecommendedChecklists(dummyProject);

            if (checklists == null || checklists.Count == 0)
            {
                PanelQualityGuidelines.Visibility = Visibility.Collapsed;
                return;
            }

            // Take the first recommended checklist (primary)
            var primaryChecklist = checklists.First();
            
            // …valuation automatique
            _qualityService.EvaluateProtocol(primaryChecklist, currentProtocol);

            QualityStandardName.Text = $"({primaryChecklist.Name})";
            QualityGuidelinesList.Children.Clear();

            foreach (var section in primaryChecklist.Sections)
            {
                var txtSection = new System.Windows.Controls.TextBlock 
                { 
                    Text = section.Name, 
                    FontWeight = FontWeights.Bold, 
                    Margin = new Thickness(0, 10, 0, 5),
                    Foreground = (Brush)Application.Current.Resources["PrimaryBrush"]
                };
                QualityGuidelinesList.Children.Add(txtSection);

                foreach (var item in section.Items)
                {
                    var cb = new System.Windows.Controls.CheckBox 
                    { 
                        Content = new System.Windows.Controls.TextBlock { Text = item.Requirement, TextWrapping = TextWrapping.Wrap },
                        Margin = new Thickness(10, 0, 0, 5),
                        IsChecked = item.IsMet,
                        ToolTip = item.IsMet ? "CritËre automatiquement validÈ par le contenu saisi" : "Ce critËre ne semble pas encore rempli"
                    };
                    QualityGuidelinesList.Children.Add(cb);
                }
            }

            PanelQualityGuidelines.Visibility = Visibility.Visible;
        }

        private void UpdateSamplingTypes(StudyType studyType)
        {
            if (SamplingTypeComboBox == null) return;

            var allSamplingTypes = System.Enum.GetValues(typeof(SamplingType)).Cast<SamplingType>().ToList();
            List<SamplingType> filteredTypes;

            switch (studyType)
            {
                case StudyType.Quantitative:
                    filteredTypes = allSamplingTypes.Where(t => 
                        t == SamplingType.SimpleRandom || 
                        t == SamplingType.Systematic || 
                        t == SamplingType.Stratified || 
                        t == SamplingType.ClusterSampling || 
                        t == SamplingType.MultiStage || 
                        t == SamplingType.StratifiedCluster ||
                        t == SamplingType.Census ||
                        t == SamplingType.Convenience ||
                        t == SamplingType.None
                    ).ToList();
                    break;

                case StudyType.Qualitative:
                    filteredTypes = allSamplingTypes.Where(t => 
                        t == SamplingType.Purposive || 
                        t == SamplingType.Snowball || 
                        t == SamplingType.Quota || 
                        t == SamplingType.Convenience || 
                        t == SamplingType.Theoretical ||
                        t == SamplingType.None
                    ).ToList();
                    break;

                case StudyType.Mixed:
                default:
                    filteredTypes = allSamplingTypes;
                    break;
            }

            SamplingTypeComboBox.ItemsSource = filteredTypes;
            SamplingTypeComboBox.SelectedIndex = 0;
        }

        private void EpidemiologyTypeComboBox_SelectionChanged(object sender, System.Windows.Controls.SelectionChangedEventArgs e)
        {
            if (CalculatorSelector == null) return;

            var epiType = (EpidemiologicalStudyType)EpidemiologyTypeComboBox.SelectedItem;
            
            // Suggest calculator based on study type (does not enforce, just selects)
            switch (epiType)
            {
                case EpidemiologicalStudyType.CrossSectionalDescriptive:
                case EpidemiologicalStudyType.Ecological:
                    SelectCalculator("Cochran");
                    break;

                case EpidemiologicalStudyType.LongitudinalIncidence:
                case EpidemiologicalStudyType.CohortProspective:
                case EpidemiologicalStudyType.CohortRetrospective:
                case EpidemiologicalStudyType.CaseControl:
                case EpidemiologicalStudyType.RandomizedControlledTrial:
                case EpidemiologicalStudyType.QuasiExperimental:
                case EpidemiologicalStudyType.BeforeAfterStudy:
                    SelectCalculator("Comparison");
                    break;
                
                default:
                    SelectCalculator("None");
                    break;
            }

            // Refresh Quality Audit (e.g. switch to CONSORT if RCT is selected)
            if (StudyTypeComboBox != null) UpdateQualityGuidelines((StudyType)StudyTypeComboBox.SelectedItem);
        }

        private void SelectCalculator(string tag)
        {
            foreach (System.Windows.Controls.ComboBoxItem item in CalculatorSelector.Items)
            {
                if (item.Tag.ToString() == tag)
                {
                    CalculatorSelector.SelectedItem = item;
                    break;
                }
            }
        }

        private void CalculatorSelector_SelectionChanged(object sender, System.Windows.Controls.SelectionChangedEventArgs e)
        {
            if (PanelCochran == null || PanelComparison == null) return;
            
            PanelCochran.Visibility = Visibility.Collapsed;
            PanelComparison.Visibility = Visibility.Collapsed;

            if (CalculatorSelector.SelectedItem is System.Windows.Controls.ComboBoxItem item)
            {
                string? tag = item.Tag?.ToString();
                if (tag == "Cochran") PanelCochran.Visibility = Visibility.Visible;
                else if (tag == "Comparison") PanelComparison.Visibility = Visibility.Visible;
            }
        }

        private void CalculateCochran_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                double p = double.Parse(Calc_Cochran_P.Text) / 100.0;
                double d = double.Parse(Calc_Cochran_D.Text) / 100.0;
                
                // Population Totale (Schwartz)
                double N_pop = 0;
                if (!string.IsNullOrWhiteSpace(Calc_Cochran_N.Text))
                {
                    double.TryParse(Calc_Cochran_N.Text, out N_pop);
                }

                var selectedItem = (System.Windows.Controls.ComboBoxItem)Calc_Cochran_Z.SelectedItem;
                double z = double.Parse(selectedItem.Tag?.ToString() ?? "1.96", System.Globalization.CultureInfo.InvariantCulture);

                // 1. Calcul de base (Cochran / Population Infinie)
                // n0 = (Z≤ * p * q) / d≤
                double n0 = (Math.Pow(z, 2) * p * (1 - p)) / Math.Pow(d, 2);
                
                double nFinal = n0;
                string formulaUsed = "Cochran (population infinie)";

                // 2. Correction si Population Finie (Schwartz)
                if (N_pop > 0)
                {
                    // n = n0 / (1 + (n0 - 1) / N)
                    nFinal = n0 / (1 + ((n0 - 1) / N_pop));
                    formulaUsed = $"Schwartz (population finie N={N_pop})";
                }

                int nCeiling = (int)Math.Ceiling(nFinal);

                ResultCochran.Text = $"N requis = {nCeiling} sujets";
                
                // Injection
                SamplingTextBox.Text = $"La taille d'Èchantillon minimal a ÈtÈ calculÈe selon la formule de {formulaUsed}. " +
                                       $"Avec une prÈvalence attendue de {p*100}%, une marge d'erreur de {d*100}% et un niveau de confiance de 95% (Z={z}), " +
                                       $"le nombre de sujets requis est de {nCeiling}.";
            }
            catch { MessageBox.Show("VÈrifiez vos valeurs numÈriques (utilisez des points ou virgules)."); }
        }

        private void CalculateComparison_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                double p1 = double.Parse(Calc_Comp_P1.Text) / 100.0;
                double p2 = double.Parse(Calc_Comp_P2.Text) / 100.0;
                
                var itemAlpha = (System.Windows.Controls.ComboBoxItem)Calc_Comp_Alpha.SelectedItem;
                double zAlpha = double.Parse(itemAlpha.Tag?.ToString() ?? "1.96", System.Globalization.CultureInfo.InvariantCulture); 
                
                var itemBeta = (System.Windows.Controls.ComboBoxItem)Calc_Comp_Power.SelectedItem;
                double zBeta = double.Parse(itemBeta.Tag?.ToString() ?? "1.28", System.Globalization.CultureInfo.InvariantCulture);

                bool isMatched = Chk_Matched.IsChecked == true;
                double nFinal = 0;
                string resultText = "";
                string formulaDesc = "";

                if (!isMatched)
                {
                    // --- IND…PENDANTS (Formule Classique Fleiss/Casalegno) ---
                    // n = [ (Zalpha + Zbeta)≤ * (p1(1-p1) + p2(1-p2)) ] / (p1 - p2)≤
                    double numerator = Math.Pow(zAlpha + zBeta, 2) * ( (p1*(1-p1)) + (p2*(1-p2)) );
                    double denominator = Math.Pow(p1 - p2, 2);
                    
                    if (denominator == 0) { MessageBox.Show("P1 et P2 ne peuvent pas Ítre identiques."); return; }

                    nFinal = Math.Ceiling(numerator / denominator);
                    resultText = $"N = {nFinal} par groupe (Total: {nFinal*2})";
                    formulaDesc = $"comparaison de proportions (groupes indÈpendants)";
                     
                    SamplingTextBox.Text = $"Pour mettre en Èvidence une diffÈrence entre P1={Calc_Comp_P1.Text}% et P2={Calc_Comp_P2.Text}% " +
                                           $"avec une puissance de {(itemBeta.Content?.ToString()?.Contains("80") == true ? "80" : "90")}% et un risque alpha de 5%, " +
                                           $"la taille d'Èchantillon requise est de {nFinal} sujets par groupe (Total: {nFinal*2}).";
                }
                else
                {
                    // --- APPARI…S (Formule Connor / Schlesselman pour Paires) ---
                    // N_pairs = [ (Zalpha + Zbeta)≤ * ( p1(1-p1) + p2(1-p2) - 2*phi*sqrt(...) ) ] / (p1 - p2)≤
                    // phi (correlation) implicite approx 0.2 pour design appariÈ standard
                    double phi = 0.2; 
                    
                    double term1 = p1 * (1 - p1);
                    double term2 = p2 * (1 - p2);
                    double termCorr = 2 * phi * Math.Sqrt(term1 * term2);
                    
                    double numerator = Math.Pow(zAlpha + zBeta, 2) * (term1 + term2 - termCorr); // Moins de variance car correlation
                    double denominator = Math.Pow(p1 - p2, 2);

                    if (denominator == 0) { MessageBox.Show("P1 et P2 ne peuvent pas Ítre identiques."); return; }

                    nFinal = Math.Ceiling(numerator / denominator);
                    resultText = $"N = {nFinal} PAIRES (Total sujets: {nFinal*2})";
                    formulaDesc = $"comparaison de proportions APPARI…ES (McNemar/Connor, corrÈlation estimÈe 0.2)";

                    SamplingTextBox.Text = $"S'agissant d'une Ètude appariÈe (Matched Case-Control), la formule utilisÈe prend en compte la corrÈlation intra-paire. " +
                                           $"Avec P1={Calc_Comp_P1.Text}% et P2={Calc_Comp_P2.Text}%, " +
                                           $"il est nÈcessaire d'inclure {nFinal} PAIRES de sujets (soit {nFinal} Cas et {nFinal} TÈmoins).";
                }

                ResultComparison.Text = resultText;
            }
            catch { MessageBox.Show("Erreur de calcul. VÈrifiez les entrÈes."); }
        }

        private void AddCoAuthor_Click(object sender, RoutedEventArgs e)
        {
            if (string.IsNullOrWhiteSpace(CoAuthLast.Text) || string.IsNullOrWhiteSpace(CoAuthFirst.Text))
            {
                MessageBox.Show("Veuillez au moins entrer un Nom et un PrÈnom.", "Info", MessageBoxButton.OK, MessageBoxImage.Information);
                return;
            }

            var author = new AdRev.Domain.Models.Author
            {
                FirstName = CoAuthFirst.Text,
                LastName = CoAuthLast.Text,
                Institution = CoAuthInst.Text,
                Title = "Co-Aut.", 
                Email = CoAuthEmail.Text
            };

            _tempCoAuthors.Add(author);

            // Reset fields
            CoAuthFirst.Text = "";
            CoAuthLast.Text = "";
            CoAuthInst.Text = "";
            CoAuthEmail.Text = "";
            CoAuthFirst.Focus();
        }

        private void RemoveCoAuthor_Click(object sender, RoutedEventArgs e)
        {
            if (CoAuthorsListBox.SelectedItem is AdRev.Domain.Models.Author selected)
            {
                _tempCoAuthors.Remove(selected);
            }
        }

        // Gestionnaires pour les Ètudes multicentriques
        private void IsMulticentricCheckBox_Checked(object sender, RoutedEventArgs e)
        {
            if (MulticentricDetailsPanel != null)
                MulticentricDetailsPanel.Visibility = Visibility.Visible;
        }

        private void IsMulticentricCheckBox_Unchecked(object sender, RoutedEventArgs e)
        {
            if (MulticentricDetailsPanel != null)
                MulticentricDetailsPanel.Visibility = Visibility.Collapsed;
        }

        // Gestionnaires pour l'Èchantillonnage avancÈ
        private void SamplingTypeComboBox_SelectionChanged(object sender, System.Windows.Controls.SelectionChangedEventArgs e)
        {
            if (StratificationPanel == null || ClusterPanel == null) return;

            var samplingType = (SamplingType)SamplingTypeComboBox.SelectedItem;
            
            // RÈinitialiser tous les panneaux
            StratificationPanel.Visibility = Visibility.Collapsed;
            ClusterPanel.Visibility = Visibility.Collapsed;

            switch (samplingType)
            {
                case SamplingType.Stratified:
                case SamplingType.StratifiedCluster:
                    StratificationPanel.Visibility = Visibility.Visible;
                    if (samplingType == SamplingType.StratifiedCluster)
                        ClusterPanel.Visibility = Visibility.Visible;
                    break;

                case SamplingType.ClusterSampling:
                case SamplingType.MultiStage:
                    ClusterPanel.Visibility = Visibility.Visible;
                    break;
            }
        }

        private void IsStratifiedCheckBox_Checked(object sender, RoutedEventArgs e)
        {
            if (StratificationDetailsPanel != null)
                StratificationDetailsPanel.Visibility = Visibility.Visible;
        }

        private void IsStratifiedCheckBox_Unchecked(object sender, RoutedEventArgs e)
        {
            if (StratificationDetailsPanel != null)
                StratificationDetailsPanel.Visibility = Visibility.Collapsed;
        }

        private void GenerateProtocolPlan_Click(object sender, RoutedEventArgs e)
        {
            // 1. Get Objectives
            string specObjs = SpecificObjectivesTextBox.Text;
            if (string.IsNullOrWhiteSpace(specObjs))
            {
                MessageBox.Show("Veuillez d'abord dÈfinir vos Objectifs SpÈcifiques (…tape 2).");
                return;
            }

            var studyType = (StudyType)StudyTypeComboBox.SelectedItem;
            var textPlan = new System.Text.StringBuilder();

            if (studyType == StudyType.Qualitative)
            {
                GenerateThematicAnalysisPlan(textPlan, specObjs);
            }
            else
            {
                GenerateStatisticalAnalysisPlan(textPlan, specObjs);
            }

            DataAnalysisTextBox.Text = textPlan.ToString();
            
            string msg = studyType == StudyType.Qualitative 
                ? "Plan d'Analyse ThÈmatique (Cadre de Braun & Clarke) gÈnÈrÈ avec succËs !" 
                : "Plan d'Analyse Statistique (SAP) gÈnÈrÈ avec succËs !";
                
            MessageBox.Show(msg + " Vous pouvez maintenant l'adapter.", "GÈnÈration TerminÈe");
        }

        private void GenerateThematicAnalysisPlan(System.Text.StringBuilder sb, string specObjs)
        {
            sb.AppendLine("PLAN D'ANALYSE TH…MATIQUE (TAP)");
            sb.AppendLine("Cadre de rÈfÈrence : Braun & Clarke (2006)");
            sb.AppendLine("==============================================");
            sb.AppendLine();
            sb.AppendLine("L'analyse sera menÈe selon l'approche thÈmatique rÈflexive de Braun & Clarke, suivant un processus rÈcursif en 6 Ètapes :");
            sb.AppendLine();
            sb.AppendLine("1. FAMILIARISATION AVEC LES DONN…ES");
            sb.AppendLine("   - Transcription intÈgrale des entretiens/focus groups.");
            sb.AppendLine("   - Lectures rÈpÈtÈes et prise de notes initiales pour s'imprÈgner du corpus.");
            sb.AppendLine();
            sb.AppendLine("2. CODAGE INITIAL");
            sb.AppendLine("   - Identification systÈmatique d'unitÈs de sens ‡ travers tout le corpus.");
            sb.AppendLine("   - Attribution de codes sÈmantiques ou latents aux segments de texte pertinents.");
            sb.AppendLine();
            sb.AppendLine("3. RECHERCHE DE TH»MES");
            sb.AppendLine("   - Regroupement des codes en thËmes candidats plus larges.");
            sb.AppendLine("   - Organisation des relations entre les codes et les thËmes.");
            sb.AppendLine();
            sb.AppendLine("4. REVUE DES TH»MES");
            sb.AppendLine("   - VÈrification de la cohÈrence des thËmes par rapport aux codes extraits.");
            sb.AppendLine("   - Raffinement de la 'carte thÈmatique' pour s'assurer qu'elle reflËte fidËlement le corpus.");
            sb.AppendLine();
            sb.AppendLine("5. D…FINITION ET NOMMAGE DES TH»MES");
            sb.AppendLine("   - Analyse approfondie de chaque thËme pour en extraire l'essence (le 'coeur' du thËme).");
            sb.AppendLine("   - Attribution de noms concis et explicites pour chaque catÈgorie finale.");
            sb.AppendLine();
            sb.AppendLine("6. PRODUCTION DU RAPPORT");
            sb.AppendLine("   - SÈlection des verbatims les plus illustratifs pour chaque thËme.");
            sb.AppendLine("   - Liaison des thËmes avec la question de recherche et la littÈrature existante.");
            sb.AppendLine();
            sb.AppendLine("--- ANALYSES SP…CIFIQUES ---");

            var lines = specObjs.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
            int idx = 1;
            foreach (var line in lines)
            {
                var l = line.Trim();
                if (string.IsNullOrWhiteSpace(l) || l.StartsWith("OS")) continue;

                sb.AppendLine($"{idx}. Pour l'objectif : \"{l}\"");
                sb.AppendLine("   -> L'analyse thÈmatique cherchera ‡ explorer les reprÈsentations et les expÈriences liÈes ‡ ce point spÈcifique.");
                idx++;
            }
        }

        private void GenerateStatisticalAnalysisPlan(System.Text.StringBuilder textPlan, string specObjs)
        {
            textPlan.AppendLine("PLAN D'ANALYSE STATISTIQUE (SAP)");
            textPlan.AppendLine("==================================");
            
            // 2. Standard Descriptives
            textPlan.AppendLine("1. ANALYSE DESCRIPTIVE");
            textPlan.AppendLine("- Variables Qualitatives : FrÈquences et Pourcentages.");
            textPlan.AppendLine("- Variables Quantitatives : Moyenne +/- Ecart-Type (si distribution normale) ou MÈdiane (IQR).");
            textPlan.AppendLine();

            // 3. Parse and Map Objectives
            textPlan.AppendLine("2. ANALYSES INFERENTIELLES (rÈpondant aux objectifs spÈcifiques)");
            
            var lines = specObjs.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
            int idx = 1;
            foreach(var line in lines)
            {
                var l = line.Trim();
                if (string.IsNullOrWhiteSpace(l) || l.StartsWith("OS")) continue;

                textPlan.AppendLine($"2.{idx} Pour l'objectif : \"{l}\"");
                
                string lower = l.ToLower();
                if (lower.Contains("comparer") || lower.Contains("diffÈrence"))
                {
                    textPlan.AppendLine("   -> Test suggÈrÈ : Comparaison de Moyennes (T-Test) ou ANOVA.");
                    textPlan.AppendLine("   -> Variables : Variable Groupe (X) vs Variable DÈpendante (Y).");
                }
                else if (lower.Contains("associer") || lower.Contains("lien") || lower.Contains("corrÈler") || lower.Contains("facteur"))
                {
                    textPlan.AppendLine("   -> Test suggÈrÈ : Test du Chi2 (Quali vs Quali) ou CorrÈlation (Quanti vs Quanti).");
                }
                else if (lower.Contains("dÈterminer") || lower.Contains("prÈvalence") || lower.Contains("dÈcrire"))
                {
                     textPlan.AppendLine("   -> Test suggÈrÈ : Estimation avec Intervalle de Confiance ‡ 95%.");
                }
                else
                {
                    textPlan.AppendLine("   -> Test suggÈrÈ : A dÈfinir selon la nature des variables.");
                }
                idx++;
            }
            
            textPlan.AppendLine();
            textPlan.AppendLine("3. SEUIL DE SIGNIFICATIVIT…");
            textPlan.AppendLine("- P-value < 0.05 considÈrÈe comme statistiquement significative.");
        }

        private void IsClusterCheckBox_Checked(object sender, RoutedEventArgs e)
        {
            if (ClusterDetailsPanel != null)
                ClusterDetailsPanel.Visibility = Visibility.Visible;
        }

        private void IsClusterCheckBox_Unchecked(object sender, RoutedEventArgs e)
        {
            if (ClusterDetailsPanel != null)
                ClusterDetailsPanel.Visibility = Visibility.Collapsed;
        }
        
        private readonly ProtocolValidator _validator = new ProtocolValidator();

        private void Minimize_Click(object sender, RoutedEventArgs e)
        {
            this.WindowState = WindowState.Minimized;
        }

        private void Close_Click(object sender, RoutedEventArgs e)
        {
            this.Close();
        }
        
        // Permettre le dÈplacement de la fenÍtre sans barre de titre
        protected override void OnMouseLeftButtonDown(MouseButtonEventArgs e)
        {
            base.OnMouseLeftButtonDown(e);
            this.DragMove();
        }

        private void GeneralObjective_LostFocus(object sender, RoutedEventArgs e)
        {
            // Auto-gÈnÈration des puces pour les objectifs spÈcifiques
            if (!string.IsNullOrWhiteSpace(GeneralObjectiveTextBox.Text) && string.IsNullOrWhiteSpace(SpecificObjectivesTextBox.Text))
            {
                var lines = GeneralObjectiveTextBox.Text.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries);
                int count = Math.Max(1, lines.Length);
                
                var builder = new System.Text.StringBuilder();
                for (int i = 0; i < count; i++)
                {
                    builder.AppendLine("ï [Objectif SpÈcifique 1]");
                    builder.AppendLine("ï [Objectif SpÈcifique 2]");
                    if (count > 1 && i < count - 1) builder.AppendLine("---");
                }
                SpecificObjectivesTextBox.Text = builder.ToString();
            }
        }

        private int _currentStep = 1;
        private const int TotalSteps = 14;

        private void NextSection_Click(object sender, RoutedEventArgs e)
        {
             if (_currentStep < TotalSteps)
             {
                 _currentStep++;
                 UpdateView();
             }
        }

        private void PrevSection_Click(object sender, RoutedEventArgs e)
        {
             if (_currentStep > 1)
             {
                 _currentStep--;
                 UpdateView();
             }
        }

        private void UpdateView()
        {
            // Reset all to Collapsed
            if (View_Step1 != null) View_Step1.Visibility = Visibility.Collapsed;
            if (View_Introduction != null) View_Introduction.Visibility = Visibility.Collapsed;
            if (View_Objectives != null) View_Objectives.Visibility = Visibility.Collapsed;
            if (View_Step3 != null) View_Step3.Visibility = Visibility.Collapsed;
            if (View_Methodology_Design != null) View_Methodology_Design.Visibility = Visibility.Collapsed;
            if (View_Methodology_Population != null) View_Methodology_Population.Visibility = Visibility.Collapsed;
            if (View_Methodology_Sampling != null) View_Methodology_Sampling.Visibility = Visibility.Collapsed;
            if (View_Methodology_Data != null) View_Methodology_Data.Visibility = Visibility.Collapsed;
            if (View_Budget != null) View_Budget.Visibility = Visibility.Collapsed;
            if (View_Step10 != null) View_Step10.Visibility = Visibility.Collapsed;
            if (View_DataAnalysis != null) View_DataAnalysis.Visibility = Visibility.Collapsed;
            if (View_Results != null) View_Results.Visibility = Visibility.Collapsed;
            if (View_Conclusion != null) View_Conclusion.Visibility = Visibility.Collapsed;
            if (View_References != null) View_References.Visibility = Visibility.Collapsed;

            // Sync Side Menu if needed (avoids loop if already selected)
            if (SideMenuListBox != null && SideMenuListBox.SelectedIndex != _currentStep - 1)
            {
                SideMenuListBox.SelectedIndex = _currentStep - 1;
            }

            // Show current
            switch (_currentStep)
            {
                case 1: if (View_Step1 != null) View_Step1.Visibility = Visibility.Visible; break;
                case 2: if (View_Introduction != null) View_Introduction.Visibility = Visibility.Visible; break;
                case 3: if (View_Objectives != null) View_Objectives.Visibility = Visibility.Visible; break;
                case 4: if (View_Step3 != null) View_Step3.Visibility = Visibility.Visible; break;
                case 5: 
                    if (View_Methodology_Design != null) View_Methodology_Design.Visibility = Visibility.Visible;
                    // Mise ‡ jour de l'audit qualitÈ ‡ l'affichage de l'Ètape
                    if (StudyTypeComboBox != null) UpdateQualityGuidelines((StudyType)StudyTypeComboBox.SelectedItem);
                    break;
                case 6: if (View_Methodology_Population != null) View_Methodology_Population.Visibility = Visibility.Visible; break;
                case 7: if (View_Methodology_Sampling != null) View_Methodology_Sampling.Visibility = Visibility.Visible; break;
                case 8: if (View_Methodology_Data != null) View_Methodology_Data.Visibility = Visibility.Visible; break;
                case 9: 
                    if (View_Budget != null) View_Budget.Visibility = Visibility.Visible; 
                    UpdateBudgetView();
                    break;
                case 10: if (View_Step10 != null) View_Step10.Visibility = Visibility.Visible; break;
                case 11: if (View_DataAnalysis != null) View_DataAnalysis.Visibility = Visibility.Visible; break;
                case 12: if (View_Results != null) View_Results.Visibility = Visibility.Visible; break;
                case 13: if (View_Conclusion != null) View_Conclusion.Visibility = Visibility.Visible; break;
                case 14: if (View_References != null) View_References.Visibility = Visibility.Visible; break;
            }

            // Set Read-Only based on step-linked access
            bool canEdit = CanUserEditStep(_currentStep);
            SetProtocolReadOnly(!canEdit);
        }

        private void UpdateBudgetView()
        {
            if (BudgetSuggestionType == null || BudgetSuggestionsText == null) return;

            var studyType = (StudyType)StudyTypeComboBox.SelectedItem;
            string suggestions = "";
            string typeDesc = "";

            if (studyType == StudyType.Qualitative)
            {
                typeDesc = "…tude Qualitative";
                suggestions = "ï …quipement d'enregistrement (Dictaphones, CamÈras)\n" +
                              "ï Frais de dÈplacement pour les entretiens (Focus Groups, IDI)\n" +
                              "ï Co˚ts de transcription et traduction\n" +
                              "ï Compensation des participants (collation, transport)\n" +
                              "ï Logiciel d'analyse (NVivo, Atlas.ti)...";
            }
            else if (studyType == StudyType.Quantitative)
            {
                typeDesc = "…tude Quantitative";
                suggestions = "ï Impression des questionnaires (papier) ou Tablettes (ODK/Kobo)\n" +
                              "ï Formation et Per diem des enquÍteurs\n" +
                              "ï Superviseurs de terrain\n" +
                              "ï Transport et Logistique de terrain\n" +
                              "ï Saisie et Nettoyage des donnÈes (Data Clerk)...";

                // Check intervention
                var epiType = (EpidemiologicalStudyType)EpidemiologyTypeComboBox.SelectedItem;
                if (epiType == EpidemiologicalStudyType.RandomizedControlledTrial || epiType == EpidemiologicalStudyType.QuasiExperimental)
                {
                    suggestions += "\n\nSpÈcifique Essai Clinique/Intervention :\n" +
                                   "ï Achat des produits/mÈdicaments\n" +
                                   "ï Assurance responsabilitÈ civile\n" +
                                   "ï Examens biologiques/cliniques de suivi...";
                }
            }
            else // Mixed
            {
                typeDesc = "M…THODE MIXTE";
                suggestions = "ï Combinaison des co˚ts Quantitatifs et Qualitatifs\n" +
                              "ï RÈunions de coordination pour l'intÈgration des donnÈes...";
            }

            BudgetSuggestionType.Text = $"({typeDesc})";
            BudgetSuggestionsText.Text = suggestions;
        }

        private void CreateProtocol_Click(object sender, RoutedEventArgs e)
        {
            ValidationMessagesListBox.Items.Clear();

            var protocol = BuildProtocolFromUI();

            var validationResult = _validator.Validate(protocol);

            // Affichage du score et des messages
            if (validationResult.Score == 100)
            {
                 ValidationMessagesListBox.Items.Add($"?? EXCELLENT TRAVAIL ! Score QualitÈ : 100/100");
                 ValidationMessagesListBox.Items.Add("Le protocole respecte tous les critËres de qualitÈ.");
            }
            else
            {
                ValidationMessagesListBox.Items.Add($"?? Score QualitÈ : {validationResult.Score}/100");
                
                foreach (var err in validationResult.Errors)
                    ValidationMessagesListBox.Items.Add(err);

                foreach (var sug in validationResult.Suggestions)
                    ValidationMessagesListBox.Items.Add(sug);
            }

            // Sauvegarde
            if (validationResult.Errors.Count == 0)
            {
                 string pName = _project != null ? _project.Title : ("Projet_Sans_Titre_" + DateTime.Now.ToString("yyyyMMdd"));
                 _service.Create(protocol, pName);
                 
                 // Sync with Project
                 if (_project != null)
                 {
                     _project.GeneralObjective = protocol.GeneralObjective;
                     _project.SpecificObjectives = protocol.SpecificObjectives;
                     _project.DataAnalysisPlan = protocol.DataAnalysis; // Sync SAP
                 }

                 ValidationMessagesListBox.Items.Add($"?? Protocole enregistrÈ avec succËs (ID: {protocol.Id})");
            }
            else
            {
                 ValidationMessagesListBox.Items.Add("?? Veuillez corriger les erreurs critiques (?) avant l'enregistrement.");
            }
        }

        private ResearchProtocol BuildProtocolFromUI()
        {
            var protocol = new ResearchProtocol
            {
                Id = Guid.NewGuid().ToString(),
                ProjectId = _project?.Id,
                Title = TitleTextBox.Text,
                StudyType = StudyTypeComboBox.SelectedItem != null ? (StudyType)StudyTypeComboBox.SelectedItem : StudyType.Quantitative,
                Domain = DomainComboBox.SelectedItem != null ? (ScientificDomain)DomainComboBox.SelectedItem : ScientificDomain.Biomedical,
                QualitativeApproach = (StudyTypeComboBox.SelectedItem is StudyType st && st == StudyType.Qualitative && QualitativeApproachComboBox.SelectedItem != null) 
                    ? (QualitativeApproach)QualitativeApproachComboBox.SelectedItem 
                    : QualitativeApproach.Inductive, 
                EpidemiologyType = EpidemiologyTypeComboBox.SelectedItem != null ? (EpidemiologicalStudyType)EpidemiologyTypeComboBox.SelectedItem : EpidemiologicalStudyType.CrossSectionalDescriptive,
                
                PrincipalAuthor = new AdRev.Domain.Models.Author 
                {
                    FirstName = AuthorFirstNameBox.Text,
                    LastName = AuthorLastNameBox.Text,
                    Title = AuthorTitleBox.SelectedItem is System.Windows.Controls.ComboBoxItem cbi ? cbi.Content?.ToString() ?? "" : "", 
                    Institution = AuthorInstitutionBox.Text,
                    Email = AuthorEmailBox.Text
                },
                
                Context = ContextTextBox.Text,
                ProblemJustification = ProblemTextBox.Text,
                ResearchQuestion = ResearchQuestionTextBox.Text,
                Hypotheses = HypothesesTextBox.Text,
                GeneralObjective = GeneralObjectiveTextBox.Text,
                SpecificObjectives = SpecificObjectivesTextBox.Text,
                ConceptDefinitions = ConceptsTextBox.Text,
                
                StudySetting = StudySettingTextBox.Text,
                ConceptualModel = ConceptualModelTextBox.Text,
                
                IsMulticentric = IsMulticentricCheckBox.IsChecked == true,
                StudyCenters = StudyCentersTextBox?.Text ?? string.Empty,
                
                StudyPopulation = PopulationTextBox.Text,
                InclusionCriteria = InclusionTextBox.Text,
                ExclusionCriteria = ExclusionTextBox.Text,
                
                SamplingType = SamplingTypeComboBox.SelectedItem != null ? (SamplingType)SamplingTypeComboBox.SelectedItem : SamplingType.None,
                IsStratified = IsStratifiedCheckBox.IsChecked == true,
                StratificationCriteria = StratificationCriteriaTextBox?.Text ?? string.Empty,
                IsClusterSampling = IsClusterCheckBox.IsChecked == true,
                ClusterSize = int.TryParse(ClusterSizeTextBox?.Text ?? string.Empty, out int clusterSize) ? clusterSize : 0,
                DesignEffect = double.TryParse(DesignEffectTextBox?.Text ?? string.Empty, System.Globalization.NumberStyles.Any, System.Globalization.CultureInfo.InvariantCulture, out double deff) ? deff : 1.0,
                ExpectedLossRate = double.TryParse(ExpectedLossRateTextBox?.Text ?? string.Empty, out double lossRate) ? lossRate : 0.0,
                
                SamplingMethod = SamplingTextBox.Text,
                DataCollection = DataCollectionTextBox.Text,
                DataAnalysis = DataAnalysisTextBox.Text,
                
                // DataAnalysis duplicate removed
                
                DiscussionPlan = _discussionPlan,
                StudyLimitations = _limitations,
                
                Budget = BudgetTextBox?.Text ?? "",

                Ethics = EthicsTextBox.Text,
                ExpectedResults = ExpectedResultsTextBox.Text,
                Conclusion = ConclusionTextBox.Text,
                References = ReferencesTextBox.Text,
                
                ReferenceStyle = RefStyleComboStep1.SelectedItem != null ? (ReferenceStyle)RefStyleComboStep1.SelectedItem : ReferenceStyle.Vancouver,
                Citations = _citations
            };

            foreach(var auth in _tempCoAuthors) protocol.CoAuthors.Add(auth);
            protocol.Variables = _tempVariables;

            return protocol;
        }

        private void RefreshAudit_LostFocus(object sender, RoutedEventArgs e)
        {
             if (StudyTypeComboBox != null && PanelQualityGuidelines != null && PanelQualityGuidelines.Visibility == Visibility.Visible)
             {
                 UpdateQualityGuidelines((StudyType)StudyTypeComboBox.SelectedItem);
             }
        }

        private void SideMenu_SelectionChanged(object sender, System.Windows.Controls.SelectionChangedEventArgs e)
        {
            if (SideMenuListBox.SelectedItem is System.Windows.Controls.ListBoxItem item && item.Tag != null)
            {
                if (int.TryParse(item.Tag.ToString(), out int step))
                {
                    _currentStep = step;
                    UpdateView();
                }
            }
        }

        // --- Menu Actions ---

        private void MenuFileNew_Click(object sender, RoutedEventArgs e)
        {
             // Reset UI or logic
        }

        private void MenuDiscussion_Click(object sender, RoutedEventArgs e)
        {
             var type = StudyTypeComboBox.SelectedItem != null ? (StudyType)StudyTypeComboBox.SelectedItem : StudyType.Quantitative;
             var obj = SpecificObjectivesTextBox.Text;
             var style = RefStyleComboStep1.SelectedItem as ReferenceStyle? ?? ReferenceStyle.Vancouver;
             int nextIndex = _citations.Count + 1;
             
             var win = new DiscussionWindow(type, obj, _discussionPlan, _limitations, nextIndex, style);
             if (win.ShowDialog() == true)
             {
                 _discussionPlan = win.DiscussionPlan;
                 _limitations = win.Limitations;
                 
                 // Process new citations from Discussion
                 if (win.NewCitations.Any())
                 {
                     _citations.AddRange(win.NewCitations);
                     RegenerateReferencesList();
                 }
                 
                 ValidationMessagesListBox.Items.Add("? Discussion mise ‡ jour ! N'oubliez pas d'enregistrer le protocole.");
             }
        }
        // --- Gestion des RÈfÈrences ---
        
        private List<AdRev.Domain.Models.Citation> _citations = new List<AdRev.Domain.Models.Citation>();
        private ReferenceStyle _lastStyle = ReferenceStyle.Vancouver; // Default start style
        
        // Liste temporaire supprimÈe car gÈrÈe par CitationEntryWindow

        private bool _isSyncingStyle = false;
        private System.Windows.Controls.TextBox? _targetCitationTextBox; // The textbox where citation will be inserted

        private void RefStyleCombo_SelectionChanged(object sender, System.Windows.Controls.SelectionChangedEventArgs e)
        {
            if (_isSyncingStyle) return;
            
            if (sender is System.Windows.Controls.ComboBox cb && cb.SelectedItem is ReferenceStyle style)
            {
                _isSyncingStyle = true;
                if (RefStyleComboStep1 != null && RefStyleComboStep1 != cb) RefStyleComboStep1.SelectedItem = style;
                if (RefStyleComboStep13 != null && RefStyleComboStep13 != cb) RefStyleComboStep13.SelectedItem = style;
                
                // Update Text Content Dynamically
                UpdateTextCitations(_lastStyle, style);
                _lastStyle = style;
                
                _isSyncingStyle = false;

                RegenerateReferencesList();
            }
        }
        
        private void UpdateTextCitations(ReferenceStyle oldStyle, ReferenceStyle newStyle)
        {
            // List of all textboxes that support citations
            var boxes = new List<System.Windows.Controls.TextBox> 
            {
                ContextTextBox, ProblemTextBox, ResearchQuestionTextBox, HypothesesTextBox,
                GeneralObjectiveTextBox, SpecificObjectivesTextBox,
                ConceptsTextBox, ConceptualModelTextBox, StudySettingTextBox,
                PopulationTextBox, StudyCentersTextBox, InclusionTextBox, ExclusionTextBox,
                SamplingTextBox, DataCollectionTextBox, DataAnalysisTextBox,
                BudgetTextBox, EthicsTextBox, ExpectedResultsTextBox, ConclusionTextBox
            };

            foreach (var box in boxes)
            {
                if (box == null || string.IsNullOrEmpty(box.Text)) continue;

                string text = box.Text;

                for (int i = 0; i < _citations.Count; i++)
                {
                    var cit = _citations[i];
                    int index = i + 1;
                    
                    string oldMarker = "";
                    string newMarker = "";

                    // Construct Old Marker regex pattern or string
                    if (oldStyle == ReferenceStyle.Vancouver) oldMarker = $"[{index}]";
                    else oldMarker = $"({cit.Authors}, {cit.Year})";
                    
                    // Construct New Marker
                    if (newStyle == ReferenceStyle.Vancouver) newMarker = $"[{index}]";
                    else newMarker = $"({cit.Authors}, {cit.Year})";
                    
                    if (!string.IsNullOrEmpty(oldMarker) && text.Contains(oldMarker))
                    {
                        text = text.Replace(oldMarker, newMarker);
                    }
                }
                box.Text = text;
            }
            
            // Also update hidden Discussion strings
            if (!string.IsNullOrEmpty(_discussionPlan)) _discussionPlan = UpdateStringCitations(_discussionPlan, oldStyle, newStyle);
            if (!string.IsNullOrEmpty(_limitations)) _limitations = UpdateStringCitations(_limitations, oldStyle, newStyle);
        }

        private string UpdateStringCitations(string text, ReferenceStyle oldStyle, ReferenceStyle newStyle)
        {
            if (string.IsNullOrEmpty(text)) return text;
             for (int i = 0; i < _citations.Count; i++)
            {
                var cit = _citations[i];
                int index = i + 1;
                
                string oldMarker = GetCitationMarker(oldStyle, cit, index);
                string newMarker = GetCitationMarker(newStyle, cit, index);
                
                if (!string.IsNullOrEmpty(oldMarker) && text.Contains(oldMarker))
                {
                    text = text.Replace(oldMarker, newMarker);
                }
            }
            return text;
        }

        private bool IsNumericStyle(ReferenceStyle style)
        {
            return style == ReferenceStyle.Vancouver || style == ReferenceStyle.IEEE || 
                   style == ReferenceStyle.AMA || style == ReferenceStyle.Nature || 
                   style == ReferenceStyle.Science || style == ReferenceStyle.ISO690_Numeric ||
                   style == ReferenceStyle.ACS;
        }

        private string GetCitationMarker(ReferenceStyle style, AdRev.Domain.Models.Citation cit, int index)
        {
            if (IsNumericStyle(style)) return $"[{index}]";
            
            if (style == ReferenceStyle.Chicago) return $"({cit.Authors} {cit.Year})";
            if (style == ReferenceStyle.MLA) return $"({cit.Authors})"; // Simplified
            if (style == ReferenceStyle.MHRA) return $"[{index}]"; // MHRA uses notes, simplified to Ref Number here for text flow
            if (style == ReferenceStyle.Elsevier) return $"({cit.Authors}, {cit.Year})";
            
            // Default APA, Harvard
            return $"({cit.Authors}, {cit.Year})";
        }

        private string GetBibliographicEntry(ReferenceStyle style, AdRev.Domain.Models.Citation cit, int index)
        {
            string authors = cit.Authors;
            string year = cit.Year;
            string title = cit.Title;
            string source = cit.Source;

            switch (style)
            {
                case ReferenceStyle.Vancouver:
                    return $"{index}. {authors}. {title}. {source}; {year}.";
                case ReferenceStyle.APA:
                    return $"{authors} ({year}). {title}. {source}.";
                case ReferenceStyle.Harvard:
                    return $"{authors} ({year}) '{title}', {source}.";
                case ReferenceStyle.Chicago:
                    return $"{authors}. {year}. \"{title}.\" {source}.";
                case ReferenceStyle.MLA:
                    return $"{authors}. \"{title}.\" {source}, {year}.";
                case ReferenceStyle.IEEE:
                    return $"[{index}] {authors}, \"{title},\" {source}, {year}.";
                case ReferenceStyle.AMA:
                    return $"{index}. {authors}. {title}. {source}. {year}.";
                case ReferenceStyle.Nature:
                    return $"{index}. {authors} {title}. {source} ({year}).";
                case ReferenceStyle.Science:
                    return $"{index}. {authors}, {title}. {source} ({year}).";
                case ReferenceStyle.ACS:
                     // ACS: (1) Author. Title. Journal Year, Vol, Page.
                    return $"({index}) {authors}. {title}. {source} {year}."; 
                case ReferenceStyle.MHRA:
                    // MHRA: Author, Title (PubData), Year.
                    // Simplified: Author, Title, Source, Year.
                    return $"{authors}, {title}, {source}, {year}.";
                case ReferenceStyle.Elsevier:
                     // Elsevier: Author, Year. Title. Container Volume, Page.
                     return $"{authors}, {year}. {title}. {source}.";
                case ReferenceStyle.ISO690_Numeric:
                    return $"{index}. {authors.ToUpper()}. {title}. {source}, {year}.";
                default:
                    return $"[{index}] {authors}, {title} ({year})";
            }
        }

        private void AddCitation_Click(object sender, RoutedEventArgs e)
        {
            // Determine target textbox
            if (sender is System.Windows.Controls.Button btn && btn.Tag is string boxName)
            {
                _targetCitationTextBox = this.FindName(boxName) as System.Windows.Controls.TextBox;
            }
            
            // Open Citation Entry Window
            var dialog = new AdRev.Desktop.CitationEntryWindow();
            if (dialog.ShowDialog() == true && dialog.ResultCitations.Any())
            {
                var newCitations = dialog.ResultCitations;
                List<int> addedIndices = new List<int>();

                // Add to main list and track indices
                foreach (var cit in newCitations)
                {
                    _citations.Add(cit);
                    addedIndices.Add(_citations.Count);
                }

                // Insert into Text
                if (_targetCitationTextBox != null)
                {
                   int caretIndex = _targetCitationTextBox.CaretIndex;
                   string marker = "";
                   var style = RefStyleComboStep1.SelectedItem as ReferenceStyle? ?? ReferenceStyle.Vancouver;

                   if (IsNumericStyle(style) || style == ReferenceStyle.MHRA)
                   {
                       if (addedIndices.Count == 1) marker = $" [{addedIndices[0]}]";
                       else marker = $" [{string.Join(", ", addedIndices)}]";
                   }
                   else if (style == ReferenceStyle.Chicago)
                   {
                        var parts = newCitations.Select(c => $"{c.Authors} {c.Year}");
                        marker = $" ({string.Join("; ", parts)})";
                   }
                   else if (style == ReferenceStyle.MLA)
                   {
                        var parts = newCitations.Select(c => $"{c.Authors}");
                        marker = $" ({string.Join("; ", parts)})";
                   }
                   else if (style == ReferenceStyle.MHRA)
                   {
                        marker = $" [{string.Join(", ", addedIndices)}]";
                   }
                   else if (style == ReferenceStyle.Elsevier)
                   {
                        var parts = newCitations.Select(c => $"{c.Authors}, {c.Year}");
                        marker = $" ({string.Join("; ", parts)})";
                   }
                   else
                   {
                        // APA, Harvard default
                        var parts = newCitations.Select(c => $"{c.Authors}, {c.Year}");
                        marker = $" ({string.Join("; ", parts)})";
                   }

                   _targetCitationTextBox.Text = _targetCitationTextBox.Text.Insert(caretIndex, marker);
                   _targetCitationTextBox.CaretIndex = caretIndex + marker.Length;
                   _targetCitationTextBox.Focus();
                }

                RegenerateReferencesList();
            }
        }

        private void RegenerateReferences_Click(object sender, RoutedEventArgs e)
        {
            RegenerateReferencesList();
        }

        private void RegenerateReferencesList()
        {
            if (ReferencesTextBox == null || RefStyleComboStep1 == null) return;
            
            var style = (ReferenceStyle)RefStyleComboStep1.SelectedItem;
            var sb = new System.Text.StringBuilder();

            int index = 1;
            foreach (var cit in _citations)
            {
                sb.AppendLine(GetBibliographicEntry(style, cit, index));
                index++;
            }
            
            ReferencesTextBox.Text = sb.ToString();
        }

        private void ExportWord_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                var protocol = BuildProtocolForWordExport();
                
                SaveFileDialog saveFileDialog = new SaveFileDialog();
                saveFileDialog.Filter = "Document Word (*.docx)|*.docx";
                
                // Safe Title for filename
                string safeTitle = string.Join("_", protocol.Title.Split(System.IO.Path.GetInvalidFileNameChars()));
                if(string.IsNullOrWhiteSpace(safeTitle)) safeTitle = "Protocole";

                saveFileDialog.FileName = $"Protocole_{safeTitle}_{DateTime.Now:yyyyMMdd}.docx";
                
                if (saveFileDialog.ShowDialog() == true)
                {
                    _wordExportService.ExportProtocolToWord(protocol, saveFileDialog.FileName);
                    MessageBox.Show("Exportation terminÈe avec succËs !", "SuccËs", MessageBoxButton.OK, MessageBoxImage.Information);
                }
            }
            catch (System.Exception ex)
            {
                MessageBox.Show($"Erreur lors de l'exportation : {ex.Message}", "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private AdRev.Domain.Protocols.ResearchProtocol BuildProtocolForWordExport()
        {
            var p = new AdRev.Domain.Protocols.ResearchProtocol();
            p.Title = TitleTextBox.Text;
            
            // Authors
            p.PrincipalAuthor = new AdRev.Domain.Models.Author 
            { 
               LastName = AuthorLastNameBox.Text, 
               FirstName = AuthorFirstNameBox.Text,
               Institution = AuthorInstitutionBox.Text,
               Email = AuthorEmailBox.Text
            };
            
            p.CoAuthors = _tempCoAuthors.ToList();

            // Intro
            p.Context = ContextTextBox.Text;
            p.ProblemJustification = ProblemTextBox.Text;
            p.ResearchQuestion = ResearchQuestionTextBox.Text;
            p.Hypotheses = HypothesesTextBox.Text;
            
            // Obj
            p.GeneralObjective = GeneralObjectiveTextBox.Text;
            p.SpecificObjectives = SpecificObjectivesTextBox.Text;
            
            // Methodo
            if (StudyTypeComboBox.SelectedItem is StudyType st) p.StudyType = st;
            if (StudySettingTextBox != null) p.StudySetting = StudySettingTextBox.Text;
            if (PopulationTextBox != null) p.StudyPopulation = PopulationTextBox.Text;
            if (InclusionTextBox != null) p.InclusionCriteria = InclusionTextBox.Text;
            if (ExclusionTextBox != null) p.ExclusionCriteria = ExclusionTextBox.Text;
            
            if (SamplingTextBox != null) p.SamplingMethod = SamplingTextBox.Text;
            if (DataCollectionTextBox != null) p.DataCollection = DataCollectionTextBox.Text;
            if (DataAnalysisTextBox != null) p.DataAnalysis = DataAnalysisTextBox.Text;
            if (EthicsTextBox != null) p.Ethics = EthicsTextBox.Text;
            
            // Results/Discussion
            if (ExpectedResultsTextBox != null) p.ExpectedResults = ExpectedResultsTextBox.Text;
            p.StudyLimitations = _limitations; 
            if (ConclusionTextBox != null) p.Conclusion = ConclusionTextBox.Text;
            
            if (ReferencesTextBox != null) p.References = ReferencesTextBox.Text;

            return p;
        }
    }
}




FILE: \AdRev.Desktop\TeamWindow.xaml
------------------------------------
<Window x:Class="AdRev.Desktop.TeamWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:AdRev.Desktop"
        Title="Gestion de l'√©quipe" Height="500" Width="700"
        WindowStartupLocation="CenterScreen" ResizeMode="NoResize"
        Background="#F9F9F9">
    
    <Window.Resources>
        <local:EnumDescriptionConverter x:Key="EnumDescriptionConverter"/>
    </Window.Resources>
    
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Border BorderBrush="#DDD" BorderThickness="0,0,0,1" Padding="0,0,0,15" Margin="0,0,0,15">
            <StackPanel>
                <TextBlock Text="Travail en √âquipe" FontSize="22" FontWeight="Bold" Foreground="#333"/>
                <TextBlock Text="Invitez des collaborateurs pour travailler sur ce projet." FontSize="14" Foreground="#777"/>
            </StackPanel>
        </Border>

        <!-- Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="2*"/> <!-- List -->
                <ColumnDefinition Width="30"/>
                <ColumnDefinition Width="1.5*"/> <!-- Form -->
            </Grid.ColumnDefinitions>

            <!-- Team List -->
            <DockPanel>
                <TextBlock Text="Membres du projet" DockPanel.Dock="Top" FontWeight="SemiBold" Margin="0,0,0,10"/>
                <Grid>
                    <ListBox x:Name="TeamListBox" BorderThickness="0" Background="Transparent" AlternationCount="2">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border Background="White" CornerRadius="8" Padding="10" Margin="0,0,0,10">
                                    <Border.Effect>
                                        <DropShadowEffect BlurRadius="5" Color="#DDD" Opacity="0.3" ShadowDepth="2"/>
                                    </Border.Effect>
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="40"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <!-- Avatar Placeholder -->
                                        <Border Background="#5C6BC0" CornerRadius="20" Width="40" Height="40">
                                            <TextBlock Text="üë§" 
                                                       HorizontalAlignment="Center" VerticalAlignment="Center" Foreground="White" FontWeight="Bold"/>
                                        </Border>
                                        
                                        <StackPanel Grid.Column="1" Margin="10,0,0,0" VerticalAlignment="Center">
                                            <TextBlock Text="{Binding LastName}" FontWeight="Bold" FontSize="14"/>
                                            <TextBlock Text="{Binding Email}" FontSize="12" Foreground="#888"/>
                                        </StackPanel>
                                        
                                        <!-- Role Badge & Access -->
                                        <StackPanel Grid.Column="2" VerticalAlignment="Center" HorizontalAlignment="Right">
                                            <Border Background="#E8EAF6" CornerRadius="4" Padding="8,4" HorizontalAlignment="Right" Margin="0,0,0,5">
                                                <TextBlock Text="{Binding Role, Converter={StaticResource EnumDescriptionConverter}}" Foreground="#3F51B5" FontSize="11" FontWeight="SemiBold"/>
                                            </Border>
                                            <TextBlock Text="{Binding AccessLevel}" FontSize="10" Foreground="#AAA" HorizontalAlignment="Right"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <!-- Empty State -->
                    <TextBlock Text="Aucun membre dans l'√©quipe pour le moment." 
                               VerticalAlignment="Center" HorizontalAlignment="Center" 
                               Foreground="#BBB" FontSize="14" FontStyle="Italic" TextWrapping="Wrap"
                               IsHitTestVisible="False">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding ElementName=TeamListBox, Path=HasItems}" Value="False">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                </Grid>
            </DockPanel>

            <!-- Invite Form -->
            <Border Grid.Column="2" Background="White" CornerRadius="10" Padding="15">
                <Border.Effect>
                    <DropShadowEffect BlurRadius="10" Color="#DDD" Opacity="0.2"/>
                </Border.Effect>
                <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="0,0,5,0">
                    <StackPanel>
                        <TextBlock Text="Inviter un collaborateur" FontWeight="Bold" Margin="0,0,0,15" Foreground="#5C6BC0"/>
                        
                        <TextBlock Text="Nom" FontSize="12" Foreground="#666"/>
                        <TextBox x:Name="NewNameBox" Height="45" FontSize="14" VerticalContentAlignment="Center" Margin="0,0,0,10"/>
                        
                        <TextBlock Text="Titre / R√¥le" FontSize="12" Foreground="#666"/>
                         <ComboBox x:Name="NewRoleBox" Height="45" FontSize="14" VerticalContentAlignment="Center" Margin="0,0,0,10" SelectedIndex="0">
                            <ComboBox.ItemTemplate>
                                <DataTemplate>
                                    <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                </DataTemplate>
                            </ComboBox.ItemTemplate>
                        </ComboBox>

                        <TextBlock Text="Niveau d'Acc√®s" FontSize="12" Foreground="#666"/>
                        <ComboBox x:Name="NewAccessBox" Height="45" FontSize="14" VerticalContentAlignment="Center" Margin="0,0,0,10" SelectedIndex="1">
                            <ComboBoxItem Content="Lecture Seule"/>
                            <ComboBoxItem Content="√âditeur (Standard)"/>
                            <ComboBoxItem Content="Chef de Projet (Admin)"/>
                        </ComboBox>

                        <TextBlock Text="Email" FontSize="12" Foreground="#666"/>
                        <TextBox x:Name="NewEmailBox" Height="45" FontSize="14" VerticalContentAlignment="Center" Margin="0,0,0,20"/>

                        <Button Content="Envoyer l'invitation" Click="Invite_Click" 
                                Background="#5C6BC0" Foreground="White" BorderThickness="0" Height="45"
                                Cursor="Hand">
                            <Button.Resources>
                                <Style TargetType="Border">
                                    <Setter Property="CornerRadius" Value="5"/>
                                </Style>
                            </Button.Resources>
                        </Button>
                        
                        <TextBlock Text="Une notification sera envoy√©e par email." FontSize="10" Foreground="#AAA" Margin="0,10,0,0" TextWrapping="Wrap" HorizontalAlignment="Center" TextAlignment="Center"/>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>

        <!-- Footer -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,15,0,0">
            <Button Content="Fermer" Click="Close_Click" Width="100" Height="35" Background="Transparent" Foreground="#666" BorderThickness="0"/>
        </StackPanel>
    </Grid>
</Window>




FILE: \AdRev.Desktop\TeamWindow.xaml.cs
------------------------------------
using System;
using System.Collections.ObjectModel;
using System.Windows;
using AdRev.Domain.Models;
using System.Linq;

namespace AdRev.Desktop
{
    public partial class TeamWindow : Window
    {
        private ResearchProject _project;
        private ObservableCollection<Author> _teamMembers;

        public TeamWindow(ResearchProject project)
        {
            InitializeComponent();
            _project = project;

            // Initialize Team if list is null (should normally be init in model)
            if (_project.Team == null) _project.Team = new System.Collections.Generic.List<Author>();

            // Observable wrapper for UI
            _teamMembers = new ObservableCollection<Author>(_project.Team);
            TeamListBox.ItemsSource = _teamMembers;

            NewRoleBox.ItemsSource = System.Enum.GetValues(typeof(FunctionalRole));
            NewRoleBox.SelectedIndex = 0;
        }

        private void Invite_Click(object sender, RoutedEventArgs e)
        {
            if (string.IsNullOrWhiteSpace(NewNameBox.Text)) {
                MessageBox.Show("Veuillez entrer un nom."); 
                return;
            }

            var member = new Author
            {
                LastName = NewNameBox.Text,
                Role = (FunctionalRole)NewRoleBox.SelectedItem,
                Email = NewEmailBox.Text,
                AccessLevel = (UserAccessLevel)(NewAccessBox.SelectedIndex >= 0 ? NewAccessBox.SelectedIndex : 1) // Default to Editor
            };

            // Add to UI List
            _teamMembers.Add(member);
            
            // Add to Project Model
            _project.Team.Add(member);


            MessageBox.Show($"Invitation envoy√©e √† {member.Email} pour rejoindre le projet '{_project.Title}'.", "Invitation Envoy√©e", MessageBoxButton.OK, MessageBoxImage.Information);

            // Clear Form
            NewNameBox.Text = "";
            NewEmailBox.Text = "";
        }

        private void Close_Click(object sender, RoutedEventArgs e)
        {
            this.Close();
        }
    }
}




FILE: \AdRev.Desktop\VariableDesignerWindow.xaml
------------------------------------
<Window x:Class="AdRev.Desktop.VariableDesignerWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:AdRev.Desktop"
        mc:Ignorable="d"
        Title="AdRev - Concepteur de Variables" Height="750" Width="1350"
        WindowStartupLocation="CenterScreen"
        Background="{StaticResource BackgroundBrush}">
    
    <Window.Resources>
        <local:EnumDescriptionConverter x:Key="EnumDescriptionConverter"/>
        
        <Style x:Key="SectionHeaderStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="{StaticResource PrimaryDarkBrush}"/>
            <Setter Property="Margin" Value="0,0,0,10"/>
        </Style>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- Header -->
            <RowDefinition Height="*"/>    <!-- Main Content -->
            <RowDefinition Height="Auto"/> <!-- Footer -->
        </Grid.RowDefinitions>

        <!-- 1. Header Area -->
        <Border Grid.Row="0" Background="{StaticResource PrimaryDarkBrush}" Padding="25,15">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <StackPanel>
                    <TextBlock Text="CONCEPTEUR DE VARIABLES SCIENTIFIQUES" Foreground="White" FontSize="20" FontWeight="Black"/>
                    <TextBlock Text="Structurez vos donn√©es de collecte avec pr√©cision et rigueur acad√©mique." Foreground="#B0BEC5" FontSize="12" Margin="0,2,0,0"/>
                </StackPanel>
                
                <Border Grid.Column="1" Background="#1A237E" CornerRadius="8" Padding="15,8" VerticalAlignment="Center" BorderBrush="#3949AB" BorderThickness="1">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="PROJET : " FontWeight="SemiBold" Foreground="#9FA8DA" FontSize="11"/>
                        <TextBlock x:Name="TxtProjectTitle" Text="Nouveau Projet" FontWeight="Bold" Foreground="White" FontSize="13"/>
                    </StackPanel>
                </Border>
            </Grid>
        </Border>

        <!-- 2. Main Work Area -->
        <Grid Grid.Row="1" Margin="20">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="320"/> <!-- List Sidebar -->
                <ColumnDefinition Width="420"/> <!-- Editor -->
                <ColumnDefinition Width="*"/>   <!-- Preview -->
            </Grid.ColumnDefinitions>

            <!-- LEFT: Variable List -->
            <Border Grid.Column="0" Margin="0,0,10,0" Style="{StaticResource CardStyle}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <TextBlock Text="DICTIONNAIRE" Style="{StaticResource SectionHeaderStyle}" Margin="15,15,15,10"/>
                    
                    <ListBox x:Name="VariablesListBox" Grid.Row="1" BorderThickness="0" Background="Transparent" SelectionChanged="VariablesListBox_SelectionChanged" HorizontalContentAlignment="Stretch" Padding="5">
                        <ListBox.GroupStyle>
                            <GroupStyle>
                                <GroupStyle.HeaderTemplate>
                                    <DataTemplate>
                                        <Border Background="#F5F7F9" Padding="10,5" CornerRadius="4" Margin="0,5">
                                            <TextBlock Text="{Binding Name}" FontWeight="Bold" Foreground="{StaticResource PrimaryBrush}" FontSize="12"/>
                                        </Border>
                                    </DataTemplate>
                                </GroupStyle.HeaderTemplate>
                            </GroupStyle>
                        </ListBox.GroupStyle>

                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border Padding="10" Margin="0,2" CornerRadius="6" x:Name="ItemBorder">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="30"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <Border Width="24" Height="24" CornerRadius="12" Background="#E8EAF6" HorizontalAlignment="Left">
                                            <TextBlock Text="V" Foreground="{StaticResource PrimaryBrush}" FontWeight="Bold" FontSize="10" HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </Border>
                                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                                            <TextBlock Text="{Binding Prompt}" FontWeight="SemiBold" FontSize="12" TextTrimming="CharacterEllipsis"/>
                                            <TextBlock Text="{Binding Name}" FontSize="10" Foreground="Gray"/>
                                        </StackPanel>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>

                    <Grid Grid.Row="2" Margin="15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <Button x:Name="BtnAddVariable" Click="BtnAddVariable_Click" Style="{StaticResource ModernButtonStyle}" Background="{StaticResource SecondaryBrush}">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="&#xE710;" FontFamily="Segoe MDL2 Assets" Margin="0,0,8,0"/>
                                <TextBlock Text="Ajouter une Variable"/>
                            </StackPanel>
                        </Button>
                        <Button x:Name="BtnDeleteVariable" Grid.Column="1" Click="BtnDeleteVariable_Click" Margin="10,0,0,0" Width="40" Background="#FFEBEE" Foreground="#D32F2F" BorderBrush="#FFCDD2" ToolTip="Supprimer">
                            <TextBlock Text="&#xE74D;" FontFamily="Segoe MDL2 Assets"/>
                        </Button>
                    </Grid>
                </Grid>
            </Border>

            <!-- CENTER: Editor -->
            <ScrollViewer Grid.Column="1" Margin="10,0" VerticalScrollBarVisibility="Auto">
                <Border Style="{StaticResource CardStyle}" Padding="25">
                    <StackPanel x:Name="EditorPanel" IsEnabled="False">
                        <TextBlock Text="CONFIGURATEUR" Style="{StaticResource SectionHeaderStyle}"/>
                        
                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="Informations G√©n√©rales" Tag="#E3F2FD" Foreground="#1565C0" IsExpanded="True" Margin="0,0,0,15">
                            <StackPanel Margin="10">
                                <TextBlock Text="Question (Libell√©)" Style="{StaticResource LabelStyle}"/>
                                <TextBox x:Name="TxtPrompt" TextChanged="TxtPrompt_TextChanged" Height="60" TextWrapping="Wrap" AcceptsReturn="True"/>
                                
                                <Grid Margin="0,15,0,0">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="15"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <StackPanel>
                                        <TextBlock Text="Nom Technique" Style="{StaticResource LabelStyle}"/>
                                        <TextBox x:Name="TxtName" CharacterCasing="Upper"/>
                                    </StackPanel>
                                    <StackPanel Grid.Column="2">
                                        <TextBlock Text="Type de Donn√©e" Style="{StaticResource LabelStyle}"/>
                                        <ComboBox x:Name="CmbType" SelectionChanged="CmbType_SelectionChanged">
                                            <ComboBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding Converter={StaticResource EnumDescriptionConverter}}"/>
                                                </DataTemplate>
                                            </ComboBox.ItemTemplate>
                                        </ComboBox>
                                    </StackPanel>
                                </Grid>
                                
                                <TextBlock Text="Groupe / Section" Style="{StaticResource LabelStyle}" Margin="0,15,0,5"/>
                                <TextBox x:Name="TxtGroup" TextChanged="TxtGroup_TextChanged"/>
                                
                                <CheckBox x:Name="ChkRequired" Content="Variable Obligatoire (*)" Margin="0,15,0,0" FontWeight="Bold" Click="ChkRequired_Click" Foreground="#D32F2F"/>
                            </StackPanel>
                        </Expander>

                        <Expander Style="{StaticResource ScientificExpanderStyle}" Header="Logique et Visibilit√©" Tag="#FFF3E0" Foreground="#E65100" Margin="0,0,0,15">
                            <StackPanel Margin="10">
                                <TextBlock Text="Condition d'Affichage" Style="{StaticResource LabelStyle}"/>
                                <TextBox x:Name="TxtCondition" TextChanged="TxtCondition_TextChanged" ToolTip="Ex: [SEXE] = 'F'"/>
                                <TextBlock Text="Laissez vide pour une visibilit√© permanente." FontSize="10" Foreground="Gray" FontStyle="Italic"/>

                                <TextBlock Text="Logique de Saut (Skip)" Style="{StaticResource LabelStyle}" Margin="0,15,0,5"/>
                                <TextBox x:Name="TxtSkipLogic" TextChanged="TxtSkipLogic_TextChanged" ToolTip="Ex: Aller √† la section B"/>
                            </StackPanel>
                        </Expander>

                        <!-- Param√®tres Sp√©cifiques (Dynamic) -->
                        <Border x:Name="OptionsPanel" Background="#F8F9FA" CornerRadius="8" Padding="15" BorderBrush="#E0E0E0" BorderThickness="1">
                            <StackPanel>
                                <TextBlock Text="PARAM√àTRES AVANC√âS" FontWeight="Bold" FontSize="11" Foreground="#546E7A" Margin="0,0,0,10"/>
                                
                                <StackPanel x:Name="PanelChoices" Visibility="Collapsed">
                                    <TextBlock Text="Options de r√©ponse (S√©parez par des virgules)" Style="{StaticResource LabelStyle}"/>
                                    <TextBox x:Name="TxtChoices" Height="80" TextWrapping="Wrap" AcceptsReturn="True" TextChanged="TxtChoices_TextChanged"/>
                                </StackPanel>

                                <StackPanel x:Name="PanelNumeric" Visibility="Collapsed">
                                    <Grid>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="20"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <StackPanel>
                                            <TextBlock Text="Min" Style="{StaticResource LabelStyle}"/>
                                            <TextBox x:Name="TxtMin" TextChanged="TxtMin_TextChanged"/>
                                        </StackPanel>
                                        <StackPanel Grid.Column="2">
                                            <TextBlock Text="Max" Style="{StaticResource LabelStyle}"/>
                                            <TextBox x:Name="TxtMax" TextChanged="TxtMax_TextChanged"/>
                                        </StackPanel>
                                    </Grid>
                                </StackPanel>

                                <StackPanel x:Name="PanelCalculated" Visibility="Collapsed">
                                    <TextBlock Text="Formule Math√©matique" Style="{StaticResource LabelStyle}"/>
                                    <TextBox x:Name="TxtFormula" Height="60" TextWrapping="Wrap" AcceptsReturn="True" TextChanged="TxtFormula_TextChanged" Background="#E8EAF6"/>
                                </StackPanel>
                                
                                <StackPanel x:Name="PanelQualitativeDeductive" Visibility="Collapsed">
                                    <TextBlock Text="Classification Scientifique" Style="{StaticResource LabelStyle}"/>
                                    <TextBox x:Name="TxtTheme" TextChanged="TxtTheme_TextChanged" Tag="Th√®me"/>
                                    <TextBox x:Name="TxtSubTheme" TextChanged="TxtSubTheme_TextChanged" Tag="Sous-th√®me" Margin="0,8,0,0"/>
                                </StackPanel>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </Border>
            </ScrollViewer>

            <!-- RIGHT: Live Preview with Times New Roman -->
            <Grid Grid.Column="2" Margin="10,0,0,0">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>
                
                <Border Background="{StaticResource PrimaryBrush}" Padding="15,10" CornerRadius="8,8,0,0">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="&#xE890;" FontFamily="Segoe MDL2 Assets" Foreground="White" VerticalAlignment="Center" Margin="0,0,10,0" FontSize="16"/>
                        <TextBlock Text="APER√áU SCIENTIFIQUE (Times New Roman)" Foreground="White" FontWeight="Bold" FontSize="12" VerticalAlignment="Center"/>
                    </StackPanel>
                </Border>
                
                <Border Grid.Row="1" Background="White" BorderBrush="{StaticResource PrimaryBrush}" BorderThickness="1,0,1,1" CornerRadius="0,0,8,8">
                    <TextBox x:Name="TxtPreview" 
                             BorderThickness="0"
                             FontFamily="Times New Roman" 
                             FontSize="14" 
                             Padding="30" 
                             AcceptsReturn="True" 
                             VerticalScrollBarVisibility="Auto" 
                             IsReadOnly="True" 
                             TextWrapping="Wrap"
                             Background="White"
                             Foreground="#333"/>
                </Border>
            </Grid>
        </Grid>

        <!-- 3. Footer Operations -->
        <Border Grid.Row="2" Background="#ECEFF1" Padding="25,15" BorderBrush="#CFD8DC" BorderThickness="0,1,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                
                <Button Grid.Column="0" Click="BtnExport_Click" Style="{StaticResource ModernButtonStyle}" Background="#F57C00">
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="&#xE8A1;" FontFamily="Segoe MDL2 Assets" Margin="0,0,10,0"/>
                        <TextBlock Text="Exporter en Word (MS Word)"/>
                    </StackPanel>
                </Button>

                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <Button Content="Fermer" Click="Close_Click" Margin="0,0,15,0" Width="100" Background="Transparent" Foreground="#455A64" BorderBrush="#90A4AE"/>
                    <Button Content="ENREGISTRER LE MASQUE" Click="BtnSave_Click" Style="{StaticResource ModernButtonStyle}" Width="280"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>




FILE: \AdRev.Desktop\VariableDesignerWindow.xaml.cs
------------------------------------
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.Linq;
using System.Windows;
using System.Windows.Controls;
using AdRev.Domain.Enums;
using AdRev.Domain.Variables;

namespace AdRev.Desktop
{
    public partial class VariableDesignerWindow : Window
    {
        // Collection observable pour lier √† l'interface (mise √† jour automatique)
        public ObservableCollection<StudyVariable> Variables { get; set; }
        private StudyVariable? _currentVariable;
        private bool _isUpdating = false;
        private bool _isQualitativeDeductive = false;

        public VariableDesignerWindow(List<StudyVariable> existingVariables, string projectTitle, bool isQualitativeDeductive = false)
        {
            InitializeComponent();
            _isQualitativeDeductive = isQualitativeDeductive;
            TxtProjectTitle.Text = projectTitle;

            if (_isQualitativeDeductive)
            {
                PanelQualitativeDeductive.Visibility = Visibility.Visible;
            }
            else
            {
                PanelQualitativeDeductive.Visibility = Visibility.Collapsed;
            }
            
            // Initialisation de la liste
            Variables = new ObservableCollection<StudyVariable>(existingVariables ?? new List<StudyVariable>());
            VariablesListBox.ItemsSource = Variables; 

            // Configurer le regroupement
            System.Windows.Data.CollectionView view = (System.Windows.Data.CollectionView)System.Windows.Data.CollectionViewSource.GetDefaultView(VariablesListBox.ItemsSource);
            if (view != null)
            {
                view.GroupDescriptions.Clear();
                view.GroupDescriptions.Add(new System.Windows.Data.PropertyGroupDescription("GroupName"));
            }

            // Remplir le ComboBox des types
            CmbType.ItemsSource = Enum.GetValues(typeof(VariableType));
            
            UpdatePreview(); // Premier aper√ßu
        }

        private void BtnAddVariable_Click(object sender, RoutedEventArgs e)
        {
            // Cr√©er une nouvelle variable par d√©faut
            var newVar = new StudyVariable
            {
                Prompt = "Nouvelle Question",
                Name = $"VAR_{Variables.Count + 1}",
                Type = VariableType.Text,
                GroupName = "SECTION 1" // Groupe par d√©faut
            };

            Variables.Add(newVar);
            VariablesListBox.SelectedItem = newVar; 
            VariablesListBox.ScrollIntoView(newVar);
            UpdatePreview();
        }

        private void BtnDeleteVariable_Click(object sender, RoutedEventArgs e)
        {
            if (VariablesListBox.SelectedItem is StudyVariable selected)
            {
                if (MessageBox.Show($"Voulez-vous vraiment supprimer '{selected.Prompt}' ?", "Confirmation", MessageBoxButton.YesNo, MessageBoxImage.Warning) == MessageBoxResult.Yes)
                {
                    Variables.Remove(selected);
                    UpdatePreview();
                }
            }
        }

        // Mise √† jour de l'aper√ßu en temps r√©el
        private void UpdatePreview()
        {
            if (TxtPreview == null) return;

            try
            {
                var tempWithRef = new AdRev.Domain.Protocols.ResearchProtocol
                {
                    Title = TxtProjectTitle.Text,
                    Variables = new List<StudyVariable>(Variables)
                };

                var gen = new AdRev.Core.Services.QuestionnaireGenerator();
                TxtPreview.Text = gen.GenerateMarkdownQuestionnaire(tempWithRef);
            }
            catch
            {
                // Ignorer erreurs pendant la frappe
            }
        }

        // Quand on s√©lectionne une variable dans la liste
        private void VariablesListBox_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (VariablesListBox.SelectedItem is StudyVariable selected)
            {
                _currentVariable = selected;
                EditorPanel.IsEnabled = true;
                _isUpdating = true; 

                // Remplir le formulaire
                TxtPrompt.Text = selected.Prompt;
                TxtName.Text = selected.Name;
                CmbType.SelectedItem = selected.Type;
                TxtGroup.Text = selected.GroupName;
                TxtCondition.Text = selected.VisibilityCondition; 
                
                TxtChoices.Text = selected.ChoiceOptions;
                TxtSkipLogic.Text = selected.SkipLogic;         
                TxtFormula.Text = selected.CalculationFormula;   

                TxtMin.Text = selected.MinValue?.ToString();
                TxtMax.Text = selected.MaxValue?.ToString();
                TxtTheme.Text = selected.Theme;
                TxtSubTheme.Text = selected.SubTheme;
                ChkRequired.IsChecked = selected.IsRequired;
                
                UpdateOptionPanelsVisibility(selected.Type);

                _isUpdating = false;
            }
            else
            {
                EditorPanel.IsEnabled = false;
                _currentVariable = null;
            }
        }

        private void TxtPrompt_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_isUpdating || _currentVariable == null) return;
            _currentVariable.Prompt = TxtPrompt.Text;
            
            if (string.IsNullOrWhiteSpace(TxtName.Text) || TxtName.Text.StartsWith("VAR_"))
            {
                string suggestedName = GenerateSlug(TxtPrompt.Text);
                if (suggestedName.Length > 12) suggestedName = suggestedName.Substring(0, 12);
                TxtName.Text = suggestedName.ToUpper();
            }
            UpdatePreview();
        }

        private void TxtGroup_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_isUpdating || _currentVariable == null) return;
            _currentVariable.GroupName = TxtGroup.Text;
            
            System.Windows.Data.CollectionView view = (System.Windows.Data.CollectionView)System.Windows.Data.CollectionViewSource.GetDefaultView(VariablesListBox.ItemsSource);
            view?.Refresh();
            
            UpdatePreview();
        }

        private void CmbType_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (_isUpdating || _currentVariable == null) return;
            
            if (CmbType.SelectedItem is VariableType type)
            {
                _currentVariable.Type = type;
                UpdateOptionPanelsVisibility(type);
                UpdatePreview();
            }
        }

        private void TxtTheme_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_isUpdating || _currentVariable == null) return;
            _currentVariable.Theme = TxtTheme.Text;
            UpdatePreview();
        }

        private void TxtSubTheme_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_isUpdating || _currentVariable == null) return;
            _currentVariable.SubTheme = TxtSubTheme.Text;
            UpdatePreview();
        }

        private void UpdateOptionPanelsVisibility(VariableType type)
        {
            PanelChoices.Visibility = Visibility.Collapsed;
            PanelNumeric.Visibility = Visibility.Collapsed;
            PanelCalculated.Visibility = Visibility.Collapsed;

            switch (type)
            {
                case VariableType.QualitativeNominal:
                case VariableType.QualitativeOrdinal:
                case VariableType.MultipleChoice:
                case VariableType.QualitativeBinary: 
                    PanelChoices.Visibility = Visibility.Visible;
                    break;
                case VariableType.QuantitativeDiscrete:
                case VariableType.QuantitativeContinuous:
                    PanelNumeric.Visibility = Visibility.Visible;
                    break;
                case VariableType.Calculated:
                    PanelCalculated.Visibility = Visibility.Visible;
                    break;
            }
        }

        private void TxtChoices_TextChanged(object sender, TextChangedEventArgs e)
        {
             if (_isUpdating || _currentVariable == null) return;
             _currentVariable.ChoiceOptions = TxtChoices.Text;
             UpdatePreview();
        }

        private void TxtSkipLogic_TextChanged(object sender, TextChangedEventArgs e)
        {
             if (_isUpdating || _currentVariable == null) return;
             _currentVariable.SkipLogic = TxtSkipLogic.Text;
             UpdatePreview();
        }

        private void TxtFormula_TextChanged(object sender, TextChangedEventArgs e)
        {
             if (_isUpdating || _currentVariable == null) return;
             _currentVariable.CalculationFormula = TxtFormula.Text;
             UpdatePreview();
        }

        private void TxtMin_TextChanged(object sender, TextChangedEventArgs e)
        {
             if (_isUpdating || _currentVariable == null) return;
             if (double.TryParse(TxtMin.Text, out double val)) _currentVariable.MinValue = val;
             else _currentVariable.MinValue = null;
             UpdatePreview();
        }

        private void TxtMax_TextChanged(object sender, TextChangedEventArgs e)
        {
             if (_isUpdating || _currentVariable == null) return;
             if (double.TryParse(TxtMax.Text, out double val)) _currentVariable.MaxValue = val;
             else _currentVariable.MaxValue = null;
             UpdatePreview();
        }

        private void ChkRequired_Click(object sender, RoutedEventArgs e)
        {
             if (_isUpdating || _currentVariable == null) return;
             _currentVariable.IsRequired = ChkRequired.IsChecked ?? false;
             UpdatePreview();
        }

        private void TxtCondition_TextChanged(object sender, TextChangedEventArgs e)
        {
             if (_isUpdating || _currentVariable == null) return;
             _currentVariable.VisibilityCondition = TxtCondition.Text;
             UpdatePreview();
        }

        private void Close_Click(object sender, RoutedEventArgs e)
        {
            DialogResult = false;
        }

        private void BtnSave_Click(object sender, RoutedEventArgs e)
        {
            DialogResult = true;
        }

        private string GenerateSlug(string text)
        {
             if (string.IsNullOrEmpty(text)) return "VAR";
             string normalizedString = text.Normalize(System.Text.NormalizationForm.FormD);
             var sb = new System.Text.StringBuilder();
             foreach (var c in normalizedString)
             {
                 if (System.Globalization.CharUnicodeInfo.GetUnicodeCategory(c) != System.Globalization.UnicodeCategory.NonSpacingMark)
                     sb.Append(c);
             }
             string cleanText = sb.ToString().Normalize(System.Text.NormalizationForm.FormC);
             var final = new string(cleanText.Where(c => char.IsLetterOrDigit(c)).ToArray());
             return string.IsNullOrWhiteSpace(final) ? "VAR" : final.ToUpper();
        }

        private void BtnExport_Click(object sender, RoutedEventArgs e)
        {
            if (Variables.Count == 0)
            {
                MessageBox.Show("Veuillez d'abord ajouter des variables.", "Export Impossible", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            try
            {
                var tempProtocol = new AdRev.Domain.Protocols.ResearchProtocol
                {
                    Title = TxtProjectTitle.Text,
                    Variables = new List<StudyVariable>(Variables)
                };

                var saveFileDialog = new Microsoft.Win32.SaveFileDialog
                {
                    Filter = "Document Word (*.docx)|*.docx",
                    FileName = $"Fiche_Enquete_{DateTime.Now:yyyyMMdd_HHmmss}.docx"
                };

                if (saveFileDialog.ShowDialog() == true)
                {
                    var exportService = new Services.WordExportService();
                    exportService.ExportVariableSheetToWord(tempProtocol, saveFileDialog.FileName);

                    MessageBox.Show("Fiche de conception export√©e avec succ√®s !", "Succ√®s", MessageBoxButton.OK, MessageBoxImage.Information);
                    System.Diagnostics.Process.Start(new System.Diagnostics.ProcessStartInfo(saveFileDialog.FileName) { UseShellExecute = true });
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Erreur lors de l'export Word : {ex.Message}", "Erreur", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }
    }
}




FILE: \AdRev.Desktop\WelcomeWindow.xaml
------------------------------------
<Window x:Class="AdRev.Desktop.WelcomeWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Bienvenue sur AdRev" Height="500" Width="600"
        WindowStartupLocation="CenterScreen" WindowStyle="None" ResizeMode="NoResize"
        Background="Transparent" AllowsTransparency="True">
    
    <Border CornerRadius="20" Background="White" BorderBrush="{StaticResource PrimaryBrush}" BorderThickness="1">
        <Border.Effect>
            <DropShadowEffect BlurRadius="20" Color="#AAAAAA" ShadowDepth="5" Opacity="0.5"/>
        </Border.Effect>
        
        <Grid Margin="40">
            <StackPanel VerticalAlignment="Center">
                <!-- Logo / Icon -->
                <Image Source="pack://application:,,,/AdRev.Desktop;component/Assets/AppIcon.png" Width="80" Height="80" Margin="0,0,0,20"/>
                
                <TextBlock Text="Bienvenue sur AdRev" FontSize="28" FontWeight="Bold" Foreground="{StaticResource PrimaryBrush}" HorizontalAlignment="Center" Margin="0,0,0,10"/>
                <TextBlock Text="Faisons connaissance pour mieux personnaliser votre exp√©rience." FontSize="14" Foreground="#666" HorizontalAlignment="Center" Margin="0,0,0,30"/>
                
                <Grid Margin="0,0,0,20" HorizontalAlignment="Center" Width="400">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Row 1: Title & Name -->
                    <Grid Grid.Row="0" Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="100"/>
                            <ColumnDefinition Width="10"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        
                        <StackPanel>
                            <TextBlock Text="Titre" Foreground="#888" Margin="0,0,0,5"/>
                            <ComboBox x:Name="TitleBox" Height="40" VerticalContentAlignment="Center" FontSize="16" SelectedIndex="0">
                                <ComboBoxItem Content="Dr"/>
                                <ComboBoxItem Content="Pr"/>
                                <ComboBoxItem Content="M."/>
                                <ComboBoxItem Content="Mme"/>
                            </ComboBox>
                        </StackPanel>
                        
                        <StackPanel Grid.Column="2">
                            <TextBlock Text="Votre Nom" Foreground="#888" Margin="0,0,0,5"/>
                            <TextBox x:Name="NameBox" Height="40" VerticalContentAlignment="Center" FontSize="16" Padding="5"/>
                        </StackPanel>
                    </Grid>

                    <!-- Row 2: Email -->
                    <StackPanel Grid.Row="1" Margin="0,0,0,15">
                        <TextBlock Text="Email Professionnel" Foreground="#888" Margin="0,0,0,5"/>
                        <TextBox x:Name="EmailBox" Height="40" VerticalContentAlignment="Center" FontSize="16" Padding="5"/>
                    </StackPanel>

                     <!-- Row 3: License Request -->
                    <Grid Grid.Row="2" Margin="0,0,0,15">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="10"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        
                        <StackPanel>
                            <TextBlock Text="Type de Licence Souhait√©" Foreground="#888" Margin="0,0,0,5"/>
                            <ComboBox x:Name="LicenseTypeBox" Height="40" VerticalContentAlignment="Center" FontSize="14" SelectedIndex="0">
                                <ComboBoxItem Content="Professionnelle (Standards)"/>
                                <ComboBoxItem Content="√âtudiant (Tarif R√©duit)"/>
                                <ComboBoxItem Content="Entreprise (Multi-postes)"/>
                                <ComboBoxItem Content="Annuelle"/>
                            </ComboBox>
                        </StackPanel>

                        <StackPanel Grid.Column="2">
                            <TextBlock Text="Code Machine (HWID)" Foreground="#888" Margin="0,0,0,5"/>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBox x:Name="HwidBox" IsReadOnly="True" Height="40" VerticalContentAlignment="Center" FontSize="12" Padding="5" Background="#F5F5F5" FontFamily="Consolas"/>
                                <Button Grid.Column="1" Content="Copier" Width="50" Height="40" Margin="5,0,0,0" x:Name="CopyHwidBtn" Click="CopyHwid_Click" ToolTip="Copier les infos de commande"/>
                            </Grid>
                            <TextBlock Text="N'oubliez pas de joindre votre preuve de paiement !" FontSize="10" Foreground="#d9534f" Margin="0,2,0,0" FontStyle="Italic" HorizontalAlignment="Right"/>
                        </StackPanel>
                    </Grid>

                    <!-- Row 4: License Key -->
                    <StackPanel Grid.Row="3" Margin="0,0,0,15">
                        <TextBlock Text="Cl√© de Licence (Optionnel)" Foreground="#888" Margin="0,0,0,5"/>
                        <TextBox x:Name="LicenseBox" Height="40" VerticalContentAlignment="Center" FontSize="14" Padding="5" FontFamily="Consolas"/>
                        <TextBlock Text="Laisser vide pour commencer un essai gratuit." FontSize="11" Foreground="#999" Margin="0,2,0,0" FontStyle="Italic"/>
                    </StackPanel>
                </Grid>
                
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                    <Button Content="Activer" Click="Activate_Click" x:Name="BtnActivate"
                            Width="120" Height="50" FontSize="16" FontWeight="Bold" Margin="0,0,10,0"
                            Background="{StaticResource PrimaryBrush}" Foreground="White" BorderThickness="0">
                        <Button.Resources>
                            <Style TargetType="Border">
                                <Setter Property="CornerRadius" Value="25"/>
                            </Style>
                        </Button.Resources>
                    </Button>

                    <Button Content="Essai 7 Jours" Click="Trial_Click" x:Name="BtnTrial"
                            Width="150" Height="50" FontSize="16" FontWeight="SemiBold"
                            Background="White" Foreground="{StaticResource PrimaryBrush}" BorderBrush="{StaticResource PrimaryBrush}" BorderThickness="2">
                        <Button.Resources>
                            <Style TargetType="Border">
                                <Setter Property="CornerRadius" Value="25"/>
                            </Style>
                        </Button.Resources>
                    </Button>
                </StackPanel>
            </StackPanel>
        </Grid>
    </Border>
</Window>




FILE: \AdRev.Desktop\WelcomeWindow.xaml.cs
------------------------------------
using System.Windows;
using AdRev.Core.Services;
using AdRev.Domain.Models;
using AdRev.Desktop.Services;

namespace AdRev.Desktop
{
    public partial class WelcomeWindow : Window
    {
        public UserProfile? Profile { get; private set; }

        public WelcomeWindow()
        {
            InitializeComponent();
            var service = new LicensingService();
            HwidBox.Text = service.GetHardwareId();
        }

        private void CopyHwid_Click(object sender, RoutedEventArgs e)
        {
            if (string.IsNullOrWhiteSpace(NameBox.Text) || string.IsNullOrWhiteSpace(EmailBox.Text))
            {
                MessageBox.Show("Veuillez remplir votre Nom et Email avant de copier la demande.", "Infos manquantes", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            string type = (LicenseTypeBox.SelectedItem as System.Windows.Controls.ComboBoxItem)?.Content?.ToString() ?? "Standard";
            string orderRequest = $"COMMAND ADREV\n------------------\nNOM : {NameBox.Text} {TitleBox.Text}\nEMAIL : {EmailBox.Text}\nTYPE : {type}\nHWID : {HwidBox.Text}\nPAIEMENT : [Joindre Capture/Facture]\n------------------";
            
            Clipboard.SetText(orderRequest);
            MessageBox.Show("Les informations de commande ont √©t√© copi√©es !\nCollez ce message au vendeur pour obtenir votre cl√©.", "Demande Copi√©e", MessageBoxButton.OK, MessageBoxImage.Information);
        }

        private void Activate_Click(object sender, RoutedEventArgs e)
        {
            if (!ValidateInput()) return;

            string key = LicenseBox.Text.Trim();
            if (string.IsNullOrEmpty(key))
            {
                MessageBox.Show("Veuillez entrer une cl√© de licence pour activer.", "Cl√© manquante", MessageBoxButton.OK, MessageBoxImage.Warning);
                return;
            }

            var service = new LicensingService();
            if (service.Activate(key))
            {
                SaveProfile();
                MessageBox.Show("F√©licitations ! Votre licence AdRev Pro est activ√©e.", "Activation R√©ussie", MessageBoxButton.OK, MessageBoxImage.Information);
                this.DialogResult = true;
                this.Close();
            }
            else
            {
                MessageBox.Show("Cl√© de licence invalide ou expir√©e.", "Erreur d'Activation", MessageBoxButton.OK, MessageBoxImage.Error);
            }
        }

        private void Trial_Click(object sender, RoutedEventArgs e)
        {
            if (!ValidateInput()) return;

            var service = new LicensingService();
            service.StartTrial();

            SaveProfile();
            MessageBox.Show("Votre p√©riode d'essai de 7 jours commence maintenant !", "Essai Activ√©", MessageBoxButton.OK, MessageBoxImage.Information);
            
            this.DialogResult = true;
            this.Close();
        }

        private bool ValidateInput()
        {
            if (string.IsNullOrWhiteSpace(NameBox.Text) || string.IsNullOrWhiteSpace(EmailBox.Text))
            {
                MessageBox.Show("Veuillez entrer votre nom et votre email pour continuer.", "Information manquante", MessageBoxButton.OK, MessageBoxImage.Information);
                return false;
            }

            if (!EmailBox.Text.Contains("@"))
            {
                 MessageBox.Show("Veuillez entrer une adresse email valide.", "Email Invalide", MessageBoxButton.OK, MessageBoxImage.Warning);
                 return false;
            }
            return true;
        }

        private void SaveProfile()
        {
            Profile = new UserProfile
            {
                Title = TitleBox.Text,
                LastName = NameBox.Text,
                Email = EmailBox.Text
            };
        }
    }
}




FILE: \AdRev.Domain\Enums\AcademicLevel.cs
------------------------------------
using System.ComponentModel;

namespace AdRev.Domain.Enums
{
    public enum AcademicLevel
    {
        [Description("Th√®se de Doctorat")]
        Thesis,
        
        [Description("M√©moire de Master")]
        MasterMemoir,
        
        [Description("M√©moire de Licence")]
        BachelorMemoir,
        
        [Description("Article Scientifique")]
        ScientificArticle,
        
        [Description("Rapport de Stage / Etude")]
        TechnicalReport,

        [Description("Rapport ONG / Humanitaire")]
        NGOReport,

        [Description("Autre")]
        Other
    }
}




FILE: \AdRev.Domain\Enums\EpidemiologicalStudyType.cs
------------------------------------
using System.ComponentModel;

namespace AdRev.Domain.Enums
{
    public enum EpidemiologicalStudyType
    {
        [Description("Non sp√©cifi√©")]
        None,

        // Observationnelles Descriptives
        [Description("Transversale (Pr√©valence)")]
        CrossSectionalDescriptive,
        
        [Description("Longitudinale (Incidence)")]
        LongitudinalIncidence,
        
        [Description("√âcologique (Corr√©lationnelle)")]
        Ecological,
        
        [Description("S√©rie de Cas")]
        CaseSeries,

        // Observationnelles Analytiques
        [Description("Cas-T√©moins")]
        CaseControl,
        
        [Description("Cohorte Prospective")]
        CohortProspective,
        
        [Description("Cohorte R√©trospective")]
        CohortRetrospective,
        
        [Description("Transversale Analytique")]
        CrossSectionalAnalytic,

        // Exp√©rimentales (Interventionnelles)
        [Description("Essai Randomis√© Contr√¥l√© (ERC)")]
        RandomizedControlledTrial,
        
        [Description("Essai Quasi-Exp√©rimental")]
        QuasiExperimental,
        
        [Description("Essai Avant-Apr√®s")]
        BeforeAfterStudy,

        // Synth√®se
        [Description("Revue Syst√©matique / M√©ta-analyse")]
        SystematicReviewMetaAnalysis
    }
}




FILE: \AdRev.Domain\Enums\ProjectContext.cs
------------------------------------
using System.ComponentModel;

namespace AdRev.Domain.Enums
{
    public enum ProjectContext
    {
        [Description("Projet de Th√®se M√©decine")]
        MedicalThesis,
        
        [Description("Projet de M√©moire de Sp√©cialisation")]
        SpecializationThesis,
        
        [Description("Projet d'√©valuation ONG")]
        ONGEvaluation,
        
        [Description("Projet de recherche ONG")]
        ONGResearch,
        
        [Description("Projet National")]
        NationalProject,

        [Description("Autre")]
        Other
    }
}




FILE: \AdRev.Domain\Enums\QualitativeApproach.cs
------------------------------------
using System.ComponentModel;

namespace AdRev.Domain.Enums
{
    public enum QualitativeApproach
    {
        [Description("Inductive (Grounded Theory, Ph√©nom√©nologie)")]
        Inductive,

        [Description("D√©ductive (Framework Analysis, Analyse de contenu dirig√©e)")]
        Deductive,

        [Description("Mixte / Hybride")]
        Mixed
    }
}




FILE: \AdRev.Domain\Enums\ReferenceStyle.cs
------------------------------------
namespace AdRev.Domain.Enums;

public enum ReferenceStyle
{
    Vancouver,
    APA,
    Harvard,
    Chicago,
    MLA,
    IEEE,
    AMA,
    Nature,
    Science,
    ISO690_Numeric,
    [System.ComponentModel.Description("ACS (Chimie - Num√©rique)")]
    ACS,
    [System.ComponentModel.Description("MHRA (Humanit√©s - Notes)")]
    MHRA,
    [System.ComponentModel.Description("Elsevier (Standard - Harvard)")]
    Elsevier
}




FILE: \AdRev.Domain\Enums\SamplingType.cs
------------------------------------
using System.ComponentModel;

namespace AdRev.Domain.Enums
{
    public enum SamplingType
    {
        [Description("Non sp√©cifi√©")]
        None,

        // √âchantillonnage probabiliste
        [Description("Al√©atoire Simple")]
        SimpleRandom,
        
        [Description("Syst√©matique")]
        Systematic,
        
        [Description("Stratifi√©")]
        Stratified,
        
        [Description("En Grappe (Cluster)")]
        ClusterSampling,
        
        [Description("√Ä Plusieurs Degr√©s")]
        MultiStage,
        
        [Description("Stratifi√© en Grappes")]
        StratifiedCluster,

        // √âchantillonnage non probabiliste
        [Description("De Convenance")]
        Convenience,
        
        [Description("Raisonn√© (Purposive)")]
        Purposive,
        
        [Description("Boule de Neige")]
        Snowball,
        
        [Description("Par Quotas")]
        Quota,

        [Description("Th√©orique (Grounded Theory)")]
        Theoretical,
        
        // Autres
        [Description("Exhaustif (Recensement)")]
        Census
    }
}




FILE: \AdRev.Domain\Enums\ScientificDomain.cs
------------------------------------
using System.ComponentModel;

namespace AdRev.Domain.Enums
{
    public enum ScientificDomain
    {
        [Description("Biom√©decine & Sant√©")]
        Biomedical,

        [Description("Sciences Sociales & Humaines")]
        SocialSciences,

        [Description("Histoire & Arch√©ologie")]
        History,

        [Description("G√©ographie & Sciences de la Terre")]
        Geography,

        [Description("Espace & Physique")]
        SpacePhysics,

        [Description("Ing√©nierie & Technologie")]
        Engineering,

        [Description("√âconomie & Gestion")]
        Economics
    }
}




FILE: \AdRev.Domain\Enums\StudyType.cs
------------------------------------
namespace AdRev.Domain.Enums
{
    using System.ComponentModel;

    public enum StudyType
    {
        [Description("Quantitative")]
        Quantitative,
        
        [Description("Qualitative")]
        Qualitative,
        
        [Description("Mixte")]
        Mixed
    }
}




FILE: \AdRev.Domain\Enums\VariableType.cs
------------------------------------
using System.ComponentModel;

namespace AdRev.Domain.Enums
{
    /// <summary>
    /// Types de variables disponibles pour la cr√©ation de masques de saisie (style Epi Info)
    /// </summary>
    public enum VariableType
    {
        [Description("Texte Court (ex: Nom, Ville)")]
        Text,

        [Description("Texte Long (ex: Commentaires)")]
        Memo,

        [Description("Quantitative Discr√®te (Nombre Entier)")]
        QuantitativeDiscrete, // Was NumberInteger

        [Description("Quantitative Continue (Nombre D√©cimal)")]
        QuantitativeContinuous, // Was NumberDecimal

        [Description("Quantitative Temporelle (Date)")]
        QuantitativeTemporal, // Was Date

        [Description("Quantitative Temporelle (Heure)")]
        Time,

        [Description("Qualitative Binaire (Oui/Non)")]
        QualitativeBinary, // Was YesNo

        [Description("Qualitative Nominale (Choix Unique)")]
        QualitativeNominal, // Was SingleChoice

        [Description("Qualitative Ordinale (Choix Ordonn√©)")]
        QualitativeOrdinal,

        [Description("Qualitative Cat√©gorielle (Choix Multiples)")]
        MultipleChoice,

        [Description("Calcul√© / Formule")]
        Calculated,

        [Description("Label / Titre de section")]
        LabelOnly,
        
        [Description("G√©olocalisation (Point unique, GPS)")]
        GeolocationPoint,
        
        [Description("G√©olocalisation (Zone, Polygone)")]
        GeolocationZone
    }
}




FILE: \AdRev.Domain\Methodology\MethodologyCheck.cs
------------------------------------
using AdRev.Domain.Protocols;

namespace AdRev.Domain.Methodology
{
    public class MethodologyCheck
    {
        public ResearchProtocol Protocol { get; private set; }
        public bool TitleFilled { get; private set; }
        public bool ResearchQuestionFilled { get; private set; }
        public bool GeneralObjectiveFilled { get; private set; }
        public bool SpecificObjectivesFilled { get; private set; }

        public MethodologyCheck(ResearchProtocol protocol)
        {
            Protocol = protocol;
            TitleFilled = !string.IsNullOrWhiteSpace(protocol.Title);
            ResearchQuestionFilled = !string.IsNullOrWhiteSpace(protocol.ResearchQuestion);
            GeneralObjectiveFilled = !string.IsNullOrWhiteSpace(protocol.GeneralObjective);
            SpecificObjectivesFilled = !string.IsNullOrWhiteSpace(protocol.SpecificObjectives);
        }

        public bool IsValid()
        {
            return TitleFilled && ResearchQuestionFilled &&
                   GeneralObjectiveFilled && SpecificObjectivesFilled;
        }
    }
}




FILE: \AdRev.Domain\Models\AnalysisPlanItem.cs
------------------------------------
using System;
using System.Collections.Generic;

namespace AdRev.Domain.Models
{
    public class AnalysisPlanItem
    {
        public string Title { get; set; } = string.Empty;
        public string TestType { get; set; } = string.Empty; // e.g., "Descriptive", "T-Test", "ANOVA", "Regression"
        public string Description { get; set; } = string.Empty; // Auto-generated or manual text
        
        // Selected variable names
        public List<string> Variables { get; set; } = new List<string>();

        // Status
        public bool IsExecuted { get; set; }
        public string ResultSummary { get; set; } = string.Empty;

        public AnalysisPlanItem() { }
    }
}




FILE: \AdRev.Domain\Models\Author.cs
------------------------------------
namespace AdRev.Domain.Models
{
    public enum UserAccessLevel
    {
        [System.ComponentModel.Description("Lecteur")]
        Viewer,
        [System.ComponentModel.Description("√âditeur")]
        Editor,
        [System.ComponentModel.Description("Chef de Projet")]
        Admin
    }

    public enum FunctionalRole
    {
        [System.ComponentModel.Description("Investigateur Principal")]
        PrincipalInvestigator,
        [System.ComponentModel.Description("M√©thodologiste")]
        Methodologist,
        [System.ComponentModel.Description("Statisticien")]
        Statistician,
        [System.ComponentModel.Description("Data Manager")]
        DataManager,
        [System.ComponentModel.Description("Co-Investigateur")]
        CoInvestigator,
        [System.ComponentModel.Description("Moniteur / ARC")]
        Monitor,
        [System.ComponentModel.Description("√âtudiant / Stagiaire")]
        Student
    }

    public class Author
    {
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Title { get; set; } = string.Empty; // Prof, Dr, Mr, Mme...
        public string Institution { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        
        public UserAccessLevel AccessLevel { get; set; } = UserAccessLevel.Editor;
        public FunctionalRole Role { get; set; } = FunctionalRole.PrincipalInvestigator;

        public override string ToString()
        {
            return $"{Title} {FirstName} {LastName} ({Institution}) - {Role} ({AccessLevel})";
        }
    }
}




FILE: \AdRev.Domain\Models\Citation.cs
------------------------------------
using System;

namespace AdRev.Domain.Models;

public class Citation
{
    public string Id { get; set; } = Guid.NewGuid().ToString();
    public string Authors { get; set; } = string.Empty; // "Smith J, Doe A"
    public string Year { get; set; } = string.Empty;
    public string Title { get; set; } = string.Empty;
    public string Source { get; set; } = string.Empty; // Journal, Publisher, URL
    public string Journal { get; set; } = string.Empty;
    public string Volume { get; set; } = string.Empty;
    public string Issue { get; set; } = string.Empty;
    public string Pages { get; set; } = string.Empty;
    public string Doi { get; set; } = string.Empty;
    public string FormattedString { get; set; } = string.Empty; // Cache
}




FILE: \AdRev.Domain\Models\JournalSubmissionCriteria.cs
------------------------------------
using System;
using System.Collections.Generic;

namespace AdRev.Domain.Models
{
    public class JournalSubmissionCriteria
    {
        public string JournalName { get; set; } = string.Empty;
        public string Publisher { get; set; } = string.Empty;
        public List<string> Specialties { get; set; } = new List<string>(); // e.g. "Primary Care", "General Medicine"
        
        // General Constraints
        public int MaxWordCountAbstract { get; set; }
        public int MaxWordCountBody { get; set; }
        public int MaxFiguresAndTables { get; set; }
        public int MaxReferences { get; set; }
        
        // Structure Requirements
        public bool RequiresStructuredAbstract { get; set; } // e.g., Background, Methods, Results, Conclusion
        public List<string> RequiredSections { get; set; } = new List<string>();
        
        // Formatting Style
        public string CitationStyle { get; set; } = string.Empty; // e.g., "Vancouver", "APA"
        public string FontRequirements { get; set; } = string.Empty;
        
        // Submission Info
        public string SubmissionUrl { get; set; } = string.Empty;
        public string GuidelinesUrl { get; set; } = string.Empty;

        public JournalSubmissionCriteria() { }
    }
}




FILE: \AdRev.Domain\Models\LicenseModels.cs
------------------------------------
using System;

namespace AdRev.Domain.Models
{
    public enum LicenseType
    {
        Lifetime,
        Annual,
        Enterprise,
        Student,
        Trial
    }

    public class LicenseMetadata
    {
        public string Hwid { get; set; } = string.Empty;
        public LicenseType Type { get; set; } = LicenseType.Lifetime;
        public DateTime ExpiryDate { get; set; } = DateTime.MaxValue;
        public int MaxSeats { get; set; } = 1;
        
        /// <summary>
        /// Email du client enregistr√© (Affichage Pro).
        /// </summary>
        public string RegisteredEmail { get; set; } = string.Empty;

        /// <summary>
        /// Label commercial (ex: "Licence √âtudiant - Mali").
        /// </summary>
        public string FeaturesLabel { get; set; } = string.Empty;

        public string Signature { get; set; } = string.Empty;
    }
}




FILE: \AdRev.Domain\Models\QualitativeDataModels.cs
------------------------------------
using System;
using System.Collections.Generic;

namespace AdRev.Domain.Models
{
    public class QualitativeSource
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string Name { get; set; } = string.Empty;
        public string FilePath { get; set; } = string.Empty;
        public string Type { get; set; } = "Document"; // "Transcription", "Audio", "PDF"
        public string Content { get; set; } = string.Empty; // For text content
        public DateTime ImportDate { get; set; } = DateTime.Now;
        
        public double? Latitude { get; set; }
        public double? Longitude { get; set; }
    }

    public class QualitativeCode
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string Name { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string ParentId { get; set; } = string.Empty; // For hierarchy
        public string Color { get; set; } = "#CCCCCC";
        public List<QualitativeCodeSegment> Segments { get; set; } = new List<QualitativeCodeSegment>();
    }

    public class QualitativeCodeSegment
    {
        public string SourceId { get; set; } = string.Empty;
        public int StartIndex { get; set; }
        public int Length { get; set; }
        public string SelectedText { get; set; } = string.Empty;
    }
}




FILE: \AdRev.Domain\Models\ResearchProject.cs
------------------------------------
using System;
using AdRev.Domain.Enums;
using AdRev.Domain.Variables;
using System.Collections.Generic;
using System.ComponentModel;

namespace AdRev.Domain.Models
{
    public enum ProjectStatus
    {
        [Description("En Cours")]
        Ongoing,
        [Description("TerminÈ")]
        Completed,
        [Description("AcceptÈ / ValidÈ")]
        Accepted,
        [Description("PubliÈ")]
        Published,
        [Description("ArchivÈ")]
        Archived
    }

    public class ResearchProject
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string Title { get; set; } = string.Empty;
        public string Version { get; set; } = "1.0.0"; // Semantic Versioning


        public StudyType StudyType { get; set; }
        public ScientificDomain Domain { get; set; } = ScientificDomain.Biomedical;
        public EpidemiologicalStudyType EpidemiologyType { get; set; }
        public ProjectContext Context { get; set; }
        public AcademicLevel AcademicLevel { get; set; } = AcademicLevel.Thesis;
        public string TargetJournalName { get; set; } = string.Empty;
        // Serialized JSON of journal criteria if needed, or just the name to lookup
        public string TargetJournalCriteriaJson { get; set; } = string.Empty; 

        public string Authors { get; set; } = string.Empty;
        public string Institution { get; set; } = string.Empty;

        public string? FilePath { get; set; }

        public ProjectStatus Status { get; set; } = ProjectStatus.Ongoing;

        public DateTime? PublicationDate { get; set; }
        public string PublicationReference { get; set; } = string.Empty; // Volume, Issue, DOI
        public int AuthorRank { get; set; } = 1; // 1 = First Author

        // Link to Protocol
        public string? SourceProtocolId { get; set; } 

        public DateTime CreatedOn { get; set; } = DateTime.Now;
        public List<StudyVariable> Variables { get; set; } = new List<StudyVariable>();

        // Protocol Data linked to Project
        public string ProblemJustification { get; set; } = string.Empty;
        public string GeneralObjective { get; set; } = string.Empty;
        public string SpecificObjectives { get; set; } = string.Empty; // text blob for now
        
        // This holds the textual SAP from the protocol
        public string DataAnalysisPlan { get; set; } = string.Empty;

        // Results & Discussion (Persisted)
        public string DiscussionContent { get; set; } = string.Empty;
        public string LimitationsContent { get; set; } = string.Empty;
        public string ConclusionContent { get; set; } = string.Empty;
        public List<Citation> References { get; set; } = new List<Citation>();

        public List<Author> Team { get; set; } = new List<Author>();

        // Qualitative Data
        public List<QualitativeSource> QualitativeSources { get; set; } = new List<QualitativeSource>();
        public List<QualitativeCode> QualitativeCodes { get; set; } = new List<QualitativeCode>();
    }
}




FILE: \AdRev.Domain\Protocols\ResearchProtocol.cs
------------------------------------
using AdRev.Domain.Enums;
using AdRev.Domain.Models;
using System;
using System.Collections.Generic;

namespace AdRev.Domain.Protocols;

public class ResearchProtocol
{
    public string Id { get; set; } = Guid.NewGuid().ToString();
    public string? ProjectId { get; set; }
    public string Title { get; set; } = string.Empty;
    
    // Auteurs structurÈs
    public Author PrincipalAuthor { get; set; } = new Author();
    public List<Author> CoAuthors { get; set; } = new List<Author>();

    public DateTime CreatedAt { get; set; } = DateTime.Now;

    // Introduction Split
    public string Context { get; set; } = string.Empty;
    public string ProblemJustification { get; set; } = string.Empty;

    public string ResearchQuestion { get; set; } = string.Empty; // Max 3
    public string Hypotheses { get; set; } = string.Empty;       // Max 2
    
    public string GeneralObjective { get; set; } = string.Empty;
    public string SpecificObjectives { get; set; } = string.Empty;
    public string ConceptDefinitions { get; set; } = string.Empty; // DÈfinition des concepts

    public StudyType StudyType { get; set; }
    public ScientificDomain Domain { get; set; } = ScientificDomain.Biomedical;
    public QualitativeApproach QualitativeApproach { get; set; }
    public EpidemiologicalStudyType EpidemiologyType { get; set; }

    // Methodology Split
    public string StudySetting { get; set; } = string.Empty;       // Cadre de l'Ètude
    public string ConceptualModel { get; set; } = string.Empty;    // ModËle Conceptuel
    
    // CaractÈristiques de l'Ètude
    public bool IsMulticentric { get; set; } = false;              // …tude multicentrique
    public string StudyCenters { get; set; } = string.Empty;       // Liste des centres participants
    
    public string StudyPopulation { get; set; } = string.Empty;    // Population
    public string InclusionCriteria { get; set; } = string.Empty;
    public string ExclusionCriteria { get; set; } = string.Empty;
    
    // …chantillonnage avancÈ
    public SamplingType SamplingType { get; set; } = SamplingType.None;
    public bool IsStratified { get; set; } = false;                // …chantillonnage stratifiÈ
    public string StratificationCriteria { get; set; } = string.Empty; // CritËres de stratification
    public bool IsClusterSampling { get; set; } = false;           // …chantillonnage en grappe
    public int ClusterSize { get; set; } = 0;                      // Taille moyenne des grappes
    public double DesignEffect { get; set; } = 1.0;                // Effet de plan (Deff)
    public double ExpectedLossRate { get; set; } = 0.0;            // Taux de perdus de vue attendu (%)
    
    public string SamplingMethod { get; set; } = string.Empty;     // Texte descriptif final de l'Èchantillonnage
    public string DataCollection { get; set; } = string.Empty;     // Collecte (outils/variables)
    public string DataAnalysis { get; set; } = string.Empty;       // Plan d'analyse

    public string Ethics { get; set; } = string.Empty;
    public string Budget { get; set; } = string.Empty; // Budget prÈvisionnel
    public string ExpectedResults { get; set; } = string.Empty;
    
    // Discussion et Limites
    public string DiscussionPlan { get; set; } = string.Empty;
    public string StudyLimitations { get; set; } = string.Empty;

    public string Conclusion { get; set; } = string.Empty;
    public string References { get; set; } = string.Empty;

    // Dictionnaire des Variables (Style Epi Info - Masque de Saisie)
    public List<AdRev.Domain.Variables.StudyVariable> Variables { get; set; } = new List<AdRev.Domain.Variables.StudyVariable>();

    // Gestion Bibliographique
    public ReferenceStyle ReferenceStyle { get; set; } = ReferenceStyle.Vancouver;
    public List<Citation> Citations { get; set; } = new List<Citation>();
}



FILE: \AdRev.Domain\Quality\QualityChecklist.cs
------------------------------------
using System.Collections.Generic;

namespace AdRev.Domain.Quality
{
    public class QualityChecklist
    {
        public string Name { get; set; } = string.Empty; // e.g., "COREQ", "STROBE"
        public string Description { get; set; } = string.Empty;
        public string SourceUrl { get; set; } = string.Empty;
        public List<ChecklistSection> Sections { get; set; } = new List<ChecklistSection>();
    }

    public class ChecklistSection
    {
        public string Name { get; set; } = string.Empty; // e.g., "Domain 1: Research Team"
        public List<ChecklistItem> Items { get; set; } = new List<ChecklistItem>();
    }

    public class ChecklistItem
    {
        public string Id { get; set; } = string.Empty;
        public string Requirement { get; set; } = string.Empty; // The question/requirement
        public string Description { get; set; } = string.Empty; // More details
        public bool IsMet { get; set; } = false;
        public string UserNotes { get; set; } = string.Empty;
    }
}




FILE: \AdRev.Domain\Variables\StudyVariable.cs
------------------------------------
using AdRev.Domain.Enums;
using System.Collections.Generic;

namespace AdRev.Domain.Variables
{
    /// <summary>
    /// Repr√©sente une variable d'√©tude (une question dans le masque de saisie)
    /// Inspir√© de la structure de m√©tadonn√©es d'Epi Info 7
    /// </summary>
    public class StudyVariable
    {
        /// <summary>
        /// Nom de la variable dans la base de donn√©es (ex: "DATENAISS")
        /// Doit √™tre court, sans espace, unique.
        /// </summary>
        public string Name { get; set; } = string.Empty;
        public string Prompt { get; set; } = string.Empty;

        /// <summary>
        /// Le type de donn√©es (Texte, Nombre, Date...)
        /// </summary>
        public VariableType Type { get; set; }

        /// <summary>
        /// Indique si la r√©ponse est obligatoire
        /// </summary>
        public bool IsRequired { get; set; }

        /// <summary>
        /// Pour les types num√©riques : valeur minimale accept√©e
        /// </summary>
        public double? MinValue { get; set; }

        /// <summary>
        /// Pour les types num√©riques : valeur maximale accept√©e
        /// </summary>
        public double? MaxValue { get; set; }

        /// <summary>
        /// Pour les types Text : longueur maximale
        /// </summary>
        public int MaxLength { get; set; } = 255;

        /// <summary>
        /// Pour les listes de choix : les options disponibles (s√©par√©es par des virgules ou stock√©es ailleurs)
        /// Ex: "Masculin,F√©minin"
        /// </summary>
        public string ChoiceOptions { get; set; } = string.Empty;

        /// <summary>
        /// Groupe ou Section auquel appartient la variable (pour organiser la page)
        /// Ex: "Donn√©es Sociod√©mographiques", "Donn√©es Cliniques"
        /// </summary>
        public string GroupName { get; set; } = string.Empty;

        /// <summary>
        /// Pour les √©tudes qualitatives d√©ductives : Th√®me majeur de codification
        /// </summary>
        public string Theme { get; set; } = string.Empty;
        public string SubTheme { get; set; } = string.Empty;

        /// <summary>
        /// Indique si cette variable est un attribut de cas (pour le qualitatif).
        /// </summary>
        public bool IsQualitativeCaseAttribute { get; set; }

        /// <summary>
        /// Nom de la feuille de classification (ex: "Sociod√©mographique") pour le qualitatif.
        /// </summary>
        public string ClassificationSheet { get; set; } = string.Empty;

        /// <summary>
        /// Ordre d'affichage dans le masque
        /// </summary>
        public int SortOrder { get; set; }

        /// <summary>
        /// Note ou instruction pour l'enqu√™teur
        /// </summary>
        public string Description { get; set; } = string.Empty;

        /// <summary>
        /// Logique de saut (Skip Pattern)
        /// Ex: "Si NON, aller √† Q10" ou condition formelle
        /// </summary>
        public string SkipLogic { get; set; } = string.Empty;

        /// <summary>
        /// Formule pour les champs calcul√©s
        /// Ex: "[POIDS] / ([TAILLE] * [TAILLE])"
        /// </summary>
        public string CalculationFormula { get; set; } = string.Empty;

        /// <summary>
        /// Condition pour que cette question soit pos√©e
        /// Ex: "[SEXE] = 'Femme'"
        /// </summary>
        public string VisibilityCondition { get; set; } = string.Empty;

        /// <summary>
        /// Coordonn√©es par d√©faut pour les variables de g√©olocalisation
        /// </summary>
        public double? DefaultLatitude { get; set; }
        public double? DefaultLongitude { get; set; }

        public StudyVariable()
        {
            Type = VariableType.Text;
            IsRequired = false;
        }

        public override string ToString()
        {
            return $"{Name} ({Type}) - {Prompt}";
        }
    }
}




FILE: \AdRev.LicenseGenerator\App.xaml
------------------------------------
<Application x:Class="AdRev.LicenseGenerator.App"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             StartupUri="MainWindow.xaml">
    <Application.Resources>
         
    </Application.Resources>
</Application>




FILE: \AdRev.LicenseGenerator\App.xaml.cs
------------------------------------
using System.Windows;

namespace AdRev.LicenseGenerator
{
    public partial class App : Application
    {
    }
}




FILE: \AdRev.LicenseGenerator\MainWindow.xaml
------------------------------------
<Window x:Class="AdRev.LicenseGenerator.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="AdRev License Master - USB &amp; Institutional" Height="720" Width="750"
        WindowStartupLocation="CenterScreen" Background="#1E1E2E">
    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <Grid Margin="30">
            <StackPanel>
                <TextBlock Text="üîë AdRev License Master" FontSize="28" FontWeight="Bold" Foreground="White" Margin="0,0,0,5"/>
                <TextBlock Text="G√©n√©ration de licences USB, Annuelles et Institutionnelles" Foreground="#A0A0B0" Margin="0,0,0,25"/>

                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    
                    <StackPanel Grid.Column="0" Margin="0,0,10,0">
                        <TextBlock Text="Hardware ID du Client :" Foreground="White" Margin="0,0,0,5"/>
                        <TextBox x:Name="HwidInput" Height="40" Padding="10" FontSize="16" Background="#2B2B3B" Foreground="White" BorderBrush="#3B3B4B"/>
                        <TextBlock Text="(Laissez vide pour licence institutionnelle g√©n√©rique)" Foreground="#707080" FontSize="10" Margin="0,5,0,0"/>
                    </StackPanel>

                    <StackPanel Grid.Column="1" Margin="10,0,0,0">
                        <TextBlock Text="Type de Licence :" Foreground="White" Margin="0,0,0,5"/>
                        <ComboBox x:Name="TypeCombo" Height="40" Background="#2B2B3B" Foreground="Black" Padding="10,8" SelectionChanged="TypeCombo_SelectionChanged">
                            <ComboBoxItem Content="√Ä Vie (Lifetime)" IsSelected="True" Tag="Lifetime"/>
                            <ComboBoxItem Content="Annuel (Subscription)" Tag="Annual"/>
                            <ComboBoxItem Content="Institutionnelle (Institution)" Tag="Institutional"/>
                        </ComboBox>
                    </StackPanel>
                </Grid>

                <Grid Margin="0,20,0,0" x:Name="AnnualOptions" Visibility="Collapsed">
                    <StackPanel>
                        <TextBlock Text="Dur√©e : 365 Jours √† partir d'aujourd'hui" Foreground="#00E676" FontWeight="SemiBold"/>
                    </StackPanel>
                </Grid>

                <Grid Margin="0,20,0,0" x:Name="InstitutionalOptions" Visibility="Collapsed">
                    <StackPanel>
                        <TextBlock Text="Nombre de Postes autoris√©s (Max 7) :" Foreground="White" Margin="0,0,0,5"/>
                        <Slider x:Name="SeatsSlider" Minimum="1" Maximum="7" Value="7" TickFrequency="1" IsSnapToTickEnabled="True"/>
                        <TextBlock Text="{Binding Value, ElementName=SeatsSlider, StringFormat='{}Postes: {0}'}" Foreground="#00E676" HorizontalAlignment="Right"/>
                    </StackPanel>
                </Grid>

                <Button Content="G√©n√©rer la Cl√© S√©curis√©e" Click="Generate_Click" Height="50" Margin="0,40,0,0" 
                        Background="#7C4DFF" Foreground="White" FontSize="16" FontWeight="Bold">
                    <Button.Resources>
                        <Style TargetType="Border">
                            <Setter Property="CornerRadius" Value="8"/>
                        </Style>
                    </Button.Resources>
                </Button>

                <Separator Margin="0,40" Background="#3B3B4B"/>

                <TextBlock Text="Code d'Activation √† fournir :" Foreground="White" Margin="0,0,0,5"/>
                <TextBox x:Name="LicenseOutput" Height="120" Padding="10" FontSize="12" IsReadOnly="True" 
                         TextWrapping="Wrap" Background="#161621" Foreground="#00E676" BorderBrush="#3B3B4B" VerticalScrollBarVisibility="Auto"/>
                
                <Button Content="Copier le code" Click="Copy_Click" Height="45" Margin="0,15,0,30"
                        Background="#3B3B4B" Foreground="White" BorderBrush="#555" BorderThickness="1" Cursor="Hand">
                    <Button.Resources>
                        <Style TargetType="Border">
                            <Setter Property="CornerRadius" Value="8"/>
                        </Style>
                    </Button.Resources>
                </Button>
            </StackPanel>
        </Grid>
    </ScrollViewer>
</Window>




FILE: \AdRev.LicenseGenerator\MainWindow.xaml.cs
------------------------------------
using System;
using System.IO;
using System.Security.Cryptography;
using System.Text;
using System.Text.Json;
using System.Windows;
using System.Windows.Controls;

namespace AdRev.LicenseGenerator
{
    public enum LicenseType { Lifetime, Annual, Institutional }

    public class LicenseMetadata
    {
        public string Hwid { get; set; } = string.Empty;
        public LicenseType Type { get; set; } = LicenseType.Lifetime;
        public DateTime ExpiryDate { get; set; } = DateTime.MaxValue;
        public int MaxSeats { get; set; } = 1;
        public string Signature { get; set; } = string.Empty;
    }

    public partial class MainWindow : Window
    {
        private const string SecretSalt = "AdRev_Security_2026_Robust_Research_System_V2";

        public MainWindow()
        {
            InitializeComponent();
        }

        private void TypeCombo_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (AnnualOptions == null || InstitutionalOptions == null) return;

            var item = TypeCombo.SelectedItem as ComboBoxItem;
            string tag = item?.Tag?.ToString() ?? "";

            AnnualOptions.Visibility = (tag == "Annual") ? Visibility.Visible : Visibility.Collapsed;
            InstitutionalOptions.Visibility = (tag == "Institutional") ? Visibility.Visible : Visibility.Collapsed;
        }

        private void Generate_Click(object sender, RoutedEventArgs e)
        {
            string hwid = HwidInput.Text.Trim().ToUpper();
            var item = TypeCombo.SelectedItem as ComboBoxItem;
            string tag = item?.Tag?.ToString() ?? "Lifetime";

            var metadata = new LicenseMetadata();
            metadata.Hwid = hwid;

            if (tag == "Lifetime")
            {
                metadata.Type = LicenseType.Lifetime;
                metadata.ExpiryDate = DateTime.MaxValue;
                metadata.MaxSeats = 1;
            }
            else if (tag == "Annual")
            {
                metadata.Type = LicenseType.Annual;
                metadata.ExpiryDate = DateTime.UtcNow.AddYears(1);
                metadata.MaxSeats = 1;
            }
            else // Institutional
            {
                metadata.Type = LicenseType.Institutional;
                metadata.ExpiryDate = DateTime.MaxValue;
                metadata.MaxSeats = (int)SeatsSlider.Value;
                if (string.IsNullOrEmpty(hwid)) metadata.Hwid = "INSTITUTIONAL-GENERIC";
            }

            // Create Signature
            string dataToSign = $"{metadata.Hwid}|{metadata.Type}|{metadata.ExpiryDate:yyyy-MM-dd}|{metadata.MaxSeats}";
            metadata.Signature = HashString(dataToSign + SecretSalt);

            // Serialize and Encrypt
            string json = JsonSerializer.Serialize(metadata);
            string encrypted = EncryptString(json);

            LicenseOutput.Text = encrypted;
        }

        private void Copy_Click(object sender, RoutedEventArgs e)
        {
            if (!string.IsNullOrEmpty(LicenseOutput.Text))
            {
                Clipboard.SetText(LicenseOutput.Text);
                MessageBox.Show("Code de licence copi√© !", "Succ√®s", MessageBoxButton.OK, MessageBoxImage.Information);
            }
        }

        private string HashString(string input)
        {
            using (var sha256 = SHA256.Create())
            {
                byte[] bytes = sha256.ComputeHash(Encoding.UTF8.GetBytes(input));
                return BitConverter.ToString(bytes).Replace("-", "");
            }
        }

        private string EncryptString(string plainText)
        {
            byte[] iv = new byte[16];
            byte[] array;

            using (Aes aes = Aes.Create())
            {
                aes.Key = Encoding.UTF8.GetBytes(SecretSalt.Substring(0, 32));
                aes.IV = iv;
                ICryptoTransform encryptor = aes.CreateEncryptor(aes.Key, aes.IV);

                using (MemoryStream memoryStream = new MemoryStream())
                {
                    using (CryptoStream cryptoStream = new CryptoStream(memoryStream, encryptor, CryptoStreamMode.Write))
                    {
                        using (StreamWriter streamWriter = new StreamWriter(cryptoStream))
                        {
                            streamWriter.Write(plainText);
                        }
                        array = memoryStream.ToArray();
                    }
                }
            }
            return Convert.ToBase64String(array);
        }
    }
}




FILE: \AdRev.Verify\Program.cs
------------------------------------
using System;
using System.IO;
using System.Security.Cryptography;
using System.Text;

public class Program
{
    private const string SecretSalt = "AdRev_Security_2026_Robust_Research_System_V2";

    public static void Main()
    {
        string cipherText = "7xbEgxKj/8PWLafKsm72PJ9IsnK8F3L13H3z46TiWm1DR2ssTOnnirrUD2sKsziXkHuZBXOjHz1gIN2lM+mdMWRMF7Vx9Kpq8R6J78EimedTQFAvGO3PTOxStNIKMHQvtT+M1IsTXffrkaMH9GTX2SnAh/Q5tW6WXBmDqNTp7tsxzKKCr+31ZDPu4O151srY0HdUa3DZSSLrXVtq/TcYZwk9HnWkH/EmY3H9hDqnj7s=";
        
        try {
            string plainText = DecryptString(cipherText);
            Console.WriteLine("Decrypted Content:");
            Console.WriteLine(plainText);
        } catch (Exception ex) {
            Console.WriteLine("Error: " + ex.Message);
        }
    }

    private static string DecryptString(string cipherText)
    {
        byte[] iv = new byte[16];
        byte[] buffer = Convert.FromBase64String(cipherText);

        using (Aes aes = Aes.Create())
        {
            aes.Key = Encoding.UTF8.GetBytes(SecretSalt.Substring(0, 32));
            aes.IV = iv;
            ICryptoTransform decryptor = aes.CreateDecryptor(aes.Key, aes.IV);

            using (MemoryStream memoryStream = new MemoryStream(buffer))
            {
                using (CryptoStream cryptoStream = new CryptoStream(memoryStream, decryptor, CryptoStreamMode.Read))
                {
                    using (StreamReader streamReader = new StreamReader(cryptoStream))
                    {
                        return streamReader.ReadToEnd();
                    }
                }
            }
        }
    }
}




FILE: \Documentation\CHANGELOG_Methodologie_Avancee.md
------------------------------------
# R√©sum√© des Modifications - M√©thodologie Avanc√©e

## üìÖ Date : Janvier 2026

## üéØ Objectif
Enrichir AdRev pour prendre en charge des m√©thodologies de recherche plus complexes, notamment les √©tudes multicentriques et l'√©chantillonnage en grappe.

## ‚ú® Nouvelles Fonctionnalit√©s

### 1. √âtudes Multicentriques
**Fichiers modifi√©s :**
- `AdRev.Domain/Protocols/ResearchProtocol.cs`
- `AdRev.Desktop/ProtocolWindow.xaml` (√† modifier manuellement)
- `AdRev.Desktop/ProtocolWindow.xaml.cs`

**Champs ajout√©s :**
- `bool IsMulticentric` : Indique si l'√©tude est multicentrique
- `string StudyCenters` : Liste des centres participants

**Interface utilisateur :**
- Checkbox "√âtude Multicentrique"
- Champ texte pour lister les centres (affich√© conditionnellement)

### 2. Types d'√âchantillonnage

**Nouveau fichier :**
- `AdRev.Domain/Enums/SamplingType.cs`

**Types disponibles :**

**Probabilistes :**
- Al√©atoire Simple
- Syst√©matique
- Stratifi√©
- En Grappe (Cluster)
- √Ä Plusieurs Degr√©s
- Stratifi√© en Grappes

**Non Probabilistes :**
- De Convenance
- Raisonn√© (Purposive)
- Boule de Neige
- Par Quotas

**Autres :**
- Exhaustif (Recensement)

### 3. √âchantillonnage Avanc√©

**Champs ajout√©s au mod√®le ResearchProtocol :**
- `SamplingType SamplingType` : Type d'√©chantillonnage (√©num√©ration)
- `bool IsStratified` : √âchantillonnage stratifi√©
- `string StratificationCriteria` : Crit√®res de stratification
- `bool IsClusterSampling` : √âchantillonnage en grappe
- `int ClusterSize` : Taille moyenne des grappes
- `double DesignEffect` : Effet de plan (Deff) pour ajuster la taille d'√©chantillon
- `double ExpectedLossRate` : Taux de perdus de vue attendu (%)

**Interface utilisateur :**
- ComboBox pour s√©lectionner le type d'√©chantillonnage
- Panels conditionnels pour :
  - Stratification (crit√®res)
  - √âchantillonnage en grappe (taille des grappes, effet de design)
  - Taux de perdus de vue

### 4. Logique Dynamique

**Gestionnaires d'√©v√©nements ajout√©s :**
- `IsMulticentricCheckBox_Checked/Unchecked` : Affiche/cache les centres
- `SamplingTypeComboBox_SelectionChanged` : Affiche les panels appropri√©s selon le type
- `IsStratifiedCheckBox_Checked/Unchecked` : Affiche/cache crit√®res de stratification
- `IsClusterCheckBox_Checked/Unchecked` : Affiche/cache param√®tres de grappe

## üìä Formules et Calculs

### Ajustement pour l'Effet de Plan
```
N ajust√© = N calcul√© √ó Design Effect
```

### Ajustement pour Perdus de Vue
```
N final = N ajust√© / (1 - taux de perdus de vue)
```

### Exemple Complet
```
N‚ÇÄ = 384 (Cochran)
N‚ÇÅ = 384 √ó 1.5 (Design Effect) = 576
N final = 576 / 0.90 (10% perdus de vue) = 640 sujets
```

## üìù Documentation Cr√©√©e

**Fichier :** `Documentation/Guide_Methodologie_Avancee.md`

**Contenu :**
1. Vue d'ensemble des nouvelles fonctionnalit√©s
2. Guide des √©tudes multicentriques
3. Description d√©taill√©e de tous les types d'√©chantillonnage
4. Explication de l'effet de plan (Design Effect)
5. Guide sur les perdus de vue
6. Exemple pratique complet avec tous les ajustements
7. Bonnes pratiques et conseils
8. Ressources bibliographiques

## üîß Actions Requises

### ‚ö†Ô∏è IMPORTANT : Modification Manuelle du XAML
Le fichier `AdRev.Desktop/ProtocolWindow.xaml` n√©cessite une modification manuelle en raison de probl√®mes d'encodage.

**Emplacement :** Apr√®s la ligne 237 (apr√®s "Population d'√©tude")

**Code √† ajouter :**

```xml
<!-- Section √âtude Multicentrique -->
<Border Background="#F5F5F5" BorderBrush="#DDDDDD" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,0,0,15">
    <StackPanel>
        <CheckBox x:Name="IsMulticentricCheckBox" Content="√âtude Multicentrique" FontWeight="SemiBold" Margin="0,0,0,10" Checked="IsMulticentricCheckBox_Checked" Unchecked="IsMulticentricCheckBox_Unchecked"/>
        
        <StackPanel x:Name="MulticentricDetailsPanel" Visibility="Collapsed">
            <TextBlock Text="Centres participants (un par ligne) :" Style="{StaticResource LabelStyle}" FontSize="11"/>
            <TextBox x:Name="StudyCentersTextBox" Height="60" TextWrapping="Wrap" AcceptsReturn="True" ToolTip="Listez les centres participants √† l'√©tude"/>
        </StackPanel>
    </StackPanel>
</Border>
```

**Puis, apr√®s les crit√®res d'inclusion/exclusion (ligne 254), ajouter :**

```xml
<!-- Section √âchantillonnage Avanc√© -->
<Border Background="#FFF9E6" BorderBrush="#FFD700" BorderThickness="1" CornerRadius="5" Padding="10" Margin="0,10,0,15">
    <StackPanel>
        <TextBlock Text="‚öôÔ∏è Configuration de l'√âchantillonnage" FontWeight="Bold" FontSize="13" Margin="0,0,0,10"/>
        
        <TextBlock Text="Type d'√©chantillonnage :" Style="{StaticResource LabelStyle}" FontSize="11"/>
        <ComboBox x:Name="SamplingTypeComboBox" Height="32" Padding="8" VerticalContentAlignment="Center" FontSize="12" Margin="0,0,0,10" SelectionChanged="SamplingTypeComboBox_SelectionChanged"/>
        
        <!-- Options Stratification -->
        <StackPanel x:Name="StratificationPanel" Visibility="Collapsed" Margin="0,0,0,10">
            <CheckBox x:Name="IsStratifiedCheckBox" Content="√âchantillonnage stratifi√©" FontSize="11" Margin="0,0,0,5" Checked="IsStratifiedCheckBox_Checked" Unchecked="IsStratifiedCheckBox_Unchecked"/>
            <StackPanel x:Name="StratificationDetailsPanel" Visibility="Collapsed">
                <TextBlock Text="Crit√®res de stratification :" FontSize="10" Foreground="#666" Margin="15,0,0,2"/>
                <TextBox x:Name="StratificationCriteriaTextBox" Height="40" TextWrapping="Wrap" AcceptsReturn="True" Margin="15,0,0,0" FontSize="11" ToolTip="Ex: √Çge, Sexe, R√©gion g√©ographique..."/>
            </StackPanel>
        </StackPanel>
        
        <!-- Options Grappe -->
        <StackPanel x:Name="ClusterPanel" Visibility="Collapsed" Margin="0,0,0,10">
            <CheckBox x:Name="IsClusterCheckBox" Content="√âchantillonnage en grappe" FontSize="11" Margin="0,0,0,5" Checked="IsClusterCheckBox_Checked" Unchecked="IsClusterCheckBox_Unchecked"/>
            <StackPanel x:Name="ClusterDetailsPanel" Visibility="Collapsed">
                <Grid Margin="15,0,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="10"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel>
                        <TextBlock Text="Taille moyenne des grappes :" FontSize="10" Foreground="#666"/>
                        <TextBox x:Name="ClusterSizeTextBox" Height="28" FontSize="11" ToolTip="Nombre moyen de sujets par grappe"/>
                    </StackPanel>
                    <StackPanel Grid.Column="2">
                        <TextBlock Text="Effet de plan (Design Effect) :" FontSize="10" Foreground="#666"/>
                        <TextBox x:Name="DesignEffectTextBox" Text="1.5" Height="28" FontSize="11" ToolTip="G√©n√©ralement entre 1.5 et 2.0"/>
                    </StackPanel>
                </Grid>
            </StackPanel>
        </StackPanel>
        
        <!-- Taux de perdus de vue -->
        <Grid Margin="0,5,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="10"/>
                <ColumnDefinition Width="100"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <TextBlock Text="Taux de perdus de vue attendu :" VerticalAlignment="Center" FontSize="11"/>
            <TextBox x:Name="ExpectedLossRateTextBox" Grid.Column="2" Text="10" Height="28" FontSize="11" VerticalContentAlignment="Center" ToolTip="En pourcentage"/>
            <TextBlock Grid.Column="3" Text=" %" VerticalAlignment="Center" FontSize="11" Margin="5,0,0,0"/>
        </Grid>
    </StackPanel>
</Border>
```

## ‚úÖ Fichiers Modifi√©s Automatiquement

1. ‚úÖ `AdRev.Domain/Protocols/ResearchProtocol.cs` - Mod√®le enrichi
2. ‚úÖ `AdRev.Domain/Enums/SamplingType.cs` - Nouvelle √©num√©ration cr√©√©e
3. ‚úÖ `AdRev.Desktop/ProtocolWindow.xaml.cs` - Logique ajout√©e
4. ‚úÖ `Documentation/Guide_Methodologie_Avancee.md` - Documentation cr√©√©e

## ‚è≥ √Ä Faire Manuellement

1. ‚ö†Ô∏è `AdRev.Desktop/ProtocolWindow.xaml` - Ajouter les sections UI (voir code ci-dessus)
2. üîÑ Mettre √† jour `ProtocolValidator.cs` si n√©cessaire pour valider les nouveaux champs
3. üîÑ Mettre √† jour les services d'export (Word, PDF) pour inclure les nouvelles informations

## üß™ Tests √† Effectuer

1. **Test Multicentrique :**
   - Cocher/d√©cocher "√âtude Multicentrique"
   - V√©rifier l'affichage du champ centres
   - Sauvegarder et v√©rifier la persistence

2. **Test √âchantillonnage Stratifi√© :**
   - S√©lectionner "Stratifi√©" dans le type
   - Cocher "√âchantillonnage stratifi√©"
   - Entrer des crit√®res

3. **Test √âchantillonnage en Grappe :**
   - S√©lectionner "En Grappe (Cluster)"
   - Cocher "√âchantillonnage en grappe"
   - Entrer taille des grappes et effet de design
   - V√©rifier les calculs

4. **Test Combin√© :**
   - √âtude multicentrique + √©chantillonnage en grappe stratifi√©
   - Avec perdus de vue
   - Valider la coh√©rence des donn√©es sauvegard√©es

## üìö R√©f√©rences Utilis√©es

1. OMS : Sample Size Determination in Health Studies
2. Bennett S. et al. (1991). A simplified general method for cluster-sample surveys
3. Lwanga SK, Lemeshow S. (1991). Sample size determination in health studies
4. Cochran WG. (1977). Sampling Techniques. 3rd ed.

## üéì Cas d'Usage Typiques

### Cas 1 : Enqu√™te de pr√©valence en milieu rural
- Type : Transversale descriptive
- √âchantillonnage : En grappe (villages)
- Design Effect : 1.8
- Multicentrique : 3 districts

### Cas 2 : Essai clinique multicentrique
- Type : ERC
- √âchantillonnage : Al√©atoire simple
- Multicentrique : 5 h√¥pitaux
- Stratifi√© : Par centre
- Perdus de vue : 15%

### Cas 3 : √âtude cas-t√©moins appari√©s
- Type : Cas-T√©moins
- √âchantillonnage : Appari√© (existant)
- Stratifi√© : √Çge, sexe
- Multicentrique : Non

---

**Note :** Cette mise √† jour apporte des capacit√©s de niveau professionnel √† AdRev, permettant de g√©rer des protocoles de recherche complexes conformes aux standards internationaux.




FILE: \Documentation\Guide_Methodologie_Avancee.md
------------------------------------
# Guide : M√©thodologie Avanc√©e - √âtudes Multicentriques et √âchantillonnage en Grappe

## Vue d'ensemble

AdRev a √©t√© enrichi pour prendre en charge des m√©thodologies de recherche plus complexes, notamment :

- **√âtudes Multicentriques** : √âtudes men√©es dans plusieurs centres/sites
- **√âchantillonnage en Grappe (Cluster Sampling)** : M√©thode d'√©chantillonnage o√π les sujets sont group√©s
- **√âchantillonnage Stratifi√©** : Division de la population en sous-groupes homog√®nes
- **Effet de Plan (Design Effect)** : Correction de la taille d'√©chantillon pour les designs complexes
- **Taux de Perdus de Vue** : Prise en compte des abandons/perdus de vue

## 1. √âtudes Multicentriques

### Quand utiliser ?
- Lorsque l'√©tude se d√©roule dans plusieurs h√¥pitaux, cliniques ou centres de recherche
- Pour augmenter la taille de l'√©chantillon
- Pour am√©liorer la g√©n√©ralisabilit√© des r√©sultats

### Configuration
1. Cocher la case **"√âtude Multicentrique"**
2. Lister les centres participants (un par ligne) dans le champ qui appara√Æt

### Exemple
```
Centre Hospitalier Universitaire de Bamako
H√¥pital Gabriel Tour√©
Centre de Sant√© de R√©f√©rence de Koulikoro
```

## 2. Types d'√âchantillonnage

### √âchantillonnage Probabiliste

#### a) Al√©atoire Simple
- Chaque sujet a la m√™me probabilit√© d'√™tre s√©lectionn√©
- Le plus simple, mais peut √™tre difficile si la population est dispers√©e

#### b) Syst√©matique  
- S√©lection d'un sujet tous les k individus (ex: 1 personne sur 10)
- Facile √† mettre en ≈ìuvre

#### c) Stratifi√©
- Division de la population en strates (groupes homog√®nes)
- √âchantillonnage al√©atoire dans chaque strate
- **Exemple de crit√®res de stratification** : √¢ge, sexe, niveau socio-√©conomique, zone g√©ographique

**Configuration :**
1. S√©lectionner "Stratifi√©" dans le type d'√©chantillonnage
2. Cocher "√âchantillonnage stratifi√©"
3. Pr√©ciser les crit√®res (ex: "√Çge (<40 ans, ‚â•40 ans), Sexe (Homme, Femme)")

#### d) En Grappe (Cluster Sampling)
- S√©lection de groupes (grappes) plut√¥t que d'individus
- Utile quand la population est g√©ographiquement dispers√©e
- **Exemples de grappes** : √©coles, villages, quartiers, familles

**Configuration :**
1. S√©lectionner "En Grappe (Cluster)" dans le type d'√©chantillonnage
2. Cocher "√âchantillonnage en grappe"
3. Indiquer :
   - **Taille moyenne des grappes** : nombre moyen de sujets par grappe (ex: 30 √©l√®ves par √©cole)
   - **Effet de plan (Design Effect)** : g√©n√©ralement entre 1.5 et 2.0 (voir section suivante)

#### e) √Ä Plusieurs Degr√©s (Multi-stage)
- √âchantillonnage en plusieurs √©tapes
- **Exemple** : 
  - 1er degr√© : s√©lection de r√©gions
  - 2√®me degr√© : s√©lection de districts dans chaque r√©gion
  - 3√®me degr√© : s√©lection de m√©nages dans chaque district

#### f) Stratifi√© en Grappes
- Combinaison de stratification et d'√©chantillonnage en grappe
- **Exemple** : Stratifier par zone (urbain/rural), puis √©chantillonner des villages (grappes) dans chaque strate

### √âchantillonnage Non Probabiliste

#### a) De Convenance
- S√©lection des sujets facilement accessibles
- Rapide et peu co√ªteux, mais biais de s√©lection important

#### b) Raisonn√© (Purposive)
- S√©lection intentionnelle de sujets ayant des caract√©ristiques sp√©cifiques
- Utilis√© en recherche qualitative

#### c) Boule de Neige
- Les participants recrutent d'autres participants
- Utile pour les populations difficiles d'acc√®s

#### d) Par Quotas
- S√©lection pour respecter des proportions pr√©d√©finies
- Similaire au stratifi√©, mais non probabiliste

## 3. Effet de Plan (Design Effect - Deff)

### D√©finition
L'effet de plan mesure l'augmentation de la variance due √† un design d'√©chantillonnage complexe (grappe, stratifi√©) par rapport √† un √©chantillonnage al√©atoire simple.

### Formule  
```
Taille ajust√©e = Taille calcul√©e √ó Design Effect
```

### Valeurs typiques
- **Deff = 1.0** : √âchantillonnage al√©atoire simple (pas d'ajustement)
- **Deff = 1.5 √† 2.0** : √âchantillonnage en grappe typique
- **Deff > 2.0** : Grappes tr√®s homog√®nes (forte corr√©lation intra-classe)

### Exemple
Si votre calcul de base donne **N = 384 sujets** et que vous utilisez un √©chantillonnage en grappe avec Deff = 1.8 :
```
N ajust√© = 384 √ó 1.8 = 691 sujets
```

### Comment estimer le Deff ?
1. **Litt√©rature** : Chercher des √©tudes similaires
2. **√âtude pilote** : Calculer la corr√©lation intra-classe (ICC)
3. **Formule** : Deff = 1 + (m - 1) √ó ICC
   - m = taille moyenne de la grappe
   - ICC = coefficient de corr√©lation intra-classe (g√©n√©ralement 0.01 √† 0.05)

## 4. Taux de Perdus de Vue

### D√©finition
Proportion attendue de participants qui ne compl√©teront pas l'√©tude (abandon, d√©c√®s, perte de contact).

### Formule d'ajustement
```
N ajust√© = N calcul√© / (1 - taux de perdus de vue)
```

### Valeurs typiques
- **√âtudes transversales** : 5-10%
- **√âtudes de cohorte courte (< 1 an)** : 10-15%
- **√âtudes de cohorte longue (> 1 an)** : 15-25%
- **Essais cliniques** : 10-20%

### Exemple
Si N calcul√© = 400 et taux de perdus de vue = 15% :
```
N ajust√© = 400 / (1 - 0.15) = 400 / 0.85 = 471 sujets
```

## 5. Calcul Complet avec Ajustements

### Exemple pratique : √âtude multicentrique en grappe

**Contexte** :
- √âtude sur la pr√©valence du diab√®te en milieu rural
- 3 centres (r√©gions sanitaires)
- √âchantillonnage en grappe (villages = grappes)

**√âtapes** :

1. **Calcul de base (Cochran)** :
   - Pr√©valence attendue : 10%
   - Pr√©cision : 3%
   - IC 95% (Z=1.96)
   - **N‚ÇÄ = 384 sujets**

2. **Ajustement pour Design Effect** :
   - Taille moyenne des grappes : 25 personnes/village
   - ICC estim√© : 0.02 (litt√©rature)
   - Deff = 1 + (25 - 1) √ó 0.02 = 1.48 ‚âà **1.5**
   - **N‚ÇÅ = 384 √ó 1.5 = 576 sujets**

3. **Ajustement pour perdus de vue** :
   - Taux attendu : 10%
   - **N final = 576 / 0.90 = 640 sujets**

4. **R√©partition par centre** :
   - Si √©quitable : 640 / 3 ‚âà **213 sujets par centre**

5. **Nombre de grappes** :
   - **640 / 25 = 26 villages** au total
   - Soit environ 9 villages par centre

### Texte g√©n√©r√© pour le protocole
```
La taille d'√©chantillon a √©t√© calcul√©e selon la formule de Cochran pour une pr√©valence attendue de 10%,
avec une pr√©cision de 3% et un niveau de confiance de 95%, donnant un √©chantillon de base de 384 sujets.

En raison de l'√©chantillonnage en grappe (villages), un effet de plan (Design Effect) de 1.5 a √©t√© appliqu√©,
portant l'√©chantillon √† 576 sujets. 

Anticipant un taux de perdus de vue de 10%, l'√©chantillon final requis est de 640 sujets, r√©partis
√©quitablement dans les 3 centres participants (environ 213 sujets par centre), correspondant √† 26 villages
avec une moyenne de 25 personnes par village.
```

## 6. Conseils Pratiques

### ‚úÖ Bonnes Pratiques
- Toujours justifier le choix de la m√©thode d'√©chantillonnage
- Documenter les sources pour le Design Effect
- √ätre r√©aliste sur le taux de perdus de vue
- Pour les √©tudes multicentriques, v√©rifier la faisabilit√© de recrutement dans chaque centre

### ‚ö†Ô∏è √Ä √âviter
- Sous-estimer l'effet de plan (risque de manque de puissance)
- Ignorer les perdus de vue (√©chantillon final insuffisant)
- Utiliser un √©chantillonnage en grappe sans ajustement
- Confondre √©chantillonnage stratifi√© et par quotas

### üìö Ressources
- OMS : Sample Size Determination in Health Studies
- Bennett S. et al. (1991). A simplified general method for cluster-sample surveys
- Lwanga SK, Lemeshow S. (1991). Sample size determination in health studies

## 7. Validation dans AdRev

Le syst√®me AdRev valide automatiquement :
- La coh√©rence entre le type d'√©tude et la m√©thode d'√©chantillonnage
- La pr√©sence de justifications pour les choix m√©thodologiques
- La description compl√®te de la proc√©dure d'√©chantillonnage

---

**Version** : 2.0  
**Date** : Janvier 2026  
**Auteur** : √âquipe AdRev




FILE: \AI_Site_Prompt.md
------------------------------------
# PROMPT PREMIUM : G√©n√©ration de Site Web IA (Futuriste & High-End)

## Destination : v0.dev / Bolt.new / Claude Artifacts

---

### **Prompt (Fran√ßais)**

> "G√©n√®re un site web vitrine 'Single Page' ultra-moderne et futuriste pour une plateforme SaaS d'IA appel√©e **'Nexus Intelligence'**.
> 
> **AESTHETICS & DESIGN :**
> - **Style :** Glassmorphisme, Neumorphisme subtil, et th√®me 'Midnight Blue' Profond (Dark Mode).
> - **Couleurs :** Fond `#020617`, Accents Neon Cyan `#22d3ee` et Violet √âlectrique `#a855f7`.
> - **Effets :** Gradients anim√©s en arri√®re-plan (mesh gradients), flous gaussiens, cartes avec bordures iris√©es qui r√©agissent au hover.
> - **Typographie :** 'Outfit' ou 'Inter' pour un look premium et technologique.
> 
> **STRUCTURE DE LA PAGE :**
> 1. **Hero Section :** Un titre avec un gradient de texte (Cyan √† Violet), un sous-titre √©l√©gant, et un bouton 'Call-to-Action' avec un effet de lueur (glow). Ajoute un composant interactif comme un globe 3D ou des particules.
> 2. **Bento Grid :** Une grille type Apple/Bento pr√©sentant 4 fonctionnalit√©s cl√©s de l'IA (Analyse de donn√©es, Automatisation, Mod√®les LLM, R√©dacteur IA). Chaque tuile doit avoir un effet de hover premium.
> 3. **Live Terminal Demo :** Un faux terminal de code interactif qui 'tape' du code en temps r√©el pour montrer l'API.
> 4. **Pricing Cards :** 3 cartes de prix √©pur√©es (Gratuit, Pro, Enterprise) avec la carte Pro mise en avant par un badge 'Recommand√©' brillant.
> 5. **Footer :** Design minimaliste avec liens r√©seaux sociaux et copyright.
> 
> **TECH & ANIMATIONS :**
> - Utilise React, Tailwind CSS et Framer Motion pour les animations d'entr√©e (fade-in, slide-up).
> - Les boutons doivent avoir un effet de micro-interaction (scale sur clic, ripple effect).
> - Le site doit √™tre 100% responsive et fluide."

---

### **Prompt (English Version)**

> "Create a high-end, futuristic 'Single Page' showcase website for an AI SaaS platform named **'Nexus Intelligence'**.
> 
> **AESTHETICS & DESIGN:**
> - **Style:** Deep Glassmorphism, subtle Neumorphism, and a 'Midnight Blue' Dark Mode theme.
> - **Colors:** Background `#020617`, Accents Neon Cyan `#22d3ee` and Electric Purple `#a855f7`.
> - **Effects:** Animated mesh gradients in the background, Gaussian blurs, and cards with iridescent borders that react on hover.
> - **Typography:** 'Outfit' or 'Inter' for a premium, tech-forward look.
> 
> **PAGE STRUCTURE:**
> 1. **Hero Section:** A title with a text gradient (Cyan to Purple), an elegant subtitle, and a 'Call-to-Action' button with a glowing effect. Include an interactive component like a 3D globe or particles.
> 2. **Bento Grid:** An Apple-style Bento grid showcasing 4 key AI features (Data Analysis, Automation, LLM Models, AI Copywriter). Each tile must have a premium hover effect.
> 3. **Live Terminal Demo:** A mock interactive code terminal that 'types' code in real-time to demonstrate the API.
> 4. **Pricing Cards:** 3 clean pricing cards (Free, Pro, Enterprise) with the Pro card highlighted by a glowing 'Recommended' badge.
> 5. **Footer:** Minimalist design with social links and copyright.
> 
> **TECH & ANIMATIONS:**
> - Use React, Tailwind CSS, and Framer Motion for entrance animations (fade-in, slide-up).
> - Buttons should have micro-interactions (scale on click, ripple effect).
> - The site must be 100% responsive and fluidly animated."




FILE: \GUIDE_VARIABLES.md
------------------------------------
# üìù Module "Masque de Saisie" & Variables

**Nouveaut√© AdRev 2.0 !** 
Vous pouvez d√©sormais transformer votre protocole en outils de collecte concrets, comme dans Epi Info 7 ("Make View").

---

## üöÄ √Ä quoi √ßa sert ?

Ce module fait le pont entre la **th√©orie** (votre m√©thodologie) et la **pratique** (votre terrain). Il permet de :
1.  **D√©finir le dictionnaire des variables** (Codebook).
2.  **Cr√©er le masque de saisie** (Types de donn√©es, contraintes).
3.  **G√©n√©rer automatiquement la Fiche d'Enqu√™te** (Cahier d'Observation - CRF).

---

## üõ†Ô∏è Comment l'utiliser ?

### 1. Acc√©der au Concepteur
Dans l'onglet **M√©thodologie**, apr√®s la section √©chantillonnage, cliquez sur le bouton vert :
> **[ üìù Dictionnaire des Variables / Masque de Saisie ]**

### 2. Cr√©er vos Variables
Une interface s'ouvre (similaire √† Google Forms ou Epi Info).
- Cliquez sur **"‚ûï Nouvelle Variable"**.
- Remplissez les champs :
  - **Question (Prompt) :** "Quel est l'√¢ge du patient ?"
  - **Nom (BDD) :** `AGE_ANN` (g√©n√©r√© automatiquement)
  - **Type :** Nombre Entier, Date, Texte, Choix Multiple...
  - **Groupe :** "Donn√©es Cliniques" (pour organiser la fiche)

### 3. Types de Variables Disponibles

| Type | Usage | Exemple |
|------|-------|---------|
| **Texte Court** | Noms, Villes, Codes | *"Bamako"* |
| **Nombre Entier** | √Çge, Nbre enfants | *45* |
| **Nombre D√©cimal** | Poids, HbA1c, Taille | *75.5* |
| **Date** | Date visite, Naissance | *12/05/2024* |
| **Oui / Non** | Sympt√¥me pr√©sent ? | *Oui* |
| **Choix Unique** | Liste d√©roulante | *Homme / Femme* |
| **Choix Multiples** | Plusieurs r√©ponses | *Toux / Fi√®vre / Douleur* |
| **Memo** | Texte long | *Commentaires...* |

### 4. Exporter la Fiche d'Enqu√™te
Une fois vos variables d√©finies :
1.  Cliquez sur le bouton orange **"üñ®Ô∏è Exporter Fiche d'Enqu√™te"** (en bas √† gauche).
2.  Le logiciel g√©n√®re instantan√©ment un fichier texte (.txt) propre et format√©.
3.  Le fichier s'ouvre automatiquement.
4.  **Astuce :** Copiez-collez le contenu dans Word pour finaliser la mise en page !

---

## üìä Exemple de R√©sultat

Voici ce que AdRev g√©n√®re automatiquement :

```text
# FICHE D'ENQU√äTE / CAHIER D'OBSERVATION
________________________________________________________________________________
TITRE : √âTUDE PR√âVALENCE DIAB√àTE
CODE √âTUDE : ADREV-BKO-01
DATE : ____ / ____ / ________
________________________________________________________________________________

## DONN√âES SOCIOD√âMOGRAPHIQUES
--------------------------------------------------
**Sexe du participant (*)**
   ( ) Masculin
   ( ) F√©minin
   _SEXE_

**√Çge (ann√©es r√©volues) (*)**
   |__|__|__|
   _AGE_

## DONN√âES CLINIQUES
--------------------------------------------------
**Ant√©c√©dents familiaux de diab√®te ?**
   [ ] OUI    [ ] NON
   _ATCD_DIAB_

**Glyc√©mie √† jeun (g/L)**
   |__|__| , |__|__|
   _GLYCEMIE_
```

---

## üí° Conseils M√©thodologiques

*   **Nommer vos variables** clairement (ex: `PAS_MMHG` pour Pression Art√©rielle Systolique).
*   Utilisez les **Groupes** pour structurer votre questionnaire (Sociod√©mographie, Clinique, Biologie...).
*   Cochez **"Obligatoire"** pour les variables cl√©s (crit√®res d'inclusion, outcome principal).
*   L'export g√©n√©r√© sert de **Cahier d'Observation (CRF)** papier pour les enqu√™teurs.

---

**C'est cette structure qui servira plus tard √† cr√©er la base de donn√©es d'analyse (Excel, SPSS, Epi Info).**




FILE: \INDEX_DOCUMENTATION.md
------------------------------------
# üìö INDEX - Documentation AdRev 2.0 M√©thodologies Avanc√©es

## üéØ Par O√π Commencer ?

### üöÄ Vous voulez tester MAINTENANT (5 min)
‚Üí **[PREMIERS_PAS.md](PREMIERS_PAS.md)**

### üìñ Vous voulez comprendre ce qui a √©t√© fait
‚Üí **[VALIDATION_FINALE.md](VALIDATION_FINALE.md)**

### ‚ö° Vous voulez une vue d'ensemble rapide
‚Üí **[QUICK_START.md](QUICK_START.md)**

### üìã Vous voulez les instructions compl√®tes
‚Üí **[README_Methodologie_Avancee.md](README_Methodologie_Avancee.md)**

---

## üìÇ Tous les Documents par Cat√©gorie

### üéì Documentation Acad√©mique

| Fichier | Description | Pages |
|---------|-------------|-------|
| **[Guide_Methodologie_Avancee.md](Documentation/Guide_Methodologie_Avancee.md)** | Guide acad√©mique complet sur tous les types d'√©chantillonnage, formules, exemples pratiques | 15+ |
| | ‚Ä¢ √âtudes multicentriques d√©taill√©es | |
| | ‚Ä¢ 13 types d'√©chantillonnage expliqu√©s | |
| | ‚Ä¢ Formules et calculs (Design Effect, ICC, etc.) | |
| | ‚Ä¢ Exemples concrets avec donn√©es r√©elles | |
| | ‚Ä¢ R√©f√©rences bibliographiques | |

### üõ†Ô∏è Documentation Technique

| Fichier | Description | Info |
|---------|-------------|------|
| **[CHANGELOG_Methodologie_Avancee.md](Documentation/CHANGELOG_Methodologie_Avancee.md)** | Liste compl√®te des modifications techniques | D√©tails complets |
| | ‚Ä¢ Fichiers cr√©√©s (5) | |
| | ‚Ä¢ Fichiers modifi√©s (3) | |
| | ‚Ä¢ Nouvelles classes et m√©thodes | |
| | ‚Ä¢ Instructions XAML | |

### ‚úÖ Documentation de Validation

| Fichier | Description | Statut |
|---------|-------------|--------|
| **[VALIDATION_FINALE.md](VALIDATION_FINALE.md)** | Confirmation 100% de l'impl√©mentation | ‚úÖ COMPLET |
| | ‚Ä¢ Build status : SUCC√àS | |
| | ‚Ä¢ 4 tests d√©taill√©s √† effectuer | |
| | ‚Ä¢ Exemple complet d'utilisation | |
| | ‚Ä¢ Statistiques finales | |
| **[INTEGRATION_COMPLETE.md](INTEGRATION_COMPLETE.md)** | R√©sum√© visuel de l'int√©gration | ‚úÖ COMPLET |
| | ‚Ä¢ Impact et b√©n√©fices | |
| | ‚Ä¢ Fichiers cr√©√©s/modifi√©s | |
| | ‚Ä¢ Checklist de finalisation | |

### üöÄ Guides de D√©marrage

| Fichier | Description | Temps |
|---------|-------------|-------|
| **[PREMIERS_PAS.md](PREMIERS_PAS.md)** | Test imm√©diat des nouvelles fonctionnalit√©s | 5 min |
| | ‚Ä¢ 2 tests rapides | |
| | ‚Ä¢ R√©sultats attendus | |
| | ‚Ä¢ D√©pannage simple | |
| **[QUICK_START.md](QUICK_START.md)** | D√©marrage rapide condens√© | 2 min |
| | ‚Ä¢ Utilisation en 30 secondes | |
| | ‚Ä¢ Formules essentielles | |
| | ‚Ä¢ Exemple complet | |
| **[README_Methodologie_Avancee.md](README_Methodologie_Avancee.md)** | Instructions compl√®tes | 20 min |
| | ‚Ä¢ Code XAML complet | |
| | ‚Ä¢ Tests recommand√©s | |
| | ‚Ä¢ Exemples d√©taill√©s | |

---

## üéØ Par Besoin Sp√©cifique

### Je veux comprendre comment utiliser...

#### √âtudes Multicentriques
- **D√©marrage rapide :** [PREMIERS_PAS.md](PREMIERS_PAS.md) ‚Üí Section "Test Rapide 1"
- **Guide complet :** [Guide_Methodologie_Avancee.md](Documentation/Guide_Methodologie_Avancee.md) ‚Üí Section 1

#### √âchantillonnage en Grappe
- **D√©marrage rapide :** [PREMIERS_PAS.md](PREMIERS_PAS.md) ‚Üí Section "Test Rapide 2"
- **Formules :** [QUICK_START.md](QUICK_START.md) ‚Üí Formules Utiles
- **Guide complet :** [Guide_Methodologie_Avancee.md](Documentation/Guide_Methodologie_Avancee.md) ‚Üí Section 2.d

#### Design Effect (Effet de Plan)
- **Formule rapide :** [QUICK_START.md](QUICK_START.md) ‚Üí Formules
- **Explication d√©taill√©e :** [Guide_Methodologie_Avancee.md](Documentation/Guide_Methodologie_Avancee.md) ‚Üí Section 3
- **Valeurs typiques :** [VALIDATION_FINALE.md](VALIDATION_FINALE.md) ‚Üí Section "Formules"

#### √âchantillonnage Stratifi√©
- **Vue d'ensemble :** [README_Methodologie_Avancee.md](README_Methodologie_Avancee.md) ‚Üí Fonctionnalit√©s
- **Guide complet :** [Guide_Methodologie_Avancee.md](Documentation/Guide_Methodologie_Avancee.md) ‚Üí Section 2.c

#### Taux de Perdus de Vue
- **Formule :** [VALIDATION_FINALE.md](VALIDATION_FINALE.md) ‚Üí Formules de R√©f√©rence
- **Valeurs typiques :** [Guide_Methodologie_Avancee.md](Documentation/Guide_Methodologie_Avancee.md) ‚Üí Section 4

---

## üîç Par Type d'Information

### Je cherche...

#### Des Exemples Pratiques
1. **[VALIDATION_FINALE.md](VALIDATION_FINALE.md)** ‚Üí Section "Exemple Complet d'Utilisation"
   - Cas diab√®te en milieu rural, √©tape par √©tape

2. **[Guide_Methodologie_Avancee.md](Documentation/Guide_Methodologie_Avancee.md)** ‚Üí Section 5
   - Exemple avec tous les ajustements

3. **[QUICK_START.md](QUICK_START.md)** ‚Üí Section "Exemple Complet"
   - Exemple condens√© rapide

#### Des Formules Math√©matiques
- **[VALIDATION_FINALE.md](VALIDATION_FINALE.md)** ‚Üí "Formules de R√©f√©rence"
- **[QUICK_START.md](QUICK_START.md)** ‚Üí "Formules Utiles"
- **[Guide_Methodologie_Avancee.md](Documentation/Guide_Methodologie_Avancee.md)** ‚Üí Toutes les sections

#### La Liste des Modifications Techniques
- **[CHANGELOG_Methodologie_Avancee.md](Documentation/CHANGELOG_Methodologie_Avancee.md)** ‚Üí Complet
- **[INTEGRATION_COMPLETE.md](INTEGRATION_COMPLETE.md)** ‚Üí R√©sum√© visuel

#### Le Code √† Copier-Coller  
‚ö†Ô∏è **Note :** Code XAML d√©j√† ajout√© automatiquement !
- Les sections UI ont √©t√© int√©gr√©es dans `ProtocolWindow.xaml`
- Rien √† copier manuellement !

#### Des Tests √† Effectuer
- **[PREMIERS_PAS.md](PREMIERS_PAS.md)** ‚Üí 2 tests rapides
- **[VALIDATION_FINALE.md](VALIDATION_FINALE.md)** ‚Üí 4 tests complets
- **[README_Methodologie_Avancee.md](README_Methodologie_Avancee.md)** ‚Üí Tests d√©taill√©s

---

## üìä Statistiques Globales

### Documentation Cr√©√©e
- **Fichiers :** 10+
- **Pages totales :** ~50 pages A4
- **Lignes de documentation :** 1500+
- **Exemples pratiques :** 10+
- **Tests fournis :** 8
- **Formules expliqu√©es :** 15+

### Code Cr√©√©/Modifi√©
- **Fichiers cr√©√©s :** 5 (C# + Enums)
- **Fichiers modifi√©s :** 3 (Model + UI + Code-behind)
- **Lignes de code :** 600+
- **Nouvelles propri√©t√©s :** 15
- **Nouvelles m√©thodes :** 12+
- **Gestionnaires d'√©v√©nements :** 6

### Fonctionnalit√©s
- **Types d'√©chantillonnage :** 13
- **Ajustements automatiques :** 2 (Deff, perdus de vue)
- **Interfaces utilisateur :** 2 sections compl√®tes
- **Build status :** ‚úÖ SUCC√àS

---

## üéì R√©f√©rences Bibliographiques

Mentionn√©es dans **[Guide_Methodologie_Avancee.md](Documentation/Guide_Methodologie_Avancee.md)** :

1. Cochran WG. (1977). *Sampling Techniques*. 3rd ed.
2. Bennett S. et al. (1991). *A simplified general method for cluster-sample surveys*
3. Lwanga SK, Lemeshow S. (1991). *Sample size determination in health studies*
4. OMS : *Sample Size Determination in Health Studies*

---

## üóÇÔ∏è Structure des Dossiers

```
AdRev/
‚îú‚îÄ‚îÄ Documentation/
‚îÇ   ‚îú‚îÄ‚îÄ Guide_Methodologie_Avancee.md ................ Guide acad√©mique complet
‚îÇ   ‚îî‚îÄ‚îÄ CHANGELOG_Methodologie_Avancee.md ............ Modifications techniques
‚îÇ
‚îú‚îÄ‚îÄ PREMIERS_PAS.md .................................. Test en 5 minutes
‚îú‚îÄ‚îÄ QUICK_START.md ................................... D√©marrage rapide
‚îú‚îÄ‚îÄ README_Methodologie_Avancee.md ................... Instructions compl√®tes
‚îú‚îÄ‚îÄ VALIDATION_FINALE.md ............................. Confirmation 100%
‚îú‚îÄ‚îÄ INTEGRATION_COMPLETE.md .......................... R√©sum√© visuel
‚îî‚îÄ‚îÄ INDEX_DOCUMENTATION.md (ce fichier) .............. Index g√©n√©ral
```

---

## ‚úÖ Parcours Recommand√©

### Pour un utilisateur press√© (10 min)
1. [PREMIERS_PAS.md](PREMIERS_PAS.md) - Tester les fonctionnalit√©s
2. [QUICK_START.md](QUICK_START.md) - Vue d'ensemble rapide

### Pour un utilisateur m√©thodique (30 min)
1. [VALIDATION_FINALE.md](VALIDATION_FINALE.md) - Comprendre ce qui a √©t√© fait
2. [PREMIERS_PAS.md](PREMIERS_PAS.md) - Tester
3. [README_Methodologie_Avancee.md](README_Methodologie_Avancee.md) - Instructions d√©taill√©es

### Pour un chercheur/acad√©mique (1h+)
1. [VALIDATION_FINALE.md](VALIDATION_FINALE.md) - Vue d'ensemble
2. [Guide_Methodologie_Avancee.md](Documentation/Guide_Methodologie_Avancee.md) - Approfondir
3. [CHANGELOG_Methodologie_Avancee.md](Documentation/CHANGELOG_Methodologie_Avancee.md) - Aspects techniques
4. Tests pratiques

---

## üÜò D√©pannage Rapide

### Probl√®me ‚Üí Solution

| Probl√®me | Document de r√©f√©rence |
|----------|----------------------|
| L'application ne d√©marre pas | [PREMIERS_PAS.md](PREMIERS_PAS.md) ‚Üí "En cas de probl√®me" |
| Les nouveaux champs n'apparaissent pas | [README_Methodologie_Avancee.md](README_Methodologie_Avancee.md) ‚Üí Tests |
| Je ne comprends pas le Design Effect | [Guide_Methodologie_Avancee.md](Documentation/Guide_Methodologie_Avancee.md) ‚Üí Section 3 |
| Je veux voir un exemple complet | [VALIDATION_FINALE.md](VALIDATION_FINALE.md) ‚Üí "Exemple Complet" |
| Erreur √† la sauvegarde | [PREMIERS_PAS.md](PREMIERS_PAS.md) ‚Üí "En cas de probl√®me" |

---

## üéØ Checklist Rapide de Navigation

Vous avez lu ce fichier? Voici votre prochaine √©tape :

- [ ] Je veux **tester maintenant** ‚Üí [PREMIERS_PAS.md](PREMIERS_PAS.md)
- [ ] Je veux **comprendre globalement** ‚Üí [VALIDATION_FINALE.md](VALIDATION_FINALE.md)
- [ ] Je veux **apprendre en d√©tail** ‚Üí [Guide_Methodologie_Avancee.md](Documentation/Guide_Methodologie_Avancee.md)
- [ ] Je suis **d√©veloppeur** ‚Üí [CHANGELOG_Methodologie_Avancee.md](Documentation/CHANGELOG_Methodologie_Avancee.md)

---

**Bonne navigation dans la documentation AdRev 2.0 ! üìö‚ú®**

*Derni√®re mise √† jour : 10 Janvier 2026*




FILE: \NotebookLM_Context_Pack.md
------------------------------------
# AdRev 2.0 - Project Context Pack (NotebookLM Ready)

## Project Overview
**AdRev** is a specialized medical research methodology application built with WPF (.NET 8). It assists researchers in designing protocols, calculating sample sizes with advanced statistical adjustments, and managing qualitative/quantitative variables.

## Key Components

### 1. Research Protocol (`AdRev.Domain.Protocols.ResearchProtocol`)
The central entity. It contains:
- **Project Info**: Title, Authors (Principal + Co-authors).
- **Introduction**: Context, Problem Justification, Research Question, Hypotheses.
- **Objectives**: General and Specific.
- **Methodology**: Study Type, Setting, Conceptual Model.
- **Advanced Sampling**: 
    - Supports **13 types** (Stratified, Cluster, etc.).
    - Automatic adjustments for **Design Effect (Deff)** and **Expected Loss Rate**.
    - Handles multicentric study sites.
- **Variables**: Dynamic list of study variables (style Epi Info).
- **Ethics & Budget**: Dedicated sections for compliance and planning.

### 2. Statistical Core (`AdRev.Core.Services`)
Contains the logic for:
- **Sample Size Calculations**: Cochran, Comparison of Proportions.
- **Adjustments**: Mathematical formulas to scale sample size based on stratification or clustering.
- **Word Export**: Generates professional reports from the protocol data.

### 3. UI Layer (`AdRev.Desktop`)
- **MainWindow**: Dashboard for project management.
- **ProtocolWindow**: Multi-step wizard (Introduction, Objectives, Methodology, Sampling, etc.).
- **VariableDesigner**: Visual drag-and-drop tool for creating data entry masks.

## Business Logic Highlights
- **Dynamic Methodology**: The UI adapts based on `StudyType`. For example, selecting "Qualitative" enables specific fields like "Qualitative Approach".
- **Real-time Feedback**: Calculations update as the user types parameters (prevalence, precision, error margin).

## Technical Stack
- **Languages**: C#, XAML.
- **Framework**: .NET 8, WPF.
- **Data**: JSON-based serialization for project files.




FILE: \PREMIERS_PAS.md
------------------------------------
# üéØ PREMIERS PAS - AdRev 2.0

## ‚úÖ Statut : TOUT EST PR√äT !

L'impl√©mentation est **100% termin√©e** et le **build a r√©ussi** ! üéâ

---

## üöÄ Pour tester MAINTENANT (5 minutes)

### 1Ô∏è‚É£ Lancez l'application
```powershell
cd c:\Users\HP\Documents\AdRev
dotnet run --project AdRev.Desktop
```

Ou double-cliquez sur l'ex√©cutable dans `AdRev.Desktop\bin\Debug\net8.0-windows\`

### 2Ô∏è‚É£ Cr√©ez un nouveau protocole
- Cliquez sur "Nouveau Protocole" (ou √©quivalent)
- Remplissez les infos de base (√âtape 1)
- Passez √† l'√©tape "M√©thodologie" (√âtape 4)

### 3Ô∏è‚É£ Testez les nouvelles fonctionnalit√©s

#### Test Rapide 1 : Multicentrique
```
1. Cochez "√âtude Multicentrique"
2. Le champ centres appara√Æt automatiquement ‚ú®
3. Entrez 2-3 centres (un par ligne)
4. D√©cochez : le champ dispara√Æt
5. Recochez : vos donn√©es sont toujours l√† !
```

#### Test Rapide 2 : √âchantillonnage en Grappe
```
1. S√©lectionnez type d'√©tude : Quantitative ‚Üí Transversale
2. Dans "Type d'√©chantillonnage" : En Grappe (Cluster)
3. Cochez "√âchantillonnage en grappe"
4. Les champs apparaissent ‚ú®
5. Entrez : Taille = 30, Design Effect = 1.8
6. Perdus de vue : 10%
7. Calculez avec Cochran (p=50%, d=5%)
8. Observez : N passe de 384 ‚Üí 692 ‚Üí 769 ! üéØ
```

#### Test Rapide 3 : Masque de Saisie & Export (NOUVEAU ‚ú®)
```
1. Cliquez sur le bouton vert [ üìù Dictionnaire des Variables ]
2. Une fen√™tre s'ouvre. Cliquez "‚ûï Nouvelle Variable" (x3 fois)
3. Cr√©ez : "Age" (Nombre), "Sexe" (Choix), "Date Visite" (Date)
4. Cliquez sur le bouton orange [ üñ®Ô∏è Exporter Fiche d'Enqu√™te ]
5. UN FICHIER TEXTE S'OUVRE AVEC VOTRE QUESTIONNAIRE ! üéâ
6. Fermez la fen√™tre en validant.
```

---

## üìä R√©sultat Attendu

Apr√®s le calcul, vous devriez voir :
```
N requis = 769 sujets (base: 384)

Texte g√©n√©r√© :
"La taille d'√©chantillon minimal a √©t√© calcul√©e selon la formule de Cochran... 
Avec un effet de plan de 1.80, la taille passe √† 692 sujets. 
En pr√©voyant 10% de perdus de vue, la taille finale est de 769 sujets."
```

---

## üìö Si vous voulez en savoir plus

### Documentation Rapide
- **D√©marrage rapide :** `QUICK_START.md`
- **Instructions compl√®tes :** `README_Methodologie_Avancee.md`

### Documentation Acad√©mique
- **Guide complet :** `Documentation/Guide_Methodologie_Avancee.md`
- **Historique :** `Documentation/CHANGELOG_Methodologie_Avancee.md`

### Validation
- **Statut final :** `VALIDATION_FINALE.md`
- **R√©sum√© :** `INTEGRATION_COMPLETE.md`

---

## üéì Exemple Complet en 3 Minutes

**Sc√©nario :** √âtude de pr√©valence du diab√®te

**Configuration :**
1. Type : Quantitative ‚Üí Transversale Descriptive
2. ‚òë √âtude Multicentrique
   - CHU Bamako
   - H√¥pital Gabriel Tour√©
3. Type √©chantillonnage : En Grappe
4. ‚òë √âchantillonnage en grappe
   - Taille : 25
   - Design Effect : 1.8
5. Perdus de vue : 10%
6. Calculer : p=10%, d=3%, IC=95%

**R√©sultat :**
```
N_base = 384
√ó 1.8 = 692
√∑ 0.90 = 769 sujets
= 31 villages (769√∑25)
= ~10 villages par centre
```

**Temps total :** < 3 minutes !

---

## ‚ùì Questions Fr√©quentes

### Q: O√π sont les nouveaux champs ?
**R:** √âtape 4 "M√©thodologie", juste apr√®s la population d'√©tude

### Q: Les donn√©es sont-elles sauvegard√©es ?
**R:** Oui ! Toutes les 15 nouvelles propri√©t√©s sont persist√©es

### Q: Puis-je utiliser plusieurs types en m√™me temps ?
**R:** Oui ! Par exemple : Multicentrique + Stratifi√© en Grappes + Perdus de vue

### Q: Les calculs sont-ils automatiques ?
**R:** Partiellement. Les ajustements sont sugg√©r√©s, vous pouvez les affiner

---

## üéØ Checklist Rapide

Vous saurez que tout fonctionne quand :
- [ ] L'application d√©marre sans erreur
- [ ] Checkbox "√âtude Multicentrique" affiche/cache le champ
- [ ] ComboBox "Type d'√©chantillonnage" a 13 options
- [ ] S√©lection "En Grappe" affiche les options de grappe
- [ ] Les calculs prennent en compte Design Effect et perdus de vue
- [ ] Sauvegarde fonctionne sans erreur

**Si tous les ‚úì sont coch√©s : SUCC√àS TOTAL ! üéâ**

---

## üÜò En cas de probl√®me

### L'application ne d√©marre pas
```powershell
cd c:\Users\HP\Documents\AdRev
dotnet clean
dotnet build
dotnet run --project AdRev.Desktop
```

### Les champs n'apparaissent pas
- V√©rifiez que vous √™tes bien √† l'√©tape "M√©thodologie"
- V√©rifiez que le build a r√©ussi (voir console)

### Erreur √† la sauvegarde
- V√©rifiez que tous les champs obligatoires sont remplis
- Consultez les messages de validation en bas de l'√©cran

---

## üéâ F√©licitations !

Vous avez maintenant AdRev 2.0 avec :
- ‚úÖ √âtudes multicentriques
- ‚úÖ 13 types d'√©chantillonnage
- ‚úÖ √âchantillonnage en grappe
- ‚úÖ Ajustements automatiques
- ‚úÖ Interface professionnelle

**C'est un outil de niveau international ! üåç‚ú®**

---

**Bon test ! Si tout fonctionne, vous √™tes pr√™t pour vos protocoles de recherche ! üöÄ**

Date : 10 Janvier 2026




FILE: \QUICK_START.md
------------------------------------
# üöÄ D√©marrage Rapide - Nouvelles Fonctionnalit√©s

## üìå En 30 secondes

AdRev supporte maintenant :
- ‚úÖ √âtudes multicentriques
- ‚úÖ √âchantillonnage en grappe
- ‚úÖ 13 types d'√©chantillonnage
- ‚úÖ Ajustements automatiques (Design Effect, perdus de vue)

## ‚ö° Action Imm√©diate Requise

**Fichier √† modifier :** `AdRev.Desktop/ProtocolWindow.xaml`

**O√π ?** Ouvrez `README_Methodologie_Avancee.md` et copiez les 2 sections UI marqu√©es

**Temps estim√© :** 10 minutes

## üéØ Utilisation Rapide

### 1. √âtude Multicentrique
```
‚òë √âtude Multicentrique
‚îó‚îÅ Centres :
    - CHU de Bamako
    - H√¥pital Gabriel Tour√©
    - CSR√©f Koulikoro
```

### 2. √âchantillonnage en Grappe
```
Type d'√©chantillonnage: [En Grappe (Cluster) ‚ñº]
‚òë √âchantillonnage en grappe
‚î£‚îÅ Taille moyenne des grappes: 25
‚îó‚îÅ Design Effect: 1.8
```

### 3. Perdus de Vue
```
Taux de perdus de vue attendu: [10] %
```

### 4. Calcul Automatique
```
N_base = 384 (Cochran)
√ó 1.8 (Design Effect) = 692
√∑ 0.90 (perdus 10%) = 769 sujets finaux
```

## üìä Formules Utiles

**Design Effect :**
```
Deff = 1 + (taille_grappe - 1) √ó ICC
```

**Taille Finale :**
```
N_final = (N_base √ó Deff) / (1 - taux_perdus%)
```

**Nombre de Grappes :**
```
nb_grappes = N_final / taille_moyenne_grappe
```

## üß™ Test Rapide

1. Cr√©er protocole
2. S√©lectionner "Quantitative" ‚Üí "Transversale"
3. Type √©chantillonnage : "En Grappe"
4. Cocher grappe, entrer : taille=30, Deff=1.5
5. Perdus de vue : 10%
6. Calculer Cochran : p=50%, d=5%
7. Observer : N passe de 384 ‚Üí 576 ‚Üí 640

## üìö Documentation

| Besoin | Fichier |
|--------|---------|
| Instructions compl√®tes | `README_Methodologie_Avancee.md` |
| Guide acad√©mique | `Documentation/Guide_Methodologie_Avancee.md` |
| Liste modifications | `Documentation/CHANGELOG_Methodologie_Avancee.md` |
| Statut final | `INTEGRATION_COMPLETE.md` |

## ‚úÖ Checklist

- [x] Mod√®le de donn√©es enrichi
- [x] Code-behind modifi√©
- [x] Service g√©n√©rateur cr√©√©
- [x] Documentation r√©dig√©e
- [ ] **XAML UI √† ajouter** ‚ö†Ô∏è
- [ ] Tester fonctionnalit√©s
- [ ] Valider avec protocole r√©el

## üÜò Probl√®me ?

1. V√©rifier que XAML est modifi√©
2. Recompiler le projet
3. Consulter README_Methodologie_Avancee.md
4. V√©rifier les using en haut des fichiers C#

## üéì Exemple Complet

**Contexte :** √âtude pr√©valence diab√®te en zones rurales de 3 r√©gions

**Configuration :**
- Multicentrique : 3 r√©gions ‚úì
- Type : En Grappe (villages)
- Taille grappe : 25 personnes
- Design Effect : 1.8
- Perdus de vue : 10%

**R√©sultat :**
- N base : 384
- N ajust√© Deff : 692
- N final : 769
- Villages : 31 (‚âà10/r√©gion)

**Temps de configuration :** < 3 minutes

---

**üéØ Objectif : Passer d'un simple calculateur √† un syst√®me professionnel de m√©thodologie de recherche !**




FILE: \README_DEMARRAGE.md
------------------------------------
# üéâ AdRev 2.0 - M√©thodologies Avanc√©es

## ‚úÖ STATUT : IMPL√âMENTATION COMPL√àTE !

**Date :** 10 Janvier 2026  
**Build :** ‚úÖ SUCC√àS (0 erreurs)  
**Progression :** 100% ‚úì

---

## üöÄ D√âMARRAGE RAPIDE - 3 OPTIONS

### ‚ö° Option 1 : Je veux tester MAINTENANT (5 min)
```
üìñ Lisez : PREMIERS_PAS.md
üéØ Testez les 2 fonctionnalit√©s cl√©s
‚úÖ Validez que tout fonctionne
```

### üìö Option 2 : Je veux comprendre d'abord (15 min)
```
üìñ Lisez : VALIDATION_FINALE.md  
üìä Voyez ce qui a √©t√© fait
üß™ Testez avec PREMIERS_PAS.md
```

### üéì Option 3 : Je veux tout savoir (1h)
```
üìë Consultez : INDEX_DOCUMENTATION.md
üìñ Lisez : Guide_Methodologie_Avancee.md
üî¨ Approfondissez tous les aspects
```

---

## üì¶ CE QUI A √âT√â AJOUT√â

### ‚ú® Nouvelles Fonctionnalit√©s

**1. √âtudes Multicentriques**
- Checkbox pour activer
- Liste des centres participants
- Sauvegarde automatique

**2. Types d'√âchantillonnage (13 au total)**
- Al√©atoire Simple
- Syst√©matique
- **Stratifi√©** (avec crit√®res)
- **En Grappe/Cluster** (avec Design Effect)
- √Ä Plusieurs Degr√©s
- Stratifi√© en Grappes
- + 7 autres types

**3. √âchantillonnage en Grappe**
- Taille moyenne des grappes
- Effet de plan (Design Effect)
- Calcul automatique du nombre de grappes

**4. Ajustements Automatiques**
- Design Effect : `N √ó Deff`
- Perdus de vue : `N / (1 - taux%)`
- Texte descriptif g√©n√©r√© automatiquement

**5. Interface Intuitive**
- Visibilit√© conditionnelle
- Tooltips explicatifs
- Organisation claire

---

## üìä EN CHIFFRES

| Aspect | Nombre |
|--------|-------:|
| Fichiers cr√©√©s | 10+ |
| Fichiers modifi√©s | 3 |
| Lignes de code | 600+ |
| Documentation (lignes) | 1500+ |
| Nouvelles propri√©t√©s | 15 |
| Types d'√©chantillonnage | 13 |
| Tests fournis | 8 |
| Exemples complets | 10+ |

**Total pages documentation :** ~50 pages A4 ! üìö

---

## üéØ EXEMPLE RAPIDE

**Configuration (< 3 min) :**
```
√âtude : Pr√©valence diab√®te zones rurales

‚úì Multicentrique (3 centres)
  - CHU Bamako
  - H√¥pital Gabriel Tour√©
  - CSR√©f Koulikoro

Type : En Grappe
‚úì √âchantillonnage en grappe
  Taille : 25
  Design Effect : 1.8
  
Perdus de vue : 10%
```

**Calcul Cochran (p=10%, d=3%):**
```
N_base = 384
√ó 1.8  = 692  (Design Effect)
√∑ 0.90 = 769  (Perdus de vue)

‚Üí 769 sujets
‚Üí 31 villages
‚Üí ~10 villages/centre
```

**R√©sultat : Configuration professionnelle en 3 minutes ! ‚ö°**

---

## üìö NAVIGATION DOCUMENTATION

### üìñ Documents Principaux

| Fichier | Utilisation | Temps |
|---------|-------------|-------|
| **PREMIERS_PAS.md** | Tester imm√©diatement | 5 min |
| **GUIDE_VARIABLES.md** | üéÅ Cr√©er Fiche d'Enqu√™te | 10 min |
| **VALIDATION_FINALE.md** | Comprendre l'impl√©mentation | 20 min |
| **QUICK_START.md** | Vue rapide condens√©e | 2 min |
| **RESUME_FINAL.md** | R√©sum√© visuel | 3 min |
| **INDEX_DOCUMENTATION.md** | Navigation compl√®te | - |

### üéì Documentation Technique

| Fichier | Contenu |
|---------|---------|
| **Documentation/Guide_Methodologie_Avancee.md** | Guide acad√©mique (300+ lignes) |
| **Documentation/CHANGELOG_Methodologie_Avancee.md** | Modifications techniques |
| **README_Methodologie_Avancee.md** | Instructions compl√®tes |
| **INTEGRATION_COMPLETE.md** | R√©sum√© d'int√©gration |

---

## ‚úÖ CHECKLIST RAPIDE

V√©rifiez que tout fonctionne :

- [ ] AdRev.Desktop d√©marre sans erreur
- [ ] Type d'√©chantillonnage : 13 options disponibles
- [ ] Checkbox "√âtude Multicentrique" fonctionne
- [ ] Selection "En Grappe" affiche les options
- [ ] Les calculs incluent les ajustements
- [ ] La sauvegarde fonctionne sans erreur

**Tout ‚úì ? PARFAIT ! L'impl√©mentation est compl√®te ! üéâ**

---

## üî• FORMULES CL√âS

```
Design Effect
  Deff = 1 + (m - 1) √ó ICC
  o√π m = taille grappe, ICC ‚âà 0.01-0.05

Ajustements
  N_ajust√© = N_base √ó Deff
  N_final = N_ajust√© / (1 - taux_perdus%)

Nombre de Grappes
  nb_grappes = N_final / taille_moyenne
```

---

## üåü IMPACT

### Avant AdRev 2.0
- ‚ùå √âchantillonnage basique
- ‚ùå Pas de multicentrique
- ‚ùå Calculs manuels
- ‚ùå Pas de designs complexes

### Avec AdRev 2.0
- ‚úÖ 13 types d'√©chantillonnage
- ‚úÖ Multicentriques natifs
- ‚úÖ Ajustements automatiques
- ‚úÖ Standards internationaux
- ‚úÖ Interface professionnelle

**‚Üí Outil de niveau recherche internationale ! üåç**

---

## üéì R√âF√âRENCES

Documentation conforme aux standards :
- OMS : Sample Size Determination
- Cochran WG. (1977). Sampling Techniques
- Bennett S. et al. (1991). Cluster surveys
- Lwanga & Lemeshow (1991)

---

## üìû SUPPORT

| Besoin | Solution |
|--------|----------|
| Tester rapidement | ‚Üí PREMIERS_PAS.md |
| Comprendre l'impl√©mentation | ‚Üí VALIDATION_FINALE.md |
| Apprendre les d√©tails | ‚Üí Guide_Methodologie_Avancee.md |
| Naviguer la doc | ‚Üí INDEX_DOCUMENTATION.md |
| Probl√®me technique | ‚Üí README_Methodologie_Avancee.md |

---

## üöÄ PROCHAINES √âTAPES

### Imm√©diat
1. ‚úÖ Lire **PREMIERS_PAS.md**
2. üß™ Tester les fonctionnalit√©s (5 min)
3. ‚úÖ Valider avec un protocole test

### Cette Semaine
1. üìù Utiliser pour un vrai protocole
2. üéØ Tester tous les types d'√©chantillonnage
3. üìä Partager avec coll√®gues

### Futur (Optionnel)
1. üìÑ Enrichir exports Word/PDF
2. üé® Cr√©er templates pr√©-remplis
3. üìä Ajouter diagrammes automatiques

---

## üèÜ R√âSULTAT

```
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                        ‚ïë
‚ïë    ‚úÖ AdRev 2.0 - 100% COMPL√âT√â        ‚ïë
‚ïë                                        ‚ïë
‚ïë    üéØ Fonctionnalit√©s avanc√©es         ‚ïë
‚ïë    üîß Build r√©ussi                     ‚ïë
‚ïë    üìö Documentation compl√®te           ‚ïë
‚ïë    üß™ Tests fournis                    ‚ïë
‚ïë    üåç Standards internationaux         ‚ïë
‚ïë                                        ‚ïë
‚ïë    STATUS: PRODUCTION READY üöÄ         ‚ïë
‚ïë                                        ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
```

---

**üéâ F√©licitations ! Votre outil est maintenant au niveau professionnel international ! üéâ**

**‚Üí Commencez par lire `PREMIERS_PAS.md` pour tester en 5 minutes ! ‚ö°**

---

*Version : AdRev 2.0 - M√©thodologies Avanc√©es*  
*Date : 10 Janvier 2026*  
*Build Status : ‚úÖ SUCCESS*




FILE: \README_Methodologie_Avancee.md
------------------------------------
# üéØ M√©thodologies Avanc√©es - AdRev

## üìå R√©sum√© Rapide

Votre demande a √©t√© int√©gr√©e avec succ√®s ! AdRev peut maintenant prendre en compte :

‚úÖ **√âtudes Multicentriques**  
‚úÖ **√âchantillonnage en Grappe (Cluster Sampling)**  
‚úÖ **√âchantillonnage Stratifi√©**  
‚úÖ **Effet de Plan (Design Effect)** pour ajustements  
‚úÖ **Taux de perdus de vue**  
‚úÖ **10+ types d'√©chantillonnage** (al√©atoire, syst√©matique, boule de neige, etc.)

---

## üöÄ Ce qui a √©t√© fait automatiquement

### 1. Mod√®le de donn√©es enrichi
**Fichier:** `AdRev.Domain/Protocols/ResearchProtocol.cs`
- ‚úÖ Ajout de `IsMulticentric` et `StudyCenters`
- ‚úÖ Ajout de `SamplingType` (√©num√©ration)
- ‚úÖ Ajout de `IsStratified`, `StratificationCriteria`
- ‚úÖ Ajout de `IsClusterSampling`, `ClusterSize`, `DesignEffect`
- ‚úÖ Ajout de `ExpectedLossRate`

### 2. Nouvelle √©num√©ration cr√©√©e
**Fichier:** `AdRev.Domain/Enums/SamplingType.cs`
- ‚úÖ 13 types d'√©chantillonnage disponibles
- ‚úÖ Descriptions fran√ßaises pour chaque type

### 3. Logique UI interactive
**Fichier:** `AdRev.Desktop/ProtocolWindow.xaml.cs`
- ‚úÖ Gestionnaires d'√©v√©nements pour visibilit√© conditionnelle
- ‚úÖ Initialisation des ComboBox
- ‚úÖ R√©cup√©ration des donn√©es dans CreateProtocol_Click
- ‚úÖ 6 nouvelles m√©thodes event handler

### 4. Service utilitaire cr√©√©
**Fichier:** `AdRev.Core/Protocols/SamplingDescriptionGenerator.cs`
- ‚úÖ G√©n√©ration automatique de descriptions d'√©chantillonnage
- ‚úÖ Calculs des ajustements (Design Effect, perdus de vue)
- ‚úÖ Recommandations contextuelles
- ‚úÖ M√©thodes helper pour tous les calculs

### 5. Documentation compl√®te
**Fichier:** `Documentation/Guide_Methodologie_Avancee.md`
- ‚úÖ Guide de 200+ lignes sur toutes les fonctionnalit√©s
- ‚úÖ Exemples pratiques avec calculs complets
- ‚úÖ Formules et r√©f√©rences bibliographiques
- ‚úÖ Bonnes pratiques

**Fichier:** `Documentation/CHANGELOG_Methodologie_Avancee.md`
- ‚úÖ Liste compl√®te des modifications
- ‚úÖ Instructions pour modifications manuelles
- ‚úÖ Tests √† effectuer

---

## ‚ö†Ô∏è ACTION REQUISE : Modification Manuelle du XAML

Le fichier `AdRev.Desktop/ProtocolWindow.xaml` n√©cessite l'ajout manuel de l'interface utilisateur (probl√®me d'encodage UTF-8).

### üìç √âtape 1 : Section √âtudes Multicentriques

**Emplacement:** Apr√®s la ligne contenant `<TextBox x:Name="PopulationTextBox"...` (environ ligne 237)

**Ajouter:**
```xml
<!-- Section √âtude Multicentrique -->
<Border Background="#F5F5F5" BorderBrush="#DDDDDD" BorderThickness="1" 
        CornerRadius="5" Padding="10" Margin="0,0,0,15">
    <StackPanel>
        <CheckBox x:Name="IsMulticentricCheckBox" Content="√âtude Multicentrique" 
                  FontWeight="SemiBold" Margin="0,0,0,10" 
                  Checked="IsMulticentricCheckBox_Checked" 
                  Unchecked="IsMulticentricCheckBox_Unchecked"/>
        
        <StackPanel x:Name="MulticentricDetailsPanel" Visibility="Collapsed">
            <TextBlock Text="Centres participants (un par ligne) :" 
                       Style="{StaticResource LabelStyle}" FontSize="11"/>
            <TextBox x:Name="StudyCentersTextBox" Height="60" 
                     TextWrapping="Wrap" AcceptsReturn="True" 
                     ToolTip="Listez les centres participants √† l'√©tude"/>
        </StackPanel>
    </StackPanel>
</Border>
```

### üìç √âtape 2 : Section √âchantillonnage Avanc√©

**Emplacement:** Apr√®s la section Crit√®res d'Inclusion/Exclusion, avant "Calcul de la Taille de l'√âchantillon" (environ ligne 255)

**Ajouter:**
```xml
<!-- Section √âchantillonnage Avanc√© -->
<Border Background="#FFF9E6" BorderBrush="#FFD700" BorderThickness="1" 
        CornerRadius="5" Padding="10" Margin="0,10,0,15">
    <StackPanel>
        <TextBlock Text="‚öôÔ∏è Configuration de l'√âchantillonnage" 
                   FontWeight="Bold" FontSize="13" Margin="0,0,0,10"/>
        
        <TextBlock Text="Type d'√©chantillonnage :" 
                   Style="{StaticResource LabelStyle}" FontSize="11"/>
        <ComboBox x:Name="SamplingTypeComboBox" Height="32" Padding="8" 
                  VerticalContentAlignment="Center" FontSize="12" Margin="0,0,0,10" 
                  SelectionChanged="SamplingTypeComboBox_SelectionChanged"/>
        
        <!-- Options Stratification -->
        <StackPanel x:Name="StratificationPanel" Visibility="Collapsed" Margin="0,0,0,10">
            <CheckBox x:Name="IsStratifiedCheckBox" Content="√âchantillonnage stratifi√©" 
                      FontSize="11" Margin="0,0,0,5" 
                      Checked="IsStratifiedCheckBox_Checked" 
                      Unchecked="IsStratifiedCheckBox_Unchecked"/>
            <StackPanel x:Name="StratificationDetailsPanel" Visibility="Collapsed">
                <TextBlock Text="Crit√®res de stratification :" 
                           FontSize="10" Foreground="#666" Margin="15,0,0,2"/>
                <TextBox x:Name="StratificationCriteriaTextBox" Height="40" 
                         TextWrapping="Wrap" AcceptsReturn="True" Margin="15,0,0,0" 
                         FontSize="11" ToolTip="Ex: √Çge, Sexe, R√©gion g√©ographique..."/>
            </StackPanel>
        </StackPanel>
        
        <!-- Options Grappe -->
        <StackPanel x:Name="ClusterPanel" Visibility="Collapsed" Margin="0,0,0,10">
            <CheckBox x:Name="IsClusterCheckBox" Content="√âchantillonnage en grappe" 
                      FontSize="11" Margin="0,0,0,5" 
                      Checked="IsClusterCheckBox_Checked" 
                      Unchecked="IsClusterCheckBox_Unchecked"/>
            <StackPanel x:Name="ClusterDetailsPanel" Visibility="Collapsed">
                <Grid Margin="15,0,0,0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="10"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    <StackPanel>
                        <TextBlock Text="Taille moyenne des grappes :" 
                                   FontSize="10" Foreground="#666"/>
                        <TextBox x:Name="ClusterSizeTextBox" Height="28" FontSize="11" 
                                 ToolTip="Nombre moyen de sujets par grappe"/>
                    </StackPanel>
                    <StackPanel Grid.Column="2">
                        <TextBlock Text="Effet de plan (Design Effect) :" 
                                   FontSize="10" Foreground="#666"/>
                        <TextBox x:Name="DesignEffectTextBox" Text="1.5" Height="28" 
                                 FontSize="11" ToolTip="G√©n√©ralement entre 1.5 et 2.0"/>
                    </StackPanel>
                </Grid>
            </StackPanel>
        </StackPanel>
        
        <!-- Taux de perdus de vue -->
        <Grid Margin="0,5,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="10"/>
                <ColumnDefinition Width="100"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <TextBlock Text="Taux de perdus de vue attendu :" 
                       VerticalAlignment="Center" FontSize="11"/>
            <TextBox x:Name="ExpectedLossRateTextBox" Grid.Column="2" Text="10" 
                     Height="28" FontSize="11" VerticalContentAlignment="Center" 
                     ToolTip="En pourcentage"/>
            <TextBlock Grid.Column="3" Text=" %" VerticalAlignment="Center" 
                       FontSize="11" Margin="5,0,0,0"/>
        </Grid>
    </StackPanel>
</Border>
```

### üìç (Optionnel) √âtape 3 : Am√©liorer les Calculs

Dans `ProtocolWindow.xaml.cs`, √† la fin de la m√©thode `CalculateCochran_Click` (ligne ~129), remplacer :

**AVANT:**
```csharp
SamplingTextBox.Text = $"La taille d'√©chantillon minimal a √©t√© calcul√©e selon la formule de {formulaUsed}. " +
                       $"Avec une pr√©valence attendue de {p*100}%, une marge d'erreur de {d*100}% et un niveau de confiance de 95% (Z={z}), " +
                       $"le nombre de sujets requis est de {nCeiling}.";
```

**APR√àS:**
```csharp
// Appliquer ajustements si n√©cessaire
int adjustedN = nCeiling;
string adjustmentDetails = "";

// Ajustement pour Design Effect (si √©chantillonnage en grappe)
if (IsClusterCheckBox?.IsChecked == true)
{
    double deff = double.TryParse(DesignEffectTextBox?.Text, System.Globalization.NumberStyles.Any, 
                                  System.Globalization.CultureInfo.InvariantCulture, out double d) ? d : 1.5;
    int deffAdjusted = (int)Math.Ceiling(nCeiling * deff);
    adjustmentDetails += $" Avec un effet de plan de {deff:F2}, la taille passe √† {deffAdjusted} sujets.";
    adjustedN = deffAdjusted;
}

// Ajustement pour perdus de vue
double lossRate = double.TryParse(ExpectedLossRateTextBox?.Text, out double lr) ? lr : 0.0;
if (lossRate > 0)
{
    int finalAdjusted = (int)Math.Ceiling(adjustedN / (1.0 - lossRate / 100.0));
    adjustmentDetails += $" En pr√©voyant {lossRate:F0}% de perdus de vue, la taille finale est de {finalAdjusted} sujets.";
    adjustedN = finalAdjusted;
}

ResultCochran.Text = $"N requis = {adjustedN} sujets{(adjustedN != nCeiling ? $" (base: {nCeiling})" : "")}";

SamplingTextBox.Text = $"La taille d'√©chantillon minimal a √©t√© calcul√©e selon la formule de {formulaUsed}. " +
                       $"Avec une pr√©valence attendue de {p*100}%, une marge d'erreur de {d*100}% et un niveau de confiance de 95% (Z={z}), " +
                       $"le nombre de sujets requis est de {nCeiling}.{adjustmentDetails}";
```

---

## üß™ Tests Recommand√©s

### Test 1 : √âtude Multicentrique Simple
1. Cr√©er un nouveau protocole
2. Cocher "√âtude Multicentrique"
3. Ajouter 3 centres
4. Sauvegarder et v√©rifier

### Test 2 : √âchantillonnage en Grappe
1. S√©lectionner "Quantitative" ‚Üí "Transversale"
2. Dans Type d'√©chantillonnage : "En Grappe (Cluster)"
3. Cocher "√âchantillonnage en grappe"
4. Taille grappes: 30, Design Effect: 1.8
5. Calculer avec Cochran (p=50%, d=5%)
6. Observer l'ajustement automatique

### Test 3 : Stratifi√© + Perdus de vue
1. Type d'√©chantillonnage : "Stratifi√©"
2. Cocher "√âchantillonnage stratifi√©"
3. Crit√®res : "√Çge (<40 ans, ‚â•40 ans), Sexe (H, F)"
4. Perdus de vue : 15%
5. Calculer et v√©rifier les ajustements

### Test 4 : Combinaison Compl√®te
1. Multicentrique : OUI (5 centres)
2. Type : "Stratifi√© en Grappes"
3. Stratifi√© : OUI (Zone urbaine/rurale)
4. Grappe : OUI (Villages, taille=25, Deff=2.0)
5. Perdus de vue : 20%
6. V√©rifier que tout se sauvegarde correctement

---

## üìä Exemple d'Utilisation Compl√®te

### Sc√©nario : Enqu√™te de Pr√©valence du Diab√®te en Milieu Rural

**Configuration:**
- Type d'√©tude : Quantitative ‚Üí Transversale Descriptive
- Multicentrique : ‚úì (3 r√©gions sanitaires)
- Type √©chantillonnage : En Grappe (Cluster)
- Grappe : ‚úì
  - Taille : 25 personnes/village
  - Design Effect : 1.8
- Perdus de vue : 10%

**Calcul:**
1. Base (Cochran) : p=10%, d=3% ‚Üí **N‚ÇÄ = 384**
2. + Design Effect (1.8) ‚Üí **N‚ÇÅ = 692**
3. + Perdus de vue (10%) ‚Üí **N final = 769**
4. ‚Üí **26 villages** (769/25) r√©partis dans 3 r√©gions

**Texte g√©n√©r√© automatiquement:**
> ¬´ La taille d'√©chantillon minimal a √©t√© calcul√©e selon la formule de Cochran (population infinie). Avec une pr√©valence attendue de 10%, une marge d'erreur de 3% et un niveau de confiance de 95% (Z=1.96), le nombre de sujets requis est de 384. Avec un effet de plan de 1.80, la taille passe √† 692 sujets. En pr√©voyant 10% de perdus de vue, la taille finale est de 769 sujets. ¬ª

---

## üìö Documentation Disponible

1. `Documentation/Guide_Methodologie_Avancee.md` - Guide complet (200+ lignes)
2. `Documentation/CHANGELOG_Methodologie_Avancee.md` - Liste des modifications
3. Ce fichier - Instructions d'utilisation rapide

---

## üîó Ressources Suppl√©mentaires

### Formules Cl√©s

**Design Effect (Deff):**
```
Deff = 1 + (m - 1) √ó ICC
```
- m = taille moyenne de la grappe
- ICC = coefficient de corr√©lation intra-classe

**Taille ajust√©e:**
```
N_ajust√© = N_base √ó Deff
```

**Perdus de vue:**
```
N_final = N_ajust√© / (1 - taux%)
```

### Valeurs Typiques

| Contexte | Design Effect | Perdus de vue |
|----------|--------------|---------------|
| Transversale simple | 1.0 | 5-10% |
| Transversale en grappe | 1.5-2.0 | 10% |
| Cohorte < 1 an | 1.0 | 10-15% |
| Cohorte > 1 an | 1.0 | 15-25% |
| ERC | 1.0 | 10-20% |

---

## ‚úÖ Checklist Finale

- [x] Mod√®le de donn√©es enrichi
- [x] √ânum√©ration SamplingType cr√©√©e
- [x] Gestionnaires d'√©v√©nements ajout√©s
- [x] Service SamplingDescriptionGenerator cr√©√©
- [x] Documentation compl√®te r√©dig√©e
- [ ] **XAML UI √† ajouter manuellement (REQUIS)**
- [ ] Tests fonctionnels
- [ ] Validation avec protocole r√©el

---

## üÜò Support

Si vous rencontrez des probl√®mes :

1. **V√©rifier** que tous les using sont corrects dans les fichiers C#
2. **Recompiler** le projet apr√®s modifications XAML
3. **Consulter** `Documentation/Guide_Methodologie_Avancee.md` pour exemples
4. **Tester** progressivement chaque fonctionnalit√©

---

**Bonne utilisation d'AdRev avec ses nouvelles capacit√©s avanc√©es ! üöÄ**




FILE: \Site_Creation_Plan.md
------------------------------------
# Plan : Cr√©ation du Site AdRev (NotebookLM + v0.dev)

Voici la strat√©gie √©tape par √©tape pour transformer votre projet AdRev en un site web vitrine premium.

## √âtape 1 : Pr√©paration du "Cerveau" (NotebookLM)
*   **Action :** Ex√©cutez le script `Generate_Digest.ps1` dans votre dossier AdRev.
*   **NotebookLM :** Cr√©ez un nouveau bloc-notes et importez :
    1.  `NotebookLM_Context_Pack.md` (pour la vision globale).
    2.  `AdRev_Codebase_Digest.txt` (pour le d√©tail technique).
*   **Objectif :** NotebookLM est maintenant pr√™t √† r√©pondre √† toutes les questions sur AdRev.

## √âtape 2 : Extraction du Contenu Marketing
Posez ces questions √† NotebookLM et copiez les r√©ponses :
1.  *"Pr√©pare 5 titres accrocheurs pour la section Hero du site."*
2.  *"Explique en 3 points cl√©s pourquoi l'√©chantillonnage avanc√© d'AdRev est indispensable pour un chercheur."*
3.  *"G√©n√®re 4 descriptions courtes pour la grille de fonctionnalit√©s (Bento Grid)."*

## √âtape 3 : G√©n√©ration Visuelle (v0.dev ou Bolt.new)
*   **Action :** Allez sur [v0.dev](https://v0.dev) (ou Bolt.new).
*   **Prompt :** Copiez le contenu de `AI_Site_Prompt.md`.
*   **Personnalisation :** Ajoutez les textes extraits de NotebookLM √† la fin du prompt.
    *   *Exemple :* "... utilise ces textes pour le site : Titre: 'AdRev 2.0 : La M√©thodologie M√©dicale R√©invent√©e', ..."

## √âtape 4 : Raffinement et It√©ration
*   **Design :** Demandez √† l'IA de changer des couleurs ou des animations (ex: *"Rends le gradient plus √©clatant"*, *"Ajoute un bouton de t√©l√©chargement premium"*).
*   **D√©tails :** Demandez-lui d'ajouter des sections sp√©cifiques comme une "Biblioth√®que de m√©thodes" bas√©e sur le `Guide_Methodologie_Avancee.md`.

## √âtape 5 : D√©ploiement
*   **Simple :** Utilisez le bouton 'Deploy' de v0 ou Bolt pour mettre le site en ligne imm√©diatement sur une URL temporaire.
*   **Pro :** Exportez le code (React/Tailwind) pour l'h√©berger sur Vercel ou Netlify.

---

> [!TIP]
> **Le secret du succ√®s :** Ne demandez pas tout d'un coup. G√©n√©rez d'abord la structure globale avec v0, puis affinez chaque section une par une en lui donnant les textes pr√©cis de NotebookLM.




